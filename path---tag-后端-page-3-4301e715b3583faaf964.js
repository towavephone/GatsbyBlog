webpackJsonp([0xc9eff4228571],{1562:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"基本概念 镜像 Docker 镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。 分层存储 因为镜像包含操作系统完整的 root 文件系统，其体积往往是庞大的，因此在 Docker 设计时，就充分利用 Union FS 的技术，将其设计为分层存储的架构。所以严格来说，镜像并非是像一个 ISO…",html:'<h1 id="基本概念"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h1>\n<h2 id="镜像"><a href="#%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像</h2>\n<p>Docker 镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p>\n<h3 id="分层存储"><a href="#%E5%88%86%E5%B1%82%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分层存储</h3>\n<p>因为镜像包含操作系统完整的 root 文件系统，其体积往往是庞大的，因此在 Docker 设计时，就充分利用 Union FS 的技术，将其设计为分层存储的架构。所以严格来说，镜像并非是像一个 ISO 那样的打包文件，镜像只是一个虚拟的概念，其实际体现并非由一个文件组成，而是由一组文件系统组成，或者说，由多层文件系统联合组成。</p>\n<p>镜像构建时，会一层层构建，前一层是后一层的基础。每一层构建完就不会再发生改变，后一层上的任何改变只发生在自己这一层。比如，删除前一层文件的操作，实际不是真的删除前一层的文件，而是仅在当前层标记为该文件已删除。在最终容器运行的时候，虽然不会看到这个文件，但是实际上该文件会一直跟随镜像。因此，在构建镜像的时候，需要额外小心，每一层尽量只包含该层需要添加的东西，任何额外的东西应该在该层构建结束前清理掉。</p>\n<p>分层存储的特征还使得镜像的复用、定制变的更为容易。甚至可以用之前构建好的镜像作为基础层，然后进一步添加新的层，以定制自己所需的内容，构建新的镜像。</p>\n<h2 id="容器"><a href="#%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器</h2>\n<p>镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</p>\n<p>容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间（opens new window）。因此容器可以拥有自己的 root 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。也因为这种隔离的特性，很多人初学 Docker 时常常会混淆容器和虚拟机。</p>\n<p>前面讲过镜像使用的是分层存储，容器也是如此。每一个容器运行时，是以镜像为基础层，在其上创建一个当前容器的存储层，我们可以称这个为容器运行时读写而准备的存储层为容器存储层。</p>\n<p>容器存储层的生存周期和容器一样，容器消亡时，容器存储层也随之消亡。因此，任何保存于容器存储层的信息都会随容器删除而丢失。</p>\n<p>按照 Docker 最佳实践的要求，容器不应该向其存储层内写入任何数据，容器存储层要保持无状态化。所有的文件写入操作，都应该使用数据卷（Volume）、或者绑定宿主目录，在这些位置的读写会跳过容器存储层，直接对宿主（或网络存储）发生读写，其性能和稳定性更高。</p>\n<p>数据卷的生存周期独立于容器，容器消亡，数据卷不会消亡。因此，使用数据卷后，容器删除或者重新运行之后，数据却不会丢失。</p>\n<h2 id="仓库"><a href="#%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库</h2>\n<p>镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry 就是这样的服务。</p>\n<p>一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。</p>\n<p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <code class="language-text">&lt;仓库名&gt;:&lt;标签&gt;</code> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签。</p>\n<p>以 Ubuntu 镜像为例，ubuntu 是仓库的名字，其内包含有不同的版本标签，如 16.04, 18.04。我们可以通过 ubuntu:16.04 或者 ubuntu:18.04 来具体指定所需哪个版本的镜像。如果忽略了标签，比如 ubuntu，那将视为 ubuntu:latest。</p>\n<p>仓库名经常以两段式路径形式出现，比如 jwilder/nginx-proxy，前者往往意味着 Docker Registry 多用户环境下的用户名，后者则往往是对应的软件名。但这并非绝对，取决于所使用的具体 Docker Registry 的软件或服务。</p>\n<h3 id="docker-registry-公开服务"><a href="#docker-registry-%E5%85%AC%E5%BC%80%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Registry 公开服务</h3>\n<p>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像，并可能提供收费服务供用户管理私有镜像。</p>\n<p>最常使用的 Registry 公开服务是官方的 Docker Hub，这也是默认的 Registry，并拥有大量的高质量的官方镜像。除此以外，还有 Red Hat 的 Quay.io ；Google 的 Google Container Registry，Kubernetes 的镜像使用的就是这个服务；代码托管平台 GitHub 推出的 ghcr.io。</p>\n<p>由于某些原因，在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务（Registry Mirror），这些镜像服务被称为加速器。常见的有阿里云加速器、DaoCloud 加速器等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像，比直接从 Docker Hub 下载速度会提高很多。</p>\n<p>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如网易云镜像服务、DaoCloud 镜像市场、阿里云镜像库等。</p>\n<h3 id="私有-docker-registry"><a href="#%E7%A7%81%E6%9C%89-docker-registry" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>私有 Docker Registry</h3>\n<p>除了使用公开服务外，用户还可以在本地搭建私有 Docker Registry。Docker 官方提供了 Docker Registry 镜像，可以直接使用做为私有 Registry 服务。在私有仓库一节中，会有进一步的搭建私有 Registry 服务的讲解。</p>\n<p>开源的 Docker Registry 镜像只提供了 Docker Registry API 的服务端实现，足以支持 docker 命令，不影响使用。但不包含图形界面，以及镜像维护、用户管理、访问控制等高级功能。</p>\n<p>除了官方的 Docker Registry 外，还有第三方软件实现了 Docker Registry API，甚至提供了用户界面以及一些高级功能，比如 Harbor 和 Sonatype Nexus</p>\n<h1 id="使用镜像"><a href="#%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用镜像</h1>\n<p>Docker 运行容器前需要本地存在对应的镜像，如果本地不存在该镜像，Docker 会从镜像仓库下载该镜像。</p>\n<h2 id="获取镜像"><a href="#%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取镜像</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29479600025475715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]`, `29479600025475715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token punctuation">[</span>Docker Registry 地址<span class="token punctuation">[</span>:端口号<span class="token punctuation">]</span>/<span class="token punctuation">]</span>仓库名<span class="token punctuation">[</span>:标签<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<ul>\n<li>Docker 镜像仓库地址：地址的格式一般是 <code class="language-text">&lt;域名/IP&gt;[:端口号]</code>。默认地址是 Docker Hub(docker.io)。</li>\n<li>仓库名：如之前所说，这里的仓库名是两段式名称，即 <code class="language-text">&lt;用户名&gt;/&lt;软件名&gt;</code>。对于 Docker Hub，如果不给出用户名，则默认为 library，也就是官方镜像。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75106953447718340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull ubuntu:18.04\n18.04: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image for ubuntu:18.04\ndocker.io/library/ubuntu:18.04 # 完整名称`, `75106953447718340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull ubuntu:18.04\n<span class="token number">18.04</span>: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image <span class="token keyword">for</span> ubuntu:18.04\ndocker.io/library/ubuntu:18.04 <span class="token comment"># 完整名称</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行"><a href="#%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91107928950363500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 bash\n\nroot@e7009c6ce357:/# cat /etc/os-release\nNAME=&quot;Ubuntu&quot;\nVERSION=&quot;18.04.1 LTS (Bionic Beaver)&quot;\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=&quot;Ubuntu 18.04.1 LTS&quot;\nVERSION_ID=&quot;18.04&quot;\nHOME_URL=&quot;https://www.ubuntu.com/&quot;\nSUPPORT_URL=&quot;https://help.ubuntu.com/&quot;\nBUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;\nPRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic`, `91107928950363500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">bash</span>\n\nroot@e7009c6ce357:/<span class="token comment"># cat /etc/os-release</span>\n<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu"</span>\n<span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"18.04.1 LTS (Bionic Beaver)"</span>\n<span class="token assign-left variable">ID</span><span class="token operator">=</span>ubuntu\n<span class="token assign-left variable">ID_LIKE</span><span class="token operator">=</span>debian\n<span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu 18.04.1 LTS"</span>\n<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"18.04"</span>\n<span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/"</span>\n<span class="token assign-left variable">SUPPORT_URL</span><span class="token operator">=</span><span class="token string">"https://help.ubuntu.com/"</span>\n<span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://bugs.launchpad.net/ubuntu/"</span>\n<span class="token assign-left variable">PRIVACY_POLICY_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span>\n<span class="token assign-left variable">VERSION_CODENAME</span><span class="token operator">=</span>bionic\n<span class="token assign-left variable">UBUNTU_CODENAME</span><span class="token operator">=</span>bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>docker run 就是运行容器的命令，具体格式我们会在容器一节进行详细讲解，我们这里简要的说明一下上面用到的参数。</p>\n<ul>\n<li><code class="language-text">-it</code>：这是两个参数，一个是 <code class="language-text">-i</code> 交互式操作，一个是 <code class="language-text">-t</code> 终端。我们这里打算进入 bash 执行一些命令并查看返回结果，因此我们需要交互式终端。</li>\n<li><code class="language-text">--rm</code>：这个参数是说容器退出后随之将其删除。默认情况下，为了排障需求，退出的容器并不会立即删除，除非手动 docker rm。我们这里只是随便执行个命令，看看结果，不需要排障和保留结果，因此使用 —rm 可以避免浪费空间。</li>\n<li><code class="language-text">ubuntu:18.04</code>：这是指用 <code class="language-text">ubuntu:18.04</code> 镜像为基础来启动容器。</li>\n<li><code class="language-text">bash</code>：放在镜像名后的是命令，这里我们希望有个交互式 Shell，因此用的是 bash。进入容器后，我们可以在 Shell 下操作，执行任何所需的命令。这里，我们执行了 cat /etc/os-release，这是 Linux 常用的查看当前系统版本的命令，从返回的结果可以看到容器内是 <code class="language-text">Ubuntu 18.04.1 LTS</code> 系统。</li>\n</ul>\n<p>最后我们通过 exit 退出了这个容器。</p>\n<h2 id="列出镜像"><a href="#%E5%88%97%E5%87%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出镜像</h2>\n<p>列出已经下载下来的镜像，可以使用 docker image ls 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60487846424813590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        5 days ago          183 MB\nnginx                latest              05a60462f8ba        5 days ago          181 MB\nmongo                3.2                 fe9198c04d62        5 days ago          342 MB\n<none>               <none>              00285df0df87        5 days ago          342 MB\nubuntu               18.04               329ed837d508        3 days ago          63.3MB\nubuntu               bionic              329ed837d508        3 days ago          63.3MB`, `60487846424813590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx                latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB\nmongo                <span class="token number">3.2</span>                 fe9198c04d62        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\n<span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\nubuntu               <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu               bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="镜像体积"><a href="#%E9%95%9C%E5%83%8F%E4%BD%93%E7%A7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像体积</h3>\n<p>Docker Hub 中显示的体积是压缩后的体积，而 docker image ls 显示的是镜像下载到本地后展开的大小</p>\n<p>另外一个需要注意的问题是，docker image ls 列表中的镜像体积总和并非是所有镜像实际硬盘消耗。由于 Docker 镜像是多层存储结构，并且可以继承、复用，因此不同镜像可能会因为使用相同的基础镜像，从而拥有共同的层。由于 Docker 使用 Union FS，相同的层只需要保存一份即可，因此实际镜像硬盘占用空间很可能要比这个列表镜像大小的总和要小的多。</p>\n<p>你可以通过 docker system df 命令来便捷的查看镜像、容器、数据卷所占用的空间。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52694619547560390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker system df\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              24                  0                   1.992GB             1.992GB (100%)\nContainers          1                   0                   62.82MB             62.82MB (100%)\nLocal Volumes       9                   0                   652.2MB             652.2MB (100%)\nBuild Cache                                                 0B                  0B`, `52694619547560390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker system <span class="token function">df</span>\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              <span class="token number">24</span>                  <span class="token number">0</span>                   <span class="token number">1</span>.992GB             <span class="token number">1</span>.992GB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nContainers          <span class="token number">1</span>                   <span class="token number">0</span>                   <span class="token number">62</span>.82MB             <span class="token number">62</span>.82MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nLocal Volumes       <span class="token number">9</span>                   <span class="token number">0</span>                   <span class="token number">652</span>.2MB             <span class="token number">652</span>.2MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nBuild Cache                                                 0B                  0B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="虚悬镜像"><a href="#%E8%99%9A%E6%82%AC%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>虚悬镜像</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61187187550321260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<none>               <none>              00285df0df87        5 days ago          342 MB`, `61187187550321260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个镜像原本是有镜像名和标签的，原来为 <code class="language-text">mongo:3.2</code>，随着官方镜像维护，发布了新版本后，重新 <code class="language-text">docker pull mongo:3.2</code> 时，<code class="language-text">mongo:3.2</code> 这个镜像名被转移到了新下载的镜像身上，而旧的镜像上的这个名称则被取消，从而成为了 <code class="language-text">&lt;none&gt;</code>。除了 docker pull 可能导致这种情况，docker build 也同样可以导致这种现象。由于新旧镜像同名，旧镜像名称被取消，从而出现仓库名、标签均为 <code class="language-text">&lt;none&gt;</code> 的镜像。这类无标签镜像也被称为虚悬镜像 (dangling image) ，可以用下面的命令专门显示这类镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75468041202343380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f dangling=true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<none>              <none>              00285df0df87        5 days ago          342 MB`, `75468041202343380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">dangling</span><span class="token operator">=</span>true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，虚悬镜像已经失去了存在的价值，是可以随意删除的，可以用下面的命令删除。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69576912441078000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image prune`, `69576912441078000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="中间层镜像"><a href="#%E4%B8%AD%E9%97%B4%E5%B1%82%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>中间层镜像</h3>\n<p>为了加速镜像构建、重复利用资源，Docker 会利用中间层镜像。所以在使用一段时间后，可能会看到一些依赖的中间层镜像。默认的 docker image ls 列表中只会显示顶层镜像，如果希望显示包括中间层镜像在内的所有镜像的话，需要加 -a 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91368913842942400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -a`, `91368913842942400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样会看到很多无标签的镜像，与之前的虚悬镜像不同，这些无标签的镜像很多都是中间层镜像，是其它镜像所依赖的镜像。这些无标签镜像不应该删除，否则会导致上层镜像因为依赖丢失而出错。实际上，这些镜像也没必要删除，因为之前说过，相同的层只会存一遍，而这些镜像是别的镜像的依赖，因此并不会因为它们被列出来而多存了一份，无论如何你也会需要它们。只要删除那些依赖它们的镜像后，这些依赖的中间层镜像也会被连带删除。</p>\n<h3 id="列出部分镜像"><a href="#%E5%88%97%E5%87%BA%E9%83%A8%E5%88%86%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出部分镜像</h3>\n<p>不加任何参数的情况下，docker image ls 会列出所有顶层镜像，但是有时候我们只希望列出部分镜像。docker image ls 有好几个参数可以帮助做到这个事情。</p>\n<p>根据仓库名列出镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14658772069468750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB\nubuntu              bionic              329ed837d508        3 days ago          63.3MB`, `14658772069468750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu              bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>列出特定的某个镜像，也就是说指定仓库名和标签</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39517309024568380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB`, `39517309024568380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>除此以外，docker image ls 还支持强大的过滤器参数 <code class="language-text">--filter</code>，或者简写 -f。之前我们已经看到了使用过滤器来列出虚悬镜像的用法，它还有更多的用法。比如，我们希望看到在 <code class="language-text">mongo:3.2</code> 之后建立的镜像，可以用下面的命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76140016199690240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f since=mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        5 days ago          183 MB\nnginx               latest              05a60462f8ba        5 days ago          181 MB`, `76140016199690240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">since</span><span class="token operator">=</span>mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx               latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>想查看某个位置之前的镜像也可以，只需要把 since 换成 before 即可。</p>\n<p>此外，如果镜像构建时，定义了 LABEL，还可以通过 LABEL 来过滤。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25335074699880790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f label=com.example.version=0.1`, `25335074699880790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">label</span><span class="token operator">=</span>com.example.version<span class="token operator">=</span><span class="token number">0.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="以特定格式显示"><a href="#%E4%BB%A5%E7%89%B9%E5%AE%9A%E6%A0%BC%E5%BC%8F%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>以特定格式显示</h3>\n<p>默认情况下，docker image ls 会输出一个完整的表格，但是我们并非所有时候都会需要这些内容。比如，刚才删除虚悬镜像的时候，我们需要利用 docker image ls 把所有的虚悬镜像的 ID 列出来，然后才可以交给 docker image rm 命令作为参数来删除指定的这些镜像，这个时候就用到了 -q 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87343676518985040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508`, `87343676518985040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>—filter 配合 -q 产生出指定范围的 ID 列表，然后送给另一个 docker 命令作为参数，从而针对这组实体成批的进行某种操作的做法在 Docker 命令行使用过程中非常常见，不仅仅是镜像，将来我们会在各个命令中看到这类搭配以完成很强大的功能。因此每次在文档看到过滤器后，可以多注意一下它们的用法。</p>\n<p>另外一些时候，我们可能只是对表格的结构不满意，希望自己组织列；或者不希望有标题，这样方便其它程序解析结果等，这就用到了 Go 的模板语法。</p>\n<p>比如，下面的命令会直接列出镜像结果，并且只包含镜像 ID 和仓库名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78829635105308600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;{{.ID}}: {{.Repository}}&quot;\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <none>\n329ed837d508: ubuntu\n329ed837d508: ubuntu`, `78829635105308600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"{{.ID}}: {{.Repository}}"</span>\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508: ubuntu\n329ed837d508: ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者打算以表格等距显示，并且有标题行，和默认一样，不过自己定义列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94526379113346760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;table {{.ID}}\\t{{.Repository}}\\t{{.Tag}}&quot;\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               3.2\n00285df0df87        <none>              <none>\n329ed837d508        ubuntu              18.04\n329ed837d508        ubuntu              bionic`, `94526379113346760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"table {{.ID}}<span class="token entity" title="\\t">\\t</span>{{.Repository}}<span class="token entity" title="\\t">\\t</span>{{.Tag}}"</span>\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               <span class="token number">3.2</span>\n00285df0df87        <span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508        ubuntu              <span class="token number">18.04</span>\n329ed837d508        ubuntu              bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="删除本地镜像"><a href="#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除本地镜像</h2>\n<p>如果要删除本地的镜像，可以使用 docker image rm 命令，其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9147729687768824000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm [选项] <镜像1> [<镜像2> ...]`, `9147729687768824000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="用-id、镜像名、摘要删除镜像"><a href="#%E7%94%A8-id%E3%80%81%E9%95%9C%E5%83%8F%E5%90%8D%E3%80%81%E6%91%98%E8%A6%81%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 ID、镜像名、摘要删除镜像</h3>\n<p>其中，&#x3C;镜像> 可以是 镜像短 ID、镜像长 ID、镜像名或者镜像摘要。</p>\n<p>比如我们有这么一些镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91082367013844660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        3 weeks ago         196.5 MB\nredis                       alpine              501ad78535f0        3 weeks ago         21.03 MB\ndocker                      latest              cf693ec9b5c7        3 weeks ago         105.1 MB\nnginx                       latest              e43d811ce2f4        5 weeks ago         181.5 MB`, `91082367013844660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        <span class="token number">3</span> weeks ago         <span class="token number">196.5</span> MB\nredis                       alpine              501ad78535f0        <span class="token number">3</span> weeks ago         <span class="token number">21.03</span> MB\ndocker                      latest              cf693ec9b5c7        <span class="token number">3</span> weeks ago         <span class="token number">105.1</span> MB\nnginx                       latest              e43d811ce2f4        <span class="token number">5</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10309687365922615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm 501\n\\$ docker image rm centos`, `10309687365922615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token number">501</span>\n$ docker image <span class="token function">rm</span> centos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，更精确的是使用镜像摘要删除镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97739406083869700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        3 weeks ago         214 MB\n\n\\$ docker image rm node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228`, `97739406083869700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        <span class="token number">3</span> weeks ago         <span class="token number">214</span> MB\n\n$ docker image <span class="token function">rm</span> node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="untagged-和-deleted"><a href="#untagged-%E5%92%8C-deleted" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Untagged 和 Deleted</h3>\n<p>删除行为分为两类，一类是 Untagged，另一类是 Deleted。我们之前介绍过，镜像的唯一标识是其 ID 和摘要，而一个镜像可以有多个标签。</p>\n<p>因此当我们使用上面命令删除镜像的时候，实际上是在要求删除某个标签的镜像。所以首先需要做的是将满足我们要求的所有镜像标签都取消，这就是我们看到的 Untagged 的信息。因为一个镜像可以对应多个标签，因此当我们删除了所指定的标签后，可能还有别的标签指向了这个镜像，如果是这种情况，那么 Delete 行为就不会发生。所以并非所有的 docker image rm 都会产生删除镜像的行为，有可能仅仅是取消了某个标签而已。</p>\n<p>当该镜像所有的标签都被取消了，该镜像很可能会失去了存在的意义，因此会触发删除行为。镜像是多层存储结构，因此在删除的时候也是从上层向基础层方向依次进行判断删除。镜像的多层结构让镜像复用变得非常容易，因此很有可能某个其它镜像正依赖于当前镜像的某一层。这种情况，依旧不会触发删除该层的行为。直到没有任何层依赖当前层时，才会真实的删除当前层。这就是为什么，有时候会奇怪，为什么明明没有别的标签指向这个镜像，但是它还是存在的原因，也是为什么有时候会发现所删除的层数和自己 docker pull 看到的层数不一样的原因。</p>\n<p>除了镜像依赖以外，还需要注意的是容器对镜像的依赖。如果有用这个镜像启动的容器存在（即使容器没有运行），那么同样不可以删除这个镜像。之前讲过，容器是以镜像为基础，再加一层容器存储层，组成这样的多层存储结构去运行的。因此该镜像如果被这个容器所依赖的，那么删除必然会导致故障。如果这些容器是不需要的，应该先将它们删除，然后再来删除镜像。</p>\n<h3 id="用-docker-image-ls-命令来配合"><a href="#%E7%94%A8-docker-image-ls-%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%85%8D%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 docker image ls 命令来配合</h3>\n<p>像其它可以承接多个实体的命令一样，可以使用 docker image ls -q 来配合使用 docker image rm，这样可以成批的删除希望删除的镜像。我们在“镜像列表”章节介绍过很多过滤镜像列表的方式都可以拿过来使用。</p>\n<p>比如，我们需要删除所有仓库名为 redis 的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14755174555479144000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q redis)`, `14755174555479144000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q redis<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者删除所有在 <code class="language-text">mongo:3.2</code> 之前的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81674937638624540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q -f before=mongo:3.2)`, `81674937638624540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q -f <span class="token assign-left variable">before</span><span class="token operator">=</span>mongo:3.2<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>充分利用你的想象力和 Linux 命令行的强大，你可以完成很多非常赞的功能。</p>\n<h2 id="利用-commit-理解镜像构成"><a href="#%E5%88%A9%E7%94%A8-commit-%E7%90%86%E8%A7%A3%E9%95%9C%E5%83%8F%E6%9E%84%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>利用 commit 理解镜像构成</h2>\n<p>让我们以定制一个 Web 服务器为例子，来讲解镜像是如何构建的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94573035794097500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --name webserver -d -p 80:80 nginx`, `94573035794097500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --name webserver -d -p <span class="token number">80</span>:80 nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这条命令会用 nginx 镜像启动一个容器，命名为 webserver，并且映射了 80 端口，这样我们可以用浏览器去访问这个 nginx 服务器。</p>\n<p>如果是在本机运行的 Docker，那么可以直接访问：<code class="language-text">http://localhost</code> ，如果是在虚拟机、云服务器上安装的 Docker，则需要将 localhost 换为虚拟机地址或者实际云服务器地址。</p>\n<p>直接用浏览器访问的话，我们会看到默认的 Nginx 欢迎页面。</p>\n<p>现在，假设我们非常不喜欢这个欢迎页面，我们希望改成欢迎 Docker 的文字，我们可以使用 docker exec 命令进入容器，修改其内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33072515558717640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker exec -it webserver bash\nroot@3729b97e8226:/# echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\nroot@3729b97e8226:/# exit\nexit`, `33072515558717640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -it webserver <span class="token function">bash</span>\nroot@3729b97e8226:/<span class="token comment"># echo \'&lt;h1>Hello, Docker!&lt;/h1>\' > /usr/share/nginx/html/index.html</span>\nroot@3729b97e8226:/<span class="token comment"># exit</span>\n<span class="token builtin class-name">exit</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们以交互式终端方式进入 webserver 容器，并执行了 bash 命令，也就是获得一个可操作的 Shell。</p>\n<p>然后，我们用 <code class="language-text">&lt;h1&gt;Hello, Docker!&lt;/h1&gt;</code> 覆盖了 <code class="language-text">/usr/share/nginx/html/index.html</code> 的内容。</p>\n<p>现在我们再刷新浏览器的话，会发现内容被改变了。</p>\n<p>我们修改了容器的文件，也就是改动了容器的存储层。我们可以通过 docker diff 命令看到具体的改动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51403178123636950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker diff webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp`, `51403178123636950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">diff</span> webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们定制好了变化，我们希望能将其保存下来形成镜像。</p>\n<p>要知道，当我们运行一个容器的时候（如果不使用卷的话），我们做的任何文件修改都会被记录于容器存储层里。而 Docker 提供了一个 docker commit 命令，可以将容器的存储层保存下来成为镜像。换句话说，就是在原有镜像的基础上，再叠加上容器的存储层，并构成新的镜像。以后我们运行这个新镜像的时候，就会拥有原有容器最后的文件变化。</p>\n<p>docker commit 的语法格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36943313933510380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker commit [选项] <容器ID或容器名> [<仓库名>[:<标签>]]`, `36943313933510380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker commit <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>容器ID或容器名<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们可以用下面的命令将容器保存为镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9515443616947784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker commit \\\n    --author &quot;Tao Wang <twang2218@gmail.com>&quot; \\\n    --message &quot;修改了默认网页&quot; \\\n    webserver \\\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214`, `9515443616947784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker commit <span class="token punctuation">\\</span>\n    --author <span class="token string">"Tao Wang &lt;twang2218@gmail.com>"</span> <span class="token punctuation">\\</span>\n    --message <span class="token string">"修改了默认网页"</span> <span class="token punctuation">\\</span>\n    webserver <span class="token punctuation">\\</span>\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 —author 是指定修改的作者，而 —message 则是记录本次修改的内容。这点和 git 版本控制相似，不过这里这些信息可以省略留空。</p>\n<p>我们可以在 docker image ls 中看到这个新定制的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4112359032377122000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        9 seconds ago       181.5 MB\nnginx               1.11                05a60462f8ba        12 days ago         181.5 MB\nnginx               latest              e43d811ce2f4        4 weeks ago         181.5 MB`, `4112359032377122000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        <span class="token number">9</span> seconds ago       <span class="token number">181.5</span> MB\nnginx               <span class="token number">1.11</span>                05a60462f8ba        <span class="token number">12</span> days ago         <span class="token number">181.5</span> MB\nnginx               latest              e43d811ce2f4        <span class="token number">4</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还可以用 docker history 具体查看镜像内的历史记录，如果比较 <code class="language-text">nginx:latest</code> 的历史记录，我们会发现新增了我们刚刚提交的这一层。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56701557241710576000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        54 seconds ago      nginx -g daemon off;                            95 B                修改了默认网页\ne43d811ce2f4        4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon    0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 443/tcp 80/tcp        0 B\n<missing>           4 weeks ago         /bin/sh -c ln -sf /dev/stdout /var/log/nginx/   22 B\n<missing>           4 weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   58.46 MB\n<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.11.5-1   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  MAINTAINER NGINX Docker Ma   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:23aa4f893e3288698c   123 MB`, `56701557241710576000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        <span class="token number">54</span> seconds ago      nginx -g daemon off<span class="token punctuation">;</span>                            <span class="token number">95</span> B                修改了默认网页\ne43d811ce2f4        <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["nginx" "-g" "daemon    0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  EXPOSE 443/tcp 80/tcp        0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token function">ln</span> -sf /dev/stdout /var/log/nginx/   <span class="token number">22</span> B\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   <span class="token number">58.46</span> MB\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  ENV NGINX_VERSION=1.11.5-1   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  MAINTAINER NGINX Docker Ma   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["/bin/bash"]            0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop) ADD file:23aa4f893e3288698c   123 MB</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的镜像定制好后，我们可以来运行这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87461205331825000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker run --name web2 -d -p 81:80 nginx:v2`, `87461205331825000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker run --name web2 -d -p <span class="token number">81</span>:80 nginx:v2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里我们命名为新的服务为 web2，并且映射到 81 端口。访问 <code class="language-text">http://localhost:81</code> 看到结果，其内容应该和之前修改后的 webserver 一样。</p>\n<p>至此，我们第一次完成了定制镜像，使用的是 docker commit 命令，手动操作给旧的镜像添加了新的一层，形成新的镜像，对镜像多层存储应该有了更直观的感觉。</p>\n<h3 id="慎用-docker-commit"><a href="#%E6%85%8E%E7%94%A8-docker-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>慎用 docker commit</h3>\n<p>使用 docker commit 命令虽然可以比较直观的帮助理解镜像分层存储的概念，但是实际环境中并不会这样使用。</p>\n<p>首先，如果仔细观察之前的 docker diff webserver 的结果，你会发现除了真正想要修改的 /usr/share/nginx/html/index.html 文件外，由于命令的执行，还有很多文件被改动或添加了。这还仅仅是最简单的操作，如果是安装软件包、编译构建，那会有大量的无关内容被添加进来，将会导致镜像极为臃肿。</p>\n<p>此外，使用 docker commit 意味着所有对镜像的操作都是黑箱操作，生成的镜像也被称为黑箱镜像，换句话说，就是除了制作镜像的人知道执行过什么命令、怎么生成的镜像，别人根本无从得知。而且，即使是这个制作镜像的人，过一段时间后也无法记清具体的操作。这种黑箱镜像的维护工作是非常痛苦的。</p>\n<p>而且，回顾之前提及的镜像所使用的分层存储的概念，除当前层外，之前的每一层都是不会发生改变的，换句话说，任何修改的结果仅仅是在当前层进行标记、添加、修改，而不会改动上一层。如果使用 docker commit 制作镜像，以及后期修改的话，每一次修改都会让镜像更加臃肿一次，所删除的上一层的东西并不会丢失，会一直如影随形的跟着这个镜像，即使根本无法访问到。这会让镜像更加臃肿。</p>\n<h2 id="使用-dockerfile-定制镜像"><a href="#%E4%BD%BF%E7%94%A8-dockerfile-%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Dockerfile 定制镜像</h2>\n<p>从刚才的 docker commit 的学习中，我们可以了解到，镜像的定制实际上就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是 Dockerfile。</p>\n<p>Dockerfile 是一个文本文件，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p>\n<p>还以之前定制 nginx 镜像为例，这次我们使用 Dockerfile 来定制。</p>\n<p>在一个空白目录中，建立一个文本文件，并命名为 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87461668101299290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mkdir mynginx\n\\$ cd mynginx\n\\$ touch Dockerfile`, `87461668101299290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mkdir</span> mynginx\n$ <span class="token builtin class-name">cd</span> mynginx\n$ <span class="token function">touch</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>其内容为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12138877604624022000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `12138877604624022000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM nginx\nRUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个 Dockerfile 很简单，一共就两行。涉及到了两条指令，FROM 和 RUN。</p>\n<h3 id="from-指定基础镜像"><a href="#from-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM 指定基础镜像</h3>\n<p>所谓定制镜像，那一定是以一个镜像为基础，在其上进行定制。就像我们之前运行了一个 nginx 镜像的容器，再进行修改一样，基础镜像是必须指定的。而 FROM 就是指定基础镜像，因此一个 Dockerfile 中 FROM 是必备的指令，并且必须是第一条指令。</p>\n<p>在 Docker Hub 上有非常多的高质量的官方镜像，有可以直接拿来使用的服务类的镜像，如 nginx、redis、mongo、mysql、httpd、php、tomcat 等；也有一些方便开发、构建、运行各种语言应用的镜像，如 node、openjdk、python、ruby、golang 等。可以在其中寻找一个最符合我们最终目标的镜像为基础镜像进行定制。</p>\n<p>如果没有找到对应服务的镜像，官方镜像中还提供了一些更为基础的操作系统镜像，如 ubuntu、debian、centos、fedora、alpine 等，这些操作系统的软件库为我们提供了更广阔的扩展空间。</p>\n<p>除了选择现有镜像为基础镜像外，Docker 还存在一个特殊的镜像，名为 scratch。这个镜像是虚拟的概念，并不实际存在，它表示一个空白的镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40207259060387760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n...`, `40207259060387760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你以 scratch 为基础镜像的话，意味着你不以任何镜像为基础，接下来所写的指令将作为镜像第一层开始存在。</p>\n<p>不以任何系统为基础，直接将可执行文件复制进镜像的做法并不罕见，对于 Linux 下静态编译的程序来说，并不需要有操作系统提供运行时支持，所需的一切库都已经在可执行文件里了，因此直接 FROM scratch 会让镜像体积更加小巧。使用 Go 语言开发的应用很多会使用这种方式来制作镜像，这也是为什么有人认为 Go 是特别适合容器微服务架构的语言的原因之一。</p>\n<h3 id="run-执行命令"><a href="#run-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN 执行命令</h3>\n<p>RUN 指令是用来执行命令行命令的。由于命令行的强大能力，RUN 指令在定制镜像时是最常用的指令之一。其格式有两种：</p>\n<ul>\n<li>\n<p>shell 格式：<code class="language-text">RUN &lt;命令&gt;</code>，就像直接在命令行中输入的命令一样。刚才写的 Dockerfile 中的 RUN 指令就是这种格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77250641583969440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `77250641583969440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>exec 格式：RUN [“可执行文件”, “参数 1”, “参数 2”]，这更像是函数调用中的格式。</p>\n</li>\n</ul>\n<p>既然 RUN 就像 Shell 脚本一样可以执行命令，那么我们是否就可以像 Shell 脚本一样把每个命令对应一个 RUN 呢？比如这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90493101172480410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install`, `90493101172480410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token function">apt-get</span> update\nRUN <span class="token function">apt-get</span> <span class="token function">install</span> -y gcc libc6-dev <span class="token function">make</span> <span class="token function">wget</span>\nRUN <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span>\nRUN <span class="token function">mkdir</span> -p /usr/src/redis\nRUN <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span>\nRUN <span class="token function">make</span> -C /usr/src/redis\nRUN <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之前说过，Dockerfile 中每一个指令都会建立一层，RUN 也不例外。每一个 RUN 的行为，就和刚才我们手工建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，commit 这一层的修改，构成新的镜像。</p>\n<p>而上面的这种写法，创建了 7 层镜像。这是完全没有意义的，而且很多运行时不需要的东西，都被装进了镜像里，比如编译环境、更新的软件包等等。结果就是产生非常臃肿、非常多层的镜像，不仅仅增加了构建部署的时间，也很容易出错。 这是很多初学 Docker 的人常犯的一个错误。</p>\n<p>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</p>\n<p>上面的 Dockerfile 正确的写法应该是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24046872379352523000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN set -x; buildDeps=\'gcc libc6-dev make wget\' \\\n    && apt-get update \\\n    && apt-get install -y \\$buildDeps \\\n    && wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot; \\\n    && mkdir -p /usr/src/redis \\\n    && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\n    && make -C /usr/src/redis \\\n    && make -C /usr/src/redis install \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && rm redis.tar.gz \\\n    && rm -r /usr/src/redis \\\n    && apt-get purge -y --auto-remove \\$buildDeps`, `24046872379352523000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token builtin class-name">set</span> -x<span class="token punctuation">;</span> <span class="token assign-left variable">buildDeps</span><span class="token operator">=</span><span class="token string">\'gcc libc6-dev make wget\'</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> update <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token variable">$buildDeps</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /var/lib/apt/lists/* <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> redis.tar.gz <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -r /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> purge -y --auto-remove <span class="token variable">$buildDeps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先，之前所有的命令只有一个目的，就是编译、安装 redis 可执行文件。因此没有必要建立很多层，这只是一层的事情。因此，这里没有使用很多个 RUN 一一对应不同的命令，而是仅仅使用一个 RUN 指令，并使用 &#x26;&#x26; 将各个所需命令串联起来，将之前的 7 层 简化为了 1 层。在撰写 Dockerfile 的时候，要经常提醒自己，这并不是在写 Shell 脚本，而是在定义每一层该如何构建。</p>\n<p>并且，这里为了格式化还进行了换行。Dockerfile 支持 Shell 类的行尾添加 \\ 的命令换行方式，以及行首 # 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</p>\n<p>此外，还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 apt 缓存文件。这是很重要的一步，我们之前说过，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p>\n<p>很多人初学 Docker 制作出了很臃肿的镜像的原因之一，就是忘记了每一层构建的最后一定要清理掉无关文件。</p>\n<h3 id="构建镜像"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>好了，让我们再回到之前定制的 nginx 镜像的 Dockerfile 来。现在我们明白了这个 Dockerfile 的内容，那么让我们来构建这个镜像吧。</p>\n<p>在 Dockerfile 文件所在目录执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31385767800522867000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM nginx\n ---> e43d811ce2f4\nStep 2 : RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\n ---> Running in 9cdc27646c7b\n ---> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c`, `31385767800522867000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\nStep <span class="token number">1</span> <span class="token builtin class-name">:</span> FROM nginx\n ---<span class="token operator">></span> e43d811ce2f4\nStep <span class="token number">2</span> <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 9cdc27646c7b\n ---<span class="token operator">></span> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从命令的输出结果中，我们可以清晰的看到镜像的构建过程。在 Step 2 中，如同我们之前所说的那样，RUN 指令启动了一个容器 9cdc27646c7b，执行了所要求的命令，并最后提交了这一层 44aa4490ce2c，随后删除了所用到的这个容器 9cdc27646c7b。</p>\n<p>这里我们使用了 docker build 命令进行镜像构建。其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86458457549106230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build [选项] <上下文路径/URL/->`, `86458457549106230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>上下文路径/URL/-<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这里我们指定了最终镜像的名称 <code class="language-text">-t nginx:v3</code>，构建成功后，我们可以像之前运行 nginx:v2 那样来运行这个镜像，其结果会和 nginx:v2 一样。</p>\n<h3 id="镜像构建上下文（context）"><a href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88context%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像构建上下文（Context）</h3>\n<p>如果注意，会看到 docker build 命令最后有一个 <code class="language-text">.</code>。<code class="language-text">.</code> 表示当前目录，而 Dockerfile 就在当前目录，因此不少初学者以为这个路径是在指定 Dockerfile 所在路径，这么理解其实是不准确的。如果对应上面的命令格式，你可能会发现，这是在指定上下文路径。那么什么是上下文呢？</p>\n<p>首先我们要理解 docker build 的工作原理。Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。Docker 的引擎提供了一组 REST API，被称为 Docker Remote API，而如 docker 命令这样的客户端工具，则是通过这组 API 与 Docker 引擎交互，从而完成各种功能。因此，虽然表面上我们好像是在本机执行各种 docker 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，让我们操作远程服务器的 Docker 引擎变得轻而易举。</p>\n<p>当我们进行镜像构建的时候，并非所有定制都会通过 RUN 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 COPY 指令、ADD 指令等。而 docker build 命令构建镜像，其实并非在本地构建，而是在服务端，也就是 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p>\n<p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，docker build 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p>\n<p>如果在 Dockerfile 中这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89155944848468070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./package.json /app/`, `89155944848468070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">COPY ./package.json /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这并不是要复制执行 docker build 命令所在的目录下的 package.json，也不是复制 Dockerfile 所在目录下的 package.json，而是复制上下文（context）目录下的 package.json。</p>\n<p>因此，COPY 这类指令中的源文件的路径都是相对路径。这也是初学者经常会问的为什么 <code class="language-text">COPY ../package.json /app</code> 或者 <code class="language-text">COPY /opt/xxxx /app</code> 无法工作的原因，因为这些路径已经超出了上下文的范围，Docker 引擎无法获得这些位置的文件。如果真的需要那些文件，应该将它们复制到上下文目录中去。</p>\n<p>现在就可以理解刚才的命令 <code class="language-text">docker build -t nginx:v3 .</code> 中的这个 <code class="language-text">.</code>，实际上是在指定上下文的目录，docker build 命令会将该目录下的内容打包交给 Docker 引擎以帮助构建镜像。</p>\n<p>如果观察 docker build 输出，我们其实已经看到了这个发送上下文的过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75039426143029120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\n...`, `75039426143029120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>理解构建上下文对于镜像构建是很重要的，避免犯一些不应该的错误。比如有些初学者在发现 <code class="language-text">COPY /opt/xxxx /app</code> 不工作后，于是干脆将 Dockerfile 放到了硬盘根目录去构建，结果发现 docker build 执行后，在发送一个几十 GB 的东西，极为缓慢而且很容易构建失败。那是因为这种做法是在让 docker build 打包整个硬盘，这显然是使用错误。</p>\n<p>一般来说，应该会将 Dockerfile 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 .gitignore 一样的语法写一个 .dockerignore，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p>\n<p>那么为什么会有人误以为 <code class="language-text">.</code> 是指定 Dockerfile 所在目录呢？这是因为在默认情况下，如果不额外指定 Dockerfile 的话，会将上下文目录下的名为 Dockerfile 的文件作为 Dockerfile。</p>\n<p>这只是默认行为，实际上 Dockerfile 的文件名并不要求必须为 Dockerfile，而且并不要求必须位于上下文目录中，比如可以用 -f ../Dockerfile.php 参数指定某个文件作为 Dockerfile。</p>\n<p>当然，一般大家习惯性的会使用默认的文件名 Dockerfile，以及会将其置于镜像构建上下文目录中。</p>\n<h3 id="其它-docker-build-的用法"><a href="#%E5%85%B6%E5%AE%83-docker-build-%E7%9A%84%E7%94%A8%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它 docker build 的用法</h3>\n<h4 id="直接用-git-repo-进行构建"><a href="#%E7%9B%B4%E6%8E%A5%E7%94%A8-git-repo-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接用 Git repo 进行构建</h4>\n<p>或许你已经注意到了，docker build 还支持从 URL 构建，比如可以直接从 Git repo 中构建：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64913978956033016000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$env:DOCKER_BUILDKIT=0\n# export DOCKER_BUILDKIT=0\n\n\\$ docker build -t hello-world https://github.com/docker-library/hello-world.git#master:amd64/hello-world\n\nStep 1/3 : FROM scratch\n --->\nStep 2/3 : COPY hello /\n ---> ac779757d46e\nStep 3/3 : CMD [&quot;/hello&quot;]\n ---> Running in d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---> 038ad4142d2b\nSuccessfully built 038ad4142d2b`, `64913978956033016000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $env:DOCKER_BUILDKIT=0</span>\n<span class="token comment"># export DOCKER_BUILDKIT=0</span>\n\n$ docker build -t hello-world https://github.com/docker-library/hello-world.git<span class="token comment">#master:amd64/hello-world</span>\n\nStep <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM scratch\n ---<span class="token operator">></span>\nStep <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> COPY hello /\n ---<span class="token operator">></span> ac779757d46e\nStep <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"/hello"</span><span class="token punctuation">]</span>\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---<span class="token operator">></span> 038ad4142d2b\nSuccessfully built 038ad4142d2b</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这行命令指定了构建所需的 Git repo，并且指定分支为 master，构建目录为 /amd64/hello-world/，然后 Docker 就会自己去 git clone 这个项目、切换到指定分支、并进入到指定目录后开始构建。</p>\n<h4 id="用给定的-tar-压缩包构建"><a href="#%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84-tar-%E5%8E%8B%E7%BC%A9%E5%8C%85%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用给定的 tar 压缩包构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97204220962799190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build http://server/context.tar.gz`, `97204220962799190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build http://server/context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果所给出的 URL 不是个 Git repo，而是个 tar 压缩包，那么 Docker 引擎会下载这个包，并自动解压缩，以其作为上下文，开始构建。</p>\n<h4 id="从标准输入中读取-dockerfile-进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96-dockerfile-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取 Dockerfile 进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7864501965698567000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build - < Dockerfile`, `7864501965698567000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build - <span class="token operator">&lt;</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23758409866148790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cat Dockerfile | docker build -`, `23758409866148790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">cat</span> Dockerfile <span class="token operator">|</span> docker build -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果标准输入传入的是文本文件，则将其视为 Dockerfile，并开始构建。这种形式由于直接从标准输入中读取 Dockerfile 的内容，它没有上下文，因此不可以像其他方法那样可以将本地文件 COPY 进镜像之类的事情。</p>\n<h4 id="从标准输入中读取上下文压缩包进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9%E5%8C%85%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取上下文压缩包进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30023135396479920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build - < context.tar.gz`, `30023135396479920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build - <span class="token operator">&lt;</span> context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果发现标准输入的文件格式是 gzip、bzip2 以及 xz 的话，将会使其为上下文压缩包，直接将其展开，将里面视为上下文，并开始构建。</p>\n<h2 id="其它制作镜像的方式"><a href="#%E5%85%B6%E5%AE%83%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它制作镜像的方式</h2>\n<p>除了标准的使用 Dockerfile 生成镜像的方法外，由于各种特殊需求和历史原因，还提供了一些其它方法用以生成镜像。</p>\n<h3 id="从-rootfs-压缩包导入"><a href="#%E4%BB%8E-rootfs-%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%AF%BC%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从 rootfs 压缩包导入</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8352649412000690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker import [选项] <文件>|<URL>|- [<仓库名>[:<标签>]]`, `8352649412000690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker <span class="token function">import</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>文件<span class="token operator">>|</span><span class="token operator">&lt;</span>URL<span class="token operator">>|</span>- <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>压缩包可以是本地文件、远程 Web 文件，甚至是从标准输入中得到。压缩包将会在镜像 / 目录展开，并直接作为镜像第一层提交。</p>\n<p>比如我们想要创建一个 OpenVZ 的 Ubuntu 16.04 模板的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80783235696808460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import \\\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz \\\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213`, `80783235696808460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> <span class="token punctuation">\\</span>\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz <span class="token punctuation">\\</span>\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这条命令自动下载了 ubuntu-16.04-x86_64.tar.gz 文件，并且作为根文件系统展开导入，并保存为镜像 openvz/ubuntu:16.04。</p>\n<p>导入成功后，我们可以用 docker image ls 看到这个导入的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55163250322380460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       16.04               412b8fc3e3f7        55 seconds ago      505MB`, `55163250322380460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       <span class="token number">16.04</span>               412b8fc3e3f7        <span class="token number">55</span> seconds ago      505MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果我们查看其历史的话，会看到描述中有导入的文件链接：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30245263145590727000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       214.9 MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz`, `30245263145590727000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       <span class="token number">214.9</span> MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="docker-镜像的导入和导出-docker-save-和-docker-load"><a href="#docker-%E9%95%9C%E5%83%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA-docker-save-%E5%92%8C-docker-load" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 镜像的导入和导出 docker save 和 docker load</h2>\n<p>Docker 还提供了 docker save 和 docker load 命令，用以将镜像保存为一个文件，然后传输到另一个位置上，再加载进来。这是在没有 Docker Registry 时的做法，现在已经不推荐，镜像迁移应该直接使用 Docker Registry，无论是直接使用 Docker Hub 还是使用内网私有 Registry 都可以。</p>\n<h3 id="保存镜像"><a href="#%E4%BF%9D%E5%AD%98%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保存镜像</h3>\n<p>使用 docker save 命令可以将镜像保存为归档文件。</p>\n<p>比如我们希望保存这个 alpine 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1492610084081014000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        5 weeks ago         4.803 MB`, `1492610084081014000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        <span class="token number">5</span> weeks ago         <span class="token number">4.803</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>保存镜像的命令为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50841059089482930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine -o filename\n\\$ file filename\nfilename: POSIX tar archive`, `50841059089482930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine -o filename\n$ <span class="token function">file</span> filename\nfilename: POSIX <span class="token function">tar</span> archive</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里的 filename 可以为任意名称甚至任意后缀名，但文件的本质都是归档文件</p>\n<p>注意：如果同名则会覆盖（没有警告）</p>\n<p>若使用 gzip 压缩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67501471245154860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine | gzip > alpine-latest.tar.gz`, `67501471245154860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">></span> alpine-latest.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后我们将 alpine-latest.tar.gz 文件复制到了到了另一个机器上，可以用下面这个命令加载镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16877723099161446000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest`, `16877723099161446000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果我们结合这两个命令以及 ssh 甚至 pv 的话，利用 Linux 强大的管道，我们可以写一个命令完成从一个机器将镜像迁移到另一个机器，并且带进度条的功能：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24323401169551938000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker save <镜像名> | bzip2 | pv | ssh <用户名>@<主机名> \'cat | docker load\'`, `24323401169551938000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker save <span class="token operator">&lt;</span>镜像名<span class="token operator">></span> <span class="token operator">|</span> <span class="token function">bzip2</span> <span class="token operator">|</span> <span class="token function">pv</span> <span class="token operator">|</span> <span class="token function">ssh</span> <span class="token operator">&lt;</span>用户名<span class="token operator">></span>@<span class="token operator">&lt;</span>主机名<span class="token operator">></span> <span class="token string">\'cat | docker load\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="镜像的实现原理"><a href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像的实现原理</h2>\n<p>Docker 镜像是怎么实现增量的修改和维护的？</p>\n<p>每个镜像都由很多层次构成，Docker 使用 Union FS 将这些不同的层结合到一个镜像中去。</p>\n<p>通常 Union FS 有两个用途, 一方面可以实现不借助 LVM、RAID 将多个 disk 挂到同一个目录下,另一个更常用的就是将一个只读的分支和一个可写的分支联合在一起，Live CD 正是基于此方法可以允许在镜像不变的基础上允许用户在其上进行一些写操作。</p>\n<p>Docker 在 OverlayFS 上构建的容器也是利用了类似的原理。</p>\n<h1 id="dockerfile"><a href="#dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h1>\n<h2 id="copy-复制文件"><a href="#copy-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>COPY 复制文件</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径&gt;... &lt;目标路径&gt;</code></li>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></li>\n</ul>\n<p>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p>\n<p>COPY 指令将从构建上下文目录中 <code class="language-text">&lt;源路径&gt;</code> 的文件/目录复制到新的一层的镜像内的 <code class="language-text">&lt;目标路径&gt;</code> 位置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65663706509278860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY package.json /usr/src/app/`, `65663706509278860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> package.json /usr/src/app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95267196393397710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY hom* /mydir/\nCOPY hom?.txt /mydir/`, `95267196393397710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> hom* /mydir/\n<span class="token keyword">COPY</span> hom<span class="token punctuation">?</span>.txt /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>\n<p>此外，还需要注意一点，使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71239086362439565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY --chown=55:mygroup files* /mydir/\nCOPY --chown=bin files* /mydir/\nCOPY --chown=1 files* /mydir/\nCOPY --chown=10:11 files* /mydir/`, `71239086362439565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</p>\n<h2 id="add-更高级的复制文件"><a href="#add-%E6%9B%B4%E9%AB%98%E7%BA%A7%E7%9A%84%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 更高级的复制文件</h2>\n<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。</p>\n<p>比如 <code class="language-text">&lt;源路径&gt;</code> 可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 <code class="language-text">&lt;目标路径&gt;</code> 去。下载后的文件权限自动设置为 600，如果这并不是想要的权限，那么还需要增加额外的一层 RUN 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 RUN 指令进行解压缩。所以不如直接使用 RUN 指令，然后使用 wget 或者 curl 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p>\n<p>如果 <code class="language-text">&lt;源路径&gt;</code> 为一个 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，ADD 指令将会自动解压缩这个压缩文件到 <code class="language-text">&lt;目标路径&gt;</code> 去。</p>\n<p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 ubuntu 中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98427776674591930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\nADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /\n...`, `98427776674591930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> scratch\n<span class="token keyword">ADD</span> ubuntu<span class="token punctuation">-</span>xenial<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cloudimg<span class="token punctuation">-</span>amd64<span class="token punctuation">-</span>root.tar.gz /\n<span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但在某些情况下，如果我们真的是希望复制个压缩文件进去，而不解压缩，这时就不可以使用 ADD 命令了。</p>\n<p>在 Docker 官方的 Dockerfile 最佳实践文档中要求，尽可能的使用 COPY，因为 COPY 的语义很明确，就是复制文件而已，而 ADD 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 ADD 的场合，就是所提及的需要自动解压缩的场合。</p>\n<p>另外需要注意的是，ADD 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。</p>\n<p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97007397691496760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD --chown=55:mygroup files* /mydir/\nADD --chown=bin files* /mydir/\nADD --chown=1 files* /mydir/k\nADD --chown=10:11 files* /mydir/`, `97007397691496760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/k\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cmd-容器启动命令"><a href="#cmd-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD 容器启动命令</h2>\n<p>CMD 指令的格式和 RUN 相似，也是两种格式：</p>\n<ul>\n<li>shell 格式：<code class="language-text">CMD &lt;命令&gt;</code></li>\n<li>exec 格式：<code class="language-text">CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>\n<li>参数列表格式：<code class="language-text">CMD [&quot;参数1&quot;, &quot;参数2&quot;...]</code>。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。</li>\n</ul>\n<p>之前介绍容器的时候曾经说过，Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。CMD 指令就是用于指定默认的容器主进程的启动命令的。</p>\n<p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，ubuntu 镜像默认的 CMD 是 <code class="language-text">/bin/bash</code>，如果我们直接 <code class="language-text">docker run -it ubuntu</code> 的话，会直接进入 bash。我们也可以在运行时指定运行别的命令，如 <code class="language-text">docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code class="language-text">cat /etc/os-release</code> 命令替换了默认的 <code class="language-text">/bin/bash</code> 命令了，输出了系统版本信息。</p>\n<p>在指令格式上，一般推荐使用 exec 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号，而不要使用单引号。</p>\n<p>如果使用 shell 格式的话，实际的命令会被包装为 <code class="language-text">sh -c</code> 的参数的形式进行执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48435705756516565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD echo \\$HOME`, `48435705756516565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> echo $HOME</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在实际执行中，会将其变更为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35236514509972648000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo \\$HOME&quot; ]`, `35236514509972648000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $HOME"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p>\n<p>提到 CMD 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p>\n<p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 systemd 去启动后台服务，容器内没有后台服务的概念。</p>\n<p>一些初学者将 CMD 写为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51262731751756130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD service nginx start`, `51262731751756130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> service nginx start</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后发现容器执行后就立即退出了。甚至在容器内去使用 systemctl 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p>\n<p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p>\n<p>而使用 <code class="language-text">service nginx start</code> 命令，则是希望 upstart 来以后台守护进程形式启动 nginx 服务。而刚才说了 <code class="language-text">CMD service nginx start</code> 会被理解为 <code class="language-text">CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</code>，因此主进程实际上是 sh。那么当 <code class="language-text">service nginx start</code> 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</p>\n<p>正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75810687526739850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]`, `75810687526739850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"nginx"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"daemon off;"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="entrypoint-入口点"><a href="#entrypoint-%E5%85%A5%E5%8F%A3%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT 入口点</h2>\n<p>ENTRYPOINT 的格式和 RUN 指令格式一样，分为 exec 格式和 shell 格式。</p>\n<p>ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 <code class="language-text">--entrypoint</code> 来指定。</p>\n<p>当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61214722627095510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<ENTRYPOINT> &quot;<CMD>&quot;`, `61214722627095510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>ENTRYPOINT<span class="token operator">></span> <span class="token string">"&lt;CMD>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那么有了 CMD 后，为什么还要有 ENTRYPOINT 呢？这种 <code class="language-text">&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</code> 有什么好处么？让我们来看几个场景。</p>\n<h3 id="场景一：让镜像变成像命令一样使用"><a href="#%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E8%AE%A9%E9%95%9C%E5%83%8F%E5%8F%98%E6%88%90%E5%83%8F%E5%91%BD%E4%BB%A4%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景一：让镜像变成像命令一样使用</h3>\n<p>假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 CMD 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42975895723182680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nCMD [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `42975895723182680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假如我们使用 <code class="language-text">docker build -t myip .</code> 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68022130290536740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通`, `68022130290536740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 CMD 中可以看到实质的命令是 curl，那么如果我们希望显示 HTTP 头信息，就需要加上 -i 参数。那么我们可以直接加 -i 参数给 <code class="language-text">docker run myip</code> 么？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74423378834221700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip -i\ndocker: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \\&quot;exec: \\\\\\&quot;-i\\\\\\&quot;: executable file not found in \\$PATH\\&quot;\\n&quot;.`, `74423378834221700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip -i\ndocker: Error response from daemon: invalid header field value <span class="token string">"oci runtime error: container_linux.go:247: starting container process caused <span class="token entity" title="\\&quot;">\\"</span>exec: <span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>-i<span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>: executable file not found in <span class="token environment constant">$PATH</span><span class="token entity" title="\\&quot;">\\"</span><span class="token entity" title="\\n">\\n</span>"</span><span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们可以看到可执行文件找不到的报错，<code class="language-text">executable file not found</code>。之前我们说过，跟在镜像名后面的是 command，运行时会替换 CMD 的默认值。因此这里的 -i 替换了原来的 CMD，而不是添加在原来的 <code class="language-text">curl -s http://myip.ipip.net</code> 后面。而 -i 根本不是命令，所以自然找不到。</p>\n<p>那么如果我们希望加入 -i 这参数，我们就必须重新完整的输入这个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45005347047710040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip curl -s http://myip.ipip.net -i`, `45005347047710040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip <span class="token function">curl</span> -s http://myip.ipip.net -i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这显然不是很好的解决方案，而使用 ENTRYPOINT 就可以解决这个问题。现在我们重新用 ENTRYPOINT 来实现这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58077873512084865000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `58077873512084865000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们再来尝试直接使用 <code class="language-text">docker run myip -i</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96074662689629220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n\\$ docker run myip -i\nHTTP/1.1 200 OK\nServer: nginx/1.8.0\nDate: Tue, 22 Nov 2016 05:12:40 GMT\nContent-Type: text/html; charset=UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: 1.1 cache-2:80, 1.1 proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通`, `96074662689629220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n$ docker run myip -i\nHTTP/1.1 <span class="token number">200</span> OK\nServer: nginx/1.8.0\nDate: Tue, <span class="token number">22</span> Nov <span class="token number">2016</span> 05:12:40 GMT\nContent-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: <span class="token number">1.1</span> cache-2:80, <span class="token number">1.1</span> proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这次成功了。这是因为当存在 ENTRYPOINT 后，CMD 的内容将会作为参数传给 ENTRYPOINT，而这里 -i 就是新的 CMD，因此会作为参数传给 curl，从而达到了我们预期的效果。</p>\n<h3 id="场景二：应用运行前的准备工作"><a href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景二：应用运行前的准备工作</h3>\n<p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>\n<p>比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>\n<p>此外，可能希望避免使用 root 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 root 身份执行，方便调试等。</p>\n<p>这些准备工作是和容器 CMD 无关的，无论 CMD 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 ENTRYPOINT 中去执行，而这个脚本会将接到的参数（也就是 <code class="language-text">&lt;CMD&gt;</code>）作为命令，在脚本最后执行。比如官方镜像 redis 中就是这么做的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27415134298731725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:3.4\n...\nRUN addgroup -S redis && adduser -S -G redis redis\n...\nENTRYPOINT [&quot;docker-entrypoint.sh&quot;]\n\nEXPOSE 6379\nCMD [ &quot;redis-server&quot; ]`, `27415134298731725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>3.4\n<span class="token punctuation">...</span>\n<span class="token keyword">RUN</span> addgroup <span class="token punctuation">-</span>S redis &amp;&amp; adduser <span class="token punctuation">-</span>S <span class="token punctuation">-</span>G redis redis\n<span class="token punctuation">...</span>\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"docker-entrypoint.sh"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">EXPOSE</span> 6379\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 ENTRYPOINT 为 docker-entrypoint.sh 脚本。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2867982259061330400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n...\n# allow the container to be started with \\`--user\\`\nif [ &quot;\\$1&quot; = \'redis-server\' -a &quot;\\$(id -u)&quot; = \'0\' ]; then\n   find . \\! -user redis -exec chown redis \'{}\' +\n   exec gosu redis &quot;\\$0&quot; &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `2867982259061330400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token punctuation">..</span>.\n<span class="token comment"># allow the container to be started with `--user`</span>\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'redis-server\'</span> -a <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span>"</span> <span class="token operator">=</span> <span class="token string">\'0\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n   <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token punctuation">\\</span><span class="token operator">!</span> -user redis -exec <span class="token function">chown</span> redis <span class="token string">\'{}\'</span> +\n   <span class="token builtin class-name">exec</span> gosu redis <span class="token string">"<span class="token variable">$0</span>"</span> <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该脚本的内容就是根据 CMD 的内容来判断，如果是 redis-server 的话，则切换到 redis 用户身份启动服务器，否则依旧使用 root 身份执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93094536856376210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it redis id\nuid=0(root) gid=0(root) groups=0(root)`, `93094536856376210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it redis <span class="token function">id</span>\n<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="env-设置环境变量"><a href="#env-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV 设置环境变量</h2>\n<p>格式有两种：</p>\n<ul>\n<li><code class="language-text">ENV &lt;key&gt; &lt;value&gt;</code></li>\n<li><code class="language-text">ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></li>\n</ul>\n<p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令如 RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90314638614853580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV VERSION=1.0 DEBUG=on \\\n    NAME=&quot;Happy Feet&quot;`, `90314638614853580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> VERSION=1.0 DEBUG=on \\\n    NAME=<span class="token string">"Happy Feet"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>\n<p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 node 镜像 Dockerfile 中，就有类似这样的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75371817137958190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV NODE_VERSION 7.2.0\n\nRUN curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; \\\n  && curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/SHASUMS256.txt.asc&quot; \\\n  && gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \\\n  && grep &quot; node-v\\$NODE_VERSION-linux-x64.tar.xz\\\\$&quot; SHASUMS256.txt | sha256sum -c - \\\n  && tar -xJf &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; -C /usr/local --strip-components=1 \\\n  && rm &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt \\\n  && ln -s /usr/local/bin/node /usr/local/bin/nodejs`, `75371817137958190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> NODE_VERSION 7.2.0\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz"</span> \\\n  &amp;&amp; curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc"</span> \\\n  &amp;&amp; gpg <span class="token punctuation">-</span><span class="token punctuation">-</span>batch <span class="token punctuation">-</span><span class="token punctuation">-</span>decrypt <span class="token punctuation">-</span><span class="token punctuation">-</span>output SHASUMS256.txt SHASUMS256.txt.asc \\\n  &amp;&amp; grep <span class="token string">" node-v$NODE_VERSION-linux-x64.tar.xz\\$"</span> SHASUMS256.txt <span class="token punctuation">|</span> sha256sum <span class="token punctuation">-</span>c <span class="token punctuation">-</span> \\\n  &amp;&amp; tar <span class="token punctuation">-</span>xJf <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> <span class="token punctuation">-</span>C /usr/local <span class="token punctuation">-</span><span class="token punctuation">-</span>strip<span class="token punctuation">-</span>components=1 \\\n  &amp;&amp; rm <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> SHASUMS256.txt.asc SHASUMS256.txt \\\n  &amp;&amp; ln <span class="token punctuation">-</span>s /usr/local/bin/node /usr/local/bin/nodejs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这里先定义了环境变量 <code class="language-text">NODE_VERSION</code>，其后的 RUN 这层里，多次使用 <code class="language-text">$NODE_VERSION</code> 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 7.2.0 即可，Dockerfile 构建维护变得更轻松了。</p>\n<p>下列指令可以支持环境变量展开：ADD、COPY、ENV、EXPOSE、FROM、LABEL、USER、WORKDIR、VOLUME、STOPSIGNAL、ONBUILD、RUN。</p>\n<p>可以从这个指令列表里感觉到，环境变量可以使用的地方很多，很强大。通过环境变量，我们可以让一份 Dockerfile 制作更多的镜像，只需使用不同的环境变量即可。</p>\n<h2 id="arg-构建参数"><a href="#arg-%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ARG 构建参数</h2>\n<p>格式：<code class="language-text">ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></p>\n<p>构建参数和 ENV 的效果一样，都是设置环境变量。所不同的是，ARG 所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 ARG 保存密码之类的信息，因为 docker history 还是可以看到所有值的。</p>\n<p>Dockerfile 中的 ARG 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 docker build 中用 <code class="language-text">--build-arg &lt;参数名&gt;=&lt;值&gt;</code> 来覆盖。</p>\n<p>灵活的使用 ARG 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p>\n<p>ARG 指令有生效范围，如果在 FROM 指令之前指定，那么只能用于 FROM 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67040701654514190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `67040701654514190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用上述 Dockerfile 会发现无法输出 <code class="language-text">${DOCKER_USERNAME}</code> 变量的值，要想正常输出，你必须在 FROM 之后再次指定 ARG</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51374472127636440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 只在 FROM 中生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 要想在 FROM 之后使用，必须再次指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `51374472127636440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 只在 FROM 中生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 要想在 FROM 之后使用，必须再次指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于多阶段构建，尤其要注意这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28683943140164000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 这个变量在每个 FROM 中都生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 1\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 2`, `28683943140164000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 这个变量在每个 FROM 中都生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 1\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于上述 Dockerfile 两个 FROM 指令都可以使用 <code class="language-text">${DOCKER_USERNAME}</code>，对于在各个阶段中使用的变量都必须在每个阶段分别指定：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86601219496692680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `86601219496692680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="volume-定义匿名卷"><a href="#volume-%E5%AE%9A%E4%B9%89%E5%8C%BF%E5%90%8D%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME 定义匿名卷</h2>\n<p>格式为：</p>\n<ul>\n<li><code class="language-text">VOLUME [&quot;&lt;路径 1&gt;&quot;, &quot;&lt;路径 2&gt;&quot;...]</code></li>\n<li><code class="language-text">VOLUME &lt;路径&gt;</code></li>\n</ul>\n<p>之前我们说过，容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中，后面的章节我们会进一步介绍 Docker 卷的概念。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 Dockerfile 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57584691178441050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`VOLUME /data`, `57584691178441050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">VOLUME</span> /data</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里的 /data 目录就会在容器运行时自动挂载为匿名卷，任何向 /data 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行容器时可以覆盖这个挂载设置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31037564371052028000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -v mydata:/data xxxx`, `31037564371052028000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v mydata<span class="token punctuation">:</span>/data xxxx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这行命令中，就使用了 mydata 这个命名卷挂载到了 /data 这个位置，替代了 Dockerfile 中定义的匿名卷的挂载配置。</p>\n<h2 id="expose-声明端口"><a href="#expose-%E5%A3%B0%E6%98%8E%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE 声明端口</h2>\n<p>格式为 <code class="language-text">EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]</code>。</p>\n<p>EXPOSE 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 <code class="language-text">docker run -P</code> 时，会自动随机映射 EXPOSE 的端口。</p>\n<p>要将 EXPOSE 和在运行时使用 <code class="language-text">-p &lt;宿主端口&gt;:&lt;容器端口&gt;</code> 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p>\n<h2 id="workdir-指定工作目录"><a href="#workdir-%E6%8C%87%E5%AE%9A%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR 指定工作目录</h2>\n<p>格式为 <code class="language-text">WORKDIR &lt;工作目录路径&gt;</code>。</p>\n<p>使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p>\n<p>之前提到一些初学者常犯的错误是把 Dockerfile 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4548755993164089000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN cd /app\nRUN echo &quot;hello&quot; > world.txt`, `4548755993164089000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> cd /app\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果将这个 Dockerfile 进行构建镜像运行后，会发现找不到 <code class="language-text">/app/world.txt</code> 文件，或者其内容不是 hello。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 Dockerfile 中，这两行 RUN 命令的执行环境根本不同，是两个完全不同的容器。这就是对 Dockerfile 构建分层存储的概念不了解所导致的错误。</p>\n<p>之前说过每一个 RUN 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 <code class="language-text">RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p>\n<p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 WORKDIR 指令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43923988616352874000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /app\n\nRUN echo &quot;hello&quot; > world.txt`, `43923988616352874000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 WORKDIR 指令使用的相对路径，那么所切换的路径与之前的 WORKDIR 有关：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76916725855267820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /a\nWORKDIR b\nWORKDIR c\n\nRUN pwd`, `76916725855267820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /a\n<span class="token keyword">WORKDIR</span> b\n<span class="token keyword">WORKDIR</span> c\n\n<span class="token keyword">RUN</span> pwd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RUN pwd 的工作目录为 /a/b/c。</p>\n<h2 id="user-指定当前用户"><a href="#user-%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER 指定当前用户</h2>\n<p>格式：<code class="language-text">USER &lt;用户名&gt;[:&lt;用户组&gt;]</code></p>\n<p>USER 指令和 WORKDIR 相似，都是改变环境状态并影响以后的层。WORKDIR 是改变工作目录，USER 则是改变之后层的执行 RUN, CMD 以及 ENTRYPOINT 这类命令的身份。</p>\n<p>注意，USER 只是帮助你切换到指定用户而已，这个用户必须是事先建立好的，否则无法切换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14582892330584496000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN groupadd -r redis && useradd -r -g redis redis\nUSER redis\nRUN [ &quot;redis-server&quot; ]`, `14582892330584496000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token keyword">USER</span> redis\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果以 root 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 su 或者 sudo，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 gosu。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64607367239056620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 建立 redis 用户，并使用 gosu 换另一个用户执行命令\nRUN groupadd -r redis && useradd -r -g redis redis\n# 下载 gosu\nRUN wget -O /usr/local/bin/gosu &quot;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64&quot; \\\n    && chmod +x /usr/local/bin/gosu \\\n    && gosu nobody true\n# 设置 CMD，并以另外的用户执行\nCMD [ &quot;exec&quot;, &quot;gosu&quot;, &quot;redis&quot;, &quot;redis-server&quot; ]`, `64607367239056620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 建立 redis 用户，并使用 gosu 换另一个用户执行命令</span>\n<span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token comment"># 下载 gosu</span>\n<span class="token keyword">RUN</span> wget <span class="token punctuation">-</span>O /usr/local/bin/gosu <span class="token string">"https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64"</span> \\\n    &amp;&amp; chmod +x /usr/local/bin/gosu \\\n    &amp;&amp; gosu nobody true\n<span class="token comment"># 设置 CMD，并以另外的用户执行</span>\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"gosu"</span><span class="token punctuation">,</span> <span class="token string">"redis"</span><span class="token punctuation">,</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="healthcheck-健康检查"><a href="#healthcheck-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HEALTHCHECK 健康检查</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">HEALTHCHECK [选项] CMD &lt;命令&gt;</code>：设置检查容器健康状况的命令</li>\n<li><code class="language-text">HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</li>\n</ul>\n<p>HEALTHCHECK 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。</p>\n<p>在没有 HEALTHCHECK 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。</p>\n<p>而自 1.12 之后，Docker 提供了 HEALTHCHECK 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。</p>\n<p>当在一个镜像指定了 HEALTHCHECK 指令后，用其启动容器，初始状态会为 starting，在 HEALTHCHECK 指令检查成功后变为 healthy，如果连续一定次数失败，则会变为 unhealthy。</p>\n<p>HEALTHCHECK 支持下列选项：</p>\n<ul>\n<li><code class="language-text">--interval=&lt;间隔&gt;</code>：两次健康检查的间隔，默认为 30 秒；</li>\n<li><code class="language-text">--timeout=&lt;时长&gt;</code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</li>\n<li><code class="language-text">--retries=&lt;次数&gt;</code>：当连续失败指定次数后，则将容器状态视为 unhealthy，默认 3 次。</li>\n</ul>\n<p>和 CMD, ENTRYPOINT 一样，HEALTHCHECK 只可以出现一次，如果写了多个，只有最后一个生效。</p>\n<p>在 <code class="language-text">HEALTHCHECK [选项] CMD</code> 后面的命令，格式和 ENTRYPOINT 一样，分为 shell 格式，和 exec 格式。命令的返回值决定了该次健康检查的成功与否：0：成功；1：失败；2：保留，不要使用这个值。</p>\n<p>假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 curl 来帮助判断，其 Dockerfile 的 HEALTHCHECK 可以这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42134431691572340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*\nHEALTHCHECK --interval=5s --timeout=3s \\\n  CMD curl -fs http://localhost/ || exit 1`, `42134431691572340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> nginx\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">HEALTHCHECK</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>interval=5s <span class="token punctuation">-</span><span class="token punctuation">-</span>timeout=3s \\\n  <span class="token keyword">CMD</span> curl <span class="token punctuation">-</span>fs http<span class="token punctuation">:</span>//localhost/ <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 curl -fs <a href="http://localhost/" target="_blank" rel="nofollow noreferrer noopener">http://localhost/</a> || exit 1 作为健康检查命令。</p>\n<p>使用 docker build 来构建这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57528052593602520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t myweb:v1 .`, `57528052593602520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t myweb:v1 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>构建好了后，我们启动一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6752948023739691000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d --name web -p 80:80 myweb:v1`, `6752948023739691000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d --name web -p <span class="token number">80</span>:80 myweb:v1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当运行该镜像后，可以通过 <code class="language-text">docker container ls</code> 看到最初的状态为 (health: starting)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1320248023443016000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   3 seconds ago       Up 2 seconds (health: starting)   80/tcp, 443/tcp     web`, `1320248023443016000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">3</span> seconds ago       Up <span class="token number">2</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在等待几秒钟后，再次 docker container ls，就会看到健康状态变化为了 (healthy)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51328079219146690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   18 seconds ago      Up 16 seconds (healthy)   80/tcp, 443/tcp     web`, `51328079219146690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">18</span> seconds ago      Up <span class="token number">16</span> seconds <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果健康检查连续失败超过了重试次数，状态就会变为 (unhealthy)。</p>\n<p>为了帮助排障，健康检查命令的输出（包括 stdout 以及 stderr）都会被存储于健康状态里，可以用 docker inspect 来查看。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30496911092077750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format \'{{json .State.Health}}\' web | python -m json.tool\n{\n    &quot;FailingStreak&quot;: 0,\n    &quot;Log&quot;: [\n        {\n            &quot;End&quot;: &quot;2016-11-25T14:35:37.940957051Z&quot;,\n            &quot;ExitCode&quot;: 0,\n            &quot;Output&quot;: &quot;<!DOCTYPE html>\\n<html>\\n<head>\\n<title>Welcome to nginx!</title>\\n<style>\\n    body {\\n        width: 35em;\\n        margin: 0 auto;\\n        font-family: Tahoma, Verdana, Arial, sans-serif;\\n    }\\n</style>\\n</head>\\n<body>\\n<h1>Welcome to nginx!</h1>\\n<p>If you see this page, the nginx web server is successfully installed and\\nworking. Further configuration is required.</p>\\n\\n<p>For online documentation and support please refer to\\n<a href=\\&quot;http://nginx.org/\\&quot;>nginx.org</a>.<br/>\\nCommercial support is available at\\n<a href=\\&quot;http://nginx.com/\\&quot;>nginx.com</a>.</p>\\n\\n<p><em>Thank you for using nginx.</em></p>\\n</body>\\n</html>\\n&quot;,\n            &quot;Start&quot;: &quot;2016-11-25T14:35:37.780192565Z&quot;\n        }\n    ],\n    &quot;Status&quot;: &quot;healthy&quot;\n}`, `30496911092077750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format <span class="token string">\'{{json .State.Health}}\'</span> web <span class="token operator">|</span> python -m json.tool\n<span class="token punctuation">{</span>\n    <span class="token string">"FailingStreak"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n    <span class="token string">"Log"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token string">"End"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.940957051Z"</span>,\n            <span class="token string">"ExitCode"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n            <span class="token string">"Output"</span><span class="token builtin class-name">:</span> <span class="token string">"&lt;!DOCTYPE html><span class="token entity" title="\\n">\\n</span>&lt;html><span class="token entity" title="\\n">\\n</span>&lt;head><span class="token entity" title="\\n">\\n</span>&lt;title>Welcome to nginx!&lt;/title><span class="token entity" title="\\n">\\n</span>&lt;style><span class="token entity" title="\\n">\\n</span>    body {<span class="token entity" title="\\n">\\n</span>        width: 35em;<span class="token entity" title="\\n">\\n</span>        margin: 0 auto;<span class="token entity" title="\\n">\\n</span>        font-family: Tahoma, Verdana, Arial, sans-serif;<span class="token entity" title="\\n">\\n</span>    }<span class="token entity" title="\\n">\\n</span>&lt;/style><span class="token entity" title="\\n">\\n</span>&lt;/head><span class="token entity" title="\\n">\\n</span>&lt;body><span class="token entity" title="\\n">\\n</span>&lt;h1>Welcome to nginx!&lt;/h1><span class="token entity" title="\\n">\\n</span>&lt;p>If you see this page, the nginx web server is successfully installed and<span class="token entity" title="\\n">\\n</span>working. Further configuration is required.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>For online documentation and support please refer to<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.org/<span class="token entity" title="\\&quot;">\\"</span>>nginx.org&lt;/a>.&lt;br/><span class="token entity" title="\\n">\\n</span>Commercial support is available at<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.com/<span class="token entity" title="\\&quot;">\\"</span>>nginx.com&lt;/a>.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>&lt;em>Thank you for using nginx.&lt;/em>&lt;/p><span class="token entity" title="\\n">\\n</span>&lt;/body><span class="token entity" title="\\n">\\n</span>&lt;/html><span class="token entity" title="\\n">\\n</span>"</span>,\n            <span class="token string">"Start"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.780192565Z"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>,\n    <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"healthy"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="label-指令"><a href="#label-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL 指令</h2>\n<p>LABEL 指令用来给镜像以键值对的形式添加一些元数据（metadata）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36724987493907870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL <key>=<value> <key>=<value> <key>=<value> ...`, `36724987493907870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> <span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们还可以用一些标签来申明镜像的作者、文档地址等：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94296240434517210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL org.opencontainers.image.authors=&quot;yeasy&quot;\n\nLABEL org.opencontainers.image.documentation=&quot;https://yeasy.gitbooks.io&quot;`, `94296240434517210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> org.opencontainers.image.authors=<span class="token string">"yeasy"</span>\n\n<span class="token keyword">LABEL</span> org.opencontainers.image.documentation=<span class="token string">"https://yeasy.gitbooks.io"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体可以参考 <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md" target="_blank" rel="nofollow noreferrer noopener">https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p>\n<h2 id="shell-指令"><a href="#shell-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SHELL 指令</h2>\n<p>格式：<code class="language-text">SHELL [&quot;executable&quot;, &quot;parameters&quot;]</code></p>\n<p>SHELL 指令可以指定 <code class="language-text">RUN ENTRYPOINT CMD</code> 指令的 shell，Linux 中默认为 <code class="language-text">[&quot;/bin/sh&quot;, &quot;-c&quot;]</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87533113535720620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-c&quot;]\n\nRUN lll ; ls\n\nSHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\nRUN lll ; ls`, `87533113535720620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls\n\n<span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个 RUN 运行同一命令，第二个 RUN 运行的命令会打印出每条命令并当遇到错误时退出。</p>\n<p>当 <code class="language-text">ENTRYPOINT CMD</code> 以 shell 格式指定时，SHELL 指令所指定的 shell 也会成为这两个指令的 shell</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92883717880397510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nENTRYPOINT nginx`, `92883717880397510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">ENTRYPOINT</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39069883312272210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nCMD nginx`, `39069883312272210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">CMD</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="onbuild-为他人做嫁衣裳"><a href="#onbuild-%E4%B8%BA%E4%BB%96%E4%BA%BA%E5%81%9A%E5%AB%81%E8%A1%A3%E8%A3%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ONBUILD 为他人做嫁衣裳</h2>\n<p>格式：<code class="language-text">ONBUILD &lt;其它指令&gt;</code>。</p>\n<p>ONBUILD 是一个特殊的指令，它后面跟的是其它指令，比如 RUN, COPY 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>\n<p>Dockerfile 中的其它指令都是为了定制当前镜像而准备的，唯有 ONBUILD 是为了帮助别人定制自己而准备的。</p>\n<p>假设我们要制作 Node.js 所写的应用的镜像。我们都知道 Node.js 使用 npm 进行包管理，所有依赖、配置、启动信息等会放到 package.json 文件里。在拿到程序代码后，需要先进行 npm install 才可以获得所有需要的依赖。然后就可以通过 npm start 来启动应用。因此，一般来说会这样写 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20267135354443400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `20267135354443400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把这个 Dockerfile 放到 Node.js 项目的根目录，构建好镜像后，就可以直接拿来启动容器运行。但是如果我们还有第二个 Node.js 项目也差不多呢？好吧，那就再把这个 Dockerfile 复制到第二个项目里。那如果有第三个项目呢？再复制么？文件的副本越多，版本控制就越困难，让我们继续看这样的场景维护的问题。</p>\n<p>如果第一个 Node.js 项目在开发过程中，发现这个 Dockerfile 里存在问题，比如敲错字了、或者需要安装额外的包，然后开发人员修复了这个 Dockerfile，再次构建，问题解决。第一个项目没问题了，但是第二个项目呢？虽然最初 Dockerfile 是复制、粘贴自第一个项目的，但是并不会因为第一个项目修复了他们的 Dockerfile，而第二个项目的 Dockerfile 就会被自动修复。</p>\n<p>那么我们可不可以做一个基础镜像，然后各个项目使用这个基础镜像呢？这样基础镜像更新，各个项目不用同步 Dockerfile 的变化，重新构建后就继承了基础镜像的更新？好吧，可以，让我们看看这样的结果。那么上面的这个 Dockerfile 就会变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73670736902601560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `73670736902601560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 my-node 的话，各个项目内的自己的 Dockerfile 就变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28716519437836816000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/`, `28716519437836816000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基础镜像变化后，各个项目都用这个 Dockerfile 重新构建镜像，会继承基础镜像的更新。</p>\n<p>那么，问题解决了么？没有。准确说，只解决了一半。如果这个 Dockerfile 里面有些东西需要调整呢？比如 npm install 都需要加一些参数，那怎么办？这一行 RUN 是不可能放入基础镜像的，因为涉及到了当前项目的 <code class="language-text">./package.json</code>，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 Dockerfile 的前 4 条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p>\n<p>ONBUILD 可以解决这个问题。让我们用 ONBUILD 重新写一下基础镜像的 Dockerfile:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75022111224273350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nONBUILD COPY ./package.json /app\nONBUILD RUN [ &quot;npm&quot;, &quot;install&quot; ]\nONBUILD COPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `75022111224273350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们回到原始的 Dockerfile，但是这次将项目相关的指令加上 ONBUILD，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 Dockerfile 就变成了简单地：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82329251292680030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node`, `82329251292680030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>是的，只有这么一行。当在各个项目目录中，用这个只有一行的 Dockerfile 构建镜像时，之前基础镜像的那三行 ONBUILD 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 npm install，生成应用镜像。</p>\n<h2 id="多阶段构建"><a href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多阶段构建</h2>\n<h3 id="之前的做法"><a href="#%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前的做法</h3>\n<p>在 Docker 17.05 版本之前，我们构建 Docker 镜像时，通常会采用两种方式：</p>\n<h4 id="全部放入一个-dockerfile"><a href="#%E5%85%A8%E9%83%A8%E6%94%BE%E5%85%A5%E4%B8%80%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全部放入一个 Dockerfile</h4>\n<p>一种方式是将所有的构建过程包含在一个 Dockerfile 中，包括项目及其依赖库的编译、测试、打包等流程，这里可能会带来的一些问题：</p>\n<ul>\n<li>镜像层次多，镜像体积较大，部署时间变长</li>\n<li>源代码存在泄露的风险</li>\n</ul>\n<p>例如，编写 app.go 文件，该程序输出 Hello World!</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62675259382609960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package main\n\nimport &quot;fmt&quot;\n\nfunc main(){\n    fmt.Printf(&quot;Hello World!&quot;);\n}`, `62675259382609960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token string">"fmt"</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.one 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66379116841245510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git ca-certificates\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . \\\n  && cp /go/src/github.com/go/helloworld/app /root\n\nWORKDIR /root/\n\nCMD [&quot;./app&quot;]`, `66379116841245510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app . \\\n  &amp;&amp; cp /go/src/github.com/go/helloworld/app /root\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43077237828316980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:1 -f Dockerfile.one .`, `43077237828316980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:1 -f Dockerfile.one <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="分散到多个-dockerfile"><a href="#%E5%88%86%E6%95%A3%E5%88%B0%E5%A4%9A%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分散到多个 Dockerfile</h4>\n<p>另一种方式，就是我们事先在一个 Dockerfile 将项目及其依赖库编译测试打包好后，再将其拷贝到运行环境中，这种方式需要我们编写两个 Dockerfile 和一些编译脚本才能将其两个阶段自动整合起来，这种方式虽然可以很好地规避第一种方式存在的风险，但明显部署过程较复杂。</p>\n<p>例如，编写 Dockerfile.build 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90008257470376100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .`, `90008257470376100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.copy 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76848041667179900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:latest\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY app .\n\nCMD [&quot;./app&quot;]`, `76848041667179900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 build.sh</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56341788803987325000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\necho Building go/helloworld:build\n\ndocker build -t go/helloworld:build . -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker cp extract:/go/src/github.com/go/helloworld/app ./app\ndocker rm -f extract\n\necho Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 . -f Dockerfile.copy\nrm ./app`, `56341788803987325000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token builtin class-name">echo</span> Building go/helloworld:build\n\ndocker build -t go/helloworld:build <span class="token builtin class-name">.</span> -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker <span class="token function">cp</span> extract:/go/src/github.com/go/helloworld/app ./app\ndocker <span class="token function">rm</span> -f extract\n\n<span class="token builtin class-name">echo</span> Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 <span class="token builtin class-name">.</span> -f Dockerfile.copy\n<span class="token function">rm</span> ./app</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在运行脚本即可构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21716813139903610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ chmod +x build.sh\n\n\\$ ./build.sh`, `21716813139903610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">chmod</span> +x build.sh\n\n$ ./build.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>对比两种方式生成的镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34910222088424514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   2      f7cf3465432c    22 seconds ago  6.47MB\ngo/helloworld   1      f55d3e16affc    2 minutes ago   295MB`, `34910222088424514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   <span class="token number">2</span>      f7cf3465432c    <span class="token number">22</span> seconds ago  <span class="token number">6</span>.47MB\ngo/helloworld   <span class="token number">1</span>      f55d3e16affc    <span class="token number">2</span> minutes ago   295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用多阶段构建"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>为解决以上问题，Docker v17.05 开始支持多阶段构建 (multistage builds)。使用多阶段构建我们就可以很容易解决前面提到的问题，并且只需要编写一个 Dockerfile：</p>\n<p>例如，编写 Dockerfile 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47891734349660830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nRUN go get -d -v github.com/go-sql-driver/mysql\n\nCOPY app.go .\n\nRUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n\nFROM alpine:latest as prod\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY --from=0 /go/src/github.com/go/helloworld/app .\n\nCMD [&quot;./app&quot;]`, `47891734349660830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .\n\n<span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest as prod\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=0 /go/src/github.com/go/helloworld/app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11852788991402895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:3 .`, `11852788991402895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:3 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对比三个镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12525350274171943000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     3     d6911ed9c846     7 seconds ago      6.47MB\ngo/helloworld     2     f7cf3465432c     22 seconds ago     6.47MB\ngo/helloworld     1     f55d3e16affc     2 minutes ago      295MB`, `12525350274171943000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     <span class="token number">3</span>     d6911ed9c846     <span class="token number">7</span> seconds ago      <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">2</span>     f7cf3465432c     <span class="token number">22</span> seconds ago     <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">1</span>     f55d3e16affc     <span class="token number">2</span> minutes ago      295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很明显使用多阶段构建的镜像体积小，同时也完美解决了上边提到的问题。</p>\n<h4 id="只构建某一阶段的镜像"><a href="#%E5%8F%AA%E6%9E%84%E5%BB%BA%E6%9F%90%E4%B8%80%E9%98%B6%E6%AE%B5%E7%9A%84%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>只构建某一阶段的镜像</h4>\n<p>我们可以使用 as 来为某一阶段命名，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16806532062675083000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder`, `16806532062675083000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>例如当我们只想构建 builder 阶段的镜像时，增加 —target=builder 参数即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54182404390159090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build --target builder -t username/imagename:tag .`, `54182404390159090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker build <span class="token punctuation">-</span><span class="token punctuation">-</span>target builder <span class="token punctuation">-</span>t username/imagename<span class="token punctuation">:</span>tag .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="构建时从其他镜像复制文件"><a href="#%E6%9E%84%E5%BB%BA%E6%97%B6%E4%BB%8E%E5%85%B6%E4%BB%96%E9%95%9C%E5%83%8F%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建时从其他镜像复制文件</h4>\n<p>上面例子中我们使用 <code class="language-text">COPY --from=0 /go/src/github.com/go/helloworld/app .</code> 从上一阶段的镜像中复制文件，我们也可以复制任意镜像中的文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95399528151171100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf`, `95399528151171100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=nginx<span class="token punctuation">:</span>latest /etc/nginx/nginx.conf /nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="构建多种系统架构支持的-docker-镜像----docker-manifest-命令详解"><a href="#%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F----docker-manifest-%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建多种系统架构支持的 Docker 镜像 — docker manifest 命令详解</h2>\n<p>我们知道使用镜像创建一个容器，该镜像必须与 Docker 宿主机系统架构一致，例如 <code class="language-text">Linux x86_64</code> 架构的系统中只能使用 <code class="language-text">Linux x86_64</code> 的镜像创建容器。</p>\n<p>Windows、macOS 除外，其使用了 <code class="language-text">binfmt_misc</code> 提供了多种架构支持，在 Windows、macOS 系统上 (x86_64) 可以运行 arm 等其他架构的镜像。</p>\n<p>例如我们在 <code class="language-text">Linux x86_64</code> 中构建一个 <code class="language-text">username/test</code> 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90991300199993310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine\n\nCMD echo 1`, `90991300199993310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine\n\n<span class="token keyword">CMD</span> echo 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后推送到 Docker Hub，之后我们尝试在树莓派 Linux arm64v8 中使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98590577029685410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm username/test`, `98590577029685410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以发现这个镜像根本获取不到。</p>\n<p>要解决这个问题，通常采用的做法是通过镜像名区分不同系统架构的镜像，例如在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 分别构建 <code class="language-text">username/test</code> 和 <code class="language-text">username/arm64v8-test</code> 镜像。运行时使用对应架构的镜像即可。</p>\n<p>这样做显得很繁琐，那么有没有一种方法让 Docker 引擎根据系统架构自动拉取对应的镜像呢？</p>\n<p>我们发现在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 架构的计算机中分别使用 <code class="language-text">golang:alpine</code> 镜像运行容器 <code class="language-text">$ docker run golang:alpine go version</code> 时，容器能够正常的运行。</p>\n<p>这是什么原因呢？</p>\n<p>原因就是 <code class="language-text">golang:alpine</code> 官方镜像有一个 manifest 列表 (manifest list) 。</p>\n<p>当用户获取一个镜像时，Docker 引擎会首先查找该镜像是否有 manifest 列表，如果有的话 Docker 引擎会按照 Docker 运行环境（系统及架构）查找出对应镜像（例如 golang:alpine）。如果没有的话会直接获取镜像（例如上例中我们构建的 username/test）。</p>\n<p>我们可以使用 <code class="language-text">$ docker manifest inspect golang:alpine</code> 查看这个 manifest 列表的结构。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10584890761086329000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect golang:alpine`, `10584890761086329000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect golang:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94982348792361700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;schemaVersion&quot;: 2,\n  &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;,\n  &quot;manifests&quot;: [\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;amd64&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v7&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm64&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v8&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;386&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;ppc64le&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;s390x&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    }\n  ]\n}`, `94982348792361700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>\n  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v7"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v8"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"386"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"s390x"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看出 manifest 列表中包含了不同系统架构所对应的镜像 digest 值，这样 Docker 就可以在不同的架构中使用相同的 manifest (例如 golang:alpine) 获取对应的镜像。</p>\n<p>下面介绍如何使用 <code class="language-text">$ docker manifest</code> 命令创建并推送 manifest 列表到 Docker Hub。</p>\n<h3 id="构建镜像-1"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>首先在 <code class="language-text">Linux x86_64</code> 构建 <code class="language-text">username/x8664-test</code> 镜像。并在 <code class="language-text">Linux arm64v8</code> 中构建 <code class="language-text">username/arm64v8-test</code> 镜像，构建好之后推送到 Docker Hub。</p>\n<h3 id="创建-manifest-列表"><a href="#%E5%88%9B%E5%BB%BA-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74976541252589190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]\n\\$ docker manifest create username/test \\\n      username/x8664-test \\\n      username/arm64v8-test`, `74976541252589190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]</span>\n$ docker manifest create username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      username/arm64v8-test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当要修改一个 manifest 列表时，可以加入 -a 或 —amend 参数。</p>\n<h3 id="设置-manifest-列表"><a href="#%E8%AE%BE%E7%BD%AE-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53084286918438340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST\n\\$ docker manifest annotate username/test \\\n      username/x8664-test \\\n      --os linux --arch x86_64\n\n\\$ docker manifest annotate username/test \\\n      username/arm64v8-test \\\n      --os linux --arch arm64 --variant v8`, `53084286918438340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST</span>\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      --os linux --arch x86_64\n\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/arm64v8-test <span class="token punctuation">\\</span>\n      --os linux --arch arm64 --variant v8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就配置好了 manifest 列表。</p>\n<h3 id="查看-manifest-列表"><a href="#%E6%9F%A5%E7%9C%8B-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3201720178386003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect username/test`, `3201720178386003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="推送-manifest-列表"><a href="#%E6%8E%A8%E9%80%81-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送 manifest 列表</h3>\n<p>最后我们可以将其推送到 Docker Hub。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22750870625247790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest push username/test`, `22750870625247790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest push username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="测试"><a href="#%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h3>\n<p>我们在 <code class="language-text">Linux x86_64</code> <code class="language-text">Linux arm64v8</code> 中分别执行 <code class="language-text">$ docker run -it --rm username/test</code> 命令，发现可以正确的执行。</p>\n<h1 id="操作容器"><a href="#%E6%93%8D%E4%BD%9C%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作容器</h1>\n<p>容器是 Docker 又一核心概念。</p>\n<p>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可以理解为模拟运行的一整套操作系统（提供了运行态环境和其他系统环境）和跑在上面的应用。</p>\n<p>本章将具体介绍如何来管理一个容器，包括创建、启动和停止等。</p>\n<h2 id="启动容器"><a href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动容器</h2>\n<p>启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态（exited）的容器重新启动。</p>\n<p>因为 Docker 的容器实在太轻量级了，很多时候用户都是随时删除和新创建容器。</p>\n<h3 id="新建并启动"><a href="#%E6%96%B0%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建并启动</h3>\n<p>所需要的命令主要为 docker run。</p>\n<p>例如，下面的命令输出一个 “Hello World”，之后终止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54217119679539410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/echo \'Hello world\'\nHello world`, `54217119679539410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/echo <span class="token string">\'Hello world\'</span>\nHello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这跟在本地直接执行 <code class="language-text">/bin/echo &#39;hello world&#39;</code> 几乎感觉不出任何区别。</p>\n<p>下面的命令则启动一个 bash 终端，允许用户进行交互。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93777770466915160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/#`, `93777770466915160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其中，<code class="language-text">-t</code> 选项让 Docker 分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上，<code class="language-text">-i</code> 则让容器的标准输入保持打开。</p>\n<p>在交互模式下，用户可以通过所创建的终端来输入命令，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3825656999111415300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@af8bae53bdd3:/# pwd\n/\nroot@af8bae53bdd3:/# ls\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var`, `3825656999111415300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@af8bae53bdd3:/<span class="token comment"># pwd</span>\n/\nroot@af8bae53bdd3:/<span class="token comment"># ls</span>\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：</p>\n<ul>\n<li>检查本地是否存在指定的镜像，不存在就从 registry 下载</li>\n<li>利用镜像创建并启动一个容器</li>\n<li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>\n<li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>\n<li>从地址池配置一个 ip 地址给容器</li>\n<li>执行用户指定的应用程序</li>\n<li>执行完毕后容器被终止</li>\n</ul>\n<h3 id="启动已终止容器"><a href="#%E5%90%AF%E5%8A%A8%E5%B7%B2%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动已终止容器</h3>\n<p>可以利用 <code class="language-text">docker container start</code> 命令，直接将一个已经终止（exited）的容器启动运行。</p>\n<p>容器的核心为所执行的应用程序，所需要的资源都是应用程序运行所必需的。除此之外，并没有其它的资源。可以在伪终端中利用 ps 或 top 来查看进程信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37936552226567760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@ba267838cc1b:/# ps\n  PID TTY          TIME CMD\n    1 ?        00:00:00 bash\n   11 ?        00:00:00 ps`, `37936552226567760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@ba267838cc1b:/<span class="token comment"># ps</span>\n  PID TTY          TIME CMD\n    <span class="token number">1</span> ?        00:00:00 <span class="token function">bash</span>\n   <span class="token number">11</span> ?        00:00:00 <span class="token function">ps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，容器中仅运行了指定的 bash 应用。这种特点使得 Docker 对资源的利用率极高，是货真价实的轻量级虚拟化。</p>\n<h2 id="后台运行"><a href="#%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后台运行</h2>\n<p>更多的时候，需要让 Docker 在后台运行而不是直接把执行命令的结果输出在当前宿主机下。此时，可以通过添加 <code class="language-text">-d</code> 参数来实现。</p>\n<p>下面举两个例子来说明一下。</p>\n<p>如果不使用 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81804317263146570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\nhello world\nhello world\nhello world\nhello world`, `81804317263146570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\nhello world\nhello world\nhello world\nhello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>容器会把输出的结果 (STDOUT) 打印到宿主机上面</p>\n<p>如果使用了 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18069425193368959000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a`, `18069425193368959000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时容器会在后台运行并不会把输出的结果 (STDOUT) 打印到宿主机上面(输出结果可以用 <code class="language-text">docker logs</code> 查看)。</p>\n<blockquote>\n<p>注：容器是否会长久运行，是和 docker run 指定的命令有关，和 <code class="language-text">-d</code> 参数无关。</p>\n</blockquote>\n<p>使用 <code class="language-text">-d</code> 参数启动后会返回一个唯一的 id，也可以通过 docker container ls 命令来查看容器信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68181879201593795000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while tr  2 minutes ago  Up 1 minute        agitated_wright`, `68181879201593795000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while <span class="token function">tr</span>  <span class="token number">2</span> minutes ago  Up <span class="token number">1</span> minute        agitated_wright</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要获取容器的输出信息，可以通过 <code class="language-text">docker container logs</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45381628200059355000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container logs [container ID or NAMES]\nhello world\nhello world\nhello world\n. . .`, `45381628200059355000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container logs <span class="token punctuation">[</span>container ID or NAMES<span class="token punctuation">]</span>\nhello world\nhello world\nhello world\n<span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="终止容器"><a href="#%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>终止容器</h2>\n<p>可以使用 <code class="language-text">docker container stop</code> 来终止一个运行中的容器。</p>\n<p>此外，当 Docker 容器中指定的应用终结时，容器也自动终止。</p>\n<p>例如对于上一章节中只启动了一个终端的容器，用户通过 <code class="language-text">exit</code> 命令或 <code class="language-text">Ctrl+d</code> 来退出终端时，所创建的容器立刻终止。</p>\n<p>终止状态的容器可以用 <code class="language-text">docker container ls -a</code> 命令看到。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93498976912523950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             &quot;/bin/bash&quot;            30 minutes ago      Exited (0) About a minute ago                       trusting_newton`, `93498976912523950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             <span class="token string">"/bin/bash"</span>            <span class="token number">30</span> minutes ago      Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> About a minute ago                       trusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>处于终止状态的容器，可以通过 <code class="language-text">docker container start</code> 命令来重新启动。</p>\n<p>此外，<code class="language-text">docker container restart</code> 命令会将一个运行态的容器终止，然后再重新启动它。</p>\n<h2 id="进入容器"><a href="#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进入容器</h2>\n<p>在使用 <code class="language-text">-d</code> 参数时，容器启动后会进入后台。</p>\n<p>某些时候需要进入容器进行操作，包括使用 docker attach 命令或 docker exec 命令，推荐大家使用 docker exec 命令，原因会在下面说明。</p>\n<h3 id="attach-命令"><a href="#attach-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>attach 命令</h3>\n<p>下面示例如何使用 docker attach 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15543200855611206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           nostalgic_hypatia\n\n\\$ docker attach 243c\nroot@243c32535da7:/#`, `15543200855611206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           nostalgic_hypatia\n\n$ docker attach 243c\nroot@243c32535da7:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：如果从这个 stdin 中 exit，会导致容器的停止。</p>\n<h3 id="exec-命令--i--t-参数"><a href="#exec-%E5%91%BD%E4%BB%A4--i--t-%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec 命令 -i -t 参数</h3>\n<p>docker exec 后边可以跟多个参数，这里主要说明 <code class="language-text">-i -t</code> 参数。</p>\n<p>只用 <code class="language-text">-i</code> 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p>\n<p>当 <code class="language-text">-i -t</code> 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61281277481553700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           zealous_swirles\n\n\\$ docker exec -i 69d1 bash\nls\nbin\nboot\ndev\n...\n\n\\$ docker exec -it 69d1 bash\nroot@69d137adef7a:/#`, `61281277481553700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           zealous_swirles\n\n$ docker <span class="token builtin class-name">exec</span> -i 69d1 <span class="token function">bash</span>\n<span class="token function">ls</span>\nbin\nboot\ndev\n<span class="token punctuation">..</span>.\n\n$ docker <span class="token builtin class-name">exec</span> -it 69d1 <span class="token function">bash</span>\nroot@69d137adef7a:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果从这个 stdin 中 exit，不会导致容器的停止。这就是为什么推荐大家使用 docker exec 的原因。</p>\n<p>更多参数说明请使用 <code class="language-text">docker exec --help</code> 查看。</p>\n<h2 id="导出和导入容器"><a href="#%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出和导入容器</h2>\n<h3 id="导出容器"><a href="#%E5%AF%BC%E5%87%BA%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出容器</h3>\n<p>如果要导出本地某个容器，可以使用 docker export 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97024041286142210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        &quot;/bin/bash&quot;         36 hours ago        Exited (0) 21 hours ago                       test\n\\$ docker export 7691a814370e > ubuntu.tar`, `97024041286142210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        <span class="token string">"/bin/bash"</span>         <span class="token number">36</span> hours ago        Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">21</span> hours ago                       <span class="token builtin class-name">test</span>\n$ docker <span class="token builtin class-name">export</span> 7691a814370e <span class="token operator">></span> ubuntu.tar</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样将导出容器快照到本地文件。</p>\n<h3 id="导入容器快照"><a href="#%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8%E5%BF%AB%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导入容器快照</h3>\n<p>可以使用 docker import 从容器快照文件中再导入为镜像，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16743920011957502000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat ubuntu.tar | docker import - test/ubuntu:v1.0\n\\$ docker image ls\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   171.3 MB`, `16743920011957502000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> ubuntu.tar <span class="token operator">|</span> docker <span class="token function">import</span> - test/ubuntu:v1.0\n$ docker image <span class="token function">ls</span>\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   <span class="token number">171.3</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此外，也可以通过指定 URL 或者某个目录来导入，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64019654013423000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import http://example.com/exampleimage.tgz example/imagerepo`, `64019654013423000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> http://example.com/exampleimage.tgz example/imagerepo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注：用户既可以使用 docker load 来导入镜像存储文件到本地镜像库，也可以使用 docker import 来导入一个容器快照到本地镜像库。这两者的区别在于容器快照文件将丢弃所有的历史记录和元数据信息（即仅保存容器当时的快照状态），而镜像存储文件将保存完整记录，体积也要大。此外，从容器快照文件导入时可以重新指定标签等元数据信息。</p>\n</blockquote>\n<h2 id="删除容器"><a href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除容器</h2>\n<p>可以使用 <code class="language-text">docker container rm</code> 来删除一个处于终止状态的容器。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54705010985129610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container rm trusting_newton\ntrusting_newton`, `54705010985129610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">rm</span> trusting_newton\ntrusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果要删除一个运行中的容器，可以添加 -f 参数。Docker 会发送 SIGKILL 信号给容器。</p>\n<h3 id="清理所有处于终止状态的容器"><a href="#%E6%B8%85%E7%90%86%E6%89%80%E6%9C%89%E5%A4%84%E4%BA%8E%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>清理所有处于终止状态的容器</h3>\n<p>用 <code class="language-text">docker container ls -a</code> 命令可以查看所有已经创建的包括终止状态的容器，如果数量太多要一个个删除可能会很麻烦，用下面的命令可以清理掉所有处于终止状态的容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85394989607678250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container prune`, `85394989607678250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="docker-仓库"><a href="#docker-%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 仓库</h1>\n<p>仓库（Repository）是集中存放镜像的地方。</p>\n<p>一个容易混淆的概念是注册服务器（Registry）。实际上注册服务器是管理仓库的具体服务器，每个服务器上可以有多个仓库，而每个仓库下面有多个镜像。从这方面来说，仓库可以被认为是一个具体的项目或目录。例如对于仓库地址 <code class="language-text">docker.io/ubuntu</code> 来说，docker.io 是注册服务器地址，ubuntu 是仓库名。</p>\n<p>大部分时候，并不需要严格区分这两者的概念。</p>\n<h2 id="docker-hub"><a href="#docker-hub" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Hub</h2>\n<p>目前 Docker 官方维护了一个公共仓库 Docker Hub，大部分需求都可以通过在 Docker Hub 中直接下载镜像来实现。</p>\n<h3 id="注册"><a href="#%E6%B3%A8%E5%86%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册</h3>\n<p>你可以在 <a href="https://hub.docker.com" target="_blank" rel="nofollow noreferrer noopener">https://hub.docker.com</a> 免费注册一个 Docker 账号。</p>\n<h3 id="登录"><a href="#%E7%99%BB%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h3>\n<p>可以通过执行 docker login 命令交互式的输入用户名及密码来完成在命令行界面登录 Docker Hub。</p>\n<p>你可以通过 docker logout 退出登录。</p>\n<h3 id="拉取镜像"><a href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拉取镜像</h3>\n<p>你可以通过 docker search 命令来查找官方仓库中的镜像，并利用 docker pull 命令来将它下载到本地。</p>\n<p>例如以 centos 为关键词进行搜索：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61657865925396530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   6449      [OK]\nansible/centos7-ansible            Ansible on Centos7                              132                  [OK]\nconsol/centos-xfce-vnc             Centos container with &quot;headless&quot; VNC session…   126                  [OK]\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   117                  [OK]\ncentos/systemd                     systemd enabled base container.                 96                   [OK]`, `61657865925396530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   <span class="token number">6449</span>      <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nansible/centos7-ansible            Ansible on Centos7                              <span class="token number">132</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nconsol/centos-xfce-vnc             Centos container with <span class="token string">"headless"</span> VNC session…   <span class="token number">126</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   <span class="token number">117</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\ncentos/systemd                     systemd enabled base container.                 <span class="token number">96</span>                   <span class="token punctuation">[</span>OK<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到返回了很多包含关键字的镜像，其中包括镜像名字、描述、收藏数（表示该镜像的受关注程度）、是否官方创建（OFFICIAL）、是否自动构建 （AUTOMATED）。</p>\n<p>根据是否是官方提供，可将镜像分为两类。</p>\n<ol>\n<li>\n<p>类似 centos 这样的镜像，被称为基础镜像或根镜像。这些基础镜像由 Docker 公司创建、验证、支持、提供。这样的镜像往往使用单个单词作为名字。</p>\n</li>\n<li>\n<p>比如 <code class="language-text">ansible/centos7-ansible</code> 镜像，它是由 Docker Hub 的注册用户创建并维护的，往往带有用户名称前缀。可以通过前缀 <code class="language-text">username/</code> 来指定使用某个用户提供的镜像，比如 ansible 用户。</p>\n</li>\n</ol>\n<p>另外，在查找的时候通过 <code class="language-text">--filter=stars=N</code> 参数可以指定仅显示收藏数量为 N 以上的镜像。</p>\n<p>下载官方 centos 镜像到本地。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24675518634279903000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image for centos:latest\ndocker.io/library/centos:latest`, `24675518634279903000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image <span class="token keyword">for</span> centos:latest\ndocker.io/library/centos:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="推送镜像"><a href="#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送镜像</h3>\n<p>用户也可以在登录后通过 docker push 命令来将自己的镜像推送到 Docker Hub。</p>\n<p>以下命令中的 username 请替换为你的 Docker 账号用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23389243009487393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n\\$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   18.04                  275d79972a86        6 days ago          94.6MB\nusername/ubuntu                                          18.04                  275d79972a86        6 days ago          94.6MB\n\n\\$ docker push username/ubuntu:18.04\n\n\\$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu`, `23389243009487393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n$ docker image <span class="token function">ls</span>\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\nusername/ubuntu                                          <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\n\n$ docker push username/ubuntu:18.04\n\n$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="自动构建"><a href="#%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自动构建</h3>\n<p>2021 年 7 月 26 日之后，该项功能仅限付费用户使用。</p>\n<p>自动构建（Automated Builds）可以自动触发构建镜像，方便升级镜像。</p>\n<p>有时候，用户构建了镜像，安装了某个软件，当软件发布新版本则需要手动更新镜像。</p>\n<p>而自动构建允许用户通过 Docker Hub 指定跟踪一个目标网站（支持 GitHub 或 BitBucket）上的项目，一旦项目发生新的提交（commit）或者创建了新的标签（tag），Docker Hub 会自动构建镜像并推送到 Docker Hub 中。</p>\n<p>要配置自动构建，包括如下的步骤：</p>\n<ul>\n<li>登录 Docker Hub；</li>\n<li>在 Docker Hub 点击右上角头像，在账号设置（Account Settings）中关联（Linked Accounts）目标网站；</li>\n<li>在 Docker Hub 中新建或选择已有的仓库，在 Builds 选项卡中选择 Configure Automated Builds；</li>\n<li>选取一个目标网站中的项目（需要含 Dockerfile）和分支；</li>\n<li>指定 Dockerfile 的位置，并保存。</li>\n</ul>\n<p>之后，可以在 Docker Hub 的仓库页面的 Timeline 选项卡中查看每次构建的状态。</p>\n<h1 id="数据管理"><a href="#%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据管理</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 501px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.898203592814376%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz1VQS47TQBDNXVhyDE6AhNiwYsMZWI/QSGxmxRKEuABrFmgGxJBJMiGZfLBx4kz8d9xxt9ufdre7/aGSSKCRSlWlV/VU9V7vyet3j1+dP3p59vz8Iy14lGRxWuxwGpJ0R7JdkoUYGgpglOSI5pAh9jT3Me09e/PhxdtPT8/eX3y+6rqu7TqSsXvbs1x/Y7nm1rG90PZ3KStP00NuDzVlvIez4oh0ddsGKfczYfj78UIfjKfXg/HVj/5MM3TT0lzkUC7rOsrFMkyZbPJS9CKaAzMp5cghBspU01ZSBijGhK59ZEc4RNiLYqUUk7WFGTAv18giJeOiB8K4atyE3eNi5CR2Uv57DI7YCTcxX8elrA8IZlWYcpg37fFtcEI2rZOUpahQyggTQqqclVKqIBMFr0ouuKhgKoQghdiz6iTzQAZ7oVsEdPjH0o318NfdeLZcbbYmuFSomNCFYU7mv+faan1vX2oO4eo/GR01q7reOP50qQ8ns9vpfKabX6YmbIUoHs/1/mgC+J22Mjz0wO0TuW6a1db9fnP7rT+8vhl9HUx/ajbgYF4BzlQS3gYtcOMBOcAUelU34R5v3GDrhZa/s7yQJLRuWghYhNQeGbAGIVUDCM7YX52sId9byEsQAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 17 02 27 55" title="" data-src="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png" data-srcset="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-d18f3.png 200w,\n/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-764b5.png 400w,\n/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png 501w" data-sizes="(max-width: 501px) 100vw, 501px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这一章介绍如何在 Docker 内部以及容器之间管理数据，在容器中管理数据主要有两种方式：</p>\n<ul>\n<li>数据卷（Volumes）</li>\n<li>挂载主机目录 (Bind mounts)</li>\n</ul>\n<h2 id="数据卷"><a href="#%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据卷</h2>\n<p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：</p>\n<ul>\n<li>数据卷可以在容器之间共享和重用</li>\n<li>对数据卷的修改会立马生效</li>\n<li>对数据卷的更新，不会影响镜像</li>\n<li>数据卷默认会一直存在，即使容器被删除</li>\n</ul>\n<blockquote>\n<p>注意：数据卷的使用，类似于 Linux 下对目录或文件进行 mount，镜像中的被指定为挂载点的目录中的文件会复制到数据卷中（仅数据卷为空时会复制）。</p>\n</blockquote>\n<h3 id="创建一个数据卷"><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建一个数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1455510066702525700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume create my-vol`, `1455510066702525700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume create my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>查看所有的数据卷</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24911970507372370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume ls\n\nDRIVER              VOLUME NAME\nlocal               my-vol`, `24911970507372370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">ls</span>\n\nDRIVER              VOLUME NAME\n<span class="token builtin class-name">local</span>               my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在主机里使用以下命令可以查看指定数据卷的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6914713069999601000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume inspect my-vol\n[\n    {\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Labels&quot;: {},\n        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Options&quot;: {},\n        &quot;Scope&quot;: &quot;local&quot;\n    }\n]`, `6914713069999601000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume inspect my-vol\n<span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,\n        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Mountpoint"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span>,\n        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"my-vol"</span>,\n        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="启动一个挂载数据卷的容器"><a href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动一个挂载数据卷的容器</h3>\n<p>在用 docker run 命令的时候，使用 <code class="language-text">--mount</code> 标记来将数据卷挂载到容器里。在一次 docker run 中可以挂载多个数据卷。</p>\n<p>下面创建一个名为 web 的容器，并加载一个数据卷到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54239974782043860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v my-vol:/usr/share/nginx/html \\\n    --mount source=my-vol,target=/usr/share/nginx/html \\\n    nginx:alpine`, `54239974782043860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v my-vol:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">source</span><span class="token operator">=</span>my-vol,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68322292503157960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `68322292503157960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76694842700066950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;volume&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Source&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;&quot;\n    }\n],`, `76694842700066950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"volume"</span><span class="token punctuation">,</span>\n        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"my-vol"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">""</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="删除数据卷"><a href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43355468892839720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume rm my-vol`, `43355468892839720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">rm</span> my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷是被设计用来持久化数据的，它的生命周期独立于容器，Docker 不会在容器被删除后自动删除数据卷，并且也不存在垃圾回收这样的机制来处理没有任何容器引用的数据卷。如果需要在删除容器的同时移除数据卷。可以在删除容器的时候使用 <code class="language-text">docker rm -v</code> 这个命令。</p>\n<p>无主的数据卷可能会占据很多空间，要清理请使用以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71526108017051080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume prune`, `71526108017051080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="挂载主机目录"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载主机目录</h2>\n<h3 id="挂载一个主机目录作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个主机目录作为数据卷</h3>\n<p>使用 <code class="language-text">--mount</code> 标记可以指定挂载一个本地主机的目录到容器中去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79487124491405030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html \\\n    nginx:alpine`, `79487124491405030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的命令加载主机的 <code class="language-text">/src/webapp</code> 目录到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。这个功能在进行测试的时候十分方便，比如用户可以放置一些程序到本地目录中，来查看容器是否正常工作。本地目录的路径必须是绝对路径，以前使用 <code class="language-text">-v</code> 参数时如果本地目录不存在 Docker 会自动为你创建一个文件夹，现在使用 <code class="language-text">--mount</code> 参数时如果本地目录不存在，Docker 会报错。</p>\n<p>Docker 挂载主机目录的默认权限是读写，用户也可以通过增加 readonly 指定为只读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54301076360123090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html:ro \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html,readonly \\\n    nginx:alpine`, `54301076360123090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html:ro \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html,readonly <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>加了 readonly 之后，就挂载为只读了。如果你在容器内 <code class="language-text">/usr/share/nginx/html</code> 目录新建文件，会显示如下错误</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92818768944645470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/usr/share/nginx/html # touch new.txt\ntouch: new.txt: Read-only file system`, `92818768944645470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/usr/share/nginx/html <span class="token comment"># touch new.txt</span>\ntouch: new.txt: Read-only <span class="token function">file</span> system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91412404806736760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `91412404806736760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>挂载主机目录的配置信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35785884393382773000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;bind&quot;,\n        &quot;Source&quot;: &quot;/src/webapp&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;rprivate&quot;\n    }\n],`, `35785884393382773000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/src/webapp"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="挂载一个本地主机文件作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个本地主机文件作为数据卷</h3>\n<p><code class="language-text">--mount</code> 标记也可以从主机挂载单个文件到容器中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59808803597616800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it \\\n   # -v \\$HOME/.bash_history:/root/.bash_history \\\n   --mount type=bind,source=\\$HOME/.bash_history,target=/root/.bash_history \\\n   ubuntu:18.04 \\\n   bash\n\nroot@2affd44b4667:/# history\n1  ls\n2  diskutil list`, `59808803597616800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it <span class="token punctuation">\\</span>\n   <span class="token comment"># -v $HOME/.bash_history:/root/.bash_history \\</span>\n   --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.bash_history,target<span class="token operator">=</span>/root/.bash_history <span class="token punctuation">\\</span>\n   ubuntu:18.04 <span class="token punctuation">\\</span>\n   <span class="token function">bash</span>\n\nroot@2affd44b4667:/<span class="token comment"># history</span>\n<span class="token number">1</span>  <span class="token function">ls</span>\n<span class="token number">2</span>  diskutil list</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就可以记录在容器输入过的命令了。</p>\n<h1 id="网络"><a href="#%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络</h1>\n<p>Docker 允许通过外部访问容器或容器互联的方式来提供网络服务。</p>\n<h2 id="外部访问容器"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器</h2>\n<p>容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 <code class="language-text">-P</code> 或 <code class="language-text">-p</code> 参数来指定端口映射。</p>\n<p>当使用 <code class="language-text">-P</code> 标记时，Docker 会随机映射一个端口到内部容器开放的网络端口。</p>\n<p>使用 <code class="language-text">docker container ls</code> 可以看到，本地主机的 32768 被映射到了容器的 80 端口。此时访问本机的 32768 端口即可访问容器内 NGINX 默认页面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1823570685984687900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P nginx:alpine\n\n\\$ docker container ls -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        &quot;/docker-entrypoint.…&quot;   24 seconds ago      Up 20 seconds       0.0.0.0:32768->80/tcp   bold_mcnulty`, `1823570685984687900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P nginx:alpine\n\n$ docker container <span class="token function">ls</span> -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">24</span> seconds ago      Up <span class="token number">20</span> seconds       <span class="token number">0.0</span>.0.0:32768-<span class="token operator">></span><span class="token number">80</span>/tcp   bold_mcnulty</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，可以通过 docker logs 命令来查看访问记录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91964929981967600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker logs fa\n172.17.0.1 - - [25/Aug/2020:08:34:04 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0&quot; &quot;-&quot;`, `91964929981967600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker logs fa\n<span class="token number">172.17</span>.0.1 - - <span class="token punctuation">[</span><span class="token number">25</span>/Aug/2020:08:34:04 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0"</span> <span class="token string">"-"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">-p</code> 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有 <code class="language-text">ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort</code>。</p>\n<h3 id="映射所有接口地址"><a href="#%E6%98%A0%E5%B0%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射所有接口地址</h3>\n<p>使用 <code class="language-text">hostPort:containerPort</code> 格式本地的 80 端口映射到容器的 80 端口，可以执行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82085708371667240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 80:80 nginx:alpine`, `82085708371667240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时默认会绑定本地所有接口上的所有地址。</p>\n<h3 id="映射到指定地址的指定端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的指定端口</h3>\n<p>可以使用 <code class="language-text">ip:hostPort:containerPort</code> 格式指定映射使用一个特定地址，比如 localhost 地址 127.0.0.1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30503864058642117000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80 nginx:alpine`, `30503864058642117000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="映射到指定地址的任意端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%BB%E6%84%8F%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的任意端口</h3>\n<p>使用 <code class="language-text">ip::containerPort</code> 绑定 localhost 的任意端口到容器的 80 端口，本地主机会自动分配一个端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46049966186296754000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1::80 nginx:alpine`, `46049966186296754000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1::80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>还可以使用 udp 标记来指定 udp 端口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75233025408583010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80/udp nginx:alpine`, `75233025408583010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80/udp nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看映射端口配置"><a href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看映射端口配置</h3>\n<p>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80826752935299420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker port fa 80\n0.0.0.0:32768`, `80826752935299420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker port fa <span class="token number">80</span>\n<span class="token number">0.0</span>.0.0:32768</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>容器有自己的内部网络和 ip 地址（使用 docker inspect 查看，Docker 还可以有一个可变的网络配置。）</li>\n<li><code class="language-text">-p</code> 标记可以多次使用来绑定多个端口</li>\n</ul>\n<p>例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80147191777744470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d \\\n    -p 80:80 \\\n    -p 443:443 \\\n    nginx:alpine`, `80147191777744470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d <span class="token punctuation">\\</span>\n    -p <span class="token number">80</span>:80 <span class="token punctuation">\\</span>\n    -p <span class="token number">443</span>:443 <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="容器互联"><a href="#%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器互联</h2>\n<p>如果你之前有 Docker 使用经验，你可能已经习惯了使用 <code class="language-text">--link</code> 参数来使容器互联。</p>\n<p>随着 Docker 网络的完善，强烈建议大家将容器加入自定义的 Docker 网络来连接多个容器，而不是使用 <code class="language-text">--link</code> 参数。</p>\n<h3 id="新建网络"><a href="#%E6%96%B0%E5%BB%BA%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建网络</h3>\n<p>下面先创建一个新的 Docker 网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22522393195096703000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge my-net`, `22522393195096703000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge my-net</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">-d</code> 参数指定 Docker 网络类型，有 bridge、overlay。其中 overlay 网络类型用于 Swarm mode，在本小节中你可以忽略它。</p>\n<h3 id="连接容器"><a href="#%E8%BF%9E%E6%8E%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接容器</h3>\n<p>运行一个容器并连接到新建的 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78973271144378600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox1 --network my-net busybox sh`, `78973271144378600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox1 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开新的终端，再运行一个容器并加入到 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89744116089431200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox2 --network my-net busybox sh`, `89744116089431200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox2 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>再打开一个新的终端查看容器信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18483305601034060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             &quot;sh&quot;                11 minutes ago      Up 11 minutes                           busybox2\n8720575823ec        busybox             &quot;sh&quot;                16 minutes ago      Up 16 minutes                           busybox1`, `18483305601034060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             <span class="token string">"sh"</span>                <span class="token number">11</span> minutes ago      Up <span class="token number">11</span> minutes                           busybox2\n8720575823ec        busybox             <span class="token string">"sh"</span>                <span class="token number">16</span> minutes ago      Up <span class="token number">16</span> minutes                           busybox1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面通过 ping 来证明 busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<p>在 busybox1 容器输入以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47105028222343970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox2\nPING busybox2 (172.19.0.3): 56 data bytes\n64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms\n64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms`, `47105028222343970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox2</span>\nPING busybox2 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.072</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.118</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用 ping 来测试连接 busybox2 容器，它会解析成 172.19.0.3。</p>\n<p>同理在 busybox2 容器执行 ping busybox1，也会成功连接到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67338173371610276000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox1\nPING busybox1 (172.19.0.2): 56 data bytes\n64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms\n64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms`, `67338173371610276000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox1</span>\nPING busybox1 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.064</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.143</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<h3 id="docker-compose"><a href="#docker-compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Compose</h3>\n<p>如果你有多个容器之间需要互相连接，推荐使用 Docker Compose。</p>\n<h2 id="配置-dns"><a href="#%E9%85%8D%E7%BD%AE-dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 DNS</h2>\n<p>如何自定义配置容器的主机名和 DNS 呢？秘诀就是 Docker 利用虚拟文件来挂载容器的 3 个相关配置文件。</p>\n<p>在容器中使用 mount 命令可以看到挂载信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72905391285141310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mount\n/dev/disk/by-uuid/1fec...ebdf on /etc/hostname type ext4 ...\n/dev/disk/by-uuid/1fec...ebdf on /etc/hosts type ext4 ...\ntmpfs on /etc/resolv.conf type tmpfs ...`, `72905391285141310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mount</span>\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hostname <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hosts <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\ntmpfs on /etc/resolv.conf <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种机制可以让宿主主机 DNS 信息发生更新后，所有 Docker 容器的 DNS 配置通过 <code class="language-text">/etc/resolv.conf</code> 文件立刻得到更新。</p>\n<p>配置全部容器的 DNS，也可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中增加以下内容来设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17568420034575970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;dns&quot;: [&quot;114.114.114.114&quot;, &quot;8.8.8.8&quot;]\n}`, `17568420034575970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"dns"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"114.114.114.114"</span><span class="token punctuation">,</span> <span class="token string">"8.8.8.8"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样每次启动的容器 DNS 自动配置为 <code class="language-text">114.114.114.114</code> 和 <code class="language-text">8.8.8.8</code>。使用以下命令来证明其已经生效。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67367795485229750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 cat etc/resolv.conf\n\nnameserver 114.114.114.114\nnameserver 8.8.8.8`, `67367795485229750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">cat</span> etc/resolv.conf\n\nnameserver <span class="token number">114.114</span>.114.114\nnameserver <span class="token number">8.8</span>.8.8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果用户想要手动指定容器的配置，可以在使用 docker run 命令启动容器时加入如下参数：</p>\n<p><code class="language-text">-h HOSTNAME</code> 或者 <code class="language-text">--hostname=HOSTNAME</code> 设定容器的主机名，它会被写到容器内的 <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/hosts</code>。但它在容器外部看不到，既不会在 <code class="language-text">docker container ls</code> 中显示，也不会在其他的容器的 <code class="language-text">/etc/hosts</code> 看到。</p>\n<p><code class="language-text">--dns=IP_ADDRESS</code> 添加 DNS 服务器到容器的 <code class="language-text">/etc/resolv.conf</code> 中，让容器用这个服务器来解析所有不在 <code class="language-text">/etc/hosts</code> 中的主机名。</p>\n<p><code class="language-text">--dns-search=DOMAIN</code> 设定容器的搜索域，当设定搜索域为 <code class="language-text">.example.com</code> 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 <code class="language-text">host.example.com</code>。</p>\n<p>注意：如果在容器启动时没有指定最后两个参数，Docker 会默认用主机上的 <code class="language-text">/etc/resolv.conf</code> 来配置容器。</p>\n<h1 id="高级网络配置"><a href="#%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级网络配置</h1>\n<p>本章将介绍 Docker 的一些高级网络配置和选项。</p>\n<p>当 Docker 启动时，会自动在主机上创建一个 docker0 虚拟网桥，实际上是 Linux 的一个 bridge，可以理解为一个软件交换机。它会在挂载到它的网口之间进行转发。</p>\n<p>同时，Docker 随机分配一个本地未占用的私有网段（在 RFC1918 中定义）中的一个地址给 docker0 接口。比如典型的 <code class="language-text">172.17.42.1</code>，掩码为 <code class="language-text">255.255.0.0</code>。此后启动的容器内的网口也会自动分配一个同一网段（172.17.0.0/16）的地址。</p>\n<p>当创建一个 Docker 容器的时候，同时会创建了一对 <code class="language-text">veth pair</code> 接口（当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包）。这对接口一端在容器内，即 eth0；另一端在本地并被挂载到 docker0 网桥，名称以 veth 开头（例如 vethAQI2QT）。通过这种方式，主机可以跟容器通信，容器之间也可以相互通信。Docker 就创建了在主机和所有容器之间一个虚拟共享网络。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b7caf.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.76172090457805%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACxklEQVQ4y11Sa1PTUBDlx+snxy86OoI6fhGcAXVGsOJjpG1oK4oUW9IHYh+U5nGT2zx7k6aUPW4AHfTDmd27OXvuubtZSlTQVfFERv19e9rfE9Penoj638Q0dEWiQmE6x2JkN8RY6OLUagjPN0WWRmJk2qJ5Ygi9Z4gGx7ElRKoCa4mb/PNZiKT2FHPtAea7D5F9eQL+hnmW4OdYw0HvFQ4HmxxfQ0x6AGU4ODaw+rmP9fIQazsDNE5M5DpLSoVupjw4OysX3Ve3qbVxiybFZYo9g9IkpvagRAVtmd6Wlql48Jxs2aOLuaLvnRE9elmllfVPtPx6j9glZYm/yB3KVE2gSisk9TsQ7btIyo8QyDMkSQR9UGI8wXB0D3vddRjiJ+hc4cuRgY3idwxO72Oj1KD91hjz9FIwkGkSIOrXaWLUIM4qiAd1xIEDNQ1gOb8wtvZhWVWc2S14ngmeIU4NG8eDIdc1dPqnNLYcpIoF1dSX2SxGtphRFAWQroP5IsMsDZEyFvMEcejDdQTnKWazCLmB8yzCxTyGsG3OQzrnnLWuHKppCM8dk5TP4LqPMXGGcJjo2CYkC/n+JoLwIcKgDcFOXGFwlAgCDYZ5B1LWaOJ6SJS3WJrNQulYAlrhB3UOP6Db2EZl+xClrSbKb5uXcffjFqqlVZQKFZS3dK7/QHFTR71awUlrC1+LFdrXuvyigAXTULq2QLnQoOJmGzm0QhPau2twXtlZQ6V8j4V3+bIOKu+PsLudX6Yzv4udN0dUr7WvBPMnM/h5FrnCRA7Or2HCky6i8DPi+AXM8SHaegetZgOj4YDHYV/zTfIkL/HmUtgp5Yv4FxG8iQ3fcxH4/K/y7KJQ8vDzeQU3uZe9f5eSN/KBGLiJvEk/4nkWP6F+8BW1apmXccYCMf7jUs69FGSbV4LqqngTOTlNwr/ief6n/qf2v+BvUvGtQZ/Bj1sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 18 14 38 31" title="" data-src="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-fee1c.png" data-srcset="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-a67b7.png 200w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-0b187.png 400w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-fee1c.png 800w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b1a91.png 1200w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-95179.png 1600w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b7caf.png 1813w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来的部分将介绍在一些场景中，Docker 所有的网络定制配置。以及通过 Linux 命令来调整、补充、甚至替换 Docker 默认的网络配置。</p>\n<h2 id="快速配置指南"><a href="#%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速配置指南</h2>\n<p>下面是一个跟 Docker 网络相关的命令列表。</p>\n<p>其中有些命令选项只有在 Docker 服务启动的时候才能配置，而且不能马上生效。</p>\n<ul>\n<li><code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 指定容器挂载的网桥</li>\n<li><code class="language-text">--bip=CIDR</code> 定制 docker0 的掩码</li>\n<li><code class="language-text">-H SOCKET...</code> 或 <code class="language-text">--host=SOCKET... Docker</code> 服务端接收命令的通道</li>\n<li><code class="language-text">--icc=true|false</code> 是否支持容器之间进行通信</li>\n<li><code class="language-text">--ip-forward=true|false</code> 请看下文容器之间的通信</li>\n<li><code class="language-text">--iptables=true|false</code> 是否允许 Docker 添加 iptables 规则</li>\n<li><code class="language-text">--mtu=BYTES</code> 容器网络中的 MTU</li>\n</ul>\n<p>下面 2 个命令选项既可以在启动服务时指定，也可以在启动容器时指定。在 Docker 服务启动的时候指定则会成为默认值，后面执行 docker run 时可以覆盖设置的默认值。</p>\n<ul>\n<li><code class="language-text">--dns=IP_ADDRESS...</code> 使用指定的 DNS 服务器</li>\n<li><code class="language-text">--dns-search=DOMAIN...</code> 指定 DNS 搜索域</li>\n</ul>\n<p>最后这些选项只有在 docker run 执行时使用，因为它是针对容器的特性内容。</p>\n<ul>\n<li><code class="language-text">-h HOSTNAME</code> 或 <code class="language-text">--hostname=HOSTNAME</code> 配置容器主机名</li>\n<li><code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 添加到另一个容器的连接</li>\n<li><code class="language-text">--net=bridge|none|container:NAME_or_ID|host</code> 配置容器的桥接模式</li>\n<li><code class="language-text">-p SPEC</code> 或 <code class="language-text">--publish=SPEC</code> 映射容器端口到宿主主机</li>\n<li><code class="language-text">-P</code> 或 <code class="language-text">--publish-all=true|false</code> 映射容器所有端口到宿主主机</li>\n</ul>\n<h2 id="容器访问控制"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问控制</h2>\n<p>容器的访问控制，主要通过 Linux 上的 iptables 防火墙来进行管理和实现。iptables 是 Linux 上默认的防火墙软件，在大部分发行版中都自带。</p>\n<h3 id="容器访问外部网络"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部网络</h3>\n<p>容器要想访问外部网络，需要本地系统的转发支持。在 Linux 系统中，检查转发是否打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26027068776850150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl net.ipv4.ip_forward\nnet.ipv4.ip_forward = 1`, `26027068776850150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> net.ipv4.ip_forward\nnet.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果为 0，说明没有开启转发，则需要手动打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57521879616777810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl -w net.ipv4.ip_forward=1`, `57521879616777810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> -w net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果在启动 Docker 服务的时候设定 <code class="language-text">--ip-forward=true</code>, Docker 就会自动设定系统的 <code class="language-text">ip_forward</code> 参数为 1。</p>\n<h3 id="容器之间访问"><a href="#%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器之间访问</h3>\n<p>容器之间相互访问，需要两方面的支持。</p>\n<ol>\n<li>容器的网络拓扑是否已经互联。默认情况下，所有容器都会被连接到 docker0 网桥上。</li>\n<li>本地系统的防火墙软件 <code class="language-text">iptables</code> 是否允许通过。</li>\n</ol>\n<h4 id="访问所有端口"><a href="#%E8%AE%BF%E9%97%AE%E6%89%80%E6%9C%89%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问所有端口</h4>\n<p>当启动 Docker 服务（即 dockerd）的时候，默认会添加一条转发策略到本地主机 iptables 的 FORWARD 链上。策略为通过（ACCEPT）还是禁止（DROP）取决于配置<code class="language-text">--icc=true</code>（缺省值）还是 <code class="language-text">--icc=false</code>。当然，如果手动指定 <code class="language-text">--iptables=false</code> 则不会添加 iptables 规则。</p>\n<p>可见，默认情况下，不同容器之间是允许网络互通的。如果为了安全考虑，可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中配置 <code class="language-text">{&quot;icc&quot;: false}</code> 来禁止它。</p>\n<h4 id="访问指定端口"><a href="#%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问指定端口</h4>\n<p>在通过 <code class="language-text">--icc=false</code> 关闭网络访问后，还可以通过 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项来访问容器的开放端口。</p>\n<p>例如，在启动 Docker 服务时，可以同时使用 <code class="language-text">--icc=false --iptables=true</code> 参数来关闭允许相互的网络访问，并让 Docker 可以修改系统中的 iptables 规则。</p>\n<p>此时，系统中的 iptables 规则可能是类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97525348170026040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  0.0.0.0/0            0.0.0.0/0\n...`, `97525348170026040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之后，启动容器（docker run）时使用 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项。Docker 会在 iptable 中为两个容器分别添加一条 ACCEPT 规则，允许相互访问开放的端口（取决于 Dockerfile 中的 EXPOSE 指令）。</p>\n<p>当添加了 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项后，添加了 iptables 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61658177272912210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nACCEPT     tcp  --  172.17.0.2           172.17.0.3           tcp spt:80\nACCEPT     tcp  --  172.17.0.3           172.17.0.2           tcp dpt:80\nDROP       all  --  0.0.0.0/0            0.0.0.0/0`, `61658177272912210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.2           <span class="token number">172.17</span>.0.3           tcp spt:80\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.3           <span class="token number">172.17</span>.0.2           tcp dpt:80\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 中的 CONTAINER_NAME 目前必须是 Docker 分配的名字，或使用 <code class="language-text">--name</code> 参数指定的名字。主机名则不会被识别。</p>\n<h2 id="映射容器端口到宿主主机的实现"><a href="#%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%AB%AF%E5%8F%A3%E5%88%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射容器端口到宿主主机的实现</h2>\n<p>默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。</p>\n<h3 id="容器访问外部实现"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部实现</h3>\n<p>容器所有到外部网络的连接，源地址都会被 NAT 成本地系统的 IP 地址。这是使用 iptables 的源地址伪装操作实现的。</p>\n<p>查看主机的 NAT 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60365412137750550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -t nat -nL\n...\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nMASQUERADE  all  --  172.17.0.0/16       !172.17.0.0/16\n...`, `60365412137750550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nMASQUERADE  all  --  <span class="token number">172.17</span>.0.0/16       <span class="token operator">!</span><span class="token number">172.17</span>.0.0/16\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，上述规则将所有源地址在 <code class="language-text">172.17.0.0/16</code> 网段，目标地址为其他网段（外部网络）的流量动态伪装为从系统网卡发出。MASQUERADE 跟传统 SNAT 的好处是它能动态从网卡获取地址。</p>\n<h3 id="外部访问容器实现"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器实现</h3>\n<p>容器允许外部访问，可以在 docker run 时候通过 -p 或 -P 参数来启用。</p>\n<p>不管用那种办法，其实也是在本地的 iptable 的 nat 表中添加相应的规则。</p>\n<p>使用 -P 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66100337438702210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\n...\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:49153 to:172.17.0.2:80`, `66100337438702210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:49153 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 -p 80:80 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22974302502269770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.2:80`, `22974302502269770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:80 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>\n<p>这里的规则映射了 <code class="language-text">0.0.0.0</code>，意味着将接受主机来自所有接口的流量。用户可以通过 <code class="language-text">-p IP:host_port:container_port</code> 或 <code class="language-text">-p IP::port</code> 来指定允许访问容器的主机上的 IP、接口等，以制定更严格的规则。</p>\n</li>\n<li>\n<p>如果希望永久绑定到某个固定的 IP 地址，可以在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32182249744459555000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n&quot;ip&quot;: &quot;0.0.0.0&quot;\n}`, `32182249744459555000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n<span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="自定义网桥"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自定义网桥</h2>\n<p>除了默认的 docker0 网桥，用户也可以指定网桥来连接各个容器。</p>\n<p>在启动 Docker 服务的时候，使用 <code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 来指定使用的网桥。</p>\n<p>如果服务已经运行，那需要先停止服务，并删除旧的网桥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63287907556777510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl stop docker\n\\$ sudo ip link set dev docker0 down\n\\$ sudo brctl delbr docker0`, `63287907556777510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl stop docker\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev docker0 down\n$ <span class="token function">sudo</span> brctl delbr docker0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后创建一个网桥 bridge0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61636706749398010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo brctl addbr bridge0\n\\$ sudo ip addr add 192.168.5.1/24 dev bridge0\n\\$ sudo ip link set dev bridge0 up`, `61636706749398010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> brctl addbr bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.5.1/24 dev bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev bridge0 up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>查看确认网桥创建并启动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70355143758077050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ip addr show bridge0\n4: bridge0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state UP group default\n    link/ether 66:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever`, `70355143758077050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ip</span> addr show bridge0\n<span class="token number">4</span>: bridge0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state UP group default\n    link/ether <span class="token number">66</span>:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet <span class="token number">192.168</span>.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容，即可将 Docker 默认桥接到创建的网桥上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28425087781079370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;bridge&quot;: &quot;bridge0&quot;\n}`, `28425087781079370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"bridge"</span><span class="token operator">:</span> <span class="token string">"bridge0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>启动 Docker 服务。</p>\n<p>新建一个容器，可以看到它已经桥接到了 bridge0 上。</p>\n<p>可以继续用 brctl show 命令查看桥接的信息。另外，在容器中可以使用 ip addr 和 ip route 命令来查看 IP 地址配置和路由信息。</p>\n<h2 id="工具和示例"><a href="#%E5%B7%A5%E5%85%B7%E5%92%8C%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具和示例</h2>\n<p>在介绍自定义网络拓扑之前，你可能会对一些外部工具和例子感兴趣：</p>\n<h3 id="pipework"><a href="#pipework" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipework</h3>\n<p>Jérôme Petazzoni 编写了一个叫 <a href="https://github.com/jpetazzo/pipework" target="_blank" rel="nofollow noreferrer noopener">pipework</a> 的 shell 脚本，可以帮助用户在比较复杂的场景中完成容器的连接。</p>\n<h3 id="playground"><a href="#playground" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>playground</h3>\n<p>Brandon Rhodes 创建了一个提供完整的 Docker 容器网络拓扑管理的 <a href="https://github.com/brandon-rhodes/fopnp/tree/m/playground" target="_blank" rel="nofollow noreferrer noopener">Python 库</a>，包括路由、NAT 防火墙；以及一些提供 HTTP SMTP POP IMAP Telnet SSH FTP 的服务器。</p>\n<h2 id="编辑网络配置文件"><a href="#%E7%BC%96%E8%BE%91%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑网络配置文件</h2>\n<p>Docker 1.2.0 开始支持在运行中的容器里编辑 <code class="language-text">/etc/hosts</code>, <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/resolv.conf</code> 文件。</p>\n<p>但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被 <code class="language-text">docker commit</code> 提交。</p>\n<h2 id="示例：创建一个点到点连接"><a href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%82%B9%E5%88%B0%E7%82%B9%E8%BF%9E%E6%8E%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例：创建一个点到点连接</h2>\n<p>默认情况下，Docker 会将所有容器连接到由 docker0 提供的虚拟子网中。</p>\n<p>用户有时候需要两个容器之间可以直连通信，而不用通过主机网桥进行桥接。</p>\n<p>解决办法很简单：创建一对 peer 接口，分别放到两个容器中，配置成点到点链路类型即可。</p>\n<p>首先启动 2 个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84883108891772780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@1f1f4c1f931a:/#\n\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@12e343489d2f:/#`, `84883108891772780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@1f1f4c1f931a:/<span class="token comment">#</span>\n$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@12e343489d2f:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>找到进程号，然后创建网络命名空间的跟踪文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95338098888811580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect -f \'{{.State.Pid}}\' 1f1f4c1f931a\n2989\n\\$ docker inspect -f \'{{.State.Pid}}\' 12e343489d2f\n3004\n\\$ sudo mkdir -p /var/run/netns\n\\$ sudo ln -s /proc/2989/ns/net /var/run/netns/2989\n\\$ sudo ln -s /proc/3004/ns/net /var/run/netns/3004`, `95338098888811580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 1f1f4c1f931a\n<span class="token number">2989</span>\n$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 12e343489d2f\n<span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p /var/run/netns\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/2989/ns/net /var/run/netns/2989\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/3004/ns/net /var/run/netns/3004</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建一对 peer 接口，然后配置路由</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63863415790037090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip link add A type veth peer name B\n\n\\$ sudo ip link set A netns 2989\n\\$ sudo ip netns exec 2989 ip addr add 10.1.1.1/32 dev A\n\\$ sudo ip netns exec 2989 ip link set A up\n\\$ sudo ip netns exec 2989 ip route add 10.1.1.2/32 dev A\n\n\\$ sudo ip link set B netns 3004\n\\$ sudo ip netns exec 3004 ip addr add 10.1.1.2/32 dev B\n\\$ sudo ip netns exec 3004 ip link set B up\n\\$ sudo ip netns exec 3004 ip route add 10.1.1.1/32 dev B`, `63863415790037090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> A <span class="token builtin class-name">type</span> veth peer name B\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A netns <span class="token number">2989</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev A\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev A\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B netns <span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev B\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在这 2 个容器就可以相互 ping 通，并成功建立连接。点到点链路不需要子网和子网掩码。</p>\n<p>此外，也可以不指定 <code class="language-text">--net=none</code> 来创建点到点链路。这样容器还可以通过原先的网络来通信。</p>\n<p>利用类似的办法，可以创建一个只跟主机通信的容器。但是一般情况下，更推荐使用 <code class="language-text">--icc=false</code> 来关闭容器之间的通信。</p>\n<h1 id="swarm-mode"><a href="#swarm-mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode</h1>\n<p>Docker 1.12 <a href="https://docs.docker.com/engine/swarm/" target="_blank" rel="nofollow noreferrer noopener">Swarm mode</a> 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm。请注意与旧的 Docker Swarm 区分开来。</p>\n<p>Swarm mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。</p>\n<h2 id="基本概念-1"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p>Swarm 是使用 <a href="https://github.com/docker/swarmkit/" target="_blank" rel="nofollow noreferrer noopener">SwarmKit</a> 构建的 Docker 引擎内置（原生）的集群管理和编排工具。</p>\n<p>使用 Swarm 集群之前需要了解以下几个概念。</p>\n<h3 id="节点"><a href="#%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>运行 Docker 的主机可以主动初始化一个 Swarm 集群或者加入一个已存在的 Swarm 集群，这样这个运行 Docker 的主机就成为一个 Swarm 集群的节点 (node) 。</p>\n<p>节点分为管理 (manager) 节点和工作 (worker) 节点。</p>\n<p>管理节点用于 Swarm 集群的管理，docker swarm 命令基本只能在管理节点执行（节点退出集群命令 <code class="language-text">docker swarm leave</code> 可以在工作节点执行）。一个 Swarm 集群可以有多个管理节点，但只有一个管理节点可以成为 leader，leader 通过 <a href="https://thesecretlivesofdata.com/raft/" target="_blank" rel="nofollow noreferrer noopener">raft 协议</a>实现。</p>\n<p>工作节点是任务执行节点，管理节点将服务 (service) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>\n<p>来自 Docker 官网的这张图片形象的展示了集群中管理节点与工作节点的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.893123446561724%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABmUlEQVQoz22PWU/bQBSF8///QougahRE+1CQKgQq0DYtSI2VhpSgxCFexmPH+9iexZ7FS90AD7Q9Ojq69+HTuXfQ7dR2HVEt4s2jc9n1Lh5TdRHldpyDpIAJTih/Qtp20D0rKOtpJLRYTkJxZaSXm/ji4Y8/m2io2ad6fO2xW594RDbtP3BcNdOQj91SC/jUZ9cQX1r5jUt+BmwM8FfItEjYtEl4W+/oF3BUNd8hOV+4exPn7QJ9Afhi5b+eOG/u0m+QflpuX/0AV4BkslV/we2ueRFXmh0Nb/0TPbWwmm+Lw1/BxzWysJy52WgenBo5kv9rZqImlapk3XRdnwlmlWq4ajDjOeP9o3XbUV7z5hno4URKm1CAscvYA8piJWDJbFyEguspAkVhZLlXMq+k/RCKysxzWJaoVkjKwbwojgxjf+UcO95obQwN/wSA/aX9wfFH682hGbwzreEaHNn+e8M40N1jAA+WmzOYBoIPQiE8KeaIWiUHFZ+lxJfiPmc6Lj0hZil1hVgV7D6jgZL9ahI6dYOxue2P+g2C3u29d5l6SwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 29" title="" data-src="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png" data-srcset="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-a67b7.png 200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-0b187.png 400w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png 800w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-b1a91.png 1200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png 1207w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="服务和任务"><a href="#%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务和任务</h3>\n<p>任务（Task）是 Swarm 中的最小的调度单位，目前来说就是一个单一的容器。</p>\n<p>服务（Services）是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>\n<ol>\n<li><code class="language-text">replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>\n<li><code class="language-text">global services</code> 每个工作节点上运行一个任务</li>\n</ol>\n<p>两种模式通过 <code class="language-text">docker service create</code> 的 <code class="language-text">--mode</code> 参数指定。</p>\n<p>来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQoz4VS227bMAzN/3/JHnfBuqJb16xp2mQN2mRYk665+iZbN9uKJcuWZGWyvZcBQ0cQgiTygDw8HJxeN2uXqw2mqbsCAFfP2+WvLeeijZxOg1eAjbXPnE8gekyzOWNTQsYRmGI8JiSW8tSDbZcnSlmIUmltux9nldLnfvBuvfscgRFjS4R9kLj6wzh+4bwF2y7RGLP3o5edl7FjX9OdR1FeRuArwjdpepPntwgvKF0Qeh7H2x5cmwYKRaRJeA1YRav2KVQja1UppWxTNQ1mxXLnraPYeaFUaYxumhbMVTMM5G2irsPS+QTpy0BGx0pr7cKZUlRrUtdJWfqce0IEUkZSii464LW5R2qO6/cPmzfjn3d+PiMGFLUj4tp2bM/C6CJOrtJ0CuETRKsEnQOwLrq2XdoEqhmUH+b7tw+7sccmuAU3xjAhLkF84YfXEM3KckXTgKY+It8gXPOiBTt6s6R6xMr5nGjXwndYJUWtu7HvhViX4inLbg7+2A/vQrA6skWW0arqBqabUttDQlYHsAnhj42fclk3VsiWtpu687KqEE1xzmDGKmOcFr2Wgz7811K1Up16qUYQDQkZUTpm+Qjje0qmCH0CYN9L9e+l7E5Z12cH7+N2/yUEE843hCKICcRjiF5eAfdmrF0wNsvzmeOM0DWIJxA+pOkQoaAs/wNu+3dmbX7kay/wYniIoeNs7J8N/g1ZjhJSNTR2XQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 53" title="" data-src="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" data-srcset="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-a67b7.png 200w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-0b187.png 400w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png 800w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="创建-swarm-集群"><a href="#%E5%88%9B%E5%BB%BA-swarm-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 Swarm 集群</h2>\n<p>Swarm 集群由管理节点和工作节点组成，本节我们来创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群。</p>\n<h3 id="初始化集群"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化集群</h3>\n<p>在已经安装好 Docker 的主机上执行如下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46894096944654385000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm init --advertise-addr 192.168.99.100\nSwarm initialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.\n\nTo add a worker to this swarm, run the following command:\n\n    docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nTo add a manager to this swarm, run \'docker swarm join-token manager\' and follow the instructions.`, `46894096944654385000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm init --advertise-addr <span class="token number">192.168</span>.99.100\nSwarm initialized: current node <span class="token punctuation">(</span>dxn1zf6l61qsb1josjja83ngz<span class="token punctuation">)</span> is now a manager.\n\nTo <span class="token function">add</span> a worker to this swarm, run the following command:\n\n    docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nTo <span class="token function">add</span> a manager to this swarm, run <span class="token string">\'docker swarm join-token manager\'</span> and follow the instructions.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 Docker 主机有多个网卡，拥有多个 IP，必须使用 <code class="language-text">--advertise-addr</code> 指定 IP。</p>\n<blockquote>\n<p>执行 <code class="language-text">docker swarm init</code> 命令的节点自动成为管理节点。</p>\n</blockquote>\n<h3 id="增加工作节点"><a href="#%E5%A2%9E%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加工作节点</h3>\n<p>上一步我们初始化了一个 Swarm 集群，拥有了一个管理节点，下面我们继续在两个 Docker 主机中分别执行如下命令，创建工作节点并加入到集群中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33220738084100776000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nThis node joined a swarm as a worker.`, `33220738084100776000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nThis node joined a swarm as a worker.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看集群"><a href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看集群</h3>\n<p>经过上边的两步，我们已经拥有了一个最小的 Swarm 集群，包含一个管理节点和两个工作节点。</p>\n<p>在管理节点使用 <code class="language-text">docker node ls</code> 查看集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39353613844688610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker node ls\nID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader`, `39353613844688610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker node <span class="token function">ls</span>\nID                           <span class="token environment constant">HOSTNAME</span>  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="部署服务"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h2>\n<p>我们使用 docker service 命令来管理 Swarm 集群中的服务，该命令只能在管理节点运行。</p>\n<h3 id="新建服务"><a href="#%E6%96%B0%E5%BB%BA%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建服务</h3>\n<p>现在我们在上一节创建的 Swarm 集群中运行一个名为 nginx 服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83995756604503620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create --replicas 3 -p 80:80 --name nginx nginx:1.13.7-alpine`, `83995756604503620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create --replicas <span class="token number">3</span> -p <span class="token number">80</span>:80 --name nginx nginx:1.13.7-alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们使用浏览器，输入任意节点 IP（即 <code class="language-text">192.168.99.100:80</code>），即可看到 nginx 默认页面。</p>\n<h3 id="查看服务"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<p>使用 <code class="language-text">docker service ls</code> 来查看当前 Swarm 集群运行的服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36154720505069450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          3/3                 nginx:1.13.7-alpine   *:80->80/tcp`, `36154720505069450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          <span class="token number">3</span>/3                 nginx:1.13.7-alpine   *:80-<span class="token operator">></span><span class="token number">80</span>/tcp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service ps</code> 来查看某个服务的详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5960243016610845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago`, `5960243016610845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service logs</code> 来查看某个服务的日志。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="618202281623880800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 2017/11/25 02:10:30 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.102&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:26 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:27 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 2017/11/25 02:10:27 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.101&quot;`, `618202281623880800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:30 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.102"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:26 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:27 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:27 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.101"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="服务伸缩"><a href="#%E6%9C%8D%E5%8A%A1%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务伸缩</h3>\n<p>我们可以使用 <code class="language-text">docker service scale</code> 对一个服务运行的容器数量进行伸缩。</p>\n<p>当业务处于高峰期时，我们需要扩展服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31366081817735590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=5`, `31366081817735590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当业务平稳时，我们需要减少服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35576690375394947000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=2`, `35576690375394947000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="删除服务"><a href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除服务</h3>\n<p>使用 <code class="language-text">docker service rm</code> 来从 Swarm 集群移除某个服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32283512157300675000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rm nginx`, `32283512157300675000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">rm</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="在-swarm-集群中使用-compose-文件"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E4%BD%BF%E7%94%A8-compose-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中使用 compose 文件</h2>\n<p>正如之前使用 <code class="language-text">docker-compose.yml</code> 来一次配置、启动多个容器，在 Swarm 集群中也可以使用 compose 文件（docker-compose.yml）来配置、启动多个服务。</p>\n<p>上一节中，我们使用 <code class="language-text">docker service create</code> 一次只能部署一个服务，使用 <code class="language-text">docker-compose.yml</code> 我们可以一次启动多个关联的服务。</p>\n<p>我们以在 Swarm 集群中部署 WordPress 为例进行说明。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53432992712111730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  wordpress:\n    image: wordpress\n    ports:\n      - 80:80\n    networks:\n      - overlay\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\n    deploy:\n      mode: replicated\n      replicas: 3\n\n  db:\n    image: mysql\n    networks:\n      - overlay\n    volumes:\n      - db-data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  visualizer:\n    image: dockersamples/visualizer:stable\n    ports:\n      - \'8080:8080\'\n    stop_grace_period: 1m30s\n    volumes:\n      - \'/var/run/docker.sock:/var/run/docker.sock\'\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\nvolumes:\n  db-data:\nnetworks:\n  overlay:`, `53432992712111730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">mode</span><span class="token punctuation">:</span> replicated\n      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n  <span class="token key atrule">visualizer</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> dockersamples/visualizer<span class="token punctuation">:</span>stable\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8080:8080\'</span>\n    <span class="token key atrule">stop_grace_period</span><span class="token punctuation">:</span> 1m30s\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/var/run/docker.sock:/var/run/docker.sock\'</span>\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db-data</span><span class="token punctuation">:</span>\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  overlay<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Swarm 集群管理节点新建该文件，其中的 visualizer 服务提供一个可视化页面，我们可以从浏览器中很直观的查看集群中各个服务的运行节点。</p>\n<p>在 Swarm 集群中使用 <code class="language-text">docker-compose.yml</code> 需要用 <code class="language-text">docker stack</code> 命令，下面我们对该命令进行详细讲解。</p>\n<h3 id="部署服务-1"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h3>\n<p>部署服务使用 <code class="language-text">docker stack deploy</code>，其中 <code class="language-text">-c</code> 参数指定 compose 文件名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23900984492527088000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack deploy -c docker-compose.yml wordpress`, `23900984492527088000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack deploy -c docker-compose.yml wordpress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们打开浏览器输入 <code class="language-text">任一节点IP:8080</code> 即可看到各节点运行状态。</p>\n<p>在浏览器新的标签页输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 安装界面，安装完成之后，输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 页面。</p>\n<h3 id="查看服务-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46251150781502440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack ls\nNAME                SERVICES\nwordpress           3`, `46251150781502440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack <span class="token function">ls</span>\nNAME                SERVICES\nwordpress           <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="移除服务"><a href="#%E7%A7%BB%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移除服务</h3>\n<p>要移除服务，使用 <code class="language-text">docker stack down</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2726855010850415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack down wordpress\nRemoving service wordpress_db\nRemoving service wordpress_visualizer\nRemoving service wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default`, `2726855010850415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack down wordpress\nRemoving <span class="token function">service</span> wordpress_db\nRemoving <span class="token function">service</span> wordpress_visualizer\nRemoving <span class="token function">service</span> wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该命令不会移除服务所使用的数据卷，如果你想移除数据卷请使用 <code class="language-text">docker volume rm</code></p>\n<h2 id="在-swarm-集群中管理敏感数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理敏感数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发密码、证书等敏感信息是极其重要的工作。传统的密钥分发方式（如密钥放入镜像中，设置环境变量，volume 动态挂载等）都存在着潜在的巨大的安全风险。</p>\n<p>Docker 目前已经提供了 secrets 管理功能，用户可以在 Swarm 集群中安全地管理密码、密钥证书等敏感数据，并允许在多个 Docker 容器实例之间共享访问指定的敏感数据。</p>\n<blockquote>\n<p>注意：secret 也可以在 Docker Compose 中使用。</p>\n</blockquote>\n<p>我们可以用 docker secret 命令来管理敏感信息。接下来我们在上面章节中创建好的 Swarm 集群中介绍该命令的使用。</p>\n<p>这里我们以在 Swarm 集群中部署 mysql 和 wordpress 服务为例。</p>\n<h3 id="创建-secret"><a href="#%E5%88%9B%E5%BB%BA-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 secret</h3>\n<p>我们使用 <code class="language-text">docker secret create</code> 命令以管道符的形式创建 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2683370850101019000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ openssl rand -base64 20 | docker secret create mysql_password -\n\n\\$ openssl rand -base64 20 | docker secret create mysql_root_password -`, `2683370850101019000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_password -\n\n$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_root_password -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看-secret"><a href="#%E6%9F%A5%E7%9C%8B-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 secret</h3>\n<p>使用 <code class="language-text">docker secret ls</code> 命令来查看 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59289688817347576000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker secret ls\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        41 seconds ago      41 seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   12 seconds ago      12 seconds ago`, `59289688817347576000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker secret <span class="token function">ls</span>\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        <span class="token number">41</span> seconds ago      <span class="token number">41</span> seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   <span class="token number">12</span> seconds ago      <span class="token number">12</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-mysql-服务"><a href="#%E5%88%9B%E5%BB%BA-mysql-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 MySQL 服务</h3>\n<p>创建服务相关命令已经在前边章节进行了介绍，这里直接列出命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53033089311103250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d overlay mysql_private\n\n\\$ docker service create \\\n     --name mysql \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --mount type=volume,source=mydata,destination=/var/lib/mysql \\\n     --secret source=mysql_root_password,target=mysql_root_password \\\n     --secret source=mysql_password,target=mysql_password \\\n     -e MYSQL_ROOT_PASSWORD_FILE=&quot;/run/secrets/mysql_root_password&quot; \\\n     -e MYSQL_PASSWORD_FILE=&quot;/run/secrets/mysql_password&quot; \\\n     -e MYSQL_USER=&quot;wordpress&quot; \\\n     -e MYSQL_DATABASE=&quot;wordpress&quot; \\\n     mysql:latest`, `53033089311103250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d overlay mysql_private\n\n$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name mysql <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>mydata,destination<span class="token operator">=</span>/var/lib/mysql <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_root_password,target<span class="token operator">=</span>mysql_root_password <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>mysql_password <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_root_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     mysql:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，secret 默认通过 tmpfs 文件系统挂载到容器的 /run/secrets 目录中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10601504570286012000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name wordpress \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --publish target=30000,port=80 \\\n     --mount type=volume,source=wpdata,destination=/var/www/html \\\n     --secret source=mysql_password,target=wp_db_password,mode=0444 \\\n     -e WORDPRESS_DB_USER=&quot;wordpress&quot; \\\n     -e WORDPRESS_DB_PASSWORD_FILE=&quot;/run/secrets/wp_db_password&quot; \\\n     -e WORDPRESS_DB_HOST=&quot;mysql:3306&quot; \\\n     -e WORDPRESS_DB_NAME=&quot;wordpress&quot; \\\n     wordpress:latest`, `10601504570286012000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name wordpress <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --publish <span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token number">30000</span>,port<span class="token operator">=</span><span class="token number">80</span> <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>wpdata,destination<span class="token operator">=</span>/var/www/html <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>wp_db_password,mode<span class="token operator">=</span>0444 <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/wp_db_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_HOST</span><span class="token operator">=</span><span class="token string">"mysql:3306"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_NAME</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看服务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45237563375767810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  1/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  1/1       wordpress:latest`, `45237563375767810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  <span class="token number">1</span>/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  <span class="token number">1</span>/1       wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在浏览器访问 <code class="language-text">IP:30000</code>，即可开始 WordPress 的安装与使用。</p>\n<p>通过以上方法，我们没有像以前通过设置环境变量来设置 MySQL 密码，而是采用 <code class="language-text">docker secret</code> 来设置密码，防范了密码泄露的风险。</p>\n<h2 id="在-swarm-集群中管理配置数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理配置数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发配置文件也是很重要的工作。传统的配置文件分发方式（如配置文件放入镜像中，设置环境变量，volume 动态挂载等）都降低了镜像的通用性。</p>\n<p>在 Docker 17.06 以上版本中，Docker 新增了 docker config 子命令来管理集群中的配置信息，以后你无需将配置文件放入镜像或挂载到容器中就可实现对服务的配置。</p>\n<blockquote>\n<p>注意：config 仅能在 Swarm 集群中使用。</p>\n</blockquote>\n<p>这里我们以在 Swarm 集群中部署 redis 服务为例。</p>\n<h3 id="创建-config"><a href="#%E5%88%9B%E5%BB%BA-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 config</h3>\n<p>新建 redis.conf 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95993535154018880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`port 6380`, `95993535154018880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">port <span class="token number">6380</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此项配置 Redis 监听 6380 端口</p>\n<p>我们使用 docker config create 命令创建 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22926917328656280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config create redis.conf redis.conf`, `22926917328656280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config create redis.conf redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看-config"><a href="#%E6%9F%A5%E7%9C%8B-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 config</h3>\n<p>使用 docker config ls 命令来查看 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85683445890225650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config ls\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          4 seconds ago       4 seconds ago`, `85683445890225650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config <span class="token function">ls</span>\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          <span class="token number">4</span> seconds ago       <span class="token number">4</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-redis-服务"><a href="#%E5%88%9B%E5%BB%BA-redis-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 redis 服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57954729068851440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name redis \\\n     # --config source=redis.conf,target=/etc/redis.conf \\\n     --config redis.conf \\\n     -p 6379:6380 \\\n     redis:latest \\\n     redis-server /redis.conf`, `57954729068851440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name redis <span class="token punctuation">\\</span>\n     <span class="token comment"># --config source=redis.conf,target=/etc/redis.conf \\</span>\n     --config redis.conf <span class="token punctuation">\\</span>\n     -p <span class="token number">6379</span>:6380 <span class="token punctuation">\\</span>\n     redis:latest <span class="token punctuation">\\</span>\n     redis-server /redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，默认的 redis.conf 以 tmpfs 文件系统挂载到容器的 /config.conf。</p>\n<p>经过测试，redis 可以正常使用。</p>\n<p>以前我们通过监听主机目录来配置 Redis，就需要在集群的每个节点放置该文件，如果采用 <code class="language-text">docker config</code> 来管理服务的配置信息，我们只需在集群中的管理节点创建 config，当部署服务时，集群会自动的将配置文件分发到运行服务的各个节点中，大大降低了配置信息的管理和分发难度。</p>\n<h2 id="swarm-mode-与滚动升级"><a href="#swarm-mode-%E4%B8%8E%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode 与滚动升级</h2>\n<p>在部署服务一节中我们使用 <code class="language-text">nginx:1.13.7-alpine</code> 镜像部署了一个名为 nginx 的服务。</p>\n<p>现在我们想要将 NGINX 版本升级到 <code class="language-text">1.13.12</code>，那么在 <code class="language-text">Swarm mode</code> 中如何升级服务呢？</p>\n<p>你可能会想到，先停止原来的服务，再使用新镜像部署一个服务，不就完成服务的 “升级” 了吗。</p>\n<p>这样做的弊端很明显，如果新部署的服务出现问题，原来的服务删除之后，很难恢复，那么在 Swarm mode 中到底该如何对服务进行滚动升级呢？</p>\n<p>答案就是使用 <code class="language-text">docker service update</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67443358683907100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service update \\\n    --image nginx:1.13.12-alpine \\\n    nginx`, `67443358683907100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> update <span class="token punctuation">\\</span>\n    --image nginx:1.13.12-alpine <span class="token punctuation">\\</span>\n    nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>以上命令使用 <code class="language-text">--image</code> 选项更新了服务的镜像。当然我们也可以使用 <code class="language-text">docker service update</code> 更新任意的配置。</p>\n<p><code class="language-text">--secret-add</code> 选项可以增加一个密钥</p>\n<p><code class="language-text">--secret-rm</code> 选项可以删除一个密钥</p>\n<p>更多选项可以通过 <code class="language-text">docker service update -h</code> 命令查看。</p>\n<h3 id="服务回退"><a href="#%E6%9C%8D%E5%8A%A1%E5%9B%9E%E9%80%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务回退</h3>\n<p>现在假设我们发现 nginx 服务的镜像升级到 <code class="language-text">nginx:1.13.12-alpine</code> 出现了一些问题，我们可以使用命令一键回退。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17392894991462238000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rollback nginx`, `17392894991462238000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> rollback nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在使用 docker service ps 命令查看 nginx 服务详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54443929490181970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         \\_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown 2 minutes ago\ni7ynkbg6ybq5         \\_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown 2 minutes ago`, `54443929490181970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago\ni7ynkbg6ybq5         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果的输出详细记录了服务的部署、滚动升级、回退的过程。</p>\n<h1 id="docker-buildx"><a href="#docker-buildx" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Buildx</h1>\n<p>Docker Buildx 是一个 docker CLI 插件，其扩展了 docker 命令，支持 Moby BuildKit 提供的功能。提供了与 docker build 相同的用户体验，并增加了许多新功能。</p>\n<blockquote>\n<p>该功能仅适用于 Docker v19.03+ 版本</p>\n</blockquote>\n<h2 id="使用-buildkit-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildkit-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 BuildKit 构建镜像</h2>\n<p>BuildKit 是下一代的镜像构建组件，在 <a href="https://github.com/moby/buildkit" target="_blank" rel="nofollow noreferrer noopener">https://github.com/moby/buildkit</a> 开源。</p>\n<blockquote>\n<p>注意：如果您的镜像构建使用的是云服务商提供的镜像构建服务（腾讯云容器服务、阿里云容器服务等），由于上述服务提供商的 Docker 版本低于 18.09，BuildKit 无法使用，将造成镜像构建失败。建议使用 BuildKit 构建镜像时使用一个新的 Dockerfile 文件（例如 Dockerfile.buildkit）</p>\n</blockquote>\n<p>目前，Docker Hub 自动构建已经支持 buildkit，具体请参考 <a href="https://github.com/docker-practice/docker-hub-buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/docker-hub-buildx</a></p>\n<h3 id="dockerfile-新增指令详解"><a href="#dockerfile-%E6%96%B0%E5%A2%9E%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 新增指令详解</h3>\n<p>启用 BuildKit 之后，我们可以使用下面几个新的 Dockerfile 指令来加快镜像构建。</p>\n<h4 id="run---mounttypecache"><a href="#run---mounttypecache" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=cache</h4>\n<p>目前，几乎所有的程序都会使用依赖管理工具，例如 Go 中的 go mod、Node.js 中的 npm 等等，当我们构建一个镜像时，往往会重复的从互联网中获取依赖包，难以缓存，大大降低了镜像的构建效率。</p>\n<p>例如一个前端工程需要用到 npm：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67894855845194520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN npm i --registry=https://registry.npm.taobao.org \\\n        && rm -rf ~/.npm\n\nCOPY src /app/src\n\nRUN npm run build\n\nFROM nginx:alpine\n\nCOPY --from=builder /app/dist /app/dist`, `67894855845194520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org \\\n        &amp;&amp; rm <span class="token punctuation">-</span>rf ~/.npm\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /app/dist /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用多阶段构建，构建的镜像中只包含了目标文件夹 dist，但仍然存在一些问题，当 package.json 文件变动时，<code class="language-text">RUN npm i &amp;&amp; rm -rf ~/.npm</code> 这一层会重新执行，变更多次后，生成了大量的中间层镜像。</p>\n<p>为解决这个问题，进一步的我们可以设想一个类似数据卷的功能，在镜像构建时把 <code class="language-text">node_modules</code> 文件夹挂载上去，在构建完成后，这个 <code class="language-text">node_modules</code> 文件夹会自动卸载，实际的镜像中并不包含 <code class="language-text">node_modules</code> 这个文件夹，这样我们就省去了每次获取依赖的时间，大大增加了镜像构建效率，同时也避免了生成了大量的中间层镜像。</p>\n<p>BuildKit 提供了 <code class="language-text">RUN --mount=type=cache</code> 指令，可以实现上边的设想。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85437429113542080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\nFROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n        npm i --registry=https://registry.npm.taobao.org\n\nCOPY src /app/src\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n# --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\\n        npm run build\n\nFROM nginx:alpine\n\n# COPY --from=builder /app/dist /app/dist\n\n# 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令\nRUN --mount=type=cache,target=/tmp/dist,from=builder,source=/app/dist \\\n    # --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\\n    mkdir -p /app/dist && cp -r /tmp/dist/* /app/dist`, `85437429113542080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n        npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n<span class="token comment"># --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\</span>\n        npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token comment"># COPY --from=builder /app/dist /app/dist</span>\n\n<span class="token comment"># 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/tmp/dist<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/app/dist \\\n    <span class="token comment"># --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\</span>\n    mkdir <span class="token punctuation">-</span>p /app/dist &amp;&amp; cp <span class="token punctuation">-</span>r /tmp/dist/* /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 BuildKit 为实验特性，每个 Dockerfile 文件开头都必须加上如下指令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="712991327982326400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental`, `712991327982326400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一个 RUN 指令执行后，id 为 <code class="language-text">my_app_npm_module</code> 的缓存文件夹挂载到了 <code class="language-text">/app/node_modules</code> 文件夹中。多次执行也不会产生多个中间层镜像。</p>\n<p>第二个 RUN 指令执行时需要用到 <code class="language-text">node_modules</code> 文件夹，<code class="language-text">node_modules</code> 已经挂载，命令也可以正确执行。</p>\n<p>第三个 RUN 指令将上一阶段产生的文件复制到指定位置，from 指明缓存的来源，这里 builder 表示缓存来源于构建的第一阶段，source 指明缓存来源的文件夹。</p>\n<p>上面的 Dockerfile 中 <code class="language-text">--mount=type=cache,...</code> 中指令作用如下：</p>\n<table>\n<thead>\n<tr>\n<th align="left">Option</th>\n<th align="left">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">id</td>\n<td align="left">id 设置一个标志，以便区分缓存。</td>\n</tr>\n<tr>\n<td align="left">target(必填项)</td>\n<td align="left">缓存的挂载目标文件夹。</td>\n</tr>\n<tr>\n<td align="left">ro,readonly</td>\n<td align="left">只读，缓存文件夹不能被写入。</td>\n</tr>\n<tr>\n<td align="left">sharing</td>\n<td align="left">有 shared private locked 值可供选择。sharing 设置当一个缓存被多次使用时的表现，由于 BuildKit 支持并行构建，当多个步骤使用同一缓存时（同一 id）会发生冲突。shared 表示多个步骤可以同时读写，private 表示当多个步骤使用同一缓存时，每个步骤使用不同的缓存，locked 表示当一个步骤完成释放缓存后，后一个步骤才能继续使用该缓存。</td>\n</tr>\n<tr>\n<td align="left">from</td>\n<td align="left">缓存来源（构建阶段），不填写时为空文件夹。</td>\n</tr>\n<tr>\n<td align="left">source</td>\n<td align="left">来源的文件夹路径。</td>\n</tr>\n</tbody>\n</table>\n<h4 id="run---mounttypebind"><a href="#run---mounttypebind" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=bind</h4>\n<p>该指令可以将一个镜像（或上一构建阶段）的文件挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52111943330502860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=bind,from=php:alpine,source=/usr/local/bin/docker-php-entrypoint,target=/docker-php-entrypoint \\\n        cat /docker-php-entrypoint`, `52111943330502860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>from=php<span class="token punctuation">:</span>alpine<span class="token punctuation">,</span>source=/usr/local/bin/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint<span class="token punctuation">,</span>target=/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint \\\n        cat /docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypetmpfs"><a href="#run---mounttypetmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=tmpfs</h4>\n<p>该指令可以将一个 tmpfs 文件系统挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90628130375268910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=tmpfs,target=/temp \\\n        mount | grep /temp`, `90628130375268910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=tmpfs<span class="token punctuation">,</span>target=/temp \\\n        mount <span class="token punctuation">|</span> grep /temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypesecret"><a href="#run---mounttypesecret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=secret</h4>\n<p>该指令可以将一个文件（例如密钥）挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78482369926022090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=secret,id=aws,target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n\\$ docker build -t test --secret id=aws,src=\\$HOME/.aws/credentials .`, `78482369926022090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=secret<span class="token punctuation">,</span>id=aws<span class="token punctuation">,</span>target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n$ docker build <span class="token punctuation">-</span>t test <span class="token punctuation">-</span><span class="token punctuation">-</span>secret id=aws<span class="token punctuation">,</span>src=$HOME/.aws/credentials .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypessh"><a href="#run---mounttypessh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=ssh</h4>\n<p>该指令可以挂载 ssh 密钥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31509973880597262000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM alpine\nRUN apk add --no-cache openssh-client\nRUN mkdir -p -m 0700 ~/.ssh && ssh-keyscan gitlab.com >> ~/.ssh/known_hosts\nRUN --mount=type=ssh ssh git@gitlab.com | tee /hello`, `31509973880597262000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> alpine\n<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache openssh<span class="token punctuation">-</span>client\n<span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p <span class="token punctuation">-</span>m 0700 ~/.ssh &amp;&amp; ssh<span class="token punctuation">-</span>keyscan gitlab.com <span class="token punctuation">></span><span class="token punctuation">></span> ~/.ssh/known_hosts\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=ssh ssh git@gitlab.com <span class="token punctuation">|</span> tee /hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23014697920460070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ eval \\$(ssh-agent)\n\\$ ssh-add ~/.ssh/id_rsa\n(Input your passphrase here)\n\\$ docker build -t test --ssh default=\\$SSH_AUTH_SOCK .`, `23014697920460070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>ssh-agent<span class="token variable">)</span></span>\n$ ssh-add ~/.ssh/id_rsa\n<span class="token punctuation">(</span>Input your passphrase here<span class="token punctuation">)</span>\n$ docker build -t <span class="token builtin class-name">test</span> --ssh <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token environment constant">$SSH_AUTH_SOCK</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="使用-buildx-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Buildx 构建镜像</h2>\n<h3 id="使用"><a href="#%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h3>\n<p>你可以直接使用 docker buildx build 命令构建镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47817616853745480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build .\n[+] Building 8.4s (23/32)\n => ...`, `47817616853745480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build <span class="token builtin class-name">.</span>\n<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">8</span>.4s <span class="token punctuation">(</span><span class="token number">23</span>/32<span class="token punctuation">)</span>\n <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Buildx 使用 BuildKit 引擎 进行构建，支持许多新的功能，具体参考 Buildkit 一节。</p>\n<h3 id="官方文档"><a href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方文档</h3>\n<p><a href="https://docs.docker.com/engine/reference/commandline/buildx/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/engine/reference/commandline/buildx/</a></p>\n<h2 id="使用-buildx-构建多种系统架构支持的-docker-镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 buildx 构建多种系统架构支持的 Docker 镜像</h2>\n<p>在之前的版本中构建多种系统架构支持的 Docker 镜像，要想使用统一的名字必须使用 <code class="language-text">$ docker manifest</code> 命令。</p>\n<p>在 Docker 19.03+ 版本中可以使用 <code class="language-text">$ docker buildx build</code> 命令使用 BuildKit 构建镜像。该命令支持 <code class="language-text">--platform</code> 参数可以同时构建支持多种系统架构的 Docker 镜像，大大简化了构建步骤。</p>\n<h3 id="新建-builder-实例"><a href="#%E6%96%B0%E5%BB%BA-builder-%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建 builder 实例</h3>\n<p>Docker for Linux 不支持构建 arm 架构镜像，我们可以运行一个新的容器让其支持该特性，Docker 桌面版无需进行此项设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25601231954245927000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm --privileged tonistiigi/binfmt:latest --install all`, `25601231954245927000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm --privileged tonistiigi/binfmt:latest --install all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 Docker 默认的 builder 实例不支持同时指定多个 <code class="language-text">--platform</code>，我们必须首先创建一个新的 builder 实例。同时由于国内拉取镜像较缓慢，我们可以使用配置了<a href="https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md" target="_blank" rel="nofollow noreferrer noopener">镜像加速地址</a>的 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">dockerpracticesig/buildkit:master</a> 镜像替换官方镜像。</p>\n<blockquote>\n<p>如果你有私有的镜像加速器，可以基于 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/buildx</a> 构建自己的 buildkit 镜像并使用它。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60585608002171230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 适用于国内环境\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master\n\n# 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-tencent\n\n# \\$ docker buildx create --name mybuilder --driver docker-container\n\n\\$ docker buildx use mybuilder`, `60585608002171230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 适用于国内环境</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master\n\n<span class="token comment"># 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master-tencent\n\n<span class="token comment"># $ docker buildx create --name mybuilder --driver docker-container</span>\n\n$ docker buildx use mybuilder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建镜像-2"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>新建 Dockerfile 文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44453084143226240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM --platform=\\$TARGETPLATFORM alpine\n\nRUN uname -a > /os.txt\n\nCMD cat /os.txt`, `44453084143226240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>platform=$TARGETPLATFORM alpine\n\n<span class="token keyword">RUN</span> uname <span class="token punctuation">-</span>a <span class="token punctuation">></span> /os.txt\n\n<span class="token keyword">CMD</span> cat /os.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">$ docker buildx build</code> 命令构建镜像，注意将 <code class="language-text">myusername</code> 替换为自己的 <code class="language-text">Docker Hub</code> 用户名。</p>\n<p><code class="language-text">--push</code> 参数表示将构建好的镜像推送到 Docker 仓库。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46721293041717395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello . --push\n\n# 查看镜像信息\n\\$ docker buildx imagetools inspect myusername/hello`, `46721293041717395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello <span class="token builtin class-name">.</span> --push\n\n<span class="token comment"># 查看镜像信息</span>\n$ docker buildx imagetools inspect myusername/hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在不同架构运行该镜像，可以得到该架构的信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10677189567374068000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# arm\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux\n\n# arm64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux\n\n# amd64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux`, `10677189567374068000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># arm</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux</span>\n\n<span class="token comment"># arm64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux</span>\n\n<span class="token comment"># amd64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="架构相关变量"><a href="#%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构相关变量</h3>\n<p>Dockerfile 支持如下架构相关的变量</p>\n<ul>\n<li>TARGETPLATFORM：构建镜像的目标平台，例如 <code class="language-text">linux/amd64</code>, <code class="language-text">linux/arm/v7</code>, <code class="language-text">windows/amd64</code>。</li>\n<li>TARGETOS：TARGETPLATFORM 的 OS 类型，例如 linux, windows</li>\n<li>TARGETARCH：TARGETPLATFORM 的架构类型，例如 amd64, arm</li>\n<li>TARGETVARIANT：TARGETPLATFORM 的变种，该变量可能为空，例如 v7</li>\n<li>BUILDPLATFORM：构建镜像主机平台，例如 <code class="language-text">linux/amd64</code></li>\n<li>BUILDOS：BUILDPLATFORM 的 OS 类型，例如 linux</li>\n<li>BUILDARCH：BUILDPLATFORM 的架构类型，例如 amd64</li>\n<li>BUILDVARIANT：BUILDPLATFORM 的变种，该变量可能为空，例如 v7</li>\n</ul>\n<h4 id="使用举例"><a href="#%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用举例</h4>\n<p>例如我们要构建支持 <code class="language-text">linux/arm/v7</code> 和 <code class="language-text">linux/amd64</code> 两种架构的镜像。假设已经生成了两个平台对应的二进制文件：</p>\n<ul>\n<li>bin/dist-linux-arm</li>\n<li>bin/dist-linux-amd64</li>\n</ul>\n<p>那么 Dockerfile 可以这样书写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7147101189268823000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n\n# 使用变量必须申明\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-\\${TARGETOS}-\\${TARGETARCH} /dist\n\nENTRYPOINT [&quot;dist&quot;]`, `7147101189268823000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n\n<span class="token comment"># 使用变量必须申明</span>\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-<span class="token variable">${TARGETOS}</span>-<span class="token variable">${TARGETARCH}</span> /dist\n\nENTRYPOINT <span class="token punctuation">[</span><span class="token string">"dist"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="podman"><a href="#podman" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>podman</h1>\n<p><a href="https://github.com/containers/podman" target="_blank" rel="nofollow noreferrer noopener">podman</a> 是一个无守护程序与 docker 命令兼容的下一代 Linux 容器工具。</p>\n<h2 id="安装"><a href="#%E5%AE%89%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55794590375853550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo yum -y install podman`, `55794590375853550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> yum -y <span class="token function">install</span> podman</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-1"><a href="#%E4%BD%BF%E7%94%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<p>podman 与 docker 命令完全兼容，只需将 docker 替换为 podman 即可，例如运行一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11862973982844060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker run -d -p 80:80 nginx:alpine\n\n\\$ podman run -d -p 80:80 nginx:alpine`, `11862973982844060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker run -d -p 80:80 nginx:alpine</span>\n\n$ podman run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="常见问题总结"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见问题总结</h1>\n<h2 id="镜像相关"><a href="#%E9%95%9C%E5%83%8F%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像相关</h2>\n<h3 id="如何批量清理临时镜像文件？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E4%B8%B4%E6%97%B6%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理临时镜像文件？</h3>\n<p>答：可以使用 <code class="language-text">docker image prune</code> 命令。</p>\n<h3 id="如何查看镜像支持的环境变量？"><a href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何查看镜像支持的环境变量？</h3>\n<p>答：可以使用 <code class="language-text">docker run IMAGE env</code> 命令。</p>\n<h3 id="本地的镜像文件都存放在哪里？"><a href="#%E6%9C%AC%E5%9C%B0%E7%9A%84%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E9%83%BD%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地的镜像文件都存放在哪里？</h3>\n<p>答：与 Docker 相关的本地资源默认存放在 <code class="language-text">/var/lib/docker/</code> 目录下，以 overlay2 文件系统为例，其中 containers 目录存放容器信息，image 目录存放镜像信息，overlay2 目录下存放具体的镜像层文件。</p>\n<h3 id="构建-docker-镜像应该遵循哪些原则？"><a href="#%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F%E5%BA%94%E8%AF%A5%E9%81%B5%E5%BE%AA%E5%93%AA%E4%BA%9B%E5%8E%9F%E5%88%99%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建 Docker 镜像应该遵循哪些原则？</h3>\n<p>答：整体原则上，尽量保持镜像功能的明确和内容的精简，要点包括</p>\n<ul>\n<li>尽量选取满足需求但较小的基础系统镜像，例如大部分时候可以选择 alpine 镜像，仅有不足六兆大小；</li>\n<li>清理编译生成文件、安装包的缓存等临时文件；</li>\n<li>安装各个软件时候要指定准确的版本号，并避免引入不需要的依赖；</li>\n<li>从安全角度考虑，应用要尽量使用系统的库和依赖；</li>\n<li>如果安装应用时候需要配置一些特殊的环境变量，在安装后要还原不需要保持的变量值；</li>\n<li>使用 Dockerfile 创建镜像时候要添加 <code class="language-text">.dockerignore</code> 文件或使用干净的工作目录。</li>\n</ul>\n<h3 id="碰到网络问题，无法-pull-镜像，命令行指定-http_proxy-无效？"><a href="#%E7%A2%B0%E5%88%B0%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%EF%BC%8C%E6%97%A0%E6%B3%95-pull-%E9%95%9C%E5%83%8F%EF%BC%8C%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8C%87%E5%AE%9A-http_proxy-%E6%97%A0%E6%95%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>碰到网络问题，无法 pull 镜像，命令行指定 <code class="language-text">http_proxy</code> 无效？</h3>\n<p>答：在 Docker 配置文件中添加 <code class="language-text">export http_proxy=&quot;http://&lt;PROXY_HOST&gt;:&lt;PROXY_PORT&gt;&quot;</code>，之后重启 Docker 服务即可。</p>\n<h2 id="容器相关"><a href="#%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器相关</h2>\n<h3 id="容器退出后，通过-docker-container-ls-命令查看不到，数据会丢失么？"><a href="#%E5%AE%B9%E5%99%A8%E9%80%80%E5%87%BA%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87-docker-container-ls-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%B8%A2%E5%A4%B1%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器退出后，通过 <code class="language-text">docker container ls</code> 命令查看不到，数据会丢失么？</h3>\n<p>答：容器退出后会处于终止（exited）状态，此时可以通过 <code class="language-text">docker container ls -a</code> 查看。其中的数据也不会丢失，还可以通过 docker start 命令来启动它。只有删除掉容器才会清除所有数据。</p>\n<h3 id="如何停止所有正在运行的容器？"><a href="#%E5%A6%82%E4%BD%95%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何停止所有正在运行的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker stop $(docker container ls -q)</code> 命令。</p>\n<h3 id="如何批量清理已经停止的容器？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E5%B7%B2%E7%BB%8F%E5%81%9C%E6%AD%A2%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理已经停止的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker container prune</code> 命令。</p>\n<h3 id="如何获取某个容器的-pid-信息？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-pid-%E4%BF%A1%E6%81%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 PID 信息？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14434079571641311000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .State.Pid }}\' <CONTAINER ID or NAME>`, `14434079571641311000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .State.Pid }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取某个容器的-ip-地址？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-ip-%E5%9C%B0%E5%9D%80%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 IP 地址？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41016845440470690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .NetworkSettings.IPAddress }}\' <CONTAINER ID or NAME>`, `41016845440470690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .NetworkSettings.IPAddress }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何给容器指定一个固定-ip-地址，而不是每次重启容器-ip-地址都会变？"><a href="#%E5%A6%82%E4%BD%95%E7%BB%99%E5%AE%B9%E5%99%A8%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%9B%BA%E5%AE%9A-ip-%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%AF%8F%E6%AC%A1%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8-ip-%E5%9C%B0%E5%9D%80%E9%83%BD%E4%BC%9A%E5%8F%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？</h3>\n<p>答：使用以下命令启动容器可以使容器 IP 固定不变</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46264695518201670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge --subnet 172.25.0.0/16 my-net\n\n\\$ docker run --network=my-net --ip=172.25.3.3 -itd --name=my-container busybox`, `46264695518201670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge --subnet <span class="token number">172.25</span>.0.0/16 my-net\n\n$ docker run --network<span class="token operator">=</span>my-net --ip<span class="token operator">=</span><span class="token number">172.25</span>.3.3 -itd --name<span class="token operator">=</span>my-container busybox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="如何临时退出一个正在交互的容器的终端，而不终止它？"><a href="#%E5%A6%82%E4%BD%95%E4%B8%B4%E6%97%B6%E9%80%80%E5%87%BA%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E4%BA%A4%E4%BA%92%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BB%88%E7%AB%AF%EF%BC%8C%E8%80%8C%E4%B8%8D%E7%BB%88%E6%AD%A2%E5%AE%83%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何临时退出一个正在交互的容器的终端，而不终止它？</h3>\n<p>答：按 <code class="language-text">Ctrl-p</code> <code class="language-text">Ctrl-q</code>。如果按 <code class="language-text">Ctrl-c</code> 往往会让容器内应用进程终止，进而会终止容器。</p>\n<h3 id="使用-docker-port-命令映射容器的端口时，系统报错-error-no-public-port-80-published-for-xxx？"><a href="#%E4%BD%BF%E7%94%A8-docker-port-%E5%91%BD%E4%BB%A4%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%97%B6%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%8A%A5%E9%94%99-error-no-public-port-80-published-for-xxx%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 docker port 命令映射容器的端口时，系统报错 “Error: No public port ‘80’ published for xxx”？</h3>\n<ul>\n<li>\n<p>创建镜像时 Dockerfile 要通过 EXPOSE 指定正确的开放端口；</p>\n</li>\n<li>\n<p>容器启动时指定 <code class="language-text">PublishAllPort = true</code>。</p>\n</li>\n</ul>\n<h3 id="可以在一个容器中同时运行多个应用进程么？"><a href="#%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%90%8C%E6%97%B6%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可以在一个容器中同时运行多个应用进程么？</h3>\n<p>答：一般并不推荐在同一个容器内运行多个应用进程。如果有类似需求，可以通过一些额外的进程管理机制，比如 supervisord 来管理所运行的进程。可以参考 <a href="https://docs.docker.com/config/containers/multi-service_container/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/config/containers/multi-service_container/</a> 。</p>\n<h3 id="如何控制容器占用系统资源（cpu、内存）的份额？"><a href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%AE%B9%E5%99%A8%E5%8D%A0%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%88cpu%E3%80%81%E5%86%85%E5%AD%98%EF%BC%89%E7%9A%84%E4%BB%BD%E9%A2%9D%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何控制容器占用系统资源（CPU、内存）的份额？</h3>\n<p>答：在使用 <code class="language-text">docker create</code> 命令创建容器或使用 <code class="language-text">docker run</code> 创建并启动容器的时候，可以使用 <code class="language-text">-c|--cpu-shares[=0]</code> 参数来调整容器使用 CPU 的权重；使用 <code class="language-text">-m|--memory[=MEMORY]</code> 参数来调整容器使用内存的大小。</p>\n<h2 id="仓库相关"><a href="#%E4%BB%93%E5%BA%93%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库相关</h2>\n<h3 id="仓库（repository）、注册服务器（registry）、注册索引（index）有何关系？"><a href="#%E4%BB%93%E5%BA%93%EF%BC%88repository%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88registry%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E7%B4%A2%E5%BC%95%EF%BC%88index%EF%BC%89%E6%9C%89%E4%BD%95%E5%85%B3%E7%B3%BB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库（Repository）、注册服务器（Registry）、注册索引（Index）有何关系？</h3>\n<p>首先，仓库是存放一组关联镜像的集合，比如同一个应用的不同版本的镜像。</p>\n<p>注册服务器是存放实际的镜像文件的地方。注册索引则负责维护用户的账号、权限、搜索、标签等的管理。因此，注册服务器利用注册索引来实现认证等管理。</p>\n<h2 id="配置相关"><a href="#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置相关</h2>\n<h3 id="docker-的配置文件放在哪里，如何修改配置？"><a href="#docker-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 的配置文件放在哪里，如何修改配置？</h3>\n<p>答：使用 systemd 的系统（如 <code class="language-text">Ubuntu 16.04</code>、Centos 等）的配置文件在 <code class="language-text">/etc/docker/daemon.json</code>。</p>\n<h3 id="如何更改-docker-的默认存储位置？"><a href="#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%94%B9-docker-%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何更改 Docker 的默认存储位置？</h3>\n<p>答：Docker 的默认存储位置是 <code class="language-text">/var/lib/docker</code>，如果希望将 Docker 的本地文件存储到其他分区，可以使用 Linux 软连接的方式来完成，或者在启动 daemon 时通过 <code class="language-text">-g</code> 参数指定，或者修改配置文件 <code class="language-text">/etc/docker/daemon.json</code> 的 “data-root” 项 。可以使用 <code class="language-text">docker system info | grep &quot;Root Dir&quot;</code> 查看当前使用的存储位置。</p>\n<p>例如，如下操作将默认存储位置迁移到 <code class="language-text">/storage/docker</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88715137346037830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[root@s26 ~]# df -h\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  5.3G   42G  12% /\ntmpfs                          48G  228K   48G   1% /dev/shm\n/dev/sda1                     485M   40M  420M   9% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   1% /home\n/dev/sdb2                     2.7T  323G  2.3T  13% /storage\n[root@s26 ~]# service docker stop\n[root@s26 ~]# cd /var/lib/\n[root@s26 lib]# mv docker /storage/\n[root@s26 lib]# ln -s /storage/docker/ docker\n[root@s26 lib]# ls -la docker\nlrwxrwxrwx. 1 root root 15 11月 17 13:43 docker -> /storage/docker\n[root@s26 lib]# service docker start`, `88715137346037830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  <span class="token number">5</span>.3G   42G  <span class="token number">12</span>% /\ntmpfs                          48G  228K   48G   <span class="token number">1</span>% /dev/shm\n/dev/sda1                     485M   40M  420M   <span class="token number">9</span>% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   <span class="token number">1</span>% /home\n/dev/sdb2                     <span class="token number">2</span>.7T  323G  <span class="token number">2</span>.3T  <span class="token number">13</span>% /storage\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># service docker stop</span>\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># mv docker /storage/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ln -s /storage/docker/ docker</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ls -la docker</span>\nlrwxrwxrwx. <span class="token number">1</span> root root <span class="token number">15</span> <span class="token number">11</span>月 <span class="token number">17</span> <span class="token number">13</span>:43 docker -<span class="token operator">></span> /storage/docker\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># service docker start</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用内存和-swap-限制启动容器时候报警告：warning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded？"><a href="#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E5%92%8C-swap-%E9%99%90%E5%88%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%97%B6%E5%80%99%E6%8A%A5%E8%AD%A6%E5%91%8A%EF%BC%9Awarning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用内存和 swap 限制启动容器时候报警告：“WARNING: Your kernel does not support cgroup swap limit. WARNING: Your kernel does not support swap limit capabilities. Limitation discarded.“？</h3>\n<p>答：这是因为系统默认没有开启对内存和 swap 使用的统计功能，引入该功能会带来性能的下降。要开启该功能，可以采取如下操作：</p>\n<ul>\n<li>编辑 <code class="language-text">/etc/default/grub</code> 文件（Ubuntu 系统为例），配置 <code class="language-text">GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</code></li>\n<li>更新 grub：<code class="language-text">$ sudo update-grub</code></li>\n<li>重启系统，即可。</li>\n</ul>\n<h2 id="docker-与虚拟化"><a href="#docker-%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与虚拟化</h2>\n<h3 id="docker-与-lxc（linux-container）有何不同？"><a href="#docker-%E4%B8%8E-lxc%EF%BC%88linux-container%EF%BC%89%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 LXC（Linux Container）有何不同？</h3>\n<p>答：LXC 利用 Linux 上相关技术实现了容器。Docker 则在如下的几个方面进行了改进：</p>\n<ul>\n<li>移植性：通过抽象容器配置，容器可以实现从一个平台移植到另一个平台；</li>\n<li>镜像系统：基于 OverlayFS 的镜像系统为容器的分发带来了很多的便利，同时共同的镜像层只需要存储一份，实现高效率的存储；</li>\n<li>版本管理：类似于 Git 的版本管理理念，用户可以更方便的创建、管理镜像文件；</li>\n<li>仓库系统：仓库系统大大降低了镜像的分发和管理的成本；</li>\n<li>周边工具：各种现有工具（配置管理、云平台）对 Docker 的支持，以及基于 Docker 的 PaaS、CI 等系统，让 Docker 的应用更加方便和多样化。</li>\n</ul>\n<h3 id="docker-与-vagrant-有何不同？"><a href="#docker-%E4%B8%8E-vagrant-%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 Vagrant 有何不同？</h3>\n<p>答：两者的定位完全不同。</p>\n<ul>\n<li>Vagrant 类似 Boot2Docker（一款运行 Docker 的最小内核），是一套虚拟机的管理环境。Vagrant 可以在多种系统上和虚拟机软件中运行，可以在 Windows，Mac 等非 Linux 平台上为 Docker 提供支持，自身具有较好的包装性和移植性。</li>\n<li>原生的 Docker 自身只能运行在 Linux 平台上，但启动和运行的性能都比虚拟机要快，往往更适合快速开发和部署应用的场景。</li>\n</ul>\n<p>简单说：Vagrant 适合用来管理虚拟机，而 Docker 适合用来管理应用环境。</p>\n<h3 id="开发环境中-docker-和-vagrant-该如何选择？"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%AD-docker-%E5%92%8C-vagrant-%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境中 Docker 和 Vagrant 该如何选择？</h3>\n<p>答：Docker 不是虚拟机，而是进程隔离，对于资源的消耗很少，但是目前需要 Linux 环境支持。Vagrant 是虚拟机上做的封装，虚拟机本身会消耗资源。</p>\n<p>如果本地使用的 Linux 环境，推荐都使用 Docker。</p>\n<p>如果本地使用的是 macOS 或者 Windows 环境，那就需要开虚拟机，单一开发环境下 Vagrant 更简单；多环境开发下推荐在 Vagrant 里面再使用 Docker 进行环境隔离。</p>\n<h2 id="其它"><a href="#%E5%85%B6%E5%AE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它</h2>\n<h3 id="docker-能在非-linux-平台（比如-windows-或-macos-）上运行么？"><a href="#docker-%E8%83%BD%E5%9C%A8%E9%9D%9E-linux-%E5%B9%B3%E5%8F%B0%EF%BC%88%E6%AF%94%E5%A6%82-windows-%E6%88%96-macos-%EF%BC%89%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 能在非 Linux 平台（比如 Windows 或 macOS ）上运行么？</h3>\n<p>答：完全可以。</p>\n<h3 id="如何将一台宿主主机的-docker-环境迁移到另外一台宿主主机？"><a href="#%E5%A6%82%E4%BD%95%E5%B0%86%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84-docker-%E7%8E%AF%E5%A2%83%E8%BF%81%E7%A7%BB%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何将一台宿主主机的 Docker 环境迁移到另外一台宿主主机？</h3>\n<p>答：停止 Docker 服务。将整个 Docker 存储文件夹复制到另外一台宿主主机，然后调整另外一台宿主主机的配置即可。</p>\n<h3 id="如何进入-docker-容器的网络命名空间？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5-docker-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进入 Docker 容器的网络命名空间？</h3>\n<p>答：Docker 在创建容器后，删除了宿主主机上 <code class="language-text">/var/run/netns</code> 目录中的相关的网络命名空间文件。因此，在宿主主机上是无法看到或访问容器的网络命名空间的。</p>\n<p>用户可以通过如下方法来手动恢复它。</p>\n<p>首先，使用下面的命令查看容器进程信息，比如这里的 1234。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79998288947322750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format=\'{{. State.Pid}}\' \\$container_id\n1234`, `79998288947322750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format<span class="token operator">=</span><span class="token string">\'{{. State.Pid}}\'</span> <span class="token variable">$container_id</span>\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>接下来，在 <code class="language-text">/proc</code> 目录下，把对应的网络命名空间文件链接到 <code class="language-text">/var/run/netns</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35574384637574074000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ln -s /proc/1234/ns/net /var/run/netns/`, `35574384637574074000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/1234/ns/net /var/run/netns/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后，在宿主主机上就可以看到容器的网络命名空间信息。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18705247626139853000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns show\n1234`, `18705247626139853000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns show\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时，用户可以通过正常的系统命令来查看或操作容器的命名空间了。例如修改容器的 IP 地址信息为 <code class="language-text">172.17.0.100/16</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42046279153885370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns exec 1234 ifconfig eth0 172.17.0.100/16`, `42046279153885370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">1234</span> <span class="token function">ifconfig</span> eth0 <span class="token number">172.17</span>.0.100/16</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取容器绑定到本地那个-veth-接口上？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%AE%B9%E5%99%A8%E7%BB%91%E5%AE%9A%E5%88%B0%E6%9C%AC%E5%9C%B0%E9%82%A3%E4%B8%AA-veth-%E6%8E%A5%E5%8F%A3%E4%B8%8A%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取容器绑定到本地那个 veth 接口上？</h3>\n<p>答：Docker 容器启动后，会通过 veth 接口对连接到本地网桥，veth 接口命名跟容器命名毫无关系，十分难以找到对应关系。</p>\n<p>最简单的一种方式是通过查看接口的索引号，在容器中执行 <code class="language-text">ip a</code> 命令，查看到本地接口最前面的接口索引号，如 205，将此值加上 1，即 206，然后在本地主机执行 <code class="language-text">ip a</code> 命令，查找接口索引号为 206 的接口，两者即为连接的 veth 接口对。</p>\n<h1 id="docker-命令"><a href="#docker-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 命令</h1>\n<p>Docker 命令有两大类，客户端命令和服务端命令。前者是主要的操作接口，后者用来启动 Docker Daemon。</p>\n<ul>\n<li>客户端命令：基本命令格式为 <code class="language-text">docker [OPTIONS] COMMAND [arg...]</code>；</li>\n<li>服务端命令：基本命令格式为 <code class="language-text">dockerd [OPTIONS]</code>。</li>\n</ul>\n<p>可以通过 <code class="language-text">man docker</code> 或 <code class="language-text">docker help</code> 来查看这些命令。</p>\n<h2 id="客户端命令docker"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令(docker)</h2>\n<h3 id="客户端命令选项"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令选项</h3>\n<ul>\n<li><code class="language-text">--config=&quot;&quot;</code>：指定客户端配置文件，默认为 <code class="language-text">~/.docker</code>；</li>\n<li><code class="language-text">-D=true|false</code>：是否使用 debug 模式。默认不开启；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker 守护进程的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker 守护进程启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否。</li>\n</ul>\n<h3 id="客户端命令"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令</h3>\n<p>可以通过 <code class="language-text">docker COMMAND --help</code> 来查看这些命令的具体用法。</p>\n<ul>\n<li>attach：依附到一个正在运行的容器中；</li>\n<li>build：从一个 Dockerfile 创建一个镜像；</li>\n<li>commit：从一个容器的修改中创建一个新的镜像；</li>\n<li>cp：在容器和本地宿主系统之间复制文件中；</li>\n<li>create：创建一个新容器，但并不运行它；</li>\n<li>diff：检查一个容器内文件系统的修改，包括修改和增加；</li>\n<li>events：从服务端获取实时的事件；</li>\n<li>exec：在运行的容器内执行命令；</li>\n<li>export：导出容器内容为一个 tar 包；</li>\n<li>history：显示一个镜像的历史信息；</li>\n<li>images：列出存在的镜像；</li>\n<li>import：导入一个文件（典型为 tar 包）路径或目录来创建一个本地镜像；</li>\n<li>info：显示一些相关的系统信息；</li>\n<li>inspect：显示一个容器的具体配置信息；</li>\n<li>kill：关闭一个运行中的容器 (包括进程和所有相关资源)；</li>\n<li>load：从一个 tar 包中加载一个镜像；</li>\n<li>login：注册或登录到一个 Docker 的仓库服务器；</li>\n<li>logout：从 Docker 的仓库服务器登出；</li>\n<li>logs：获取容器的 log 信息；</li>\n<li>network：管理 Docker 的网络，包括查看、创建、删除、挂载、卸载等；</li>\n<li>node：管理 swarm 集群中的节点，包括查看、更新、删除、提升/取消管理节点等；</li>\n<li>pause：暂停一个容器中的所有进程；</li>\n<li>port：查找一个 nat 到一个私有网口的公共口；</li>\n<li>ps：列出主机上的容器；</li>\n<li>pull：从一个 Docker 的仓库服务器下拉一个镜像或仓库；</li>\n<li>push：将一个镜像或者仓库推送到一个 Docker 的注册服务器；</li>\n<li>rename：重命名一个容器；</li>\n<li>restart：重启一个运行中的容器；</li>\n<li>rm：删除给定的若干个容器；</li>\n<li>rmi：删除给定的若干个镜像；</li>\n<li>run：创建一个新容器，并在其中运行给定命令；</li>\n<li>save：保存一个镜像为 tar 包文件；</li>\n<li>search：在 Docker index 中搜索一个镜像；</li>\n<li>service：管理 Docker 所启动的应用服务，包括创建、更新、删除等；</li>\n<li>start：启动一个容器；</li>\n<li>stats：输出（一个或多个）容器的资源使用统计信息；</li>\n<li>stop：终止一个运行中的容器；</li>\n<li>swarm：管理 Docker swarm 集群，包括创建、加入、退出、更新等；</li>\n<li>tag：为一个镜像打标签；</li>\n<li>top：查看一个容器中的正在运行的进程信息；</li>\n<li>unpause：将一个容器内所有的进程从暂停状态中恢复；</li>\n<li>update：更新指定的若干容器的配置信息；</li>\n<li>version：输出 Docker 的版本信息；</li>\n<li>volume：管理 Docker volume，包括查看、创建、删除等；</li>\n<li>wait：阻塞直到一个容器终止，然后输出它的退出符。</li>\n</ul>\n<h3 id="一张图总结-docker-的命令"><a href="#%E4%B8%80%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93-docker-%E7%9A%84%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一张图总结 Docker 的命令</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACh0lEQVQ4y5VUvW7UQBD2S/EKFLwALW9ARRdRICEh0VBRQQQtNUJEoUAhCaCg5EiU5Mzpcpf7sX3ntfd/7f2zGdvK5YBrGFmrsXe+mdlvvnWQITSdTPr90DlX/6cFK6+qqnXfe1/dmG/t37CgWrPVtjHGWiulVEoVRcEoI4RsAK88iIZQCBKcE4wZawCAT9EySRJKKQTACjGbwTjPM4zj8ej69EQoJaXIsrw3OBqMfkFxsAylQogNYGg1DEPWGqSnrUHNOI4IwdAFF5Kmc8Wyrv2/KwO+4xzACCGtNXyBFV67jEJwCLqtDNQUrakbA7/LAgzDAg6kLUu9illxFiTxbHw1TJLFxkmuT2HdIJvRRWBN0R2g61wbDXVuAa1DwzeTzw/Toy1Xom7DeysFac6c5/ll/4Jymuf49KwXxfN220Pz0Kl1lQpfLT49YN8eVWW+YgsKgEh8WRQAW1K5pCrLMcwWkEA1Qin4XReYSWMbLr2xivKSSWddADTAMNKcMO3hwbyhBWjuRsUZM7Yyl09n7++yvfuKXpNrdL5zcLXX01R28vTa+lxaJDRXxlnDOQdpNweuGkmbaDc7fsEvthVH/paNKjDWdEoEMaUpoiAlzgil8Txappmta+etrusUWjJOSMFTTKYLFiFXmgDmN52NkngOzUfRbLGYDwahEBKKLrN8ME9kWVa1B2HqssSUoOFs8vVsfnRpuAqgveEUHf4cf79IfvSj/eNhOF5UNxcQGMGYAKFKpE7TopB+7fI1ozrojZ9v7z57e/jk9f7jlx8/HAzWbl8Tyk+2Ru/upDv3vIqa795BdqPLAJTrnW0iCpdSo90ff4LWqR0+N7NdE39xpugKg7yUJL8BbOM6W57Sp9wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 20 14 15 18" title="" data-src="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png" data-srcset="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-a67b7.png 200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-0b187.png 400w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png 800w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-b1a91.png 1200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png 1600w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="服务端命令dockerd"><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%91%BD%E4%BB%A4dockerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务端命令(dockerd)</h2>\n<h3 id="dockerd-命令选项"><a href="#dockerd-%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerd 命令选项</h3>\n<ul>\n<li><code class="language-text">--api-cors-header=&quot;&quot;</code>：CORS 头部域，默认不允许 CORS，要允许任意的跨域访问，可以指定为 ”*“；</li>\n<li><code class="language-text">--authorization-plugin=&quot;&quot;</code>：载入认证的插件；</li>\n<li><code class="language-text">-b=&quot;&quot;</code>：将容器挂载到一个已存在的网桥上。指定为 none 时则禁用容器的网络，与 <code class="language-text">--bip</code> 选项互斥；</li>\n<li><code class="language-text">--bip=&quot;&quot;</code>：让动态创建的 docker0 网桥采用给定的 CIDR 地址; 与 <code class="language-text">-b</code> 选项互斥；</li>\n<li><code class="language-text">--cgroup-parent=&quot;&quot;</code>：指定 cgroup 的父组，默认 fs cgroup 驱动为 <code class="language-text">/docker</code>，systemd cgroup 驱动为 <code class="language-text">system.slice</code>；</li>\n<li><code class="language-text">--cluster-store=&quot;&quot;</code>：构成集群（如 Swarm）时，集群键值数据库服务地址；</li>\n<li><code class="language-text">--cluster-advertise=&quot;&quot;</code>：构成集群时，自身的被访问地址，可以为 <code class="language-text">host:port</code> 或 <code class="language-text">interface:port</code>；</li>\n<li><code class="language-text">--cluster-store-opt=&quot;&quot;</code>：构成集群时，键值数据库的配置选项；</li>\n<li><code class="language-text">--config-file=&quot;/etc/docker/daemon.json&quot;</code>：daemon 配置文件路径；</li>\n<li><code class="language-text">--containerd=&quot;&quot;</code>：containerd 文件的路径；</li>\n<li><code class="language-text">-D, --debug=true|false</code>：是否使用 Debug 模式。缺省为 false；</li>\n<li><code class="language-text">--default-gateway=&quot;&quot;</code>：容器的 IPv4 网关地址，必须在网桥的子网段内；</li>\n<li><code class="language-text">--default-gateway-v6=&quot;&quot;</code>：容器的 IPv6 网关地址；</li>\n<li><code class="language-text">--default-ulimit=[]</code>：默认的 ulimit 值；</li>\n<li><code class="language-text">--disable-legacy-registry=true|false</code>：是否允许访问旧版本的镜像仓库服务器；</li>\n<li><code class="language-text">--dns=&quot;&quot;</code>：指定容器使用的 DNS 服务器地址；</li>\n<li><code class="language-text">--dns-opt=&quot;&quot;</code>：DNS 选项；</li>\n<li><code class="language-text">--dns-search=[]</code>：DNS 搜索域；</li>\n<li><code class="language-text">--exec-opt=[]</code>：运行时的执行选项；</li>\n<li><code class="language-text">--exec-root=&quot;&quot;</code>：容器执行状态文件的根路径，默认为 <code class="language-text">/var/run/docker</code>；</li>\n<li><code class="language-text">--fixed-cidr=&quot;&quot;</code>：限定分配 IPv4 地址范围；</li>\n<li><code class="language-text">--fixed-cidr-v6=&quot;&quot;</code>：限定分配 IPv6 地址范围；</li>\n<li><code class="language-text">-G, --group=&quot;&quot;</code>：分配给 unix 套接字的组，默认为 docker；</li>\n<li><code class="language-text">-g, --graph=&quot;&quot;</code>：Docker 运行时的根路径，默认为 <code class="language-text">/var/lib/docker</code>；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker daemon 的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">--icc=true|false</code>：是否启用容器间以及跟 daemon 所在主机的通信。默认为 true。</li>\n<li><code class="language-text">--insecure-registry=[]</code>：允许访问给定的非安全仓库服务；</li>\n<li><code class="language-text">--ip=&quot;&quot;</code>：绑定容器端口时候的默认 IP 地址。缺省为 0.0.0.0；</li>\n<li><code class="language-text">--ip-forward=true|false</code>：是否检查启动在 Docker 主机上的启用 IP 转发服务，默认开启。注意关闭该选项将不对系统转发能力进行任何检查修改；</li>\n<li><code class="language-text">--ip-masq=true|false</code>：是否进行地址伪装，用于容器访问外部网络，默认开启；</li>\n<li><code class="language-text">--iptables=true|false</code>：是否允许 Docker 添加 iptables 规则。缺省为 true；</li>\n<li><code class="language-text">--ipv6=true|false</code>：是否启用 IPv6 支持，默认关闭；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--label=&quot;[]&quot;</code>：添加指定的键值对标注；</li>\n<li><code class="language-text">--log-driver=&quot;json-file|syslog|journald|gelf|fluentd|awslogs|splunk|etwlogs|gcplogs|none&quot;</code>：指定日志后端驱动，默认为 <code class="language-text">json-file</code>；</li>\n<li><code class="language-text">--log-opt=[]</code>：日志后端的选项；</li>\n<li><code class="language-text">--mtu=VALUE</code>：指定容器网络的 mtu；</li>\n<li><code class="language-text">-p=&quot;&quot;</code>：指定 daemon 的 PID 文件路径。缺省为 <code class="language-text">/var/run/docker.pid</code>；</li>\n<li><code class="language-text">--raw-logs</code>：输出原始，未加色彩的日志信息；</li>\n<li><code class="language-text">--registry-mirror=&lt;scheme&gt;://&lt;host&gt;</code>：指定 docker pull 时使用的注册服务器镜像地址；</li>\n<li><code class="language-text">-s, --storage-driver=&quot;&quot;</code>：指定使用给定的存储后端；</li>\n<li><code class="language-text">--selinux-enabled=true|false</code>：是否启用 SELinux 支持。缺省值为 false。SELinux 目前尚不支持 overlay 存储驱动；</li>\n<li><code class="language-text">--storage-opt=[]</code>：驱动后端选项；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker daemon 启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否；</li>\n<li><code class="language-text">--userland-proxy=true|false</code>：是否使用用户态代理来实现容器间和出容器的回环通信，默认为 true；</li>\n<li><code class="language-text">--userns-remap=default|uid:gid|user:group|user|uid</code>：指定容器的用户命名空间，默认是创建新的 UID 和 GID 映射到容器内进程。</li>\n</ul>\n<h1 id="dockerfile-最佳实践"><a href="#dockerfile-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 最佳实践</h1>\n<h2 id="一般性的指南和建议"><a href="#%E4%B8%80%E8%88%AC%E6%80%A7%E7%9A%84%E6%8C%87%E5%8D%97%E5%92%8C%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一般性的指南和建议</h2>\n<h3 id="容器应该是短暂的"><a href="#%E5%AE%B9%E5%99%A8%E5%BA%94%E8%AF%A5%E6%98%AF%E7%9F%AD%E6%9A%82%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器应该是短暂的</h3>\n<p>通过 Dockerfile 构建的镜像所启动的容器应该尽可能短暂（生命周期短）。「短暂」意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。</p>\n<h3 id="使用-dockerignore-文件"><a href="#%E4%BD%BF%E7%94%A8-dockerignore-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 .dockerignore 文件</h3>\n<p>使用 Dockerfile 构建镜像时最好是将 Dockerfile 放置在一个新建的空目录下。然后将构建镜像所需要的文件添加到该目录中。为了提高构建镜像的效率，你可以在目录下新建一个 .dockerignore 文件来指定要忽略的文件和目录。.dockerignore 文件的排除模式语法和 Git 的 .gitignore 文件相似。</p>\n<h3 id="使用多阶段构建-1"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>在 Docker 17.05 以上版本中，你可以使用多阶段构建来减少所构建镜像的大小。</p>\n<h3 id="避免安装不必要的包"><a href="#%E9%81%BF%E5%85%8D%E5%AE%89%E8%A3%85%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免安装不必要的包</h3>\n<p>为了降低复杂性、减少依赖、减小文件大小、节约构建时间，你应该避免安装任何不必要的包。例如，不要在数据库镜像中包含一个文本编辑器。</p>\n<h3 id="一个容器只运行一个进程"><a href="#%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%8F%AA%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个容器只运行一个进程</h3>\n<p>应该保证在一个容器中只运行一个进程。将多个应用解耦到不同容器中，保证了容器的横向扩展和复用。例如 web 应用应该包含三个容器：web 应用、数据库、缓存。</p>\n<p>如果容器互相依赖，你可以使用 Docker 自定义网络来把这些容器连接起来。</p>\n<h3 id="镜像层数尽可能少"><a href="#%E9%95%9C%E5%83%8F%E5%B1%82%E6%95%B0%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%B0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像层数尽可能少</h3>\n<p>你需要在 Dockerfile 可读性（也包括长期的可维护性）和减少层数之间做一个平衡。</p>\n<h3 id="将多行参数排序"><a href="#%E5%B0%86%E5%A4%9A%E8%A1%8C%E5%8F%82%E6%95%B0%E6%8E%92%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>将多行参数排序</h3>\n<p>将多行参数按字母顺序排序（比如要安装多个包时）。这可以帮助你避免重复包含同一个包，更新包列表时也更容易。也便于 PRs 阅读和审查。建议在反斜杠符号 <code class="language-text">\\</code> 之前添加一个空格，以增加可读性。</p>\n<p>下面是来自 <code class="language-text">buildpack-deps</code> 镜像的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50771579236086596000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion`, `50771579236086596000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建缓存"><a href="#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建缓存</h3>\n<p>在镜像的构建过程中，Docker 会遍历 Dockerfile 文件中的指令，然后按顺序执行。在执行每条指令之前，Docker 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 docker build 命令中使用 <code class="language-text">--no-cache=true</code> 选项。</p>\n<p>但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p>\n<ul>\n<li>从一个基础镜像开始（FROM 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li>\n<li>在大多数情况下，只需要简单地对比 Dockerfile 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li>\n<li>对于 ADD 和 COPY 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li>\n<li>除了 ADD 和 COPY 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code class="language-text">RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li>\n</ul>\n<p>一旦缓存失效，所有后续的 Dockerfile 指令都将产生新的镜像，缓存不会被使用。</p>\n<h2 id="dockerfile-指令"><a href="#dockerfile-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 指令</h2>\n<p>下面针对 Dockerfile 中各种指令的最佳编写方式给出建议。</p>\n<h3 id="from"><a href="#from" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM</h3>\n<p>尽可能使用当前官方仓库作为你构建镜像的基础。推荐使用 Alpine 镜像，因为它被严格控制并保持最小尺寸（目前小于 5 MB），但它仍然是一个完整的发行版。</p>\n<h3 id="label"><a href="#label" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL</h3>\n<p>你可以给镜像添加标签来帮助组织镜像、记录许可信息、辅助自动化构建等。每个标签一行，由 LABEL 开头加上一个或多个标签对。下面的示例展示了各种不同的可能格式。<code class="language-text">#</code> 开头的行是注释内容。</p>\n<p>注意：如果你的字符串中包含空格，必须将字符串放入引号中或者对空格使用转义。如果字符串内容本身就包含引号，必须对引号使用转义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="281835265949048600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set one or more individual labels\nLABEL com.example.version=&quot;0.0.1-beta&quot;\n\nLABEL vendor=&quot;ACME Incorporated&quot;\n\nLABEL com.example.release-date=&quot;2015-02-12&quot;\n\nLABEL com.example.version.is-production=&quot;&quot;`, `281835265949048600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set one or more individual labels</span>\n<span class="token keyword">LABEL</span> com.example.version=<span class="token string">"0.0.1-beta"</span>\n\n<span class="token keyword">LABEL</span> vendor=<span class="token string">"ACME Incorporated"</span>\n\n<span class="token keyword">LABEL</span> com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span>\n\n<span class="token keyword">LABEL</span> com.example.version.is<span class="token punctuation">-</span>production=<span class="token string">""</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个镜像可以包含多个标签，但建议将多个标签放入到一个 LABEL 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14190725729957431000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set multiple labels at once, using line-continuation characters to break long lines\nLABEL vendor=ACME\\ Incorporated \\\n      com.example.is-beta= \\\n      com.example.is-production=&quot;&quot; \\\n      com.example.version=&quot;0.0.1-beta&quot; \\\n      com.example.release-date=&quot;2015-02-12&quot;`, `14190725729957431000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set multiple labels at once, using line-continuation characters to break long lines</span>\n<span class="token keyword">LABEL</span> vendor=ACME\\ Incorporated \\\n      com.example.is<span class="token punctuation">-</span>beta= \\\n      com.example.is<span class="token punctuation">-</span>production=<span class="token string">""</span> \\\n      com.example.version=<span class="token string">"0.0.1-beta"</span> \\\n      com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于标签可以接受的键值对，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Understanding object labels</a>。关于查询标签信息，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Managing labels on objects</a>。</p>\n<h3 id="run"><a href="#run" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN</h3>\n<p>为了保持 Dockerfile 文件的可读性，可理解性，以及可维护性，建议将长的或复杂的 RUN 指令用反斜杠 <code class="language-text">\\</code> 分割成多行。</p>\n<h4 id="apt-get"><a href="#apt-get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>apt-get</h4>\n<p>RUN 指令最常见的用法是安装包用的 apt-get。因为 <code class="language-text">RUN apt-get</code> 指令会安装包，所以有几个问题需要注意。</p>\n<p>不要使用 <code class="language-text">RUN apt-get upgrade</code> 或 <code class="language-text">dist-upgrade</code>，因为许多基础镜像中的「必须」包不会在一个非特权容器中升级。如果基础镜像中的某个包过时了，你应该联系它的维护者。如果你确定某个特定的包，比如 foo，需要升级，使用 <code class="language-text">apt-get install -y foo</code> 就行，该指令会自动升级 foo 包。</p>\n<p>永远将 <code class="language-text">RUN apt-get update</code> 和 <code class="language-text">apt-get install</code> 组合成一条 RUN 声明，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20941355361094940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n        package-bar \\\n        package-baz \\\n        package-foo`, `20941355361094940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n        package<span class="token punctuation">-</span>bar \\\n        package<span class="token punctuation">-</span>baz \\\n        package<span class="token punctuation">-</span>foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将 <code class="language-text">apt-get update</code> 放在一条单独的 RUN 声明中会导致缓存问题以及后续的 <code class="language-text">apt-get install</code> 失败。比如，假设你有一个 Dockerfile 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87861369011847120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl`, `87861369011847120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后，所有的层都在 Docker 的缓存中。假设你后来又修改了其中的 <code class="language-text">apt-get install</code> 添加了一个包：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77387644793021150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl nginx`, `77387644793021150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Docker 发现修改后的 <code class="language-text">RUN apt-get update</code> 指令和之前的完全一样。所以，<code class="language-text">apt-get update</code> 不会执行，而是使用之前的缓存镜像。因为 <code class="language-text">apt-get update</code> 没有运行，后面的 <code class="language-text">apt-get install</code> 可能安装的是过时的 curl 和 nginx 版本。</p>\n<p>使用 <code class="language-text">RUN apt-get update &amp;&amp; apt-get install -y</code> 可以确保你的 Dockerfiles 每次安装的都是包的最新的版本，而且这个过程不需要进一步的编码或额外干预。这项技术叫作 <code class="language-text">cache busting</code>。你也可以显示指定一个包的版本号来达到 <code class="language-text">cache-busting</code>，这就是所谓的固定版本，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26316763342286877000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    package-bar \\\n    package-baz \\\n    package-foo=1.3.*`, `26316763342286877000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    package<span class="token punctuation">-</span>bar \\\n    package<span class="token punctuation">-</span>baz \\\n    package<span class="token punctuation">-</span>foo=1.3.*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>固定版本会迫使构建过程检索特定的版本，而不管缓存中有什么。这项技术也可以减少因所需包中未预料到的变化而导致的失败。</p>\n<p>下面是一个 RUN 指令的示例模板，展示了所有关于 apt-get 的建议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76914718341092950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    aufs-tools \\\n    automake \\\n    build-essential \\\n    curl \\\n    dpkg-sig \\\n    libcap-dev \\\n    libsqlite3-dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1-dev \\\n    s3cmd=1.1.* \\\n && rm -rf /var/lib/apt/lists/*`, `76914718341092950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    aufs<span class="token punctuation">-</span>tools \\\n    automake \\\n    build<span class="token punctuation">-</span>essential \\\n    curl \\\n    dpkg<span class="token punctuation">-</span>sig \\\n    libcap<span class="token punctuation">-</span>dev \\\n    libsqlite3<span class="token punctuation">-</span>dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1<span class="token punctuation">-</span>dev \\\n    s3cmd=1.1.* \\\n &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 s3cmd 指令指定了一个版本号 <code class="language-text">1.1.*</code>。如果之前的镜像使用的是更旧的版本，指定新的版本会导致 <code class="language-text">apt-get udpate</code> 缓存失效并确保安装的是新版本。</p>\n<p>另外，清理掉 apt 缓存 <code class="language-text">var/lib/apt/lists</code> 可以减小镜像大小。因为 RUN 指令的开头为 <code class="language-text">apt-get udpate</code>，包缓存总是会在 <code class="language-text">apt-get install</code> 之前刷新。</p>\n<blockquote>\n<p>注意：官方的 Debian 和 Ubuntu 镜像会自动运行 <code class="language-text">apt-get clean</code>，所以不需要显式的调用 <code class="language-text">apt-get clean</code>。</p>\n</blockquote>\n<h3 id="cmd"><a href="#cmd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD</h3>\n<p>CMD 指令用于执行目标镜像中包含的软件，可以包含参数。CMD 大多数情况下都应该以 <code class="language-text">CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;...]</code> 的形式使用。因此，如果创建镜像的目的是为了部署某个服务(比如 Apache)，你可能会执行类似于 <code class="language-text">CMD [&quot;apache2&quot;, &quot;-DFOREGROUND&quot;]</code> 形式的命令。我们建议任何服务镜像都使用这种形式的命令。</p>\n<p>多数情况下，CMD 都需要一个交互式的 shell (bash, Python, perl 等)，例如 <code class="language-text">CMD [&quot;perl&quot;, &quot;-de0&quot;]</code>，或者 <code class="language-text">CMD [&quot;PHP&quot;, &quot;-a&quot;]</code>。使用这种形式意味着，当你执行类似 <code class="language-text">docker run -it python</code> 时，你会进入一个准备好的 shell 中。CMD 应该在极少的情况下才能以 <code class="language-text">CMD [&quot;param&quot;, &quot;param&quot;]</code> 的形式与 ENTRYPOINT 协同使用，除非你和你的镜像使用者都对 ENTRYPOINT 的工作方式十分熟悉。</p>\n<h3 id="expose"><a href="#expose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE</h3>\n<p>EXPOSE 指令用于指定容器将要监听的端口。因此，你应该为你的应用程序使用常见的端口。例如，提供 <code class="language-text">Apache web</code> 服务的镜像应该使用 <code class="language-text">EXPOSE 80</code>，而提供 MongoDB 服务的镜像使用 <code class="language-text">EXPOSE 27017</code>。</p>\n<p>对于外部访问，用户可以在执行 <code class="language-text">docker run</code> 时使用一个标志来指示如何将指定的端口映射到所选择的端口。</p>\n<h3 id="env"><a href="#env" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV</h3>\n<p>为了方便新程序运行，你可以使用 ENV 来为容器中安装的程序更新 PATH 环境变量。例如使用 <code class="language-text">ENV PATH /usr/local/nginx/bin:$PATH</code> 来确保 <code class="language-text">CMD [&quot;nginx&quot;]</code> 能正确运行。</p>\n<p>ENV 指令也可用于为你想要容器化的服务提供必要的环境变量，比如 Postgres 需要的 PGDATA。</p>\n<p>最后，ENV 也能用于设置常见的版本号，比如下面的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12704704461093997000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV PG_MAJOR 9.3\n\nENV PG_VERSION 9.3.4\n\nRUN curl -SL http://example.com/postgres-\\$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress && …\n\nENV PATH /usr/local/postgres-\\$PG_MAJOR/bin:\\$PATH`, `12704704461093997000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> PG_MAJOR 9.3\n\n<span class="token keyword">ENV</span> PG_VERSION 9.3.4\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/postgres<span class="token punctuation">-</span>$PG_VERSION.tar.xz <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/postgress &amp;&amp; …\n\n<span class="token keyword">ENV</span> PATH /usr/local/postgres<span class="token punctuation">-</span>$PG_MAJOR/bin<span class="token punctuation">:</span>$PATH</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似于程序中的常量，这种方法可以让你只需改变 ENV 指令来自动的改变容器中的软件版本。</p>\n<h3 id="add-和-copy"><a href="#add-%E5%92%8C-copy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 和 COPY</h3>\n<p>虽然 ADD 和 COPY 功能类似，但一般优先使用 COPY。因为它比 ADD 更透明。COPY 只支持简单将本地文件拷贝到容器中，而 ADD 有一些并不明显的功能（比如本地 tar 提取和远程 URL 支持）。因此，ADD 的最佳用例是将本地 tar 文件自动提取到镜像中，例如 <code class="language-text">ADD rootfs.tar.xz</code>。</p>\n<p>如果你的 Dockerfile 有多个步骤需要使用上下文中不同的文件。单独 COPY 每个文件，而不是一次性的 COPY 所有文件，这将保证每个步骤的构建缓存只在特定的文件变化时失效。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78639797224416740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY requirements.txt /tmp/\n\nRUN pip install --requirement /tmp/requirements.txt\n\nCOPY . /tmp/`, `78639797224416740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> requirements.txt /tmp/\n\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span><span class="token punctuation">-</span>requirement /tmp/requirements.txt\n\n<span class="token keyword">COPY</span> . /tmp/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果将 <code class="language-text">COPY . /tmp/</code> 放置在 RUN 指令之前，只要 <code class="language-text">.</code> 目录中任何一个文件变化，都会导致后续指令的缓存失效。</p>\n<p>为了让镜像尽量小，最好不要使用 ADD 指令从远程 URL 获取包，而是使用 curl 和 wget。这样你可以在文件提取完之后删掉不再需要的文件来避免在镜像中额外添加一层。比如尽量避免下面的用法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43203361742704160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD http://example.com/big.tar.xz /usr/src/things/\n\nRUN tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things\n\nRUN make -C /usr/src/things all`, `43203361742704160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> http<span class="token punctuation">:</span>//example.com/big.tar.xz /usr/src/things/\n\n<span class="token keyword">RUN</span> tar <span class="token punctuation">-</span>xJf /usr/src/things/big.tar.xz <span class="token punctuation">-</span>C /usr/src/things\n\n<span class="token keyword">RUN</span> make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而是应该使用下面这种方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3393368310406486000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN mkdir -p /usr/src/things \\\n    && curl -SL http://example.com/big.tar.xz \\\n    | tar -xJC /usr/src/things \\\n    && make -C /usr/src/things all`, `3393368310406486000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p /usr/src/things \\\n    &amp;&amp; curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/big.tar.xz \\\n    <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/things \\\n    &amp;&amp; make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面使用的管道操作，所以没有中间文件需要删除。</p>\n<p>对于其他不需要 ADD 的自动提取功能的文件或目录，你应该使用 COPY。</p>\n<h3 id="entrypoint"><a href="#entrypoint" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT</h3>\n<p>ENTRYPOINT 的最佳用处是设置镜像的主命令，允许将镜像当成命令本身来运行（用 CMD 提供默认选项）。</p>\n<p>例如，下面的示例镜像提供了命令行工具 s3cmd:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66219616708643850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENTRYPOINT [&quot;s3cmd&quot;]\n\nCMD [&quot;--help&quot;]`, `66219616708643850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"s3cmd"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"--help"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>现在直接运行该镜像创建的容器会显示命令帮助：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59653544000743070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd`, `59653544000743070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者提供正确的参数来执行某个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22306098294657774000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd ls s3://mybucket`, `22306098294657774000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd <span class="token function">ls</span> s3://mybucket</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样镜像名可以当成命令行的参考。</p>\n<p>ENTRYPOINT 指令也可以结合一个辅助脚本使用，和前面命令行风格类似，即使启动工具需要不止一个步骤。</p>\n<p>例如，Postgres 官方镜像使用下面的脚本作为 ENTRYPOINT：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93729545994350760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/bash\nset -e\n\nif [ &quot;\\$1&quot; = \'postgres\' ]; then\n    chown -R postgres &quot;\\$PGDATA&quot;\n\n    if [ -z &quot;\\$(ls -A &quot;\\$PGDATA&quot;)&quot; ]; then\n        gosu postgres initdb\n    fi\n\n    exec gosu postgres &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `93729545994350760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>\n<span class="token builtin class-name">set</span> -e\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'postgres\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token function">chown</span> -R postgres <span class="token string">"<span class="token variable">$PGDATA</span>"</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -A <span class="token string">"<span class="token variable">$PGDATA</span>"</span><span class="token variable">)</span></span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        gosu postgres initdb\n    <span class="token keyword">fi</span>\n\n    <span class="token builtin class-name">exec</span> gosu postgres <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：该脚本使用了 Bash 的内置命令 exec，所以最后运行的进程就是容器的 PID 为 1 的进程。这样，进程就可以接收到任何发送给容器的 Unix 信号了。</p>\n</blockquote>\n<p>该辅助脚本被拷贝到容器，并在容器启动时通过 ENTRYPOINT 执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70424008309656690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./docker-entrypoint.sh /\n\nENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]`, `70424008309656690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> ./docker<span class="token punctuation">-</span>entrypoint.sh /\n\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"/docker-entrypoint.sh"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>该脚本可以让用户用几种不同的方式和 Postgres 交互。</p>\n<p>你可以很简单地启动 Postgres：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40732367351895270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres`, `40732367351895270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也可以执行 Postgres 并传递参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8036033847614754000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres postgres --help`, `8036033847614754000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres postgres --help</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后，你还可以启动另外一个完全不同的工具，比如 Bash：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66418218346094715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it postgres bash`, `66418218346094715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it postgres <span class="token function">bash</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="volume"><a href="#volume" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME</h3>\n<p>VOLUME 指令用于暴露任何数据库存储文件，配置文件，或容器创建的文件和目录。强烈建议使用 VOLUME 来管理镜像中的可变部分和用户可以改变的部分。</p>\n<h3 id="user"><a href="#user" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER</h3>\n<p>如果某个服务不需要特权执行，建议使用 USER 指令切换到非 root 用户。先在 Dockerfile 中使用类似 <code class="language-text">RUN groupadd -r postgres &amp;&amp; useradd -r -g postgres postgres</code> 的指令创建用户和用户组。</p>\n<blockquote>\n<p>注意：在镜像中，用户和用户组每次被分配的 <code class="language-text">UID/GID</code> 都是不确定的，下次重新构建镜像时被分配到的 <code class="language-text">UID/GID</code> 可能会不一样。如果要依赖确定的 <code class="language-text">UID/GID</code>，你应该显式的指定一个 <code class="language-text">UID/GID</code>。</p>\n</blockquote>\n<p>你应该避免使用 sudo，因为它不可预期的 TTY 和信号转发行为可能造成的问题比它能解决的问题还多。如果你真的需要和 sudo 类似的功能（例如，以 root 权限初始化某个守护进程，以非 root 权限执行它），你可以使用 <a href="https://github.com/tianon/gosu" target="_blank" rel="nofollow noreferrer noopener">gosu</a>。</p>\n<p>最后，为了减少层数和复杂度，避免频繁地使用 USER 来回切换用户。</p>\n<h3 id="workdir"><a href="#workdir" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR</h3>\n<p>为了清晰性和可靠性，你应该总是在 WORKDIR 中使用绝对路径。另外，你应该使用 WORKDIR 来替代类似于 <code class="language-text">RUN cd ... &amp;&amp; do-something</code> 的指令，后者难以阅读、排错和维护。</p>\n<h2 id="官方镜像示例"><a href="#%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方镜像示例</h2>\n<p>这些官方镜像的 Dockerfile 都是参考典范：<a href="https://github.com/docker-library/docs" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-library/docs</a></p>\n<h1 id="如何调试-docker"><a href="#%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何调试 Docker</h1>\n<h2 id="开启-debug-模式"><a href="#%E5%BC%80%E5%90%AF-debug-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开启 Debug 模式</h2>\n<p>在 dockerd 配置文件 <code class="language-text">daemon.json</code>（默认位于 <code class="language-text">/etc/docker/</code>）中添加</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95697130180585230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;debug&quot;: true\n}`, `95697130180585230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>重启守护进程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33020829237393314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGHUP \\$(pidof dockerd)`, `33020829237393314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGHUP <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时 dockerd 会在日志中输入更多信息供分析。</p>\n<h2 id="检查内核日志"><a href="#%E6%A3%80%E6%9F%A5%E5%86%85%E6%A0%B8%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检查内核日志</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24851559335415517000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo dmesg | grep dockerd\n\\$ sudo dmesg | grep runc`, `24851559335415517000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> dockerd\n$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> runc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="docker-不响应时处理"><a href="#docker-%E4%B8%8D%E5%93%8D%E5%BA%94%E6%97%B6%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 不响应时处理</h2>\n<p>可以杀死 dockerd 进程查看其堆栈调用情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28074683379290600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGUSR1 \\$(pidof dockerd)`, `28074683379290600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGUSR1 <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="重置-docker-本地数据"><a href="#%E9%87%8D%E7%BD%AE-docker-%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置 Docker 本地数据</h2>\n<p>注意，本操作会移除所有的 Docker 本地数据，包括镜像和容器等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98117388211847560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo rm -rf /var/lib/docker`, `98117388211847560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="compose"><a href="#compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose</h1>\n<p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 OpenStack 中的 Heat 十分类似。</p>\n<p>其代码目前在 <a href="https://github.com/docker/compose" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker/compose</a> 上开源。</p>\n<p>Compose 定位是「定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>\n<p>通过第一部分中的介绍，我们知道使用一个 Dockerfile 模板文件，可以让用户很方便的定义一个单独的应用容器。然而，在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>\n<p>Compose 恰好满足了这样的需求。它允许用户通过一个单独的 <code class="language-text">docker-compose.yml</code> 模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>\n<p>Compose 中有两个重要的概念：</p>\n<ul>\n<li>服务 (service)：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li>\n<li>项目 (project)：由一组关联的应用容器组成的一个完整业务单元，在 <code class="language-text">docker-compose.yml</code> 文件中定义。</li>\n</ul>\n<p>Compose 的默认管理对象是项目，通过子命令对项目中的一组容器进行便捷地生命周期管理。</p>\n<p>Compose 项目由 Python 编写，实现上调用了 Docker 服务提供的 API 来对容器进行管理。因此，只要所操作的平台支持 Docker API，就可以在其上利用 Compose 来进行编排管理。</p>\n<h2 id="使用-2"><a href="#%E4%BD%BF%E7%94%A8-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<h3 id="术语"><a href="#%E6%9C%AF%E8%AF%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>术语</h3>\n<p>首先介绍几个术语。</p>\n<ul>\n<li>服务(service)：一个应用容器，实际上可以运行多个相同镜像的实例。</li>\n<li>项目(project)：由一组关联的应用容器组成的一个完整业务单元。</li>\n</ul>\n<p>可见，一个项目可以由多个服务（容器）关联而成，Compose 面向项目进行管理。</p>\n<h3 id="场景"><a href="#%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景</h3>\n<p>最常见的项目是 web 网站，该项目应该包含 web 应用和缓存。</p>\n<p>下面我们用 Python 来建立一个能够记录页面访问次数的 web 网站。</p>\n<h4 id="web-应用"><a href="#web-%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 应用</h4>\n<p>新建文件夹，在该目录中编写 app.py 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13170226711978273000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from flask import Flask\nfrom redis import Redis\n\napp = Flask(__name__)\nredis = Redis(host=\'redis\', port=6379)\n\n@app.route(\'/\')\ndef hello():\n    count = redis.incr(\'hits\')\n    return \'Hello World! 该页面已被访问 {} 次。\\n\'.format(count)\n\nif __name__ == &quot;__main__&quot;:\n    app.run(host=&quot;0.0.0.0&quot;, debug=True)`, `13170226711978273000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask\n<span class="token keyword">from</span> redis <span class="token keyword">import</span> Redis\n\napp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>\nredis <span class="token operator">=</span> Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">\'redis\'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>\n\n@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">\'hits\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hello World! 该页面已被访问 {} 次。\\n\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>\n    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dockerfile-1"><a href="#dockerfile-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h4>\n<p>编写 Dockerfile 文件，内容为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20194699397369287000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3.6-alpine\nADD . /code\nWORKDIR /code\nRUN pip install redis flask\nCMD [&quot;python&quot;, &quot;app.py&quot;]`, `20194699397369287000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3.6<span class="token punctuation">-</span>alpine\n<span class="token keyword">ADD</span> . /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">RUN</span> pip install redis flask\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"app.py"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="docker-composeyml"><a href="#docker-composeyml" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>docker-compose.yml</h4>\n<p>编写 <code class="language-text">docker-compose.yml</code> 文件，这个是 Compose 使用的主模板文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22027044002122010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  web:\n    build: .\n    ports:\n      - \'5000:5000\'\n\n  redis:\n    image: \'redis:alpine\'`, `22027044002122010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'5000:5000\'</span>\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'redis:alpine\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行-compose-项目"><a href="#%E8%BF%90%E8%A1%8C-compose-%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行 compose 项目</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20575658197464140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up`, `20575658197464140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时访问本地 5000 端口，每次刷新页面，计数就会加 1。</p>\n<h2 id="compose-命令说明"><a href="#compose-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 命令说明</h2>\n<h3 id="命令对象与格式"><a href="#%E5%91%BD%E4%BB%A4%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%A0%BC%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令对象与格式</h3>\n<p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>\n<p>执行 <code class="language-text">docker compose [COMMAND] --help</code> 可以查看具体某个命令的使用格式。</p>\n<p>docker compose 命令的基本的使用格式是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57553573271971130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker compose [-f=<arg>...] [options] [COMMAND] [ARGS...]`, `57553573271971130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker compose <span class="token punctuation">[</span>-f<span class="token operator">=</span><span class="token operator">&lt;</span>arg<span class="token operator">></span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARGS<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="命令选项"><a href="#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令选项</h3>\n<ul>\n<li><code class="language-text">-f, --file FILE</code> 指定使用的 Compose 模板文件，默认为 <code class="language-text">docker-compose.yml</code>，可以多次指定。</li>\n<li><code class="language-text">-p, --project-name NAME</code> 指定项目名称，默认将使用所在目录名称作为项目名。</li>\n<li><code class="language-text">--verbose</code> 输出更多调试信息。</li>\n<li><code class="language-text">-v, --version</code> 打印版本并退出。</li>\n</ul>\n<h3 id="命令使用说明"><a href="#%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令使用说明</h3>\n<h4 id="build"><a href="#build" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h4>\n<p>格式为 <code class="language-text">docker compose build [options] [SERVICE...]</code>。</p>\n<p>构建（重新构建）项目中的服务容器。</p>\n<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 <code class="language-text">web_db</code>。</p>\n<p>可以随时在项目目录下运行 <code class="language-text">docker compose build</code> 来重新构建服务。</p>\n<p>选项包括：</p>\n<ul>\n<li><code class="language-text">--force-rm</code> 删除构建过程中的临时容器。</li>\n<li><code class="language-text">--no-cache</code> 构建镜像过程中不使用 cache（这将加长构建过程）。</li>\n<li><code class="language-text">--pull</code> 始终尝试通过 pull 来获取更新版本的镜像。</li>\n</ul>\n<h4 id="config"><a href="#config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>\n<h4 id="down"><a href="#down" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>down</h4>\n<p>此命令将会停止 up 命令所启动的容器，并移除网络</p>\n<h4 id="exec"><a href="#exec" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>进入指定的容器。</p>\n<h4 id="help"><a href="#help" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>获得一个命令的帮助。</p>\n<h4 id="images"><a href="#images" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>images</h4>\n<p>列出 Compose 文件中包含的镜像。</p>\n<h4 id="kill"><a href="#kill" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kill</h4>\n<p>格式为 <code class="language-text">docker compose kill [options] [SERVICE...]</code>。</p>\n<p>通过发送 SIGKILL 信号来强制停止服务容器。</p>\n<p>支持通过 <code class="language-text">-s</code> 参数来指定发送的信号，例如通过如下指令发送 SIGINT 信号。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5280762362488556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose kill -s SIGINT`, `5280762362488556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose <span class="token function">kill</span> -s SIGINT</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="logs"><a href="#logs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logs</h4>\n<p>格式为 <code class="language-text">docker compose logs [options] [SERVICE...]</code>。</p>\n<p>查看服务容器的输出。默认情况下，<code class="language-text">docker compose</code> 将对不同的服务输出使用不同的颜色来区分。可以通过 <code class="language-text">--no-color</code> 来关闭颜色。</p>\n<p>该命令在调试问题的时候十分有用。</p>\n<h4 id="pause"><a href="#pause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pause</h4>\n<p>格式为 <code class="language-text">docker compose pause [SERVICE...]</code>。</p>\n<p>暂停一个服务容器。</p>\n<h4 id="port"><a href="#port" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port</h4>\n<p>格式为 <code class="language-text">docker compose port [options] SERVICE PRIVATE_PORT</code>。</p>\n<p>打印某个容器端口所映射的公共端口。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--protocol=proto</code> 指定端口协议，tcp（默认值）或者 udp。</li>\n<li><code class="language-text">--index=index</code> 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</li>\n</ul>\n<h4 id="ps"><a href="#ps" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ps</h4>\n<p>格式为 <code class="language-text">docker compose ps [options] [SERVICE...]</code>。</p>\n<p>列出项目中目前的所有容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-q</code> 只打印容器的 ID 信息。</li>\n</ul>\n<h4 id="pull"><a href="#pull" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pull</h4>\n<p>格式为 <code class="language-text">docker compose pull [options] [SERVICE...]</code>。</p>\n<p>拉取服务依赖的镜像。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--ignore-pull-failures</code> 忽略拉取镜像过程中的错误。</li>\n</ul>\n<h4 id="push"><a href="#push" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>push</h4>\n<p>推送服务依赖的镜像到 Docker 镜像仓库。</p>\n<h4 id="restart"><a href="#restart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>restart</h4>\n<p>格式为 <code class="language-text">docker compose restart [options] [SERVICE...]</code>。</p>\n<p>重启项目中的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 指定重启前停止容器的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="rm"><a href="#rm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rm</h4>\n<p>格式为 <code class="language-text">docker compose rm [options] [SERVICE...]</code>。</p>\n<p>删除所有（停止状态的）服务容器。推荐先执行 <code class="language-text">docker compose stop</code> 命令来停止容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-f, --force</code> 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</li>\n<li><code class="language-text">-v</code> 删除容器所挂载的数据卷。</li>\n</ul>\n<h4 id="run-1"><a href="#run-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>格式为 <code class="language-text">docker compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]</code>。</p>\n<p>在指定服务上执行一个命令。</p>\n<p>例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13495890471158956000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run ubuntu ping docker.com`, `13495890471158956000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run ubuntu <span class="token function">ping</span> docker.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将会启动一个 ubuntu 服务容器，并执行 <code class="language-text">ping docker.com</code> 命令。</p>\n<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>\n<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>\n<p>两个不同点：</p>\n<ol>\n<li>给定命令将会覆盖原有的自动运行命令；</li>\n<li>不会自动创建端口，以避免冲突。</li>\n</ol>\n<p>如果不希望自动启动关联的容器，可以使用 <code class="language-text">--no-deps</code> 选项，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93106852036954520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run --no-deps web python manage.py shell`, `93106852036954520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run --no-deps web python manage.py shell</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将不会启动 web 容器所关联的其它容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 后台运行容器。</li>\n<li><code class="language-text">--name NAME</code> 为容器指定一个名字。</li>\n<li><code class="language-text">--entrypoint CMD</code> 覆盖默认的容器启动指令。</li>\n<li><code class="language-text">-e KEY=VAL</code> 设置环境变量值，可多次使用选项来设置多个环境变量。</li>\n<li><code class="language-text">-u, --user=&quot;&quot;</code> 指定运行容器的用户名或者 uid。</li>\n<li><code class="language-text">--no-deps</code> 不自动启动关联的服务容器。</li>\n<li><code class="language-text">--rm</code> 运行命令后自动删除容器，<code class="language-text">d</code> 模式下将忽略。</li>\n<li><code class="language-text">-p, --publish=[]</code> 映射容器端口到本地主机。</li>\n<li><code class="language-text">--service-ports</code> 配置服务端口并映射到本地主机。</li>\n<li><code class="language-text">-T</code> 不分配伪 tty，意味着依赖 tty 的指令将无法运行。</li>\n</ul>\n<h4 id="start"><a href="#start" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>start</h4>\n<p>格式为 <code class="language-text">docker compose start [SERVICE...]</code>。</p>\n<p>启动已经存在的服务容器。</p>\n<h4 id="stop"><a href="#stop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop</h4>\n<p>格式为 <code class="language-text">docker compose stop [options] [SERVICE...]</code>。</p>\n<p>停止已经处于运行状态的容器，但不删除它。通过 <code class="language-text">docker compose start</code> 可以再次启动这些容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="top"><a href="#top" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>top</h4>\n<p>查看各个服务容器内运行的进程。</p>\n<h4 id="unpause"><a href="#unpause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unpause</h4>\n<p>格式为 <code class="language-text">docker compose unpause [SERVICE...]</code>。</p>\n<p>恢复处于暂停状态中的服务。</p>\n<h4 id="up"><a href="#up" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>up</h4>\n<p>格式为 <code class="language-text">docker compose up [options] [SERVICE...]</code>。</p>\n<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>\n<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>\n<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>\n<p>默认情况，<code class="language-text">docker compose up</code> 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>\n<p>当通过 <code class="language-text">Ctrl-C</code> 停止命令时，所有容器将会停止。</p>\n<p>如果使用 <code class="language-text">docker compose up -d</code>，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>\n<p>默认情况，如果服务容器已经存在，<code class="language-text">docker compose up</code> 将会尝试停止容器，然后重新创建（保持使用 <code class="language-text">volumes-from</code> 挂载的卷），以保证新启动的服务匹配 <code class="language-text">docker-compose.yml</code> 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 <code class="language-text">docker compose up --no-recreate</code>。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 <code class="language-text">docker compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 在后台运行服务容器。</li>\n<li><code class="language-text">--no-color</code> 不使用颜色来区分不同的服务的控制台输出。</li>\n<li><code class="language-text">--no-deps</code> 不启动服务所链接的容器。</li>\n<li><code class="language-text">--force-recreate</code> 强制重新创建容器，不能与 <code class="language-text">--no-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-recreate</code> 如果容器已经存在了，则不重新创建，不能与 <code class="language-text">--force-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-build</code> 不自动构建缺失的服务镜像。</li>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="version"><a href="#version" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>格式为 <code class="language-text">docker compose version</code>。</p>\n<p>打印版本信息。</p>\n<h2 id="compose-模板文件"><a href="#compose-%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 模板文件</h2>\n<p>模板文件是使用 Compose 的核心，涉及到的指令关键字也比较多。但大家不用担心，这里面大部分指令跟 docker run 相关参数的含义都是类似的。</p>\n<p>默认的模板文件名称为 <code class="language-text">docker-compose.yml</code>，格式为 YAML 格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2323374261291166700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  webapp:\n    image: examples/web\n    ports:\n      - \'80:80\'\n    volumes:\n      - \'/data\'`, `2323374261291166700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> examples/web\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'80:80\'</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/data\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意每个服务都必须通过 image 指令指定镜像或 build 指令（需要 Dockerfile）等来自动构建生成镜像。</p>\n<p>如果使用 build 指令，在 Dockerfile 中设置的选项(例如：CMD, EXPOSE, VOLUME, ENV 等) 将会自动被获取，无需在 <code class="language-text">docker-compose.yml</code> 中重复设置。</p>\n<p>下面分别介绍各个指令的用法。</p>\n<h3 id="build-1"><a href="#build-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h3>\n<p>指定 Dockerfile 所在文件夹的路径（可以是绝对路径，或者相对 <code class="language-text">docker-compose.yml</code> 文件的路径）。Compose 将会利用它自动构建这个镜像，然后使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16546065778203056000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build: ./dir`, `16546065778203056000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./dir</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你也可以使用 context 指令指定 Dockerfile 所在文件夹的路径。</p>\n<p>使用 dockerfile 指令指定 Dockerfile 文件名。</p>\n<p>使用 arg 指令指定构建镜像时的变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60352343456666290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1`, `60352343456666290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span>\n      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./dir\n      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>alternate\n      <span class="token key atrule">args</span><span class="token punctuation">:</span>\n        <span class="token key atrule">buildno</span><span class="token punctuation">:</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">cache_from</code> 指定构建镜像的缓存</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86030906981904430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`build:\n  context: .\n  cache_from:\n    - alpine:latest\n    - corp/web_app:3.14`, `86030906981904430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">build</span><span class="token punctuation">:</span>\n  <span class="token key atrule">context</span><span class="token punctuation">:</span> .\n  <span class="token key atrule">cache_from</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> alpine<span class="token punctuation">:</span>latest\n    <span class="token punctuation">-</span> corp/web_app<span class="token punctuation">:</span><span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="cap_add-cap_drop"><a href="#cap_add-cap_drop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">cap_add</code>, <code class="language-text">cap_drop</code></h3>\n<p>指定容器的内核能力（capacity）分配。</p>\n<p>例如，让容器拥有所有能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97331670171689060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_add:\n  - ALL`, `97331670171689060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_add</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ALL</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>去掉 <code class="language-text">NET_ADMIN</code> 能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20814927338136146000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_drop:\n  - NET_ADMIN`, `20814927338136146000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> NET_ADMIN</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="command"><a href="#command" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command</h3>\n<p>覆盖容器启动后默认执行的命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87237652382392760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`command: echo &quot;hello world&quot;`, `87237652382392760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">command</span><span class="token punctuation">:</span> echo "hello world"</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="configs"><a href="#configs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>configs</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节。</p>\n<h3 id="cgroup_parent"><a href="#cgroup_parent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cgroup_parent</h3>\n<p>指定父 cgroup 组，意味着将继承该组的资源限制。</p>\n<p>例如，创建了一个 cgroup 组名称为 <code class="language-text">cgroups_1</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7335857765498610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cgroup_parent: cgroups_1`, `7335857765498610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cgroup_parent</span><span class="token punctuation">:</span> cgroups_1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="container_name"><a href="#container_name" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>container_name</h3>\n<p>指定容器名称。默认将会使用 <code class="language-text">项目名称-服务名称-序号</code> 这样的格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70849400504434975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`container_name: docker-web-container`, `70849400504434975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">container_name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>web<span class="token punctuation">-</span>container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注意: 指定容器名称后，该服务将无法进行扩展（scale），因为 Docker 不允许多个容器具有相同的名称。</p>\n</blockquote>\n<h3 id="deploy"><a href="#deploy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节</p>\n<h3 id="devices"><a href="#devices" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>devices</h3>\n<p>指定设备映射关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38933679471703785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`devices:\n  - \'/dev/ttyUSB1:/dev/ttyUSB0\'`, `38933679471703785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">devices</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'/dev/ttyUSB1:/dev/ttyUSB0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="depends_on"><a href="#depends_on" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>depends_on</h3>\n<p>解决容器的依赖、启动先后的问题。以下例子中会先启动 <code class="language-text">redis db</code> 再启动 web</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42817112778417400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n\n  redis:\n    image: redis\n\n  db:\n    image: postgres`, `42817112778417400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n      <span class="token punctuation">-</span> redis\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：web 服务不会等待 <code class="language-text">redis db</code>「完全启动」之后才启动。</p>\n</blockquote>\n<h3 id="dns"><a href="#dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns</h3>\n<p>自定义 DNS 服务器。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33422092273352065000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns: 8.8.8.8\n\ndns:\n  - 8.8.8.8\n  - 114.114.114.114`, `33422092273352065000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns</span><span class="token punctuation">:</span> 8.8.8.8\n\n<span class="token key atrule">dns</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> 8.8.8.8\n  <span class="token punctuation">-</span> 114.114.114.114</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dns_search"><a href="#dns_search" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns_search</h3>\n<p>配置 DNS 搜索域。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91304874322790890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns_search: example.com\n\ndns_search:\n  - domain1.example.com\n  - domain2.example.com`, `91304874322790890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns_search</span><span class="token punctuation">:</span> example.com\n\n<span class="token key atrule">dns_search</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> domain1.example.com\n  <span class="token punctuation">-</span> domain2.example.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="tmpfs"><a href="#tmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tmpfs</h3>\n<p>挂载一个 tmpfs 文件系统到容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40374303824731040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tmpfs: /run\ntmpfs:\n  - /run\n  - /tmp`, `40374303824731040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tmpfs</span><span class="token punctuation">:</span> /run\n<span class="token key atrule">tmpfs</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /run\n  <span class="token punctuation">-</span> /tmp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="env_file"><a href="#env_file" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>env_file</h3>\n<p>从文件中获取环境变量，可以为单独的文件路径或列表。</p>\n<p>如果通过 <code class="language-text">docker compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code class="language-text">env_file</code> 中变量的路径会基于模板文件路径。</p>\n<p>如果有变量名称与 environment 指令冲突，则按照惯例，以后者为准。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85351867801673610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`env_file: .env\n\nenv_file:\n  - ./common.env\n  - ./apps/web.env\n  - /opt/secrets.env`, `85351867801673610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">env_file</span><span class="token punctuation">:</span> .env\n\n<span class="token key atrule">env_file</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ./common.env\n  <span class="token punctuation">-</span> ./apps/web.env\n  <span class="token punctuation">-</span> /opt/secrets.env</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>环境变量文件中每一行必须符合格式，支持 # 开头的注释行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79394857940930690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# common.env: Set development environment\nPROG_ENV=development`, `79394857940930690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># common.env: Set development environment</span>\n<span class="token assign-left variable">PROG_ENV</span><span class="token operator">=</span>development</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="environment"><a href="#environment" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>environment</h3>\n<p>设置环境变量。你可以使用数组或字典两种格式。</p>\n<p>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92908287140944970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`environment:\n  RACK_ENV: development\n  SESSION_SECRET:\n\nenvironment:\n  - RACK_ENV=development\n  - SESSION_SECRET`, `92908287140944970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token key atrule">RACK_ENV</span><span class="token punctuation">:</span> development\n  <span class="token key atrule">SESSION_SECRET</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> RACK_ENV=development\n  <span class="token punctuation">-</span> SESSION_SECRET</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果变量名称或者值中用到 <code class="language-text">true|false</code>，<code class="language-text">yes|no</code> 等表达布尔含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16833805828878012000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF`, `16833805828878012000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">y<span class="token operator">|</span>Y<span class="token operator">|</span><span class="token function">yes</span><span class="token operator">|</span>Yes<span class="token operator">|</span>YES<span class="token operator">|</span>n<span class="token operator">|</span>N<span class="token operator">|</span>no<span class="token operator">|</span>No<span class="token operator">|</span>NO<span class="token operator">|</span><span class="token boolean">true</span><span class="token operator">|</span>True<span class="token operator">|</span>TRUE<span class="token operator">|</span><span class="token boolean">false</span><span class="token operator">|</span>False<span class="token operator">|</span>FALSE<span class="token operator">|</span>on<span class="token operator">|</span>On<span class="token operator">|</span>ON<span class="token operator">|</span>off<span class="token operator">|</span>Off<span class="token operator">|</span>OFF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="expose-1"><a href="#expose-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h3>\n<p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p>\n<p>仅可以指定内部端口为参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43351758418376950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`expose:\n  - \'3000\'\n  - \'8000\'`, `43351758418376950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">expose</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="external_links"><a href="#external_links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>external_links</h3>\n<p>注意：不建议使用该指令。</p>\n<p>链接到 <code class="language-text">docker-compose.yml</code> 外部的容器，甚至并非 Compose 管理的外部容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31819175947663704000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`external_links:\n  - redis_1\n  - project_db_1:mysql\n  - project_db_1:postgresql`, `31819175947663704000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">external_links</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> redis_1\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>mysql\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>postgresql</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="extra_hosts"><a href="#extra_hosts" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>extra_hosts</h3>\n<p>类似 Docker 中的 <code class="language-text">--add-host</code> 参数，指定额外的 host 名称映射信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3859524136844494300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`extra_hosts:\n  - \'googledns:8.8.8.8\'\n  - \'dockerhub:52.1.157.61\'`, `3859524136844494300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'googledns:8.8.8.8\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'dockerhub:52.1.157.61\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>会在启动后的服务容器中 <code class="language-text">/etc/hosts</code> 文件中添加如下两条条目。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27466994211162763000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`8.8.8.8 googledns\n52.1.157.61 dockerhub`, `27466994211162763000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token number">8.8</span>.8.8 googledns\n<span class="token number">52.1</span>.157.61 dockerhub</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="healthcheck"><a href="#healthcheck" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>healthcheck</h3>\n<p>通过命令检查容器是否健康运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1003749919403151900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`healthcheck:\n  test: [\'CMD\', \'curl\', \'-f\', \'http://localhost\']\n  interval: 1m30s\n  timeout: 10s\n  retries: 3`, `1003749919403151900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n  <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'CMD\'</span><span class="token punctuation">,</span> <span class="token string">\'curl\'</span><span class="token punctuation">,</span> <span class="token string">\'-f\'</span><span class="token punctuation">,</span> <span class="token string">\'http://localhost\'</span><span class="token punctuation">]</span>\n  <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1m30s\n  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s\n  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="image"><a href="#image" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>image</h3>\n<p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，Compose 将会尝试拉取这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40130201464069915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`image: ubuntu\nimage: orchardup/postgresql\nimage: a4bc65fd`, `40130201464069915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu\n<span class="token key atrule">image</span><span class="token punctuation">:</span> orchardup/postgresql\n<span class="token key atrule">image</span><span class="token punctuation">:</span> a4bc65fd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="labels"><a href="#labels" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>labels</h3>\n<p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10552718617979572000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`labels:\n  com.startupteam.description: \'webapp for a startup team\'\n  com.startupteam.department: \'devops department\'\n  com.startupteam.release: \'rc3 for v1.0\'`, `10552718617979572000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">labels</span><span class="token punctuation">:</span>\n  <span class="token key atrule">com.startupteam.description</span><span class="token punctuation">:</span> <span class="token string">\'webapp for a startup team\'</span>\n  <span class="token key atrule">com.startupteam.department</span><span class="token punctuation">:</span> <span class="token string">\'devops department\'</span>\n  <span class="token key atrule">com.startupteam.release</span><span class="token punctuation">:</span> <span class="token string">\'rc3 for v1.0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="links"><a href="#links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>links</h3>\n<p>注意：不推荐使用该指令。</p>\n<h3 id="logging"><a href="#logging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logging</h3>\n<p>配置日志选项。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44954833219688760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`logging:\n  driver: syslog\n  options:\n    syslog-address: \'tcp://192.168.0.42:123\'`, `44954833219688760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>\n  <span class="token key atrule">driver</span><span class="token punctuation">:</span> syslog\n  <span class="token key atrule">options</span><span class="token punctuation">:</span>\n    <span class="token key atrule">syslog-address</span><span class="token punctuation">:</span> <span class="token string">\'tcp://192.168.0.42:123\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前支持三种日志驱动类型。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11144248123456580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`driver: &quot;json-file&quot;\ndriver: &quot;syslog&quot;\ndriver: &quot;none&quot;`, `11144248123456580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"syslog"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"none"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>options 配置日志驱动的相关参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68899416752500105000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`options:\n  max-size: \'200k\'\n  max-file: \'10\'`, `68899416752500105000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">options</span><span class="token punctuation">:</span>\n  <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">\'200k\'</span>\n  <span class="token key atrule">max-file</span><span class="token punctuation">:</span> <span class="token string">\'10\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="network_mode"><a href="#network_mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>network_mode</h3>\n<p>设置网络模式。使用和 docker run 的 <code class="language-text">--network</code> 参数一样的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28334166592985354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`network_mode: &quot;bridge&quot;\nnetwork_mode: &quot;host&quot;\nnetwork_mode: &quot;none&quot;\nnetwork_mode: &quot;service:[service name]&quot;\nnetwork_mode: &quot;container:[container name/id]&quot;`, `28334166592985354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"bridge"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"none"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"service:[service name]"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"container:[container name/id]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="networks"><a href="#networks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>networks</h3>\n<p>配置容器连接的网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85155966903533260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  some-service:\n    networks:\n      - some-network\n      - other-network\n\nnetworks:\n  some-network:\n  other-network:`, `85155966903533260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-service</span><span class="token punctuation">:</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> some<span class="token punctuation">-</span>network\n      <span class="token punctuation">-</span> other<span class="token punctuation">-</span>network\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-network</span><span class="token punctuation">:</span>\n  other<span class="token punctuation">-</span>network<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="pid"><a href="#pid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pid</h3>\n<p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40732530681642710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pid: \'host\'`, `40732530681642710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">pid</span><span class="token punctuation">:</span> <span class="token string">\'host\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="ports"><a href="#ports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ports</h3>\n<p>暴露端口信息。</p>\n<p>使用宿主端口：容器端口（HOST:CONTAINER）格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65725120202537310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ports:\n  - \'3000\'\n  - \'8000:8000\'\n  - \'49100:22\'\n  - \'127.0.0.1:8001:8001\'`, `65725120202537310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'49100:22\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'127.0.0.1:8001:8001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：当使用 <code class="language-text">HOST:CONTAINER</code> 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 YAML 会自动解析 <code class="language-text">xx:yy</code> 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</p>\n</blockquote>\n<h3 id="secrets"><a href="#secrets" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>secrets</h3>\n<p>存储敏感数据，例如 mysql 服务密码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33790816935484047000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3.1\'\nservices:\n\nmysql:\n  image: mysql\n  environment:\n    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password\n  secrets:\n    - db_root_password\n    - my_other_secret\n\nsecrets:\n  my_secret:\n    file: ./my_secret.txt\n  my_other_secret:\n    external: true`, `33790816935484047000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3.1\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">mysql</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n  <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n    <span class="token key atrule">MYSQL_ROOT_PASSWORD_FILE</span><span class="token punctuation">:</span> /run/secrets/db_root_password\n  <span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> db_root_password\n    <span class="token punctuation">-</span> my_other_secret\n\n<span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">file</span><span class="token punctuation">:</span> ./my_secret.txt\n  <span class="token key atrule">my_other_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="security_opt"><a href="#security_opt" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>security_opt</h3>\n<p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23295826278522556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`security_opt:\n  - label:user:USER\n  - label:role:ROLE`, `23295826278522556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">security_opt</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>user<span class="token punctuation">:</span>USER\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>role<span class="token punctuation">:</span>ROLE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="stop_signal"><a href="#stop_signal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop_signal</h3>\n<p>设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55384896851135970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stop_signal: SIGUSR1`, `55384896851135970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stop_signal</span><span class="token punctuation">:</span> SIGUSR1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="sysctls"><a href="#sysctls" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sysctls</h3>\n<p>配置容器内核参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73560314922945350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sysctls:\n  net.core.somaxconn: 1024\n  net.ipv4.tcp_syncookies: 0\n\nsysctls:\n  - net.core.somaxconn=1024\n  - net.ipv4.tcp_syncookies=0`, `73560314922945350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token key atrule">net.core.somaxconn</span><span class="token punctuation">:</span> <span class="token number">1024</span>\n  <span class="token key atrule">net.ipv4.tcp_syncookies</span><span class="token punctuation">:</span> <span class="token number">0</span>\n\n<span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> net.core.somaxconn=1024\n  <span class="token punctuation">-</span> net.ipv4.tcp_syncookies=0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="ulimits"><a href="#ulimits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ulimits</h3>\n<p>指定容器的 ulimits 限制值。</p>\n<p>例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制）和 40000（系统硬限制，只能 root 用户提高）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80399339073902620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ulimits:\n  nproc: 65535\n  nofile:\n    soft: 20000\n    hard: 40000`, `80399339073902620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ulimits</span><span class="token punctuation">:</span>\n  <span class="token key atrule">nproc</span><span class="token punctuation">:</span> <span class="token number">65535</span>\n  <span class="token key atrule">nofile</span><span class="token punctuation">:</span>\n    <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">20000</span>\n    <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">40000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="volumes"><a href="#volumes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volumes</h3>\n<p>数据卷所挂载路径设置。可以设置为宿主机路径（HOST:CONTAINER）或者数据卷名称（VOLUME:CONTAINER），并且可以设置访问模式（HOST:CONTAINER:ro）。</p>\n<p>该指令中路径支持相对路径。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95979068931707270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`volumes:\n  - /var/lib/mysql\n  - cache/:/tmp/cache\n  - ~/configs:/etc/configs/:ro`, `95979068931707270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /var/lib/mysql\n  <span class="token punctuation">-</span> cache/<span class="token punctuation">:</span>/tmp/cache\n  <span class="token punctuation">-</span> ~/configs<span class="token punctuation">:</span>/etc/configs/<span class="token punctuation">:</span>ro</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果路径为数据卷名称，必须在文件中配置数据卷。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73140720603402990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  my_src:\n    image: mysql:8.0\n    volumes:\n      - mysql_data:/var/lib/mysql\n\nvolumes:\n  mysql_data:`, `73140720603402990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_src</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> mysql_data<span class="token punctuation">:</span>/var/lib/mysql\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  mysql_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="其它指令"><a href="#%E5%85%B6%E5%AE%83%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它指令</h3>\n<p>此外，还有包括 domainname, entrypoint, hostname, ipc, <code class="language-text">mac_address</code>, privileged, <code class="language-text">read_only</code>, <code class="language-text">shm_size</code>, restart, <code class="language-text">stdin_open</code>, tty, user, <code class="language-text">working_dir</code> 等指令，基本跟 docker run 中对应参数的功能一致。</p>\n<p>指定服务容器启动后执行的入口文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27551024978639170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entrypoint: /code/entrypoint.sh`, `27551024978639170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> /code/entrypoint.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中运行应用的用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47123192675834890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`user: nginx`, `47123192675834890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">user</span><span class="token punctuation">:</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中工作目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68983393897265684000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`working_dir: /code`, `68983393897265684000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /code</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中搜索域名、主机名、mac 地址等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83040641826346830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`domainname: your_website.com\nhostname: test\nmac_address: 08-00-27-00-0C-0A`, `83040641826346830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">domainname</span><span class="token punctuation">:</span> your_website.com\n<span class="token key atrule">hostname</span><span class="token punctuation">:</span> test\n<span class="token key atrule">mac_address</span><span class="token punctuation">:</span> 08<span class="token punctuation">-</span>00<span class="token punctuation">-</span>27<span class="token punctuation">-</span>00<span class="token punctuation">-</span>0C<span class="token punctuation">-</span>0A</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>允许容器中运行一些特权命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24929060296269800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`privileged: true`, `24929060296269800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 always 或者 <code class="language-text">unless-stopped</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66281894030410800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`restart: always`, `66281894030410800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">restart</span><span class="token punctuation">:</span> always</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>以只读模式挂载容器的 root 文件系统，意味着不能对容器内容进行修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73634723567852480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`read_only: true`, `73634723567852480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">read_only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开标准输入，可以接受外部输入。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19784699218302304000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stdin_open: true`, `19784699218302304000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>模拟一个伪终端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97510392417991330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tty: true`, `97510392417991330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="读取变量"><a href="#%E8%AF%BB%E5%8F%96%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取变量</h3>\n<p>Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 <code class="language-text">.env</code> 文件中的变量。</p>\n<p>例如，下面的 Compose 文件将从运行它的环境中读取变量 <code class="language-text">${MONGO_VERSION}</code> 的值，并写入执行的指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31875962414776504000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n\ndb:\n  image: \'mongo:\\${MONGO_VERSION}\'`, `31875962414776504000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">db</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'mongo:${MONGO_VERSION}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果执行 <code class="language-text">MONGO_VERSION=3.2 docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.2</code> 镜像的容器；如果执行 <code class="language-text">MONGO_VERSION=2.8 docker compose up</code> 则会启动一个 <code class="language-text">mongo:2.8</code> 镜像的容器。</p>\n<p>若当前目录存在 <code class="language-text">.env</code> 文件，执行 <code class="language-text">docker compose</code> 命令时将从该文件中读取变量。</p>\n<p>在当前目录新建 <code class="language-text">.env</code> 文件并写入以下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86537414711790130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 支持 # 号注释\nMONGO_VERSION=3.6`, `86537414711790130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 支持 # 号注释</span>\n<span class="token assign-left variable">MONGO_VERSION</span><span class="token operator">=</span><span class="token number">3.6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>执行 <code class="language-text">docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.6</code> 镜像的容器。</p>\n<h2 id="使用-django"><a href="#%E4%BD%BF%E7%94%A8-django" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Django</h2>\n<p>我们现在将使用 Docker Compose 配置并运行一个 <code class="language-text">Django/PostgreSQL</code> 应用。</p>\n<p>在一切工作开始前，需要先编辑好三个必要的文件。</p>\n<p>第一步，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 Dockerfile 文件来指定 Docker 容器要安装内容。内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97391041317081250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3\nENV PYTHONUNBUFFERED 1\nRUN mkdir /code\nWORKDIR /code\nCOPY requirements.txt /code/\nRUN pip install -r requirements.txt\nCOPY . /code/`, `97391041317081250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3\n<span class="token keyword">ENV</span> PYTHONUNBUFFERED 1\n<span class="token keyword">RUN</span> mkdir /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">COPY</span> requirements.txt /code/\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span>r requirements.txt\n<span class="token keyword">COPY</span> . /code/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上内容指定应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 Dockerfile 使用。</p>\n<p>第二步，在 <code class="language-text">requirements.txt</code> 文件里面写明需要安装的具体依赖包名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38917312341134490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Django>=2.0,<3.0\npsycopg2>=2.7,<3.0`, `38917312341134490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Django&gt;=2.0,&lt;3.0\npsycopg2&gt;=2.7,&lt;3.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>第三步，<code class="language-text">docker-compose.yml</code> 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、使用的 Docker 镜像、镜像之间的连接、挂载到容器的卷，以及服务开放的端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23849191396901870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: postgres\n    environment:\n      POSTGRES_PASSWORD: \'postgres\'\n\n  web:\n    build: .\n    command: python manage.py runserver 0.0.0.0:8000\n    volumes:\n      - .:/code\n    ports:\n      - \'8000:8000\'`, `23849191396901870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span>\n\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> python manage.py runserver 0.0.0.0<span class="token punctuation">:</span><span class="token number">8000</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看 <code class="language-text">docker-compose.yml</code> 章节 了解更多详细的工作机制。</p>\n<p>现在我们就可以使用 <code class="language-text">docker compose run</code> 命令启动一个 Django 应用了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13916220503434174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web django-admin startproject django_example .`, `13916220503434174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web django-admin startproject django_example <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 web 服务所使用的镜像并不存在，所以 Compose 会首先使用 Dockerfile 为 web 服务构建一个镜像，接着使用这个镜像在容器里运行 <code class="language-text">django-admin startproject django_example</code> 指令。</p>\n<p>这将在当前目录生成一个 Django 应用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6315787727119915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ls\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt`, `6315787727119915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ls</span>\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你的系统是 Linux，记得更改文件权限。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95128618360012280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo chown -R \\$USER:\\$USER .`, `95128618360012280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">chown</span> -R <span class="token environment constant">$USER</span><span class="token builtin class-name">:</span><span class="token environment constant">$USER</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>首先，我们要为应用设置好数据库的连接信息。用以下内容替换 <code class="language-text">django_example/settings.py</code> 文件中 <code class="language-text">DATABASES = ...</code> 定义的节点内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20015462534301643000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DATABASES = {\n    \'default\': {\n        \'ENGINE\': \'django.db.backends.postgresql\',\n        \'NAME\': \'postgres\',\n        \'USER\': \'postgres\',\n        \'HOST\': \'db\',\n        \'PORT\': 5432,\n        \'PASSWORD\': \'postgres\',\n    }\n}`, `20015462534301643000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'default\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'ENGINE\'</span><span class="token punctuation">:</span> <span class="token string">\'django.db.backends.postgresql\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'NAME\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'USER\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'HOST\'</span><span class="token punctuation">:</span> <span class="token string">\'db\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'PORT\'</span><span class="token punctuation">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>\n        <span class="token string">\'PASSWORD\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些信息是在 postgres 镜像固定设置好的。然后，运行 <code class="language-text">docker compose up</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84721954226046270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 ...\nCreating django_web_1 ... done\nAttaching to django_db_1, django_web_1\ndb_1   | The files belonging to this database system will be owned by user &quot;postgres&quot;.\ndb_1   | This user must also own the server process.\ndb_1   |\ndb_1   | The database cluster will be initialized with locale &quot;en_US.utf8&quot;.\ndb_1   | The default database encoding has accordingly been set to &quot;UTF8&quot;.\ndb_1   | The default text search configuration will be set to &quot;english&quot;.\n\nweb_1  | Performing system checks...\nweb_1  |\nweb_1  | System check identified no issues (0 silenced).\nweb_1  |\nweb_1  | November 23, 2017 - 06:21:19\nweb_1  | Django version 1.11.7, using settings \'django_example.settings\'\nweb_1  | Starting development server at http://0.0.0.0:8000/\nweb_1  | Quit the server with CONTROL-C.`, `84721954226046270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 <span class="token punctuation">..</span>.\nCreating django_web_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>\nAttaching to django_db_1, django_web_1\ndb_1   <span class="token operator">|</span> The files belonging to this database system will be owned by user <span class="token string">"postgres"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> This user must also own the server process.\ndb_1   <span class="token operator">|</span>\ndb_1   <span class="token operator">|</span> The database cluster will be initialized with locale <span class="token string">"en_US.utf8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default database encoding has accordingly been <span class="token builtin class-name">set</span> to <span class="token string">"UTF8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default text search configuration will be <span class="token builtin class-name">set</span> to <span class="token string">"english"</span><span class="token builtin class-name">.</span>\n\nweb_1  <span class="token operator">|</span> Performing system checks<span class="token punctuation">..</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> November <span class="token number">23</span>, <span class="token number">2017</span> - 06:21:19\nweb_1  <span class="token operator">|</span> Django version <span class="token number">1.11</span>.7, using settings <span class="token string">\'django_example.settings\'</span>\nweb_1  <span class="token operator">|</span> Starting development server at http://0.0.0.0:8000/\nweb_1  <span class="token operator">|</span> Quit the server with CONTROL-C.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 Django 应用已经开始在你的 Docker 守护进程里监听着 8000 端口了。打开 <code class="language-text">127.0.0.1:8000</code> 即可看到 Django 欢迎页面。</p>\n<p>你还可以在 Docker 上运行其它的管理命令，例如对于同步数据库结构这种事，在运行完 <code class="language-text">docker compose up</code> 后，在另外一个终端进入文件夹运行以下命令即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85229351748815220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web python manage.py syncdb`, `85229351748815220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web python manage.py syncdb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-wordpress"><a href="#%E4%BD%BF%E7%94%A8-wordpress" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 WordPress</h2>\n<p>Compose 可以很便捷的让 Wordpress 运行在一个独立的环境中。</p>\n<h3 id="创建空文件夹"><a href="#%E5%88%9B%E5%BB%BA%E7%A9%BA%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建空文件夹</h3>\n<p>假设新建一个名为 wordpress 的文件夹，然后进入这个文件夹。</p>\n<h3 id="创建-docker-composeyml-文件"><a href="#%E5%88%9B%E5%BB%BA-docker-composeyml-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 docker-compose.yml 文件</h3>\n<p><code class="language-text">docker-compose.yml</code> 文件将开启一个 wordpress 服务和一个独立的 MySQL 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80396481957118410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: mysql:8.0\n    command:\n      - --default_authentication_plugin=mysql_native_password\n      - --character-set-server=utf8mb4\n      - --collation-server=utf8mb4_unicode_ci\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n\n  wordpress:\n    depends_on:\n      - db\n    image: wordpress:latest\n    ports:\n      - \'8000:80\'\n    restart: always\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\nvolumes:\n  db_data:`, `80396481957118410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">command</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default_authentication_plugin=mysql_native_password\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db_data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>latest\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:80\'</span>\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  db_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建并运行项目"><a href="#%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建并运行项目</h3>\n<p>运行 <code class="language-text">docker compose up -d Compose</code> 就会拉取镜像再创建我们所需要的镜像，然后启动 wordpress 和数据库容器。接着浏览器访问 <code class="language-text">127.0.0.1:8000</code> 端口就能看到 WordPress 安装界面了。</p>\n<h1 id="kubernetes"><a href="#kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes</h1>\n<p>Kubernetes 是 Google 团队发起并维护的基于 Docker 的开源容器集群管理系统，它不仅支持常见的云平台，而且支持内部数据中心。</p>\n<p>建于 Docker 之上的 Kubernetes 可以构建一个容器的调度服务，其目的是让用户透过 Kubernetes 集群来进行云端容器集群的管理，而无需用户进行复杂的设置工作。系统会自动选取合适的工作节点来执行具体的容器集群调度处理工作。其核心概念是 Container Pod。一个 Pod 由一组工作于同一物理工作节点的容器构成。这些组容器拥有相同的网络命名空间、IP 以及存储配额，也可以根据实际情况对每一个 Pod 进行端口映射。此外，Kubernetes 工作节点会由主系统进行管理，节点包含了能够运行 Docker 容器所用到的服务。</p>\n<h2 id="项目简介"><a href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目简介</h2>\n<p>Kubernetes 是 Google 团队发起的开源项目，它的目标是管理跨多个主机的容器，提供基本的部署，维护以及应用伸缩，主要实现语言为 Go 语言。Kubernetes 是：</p>\n<ul>\n<li>易学：轻量级，简单，容易理解</li>\n<li>便携：支持公有云，私有云，混合云，以及多种云平台</li>\n<li>可拓展：模块化，可插拔，支持钩子，可任意组合</li>\n<li>自修复：自动重调度，自动重启，自动复制</li>\n</ul>\n<p>Kubernetes 构建于 Google 数十年经验，一大半来源于 Google 生产环境规模的经验。结合了社区最佳的想法和实践。</p>\n<p>在分布式系统中，部署，调度，伸缩一直是最为重要的也最为基础的功能。Kubernetes 就是希望解决这一序列问题的。</p>\n<p>Kubernetes 目前在 GitHub 进行维护。</p>\n<p>Kubernetes 能够运行在任何地方，虽然 Kubernetes 最初是为 GCE 定制的，但是在后续版本中陆续增加了其他云平台的支持，以及本地数据中心的支持。</p>\n<h2 id="基本概念-2"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-14d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 72.9113924050633%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACIElEQVQ4y3WUW3PaMBCF+f9/pI+dPqXtS/rQp06GduiQkAAhBHMxli+yLcuyJJ+ujA02NJrRaLSWPp2zuzACjbquB5Mi7QporZDmIe0NlOLIshx5fprWWnT3uzHqb7rRD2UixnL9G6USKGWMMAwQBAxJEp9BA2AX0Ma2s8aWcby8+whTiaLMsN5OwXNGJyvkWQzOU1RVdQM7A20L7CyrSqOQCs5QVkR4+HOH8eQbWOy50wRkiCKn0P5foQMa035E+5EWoyh//Ihd8ArvMEcSehDhEWWRU27NTb7degHa21wqKRDt18hWS1hRINtsMPv8CWLv4VJMDFSOXMS63NGL1pgGHGcSe5ZAVBQvCwTPU4iYITvssLj7gv2vnwieJtD0IOo2VW01RzXZKrwd+PIN8sga62EqsPEjpIWiB8gaTumItytsH8dID3tE3hpSSVTUVrXRPctOIVVMl1Q1UggMrZcFh794gKkKeC9j+G/T5gQ1A7nSDbAi4MVyUzecc9hVumtaSYcXEcMxz6AERyVz1A6kNCk89awD2gHQXqp8PUICfJ1N8Zdsui7RNJWiNtMnEQ6mrRkq7BrbHXCTcYF3P6QeVAQU+LGa45EFDdAQ0QmwtNF2CGty2G1sY/M0k1ziEHIIyqtTeP86xyzwnRV60DYQp8xY2/u5Xin8aDiF35+fMPF3VAjTwExPVf/+QOH1P04XL0mJlyYNuB/v3+lD/wHACZHo21IUiAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 13 57 53" title="" data-src="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-fee1c.png" data-srcset="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-a67b7.png 200w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-0b187.png 400w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-fee1c.png 800w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-14d8a.png 1185w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>节点（Node）：一个节点是一个运行 Kubernetes 中的主机。</li>\n<li>容器组（Pod）：一个 Pod 对应于由若干容器组成的一个容器组，同个组内的容器共享一个存储卷(volume)。</li>\n<li>容器组生命周期（pos-states）：包含所有容器状态集合，包括容器组状态类型，容器组生命周期，事件，重启策略，以及 <code class="language-text">replication controllers</code>。</li>\n<li>Replication Controllers：主要负责指定数量的 pod 在同一时间一起运行。</li>\n<li>服务（services）：一个 Kubernetes 服务是容器组逻辑的高级抽象，同时也对外提供访问容器组的策略。</li>\n<li>卷（volumes）：一个卷就是一个目录，容器对其有访问权限。</li>\n<li>标签（labels）：标签是用来连接一组对象的，比如容器组。标签可以被用来组织和选择子对象。</li>\n<li>接口权限（<code class="language-text">accessing_the_api</code>）：端口，IP 地址和代理的防火墙规则。</li>\n<li>web 界面（ux）：用户可以通过 web 界面操作 Kubernetes。</li>\n<li>命令行操作（cli）：kubectl 命令。</li>\n</ul>\n<h3 id="节点-1"><a href="#%E8%8A%82%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>在 Kubernetes 中，节点是实际工作的点，节点可以是虚拟机或者物理机器，依赖于一个集群环境。每个节点都有一些必要的服务以运行容器组，并且它们都可以通过主节点来管理。必要服务包括 Docker，kubelet 和代理服务。</p>\n<h4 id="容器状态"><a href="#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器状态</h4>\n<p>容器状态用来描述节点的当前状态。现在，其中包含三个信息：</p>\n<h5 id="主机-ip"><a href="#%E4%B8%BB%E6%9C%BA-ip" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主机 IP</h5>\n<p>主机 IP 需要云平台来查询，Kubernetes 把它作为状态的一部分来保存。如果 Kubernetes 没有运行在云平台上，节点 ID 就是必需的。IP 地址可以变化，并且可以包含多种类型的 IP 地址，如公共 IP，私有 IP，动态 IP，ipv6 等等。</p>\n<h5 id="节点周期"><a href="#%E8%8A%82%E7%82%B9%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点周期</h5>\n<p>通常来说节点有 Pending，Running，Terminated 三个周期，如果 Kubernetes 发现了一个节点并且其可用，那么 Kubernetes 就把它标记为 Pending。然后在某个时刻，Kubernetes 将会标记其为 Running。节点的结束周期称为 Terminated。一个已经 Terminated 的节点不会接受和调度任何请求，并且已经在其上运行的容器组也会删除。</p>\n<h5 id="节点状态"><a href="#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点状态</h5>\n<p>节点的状态主要是用来描述处于 Running 的节点。当前可用的有 NodeReachable 和 NodeReady。以后可能会增加其他状态。NodeReachable 表示集群可达。NodeReady 表示 kubelet 返回 Status Ok 并且 HTTP 状态检查健康。</p>\n<h4 id="节点管理"><a href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点管理</h4>\n<p>节点并非 Kubernetes 创建，而是由云平台创建，或者就是物理机器、虚拟机。在 Kubernetes 中，节点仅仅是一条记录，节点创建之后，Kubernetes 会检查其是否可用。在 Kubernetes 中，节点用如下结构保存：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30649833236202560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;id&quot;: &quot;10.1.2.3&quot;,\n  &quot;kind&quot;: &quot;Minion&quot;,\n  &quot;apiVersion&quot;: &quot;v1beta1&quot;,\n  &quot;resources&quot;: {\n    &quot;capacity&quot;: {\n      &quot;cpu&quot;: 1000,\n      &quot;memory&quot;: 1073741824\n    }\n  },\n  &quot;labels&quot;: {\n    &quot;name&quot;: &quot;my-first-k8s-node&quot;\n  }\n}`, `30649833236202560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"10.1.2.3"</span><span class="token punctuation">,</span>\n  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Minion"</span><span class="token punctuation">,</span>\n  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1beta1"</span><span class="token punctuation">,</span>\n  <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"capacity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n      <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token number">1073741824</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-first-k8s-node"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Kubernetes 校验节点可用依赖于 ID。在当前的版本中，有两个接口可以用来管理节点：节点控制和 Kube 管理。</p>\n<h4 id="节点控制"><a href="#%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点控制</h4>\n<p>在 Kubernetes 主节点中，节点控制器是用来管理节点的组件。主要包含：</p>\n<ul>\n<li>集群范围内节点同步</li>\n<li>单节点生命周期管理</li>\n</ul>\n<p>节点控制有一个同步轮询，主要监听所有云平台的虚拟实例，会根据节点状态创建和删除。可以通过 <code class="language-text">--node_sync_period</code> 标志来控制该轮询。如果一个实例已经创建，节点控制将会为其创建一个结构。同样的，如果一个节点被删除，节点控制也会删除该结构。在 Kubernetes 启动时可用通过 <code class="language-text">--machines</code> 标记来显示指定节点。同样可以使用 kubectl 来一条一条的添加节点，两者是相同的。通过设置 <code class="language-text">--sync_nodes=false</code> 标记来禁止集群之间的节点同步，你也可以使用 <code class="language-text">api/kubectl</code> 命令行来增删节点。</p>\n<h3 id="容器组"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组</h3>\n<p>在 Kubernetes 中，使用的最小单位是容器组，容器组是创建，调度，管理的最小单位。一个容器组使用相同的 Docker 容器并共享卷（挂载点）。一个容器组是一个特定应用的打包集合，包含一个或多个容器。</p>\n<p>和运行的容器类似，一个容器组被认为只有很短的运行周期。容器组被调度到一组节点运行，直到容器的生命周期结束或者其被删除。如果节点死掉，运行在其上的容器组将会被删除而不是重新调度。（也许在将来的版本中会添加容器组的移动）。</p>\n<h4 id="容器组设计的初衷"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%88%9D%E8%A1%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组设计的初衷</h4>\n<h4 id="资源共享和通信"><a href="#%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB%E5%92%8C%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源共享和通信</h4>\n<p>容器组主要是为了数据共享和它们之间的通信。</p>\n<p>在一个容器组中，容器都使用相同的网络地址和端口，可以通过本地网络来相互通信。每个容器组都有独立的 IP，可用通过网络来和其他物理主机或者容器通信。</p>\n<p>容器组有一组存储卷（挂载点），主要是为了让容器在重启之后可以不丢失数据。</p>\n<h4 id="容器组管理"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组管理</h4>\n<p>容器组是一个应用管理和部署的高层次抽象，同时也是一组容器的接口。容器组是部署、水平放缩的最小单位。</p>\n<h4 id="容器组的使用"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的使用</h4>\n<p>容器组可以通过组合来构建复杂的应用，其本来的意义包含：</p>\n<ul>\n<li>内容管理，文件和数据加载以及本地缓存管理等。</li>\n<li>日志和检查点备份，压缩，快照等。</li>\n<li>监听数据变化，跟踪日志，日志和监控代理，消息发布等。</li>\n<li>代理，网桥</li>\n<li>控制器，管理，配置以及更新</li>\n</ul>\n<h4 id="替代方案"><a href="#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>替代方案</h4>\n<p>为什么不在一个单一的容器里运行多个程序？</p>\n<ul>\n<li>透明化。为了使容器组中的容器保持一致的基础设施和服务，比如进程管理和资源监控。这样设计是为了用户的便利性。</li>\n<li>解偶软件之间的依赖。每个容器都可能重新构建和发布，Kubernetes 必须支持热发布和热更新（将来）。</li>\n<li>方便使用。用户不必运行独立的程序管理，也不用担心每个应用程序的退出状态。</li>\n<li>高效。考虑到基础设施有更多的职责，容器必须要轻量化。</li>\n</ul>\n<h4 id="容器组的生命状态"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E7%94%9F%E5%91%BD%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的生命状态</h4>\n<p>包括若干状态值：pending、running、succeeded、failed。</p>\n<h5 id="pending"><a href="#pending" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pending</h5>\n<p>容器组已经被节点接受，但有一个或多个容器还没有运行起来。这将包含某些节点正在下载镜像的时间，这种情形会依赖于网络情况。</p>\n<h5 id="running"><a href="#running" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>running</h5>\n<p>容器组已经被调度到节点，并且所有的容器都已经启动。至少有一个容器处于运行状态（或者处于重启状态）。</p>\n<h5 id="succeeded"><a href="#succeeded" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>succeeded</h5>\n<p>所有的容器都正常退出。</p>\n<h5 id="failed"><a href="#failed" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>failed</h5>\n<p>容器组中所有容器都意外中断了。</p>\n<h4 id="容器组生命周期"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组生命周期</h4>\n<p>通常来说，如果容器组被创建了就不会自动销毁，除非被某种行为触发，而触发此种情况可能是人为，或者复制控制器所为。唯一例外的是容器组由 succeeded 状态成功退出，或者在一定时间内重试多次依然失败。</p>\n<p>如果某个节点死掉或者不能连接，那么节点控制器将会标记其上的容器组的状态为 failed。</p>\n<p>举例如下：</p>\n<ul>\n<li>\n<p>容器组状态 running，有 1 容器，容器正常退出</p>\n<ul>\n<li>记录完成事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：容器组变为 succeeded</li>\n<li>从不：容器组变为 succeeded</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 1 容器，容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 2 容器，有 1 容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组保持 running</li>\n</ul>\n</li>\n<li>\n<p>当有 2 容器退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>如果重启策略为：</li>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，容器内存不足</p>\n<ul>\n<li>标记容器错误中断</li>\n<li>记录内存不足事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：记录错误事件，容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，一块磁盘死掉</p>\n<ul>\n<li>杀死所有容器</li>\n<li>记录事件</li>\n<li>容器组变为 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，对应的节点段溢出</p>\n<ul>\n<li>节点控制器等到超时</li>\n<li>节点控制器标记容器组 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n</ul>\n<h3 id="replication-controllers"><a href="#replication-controllers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replication Controllers</h3>\n<h3 id="服务"><a href="#%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务</h3>\n<h3 id="卷"><a href="#%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>卷</h3>\n<h3 id="标签"><a href="#%E6%A0%87%E7%AD%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标签</h3>\n<h3 id="接口权限"><a href="#%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接口权限</h3>\n<h3 id="web-界面"><a href="#web-%E7%95%8C%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 界面</h3>\n<h3 id="命令行操作"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行操作</h3>\n<h2 id="基本架构"><a href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本架构</h2>\n<p>任何优秀的项目都离不开优秀的架构设计。本小节将介绍 Kubernetes 在架构方面的设计考虑。</p>\n<h3 id="基本考虑"><a href="#%E5%9F%BA%E6%9C%AC%E8%80%83%E8%99%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本考虑</h3>\n<p>如果让我们自己从头设计一套容器管理平台，有如下几个方面是很容易想到的：</p>\n<ul>\n<li>分布式架构，保证扩展性；</li>\n<li>逻辑集中式的控制平面 + 物理分布式的运行平面；</li>\n<li>一套资源调度系统，管理哪个容器该分配到哪个节点上；</li>\n<li>一套对容器内服务进行抽象和 HA 的系统。</li>\n</ul>\n<h3 id="运行原理"><a href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行原理</h3>\n<p>下面这张图完整展示了 Kubernetes 的运行原理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-ed8e3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.67736274755578%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAC40lEQVQ4y42Uy05TURSGdwvWBJo4cWhECZBooi/gSAdgQuLYqT6FM57AARMMjVPHJAQmJISJRChKS7nfb+VSWsqtLW3PZfv9h9QUUhNWsrL3Xnuvf/3rco4xyObmZmh7e7t5a2urmTUsm+u6JpVKmXpZW1sL1v7+/gfZbDZ5dHTUp7O1Njw5OXnzaH193dyVUql06zw1NWWOj4/N6elpaH9/XwAi0bu6uvpK92dnZ6Hz83NzdXV147CxsfEMZl/QPlh+qDFcWFgwIyMjppFMT09/RrsaXuL4iPTe8ODtyspKp2yVSsUsLS0F98PDwyEYtsIsure3Fz04OGidmJhow+cxBFogFJXCOmoODw+b7gZIp9NNpBBeXFwM7ubm5p4AmKZu+XK5nPU8L8c5c3l5mSWTHMFz1Wo1WM19hLQ7qKsDgC0WixZnS70sNgu4rRdDp3qI1kP93ieTyV5YdOdyuW4Y9s7Ozr4W4MzMTBtARZoiIO/i4sLDx+ONR0O8TCYT2LQ3iiAFxJKqvb6+1tlXNAC+C3B5efk57AqUx+bzeRdnF0AXAJcSuJByAXcBds3JyYnPYx9AHwcfEL9QKFQF6DjOVwHSnHaliHOQKnZbS18iGz6BGlL0BQq6D0OfaL4i6yEs/hDoE015CoNfOKZwSgCWZA20fs+bpIbU2d3ddQB0YOcA7uDoAFRSRB7ZnZ2dFurYxFA/HBgYiEgpQ2R0dDQyODgYicVigQ4NDUXM3S7VC0zjgLxjxtqp3U8C/mY04qQcZx8nYLCnFHHZpfo+Y7CLUY8YY1DTb1z+AOyjagjbLtVNY8LcBcG4/7e/NTb3kPDY2NgLApbUOHVYHVVn1XGYupQp6Dilcg3GsP4WjZSCB1/K+Pj4S4AqgKi7AlXD/Npwaw+gpsUahtkkEolbykCb+fl5w3caEiBrB85lDbamQqACEWOlrinRdCjA//MMh/UXCgD5CXSSZllscAocG6mY/wXzi5HTlj2WkwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 05" title="" data-src="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-fee1c.png" data-srcset="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-a67b7.png 200w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-0b187.png 400w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-fee1c.png 800w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-b1a91.png 1200w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-95179.png 1600w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-5d5ba.png 2400w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-ed8e3.png 3989w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可见，Kubernetes 首先是一套分布式系统，由多个节点组成，节点分为两类：一类是属于管理平面的主节点/控制节点（Master Node）；一类是属于运行平面的工作节点（Worker Node）。</p>\n<p>显然，复杂的工作肯定都交给控制节点去做了，工作节点负责提供稳定的操作接口和能力抽象即可。</p>\n<p>从这张图上，我们没有能发现 Kubernetes 中对于控制平面的分布式实现，但是由于数据后端自身就是一套分布式的数据库 Etcd，因此可以很容易扩展到分布式实现。</p>\n<h3 id="控制平面"><a href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>控制平面</h3>\n<h4 id="主节点服务"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h4>\n<p>主节点上需要提供如下的管理服务：</p>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供一套 RESTful 的 Kubernetes API，供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上。是 pluggable 的，意味着很容易选择其它实现方式；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h4 id="etcd"><a href="#etcd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Etcd</h4>\n<p>这里 Etcd 即作为数据后端，又作为消息中间件。</p>\n<p>通过 Etcd 来存储所有的主节点上的状态信息，很容易实现主节点的分布式扩展。</p>\n<p>组件可以自动的去侦测 Etcd 中的数值变化来获得通知，并且获得更新后的数据来执行相应的操作。</p>\n<h3 id="工作节点"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点</h3>\n<ul>\n<li>kubelet 是工作节点执行操作的 agent，负责具体的容器生命周期管理，根据从数据库中获取的信息来管理容器，并上报 pod 运行状态等；</li>\n<li>kube-proxy 是一个简单的网络访问代理，同时也是一个 Load Balancer。它负责将访问到某个服务的请求具体分配给工作节点上的 Pod（同一类标签）。</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 77.1875%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADYklEQVQ4y2MonHnQpnTZpf9Va2//r914/3/Fymv/q9bf/V+05PzhgoVn5lRvuPe/Yu2tP+Wrb/wvXnbxD5D9P2/+yVYg+yGIXbnuzr+ylVf/lwDNKF568T+DUu1s5czFZ18Vb7j3JnvZxVeF6++8bN7/8X/p8ssnMqbunV+/7RlI02+ghn91W5/+a9777n/GtL3d+QtOPa3b+uR/yfLL/yuBjmnc+Qqo7vZ/hl1zTkxcMe/U4ZULzhxeNf/M4XVLLh7qXHwh0ia+3NnILcy3YftTq4Di/lDX5Jrkmo13LYuWnHVUM3f1jW5eZle64qpN7pyjtkCXWQN9YJM5fZ8dw/X1D/5fXH4dhP9dXnnz//1NT/+enrxPlwECOBgQgBNKcwExPxAzAzEjkjp2MKshs12zLLnBpDSpzqwyrdkkI6LQTExURpeLn1vr////LN4pjnLOkVaywXkekv4ZLtLGzgYyyvqq3Hyi8jySKjo8UmoGXIIS8gLCMsp8weXTmGE2iwGxFBCLwFw1cU9GxdY3Tf+nH835v+hyyf/5F4r+zT1b+B8kNu9sYQhIDdBCBgzgbevPbGvkwColKs0jIiDKb2atzwMS796W4rX4cuna+eeKZ804lreye0vqjnlni+cvuly6smtLsiVIjZa5HDvUQWwMWIAEECsBsQI7J5s6lM8ElZMBYhYoWxToCUVuPk5BIJsXiKWBWACbgSD/MysoyLPADOqa0Kp6+cqlDafPnNp5/OSx3H0H9ub4hDmLMJAK5OUUmG7cuLH77du3/79///7/yZMnYPzv37//9+7dO3j69OmINWvWgGKawcvLixGnQdOmTYMxGa9du7b80aOHj+/fv/fuxfPn/x89fPgfSH/5+fPn/5cvX/4/ePCgIzRiGPG67tSZi6j8Gx/Fl61YWzpjzpKQuq4FMms27HCaN2++JlCKlYeHh42JiYkFmgYxDX7+/DlDsh2E3V+fxLZnXprx2RXJOuVRqpYTiqxt+kpcnXNDNa2hMSvMyMggBI0YcZAFGAaWlpYyrOqPA9vUXuQt+/JIw9eH+2r/n19f/P/kqoI/L480/n+0v+7l3iVl3ERHSFeJD9jAgng72d1z07/tX5D5f/us1P+bpiX9P7go6//m6clvajJcwGk1KdgMw5sAw+qSauVPs7gAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 36" title="" data-src="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png" data-srcset="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-5da91.png 200w,\n/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-08121.png 400w,\n/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="部署-kubernetes"><a href="#%E9%83%A8%E7%BD%B2-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 Kubernetes</h2>\n<p>目前，Kubernetes 支持在多种环境下使用，包括本地主机（Ubuntu、Debian、CentOS、Fedora 等）、云服务（腾讯云、阿里云、百度云等）。</p>\n<p>你可以使用以下几种方式部署 Kubernetes：</p>\n<ul>\n<li>kubeadm</li>\n<li>docker-desktop</li>\n<li>k3s</li>\n</ul>\n<p>接下来的小节会对以上几种方式进行详细介绍。</p>\n<h3 id="使用-kubeadm-部署-kubernetescri-使用-containerd"><a href="#%E4%BD%BF%E7%94%A8-kubeadm-%E9%83%A8%E7%BD%B2-kubernetescri-%E4%BD%BF%E7%94%A8-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 kubeadm 部署 kubernetes(CRI 使用 containerd)</h3>\n<p>kubeadm 提供了 kubeadm init 以及 kubeadm join 这两个命令作为快速创建 kubernetes 集群的最佳实践。</p>\n<h4 id="安装-containerd"><a href="#%E5%AE%89%E8%A3%85-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 containerd</h4>\n<p>参考 安装 Docker 一节添加 <code class="language-text">apt/yum</code> 源，之后执行如下命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79511777308027700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# debian 系\n\\$ sudo apt install containerd.io\n\n# rhel 系\n\\$ sudo yum install containerd.io`, `79511777308027700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># debian 系</span>\n$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> containerd.io\n\n<span class="token comment"># rhel 系</span>\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> containerd.io</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-containerd"><a href="#%E9%85%8D%E7%BD%AE-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 containerd</h4>\n<p>新建 <code class="language-text">/etc/systemd/system/cri-containerd.service</code> 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="136488703348858200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target`, `136488703348858200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 <code class="language-text">/etc/cri-containerd/config.toml</code> containerd 配置文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50203498441101860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version = 2\n# persistent data location\nroot = &quot;/var/lib/cri-containerd&quot;\n# runtime state information\nstate = &quot;/run/cri-containerd&quot;\nplugin_dir = &quot;&quot;\ndisabled_plugins = []\nrequired_plugins = []\n# set containerd\'s OOM score\noom_score = 0\n\n[grpc]\n  address = &quot;/run/cri-containerd/cri-containerd.sock&quot;\n  tcp_address = &quot;&quot;\n  tcp_tls_cert = &quot;&quot;\n  tcp_tls_key = &quot;&quot;\n  # socket uid\n  uid = 0\n  # socket gid\n  gid = 0\n  max_recv_message_size = 16777216\n  max_send_message_size = 16777216\n\n[debug]\n  address = &quot;&quot;\n  format = &quot;json&quot;\n  uid = 0\n  gid = 0\n  level = &quot;&quot;\n\n[metrics]\n  address = &quot;127.0.0.1:1338&quot;\n  grpc_histogram = false\n\n[cgroup]\n  path = &quot;&quot;\n\n[timeouts]\n  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;\n  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;\n\n[plugins]\n  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]\n    pause_threshold = 0.02\n    deletion_threshold = 0\n    mutation_threshold = 100\n    schedule_delay = &quot;0s&quot;\n    startup_delay = &quot;100ms&quot;\n  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]\n    disable_tcp_service = true\n    stream_server_address = &quot;127.0.0.1&quot;\n    stream_server_port = &quot;0&quot;\n    stream_idle_timeout = &quot;4h0m0s&quot;\n    enable_selinux = false\n    selinux_category_range = 1024\n    sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5&quot;\n    stats_collect_period = 10\n    # systemd_cgroup = false\n    enable_tls_streaming = false\n    max_container_log_line_size = 16384\n    disable_cgroup = false\n    disable_apparmor = false\n    restrict_oom_score_adj = false\n    max_concurrent_downloads = 3\n    disable_proc_mount = false\n    unset_seccomp_profile = &quot;&quot;\n    tolerate_missing_hugetlb_controller = true\n    disable_hugetlb_controller = true\n    ignore_image_defined_volumes = false\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]\n      snapshotter = &quot;overlayfs&quot;\n      default_runtime_name = &quot;runc&quot;\n      no_pivot = false\n      disable_snapshot_annotations = false\n      discard_unpacked_layers = false\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]\n        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]\n          runtime_type = &quot;io.containerd.runc.v2&quot;\n          pod_annotations = []\n          container_annotations = []\n          privileged_without_host_devices = false\n          base_runtime_spec = &quot;&quot;\n          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]\n            # SystemdCgroup enables systemd cgroups.\n            SystemdCgroup = true\n            # BinaryName is the binary name of the runc binary.\n            # BinaryName = &quot;runc&quot;\n            # BinaryName = &quot;crun&quot;\n            # NoPivotRoot disables pivot root when creating a container.\n            # NoPivotRoot = false\n\n            # NoNewKeyring disables new keyring for the container.\n            # NoNewKeyring = false\n\n            # ShimCgroup places the shim in a cgroup.\n            # ShimCgroup = &quot;&quot;\n\n            # IoUid sets the I/O\'s pipes uid.\n            # IoUid = 0\n\n            # IoGid sets the I/O\'s pipes gid.\n            # IoGid = 0\n\n            # Root is the runc root directory.\n            Root = &quot;&quot;\n\n            # CriuPath is the criu binary path.\n            # CriuPath = &quot;&quot;\n\n            # CriuImagePath is the criu image path\n            # CriuImagePath = &quot;&quot;\n\n            # CriuWorkPath is the criu work path.\n            # CriuWorkPath = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]\n      bin_dir = &quot;/opt/cni/bin&quot;\n      conf_dir = &quot;/etc/cni/net.d&quot;\n      max_conf_num = 1\n      conf_template = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]\n      config_path = &quot;/etc/cri-containerd/certs.d&quot;\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]\n        # Foo = [&quot;bar&quot;]\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]\n      key_model = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]\n      tls_cert_file = &quot;&quot;\n      tls_key_file = &quot;&quot;\n  [plugins.&quot;io.containerd.internal.v1.opt&quot;]\n    path = &quot;/opt/cri-containerd&quot;\n  [plugins.&quot;io.containerd.internal.v1.restart&quot;]\n    interval = &quot;10s&quot;\n  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]\n    content_sharing_policy = &quot;shared&quot;\n  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]\n    no_prometheus = false\n  [plugins.&quot;io.containerd.runtime.v2.task&quot;]\n    platforms = [&quot;linux/amd64&quot;]\n  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]\n    default = [&quot;walking&quot;]\n  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]\n    root_path = &quot;&quot;\n    pool_name = &quot;&quot;\n    base_image_size = &quot;&quot;\n    async_remove = false`, `50203498441101860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="toml"\n              >\n                <span class="gatsby-code-button-language">toml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="toml"><pre style="counter-reset: linenumber NaN" class="language-toml line-numbers"><code class="language-toml"><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token number">2</span>\n<span class="token comment"># persistent data location</span>\n<span class="token key property">root</span> <span class="token punctuation">=</span> <span class="token string">"/var/lib/cri-containerd"</span>\n<span class="token comment"># runtime state information</span>\n<span class="token key property">state</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd"</span>\n<span class="token key property">plugin_dir</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n<span class="token key property">disabled_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token key property">required_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token comment"># set containerd\'s OOM score</span>\n<span class="token key property">oom_score</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">grpc</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd/cri-containerd.sock"</span>\n  <span class="token key property">tcp_address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_cert</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_key</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token comment"># socket uid</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token comment"># socket gid</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">max_recv_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n  <span class="token key property">max_send_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">debug</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">format</span> <span class="token punctuation">=</span> <span class="token string">"json"</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">level</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">metrics</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1:1338"</span>\n  <span class="token key property">grpc_histogram</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">cgroup</span><span class="token punctuation">]</span>\n  <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">timeouts</span><span class="token punctuation">]</span>\n  <span class="token key property">"io.containerd.timeout.shim.cleanup"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.load"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.shutdown"</span> <span class="token punctuation">=</span> <span class="token string">"3s"</span>\n  <span class="token key property">"io.containerd.timeout.task.state"</span> <span class="token punctuation">=</span> <span class="token string">"2s"</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">plugins</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.gc.v1.scheduler"</span><span class="token punctuation">]</span>\n    <span class="token key property">pause_threshold</span> <span class="token punctuation">=</span> <span class="token number">0.02</span>\n    <span class="token key property">deletion_threshold</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n    <span class="token key property">mutation_threshold</span> <span class="token punctuation">=</span> <span class="token number">100</span>\n    <span class="token key property">schedule_delay</span> <span class="token punctuation">=</span> <span class="token string">"0s"</span>\n    <span class="token key property">startup_delay</span> <span class="token punctuation">=</span> <span class="token string">"100ms"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>\n    <span class="token key property">disable_tcp_service</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">stream_server_address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1"</span>\n    <span class="token key property">stream_server_port</span> <span class="token punctuation">=</span> <span class="token string">"0"</span>\n    <span class="token key property">stream_idle_timeout</span> <span class="token punctuation">=</span> <span class="token string">"4h0m0s"</span>\n    <span class="token key property">enable_selinux</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">selinux_category_range</span> <span class="token punctuation">=</span> <span class="token number">1024</span>\n    <span class="token key property">sandbox_image</span> <span class="token punctuation">=</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5"</span>\n    <span class="token key property">stats_collect_period</span> <span class="token punctuation">=</span> <span class="token number">10</span>\n    <span class="token comment"># systemd_cgroup = false</span>\n    <span class="token key property">enable_tls_streaming</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_container_log_line_size</span> <span class="token punctuation">=</span> <span class="token number">16384</span>\n    <span class="token key property">disable_cgroup</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">disable_apparmor</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">restrict_oom_score_adj</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_concurrent_downloads</span> <span class="token punctuation">=</span> <span class="token number">3</span>\n    <span class="token key property">disable_proc_mount</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">unset_seccomp_profile</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">tolerate_missing_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">disable_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">ignore_image_defined_volumes</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd</span><span class="token punctuation">]</span>\n      <span class="token key property">snapshotter</span> <span class="token punctuation">=</span> <span class="token string">"overlayfs"</span>\n      <span class="token key property">default_runtime_name</span> <span class="token punctuation">=</span> <span class="token string">"runc"</span>\n      <span class="token key property">no_pivot</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">disable_snapshot_annotations</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">discard_unpacked_layers</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes</span><span class="token punctuation">]</span>\n        <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc</span><span class="token punctuation">]</span>\n          <span class="token key property">runtime_type</span> <span class="token punctuation">=</span> <span class="token string">"io.containerd.runc.v2"</span>\n          <span class="token key property">pod_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">container_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">privileged_without_host_devices</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n          <span class="token key property">base_runtime_spec</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n          <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options</span><span class="token punctuation">]</span>\n            <span class="token comment"># SystemdCgroup enables systemd cgroups.</span>\n            <span class="token key property">SystemdCgroup</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n            <span class="token comment"># BinaryName is the binary name of the runc binary.</span>\n            <span class="token comment"># BinaryName = "runc"</span>\n            <span class="token comment"># BinaryName = "crun"</span>\n            <span class="token comment"># NoPivotRoot disables pivot root when creating a container.</span>\n            <span class="token comment"># NoPivotRoot = false</span>\n\n            <span class="token comment"># NoNewKeyring disables new keyring for the container.</span>\n            <span class="token comment"># NoNewKeyring = false</span>\n\n            <span class="token comment"># ShimCgroup places the shim in a cgroup.</span>\n            <span class="token comment"># ShimCgroup = ""</span>\n\n            <span class="token comment"># IoUid sets the I/O\'s pipes uid.</span>\n            <span class="token comment"># IoUid = 0</span>\n\n            <span class="token comment"># IoGid sets the I/O\'s pipes gid.</span>\n            <span class="token comment"># IoGid = 0</span>\n\n            <span class="token comment"># Root is the runc root directory.</span>\n            <span class="token key property">Root</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n            <span class="token comment"># CriuPath is the criu binary path.</span>\n            <span class="token comment"># CriuPath = ""</span>\n\n            <span class="token comment"># CriuImagePath is the criu image path</span>\n            <span class="token comment"># CriuImagePath = ""</span>\n\n            <span class="token comment"># CriuWorkPath is the criu work path.</span>\n            <span class="token comment"># CriuWorkPath = ""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".cni</span><span class="token punctuation">]</span>\n      <span class="token key property">bin_dir</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cni/bin"</span>\n      <span class="token key property">conf_dir</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cni/net.d"</span>\n      <span class="token key property">max_conf_num</span> <span class="token punctuation">=</span> <span class="token number">1</span>\n      <span class="token key property">conf_template</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry</span><span class="token punctuation">]</span>\n      <span class="token key property">config_path</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cri-containerd/certs.d"</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.headers</span><span class="token punctuation">]</span>\n        <span class="token comment"># Foo = ["bar"]</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".image_decryption</span><span class="token punctuation">]</span>\n      <span class="token key property">key_model</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".x509_key_pair_streaming</span><span class="token punctuation">]</span>\n      <span class="token key property">tls_cert_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n      <span class="token key property">tls_key_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.opt"</span><span class="token punctuation">]</span>\n    <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cri-containerd"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.restart"</span><span class="token punctuation">]</span>\n    <span class="token key property">interval</span> <span class="token punctuation">=</span> <span class="token string">"10s"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.metadata.v1.bolt"</span><span class="token punctuation">]</span>\n    <span class="token key property">content_sharing_policy</span> <span class="token punctuation">=</span> <span class="token string">"shared"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.monitor.v1.cgroups"</span><span class="token punctuation">]</span>\n    <span class="token key property">no_prometheus</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.runtime.v2.task"</span><span class="token punctuation">]</span>\n    <span class="token key property">platforms</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"linux/amd64"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.service.v1.diff-service"</span><span class="token punctuation">]</span>\n    <span class="token key property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"walking"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.snapshotter.v1.devmapper"</span><span class="token punctuation">]</span>\n    <span class="token key property">root_path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">pool_name</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">base_image_size</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">async_remove</span> <span class="token punctuation">=</span> <span class="token boolean">false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="安装-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni"><a href="#%E5%AE%89%E8%A3%85-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 kubelet kubeadm kubectl cri-tools kubernetes-cni</h4>\n<h5 id="ubuntudebian"><a href="#ubuntudebian" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ubuntu/Debian</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96411520585727100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ apt-get update && apt-get install -y apt-transport-https\n\\$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\n\n\\$ cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n\\$ apt-get update\n\\$ apt-get install -y kubelet kubeadm kubectl`, `96411520585727100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https\n$ <span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -\n\n$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n$ <span class="token function">apt-get</span> update\n$ <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="centosfedora"><a href="#centosfedora" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CentOS/Fedora</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96444815340990960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n\\$ sudo yum install -y kubelet kubeadm kubectl`, `96444815340990960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo\n<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>\n<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes\n<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\n<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="修改内核的运行参数"><a href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改内核的运行参数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82408453237010320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用配置\n\\$ sysctl --system`, `82408453237010320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  <span class="token operator">=</span> <span class="token number">1</span>\nnet.ipv4.ip_forward                 <span class="token operator">=</span> <span class="token number">1</span>\nnet.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>\nEOF\n\n<span class="token comment"># 应用配置</span>\n$ sysctl --system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-kubelet"><a href="#%E9%85%8D%E7%BD%AE-kubelet" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 kubelet</h4>\n<h5 id="修改-kubeletservice"><a href="#%E4%BF%AE%E6%94%B9-kubeletservice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改 kubelet.service</h5>\n<p><code class="language-text">/etc/systemd/system/kubelet.service.d/10-proxy-ipvs.conf</code> 写入以下内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73333827171745610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 启用 ipvs 相关内核模块\n[Service]\nExecStartPre=-/sbin/modprobe ip_vs\nExecStartPre=-/sbin/modprobe ip_vs_rr\nExecStartPre=-/sbin/modprobe ip_vs_wrr\nExecStartPre=-/sbin/modprobe ip_vs_sh`, `73333827171745610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 启用 ipvs 相关内核模块</span>\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_rr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_wrr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行以下命令应用配置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80767568973843250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl daemon-reload`, `80767568973843250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl daemon-reload</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="部署"><a href="#%E9%83%A8%E7%BD%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<h5 id="master"><a href="#master" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92292920005459020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ sudo kubeadm init \\\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \\\n      --pod-network-cidr 10.244.0.0/16 \\\n      --cri-socket /run/cri-containerd/cri-containerd.sock \\\n      --v 5 \\\n      --ignore-preflight-errors=all`, `92292920005459020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ <span class="token function">sudo</span> kubeadm init <span class="token punctuation">\\</span>\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="token punctuation">\\</span>\n      --pod-network-cidr <span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\\</span>\n      --cri-socket /run/cri-containerd/cri-containerd.sock <span class="token punctuation">\\</span>\n      --v <span class="token number">5</span> <span class="token punctuation">\\</span>\n      --ignore-preflight-errors<span class="token operator">=</span>all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">--pod-network-cidr 10.244.0.0/16</code> 参数与后续 CNI 插件有关，这里以 flannel 为例，若后续部署其他类型的网络插件请更改此参数。执行可能出现错误，例如缺少依赖包，根据提示安装即可。</p>\n<p>执行成功会输出</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52734036106281910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`...\n[addons] Applied essential addon: CoreDNS\nI1116 12:35:13.270407   86677 request.go:538] Throttling request took 181.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 12:35:13.470292   86677 request.go:538] Throttling request took 186.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p \\$HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config\n  sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.199.100:6443 --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe`, `52734036106281910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS\nI1116 <span class="token number">12</span>:35:13.270407   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">181</span>.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 <span class="token number">12</span>:35:13.470292   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">186</span>.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully<span class="token operator">!</span>\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube\n  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config\n  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:\n\nkubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="node-工作节点"><a href="#node-%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node 工作节点</h5>\n<p>在另一主机重复部署小节以前的步骤，安装配置好 kubelet。根据提示，加入到集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15890913254060202000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ kubeadm join 192.168.199.100:6443 \\\n    --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe \\\n    --cri-socket /run/cri-containerd/cri-containerd.sock`, `15890913254060202000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 <span class="token punctuation">\\</span>\n    --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe <span class="token punctuation">\\</span>\n    --cri-socket /run/cri-containerd/cri-containerd.sock</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看服务-2"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h4>\n<p>所有服务启动后，通过 crictl 查看本地实际运行的容器。这些服务大概分为三类：主节点服务、工作节点服务和其它服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79995707567750200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CONTAINER_RUNTIME_ENDPOINT=/run/cri-containerd/cri-containerd.sock crictl ps -a`, `79995707567750200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">CONTAINER_RUNTIME_ENDPOINT</span><span class="token operator">=</span>/run/cri-containerd/cri-containerd.sock crictl <span class="token function">ps</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h5 id="主节点服务-1"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h5>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供 RESTful 方式供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h5 id="工作节点服务"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点服务</h5>\n<p>proxy 为 pod 上的服务提供访问的代理。</p>\n<h5 id="其它服务"><a href="#%E5%85%B6%E5%AE%83%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它服务</h5>\n<p>Etcd 是所有状态的存储数据库；</p>\n<h4 id="使用-3"><a href="#%E4%BD%BF%E7%94%A8-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h4>\n<p>将 <code class="language-text">/etc/kubernetes/admin.conf</code> 复制到 <code class="language-text">~/.kube/config</code></p>\n<p>执行 <code class="language-text">$ kubectl get all -A</code> 查看启动的服务。</p>\n<p>由于未部署 CNI 插件，CoreDNS 未正常启动。如何使用 Kubernetes，请参考后续章节。</p>\n<h4 id="部署-cni"><a href="#%E9%83%A8%E7%BD%B2-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 CNI</h4>\n<p>这里以 flannel 为例进行介绍。</p>\n<h5 id="flannel"><a href="#flannel" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flannel</h5>\n<p>检查 podCIDR 设置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80507226079060820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl get node -o yaml | grep CIDR\n\n# 输出\n    podCIDR: 10.244.0.0/16\n    podCIDRs:`, `80507226079060820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl get node -o yaml <span class="token operator">|</span> <span class="token function">grep</span> CIDR\n\n<span class="token comment"># 输出</span>\n    podCIDR: <span class="token number">10.244</span>.0.0/16\n    podCIDRs:</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25694700945601890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml`, `25694700945601890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="master-节点默认不能运行-pod"><a href="#master-%E8%8A%82%E7%82%B9%E9%BB%98%E8%AE%A4%E4%B8%8D%E8%83%BD%E8%BF%90%E8%A1%8C-pod" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master 节点默认不能运行 pod</h4>\n<p>如果用 kubeadm 部署一个单节点集群，默认情况下无法使用，请执行以下命令解除限制</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97943376873624220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n# 恢复默认值\n# \\$ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule`, `97943376873624220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n<span class="token comment"># 恢复默认值</span>\n<span class="token comment"># $ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="docker-desktop-启用-kubernetes"><a href="#docker-desktop-%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Desktop 启用 Kubernetes</h3>\n<p>使用 Docker Desktop 可以很方便的启用 Kubernetes，由于国内获取不到 k8s.gcr.io 镜像，我们必须首先解决这一问题。</p>\n<h4 id="获取-k8sgcrio-镜像"><a href="#%E8%8E%B7%E5%8F%96-k8sgcrio-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取 k8s.gcr.io 镜像</h4>\n<p>由于国内拉取不到 k8s.gcr.io 镜像，我们可以使用开源项目 <a href="https://github.com/AliyunContainerService/k8s-for-docker-desktop" target="_blank" rel="nofollow noreferrer noopener">AliyunContainerService/k8s-for-docker-desktop</a> 来获取所需的镜像。</p>\n<h4 id="启用-kubernetes"><a href="#%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启用 Kubernetes</h4>\n<p>在 Docker Desktop 设置页面，点击 Kubernetes，选择 Enable Kubernetes，稍等片刻，看到左下方 Kubernetes 变为 running，Kubernetes 启动成功。</p>\n<h4 id="测试-1"><a href="#%E6%B5%8B%E8%AF%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4286249625539451000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl version`, `4286249625539451000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl version</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果正常输出信息，则证明 Kubernetes 成功启动。</p>\n<h3 id="一步步部署-kubernetes-集群"><a href="#%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一步步部署 kubernetes 集群</h3>\n<p>可以参考 <a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="nofollow noreferrer noopener">opsnull/follow-me-install-kubernetes-cluster</a> 项目一步步部署 kubernetes 集群。</p>\n<h3 id="kubernetes-dashboard"><a href="#kubernetes-dashboard" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes Dashboard</h3>\n<p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="nofollow noreferrer noopener">Kubernetes Dashboard</a> 是基于网页的 Kubernetes 用户界面。</p>\n<h4 id="部署-1"><a href="#%E9%83%A8%E7%BD%B2-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<p>执行以下命令即可部署 Dashboard：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4367983132852671000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml`, `4367983132852671000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="访问"><a href="#%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问</h4>\n<p>通过命令行代理访问，执行以下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57976252888828550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl proxy`, `57976252888828550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl proxy</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>到 <code class="language-text">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code> 即可访问。</p>\n<h4 id="登录-1"><a href="#%E7%99%BB%E5%BD%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h4>\n<p>目前，Dashboard 仅支持使用 Bearer 令牌登录。下面教大家如何创建该令牌：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47108077463011200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl create sa dashboard-admin -n kube-system\n\n\\$ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\n\n\\$ ADMIN_SECRET=\\$(kubectl get secrets -n kube-system | grep dashboard-admin | awk \'{print \\$1}\')\n\n\\$ DASHBOARD_LOGIN_TOKEN=\\$(kubectl describe secret -n kube-system \\${ADMIN_SECRET} | grep -E \'^token\' | awk \'{print \\$2}\')\n\necho \\${DASHBOARD_LOGIN_TOKEN}`, `47108077463011200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl create sa dashboard-admin -n kube-system\n\n$ kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin\n\n$ <span class="token assign-left variable">ADMIN_SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secrets -n kube-system <span class="token operator">|</span> <span class="token function">grep</span> dashboard-admin <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$1</span>}\'</span><span class="token variable">)</span></span>\n\n$ <span class="token assign-left variable">DASHBOARD_LOGIN_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl describe secret -n kube-system $<span class="token punctuation">{</span>ADMIN_SECRET<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">\'^token\'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$2</span>}\'</span><span class="token variable">)</span></span>\n\n<span class="token builtin class-name">echo</span> <span class="token variable">${DASHBOARD_LOGIN_TOKEN}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将结果粘贴到登录页面，即可登录。</p>\n<h2 id="kubernetes-命令行-kubectl"><a href="#kubernetes-%E5%91%BD%E4%BB%A4%E8%A1%8C-kubectl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes 命令行 kubectl</h2>\n<h3 id="kubectl-使用"><a href="#kubectl-%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl 使用</h3>\n<p><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="nofollow noreferrer noopener">kubectl</a> 是 Kubernetes 自带的客户端，可以用它来直接操作 Kubernetes。</p>\n<p>使用格式有两种：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83156096155056690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl [flags]\nkubectl [command]`, `83156096155056690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>\nkubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="get"><a href="#get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>get</h4>\n<p>显示一个或多个资源</p>\n<h4 id="describe"><a href="#describe" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>describe</h4>\n<p>显示资源详情</p>\n<h4 id="create"><a href="#create" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>create</h4>\n<p>从文件或标准输入创建资源</p>\n<h4 id="update"><a href="#update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update</h4>\n<p>从文件或标准输入更新资源</p>\n<h4 id="delete"><a href="#delete" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>delete</h4>\n<p>通过文件名、标准输入、资源名或者 label selector 删除资源</p>\n<h4 id="log"><a href="#log" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>log</h4>\n<p>输出 pod 中一个容器的日志</p>\n<h4 id="rolling-update"><a href="#rolling-update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rolling-update</h4>\n<p>对指定的 replication controller 执行滚动升级</p>\n<h4 id="exec-1"><a href="#exec-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>在容器内部执行命令</p>\n<h4 id="port-forward"><a href="#port-forward" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port-forward</h4>\n<p>将本地端口转发到 Pod</p>\n<h4 id="proxy"><a href="#proxy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>proxy</h4>\n<p>为 Kubernetes API server 启动代理服务器</p>\n<h4 id="run-2"><a href="#run-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>在集群中使用指定镜像启动容器</p>\n<h4 id="expose-2"><a href="#expose-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h4>\n<p>将 <code class="language-text">replication controller service</code> 或 pod 暴露为新的 <code class="language-text">kubernetes service</code></p>\n<h4 id="label-1"><a href="#label-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>label</h4>\n<p>更新资源的 label</p>\n<h4 id="config-1"><a href="#config-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>修改 kubernetes 配置文件</p>\n<h4 id="cluster-info"><a href="#cluster-info" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cluster-info</h4>\n<p>显示集群信息</p>\n<h4 id="api-versions"><a href="#api-versions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>api-versions</h4>\n<p>以 “组/版本” 的格式输出服务端支持的 API 版本</p>\n<h4 id="version-1"><a href="#version-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>输出服务端和客户端的版本信息</p>\n<h4 id="help-1"><a href="#help-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>显示各个命令的帮助信息</p>\n<h3 id="常用命令"><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用命令</h3>\n<p>使用以下示例集来帮助你熟悉运行常用 kubectl 操作：</p>\n<h4 id="kubectl-apply---以文件或标准输入为准应用或更新资源"><a href="#kubectl-apply---%E4%BB%A5%E6%96%87%E4%BB%B6%E6%88%96%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%BA%E5%87%86%E5%BA%94%E7%94%A8%E6%88%96%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl apply - 以文件或标准输入为准应用或更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19904826158279890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 example-service.yaml 中的定义创建服务。\nkubectl apply -f example-service.yaml\n\n# 使用 example-controller.yaml 中的定义创建 replication controller。\nkubectl apply -f example-controller.yaml\n\n# 使用 <directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。\nkubectl apply -f <directory>`, `19904826158279890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 example-service.yaml 中的定义创建服务。</span>\nkubectl apply -f example-service.yaml\n\n<span class="token comment"># 使用 example-controller.yaml 中的定义创建 replication controller。</span>\nkubectl apply -f example-controller.yaml\n\n<span class="token comment"># 使用 &lt;directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。</span>\nkubectl apply -f <span class="token operator">&lt;</span>directory<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-get---列出一个或多个资源"><a href="#kubectl-get---%E5%88%97%E5%87%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl get - 列出一个或多个资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65901840357942160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 以纯文本输出格式列出所有 Pod。\nkubectl get pods\n\n# 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。\nkubectl get pods -o wide\n\n# 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。\nkubectl get replicationcontroller <rc-name>\n\n# 以纯文本输出格式列出所有副本控制器和服务。\nkubectl get rc,services\n\n# 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。\nkubectl get ds --include-uninitialized\n\n# 列出在节点 server01 上运行的所有 Pod\nkubectl get pods --field-selector=spec.nodeName=server01`, `65901840357942160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 以纯文本输出格式列出所有 Pod。</span>\nkubectl get pods\n\n<span class="token comment"># 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。</span>\nkubectl get pods -o wide\n\n<span class="token comment"># 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。</span>\nkubectl get replicationcontroller <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 以纯文本输出格式列出所有副本控制器和服务。</span>\nkubectl get rc,services\n\n<span class="token comment"># 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。</span>\nkubectl get ds --include-uninitialized\n\n<span class="token comment"># 列出在节点 server01 上运行的所有 Pod</span>\nkubectl get pods --field-selector<span class="token operator">=</span>spec.nodeName<span class="token operator">=</span>server01</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-describe---显示一个或多个资源的详细状态，默认情况下包括未初始化的资源"><a href="#kubectl-describe---%E6%98%BE%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%AF%A6%E7%BB%86%E7%8A%B6%E6%80%81%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E5%8C%85%E6%8B%AC%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl describe - 显示一个或多个资源的详细状态，默认情况下包括未初始化的资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86433006280095020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe nodes <node-name>\n\n# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe pods/<pod-name>\n\n# 显示由名为 <rc-name> 的副本控制器管理的所有 Pod 的详细信息。\n# 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。\nkubectl describe pods <rc-name>\n\n# 描述所有的 Pod\nkubectl describe pods`, `86433006280095020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe nodes <span class="token operator">&lt;</span>node-name<span class="token operator">></span>\n\n<span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe pods/<span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 显示由名为 &lt;rc-name> 的副本控制器管理的所有 Pod 的详细信息。</span>\n<span class="token comment"># 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。</span>\nkubectl describe pods <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 描述所有的 Pod</span>\nkubectl describe pods</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明： <code class="language-text">kubectl get</code> 命令通常用于检索同一资源类别的一个或多个资源。它具有丰富的参数，允许你使用 <code class="language-text">-o</code> 或 <code class="language-text">--output</code> 参数自定义输出格式。你可以指定 <code class="language-text">-w</code> 或 <code class="language-text">--watch</code> 参数以开始监测特定对象的更新。<code class="language-text">kubectl describe</code> 命令更侧重于描述指定资源的许多相关方面。它可以调用对 API 服务器的多个 API 调用来为用户构建视图。 例如，该 <code class="language-text">kubectl describe node</code> 命令不仅检索有关节点的信息，还检索在其上运行的 Pod 的摘要，为节点生成的事件等。</p>\n</blockquote>\n<h4 id="kubectl-delete---基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源"><a href="#kubectl-delete---%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E6%88%96%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8%E3%80%81%E5%90%8D%E7%A7%B0%E3%80%81%E8%B5%84%E6%BA%90%E9%80%89%E6%8B%A9%E5%99%A8%E6%88%96%E8%B5%84%E6%BA%90%E6%9D%A5%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl delete - 基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54190270829267730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 pod.yaml 文件中指定的类型和名称删除 Pod。\nkubectl delete -f pod.yaml\n\n# 删除所有带有 \'<label-key>=<label-value>\' 标签的 Pod 和服务。\nkubectl delete pods,services -l <label-key>=<label-value>\n\n# 删除所有 Pod，包括未初始化的 Pod。\nkubectl delete pods --all`, `54190270829267730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 pod.yaml 文件中指定的类型和名称删除 Pod。</span>\nkubectl delete -f pod.yaml\n\n<span class="token comment"># 删除所有带有 \'&lt;label-key>=&lt;label-value>\' 标签的 Pod 和服务。</span>\nkubectl delete pods,services -l <span class="token operator">&lt;</span>label-key<span class="token operator">></span><span class="token operator">=</span><span class="token operator">&lt;</span>label-value<span class="token operator">></span>\n\n<span class="token comment"># 删除所有 Pod，包括未初始化的 Pod。</span>\nkubectl delete pods --all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-exec---对-pod-中的容器执行命令"><a href="#kubectl-exec---%E5%AF%B9-pod-%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl exec - 对 Pod 中的容器执行命令</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11305457843548260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 从 Pod <pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。\nkubectl exec <pod-name> -- date\n\n# 运行输出 \'date\' 获取在 Pod <pod-name> 中容器 <container-name> 的输出。\nkubectl exec <pod-name> -c <container-name> -- date\n\n# 获取一个交互 TTY 并在 Pod <pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。\nkubectl exec -ti <pod-name> -- /bin/bash`, `11305457843548260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 从 Pod &lt;pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 运行输出 \'date\' 获取在 Pod &lt;pod-name> 中容器 &lt;container-name> 的输出。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -c <span class="token operator">&lt;</span>container-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 获取一个交互 TTY 并在 Pod &lt;pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> -ti <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- /bin/bash</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-logs---打印-pod-中容器的日志"><a href="#kubectl-logs---%E6%89%93%E5%8D%B0-pod-%E4%B8%AD%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl logs - 打印 Pod 中容器的日志</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14734679937033413000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 返回 Pod <pod-name> 的日志快照。\nkubectl logs <pod-name>\n\n# 从 Pod <pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。\nkubectl logs -f <pod-name>`, `14734679937033413000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 返回 Pod &lt;pod-name> 的日志快照。</span>\nkubectl logs <span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 从 Pod &lt;pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。</span>\nkubectl logs -f <span class="token operator">&lt;</span>pod-name<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-diff---查看集群建议更新的差异"><a href="#kubectl-diff---%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E5%BB%BA%E8%AE%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%B7%AE%E5%BC%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl diff - 查看集群建议更新的差异</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31957140077234870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# “pod.json”中包含的差异资源。\nkubectl diff -f pod.json\n\n# 从标准输入读取的差异文件。\ncat service.yaml | kubectl diff -f -`, `31957140077234870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># “pod.json”中包含的差异资源。</span>\nkubectl <span class="token function">diff</span> -f pod.json\n\n<span class="token comment"># 从标准输入读取的差异文件。</span>\n<span class="token function">cat</span> service.yaml <span class="token operator">|</span> kubectl <span class="token function">diff</span> -f -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-自动补全"><a href="#kubectl-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 自动补全</h4>\n<h5 id="bash"><a href="#bash" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BASH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36014666453974864000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。\necho &quot;source <(kubectl completion bash)&quot; >> ~/.bashrc # 在您的 bash shell 中永久的添加自动补全`, `36014666453974864000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span> <span class="token comment"># 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span>\n<span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span> ~/.bashrc <span class="token comment"># 在您的 bash shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50648111530905936000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`alias k=kubectl\ncomplete -o default -F __start_kubectl k`, `50648111530905936000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">k</span><span class="token operator">=</span>kubectl\ncomplete -o default -F __start_kubectl k</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="zsh"><a href="#zsh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZSH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85186263652559300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion zsh)  # 在 zsh 中设置当前 shell 的自动补全\necho \'[[ \\$commands[kubectl] ]] && source <(kubectl completion zsh)\' >> ~/.zshrc # 在您的 zsh shell 中永久的添加自动补全`, `85186263652559300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">zsh</span><span class="token punctuation">)</span>  <span class="token comment"># 在 zsh 中设置当前 shell 的自动补全</span>\n<span class="token builtin class-name">echo</span> <span class="token string">\'[[ <span class="token variable">$commands</span>[kubectl] ]] &amp;&amp; source &lt;(kubectl completion zsh)\'</span> <span class="token operator">>></span> ~/.zshrc <span class="token comment"># 在您的 zsh shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="关于---all-namespaces-的一点说明"><a href="#%E5%85%B3%E4%BA%8E---all-namespaces-%E7%9A%84%E4%B8%80%E7%82%B9%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于 <code class="language-text">--all-namespaces</code> 的一点说明</h5>\n<p>我们经常用到 <code class="language-text">--all-namespaces</code> 参数，你应该要知道它的简写 <code class="language-text">kubectl -A</code></p>\n<h4 id="kubectl-上下文和配置"><a href="#kubectl-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 上下文和配置</h4>\n<p>设置 kubectl 与哪个 Kubernetes 集群进行通信并修改配置信息。查看使用 kubeconfig 跨集群授权访问 文档获取配置文件详细信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27776552045408186000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl config view # 显示合并的 kubeconfig 配置。\n\n# 同时使用多个 kubeconfig 文件并查看合并的配置\nKUBECONFIG=~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n# 获取 e2e 用户的密码\nkubectl config view -o jsonpath=\'{.users[?(@.name == &quot;e2e&quot;)].user.password}\'\n\nkubectl config view -o jsonpath=\'{.users[].name}\'    # 显示第一个用户\nkubectl config view -o jsonpath=\'{.users[*].name}\'   # 获取用户列表\nkubectl config get-contexts                          # 显示上下文列表\nkubectl config current-context                       # 展示当前所处的上下文\nkubectl config use-context my-cluster-name           # 设置默认的上下文为 my-cluster-name\n\n# 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username=kubeuser --password=kubepassword\n\n# 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用\nkubectl config set-context --current --namespace=ggckad-s2\n\n# 使用特定的用户名和名字空间设置上下文\nkubectl config set-context gce --user=cluster-admin --namespace=foo \\\n  && kubectl config use-context gce\n\nkubectl config unset users.foo                       # 删除用户 foo\n\n# 设置或显示 context / namespace 的短别名\n# （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）\nalias kx=\'f() { [ &quot;\\$1&quot; ] && kubectl config use-context \\$1 || kubectl config current-context ; } ; f\'\nalias kn=\'f() { [ &quot;\\$1&quot; ] && kubectl config set-context --current --namespace \\$1 || kubectl config view --minify | grep namespace | cut -d&quot; &quot; -f6 ; } ; f\'`, `27776552045408186000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl config view <span class="token comment"># 显示合并的 kubeconfig 配置。</span>\n\n<span class="token comment"># 同时使用多个 kubeconfig 文件并查看合并的配置</span>\n<span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n<span class="token comment"># 获取 e2e 用户的密码</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[?(@.name == "e2e")].user.password}\'</span>\n\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[].name}\'</span>    <span class="token comment"># 显示第一个用户</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[*].name}\'</span>   <span class="token comment"># 获取用户列表</span>\nkubectl config get-contexts                          <span class="token comment"># 显示上下文列表</span>\nkubectl config current-context                       <span class="token comment"># 展示当前所处的上下文</span>\nkubectl config use-context my-cluster-name           <span class="token comment"># 设置默认的上下文为 my-cluster-name</span>\n\n<span class="token comment"># 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证</span>\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username<span class="token operator">=</span>kubeuser --password<span class="token operator">=</span>kubepassword\n\n<span class="token comment"># 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用</span>\nkubectl config set-context --current --namespace<span class="token operator">=</span>ggckad-s2\n\n<span class="token comment"># 使用特定的用户名和名字空间设置上下文</span>\nkubectl config set-context gce --user<span class="token operator">=</span>cluster-admin --namespace<span class="token operator">=</span>foo <span class="token punctuation">\\</span>\n  <span class="token operator">&amp;&amp;</span> kubectl config use-context gce\n\nkubectl config <span class="token builtin class-name">unset</span> users.foo                       <span class="token comment"># 删除用户 foo</span>\n\n<span class="token comment"># 设置或显示 context / namespace 的短别名</span>\n<span class="token comment"># （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kx</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config use-context <span class="token variable">$1</span> || kubectl config current-context ; } ; f\'</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kn</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config set-context --current --namespace <span class="token variable">$1</span> || kubectl config view --minify | grep namespace | cut -d" " -f6 ; } ; f\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-apply"><a href="#kubectl-apply" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl apply</h4>\n<p>apply 通过定义 Kubernetes 资源的文件来管理应用。它通过运行 kubectl apply 在集群中创建和更新资源。这是在生产中管理 Kubernetes 应用的推荐方法。 参见 <a href="https://kubectl.docs.kubernetes.io/zh/" target="_blank" rel="nofollow noreferrer noopener">Kubectl 文档</a>。</p>\n<h4 id="创建对象"><a href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建对象</h4>\n<p>Kubernetes 配置可以用 YAML 或 JSON 定义。可以使用的文件扩展名有 <code class="language-text">.yaml</code>、<code class="language-text">.yml</code> 和 <code class="language-text">.json</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57244196969656770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f ./my-manifest.yaml           # 创建资源\nkubectl apply -f ./my1.yaml -f ./my2.yaml     # 使用多个文件创建\nkubectl apply -f ./dir                        # 基于目录下的所有清单文件创建资源\nkubectl apply -f https://git.io/vPieo         # 从 URL 中创建资源\nkubectl create deployment nginx --image=nginx # 启动单实例 nginx\n\n# 创建一个打印 “Hello World” 的 Job\nkubectl create job hello --image=busybox:1.28 -- echo &quot;Hello World&quot;\n\n# 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob\nkubectl create cronjob hello --image=busybox:1.28 --schedule=&quot;*/1 * * * *&quot; -- echo &quot;Hello World&quot;\n\nkubectl explain pods                          # 获取 pod 清单的文档说明\n\n# 从标准输入创建多个 YAML 对象\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000000&quot;\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000&quot;\nEOF\n\n# 创建有多个 key 的 Secret\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: \\$(echo -n &quot;s33msi4&quot; | base64 -w0)\n  username: \\$(echo -n &quot;jane&quot; | base64 -w0)\nEOF`, `57244196969656770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f ./my-manifest.yaml           <span class="token comment"># 创建资源</span>\nkubectl apply -f ./my1.yaml -f ./my2.yaml     <span class="token comment"># 使用多个文件创建</span>\nkubectl apply -f ./dir                        <span class="token comment"># 基于目录下的所有清单文件创建资源</span>\nkubectl apply -f https://git.io/vPieo         <span class="token comment"># 从 URL 中创建资源</span>\nkubectl create deployment nginx --image<span class="token operator">=</span>nginx <span class="token comment"># 启动单实例 nginx</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 的 Job</span>\nkubectl create job hello --image<span class="token operator">=</span>busybox:1.28 -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob</span>\nkubectl create cronjob hello --image<span class="token operator">=</span>busybox:1.28 --schedule<span class="token operator">=</span><span class="token string">"*/1 * * * *"</span> -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\nkubectl explain pods                          <span class="token comment"># 获取 pod 清单的文档说明</span>\n\n<span class="token comment"># 从标准输入创建多个 YAML 对象</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000000"</span>\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000"</span>\nEOF\n\n<span class="token comment"># 创建有多个 key 的 Secret</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"s33msi4"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\n  username: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"jane"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\nEOF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看和查找资源"><a href="#%E6%9F%A5%E7%9C%8B%E5%92%8C%E6%9F%A5%E6%89%BE%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看和查找资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44218362662705580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# get 命令的基本输出\nkubectl get services                          # 列出当前命名空间下的所有 services\nkubectl get pods --all-namespaces             # 列出所有命名空间下的全部的 Pods\nkubectl get pods -o wide                      # 列出当前命名空间下的全部 Pods，并显示更详细的信息\nkubectl get deployment my-dep                 # 列出某个特定的 Deployment\nkubectl get pods                              # 列出当前命名空间下的全部 Pods\nkubectl get pod my-pod -o yaml                # 获取一个 pod 的 YAML\n\n# describe 命令的详细输出\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n# 列出当前名字空间下所有 Services，按名称排序\nkubectl get services --sort-by=.metadata.name\n\n# 列出 Pods，按重启次数排序\nkubectl get pods --sort-by=\'.status.containerStatuses[0].restartCount\'\n\n# 列举所有 PV 持久卷，按容量排序\nkubectl get pv --sort-by=.spec.capacity.storage\n\n# 获取包含 app=cassandra 标签的所有 Pods 的 version 标签\nkubectl get pods --selector=app=cassandra -o \\\n  jsonpath=\'{.items[*].metadata.labels.version}\'\n\n# 检索带有 “.” 键值，例： \'ca.crt\'\nkubectl get configmap myconfig \\\n  -o jsonpath=\'{.data.ca\\.crt}\'\n\n# 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。\nkubectl get secret my-secret --template=\'{{index .data &quot;key-name-with-dashes&quot;}}\'\n\n# 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）\nkubectl get node --selector=\'!node-role.kubernetes.io/control-plane\'\n\n# 获取当前命名空间中正在运行的 Pods\nkubectl get pods --field-selector=status.phase=Running\n\n# 获取全部节点的 ExternalIP 地址\nkubectl get nodes -o jsonpath=\'{.items[*].status.addresses[?(@.type==&quot;ExternalIP&quot;)].address}\'\n\n# 列出属于某个特定 RC 的 Pods 的名称\n# 在转换对于 jsonpath 过于复杂的场合，&quot;jq&quot; 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。\nsel=\\${\\$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .[] | &quot;\\(.key)=\\(.value),&quot;\')%?}\necho \\$(kubectl get pods --selector=\\$sel --output=jsonpath={.items..metadata.name})\n\n# 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）\nkubectl get pods --show-labels\n\n# 检查哪些节点处于就绪状态\nJSONPATH=\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\' \\\n && kubectl get nodes -o jsonpath=&quot;\\$JSONPATH&quot; | grep &quot;Ready=True&quot;\n\n# 不使用外部工具来输出解码后的 Secret\nkubectl get secret my-secret -o go-template=\'{{range \\$k,\\$v := .data}}{{&quot;### &quot;}}{{\\$k}}{{&quot;\\n&quot;}}{{\\$v|base64decode}}{{&quot;\\n\\n&quot;}}{{end}}\'\n\n# 列出被一个 Pod 使用的全部 Secret\nkubectl get pods -o json | jq \'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\' | grep -v null | sort | uniq\n\n# 列举所有 Pods 中初始化容器的容器 ID（containerID）\n# 可用于在清理已停止的容器时避免删除初始化容器\nkubectl get pods --all-namespaces -o jsonpath=\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{&quot;\\n&quot;}{end}\' | cut -d/ -f3\n\n# 列出事件（Events），按时间戳排序\nkubectl get events --sort-by=.metadata.creationTimestamp\n\n# 比较当前的集群状态和假定某清单被应用之后的集群状态\nkubectl diff -f ./my-manifest.yaml\n\n# 生成一个句点分隔的树，其中包含为节点返回的所有键\n# 在复杂的嵌套JSON结构中定位键时非常有用\nkubectl get nodes -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 生成一个句点分隔的树，其中包含为pod等返回的所有键\nkubectl get pods -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。\n# 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。\nfor pod in \\$(kubectl get po --output=jsonpath={.items..metadata.name}); do echo \\$pod && kubectl exec -it \\$pod -- env; done\n\n# 获取一个 Deployment 的 status 子资源\nkubectl get deployment nginx-deployment --subresource=status`, `44218362662705580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># get 命令的基本输出</span>\nkubectl get services                          <span class="token comment"># 列出当前命名空间下的所有 services</span>\nkubectl get pods --all-namespaces             <span class="token comment"># 列出所有命名空间下的全部的 Pods</span>\nkubectl get pods -o wide                      <span class="token comment"># 列出当前命名空间下的全部 Pods，并显示更详细的信息</span>\nkubectl get deployment my-dep                 <span class="token comment"># 列出某个特定的 Deployment</span>\nkubectl get pods                              <span class="token comment"># 列出当前命名空间下的全部 Pods</span>\nkubectl get pod my-pod -o yaml                <span class="token comment"># 获取一个 pod 的 YAML</span>\n\n<span class="token comment"># describe 命令的详细输出</span>\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n<span class="token comment"># 列出当前名字空间下所有 Services，按名称排序</span>\nkubectl get services --sort-by<span class="token operator">=</span>.metadata.name\n\n<span class="token comment"># 列出 Pods，按重启次数排序</span>\nkubectl get pods --sort-by<span class="token operator">=</span><span class="token string">\'.status.containerStatuses[0].restartCount\'</span>\n\n<span class="token comment"># 列举所有 PV 持久卷，按容量排序</span>\nkubectl get <span class="token function">pv</span> --sort-by<span class="token operator">=</span>.spec.capacity.storage\n\n<span class="token comment"># 获取包含 app=cassandra 标签的所有 Pods 的 version 标签</span>\nkubectl get pods --selector<span class="token operator">=</span>app<span class="token operator">=</span>cassandra -o <span class="token punctuation">\\</span>\n  <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].metadata.labels.version}\'</span>\n\n<span class="token comment"># 检索带有 “.” 键值，例： \'ca.crt\'</span>\nkubectl get configmap myconfig <span class="token punctuation">\\</span>\n  -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.data.ca\\.crt}\'</span>\n\n<span class="token comment"># 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。</span>\nkubectl get secret my-secret --template<span class="token operator">=</span><span class="token string">\'{{index .data "key-name-with-dashes"}}\'</span>\n\n<span class="token comment"># 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）</span>\nkubectl get node --selector<span class="token operator">=</span><span class="token string">\'!node-role.kubernetes.io/control-plane\'</span>\n\n<span class="token comment"># 获取当前命名空间中正在运行的 Pods</span>\nkubectl get pods --field-selector<span class="token operator">=</span>status.phase<span class="token operator">=</span>Running\n\n<span class="token comment"># 获取全部节点的 ExternalIP 地址</span>\nkubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].status.addresses[?(@.type=="ExternalIP")].address}\'</span>\n\n<span class="token comment"># 列出属于某个特定 RC 的 Pods 的名称</span>\n<span class="token comment"># 在转换对于 jsonpath 过于复杂的场合，"jq" 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。</span>\n<span class="token assign-left variable">sel</span><span class="token operator">=</span><span class="token variable">${$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .<span class="token punctuation">[</span><span class="token punctuation">]</span> | "\\(.key)=\\(.value)<span class="token operator">,</span>"\')<span class="token operator">%</span>?}</span>\n<span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>kubectl get pods --selector<span class="token operator">=</span>$sel --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>\n\n<span class="token comment"># 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）</span>\nkubectl get pods --show-labels\n\n<span class="token comment"># 检查哪些节点处于就绪状态</span>\n<span class="token assign-left variable">JSONPATH</span><span class="token operator">=</span><span class="token string">\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\'</span> <span class="token punctuation">\\</span>\n <span class="token operator">&amp;&amp;</span> kubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$JSONPATH</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Ready=True"</span>\n\n<span class="token comment"># 不使用外部工具来输出解码后的 Secret</span>\nkubectl get secret my-secret -o go-template<span class="token operator">=</span><span class="token string">\'{{range <span class="token variable">$k</span>,<span class="token variable">$v</span> := .data}}{{"### "}}{{<span class="token variable">$k</span>}}{{"<span class="token entity" title="\\n">\\n</span>"}}{{<span class="token variable">$v</span>|base64decode}}{{"<span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>"}}{{end}}\'</span>\n\n<span class="token comment"># 列出被一个 Pod 使用的全部 Secret</span>\nkubectl get pods -o json <span class="token operator">|</span> jq <span class="token string">\'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v null <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span>\n\n<span class="token comment"># 列举所有 Pods 中初始化容器的容器 ID（containerID）</span>\n<span class="token comment"># 可用于在清理已停止的容器时避免删除初始化容器</span>\nkubectl get pods --all-namespaces -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{"<span class="token entity" title="\\n">\\n</span>"}{end}\'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d/ -f3\n\n<span class="token comment"># 列出事件（Events），按时间戳排序</span>\nkubectl get events --sort-by<span class="token operator">=</span>.metadata.creationTimestamp\n\n<span class="token comment"># 比较当前的集群状态和假定某清单被应用之后的集群状态</span>\nkubectl <span class="token function">diff</span> -f ./my-manifest.yaml\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为节点返回的所有键</span>\n<span class="token comment"># 在复杂的嵌套JSON结构中定位键时非常有用</span>\nkubectl get nodes -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为pod等返回的所有键</span>\nkubectl get pods -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。</span>\n<span class="token comment"># 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">pod</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span>kubectl get po --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$pod</span> <span class="token operator">&amp;&amp;</span> kubectl <span class="token builtin class-name">exec</span> -it <span class="token variable">$pod</span> -- <span class="token function">env</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n\n<span class="token comment"># 获取一个 Deployment 的 status 子资源</span>\nkubectl get deployment nginx-deployment --subresource<span class="token operator">=</span>status</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="更新资源"><a href="#%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36050598900551090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl set image deployment/frontend www=image:v2               # 滚动更新 &quot;frontend&quot; Deployment 的 &quot;www&quot; 容器镜像\nkubectl rollout history deployment/frontend                      # 检查 Deployment 的历史记录，包括版本\nkubectl rollout undo deployment/frontend                         # 回滚到上次部署版本\nkubectl rollout undo deployment/frontend --to-revision=2         # 回滚到特定部署版本\nkubectl rollout status -w deployment/frontend                    # 监视 &quot;frontend&quot; Deployment 的滚动升级状态直到完成\nkubectl rollout restart deployment/frontend                      # 轮替重启 &quot;frontend&quot; Deployment\n\ncat pod.json | kubectl replace -f -                              # 通过传入到标准输入的 JSON 来替换 Pod\n\n# 强制替换，删除后重建资源。会导致服务不可用。\nkubectl replace --force -f ./pod.json\n\n# 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。\nkubectl expose rc nginx --port=80 --target-port=8000\n\n# 将某单容器 Pod 的镜像版本（标签）更新到 v4\nkubectl get pod mypod -o yaml | sed \'s/\\(image: myimage\\):.*\\$/\\1:v4/\' | kubectl replace -f -\n\nkubectl label pods my-pod new-label=awesome                      # 添加标签\nkubectl annotate pods my-pod icon-url=http://goo.gl/XXBTWq       # 添加注解\nkubectl autoscale deployment foo --min=2 --max=10                # 对 &quot;foo&quot; Deployment 自动伸缩容`, `36050598900551090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> image deployment/frontend <span class="token assign-left variable">www</span><span class="token operator">=</span>image:v2               <span class="token comment"># 滚动更新 "frontend" Deployment 的 "www" 容器镜像</span>\nkubectl rollout <span class="token function">history</span> deployment/frontend                      <span class="token comment"># 检查 Deployment 的历史记录，包括版本</span>\nkubectl rollout undo deployment/frontend                         <span class="token comment"># 回滚到上次部署版本</span>\nkubectl rollout undo deployment/frontend --to-revision<span class="token operator">=</span><span class="token number">2</span>         <span class="token comment"># 回滚到特定部署版本</span>\nkubectl rollout status -w deployment/frontend                    <span class="token comment"># 监视 "frontend" Deployment 的滚动升级状态直到完成</span>\nkubectl rollout restart deployment/frontend                      <span class="token comment"># 轮替重启 "frontend" Deployment</span>\n\n<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl replace -f -                              <span class="token comment"># 通过传入到标准输入的 JSON 来替换 Pod</span>\n\n<span class="token comment"># 强制替换，删除后重建资源。会导致服务不可用。</span>\nkubectl replace --force -f ./pod.json\n\n<span class="token comment"># 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。</span>\nkubectl expose rc nginx --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>\n\n<span class="token comment"># 将某单容器 Pod 的镜像版本（标签）更新到 v4</span>\nkubectl get pod mypod -o yaml <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">\'s/\\(image: myimage\\):.*$/<span class="token entity" title="\\1">\\1</span>:v4/\'</span> <span class="token operator">|</span> kubectl replace -f -\n\nkubectl label pods my-pod new-label<span class="token operator">=</span>awesome                      <span class="token comment"># 添加标签</span>\nkubectl annotate pods my-pod icon-url<span class="token operator">=</span>http://goo.gl/XXBTWq       <span class="token comment"># 添加注解</span>\nkubectl autoscale deployment foo --min<span class="token operator">=</span><span class="token number">2</span> --max<span class="token operator">=</span><span class="token number">10</span>                <span class="token comment"># 对 "foo" Deployment 自动伸缩容</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="部分更新资源"><a href="#%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部分更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12368168973553662000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 部分更新某节点\nkubectl patch node k8s-node-1 -p \'{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}\'\n\n# 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。\nkubectl patch pod valid-pod -p \'{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;kubernetes-serve-hostname&quot;,&quot;image&quot;:&quot;new image&quot;}]}}\'\n\n# 使用带位置数组的 JSON patch 更新容器的镜像\nkubectl patch pod valid-pod --type=\'json\' -p=\'[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;:&quot;new image&quot;}]\'\n\n# 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe\nkubectl patch deployment valid-deployment  --type json   -p=\'[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/livenessProbe&quot;}]\'\n\n# 在带位置数组中添加元素\nkubectl patch sa default --type=\'json\' -p=\'[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/secrets/1&quot;, &quot;value&quot;: {&quot;name&quot;: &quot;whatever&quot; } }]\'\n\n# 通过修正 scale 子资源来更新 Deployment 的副本数\nkubectl patch deployment nginx-deployment --subresource=\'scale\' --type=\'merge\' -p \'{&quot;spec&quot;:{&quot;replicas&quot;:2}}\'`, `12368168973553662000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 部分更新某节点</span>\nkubectl patch node k8s-node-1 -p <span class="token string">\'{"spec":{"unschedulable":true}}\'</span>\n\n<span class="token comment"># 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。</span>\nkubectl patch pod valid-pod -p <span class="token string">\'{"spec":{"containers":[{"name":"kubernetes-serve-hostname","image":"new image"}]}}\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 更新容器的镜像</span>\nkubectl patch pod valid-pod --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "replace", "path": "/spec/containers/0/image", "value":"new image"}]\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe</span>\nkubectl patch deployment valid-deployment  --type json   -p<span class="token operator">=</span><span class="token string">\'[{"op": "remove", "path": "/spec/template/spec/containers/0/livenessProbe"}]\'</span>\n\n<span class="token comment"># 在带位置数组中添加元素</span>\nkubectl patch sa default --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "add", "path": "/secrets/1", "value": {"name": "whatever" } }]\'</span>\n\n<span class="token comment"># 通过修正 scale 子资源来更新 Deployment 的副本数</span>\nkubectl patch deployment nginx-deployment --subresource<span class="token operator">=</span><span class="token string">\'scale\'</span> --type<span class="token operator">=</span><span class="token string">\'merge\'</span> -p <span class="token string">\'{"spec":{"replicas":2}}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编辑资源"><a href="#%E7%BC%96%E8%BE%91%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑资源</h4>\n<p>使用你偏爱的编辑器编辑 API 资源。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54531053288548340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl edit svc/docker-registry                      # 编辑名为 docker-registry 的服务\nKUBE_EDITOR=&quot;nano&quot; kubectl edit svc/docker-registry   # 使用其他编辑器`, `54531053288548340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl edit svc/docker-registry                      <span class="token comment"># 编辑名为 docker-registry 的服务</span>\n<span class="token assign-left variable">KUBE_EDITOR</span><span class="token operator">=</span><span class="token string">"nano"</span> kubectl edit svc/docker-registry   <span class="token comment"># 使用其他编辑器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="对资源进行伸缩"><a href="#%E5%AF%B9%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对资源进行伸缩</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39640487246460895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl scale --replicas=3 rs/foo                                 # 将名为 \'foo\' 的副本集伸缩到 3 副本\nkubectl scale --replicas=3 -f foo.yaml                            # 将在 &quot;foo.yaml&quot; 中的特定资源伸缩到 3 个副本\nkubectl scale --current-replicas=2 --replicas=3 deployment/mysql  # 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3\nkubectl scale --replicas=5 rc/foo rc/bar rc/baz                   # 伸缩多个副本控制器`, `39640487246460895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> rs/foo                                 <span class="token comment"># 将名为 \'foo\' 的副本集伸缩到 3 副本</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> -f foo.yaml                            <span class="token comment"># 将在 "foo.yaml" 中的特定资源伸缩到 3 个副本</span>\nkubectl scale --current-replicas<span class="token operator">=</span><span class="token number">2</span> --replicas<span class="token operator">=</span><span class="token number">3</span> deployment/mysql  <span class="token comment"># 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">5</span> rc/foo rc/bar rc/baz                   <span class="token comment"># 伸缩多个副本控制器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="删除资源"><a href="#%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62866142127655576000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl delete -f ./pod.json                                              # 删除在 pod.json 中指定的类型和名称的 Pod\nkubectl delete pod,service baz foo                                        # 删除名称为 &quot;baz&quot; 和 &quot;foo&quot; 的 Pod 和服务\nkubectl delete pods,services -l name=myLabel                              # 删除包含 name=myLabel 标签的 pods 和服务\nkubectl -n my-ns delete pod,svc --all                                     # 删除在 my-ns 名字空间中全部的 Pods 和服务\n# 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods\nkubectl get pods  -n mynamespace --no-headers=true | awk \'/pattern1|pattern2/{print \\$1}\' | xargs  kubectl delete -n mynamespace pod`, `62866142127655576000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl delete -f ./pod.json                                              <span class="token comment"># 删除在 pod.json 中指定的类型和名称的 Pod</span>\nkubectl delete pod,service baz foo                                        <span class="token comment"># 删除名称为 "baz" 和 "foo" 的 Pod 和服务</span>\nkubectl delete pods,services -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                              <span class="token comment"># 删除包含 name=myLabel 标签的 pods 和服务</span>\nkubectl -n my-ns delete pod,svc --all                                     <span class="token comment"># 删除在 my-ns 名字空间中全部的 Pods 和服务</span>\n<span class="token comment"># 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods</span>\nkubectl get pods  -n mynamespace --no-headers<span class="token operator">=</span>true <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'/pattern1|pattern2/{print <span class="token variable">$1</span>}\'</span> <span class="token operator">|</span> <span class="token function">xargs</span>  kubectl delete -n mynamespace pod</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与运行中的-pods-进行交互"><a href="#%E4%B8%8E%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84-pods-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与运行中的 Pods 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76669006889369010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs my-pod                                 # 获取 pod 日志（标准输出）\nkubectl logs -l name=myLabel                        # 获取含 name=myLabel 标签的 Pods 的日志（标准输出）\nkubectl logs my-pod --previous                      # 获取上个容器实例的 pod 日志（标准输出）\nkubectl logs my-pod -c my-container                 # 获取 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -l name=myLabel -c my-container        # 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）\nkubectl logs my-pod -c my-container --previous      # 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）\nkubectl logs -f my-pod                              # 流式输出 Pod 的日志（标准输出）\nkubectl logs -f my-pod -c my-container              # 流式输出 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -f -l name=myLabel --all-containers    # 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）\nkubectl run -i --tty busybox --image=busybox:1.28 -- sh  # 以交互式 Shell 运行 Pod\nkubectl run nginx --image=nginx -n mynamespace      # 在 “mynamespace” 命名空间中运行单个 nginx Pod\nkubectl run nginx --image=nginx                     # 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件\n  --dry-run=client -o yaml > pod.yaml\n\nkubectl attach my-pod -i                            # 挂接到一个运行的容器中\nkubectl port-forward my-pod 5000:6000               # 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000\nkubectl exec my-pod -- ls /                         # 在已有的 Pod 中运行命令（单容器场景）\nkubectl exec --stdin --tty my-pod -- /bin/sh        # 使用交互 shell 访问正在运行的 Pod (一个容器场景)\nkubectl exec my-pod -c my-container -- ls /         # 在已有的 Pod 中运行命令（多容器场景）\nkubectl top pod POD_NAME --containers               # 显示给定 Pod 和其中容器的监控数据\nkubectl top pod POD_NAME --sort-by=cpu              # 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序`, `76669006889369010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs my-pod                                 <span class="token comment"># 获取 pod 日志（标准输出）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                        <span class="token comment"># 获取含 name=myLabel 标签的 Pods 的日志（标准输出）</span>\nkubectl logs my-pod --previous                      <span class="token comment"># 获取上个容器实例的 pod 日志（标准输出）</span>\nkubectl logs my-pod -c my-container                 <span class="token comment"># 获取 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel -c my-container        <span class="token comment"># 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）</span>\nkubectl logs my-pod -c my-container --previous      <span class="token comment"># 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）</span>\nkubectl logs -f my-pod                              <span class="token comment"># 流式输出 Pod 的日志（标准输出）</span>\nkubectl logs -f my-pod -c my-container              <span class="token comment"># 流式输出 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -f -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel --all-containers    <span class="token comment"># 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）</span>\nkubectl run -i --tty busybox --image<span class="token operator">=</span>busybox:1.28 -- <span class="token function">sh</span>  <span class="token comment"># 以交互式 Shell 运行 Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx -n mynamespace      <span class="token comment"># 在 “mynamespace” 命名空间中运行单个 nginx Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx                     <span class="token comment"># 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件</span>\n  --dry-run<span class="token operator">=</span>client -o yaml <span class="token operator">></span> pod.yaml\n\nkubectl attach my-pod -i                            <span class="token comment"># 挂接到一个运行的容器中</span>\nkubectl port-forward my-pod <span class="token number">5000</span>:6000               <span class="token comment"># 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -- <span class="token function">ls</span> /                         <span class="token comment"># 在已有的 Pod 中运行命令（单容器场景）</span>\nkubectl <span class="token builtin class-name">exec</span> --stdin --tty my-pod -- /bin/sh        <span class="token comment"># 使用交互 shell 访问正在运行的 Pod (一个容器场景)</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -c my-container -- <span class="token function">ls</span> /         <span class="token comment"># 在已有的 Pod 中运行命令（多容器场景）</span>\nkubectl <span class="token function">top</span> pod POD_NAME --containers               <span class="token comment"># 显示给定 Pod 和其中容器的监控数据</span>\nkubectl <span class="token function">top</span> pod POD_NAME --sort-by<span class="token operator">=</span>cpu              <span class="token comment"># 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="从容器中复制文件和目录"><a href="#%E4%BB%8E%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从容器中复制文件和目录</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40697243103069454000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cp /tmp/foo_dir my-pod:/tmp/bar_dir            # 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir\nkubectl cp /tmp/foo my-pod:/tmp/bar -c my-container    # 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下\nkubectl cp /tmp/foo my-namespace/my-pod:/tmp/bar       # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar\nkubectl cp my-namespace/my-pod:/tmp/foo /tmp/bar       # 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar`, `40697243103069454000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token function">cp</span> /tmp/foo_dir my-pod:/tmp/bar_dir            <span class="token comment"># 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-pod:/tmp/bar -c my-container    <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-namespace/my-pod:/tmp/bar       <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar</span>\nkubectl <span class="token function">cp</span> my-namespace/my-pod:/tmp/foo /tmp/bar       <span class="token comment"># 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明：<code class="language-text">kubectl cp</code> 要求容器镜像中存在 <code class="language-text">tar</code> 二进制文件。如果 <code class="language-text">tar</code> 不存在，<code class="language-text">kubectl cp</code> 将失败。对于进阶用例，例如符号链接、通配符扩展或保留文件权限，请考虑使用 <code class="language-text">kubectl exec</code>。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93742980200001270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tar cf - /tmp/foo | kubectl exec -i -n my-namespace my-pod -- tar xf - -C /tmp/bar  # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar\nkubectl exec -n my-namespace my-pod -- tar cf - /tmp/foo | tar xf - -C /tmp/bar    # 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar`, `93742980200001270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> kubectl <span class="token builtin class-name">exec</span> -i -n my-namespace my-pod -- <span class="token function">tar</span> xf - -C /tmp/bar  <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar</span>\nkubectl <span class="token builtin class-name">exec</span> -n my-namespace my-pod -- <span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> <span class="token function">tar</span> xf - -C /tmp/bar    <span class="token comment"># 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="与-deployments-和-services-进行交互"><a href="#%E4%B8%8E-deployments-%E5%92%8C-services-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与 Deployments 和 Services 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46922289479712780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs deploy/my-deployment                         # 获取一个 Deployment 的 Pod 的日志（单容器例子）\nkubectl logs deploy/my-deployment -c my-container         # 获取一个 Deployment 的 Pod 的日志（多容器例子）\n\nkubectl port-forward svc/my-service 5000                  # 侦听本地端口 5000 并转发到 Service 后端端口 5000\nkubectl port-forward svc/my-service 5000:my-service-port  # 侦听本地端口 5000 并转发到名字为 <my-service-port> 的 Service 目标端口\n\nkubectl port-forward deploy/my-deployment 5000:6000       # 侦听本地端口 5000 并转发到 <my-deployment> 创建的 Pod 里的端口 6000\nkubectl exec deploy/my-deployment -- ls                   # 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）`, `46922289479712780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs deploy/my-deployment                         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（单容器例子）</span>\nkubectl logs deploy/my-deployment -c my-container         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（多容器例子）</span>\n\nkubectl port-forward svc/my-service <span class="token number">5000</span>                  <span class="token comment"># 侦听本地端口 5000 并转发到 Service 后端端口 5000</span>\nkubectl port-forward svc/my-service <span class="token number">5000</span>:my-service-port  <span class="token comment"># 侦听本地端口 5000 并转发到名字为 &lt;my-service-port> 的 Service 目标端口</span>\n\nkubectl port-forward deploy/my-deployment <span class="token number">5000</span>:6000       <span class="token comment"># 侦听本地端口 5000 并转发到 &lt;my-deployment> 创建的 Pod 里的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> deploy/my-deployment -- <span class="token function">ls</span>                   <span class="token comment"># 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与节点和集群进行交互"><a href="#%E4%B8%8E%E8%8A%82%E7%82%B9%E5%92%8C%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与节点和集群进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24896649532936598000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cordon my-node                                                # 标记 my-node 节点为不可调度\nkubectl drain my-node                                                 # 对 my-node 节点进行清空操作，为节点维护做准备\nkubectl uncordon my-node                                              # 标记 my-node 节点为可以调度\nkubectl top node my-node                                              # 显示给定节点的度量值\nkubectl cluster-info                                                  # 显示主控节点和服务的地址\nkubectl cluster-info dump                                             # 将当前集群状态转储到标准输出\nkubectl cluster-info dump --output-directory=/path/to/cluster-state   # 将当前集群状态输出到 /path/to/cluster-state\n\n# 如果已存在具有指定键和效果的污点，则替换其值为指定值。\nkubectl taint nodes foo dedicated=special-user:NoSchedule`, `24896649532936598000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl cordon my-node                                                <span class="token comment"># 标记 my-node 节点为不可调度</span>\nkubectl drain my-node                                                 <span class="token comment"># 对 my-node 节点进行清空操作，为节点维护做准备</span>\nkubectl uncordon my-node                                              <span class="token comment"># 标记 my-node 节点为可以调度</span>\nkubectl <span class="token function">top</span> node my-node                                              <span class="token comment"># 显示给定节点的度量值</span>\nkubectl cluster-info                                                  <span class="token comment"># 显示主控节点和服务的地址</span>\nkubectl cluster-info dump                                             <span class="token comment"># 将当前集群状态转储到标准输出</span>\nkubectl cluster-info dump --output-directory<span class="token operator">=</span>/path/to/cluster-state   <span class="token comment"># 将当前集群状态输出到 /path/to/cluster-state</span>\n\n<span class="token comment"># 如果已存在具有指定键和效果的污点，则替换其值为指定值。</span>\nkubectl taint nodes foo <span class="token assign-left variable">dedicated</span><span class="token operator">=</span>special-user:NoSchedule</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="资源类型"><a href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源类型</h5>\n<p>列出所支持的全部资源类型和它们的简称、API 组, 是否是名字空间作用域和 Kind。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47923604161031365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources`, `47923604161031365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用于探索 API 资源的其他操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82838685303126520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources --namespaced=true      # 所有命名空间作用域的资源\nkubectl api-resources --namespaced=false     # 所有非命名空间作用域的资源\nkubectl api-resources -o name                # 用简单格式列举所有资源（仅显示资源名称）\nkubectl api-resources -o wide                # 用扩展格式列举所有资源（又称 &quot;wide&quot; 格式）\nkubectl api-resources --verbs=list,get       # 支持 &quot;list&quot; 和 &quot;get&quot; 请求动词的所有资源\nkubectl api-resources --api-group=extensions # &quot;extensions&quot; API 组中的所有资源`, `82838685303126520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources --namespaced<span class="token operator">=</span>true      <span class="token comment"># 所有命名空间作用域的资源</span>\nkubectl api-resources --namespaced<span class="token operator">=</span>false     <span class="token comment"># 所有非命名空间作用域的资源</span>\nkubectl api-resources -o name                <span class="token comment"># 用简单格式列举所有资源（仅显示资源名称）</span>\nkubectl api-resources -o wide                <span class="token comment"># 用扩展格式列举所有资源（又称 "wide" 格式）</span>\nkubectl api-resources --verbs<span class="token operator">=</span>list,get       <span class="token comment"># 支持 "list" 和 "get" 请求动词的所有资源</span>\nkubectl api-resources --api-group<span class="token operator">=</span>extensions <span class="token comment"># "extensions" API 组中的所有资源</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="格式化输出"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化输出</h5>\n<p>要以特定格式将详细信息输出到终端窗口，将 <code class="language-text">-o</code>（或者 <code class="language-text">--output</code>）参数添加到支持的 kubectl 命令中。</p>\n<table>\n<thead>\n<tr>\n<th align="left">输出格式</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns=&lt;spec&gt;</code></td>\n<td align="left">使用逗号分隔的自定义列来打印表格</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns-file=&lt;filename&gt;</code></td>\n<td align="left">使用 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中的自定义列模板打印表格</td>\n</tr>\n<tr>\n<td align="left">-o=json</td>\n<td align="left">输出 JSON 格式的 API 对象</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath=&lt;template&gt;</code></td>\n<td align="left">打印 jsonpath 表达式中定义的字段</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath-file=&lt;filename&gt;</code></td>\n<td align="left">打印在 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中定义的 jsonpath 表达式所指定的字段。</td>\n</tr>\n<tr>\n<td align="left">-o=name</td>\n<td align="left">仅打印资源名称而不打印其他内容</td>\n</tr>\n<tr>\n<td align="left">-o=wide</td>\n<td align="left">以纯文本格式输出额外信息，对于 Pod 来说，输出中包含了节点名称</td>\n</tr>\n<tr>\n<td align="left">-o=yaml</td>\n<td align="left">输出 YAML 格式的 API 对象</td>\n</tr>\n</tbody>\n</table>\n<p>使用 <code class="language-text">-o=custom-columns</code> 的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10371121923895600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 集群中运行着的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[*].image\'\n\n# 列举 default 名字空间中运行的所有镜像，按 Pod 分组\nkubectl get pods --namespace default --output=custom-columns=&quot;NAME:.metadata.name,IMAGE:.spec.containers[*].image&quot;\n\n# 除 &quot;k8s.gcr.io/coredns:1.6.2&quot; 之外的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[?(@.image!=&quot;k8s.gcr.io/coredns:1.6.2&quot;)].image\'\n\n# 输出 metadata 下面的所有字段，无论 Pod 名字为何\nkubectl get pods -A -o=custom-columns=\'DATA:metadata.*\'`, `10371121923895600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 集群中运行着的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[*].image\'</span>\n\n<span class="token comment"># 列举 default 名字空间中运行的所有镜像，按 Pod 分组</span>\nkubectl get pods --namespace default --output<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">"NAME:.metadata.name,IMAGE:.spec.containers[*].image"</span>\n\n<span class="token comment"># 除 "k8s.gcr.io/coredns:1.6.2" 之外的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[?(@.image!="k8s.gcr.io/coredns:1.6.2")].image\'</span>\n\n<span class="token comment"># 输出 metadata 下面的所有字段，无论 Pod 名字为何</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:metadata.*\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有关更多示例，请参看 <a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/#custom-columns" target="_blank" rel="nofollow noreferrer noopener">kubectl 参考文档</a>。</p>\n<h5 id="kubectl-日志输出详细程度和调试"><a href="#kubectl-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E8%AF%A6%E7%BB%86%E7%A8%8B%E5%BA%A6%E5%92%8C%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 日志输出详细程度和调试</h5>\n<p>Kubectl 日志输出详细程度是通过 <code class="language-text">-v</code> 或者 <code class="language-text">--v</code> 来控制的，参数后跟一个数字表示日志的级别。Kubernetes 通用的日志习惯和相关的日志级别在 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="nofollow noreferrer noopener">这里</a> 有相应的描述。</p>\n<table>\n<thead>\n<tr>\n<th align="left">详细程度</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">—v=0</td>\n<td align="left">用于那些应该 始终 对运维人员可见的信息，因为这些信息一般很有用。</td>\n</tr>\n<tr>\n<td align="left">—v=1</td>\n<td align="left">如果您不想要看到冗余信息，此值是一个合理的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=2</td>\n<td align="left">输出有关服务的稳定状态的信息以及重要的日志消息，这些信息可能与系统中的重大变化有关。这是建议大多数系统设置的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=3</td>\n<td align="left">包含有关系统状态变化的扩展信息。</td>\n</tr>\n<tr>\n<td align="left">—v=4</td>\n<td align="left">包含调试级别的冗余信息。</td>\n</tr>\n<tr>\n<td align="left">—v=5</td>\n<td align="left">跟踪级别的详细程度。</td>\n</tr>\n<tr>\n<td align="left">—v=6</td>\n<td align="left">显示所请求的资源。</td>\n</tr>\n<tr>\n<td align="left">—v=7</td>\n<td align="left">显示 HTTP 请求头。</td>\n</tr>\n<tr>\n<td align="left">—v=8</td>\n<td align="left">显示 HTTP 请求内容。</td>\n</tr>\n<tr>\n<td align="left">—v=9</td>\n<td align="left">显示 HTTP 请求内容而且不截断内容。</td>\n</tr>\n</tbody>\n</table>\n<p>// TODO <a href="https://vuepress.mirror.docker-practice.com/security/" target="_blank" rel="nofollow noreferrer noopener">https://vuepress.mirror.docker-practice.com/security/</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Docker入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:164,frontmatter:{date:"2022-07-14 13:53:03",path:"/docker-introduce-learning/",tags:"后端, Docker, 读书笔记",title:"Docker入门学习",draft:null}},{excerpt:"版本一 版本二 工具 虚拟环境 对象自省 语法 异常 For - Else 三元运算符 Global Return open 函数  和  上下文管理器 // TODO  https://py.eastlakeside.cn/book/FunctionalProgramming/README.html",html:'<h1 id="版本一"><a href="#%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本一</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60803776768855530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# _*_ coding: utf-8 _*_\n\n&quot;&quot;&quot;类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算&quot;&quot;&quot;\n\n#-- 寻求帮助:\n    dir(obj)            # 简单的列出对象obj所包含的方法名称，返回一个字符串列表\n    help(obj.func)      # 查询obj.func的具体介绍和用法\n\n#-- 测试类型的三种方法，推荐第三种\n    if type(L) == type([]):\n        print(&quot;L is list&quot;)\n    if type(L) == list:\n        print(&quot;L is list&quot;)\n    if isinstance(L, list):\n        print(&quot;L is list&quot;)\n\n#-- Python数据类型：哈希类型、不可哈希类型\n    # 哈希类型，即在原地不能改变的变量类型，不可变类型。可利用hash函数查看其hash值，也可以作为字典的key\n    &quot;数字类型：int, float, decimal.Decimal, fractions.Fraction, complex&quot;\n    &quot;字符串类型：str, bytes&quot;\n    &quot;元组：tuple&quot;\n    &quot;冻结集合：frozenset&quot;\n    &quot;布尔类型：True, False&quot;\n    &quot;None&quot;\n    # 不可hash类型：原地可变类型：list、dict和set。它们不可以作为字典的key。\n\n#-- 数字常量\n    1234, -1234, 0, 999999999                    # 整数\n    1.23, 1., 3.14e-10, 4E210, 4.0e+210          # 浮点数\n    0o177, 0x9ff, 0X9FF, 0b101010                # 八进制、十六进制、二进制数字\n    3+4j, 3.0+4.0j, 3J                           # 复数常量，也可以用complex(real, image)来创建\n    hex(I), oct(I), bin(I)                       # 将十进制数转化为十六进制、八进制、二进制表示的“字符串”\n    int(string, base)                            # 将字符串转化为整数，base为进制数\n    # 2.x中，有两种整数类型：一般整数（32位）和长整数（无穷精度）。可以用l或L结尾，迫使一般整数成为长整数\n    float(\'inf\'), float(\'-inf\'), float(\'nan\')    # 无穷大, 无穷小, 非数\n\n#-- 数字的表达式操作符\n    yield x                                      # 生成器函数发送协议\n    lambda args: expression                      # 生成匿名函数\n    x if y else z                                # 三元选择表达式\n    x and y, x or y, not x                       # 逻辑与、逻辑或、逻辑非\n    x in y, x not in y                           # 成员对象测试\n    x is y, x is not y                           # 对象实体测试\n    x<y, x<=y, x>y, x>=y, x==y, x!=y             # 大小比较，集合子集或超集值相等性操作符\n    1 < a < 3                                    # Python中允许连续比较\n    x|y, x&y, x^y                                # 位或、位与、位异或\n    x<<y, x>>y                                   # 位操作：x左移、右移y位\n    +, -, *, /, //, %, **                        # 真除法、floor除法：返回不大于真除法结果的整数值、取余、幂运算\n    -x, +x, ~x                                   # 一元减法、识别、按位求补（取反）\n    x[i], x[i:j:k]                               # 索引、分片\n    int(3.14), float(3)                          # 强制类型转换\n\n#-- 整数可以利用bit_length函数测试所占的位数\n    a = 1;       a.bit_length()    # 1\n    a = 1024;    a.bit_length()    # 11\n\n#-- repr和str显示格式的区别\n    &quot;&quot;&quot;\n    repr格式：默认的交互模式回显，产生的结果看起来它们就像是代码。\n    str格式：打印语句，转化成一种对用户更加友好的格式。\n    &quot;&quot;&quot;\n\n#-- 数字相关的模块\n    # math模块\n    # Decimal模块：小数模块\n        import decimal\n        from decimal import Decimal\n        Decimal(&quot;0.01&quot;) + Decimal(&quot;0.02&quot;)        # 返回Decimal(&quot;0.03&quot;)\n        decimal.getcontext().prec = 4            # 设置全局精度为4 即小数点后边4位\n    # Fraction模块：分数模块\n        from fractions import Fraction\n        x = Fraction(4, 6)                       # 分数类型 4/6\n        x = Fraction(&quot;0.25&quot;)                     # 分数类型 1/4 接收字符串类型的参数\n\n#-- 集合set\n    &quot;&quot;&quot;\n    set是一个无序不重复元素集, 基本功能包括关系测试和消除重复元素。\n    set支持union(联合), intersection(交), difference(差)和symmetric difference(对称差集)等数学运算。\n    set支持x in set, len(set), for x in set。\n    set不记录元素位置或者插入点, 因此不支持indexing, slicing, 或其它类序列的操作\n    &quot;&quot;&quot;\n    s = set([3,5,9,10])                          # 创建一个数值集合，返回{3, 5, 9, 10}\n    t = set(&quot;Hello&quot;)                             # 创建一个字符的集合，返回{\'l\', \'H\', \'e\', \'o\'}\n    a = t | s;    t.union(s)                     # t 和 s的并集\n    b = t & s;    t.intersection(s)              # t 和 s的交集\n    c = t – s;    t.difference(s)                # 求差集（项在t中, 但不在s中）\n    d = t ^ s;    t.symmetric_difference(s)      # 对称差集（项在t或s中, 但不会同时出现在二者中）\n    t.add(\'x\');   t.remove(\'H\')                  # 增加/删除一个item\n    s.update([10,37,42])                         # 利用[......]更新s集合\n    x in s,  x not in s                          # 集合中是否存在某个值\n    s.issubset(t);      s <= t                   # 测试是否 s 中的每一个元素都在 t 中\n    s.issuperset(t);    s >= t                   # 测试是否 t 中的每一个元素都在 s 中\n    s.copy();\n    s.discard(x);                                # 删除s中x\n    s.clear()                                    # 清空s\n    {x**2 for x in [1, 2, 3, 4]}                 # 集合解析，结果：{16, 1, 4, 9}\n    {x for x in \'spam\'}                          # 集合解析，结果：{\'a\', \'p\', \'s\', \'m\'}\n\n#-- 集合frozenset，不可变对象\n    &quot;&quot;&quot;\n    set是可变对象，即不存在hash值，不能作为字典的键值。同样的还有list等(tuple是可以作为字典key的)\n    frozenset是不可变对象，即存在hash值，可作为字典的键值\n    frozenset对象没有add、remove等方法，但有union/intersection/difference等方法\n    &quot;&quot;&quot;\n    a = set([1, 2, 3])\n    b = set()\n    b.add(a)                     # error: set是不可哈希类型\n    b.add(frozenset(a))          # ok，将set变为frozenset，可哈希\n\n#-- 布尔类型bool\n    type(True)                   # 返回<class \'bool\'>\n    isinstance(False, int)       # bool类型属于整型，所以返回True\n    True == 1; True is 1         # 输出(True, False)\n\n#-- 动态类型简介\n    &quot;&quot;&quot;\n    变量名通过引用，指向对象。\n    Python中的“类型”属于对象，而不是变量，每个对象都包含有头部信息，比如&quot;类型标示符&quot; &quot;引用计数器&quot;等\n    &quot;&quot;&quot;\n    #共享引用及在原处修改：对于可变对象，要注意尽量不要共享引用！\n    #共享引用和相等测试：\n        L = [1], M = [1], L is M            # 返回False\n        L = M = [1, 2, 3], L is M           # 返回True，共享引用\n    #增强赋值和共享引用：普通+号会生成新的对象，而增强赋值+=会在原处修改\n        L = M = [1, 2]\n        L = L + [3, 4]                      # L = [1, 2, 3, 4], M = [1, 2]\n        L += [3, 4]                         # L = [1, 2, 3, 4], M = [1, 2, 3, 4]\n\n#-- 常见字符串常量和表达式\n    S = \'\'                                  # 空字符串\n    S = &quot;spam’s&quot;                            # 双引号和单引号相同\n    S = &quot;s\\np\\ta\\x00m&quot;                      # 转义字符\n    S = &quot;&quot;&quot;spam&quot;&quot;&quot;                          # 三重引号字符串，一般用于函数说明\n    S = r\'\\temp\'                            # Raw字符串，不会进行转义，抑制转义\n    S = b\'Spam\'                             # Python3中的字节字符串\n    S = u\'spam\'                             # Python2.6中的Unicode字符串\n    s1+s2, s1*3, s[i], s[i:j], len(s)       # 字符串操作\n    \'a %s parrot\' % \'kind\'                  # 字符串格式化表达式\n    \'a {1} {0} parrot\'.format(\'kind\', \'red\')# 字符串格式化方法\n    for x in s: print(x)                    # 字符串迭代，成员关系\n    [x*2 for x in s]                        # 字符串列表解析\n    \',\'.join([\'a\', \'b\', \'c\'])               # 字符串输出，结果：a,b,c\n\n#-- 内置str处理函数：\n    str1 = &quot;stringobject&quot;\n    str1.upper(); str1.lower(); str1.swapcase(); str1.capitalize(); str1.title()        # 全部大写，全部小写、大小写转换，首字母大写，每个单词的首字母都大写\n    str1.ljust(width)                       # 获取固定长度，左对齐，右边不够用空格补齐\n    str1.rjust(width)                       # 获取固定长度，右对齐，左边不够用空格补齐\n    str1.center(width)                      # 获取固定长度，中间对齐，两边不够用空格补齐\n    str1.zfill(width)                       # 获取固定长度，右对齐，左边不足用0补齐\n    str1.find(\'t\',start,end)                # 查找字符串，可以指定起始及结束位置搜索\n    str1.rfind(\'t\')                         # 从右边开始查找字符串\n    str1.count(\'t\')                         # 查找字符串出现的次数\n    #上面所有方法都可用index代替，不同的是使用index查找不到会抛异常，而find返回-1\n    str1.replace(\'old\',\'new\')               # 替换函数，替换old为new，参数中可以指定maxReplaceTimes，即替换指定次数的old为new\n    str1.strip();                           # 默认删除空白符\n    str1.strip(\'d\');                        # 删除str1字符串中开头、结尾处，位于 d 删除序列的字符\n    str1.lstrip();\n    str1.lstrip(\'d\');                       # 删除str1字符串中开头处，位于 d 删除序列的字符\n    str1.rstrip();\n    str1.rstrip(\'d\')                        # 删除str1字符串中结尾处，位于 d 删除序列的字符\n    str1.startswith(\'start\')                # 是否以start开头\n    str1.endswith(\'end\')                    # 是否以end结尾\n    str1.isalnum(); str1.isalpha(); str1.isdigit(); str1.islower(); str1.isupper()      # 判断字符串是否全为字符、数字、小写、大写\n\n#-- 三重引号编写多行字符串块，并且在代码折行处嵌入换行字符\\n\n    mantra = &quot;&quot;&quot;hello world\n            hello python\n            hello my friend&quot;&quot;&quot;\n    # mantra为&quot;&quot;&quot;hello world \\n hello python \\n hello my friend&quot;&quot;&quot;\n\n#-- 索引和分片：\n    S[0], S[len(S)–1], S[-1]                # 索引\n    S[1:3], S[1:], S[:-1], S[1:10:2]        # 分片，第三个参数指定步长，如\\`S[1:10:2]\\`是从1位到10位没隔2位获取一个字符。\n\n#-- 字符串转换工具：\n    int(\'42\'), str(42)                      # 返回(42, \'42\')\n    float(\'4.13\'), str(4.13)                # 返回(4.13, \'4.13\')\n    ord(\'s\'), chr(115)                      # 返回(115, \'s\')\n    int(\'1001\', 2)                          # 将字符串作为二进制数字，转化为数字，返回9\n    bin(13), oct(13), hex(13)               # 将整数转化为二进制/八进制/十六进制字符串，返回(\'0b1101\', \'015\', \'0xd\')\n\n#-- 另类字符串连接\n    name = &quot;wang&quot; &quot;hong&quot;                    # 单行，name = &quot;wanghong&quot;\n    name = &quot;wang&quot; \\\n            &quot;hong&quot;                          # 多行，name = &quot;wanghong&quot;\n\n#-- Python中的字符串格式化实现1--字符串格式化表达式\n    &quot;&quot;&quot;\n    基于C语言的\'print\'模型，并且在大多数的现有的语言中使用。\n    通用结构：%[(name)][flag][width].[precision]typecode\n    &quot;&quot;&quot;\n    &quot;this is %d %s bird&quot; % (1, \'dead\')                          # 一般的格式化表达式\n    &quot;%s---%s---%s&quot; % (42, 3.14, [1, 2, 3])                      # 字符串输出：\'42---3.14---[1, 2, 3]\'\n    &quot;%d...%6d...%-6d...%06d&quot; % (1234, 1234, 1234, 1234)         # 对齐方式及填充：&quot;1234...  1234...1234  ...001234&quot;\n    x = 1.23456789\n    &quot;%e | %f | %g&quot; % (x, x, x)                                  # 对齐方式：&quot;1.234568e+00 | 1.234568 | 1.23457&quot;\n    &quot;%6.2f*%-6.2f*%06.2f*%+6.2f&quot; % (x, x, x, x)                 # 对齐方式：\'  1.23*1.23  *001.23* +1.23\'\n    &quot;%(name1)d---%(name2)s&quot; % {&quot;name1&quot;:23, &quot;name2&quot;:&quot;value2&quot;}    # 基于字典的格式化表达式\n    &quot;%(name)s is %(age)d&quot; % vars()                              # vars()函数调用返回一个字典，包含了所有本函数调用时存在的变量\n\n#-- Python中的字符串格式化实现2--字符串格式化调用方法\n    # 普通调用\n    &quot;{0}, {1} and {2}&quot;.format(\'spam\', \'ham\', \'eggs\')            # 基于位置的调用\n    &quot;{motto} and {pork}&quot;.format(motto = \'spam\', pork = \'ham\')   # 基于Key的调用\n    &quot;{motto} and {0}&quot;.format(\'ham\', motto = \'spam\')             # 混合调用\n    # 添加键 属性 偏移量 (import sys)\n    &quot;my {1[spam]} runs {0.platform}&quot;.format(sys, {\'spam\':\'laptop\'})                 # 基于位置的键和属性\n    &quot;{config[spam]} {sys.platform}&quot;.format(sys = sys, config = {\'spam\':\'laptop\'})   # 基于Key的键和属性\n    &quot;first = {0[0]}, second = {0[1]}&quot;.format([\'A\', \'B\', \'C\'])                       # 基于位置的偏移量\n    # 具体格式化\n    &quot;{0:e}, {1:.3e}, {2:g}&quot;.format(3.14159, 3.14159, 3.14159)   # 输出\'3.141590e+00, 3.142e+00, 3.14159\'\n    &quot;{fieldname:format_spec}&quot;.format(......)\n    # 说明:\n    &quot;&quot;&quot;\n        fieldname是指定参数的一个数字或关键字, 后边可跟可选的&quot;.name&quot;或&quot;[index]&quot;成分引用\n        format_spec ::=  [[fill]align][sign][#][0][width][,][.precision][type]\n        fill        ::=  <any character>              #填充字符\n        align       ::=  &quot;<&quot; | &quot;>&quot; | &quot;=&quot; | &quot;^&quot;        #对齐方式\n        sign        ::=  &quot;+&quot; | &quot;-&quot; | &quot; &quot;              #符号说明\n        width       ::=  integer                      #字符串宽度\n        precision   ::=  integer                      #浮点数精度\n        type        ::=  &quot;b&quot; | &quot;c&quot; | &quot;d&quot; | &quot;e&quot; | &quot;E&quot; | &quot;f&quot; | &quot;F&quot; | &quot;g&quot; | &quot;G&quot; | &quot;n&quot; | &quot;o&quot; | &quot;s&quot; | &quot;x&quot; | &quot;X&quot; | &quot;%&quot;\n    &quot;&quot;&quot;\n    # 例子:\n        \'={0:10} = {1:10}\'.format(\'spam\', 123.456)    # 输出\'=spam       =    123.456\'\n        \'={0:>10}=\'.format(\'test\')                    # 输出\'=      test=\'\n        \'={0:<10}=\'.format(\'test\')                    # 输出\'=test      =\'\n        \'={0:^10}=\'.format(\'test\')                    # 输出\'=   test   =\'\n        \'{0:X}, {1:o}, {2:b}\'.format(255, 255, 255)   # 输出\'FF, 377, 11111111\'\n        \'My name is {0:{1}}.\'.format(\'Fred\', 8)       # 输出\'My name is Fred    .\'  动态指定参数\n\n#-- 常用列表常量和操作\n    L = [[1, 2], \'string\', {}]                        # 嵌套列表\n    L = list(\'spam\')                                  # 列表初始化\n    L = list(range(0, 4))                             # 列表初始化\n    list(map(ord, \'spam\'))                            # 列表解析\n    len(L)                                            # 求列表长度\n    L.count(value)                                    # 求列表中某个值的个数\n    L.append(obj)                                     # 向列表的尾部添加数据，比如append(2)，添加元素2\n    L.insert(index, obj)                              # 向列表的指定index位置添加数据，index及其之后的数据后移\n    L.extend(interable)                               # 通过添加iterable中的元素来扩展列表，比如extend([2])，添加元素2，注意和append的区别\n    L.index(value, [start, [stop]])                   # 返回列表中值value的第一个索引\n    L.pop([index])                                    # 删除并返回index处的元素，默认为删除并返回最后一个元素\n    L.remove(value)                                   # 删除列表中的value值，只删除第一次出现的value的值\n    L.reverse()                                       # 反转列表\n    L.sort(cmp=None, key=None, reverse=False)         # 排序列表\n    a = [1, 2, 3], b = a[10:]                         # 注意，这里不会引发IndexError异常，只会返回一个空的列表[]\n    a = [], a += [1]                                  # 这里实在原有列表的基础上进行操作，即列表的id没有改变\n    a = [], a = a + [1]                               # 这里最后的a要构建一个新的列表，即a的id发生了变化\n\n#-- 用切片来删除序列的某一段\n    a = [1, 2, 3, 4, 5, 6, 7]\n    a[1:4] = []                                       # a = [1, 5, 6, 7]\n    a = [0, 1, 2, 3, 4, 5, 6, 7]\n    del a[::2]                                        # 去除偶数项(偶数索引的)，a = [1, 3, 5, 7]\n\n#-- 常用字典常量和操作\n    D = {}\n    D = {\'spam\':2, \'tol\':{\'ham\':1}}                   # 嵌套字典\n    D = dict.fromkeys([\'s\', \'d\'], 8)                  # {\'s\': 8, \'d\': 8}\n    D = dict(name = \'tom\', age = 12)                  # {\'age\': 12, \'name\': \'tom\'}\n    D = dict([(\'name\', \'tom\'), (\'age\', 12)])          # {\'age\': 12, \'name\': \'tom\'}\n    D = dict(zip([\'name\', \'age\'], [\'tom\', 12]))       # {\'age\': 12, \'name\': \'tom\'}\n    D.keys(); D.values(); D.items()                   # 字典键、值以及键值对\n    D.get(key, default)                               # get函数\n    D.update(D_other)                                 # 合并字典，如果存在相同的键值，D_other的数据会覆盖掉D的数据\n    D.pop(key, [D])                                   # 删除字典中键值为key的项，返回键值为key的值，如果不存在，返回默认值D，否则异常\n    D.popitem()                                       # pop字典中随机的一项（一个键值对）\n    D.setdefault(k[, d])                              # 设置D中某一项的默认值。如果k存在，则返回D[k]，否则设置D[k]=d，同时返回D[k]。\n    del D                                             # 删除字典\n    del D[\'key\']                                      # 删除字典的某一项\n    if key in D:   if key not in D:                   # 测试字典键是否存在\n    # 字典注意事项：（1）对新索引赋值会添加一项（2）字典键不一定非得是字符串，也可以为任何的不可变对象\n    # 不可变对象：调用对象自身的任意方法，也不会改变该对象自身的内容，这些方法会创建新的对象并返回。\n    # 字符串、整数、tuple都是不可变对象，dict、set、list都是可变对象\n    D[(1,2,3)] = 2                                    # tuple作为字典的key\n\n#-- 字典解析\n    D = {k:8 for k in [\'s\', \'d\']}                     # {\'s\': 8, \'d\': 8}\n    D = {k:v for (k, v) in zip([\'name\', \'age\'], [\'tom\', 12])}       # {\'age\': 12, \'name\': tom}\n\n#-- 字典的特殊方法__missing__：当查找找不到key时，会执行该方法\n    class Dict(dict):\n        def __missing__(self, key):\n            self[key] = []\n            return self[key]\n    dct = dict()\n    dct[&quot;foo&quot;].append(1)    # 这有点类似于collections.defalutdict\n    dct[&quot;foo&quot;]              # [1]\n\n#-- 元组和列表的唯一区别在于元组是不可变对象，列表是可变对象\n    a = [1, 2, 3]           # a[1] = 0, OK\n    a = (1, 2, 3)           # a[1] = 0, Error\n    a = ([1, 2],)           # a[0][1] = 0, OK\n    a = [(1, 2)]            # a[0][1] = 0, Error\n\n#-- 元组的特殊语法: 逗号和圆括号\n    D = (12)                # 此时D为一个整数 即D = 12\n    D = (12, )              # 此时D为一个元组 即D = (12, )\n\n#-- 文件基本操作\n    output = open(r\'C:\\spam\', \'w\')          # 打开输出文件，用于写\n    input = open(\'data\', \'r\')               # 打开输入文件，用于读。打开的方式可以为\'w\', \'r\', \'a\', \'wb\', \'rb\', \'ab\'等\n    fp.read([size])                         # size为读取的长度，以byte为单位\n    fp.readline([size])                     # 读一行，如果定义了size，有可能返回的只是一行的一部分\n    fp.readlines([size])                    # 把文件每一行作为一个list的一个成员，并返回这个list。其实它的内部是通过循环调用readline()来实现的。如果提供size参数，size是表示读取内容的总长。\n    fp.readable()                           # 是否可读\n    fp.write(str)                           # 把str写到文件中，write()并不会在str后加上一个换行符\n    fp.writelines(seq)                      # 把seq的内容全部写到文件中(多行一次性写入)\n    fp.writeable()                          # 是否可写\n    fp.close()                              # 关闭文件。\n    fp.flush()                              # 把缓冲区的内容写入硬盘\n    fp.fileno()                             # 返回一个长整型的”文件标签“\n    fp.isatty()                             # 文件是否是一个终端设备文件（unix系统中的）\n    fp.tell()                               # 返回文件操作标记的当前位置，以文件的开头为原点\n    fp.next()                               # 返回下一行，并将文件操作标记位移到下一行。把一个file用于for … in file这样的语句时，就是调用next()函数来实现遍历的。\n    fp.seek(offset[,whence])                # 将文件打开操作标记移到offset的位置。whence为0表示从头开始计算，1表示以当前位置为原点计算。2表示以文件末尾为原点进行计算。\n    fp.seekable()                           # 是否可以seek\n    fp.truncate([size])                     # 把文件裁成规定的大小，默认的是裁到当前文件操作标记的位置。\n    for line in open(\'data\'):\n        print(line)                         # 使用for语句，比较适用于打开比较大的文件\n    with open(\'data\') as file:\n        print(file.readline())              # 使用with语句，可以保证文件关闭\n    with open(\'data\') as file:\n        lines = file.readlines()            # 一次读入文件所有行，并关闭文件\n    open(\'f.txt\', encoding = \'latin-1\')     # Python3.x Unicode文本文件\n    open(\'f.bin\', \'rb\')                     # Python3.x 二进制bytes文件\n    # 文件对象还有相应的属性：buffer closed encoding errors line_buffering name newlines等\n\n#-- 其他\n    # Python中的真假值含义：1. 数字如果非零，则为真，0为假。 2. 其他对象如果非空，则为真\n    # 通常意义下的类型分类：1. 数字、序列、映射。 2. 可变类型和不可变类型\n\n\n&quot;&quot;&quot;语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句&quot;&quot;&quot;\n\n#-- 赋值语句的形式\n    spam = \'spam\'                          # 基本形式\n    spam, ham = \'spam\', \'ham\'              # 元组赋值形式\n    [spam, ham] = [\'s\', \'h\']               # 列表赋值形式\n    a, b, c, d = \'abcd\'                    # 序列赋值形式\n    a, *b, c = \'spam\'                      # 序列解包形式（Python3.x中才有）\n    spam = ham = \'no\'                      # 多目标赋值运算，涉及到共享引用\n    spam += 42                             # 增强赋值，涉及到共享引用\n\n#-- 序列赋值 序列解包\n    [a, b, c] = (1, 2, 3)                  # a = 1, b = 2, c = 3\n    a, b, c, d = &quot;spam&quot;                    # a = \'s\', b = \'p\', c = \'a\', d = \'m\'\n    a, b, c = range(3)                     # a = 0, b = 1, c = 2\n    a, *b = [1, 2, 3, 4]                   # a = 1, b = [2, 3, 4]\n    *a, b = [1, 2, 3, 4]                   # a = [1, 2, 3], b = 4\n    a, *b, c = [1, 2, 3, 4]                # a = 1, b = [2, 3], c = 4\n    # 带有*时 会优先匹配*之外的变量 如\n    a, *b, c = [1, 2]                      # a = 1, c = 2, b = []\n\n#-- print函数原型\n    print(value, ..., sep=\' \', end=\'\\n\', file=sys.stdout, flush=False)\n    # 流的重定向\n    print(\'hello world\')                   # 等于sys.stdout.write(\'hello world\')\n    temp = sys.stdout                      # 原有流的保存\n    sys.stdout = open(\'log.log\', \'a\')      # 流的重定向\n    print(\'hello world\')                   # 写入到文件log.log\n    sys.stdout.close()\n    sys.stdout = temp                      # 原有流的复原\n\n#-- Python中and或or总是返回对象(左边的对象或右边的对象) 且具有短路求值的特性\n    1 or 2 or 3                            # 返回 1\n    1 and 2 and 3                          # 返回 3\n\n#-- if/else三元表达符（if语句在行内）\n    A = 1 if X else 2\n    A = 1 if X else (2 if Y else 3)\n    # 也可以使用and-or语句（一条语句实现多个if-else）\n    a = 6\n    result = (a > 20 and &quot;big than 20&quot; or a > 10 and &quot;big than 10&quot; or a > 5 and &quot;big than 5&quot;)    # 返回&quot;big than 5&quot;\n\n#-- Python的while语句或者for语句可以带else语句 当然也可以带continue/break/pass语句\n    while a > 1:\n        anything\n    else:\n        anything\n    # else语句会在循环结束后执行，除非在循环中执行了break，同样的还有for语句\n    for i in range(5):\n        anything\n    else:\n        anything\n\n#-- for循环的元组赋值\n    for (a, b) in [(1, 2), (3, 4)]:                   # 最简单的赋值\n    for ((a, b), c) in [((1, 2), 3), ((4, 5), 6)]:    # 自动解包赋值\n    for ((a, b), c) in [((1, 2), 3), (&quot;XY&quot;, 6)]:      # 自动解包 a = X, b = Y, c = 6\n    for (a, *b) in [(1, 2, 3), (4, 5, 6)]:            # 自动解包赋值\n\n#-- 列表解析语法\n    M = [[1,2,3], [4,5,6], [7,8,9]]\n    res = [sum(row) for row in M]                     # G = [6, 15, 24] 一般的列表解析 生成一个列表\n    res = [c * 2 for c in \'spam\']                     # [\'ss\', \'pp\', \'aa\', \'mm\']\n    res = [a * b for a in [1, 2] for b in [4, 5]]     # 多解析过程 返回[4, 5, 8, 10]\n    res = [a for a in [1, 2, 3] if a < 2]             # 带判断条件的解析过程\n    res = [a if a > 0 else 0 for a in [-1, 0, 1]]     # 带判断条件的高级解析过程\n    # 两个列表同时解析：使用zip函数\n    for teama, teamb in zip([&quot;Packers&quot;, &quot;49ers&quot;], [&quot;Ravens&quot;, &quot;Patriots&quot;]):\n        print(teama + &quot; vs. &quot; + teamb)\n    # 带索引的列表解析：使用enumerate函数\n    for index, team in enumerate([&quot;Packers&quot;, &quot;49ers&quot;, &quot;Ravens&quot;, &quot;Patriots&quot;]):\n        print(index, team)                            # 输出0, Packers \\n 1, 49ers \\n ......\n\n#-- 生成器表达式\n    G = (sum(row) for row in M)                       # 使用小括号可以创建所需结果的生成器generator object\n    next(G), next(G), next(G)                         # 输出(6, 15, 24)\n    G = {sum(row) for row in M}                       # G = {6, 15, 24} 解析语法还可以生成集合和字典\n    G = {i:sum(M[i]) for i in range(3)}               # G = {0: 6, 1: 15, 2: 24}\n\n#-- 文档字符串:出现在Module的开端以及其中函数或类的开端 使用三重引号字符串\n    &quot;&quot;&quot;\n    module document\n    &quot;&quot;&quot;\n    def func():\n        &quot;&quot;&quot;\n        function document\n        &quot;&quot;&quot;\n        print()\n    class Employee(object):\n        &quot;&quot;&quot;\n        class document\n        &quot;&quot;&quot;\n        print()\n    print(func.__doc__)                # 输出函数文档字符串\n    print(Employee.__doc__)            # 输出类的文档字符串\n\n#-- 命名惯例:\n    &quot;&quot;&quot;\n    以单一下划线开头的变量名(_X)不会被from module import*等语句导入\n    前后有两个下划线的变量名(__X__)是系统定义的变量名，对解释器有特殊意义\n    以两个下划线开头但不以下划线结尾的变量名(__X)是类的本地(私有)变量\n    &quot;&quot;&quot;\n\n#-- 列表解析 in成员关系测试 map sorted zip enumerate内置函数等都使用了迭代协议\n    \'first line\' in open(\'test.txt\')   # in测试 返回True或False\n    list(map(str.upper, open(\'t\')))    # map内置函数\n    sorted(iter([2, 5, 8, 3, 1]))      # sorted内置函数\n    list(zip([1, 2], [3, 4]))          # zip内置函数 [(1, 3), (2, 4)]\n\n#-- del语句: 手动删除某个变量\n    del X\n\n#-- 获取列表的子表的方法:\n    x = [1,2,3,4,5,6]\n    x[:3]                              # 前3个[1,2,3]\n    x[1:5]                             # 中间4个[2,3,4,5]\n    x[-3:]                             # 最后3个[4,5,6]\n    x[::2]                             # 奇数项[1,3,5]\n    x[1::2]                            # 偶数项[2,4,6]\n\n#-- 手动迭代：iter和next\n    L = [1, 2]\n    I = iter(L)                        # I为L的迭代器\n    I.next()                           # 返回1\n    I.next()                           # 返回2\n    I.next()                           # Error:StopIteration\n\n#-- Python中的可迭代对象\n    &quot;&quot;&quot;\n    1.range迭代器\n    2.map、zip和filter迭代器\n    3.字典视图迭代器：D.keys()), D.items()等\n    4.文件类型\n    &quot;&quot;&quot;\n\n\n&quot;&quot;&quot;函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则&quot;&quot;&quot;\n\n#-- 函数相关的语句和表达式\n    myfunc(\'spam\')                     # 函数调用\n    def myfunc():                      # 函数定义\n    return None                        # 函数返回值\n    global a                           # 全局变量\n    nonlocal x                         # 在函数或其他作用域中使用外层（非全局）变量\n    yield x                            # 生成器函数返回\n    lambda                             # 匿名函数\n\n#-- Python函数变量名解析:LEGB原则，即:\n    &quot;&quot;&quot;\n    local(functin) --> encloseing function locals --> global(module) --> build-in(python)\n    说明:以下边的函数maker为例 则相对于action而言 X为Local N为Encloseing\n    &quot;&quot;&quot;\n\n#-- 嵌套函数举例:工厂函数\n    def maker(N):\n        def action(X):\n            return X ** N\n        return action\n    f = maker(2)                       # pass 2 to N\n    f(3)                               # 9, pass 3 to X\n\n#-- 嵌套函数举例:lambda实例\n    def maker(N):\n        action = (lambda X: X**N)\n        return action\n    f = maker(2)                       # pass 2 to N\n    f(3)                               # 9, pass 3 to X\n\n#-- nonlocal和global语句的区别\n    # nonlocal应用于一个嵌套的函数的作用域中的一个名称 例如:\n    start = 100\n    def tester(start):\n        def nested(label):\n            nonlocal start             # 指定start为tester函数内的local变量 而不是global变量start\n            print(label, start)\n            start += 3\n        return nested\n    # global为全局的变量 即def之外的变量\n    def tester(start):\n        def nested(label):\n            global start               # 指定start为global变量start\n            print(label, start)\n            start += 3\n        return nested\n\n#-- 函数参数，不可变参数通过“值”传递，可变参数通过“引用”传递\n    def f(a, b, c): print(a, b, c)\n    f(1, 2, 3)                         # 参数位置匹配\n    f(1, c = 3, b = 2)                 # 参数关键字匹配\n    def f(a, b=1, c=2): print(a, b, c)\n    f(1)                               # 默认参数匹配\n    f(1, 2)                            # 默认参数匹配\n    f(a = 1, c = 3)                    # 关键字参数和默认参数的混合\n    # Keyword-Only参数:出现在*args之后 必须用关键字进行匹配\n    def keyOnly(a, *b, c): print(\'\')   # c就为keyword-only匹配 必须使用关键字c = value匹配\n    def keyOnly(a, *, b, c): ......    # b c为keyword-only匹配 必须使用关键字匹配\n    def keyOnly(a, *, b = 1): ......   # b有默认值 或者省略 或者使用关键字参数b = value\n\n#-- 可变参数匹配: * 和 **\n    def f(*args): print(args)          # 在元组中收集不匹配的位置参数\n    f(1, 2, 3)                         # 输出(1, 2, 3)\n    def f(**args): print(args)         # 在字典中收集不匹配的关键字参数\n    f(a = 1, b = 2)                    # 输出{\'a\':1, \'b\':2}\n    def f(a, *b, **c): print(a, b, c)  # 两者混合使用\n    f(1, 2, 3, x=4, y=5)               # 输出1, (2, 3), {\'x\':4, \'y\':5}\n\n#-- 函数调用时的参数解包: * 和 ** 分别解包元组和字典\n    func(1, *(2, 3))  <==>  func(1, 2, 3)\n    func(1, **{\'c\':3, \'b\':2})  <==>  func(1, b = 2, c = 3)\n    func(1, *(2, 3), **{\'c\':3, \'b\':2})  <==>  func(1, 2, 3, b = 2, c = 3)\n\n#-- 函数属性:(自己定义的)函数可以添加属性\n    def func():.....\n    func.count = 1                     # 自定义函数添加属性\n    print.count = 1                    # Error 内置函数不可以添加属性\n\n#-- 函数注解: 编写在def头部行 主要用于说明参数范围、参数类型、返回值类型等\n    def func(a:\'spam\', b:(1, 10), c:float) -> int :\n        print(a, b, c)\n    func.__annotations__               # {\'c\':<class \'float\'>, \'b\':(1, 10), \'a\':\'spam\', \'return\':<class \'int\'>}\n    # 编写注解的同时 还是可以使用函数默认值 并且注解的位置位于=号的前边\n    def func(a:\'spam\'=\'a\', b:(1, 10)=2, c:float=3) -> int :\n        print(a, b, c)\n\n#-- 匿名函数:lambda\n    f = lambda x, y, z : x + y + z     # 普通匿名函数，使用方法f(1, 2, 3)\n    f = lambda x = 1, y = 1: x + y     # 带默认参数的lambda函数\n    def action(x):                     # 嵌套lambda函数\n        return (lambda y : x + y)\n    f = lambda: a if xxx() else b      # 无参数的lambda函数，使用方法f()\n\n#-- lambda函数与map filter reduce函数的结合\n    list(map((lambda x: x + 1), [1, 2, 3]))              # [2, 3, 4]\n    list(filter((lambda x: x > 0), range(-4, 5)))        # [1, 2, 3, 4]\n    functools.reduce((lambda x, y: x + y), [1, 2, 3])    # 6\n    functools.reduce((lambda x, y: x * y), [2, 3, 4])    # 24\n\n#-- 生成器函数:yield VS return\n    def gensquare(N):\n        for i in range(N):\n            yield i** 2                # 状态挂起 可以恢复到此时的状态\n    for i in gensquare(5):             # 使用方法\n        print(i, end = \' \')            # [0, 1, 4, 9, 16]\n    x = gensquare(2)                   # x是一个生成对象\n    next(x)                            # 等同于x.__next__() 返回0\n    next(x)                            # 等同于x.__next__() 返回1\n    next(x)                            # 等同于x.__next__() 抛出异常StopIteration\n\n#-- 生成器表达式:小括号进行列表解析\n    G = (x ** 2 for x in range(3))     # 使用小括号可以创建所需结果的生成器generator object\n    next(G), next(G), next(G)          # 和上述中的生成器函数的返回值一致\n    #（1）生成器(生成器函数/生成器表达式)是单个迭代对象\n    G = (x ** 2 for x in range(4))\n    I1 = iter(G)                       # 这里实际上iter(G) = G\n    next(I1)                           # 输出0\n    next(G)                            # 输出1\n    next(I1)                           # 输出4\n    #（2）生成器不保留迭代后的结果\n    gen = (i for i in range(4))\n    2 in gen                           # 返回True\n    3 in gen                           # 返回True\n    1 in gen                           # 返回False，其实检测2的时候，1已经就不在生成器中了，即1已经被迭代过了，同理2、3也不在了\n\n#-- 本地变量是静态检测的\n    X = 22                             # 全局变量X的声明和定义\n    def test():\n        print(X)                       # 如果没有下一语句 则该句合法 打印全局变量X\n        X = 88                         # 这一语句使得上一语句非法 因为它使得X变成了本地变量 上一句变成了打印一个未定义的本地变量(局部变量)\n        if False:                      # 即使这样的语句 也会把print语句视为非法语句 因为:\n            X = 88                     # Python会无视if语句而仍然声明了局部变量X\n    def test():                        # 改进\n        global X                       # 声明变量X为全局变量\n        print(X)                       # 打印全局变量X\n        X = 88                         # 改变全局变量X\n\n#-- 函数的默认值是在函数定义的时候实例化的 而不是在调用的时候 例子:\n    def foo(numbers=[]):               # 这里的[]是可变的\n        numbers.append(9)\n        print(numbers)\n    foo()                              # first time, like before, [9]\n    foo()                              # second time, not like before, [9, 9]\n    foo()                              # third time, not like before too, [9, 9, 9]\n    # 改进:\n    def foo(numbers=None):\n        if numbers is None: numbers = []\n        numbers.append(9)\n        print(numbers)\n    # 另外一个例子 参数的默认值为不可变的:\n    def foo(count=0):                  # 这里的0是数字, 是不可变的\n        count += 1\n        print(count)\n    foo()                              # 输出1\n    foo()                              # 还是输出1\n    foo(3)                             # 输出4\n    foo()                              # 还是输出1\n\n\n&quot;&quot;&quot;函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子&quot;&quot;&quot;\n\n    &quot;&quot;&quot;数学运算类&quot;&quot;&quot;\n    abs(x)                              # 求绝对值，参数可以是整型，也可以是复数，若参数是复数，则返回复数的模\n    complex([real[, imag]])             # 创建一个复数\n    divmod(a, b)                        # 分别取商和余数，注意：整型、浮点型都可以\n    float([x])                          # 将一个字符串或数转换为浮点数。如果无参数将返回0.0\n    int([x[, base]])                    # 将一个字符串或浮点数转换为int类型，base表示进制\n    long([x[, base]])                   # 将一个字符串或浮点数转换为long类型\n    pow(x, y)                           # 返回x的y次幂\n    range([start], stop[, step])        # 产生一个序列，默认从0开始\n    round(x[, n])                       # 四舍五入\n    sum(iterable[, start])              # 对集合求和\n    oct(x)                              # 将一个数字转化为8进制字符串\n    hex(x)                              # 将一个数字转换为16进制字符串\n    chr(i)                              # 返回给定int类型对应的ASCII字符\n    unichr(i)                           # 返回给定int类型的unicode\n    ord(c)                              # 返回ASCII字符对应的整数\n    bin(x)                              # 将整数x转换为二进制字符串\n    bool([x])                           # 将x转换为Boolean类型\n\n    &quot;&quot;&quot;集合类操作&quot;&quot;&quot;\n    basestring()                        # str和unicode的超类，不能直接调用，可以用作isinstance判断\n    format(value [, format_spec])       # 格式化输出字符串，格式化的参数顺序从0开始，如“I am {0},I like {1}”\n    enumerate(sequence[, start=0])      # 返回一个可枚举的对象，注意它有第二个参数\n    iter(obj[, sentinel])               # 生成一个对象的迭代器，第二个参数表示分隔符\n    max(iterable[, args...][key])       # 返回集合中的最大值\n    min(iterable[, args...][key])       # 返回集合中的最小值\n    dict([arg])                         # 创建数据字典\n    list([iterable])                    # 将一个集合类转换为另外一个集合类\n    set()                               # set对象实例化\n    frozenset([iterable])               # 产生一个不可变的set\n    tuple([iterable])                   # 生成一个tuple类型\n    str([object])                       # 转换为string类型\n    sorted(iterable[, cmp[, key[, reverse]]])             # 集合排序\n        L = [(\'b\',2),(\'a\',1),(\'c\',3),(\'d\',4)]\n        sorted(L, key=lambda x: x[1], reverse=True)       # 使用Key参数和reverse参数\n        sorted(L, key=lambda x: (x[0], x[1]))             # 使用key参数进行多条件排序，即如果x[0]相同，则比较x[1]\n\n    &quot;&quot;&quot;逻辑判断&quot;&quot;&quot;\n    all(iterable)                       # 集合中的元素都为真的时候为真，特别的，若为空串返回为True\n    any(iterable)                       # 集合中的元素有一个为真的时候为真，特别的，若为空串返回为False\n    cmp(x, y)                           # 如果x < y ,返回负数；x == y, 返回0；x > y,返回正数\n\n    &quot;&quot;&quot;IO操作&quot;&quot;&quot;\n    file(filename [, mode [, bufsize]]) # file类型的构造函数。\n    input([prompt])                     # 获取用户输入，推荐使用raw_input，因为该函数将不会捕获用户的错误输入，意思是自行判断类型\n    # 在 Built-in Functions 里有一句话是这样写的：Consider using the raw_input() function for general input from users.\n    raw_input([prompt])                 # 设置输入，输入都是作为字符串处理\n    open(name[, mode[, buffering]])     # 打开文件，与file有什么不同？推荐使用open\n\n    &quot;&quot;&quot;其他&quot;&quot;&quot;\n    callable(object)                    # 检查对象object是否可调用\n    classmethod(func)                   # 用来说明这个func是个类方法\n    staticmethod(func)                  # 用来说明这个func为静态方法\n    dir([object])                       # 不带参数时，返回当前范围内的变量、方法和定义的类型列表；带参数时，返回参数的属性、方法列表。\n    help(obj)                           # 返回obj的帮助信息\n    eval(expression)                    # 计算表达式expression的值，并返回\n    exec(str)                           # 将str作为Python语句执行\n    execfile(filename)                  # 用法类似exec()，不同的是execfile的参数filename为文件名，而exec的参数为字符串。\n    filter(function, iterable)          # 构造一个序列，等价于[item for item in iterable if function(item)]，function返回值为True或False的函数\n        list(filter(bool, range(-3, 4)))# 返回[-3, -2, -1, 1, 2, 3], 没有0\n    hasattr(object, name)               # 判断对象object是否包含名为name的特性\n    getattr(object, name [, defalut])   # 获取一个类的属性\n    setattr(object, name, value)        # 设置属性值\n    delattr(object, name)               # 删除object对象名为name的属性\n    globals()                           # 返回一个描述当前全局符号表的字典\n    hash(object)                        # 如果对象object为哈希表类型，返回对象object的哈希值\n    id(object)                          # 返回对象的唯一标识，一串数字\n    isinstance(object, classinfo)       # 判断object是否是class的实例\n        isinstance(1, int)              # 判断是不是int类型\n        isinstance(1, (int, float))     # isinstance的第二个参数接受一个元组类型\n    issubclass(class, classinfo)        # 判断class是否为classinfo的子类\n    locals()                            # 返回当前的变量列表\n    map(function, iterable, ...)        # 遍历每个元素，执行function操作\n        list(map(abs, range(-3, 4)))    # 返回[3, 2, 1, 0, 1, 2, 3]\n    next(iterator[, default])           # 类似于iterator.next()\n    property([fget[, fset[, fdel[, doc]]]])           # 属性访问的包装类，设置后可以通过c.x=value等来访问setter和getter\n    reduce(function, iterable[, initializer])         # 合并操作，从第一个开始是前两个参数，然后是前两个的结果与第三个合并进行处理，以此类推\n        def add(x,y):return x + y\n        reduce(add, range(1, 11))                     # 返回55 (注:1+2+3+4+5+6+7+8+9+10 = 55)\n        reduce(add, range(1, 11), 20)                 # 返回75\n    reload(module)                      # 重新加载模块\n    repr(object)                        # 将一个对象变幻为可打印的格式\n    slice(start, stop[, step])          # 产生分片对象\n    type(object)                        # 返回该object的类型\n    vars([object])                      # 返回对象的变量名、变量值的字典\n        a = Class();                    # Class为一个空类\n        a.name = \'qi\', a.age = 9\n        vars(a)                         # {\'name\':\'qi\', \'age\':9}\n    zip([iterable, ...])                # 返回对应数组\n        list(zip([1, 2, 3], [4, 5, 6])) # [(1, 4), (2, 5), (3, 6)]\n        a = [1, 2, 3],  b = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]\n        z = zip(a, b)                   # 压缩：[(1, &quot;a&quot;), (2, &quot;b&quot;), (3, &quot;c&quot;)]\n        zip(*z)                         # 解压缩：[(1, 2, 3), (&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)]\n    unicode(string, encoding, errors)   # 将字符串string转化为unicode形式，string为encoded string。\n\n\n&quot;&quot;&quot;模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle&quot;&quot;&quot;\n\n#-- Python模块搜索路径:\n    &quot;&quot;&quot;\n    (1)程序的主目录    (2)PYTHONPATH目录 (3)标准链接库目录 (4)任何.pth文件的内容\n    &quot;&quot;&quot;\n\n#-- 查看全部的模块搜索路径\n    import sys\n    sys.path\n    sys.argv                            # 获得脚本的参数\n    sys.builtin_module_names            # 查找内建模块\n    sys.platform                        # 返回当前平台 出现如： &quot;win32&quot; &quot;linux&quot; &quot;darwin&quot;等\n    sys.modules                         # 查找已导入的模块\n    sys.modules.keys()\n    sys.stdout                          # stdout 和 stderr 都是类文件对象，但是它们都是只写的。它们都没有 read 方法，只有 write 方法\n    sys.stdout.write(&quot;hello&quot;)\n    sys.stderr\n    sys.stdin\n\n#-- 模块的使用代码\n    import module1, module2             # 导入module1 使用module1.printer()\n    from module1 import printer         # 导入module1中的printer变量 使用printer()\n    from module1 import *               # 导入module1中的全部变量 使用不必添加module1前缀\n\n#-- 重载模块reload: 这是一个内置函数 而不是一条语句\n    from imp import reload\n    reload(module)\n\n#-- 模块的包导入:使用点号(.)而不是路径(dir1\\dir2)进行导入\n    import dir1.dir2.mod                # d导入包(目录)dir1中的包dir2中的mod模块 此时dir1必须在Python可搜索路径中\n    from dir1.dir2.mod import *         # from语法的包导入\n\n#-- __init__.py包文件:每个导入的包中都应该包含这么一个文件\n    &quot;&quot;&quot;\n    该文件可以为空\n    首次进行包导入时 该文件会自动执行\n    高级功能:在该文件中使用__all__列表来定义包(目录)以from*的形式导入时 需要导入什么\n    &quot;&quot;&quot;\n\n#-- 包相对导入:使用点号(.) 只能使用from语句\n    from . import spam                  # 导入当前目录下的spam模块（Python2: 当前目录下的模块, 直接导入即可）\n    from .spam import name              # 导入当前目录下的spam模块的name属性（Python2: 当前目录下的模块, 直接导入即可，不用加.）\n    from .. import spam                 # 导入当前目录的父目录下的spam模块\n\n#-- 包相对导入与普通导入的区别\n    from string import *                # 这里导入的string模块为sys.path路径上的 而不是本目录下的string模块(如果存在也不是)\n    from .string import *               # 这里导入的string模块为本目录下的(不存在则导入失败) 而不是sys.path路径上的\n\n#-- 模块数据隐藏:最小化from*的破坏\n    _X                                  # 变量名前加下划线可以防止from*导入时该变量名被复制出去\n    __all__ = [\'x\', \'x1\', \'x2\']         # 使用__all__列表指定from*时复制出去的变量名(变量名在列表中为字符串形式)\n\n#-- 可以使用__name__进行模块的单元测试:当模块为顶层执行文件时值为\'__main__\' 当模块被导入时为模块名\n    if __name__ == \'__main__\':\n        doSomething\n    # 模块属性中还有其他属性，例如：\n    __doc__                             # 模块的说明文档\n    __file__                            # 模块文件的文件名，包括全路径\n    __name__                            # 主文件或者被导入文件\n    __package__                         # 模块所在的包\n\n#-- import语句from语句的as扩展\n    import modulename as name\n    from modulename import attrname as name\n\n#-- 得到模块属性的几种方法 假设为了得到name属性的值\n    M.name\n    M.__dict__[\'name\']\n    sys.modules[\'M\'].name\n    getattr(M, \'name\')\n\n\n&quot;&quot;&quot;类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象&quot;&quot;&quot;\n\n#-- 最普通的类\n    class C1(C2, C3):\n        spam = 42                       # 数据属性\n        def __init__(self, name):       # 函数属性:构造函数\n            self.name = name\n        def __del__(self):              # 函数属性:析构函数\n            print(&quot;goodbey &quot;, self.name)\n    I1 = C1(\'bob\')\n\n#-- Python的类没有基于参数的函数重载\n    class FirstClass(object):\n        def test(self, string):\n            print(string)\n        def test(self):                 # 此时类中只有一个test函数 即后者test(self) 它覆盖掉前者带参数的test函数\n            print(&quot;hello world&quot;)\n\n#-- 子类扩展超类: 尽量调用超类的方法\n    class Manager(Person):\n        def giveRaise(self, percent, bonus = .10):\n            self.pay = int(self.pay*(1 + percent + bonus))     # 不好的方式 复制粘贴超类代码\n            Person.giveRaise(self, percent + bonus)            # 好的方式 尽量调用超类方法\n\n#-- 类内省工具\n    bob = Person(\'bob\')\n    bob.__class__                       # <class \'Person\'>\n    bob.__class__.__name__              # \'Person\'\n    bob.__dict__                        # {\'pay\':0, \'name\':\'bob\', \'job\':\'Manager\'}\n\n#-- 返回1中 数据属性spam是属于类 而不是对象\n    I1 = C1(\'bob\'); I2 = C2(\'tom\')      # 此时I1和I2的spam都为42 但是都是返回的C1的spam属性\n    C1.spam = 24                        # 此时I1和I2的spam都为24\n    I1.spam = 3                         # 此时I1新增自有属性spam 值为3 I2和C1的spam还都为24\n\n#-- 类方法调用的两种方式\n    instance.method(arg...)\n    class.method(instance, arg...)\n\n#-- 抽象超类的实现方法\n    # (1)某个函数中调用未定义的函数 子类中定义该函数\n        def delegate(self):\n            self.action()               # 本类中不定义action函数 所以使用delegate函数时就会出错\n    # (2)定义action函数 但是返回异常\n        def action(self):\n            raise NotImplementedError(&quot;action must be defined&quot;)\n    # (3)上述的两种方法还都可以定义实例对象 实际上可以利用@装饰器语法生成不能定义的抽象超类\n        from abc import ABCMeta, abstractmethod\n        class Super(metaclass = ABCMeta):\n            @abstractmethod\n            def action(self): pass\n        x = Super()                     # 返回 TypeError: Can\'t instantiate abstract class Super with abstract methods action\n\n#-- # OOP和继承: &quot;is-a&quot;的关系\n    class A(B):\n        pass\n    a = A()\n    isinstance(a, B)                    # 返回True, A是B的子类 a也是B的一种\n    # OOP和组合: &quot;has-a&quot;的关系\n    pass\n    # OOP和委托: &quot;包装&quot;对象 在Python中委托通常是以&quot;__getattr__&quot;钩子方法实现的, 这个方法会拦截对不存在属性的读取\n    # 包装类(或者称为代理类)可以使用__getattr__把任意读取转发给被包装的对象\n    class wrapper(object):\n        def __init__(self, object):\n            self.wrapped = object\n        def __getattr(self, attrname):\n            print(\'Trace: \', attrname)\n            return getattr(self.wrapped, attrname)\n    # 注:这里使用getattr(X, N)内置函数以变量名字符串N从包装对象X中取出属性 类似于X.__dict__[N]\n    x = wrapper([1, 2, 3])\n    x.append(4)                         # 返回 &quot;Trace: append&quot; [1, 2, 3, 4]\n    x = wrapper({\'a\':1, \'b\':2})\n    list(x.keys())                      # 返回 &quot;Trace: keys&quot; [\'a\', \'b\']\n\n#-- 类的伪私有属性:使用__attr\n    class C1(object):\n        def __init__(self, name):\n            self.__name = name          # 此时类的__name属性为伪私有属性 原理 它会自动变成self._C1__name = name\n        def __str__(self):\n            return \'self.name = %s\' % self.__name\n    I = C1(\'tom\')\n    print(I)                            # 返回 self.name = tom\n    I.__name = \'jeey\'                   # 这里无法访问 __name为伪私有属性\n    I._C1__name = \'jeey\'                # 这里可以修改成功 self.name = jeey\n\n#-- 类方法是对象:无绑定类方法对象 / 绑定实例方法对象\n    class Spam(object):\n        def doit(self, message):\n            print(message)\n        def selfless(message)\n            print(message)\n    obj = Spam()\n    x = obj.doit                        # 类的绑定方法对象 实例 + 函数\n    x(\'hello world\')\n    x = Spam.doit                       # 类的无绑定方法对象 类名 + 函数\n    x(obj, \'hello world\')\n    x = Spam.selfless                   # 类的无绑定方法函数 在3.0之前无效\n    x(\'hello world\')\n\n#-- 获取对象信息: 属性和方法\n    a = MyObject()\n    dir(a)                              # 使用dir函数\n    hasattr(a, \'x\')                     # 测试是否有x属性或方法 即a.x是否已经存在\n    setattr(a, \'y\', 19)                 # 设置属性或方法 等同于a.y = 19\n    getattr(a, \'z\', 0)                  # 获取属性或方法 如果属性不存在 则返回默认值0\n    #这里有个小技巧，setattr可以设置一个不能访问到的属性，即只能用getattr获取\n    setattr(a, &quot;can\'t touch&quot;, 100)      # 这里的属性名带有空格，不能直接访问\n    getattr(a, &quot;can\'t touch&quot;, 0)        # 但是可以用getattr获取\n\n#-- 为类动态绑定属性或方法: MethodType方法\n    # 一般创建了一个class的实例后, 可以给该实例绑定任何属性和方法, 这就是动态语言的灵活性\n    class Student(object):\n        pass\n    s = Student()\n    s.name = \'Michael\'                  # 动态给实例绑定一个属性\n    def set_age(self, age):             # 定义一个函数作为实例方法\n        self.age = age\n    from types import MethodType\n    s.set_age = MethodType(set_age, s)  # 给实例绑定一个方法 类的其他实例不受此影响\n    s.set_age(25)                       # 调用实例方法\n    Student.set_age = MethodType(set_age, Student)    # 为类绑定一个方法 类的所有实例都拥有该方法\n\n\n&quot;&quot;&quot;类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题&quot;&quot;&quot;\n\n#-- 多重继承: &quot;混合类&quot;, 搜索方式&quot;从下到上 从左到右 广度优先&quot;\n    class A(B, C):\n        pass\n\n#-- 类的继承和子类的初始化\n    # 1.子类定义了__init__方法时，若未显示调用基类__init__方法，python不会帮你调用。\n    # 2.子类未定义__init__方法时，python会自动帮你调用首个基类的__init__方法，注意是首个。\n    # 3.子类显示调用基类的初始化函数：\n    class FooParent(object):\n        def __init__(self, a):\n            self.parent = \'I\\\'m the Parent.\'\n            print(\'Parent:a=\' + str(a))\n        def bar(self, message):\n            print(message + \' from Parent\')\n    class FooChild(FooParent):\n        def __init__(self, a):\n            FooParent.__init__(self, a)\n            print(\'Child:a=\' + str(a))\n        def bar(self, message):\n            FooParent.bar(self, message)\n            print(message + \' from Child\')\n    fooChild = FooChild(10)\n    fooChild.bar(\'HelloWorld\')\n\n#-- #实例方法 / 静态方法 / 类方法\n    class Methods(object):\n        def imeth(self, x): print(self, x)      # 实例方法：传入的是实例和数据，操作的是实例的属性\n        def smeth(x): print(x)                  # 静态方法：只传入数据 不传入实例，操作的是类的属性而不是实例的属性\n        def cmeth(cls, x): print(cls, x)        # 类方法：传入的是类对象和数据\n        smeth = staticmethod(smeth)             # 调用内置函数，也可以使用@staticmethod\n        cmeth = classmethod(cmeth)              # 调用内置函数，也可以使用@classmethod\n    obj = Methods()\n    obj.imeth(1)                                # 实例方法调用 <__main__.Methods object...> 1\n    Methods.imeth(obj, 2)                       # <__main__.Methods object...> 2\n    Methods.smeth(3)                            # 静态方法调用 3\n    obj.smeth(4)                                # 这里可以使用实例进行调用\n    Methods.cmeth(5)                            # 类方法调用 <class \'__main__.Methods\'> 5\n    obj.cmeth(6)                                # <class \'__main__.Methods\'> 6\n\n#-- 函数装饰器:是它后边的函数的运行时的声明 由@符号以及后边紧跟的&quot;元函数&quot;(metafunction)组成\n        @staticmethod\n        def smeth(x): print(x)\n    # 等同于:\n        def smeth(x): print(x)\n        smeth = staticmethod(smeth)\n    # 同理\n        @classmethod\n        def cmeth(cls, x): print(x)\n    # 等同于\n        def cmeth(cls, x): print(x)\n        cmeth = classmethod(cmeth)\n\n#-- 类修饰器:是它后边的类的运行时的声明 由@符号以及后边紧跟的&quot;元函数&quot;(metafunction)组成\n        def decorator(aClass):.....\n        @decorator\n        class C(object):....\n    # 等同于:\n        class C(object):....\n        C = decorator(C)\n\n#-- 限制class属性: __slots__属性\n    class Student(object):\n        __slots__ = (\'name\', \'age\')             # 限制Student及其实例只能拥有name和age属性\n    # __slots__属性只对当前类起作用, 对其子类不起作用\n    # __slots__属性能够节省内存\n    # __slots__属性可以为列表list，或者元组tuple\n\n#-- 类属性高级话题: @property\n    # 假设定义了一个类:C，该类必须继承自object类，有一私有变量_x\n    class C(object):\n        def __init__(self):\n            self.__x = None\n    # 第一种使用属性的方法\n        def getx(self):\n            return self.__x\n        def setx(self, value):\n            self.__x = value\n        def delx(self):\n            del self.__x\n        x = property(getx, setx, delx, \'\')\n    # property函数原型为property(fget=None,fset=None,fdel=None,doc=None)\n    # 使用\n    c = C()\n    c.x = 100                         # 自动调用setx方法\n    y = c.x                           # 自动调用getx方法\n    del c.x                           # 自动调用delx方法\n    # 第二种方法使用属性的方法\n        @property\n        def x(self):\n            return self.__x\n        @x.setter\n        def x(self, value):\n           self.__x = value\n        @x.deleter\n        def x(self):\n           del self.__x\n    # 使用\n    c = C()\n    c.x = 100                         # 自动调用setter方法\n    y = c.x                           # 自动调用x方法\n    del c.x                           # 自动调用deleter方法\n\n#-- 定制类: 重写类的方法\n    # (1)__str__方法、__repr__方法: 定制类的输出字符串\n    # (2)__iter__方法、next方法: 定制类的可迭代性\n    class Fib(object):\n        def __init__(self):\n            self.a, self.b = 0, 1     # 初始化两个计数器a，b\n        def __iter__(self):\n            return self               # 实例本身就是迭代对象，故返回自己\n        def next(self):\n            self.a, self.b = self.b, self.a + self.b\n            if self.a > 100000:       # 退出循环的条件\n                raise StopIteration()\n            return self.a             # 返回下一个值\n    for n in Fib():\n        print(n)                      # 使用\n    # (3)__getitem__方法、__setitem__方法: 定制类的下标操作[] 或者切片操作slice\n    class Indexer(object):\n        def __init__(self):\n            self.data = {}\n        def __getitem__(self, n):             # 定义getitem方法\n            print(\'getitem:\', n)\n            return self.data[n]\n        def __setitem__(self, key, value):    # 定义setitem方法\n            print(\'setitem:key = {0}, value = {1}\'.format(key, value))\n            self.data[key] = value\n    test = Indexer()\n    test[0] = 1;   test[3] = \'3\'              # 调用setitem方法\n    print(test[0])                            # 调用getitem方法\n    # (4)__getattr__方法: 定制类的属性操作\n    class Student(object):\n        def __getattr__(self, attr):          # 定义当获取类的属性时的返回值\n            if attr==\'age\':\n                return 25                     # 当获取age属性时返回25\n        raise AttributeError(\'object has no attribute: %s\' % attr)\n        # 注意: 只有当属性不存在时 才会调用该方法 且该方法默认返回None 需要在函数最后引发异常\n    s = Student()\n    s.age                                     # s中age属性不存在 故调用__getattr__方法 返回25\n    # (5)__call__方法: 定制类的\'可调用\'性\n    class Student(object):\n        def __call__(self):                   # 也可以带参数\n            print(\'Calling......\')\n    s = Student()\n    s()                                       # s变成了可调用的 也可以带参数\n    callable(s)                               # 测试s的可调用性 返回True\n    #    (6)__len__方法：求类的长度\n    def __len__(self):\n        return len(self.data)\n\n#-- 动态创建类type()\n    # 一般创建类 需要在代码中提前定义\n        class Hello(object):\n            def hello(self, name=\'world\'):\n                print(\'Hello, %s.\' % name)\n        h = Hello()\n        h.hello()                             # Hello, world\n        type(Hello)                           # Hello是一个type类型 返回<class \'type\'>\n        type(h)                               # h是一个Hello类型 返回<class \'Hello\'>\n    # 动态类型语言中 类可以动态创建 type函数可用于创建新类型\n        def fn(self, name=\'world\'):           # 先定义函数\n            print(\'Hello, %s.\' % name)\n        Hello = type(\'Hello\', (object,), dict(hello=fn))    # 创建Hello类 type原型: type(name, bases, dict)\n        h = Hello()                           # 此时的h和上边的h一致\n\n\n&quot;&quot;&quot;异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关&quot;&quot;&quot;\n\n#-- #捕获异常:\n        try:\n        except:                               # 捕获所有的异常 等同于except Exception:\n        except name:                          # 捕获指定的异常\n        except name, value:                   # 捕获指定的异常和额外的数据(实例)\n        except (name1, name2):\n        except (name1, name2), value:\n        except name4 as X:\n        else:                                 # 如果没有发生异常\n        finally:                              # 总会执行的部分\n    # 引发异常: raise子句(raise IndexError)\n        raise <instance>                      # raise instance of a class, raise IndexError()\n        raise <class>                         # make and raise instance of a class, raise IndexError\n        raise                                 # reraise the most recent exception\n\n#-- Python3.x中的异常链: raise exception from otherException\n    except Exception as X:\n        raise IndexError(\'Bad\') from X\n\n#-- assert子句: assert <test>, <data>\n    assert x < 0, \'x must be negative\'\n\n#-- with/as环境管理器:作为常见的try/finally用法模式的替代方案\n    with expression [as variable], expression [as variable]:\n    # 例子:\n        with open(\'test.txt\') as myfile:\n            for line in myfile: print(line)\n    # 等同于:\n        myfile = open(\'test.txt\')\n        try:\n            for line in myfile: print(line)\n        finally:\n            myfile.close()\n\n#-- 用户自定义异常: class Bad(Exception):.....\n    &quot;&quot;&quot;\n    Exception超类 / except基类即可捕获到其所有子类\n    Exception超类有默认的打印消息和状态 当然也可以定制打印显示:\n    &quot;&quot;&quot;\n    class MyBad(Exception):\n        def __str__(self):\n            return \'定制的打印消息\'\n    try:\n        MyBad()\n    except MyBad as x:\n        print(x)\n\n#-- 用户定制异常数据\n    class FormatError(Exception):\n        def __init__(self, line ,file):\n            self.line = line\n            self.file = file\n    try:\n        raise FormatError(42, \'test.py\')\n    except FormatError as X:\n        print(\'Error at \', X.file, X.line)\n    # 用户定制异常行为(方法):以记录日志为例\n    class FormatError(Exception):\n        logfile = \'formaterror.txt\'\n        def __init__(self, line ,file):\n            self.line = line\n            self.file = file\n        def logger(self):\n            open(self.logfile, \'a\').write(\'Error at \', self.file, self.line)\n    try:\n        raise FormatError(42, \'test.py\')\n    except FormatError as X:\n        X.logger()\n\n#-- 关于sys.exc_info:允许一个异常处理器获取对最近引发的异常的访问\n    try:\n        ......\n    except:\n        # 此时sys.exc_info()返回一个元组(type, value, traceback)\n        # type:正在处理的异常的异常类型\n        # value:引发的异常的实例\n        # traceback:堆栈信息\n\n#-- 异常层次\n    BaseException\n    +-- SystemExit\n    +-- KeyboardInterrupt\n    +-- GeneratorExit\n    +-- Exception\n        +-- StopIteration\n        +-- ArithmeticError\n        +-- AssertionError\n        +-- AttributeError\n        +-- BufferError\n        +-- EOFError\n        +-- ImportError\n        +-- LookupError\n        +-- MemoryError\n        +-- NameError\n        +-- OSError\n        +-- ReferenceError\n        +-- RuntimeError\n        +-- SyntaxError\n        +-- SystemError\n        +-- TypeError\n        +-- ValueError\n        +-- Warning\n\n\n&quot;&quot;&quot;Unicode和字节字符串---Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串&quot;&quot;&quot;\n\n#-- Python的字符串类型\n    &quot;&quot;&quot;Python2.x&quot;&quot;&quot;\n    # 1.str表示8位文本和二进制数据\n    # 2.unicode表示宽字符Unicode文本\n    &quot;&quot;&quot;Python3.x&quot;&quot;&quot;\n    # 1.str表示Unicode文本（8位或者更宽）\n    # 2.bytes表示不可变的二进制数据\n    # 3.bytearray是一种可变的bytes类型\n\n#-- 字符编码方法\n    &quot;&quot;&quot;ASCII&quot;&quot;&quot;                   # 一个字节，只包含英文字符，0到127，共128个字符，利用函数可以进行字符和数字的相互转换\n    ord(\'a\')                      # 字符a的ASCII码为97，所以这里返回97\n    chr(97)                       # 和上边的过程相反，返回字符\'a\'\n    &quot;&quot;&quot;Latin-1&quot;&quot;&quot;                 # 一个字节，包含特殊字符，0到255，共256个字符，相当于对ASCII码的扩展\n    chr(196)                      # 返回一个特殊字符：Ä\n    &quot;&quot;&quot;Unicode&quot;&quot;&quot;                 # 宽字符，一个字符包含多个字节，一般用于亚洲的字符集，比如中文有好几万字\n    &quot;&quot;&quot;UTF-8&quot;&quot;&quot;                   # 可变字节数，小于128的字符表示为单个字节，128到0X7FF之间的代码转换为两个字节，0X7FF以上的代码转换为3或4个字节\n    # 注意：可以看出来，ASCII码是Latin-1和UTF-8的一个子集\n    # 注意：utf-8是unicode的一种实现方式，unicode、gbk、gb2312是编码字符集\n\n#-- 查看Python中的字符串编码名称，查看系统的编码\n    import encodings\n    help(encoding)\n    import sys\n    sys.platform                  # \'win64\'\n    sys.getdefaultencoding()      # \'utf-8\'\n    sys.getdefaultencoding()      # 返回当前系统平台的编码类型\n    sys.getsizeof(object)         # 返回object占有的bytes的大小\n\n#-- 源文件字符集编码声明: 添加注释来指定想要的编码形式 从而改变默认值 注释必须出现在脚本的第一行或者第二行\n    &quot;&quot;&quot;说明：其实这里只会检查#和coding:utf-8，其余的字符都是为了美观加上的&quot;&quot;&quot;\n    # _*_ coding: utf-8 _*_\n    # coding = utf-8\n\n#-- #编码: 字符串 --> 原始字节       #解码: 原始字节 --> 字符串\n\n#-- Python3.x中的字符串应用\n    s = \'...\'                     # 构建一个str对象，不可变对象\n    b = b\'...\'                    # 构建一个bytes对象，不可变对象\n    s[0], b[0]                    # 返回(\'.\', 113)\n    s[1:], b[1:]                  # 返回(\'..\', b\'..\')\n    B = B&quot;&quot;&quot;\n        xxxx\n        yyyy\n        &quot;&quot;&quot;\n    # B = b\'\\nxxxx\\nyyyy\\n\'\n    # 编码，将str字符串转化为其raw bytes形式：\n        str.encode(encoding = \'utf-8\', errors = \'strict\')\n        bytes(str, encoding)\n    # 编码例子：\n        S = \'egg\'\n        S.encode()                    # b\'egg\'\n        bytes(S, encoding = \'ascii\')  # b\'egg\'\n    # 解码，将raw bytes字符串转化为str形式：\n        bytes.decode(encoding = \'utf-8\', errors = \'strict\')\n        str(bytes_or_buffer[, encoding[, errors]])\n    # 解码例子：\n        B = b\'spam\'\n        B.decode()                # \'spam\'\n        str(B)                    # &quot;b\'spam\'&quot;，不带编码的str调用，结果为打印该bytes对象\n        str(B, encoding = \'ascii\')# \'spam\'，带编码的str调用，结果为转化该bytes对象\n\n#-- Python2.x的编码问题\n    u = u\'汉\'\n    print repr(u)                 # u\'\\xba\\xba\'\n    s = u.encode(\'UTF-8\')\n    print repr(s)                 # \'\\xc2\\xba\\xc2\\xba\'\n    u2 = s.decode(\'UTF-8\')\n    print repr(u2)                # u\'\\xba\\xba\'\n    # 对unicode进行解码是错误的\n    s2 = u.decode(\'UTF-8\')        # UnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)\n    # 同样，对str进行编码也是错误的\n    u2 = s.encode(\'UTF-8\')        # UnicodeDecodeError: \'ascii\' codec can\'t decode byte 0xc2 in position 0: ordinal not in range(128)\n\n#-- bytes对象\n    B = b\'abc\'\n    B = bytes(\'abc\', \'ascii\')\n    B = bytes([97, 98, 99])\n    B = \'abc\'.encode()\n    # bytes对象的方法调用基本和str类型一致 但:B[0]返回的是ASCII码值97, 而不是b\'a\'\n\n#-- #文本文件: 根据Unicode编码来解释文件内容，要么是平台的默认编码，要么是指定的编码类型\n    # 二进制文件：表示字节值的整数的一个序列 open(\'bin.txt\', \'rb\')\n\n#-- Unicode文件\n    s = \'A\\xc4B\\xe8C\'             # s = \'A?BèC\'  len(s) = 5\n    #手动编码\n        l = s.encode(\'latin-1\')   # l = b\'A\\xc4B\\xe8C\'  len(l) = 5\n        u = s.encode(\'utf-8\')     # u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7\n    #文件输出编码\n        open(\'latindata\', \'w\', encoding = \'latin-1\').write(s)\n        l = open(\'latindata\', \'rb\').read()                        # l = b\'A\\xc4B\\xe8C\'  len(l) = 5\n        open(\'uft8data\', \'w\', encoding = \'utf-8\').write(s)\n        u = open(\'uft8data\', \'rb\').read()                         # u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7\n    #文件输入编码\n        s = open(\'latindata\', \'r\', encoding = \'latin-1\').read()   # s = \'A?BèC\'  len(s) = 5\n        s = open(\'latindata\', \'rb\').read().decode(\'latin-1\')      # s = \'A?BèC\'  len(s) = 5\n        s = open(\'utf8data\', \'r\', encoding = \'utf-8\').read()      # s = \'A?BèC\'  len(s) = 5\n        s = open(\'utf8data\', \'rb\').read().decode(\'utf-8\')         # s = \'A?BèC\'  len(s) = 5\n\n\n&quot;&quot;&quot;其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他&quot;&quot;&quot;\n\n#-- Python实现任意深度的赋值 例如a[0] = \'value1\'; a[1][2] = \'value2\'; a[3][4][5] = \'value3\'\n    class MyDict(dict):\n        def __setitem__(self, key, value):                 # 该函数不做任何改动 这里只是为了输出\n            print(\'setitem:\', key, value, self)\n            super().__setitem__(key, value)\n        def __getitem__(self, item):                       # 主要技巧在该函数\n            print(\'getitem:\', item, self)                  # 输出信息\n            # 基本思路: a[1][2]赋值时 需要先取出a[1] 然后给a[1]的[2]赋值\n            if item not in self:                           # 如果a[1]不存在 则需要新建一个dict 并使得a[1] = dict\n                temp = MyDict()                            # 新建的dict: temp\n                super().__setitem__(item, temp)            # 赋值a[1] = temp\n                return temp                                # 返回temp 使得temp[2] = value有效\n            return super().__getitem__(item)               # 如果a[1]存在 则直接返回a[1]\n    # 例子:\n        test = MyDict()\n        test[0] = \'test\'\n        print(test[0])\n        test[1][2] = \'test1\'\n        print(test[1][2])\n        test[1][3] = \'test2\'\n        print(test[1][3])\n\n#-- Python中的多维数组\n    lists = [0] * 3                                        # 扩展list，结果为[0, 0, 0]\n    lists = [[]] * 3                                       # 多维数组，结果为[[], [], []]，但有问题，往下看\n    lists[0].append(3)                                     # 期望看到的结果[[3], [], []]，实际结果[[3], [3], [3]]，原因：list*n操作，是浅拷贝，如何避免？往下看\n    lists = [[] for i in range(3)]                         # 多维数组，结果为[[], [], []]\n    lists[0].append(3)                                     # 结果为[[3], [], []]\n    lists[1].append(6)                                     # 结果为[[3], [6], []]\n    lists[2].append(9)                                     # 结果为[[3], [6], [9]]\n    lists = [[[] for j in range(4)] for i in range(3)]     # 3行4列，且每一个元素为[]`, `60803776768855530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># _*_ coding: utf-8 _*_</span>\n\n<span class="token triple-quoted-string string">"""类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算"""</span>\n\n<span class="token comment">#-- 寻求帮助:</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>            <span class="token comment"># 简单的列出对象obj所包含的方法名称，返回一个字符串列表</span>\n    <span class="token builtin">help</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>func<span class="token punctuation">)</span>      <span class="token comment"># 查询obj.func的具体介绍和用法</span>\n\n<span class="token comment">#-- 测试类型的三种方法，推荐第三种</span>\n    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python数据类型：哈希类型、不可哈希类型</span>\n    <span class="token comment"># 哈希类型，即在原地不能改变的变量类型，不可变类型。可利用hash函数查看其hash值，也可以作为字典的key</span>\n    <span class="token string">"数字类型：int, float, decimal.Decimal, fractions.Fraction, complex"</span>\n    <span class="token string">"字符串类型：str, bytes"</span>\n    <span class="token string">"元组：tuple"</span>\n    <span class="token string">"冻结集合：frozenset"</span>\n    <span class="token string">"布尔类型：True, False"</span>\n    <span class="token string">"None"</span>\n    <span class="token comment"># 不可hash类型：原地可变类型：list、dict和set。它们不可以作为字典的key。</span>\n\n<span class="token comment">#-- 数字常量</span>\n    <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">999999999</span>                    <span class="token comment"># 整数</span>\n    <span class="token number">1.23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3.14e-10</span><span class="token punctuation">,</span> <span class="token number">4E210</span><span class="token punctuation">,</span> <span class="token number">4.0e+210</span>          <span class="token comment"># 浮点数</span>\n    <span class="token number">0o177</span><span class="token punctuation">,</span> <span class="token number">0x9ff</span><span class="token punctuation">,</span> <span class="token number">0X9FF</span><span class="token punctuation">,</span> <span class="token number">0b101010</span>                <span class="token comment"># 八进制、十六进制、二进制数字</span>\n    <span class="token number">3</span><span class="token operator">+</span><span class="token number">4j</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token operator">+</span><span class="token number">4.0j</span><span class="token punctuation">,</span> <span class="token number">3J</span>                           <span class="token comment"># 复数常量，也可以用complex(real, image)来创建</span>\n    <span class="token builtin">hex</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">oct</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bin</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span>                       <span class="token comment"># 将十进制数转化为十六进制、八进制、二进制表示的“字符串”</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> base<span class="token punctuation">)</span>                            <span class="token comment"># 将字符串转化为整数，base为进制数</span>\n    <span class="token comment"># 2.x中，有两种整数类型：一般整数（32位）和长整数（无穷精度）。可以用l或L结尾，迫使一般整数成为长整数</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'-inf\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'nan\'</span><span class="token punctuation">)</span>    <span class="token comment"># 无穷大, 无穷小, 非数</span>\n\n<span class="token comment">#-- 数字的表达式操作符</span>\n    <span class="token keyword">yield</span> x                                      <span class="token comment"># 生成器函数发送协议</span>\n    <span class="token keyword">lambda</span> args<span class="token punctuation">:</span> expression                      <span class="token comment"># 生成匿名函数</span>\n    x <span class="token keyword">if</span> y <span class="token keyword">else</span> z                                <span class="token comment"># 三元选择表达式</span>\n    x <span class="token keyword">and</span> y<span class="token punctuation">,</span> x <span class="token keyword">or</span> y<span class="token punctuation">,</span> <span class="token keyword">not</span> x                       <span class="token comment"># 逻辑与、逻辑或、逻辑非</span>\n    x <span class="token keyword">in</span> y<span class="token punctuation">,</span> x <span class="token keyword">not</span> <span class="token keyword">in</span> y                           <span class="token comment"># 成员对象测试</span>\n    x <span class="token keyword">is</span> y<span class="token punctuation">,</span> x <span class="token keyword">is</span> <span class="token keyword">not</span> y                           <span class="token comment"># 对象实体测试</span>\n    x<span class="token operator">&lt;</span>y<span class="token punctuation">,</span> x<span class="token operator">&lt;=</span>y<span class="token punctuation">,</span> x<span class="token operator">></span>y<span class="token punctuation">,</span> x<span class="token operator">>=</span>y<span class="token punctuation">,</span> x<span class="token operator">==</span>y<span class="token punctuation">,</span> x<span class="token operator">!=</span>y             <span class="token comment"># 大小比较，集合子集或超集值相等性操作符</span>\n    <span class="token number">1</span> <span class="token operator">&lt;</span> a <span class="token operator">&lt;</span> <span class="token number">3</span>                                    <span class="token comment"># Python中允许连续比较</span>\n    x<span class="token operator">|</span>y<span class="token punctuation">,</span> x<span class="token operator">&amp;</span>y<span class="token punctuation">,</span> x<span class="token operator">^</span>y                                <span class="token comment"># 位或、位与、位异或</span>\n    x<span class="token operator">&lt;&lt;</span>y<span class="token punctuation">,</span> x<span class="token operator">>></span>y                                   <span class="token comment"># 位操作：x左移、右移y位</span>\n    <span class="token operator">+</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">//</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token punctuation">,</span> <span class="token operator">**</span>                        <span class="token comment"># 真除法、floor除法：返回不大于真除法结果的整数值、取余、幂运算</span>\n    <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">+</span>x<span class="token punctuation">,</span> <span class="token operator">~</span>x                                   <span class="token comment"># 一元减法、识别、按位求补（取反）</span>\n    x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">:</span>k<span class="token punctuation">]</span>                               <span class="token comment"># 索引、分片</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                          <span class="token comment"># 强制类型转换</span>\n\n<span class="token comment">#-- 整数可以利用bit_length函数测试所占的位数</span>\n    a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       a<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 1</span>\n    a <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>    a<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 11</span>\n\n<span class="token comment">#-- repr和str显示格式的区别</span>\n    <span class="token triple-quoted-string string">"""\n    repr格式：默认的交互模式回显，产生的结果看起来它们就像是代码。\n    str格式：打印语句，转化成一种对用户更加友好的格式。\n    """</span>\n\n<span class="token comment">#-- 数字相关的模块</span>\n    <span class="token comment"># math模块</span>\n    <span class="token comment"># Decimal模块：小数模块</span>\n        <span class="token keyword">import</span> decimal\n        <span class="token keyword">from</span> decimal <span class="token keyword">import</span> Decimal\n        Decimal<span class="token punctuation">(</span><span class="token string">"0.01"</span><span class="token punctuation">)</span> <span class="token operator">+</span> Decimal<span class="token punctuation">(</span><span class="token string">"0.02"</span><span class="token punctuation">)</span>        <span class="token comment"># 返回Decimal("0.03")</span>\n        decimal<span class="token punctuation">.</span>getcontext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prec <span class="token operator">=</span> <span class="token number">4</span>            <span class="token comment"># 设置全局精度为4 即小数点后边4位</span>\n    <span class="token comment"># Fraction模块：分数模块</span>\n        <span class="token keyword">from</span> fractions <span class="token keyword">import</span> Fraction\n        x <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>                       <span class="token comment"># 分数类型 4/6</span>\n        x <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token string">"0.25"</span><span class="token punctuation">)</span>                     <span class="token comment"># 分数类型 1/4 接收字符串类型的参数</span>\n\n<span class="token comment">#-- 集合set</span>\n    <span class="token triple-quoted-string string">"""\n    set是一个无序不重复元素集, 基本功能包括关系测试和消除重复元素。\n    set支持union(联合), intersection(交), difference(差)和symmetric difference(对称差集)等数学运算。\n    set支持x in set, len(set), for x in set。\n    set不记录元素位置或者插入点, 因此不支持indexing, slicing, 或其它类序列的操作\n    """</span>\n    s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                          <span class="token comment"># 创建一个数值集合，返回{3, 5, 9, 10}</span>\n    t <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>                             <span class="token comment"># 创建一个字符的集合，返回{\'l\', \'H\', \'e\', \'o\'}</span>\n    a <span class="token operator">=</span> t <span class="token operator">|</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>union<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                     <span class="token comment"># t 和 s的并集</span>\n    b <span class="token operator">=</span> t <span class="token operator">&amp;</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>intersection<span class="token punctuation">(</span>s<span class="token punctuation">)</span>              <span class="token comment"># t 和 s的交集</span>\n    c <span class="token operator">=</span> t – s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                <span class="token comment"># 求差集（项在t中, 但不在s中）</span>\n    d <span class="token operator">=</span> t <span class="token operator">^</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>symmetric_difference<span class="token punctuation">(</span>s<span class="token punctuation">)</span>      <span class="token comment"># 对称差集（项在t或s中, 但不会同时出现在二者中）</span>\n    t<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   t<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">\'H\'</span><span class="token punctuation">)</span>                  <span class="token comment"># 增加/删除一个item</span>\n    s<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># 利用[......]更新s集合</span>\n    x <span class="token keyword">in</span> s<span class="token punctuation">,</span>  x <span class="token keyword">not</span> <span class="token keyword">in</span> s                          <span class="token comment"># 集合中是否存在某个值</span>\n    s<span class="token punctuation">.</span>issubset<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>      s <span class="token operator">&lt;=</span> t                   <span class="token comment"># 测试是否 s 中的每一个元素都在 t 中</span>\n    s<span class="token punctuation">.</span>issuperset<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    s <span class="token operator">>=</span> t                   <span class="token comment"># 测试是否 t 中的每一个元素都在 s 中</span>\n    s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    s<span class="token punctuation">.</span>discard<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment"># 删除s中x</span>\n    s<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>                                    <span class="token comment"># 清空s</span>\n    <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span>                 <span class="token comment"># 集合解析，结果：{16, 1, 4, 9}</span>\n    <span class="token punctuation">{</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">\'spam\'</span><span class="token punctuation">}</span>                          <span class="token comment"># 集合解析，结果：{\'a\', \'p\', \'s\', \'m\'}</span>\n\n<span class="token comment">#-- 集合frozenset，不可变对象</span>\n    <span class="token triple-quoted-string string">"""\n    set是可变对象，即不存在hash值，不能作为字典的键值。同样的还有list等(tuple是可以作为字典key的)\n    frozenset是不可变对象，即存在hash值，可作为字典的键值\n    frozenset对象没有add、remove等方法，但有union/intersection/difference等方法\n    """</span>\n    a <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    b <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    b<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">)</span>                     <span class="token comment"># error: set是不可哈希类型</span>\n    b<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">frozenset</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># ok，将set变为frozenset，可哈希</span>\n\n<span class="token comment">#-- 布尔类型bool</span>\n    <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>                   <span class="token comment"># 返回&lt;class \'bool\'></span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>       <span class="token comment"># bool类型属于整型，所以返回True</span>\n    <span class="token boolean">True</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token boolean">True</span> <span class="token keyword">is</span> <span class="token number">1</span>         <span class="token comment"># 输出(True, False)</span>\n\n<span class="token comment">#-- 动态类型简介</span>\n    <span class="token triple-quoted-string string">"""\n    变量名通过引用，指向对象。\n    Python中的“类型”属于对象，而不是变量，每个对象都包含有头部信息，比如"类型标示符" "引用计数器"等\n    """</span>\n    <span class="token comment">#共享引用及在原处修改：对于可变对象，要注意尽量不要共享引用！</span>\n    <span class="token comment">#共享引用和相等测试：</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> L <span class="token keyword">is</span> M            <span class="token comment"># 返回False</span>\n        L <span class="token operator">=</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> L <span class="token keyword">is</span> M           <span class="token comment"># 返回True，共享引用</span>\n    <span class="token comment">#增强赋值和共享引用：普通+号会生成新的对象，而增强赋值+=会在原处修改</span>\n        L <span class="token operator">=</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n        L <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                      <span class="token comment"># L = [1, 2, 3, 4], M = [1, 2]</span>\n        L <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                         <span class="token comment"># L = [1, 2, 3, 4], M = [1, 2, 3, 4]</span>\n\n<span class="token comment">#-- 常见字符串常量和表达式</span>\n    S <span class="token operator">=</span> <span class="token string">\'\'</span>                                  <span class="token comment"># 空字符串</span>\n    S <span class="token operator">=</span> <span class="token string">"spam’s"</span>                            <span class="token comment"># 双引号和单引号相同</span>\n    S <span class="token operator">=</span> <span class="token string">"s\\np\\ta\\x00m"</span>                      <span class="token comment"># 转义字符</span>\n    S <span class="token operator">=</span> <span class="token triple-quoted-string string">"""spam"""</span>                          <span class="token comment"># 三重引号字符串，一般用于函数说明</span>\n    S <span class="token operator">=</span> <span class="token string">r\'\\temp\'</span>                            <span class="token comment"># Raw字符串，不会进行转义，抑制转义</span>\n    S <span class="token operator">=</span> <span class="token string">b\'Spam\'</span>                             <span class="token comment"># Python3中的字节字符串</span>\n    S <span class="token operator">=</span> <span class="token string">u\'spam\'</span>                             <span class="token comment"># Python2.6中的Unicode字符串</span>\n    s1<span class="token operator">+</span>s2<span class="token punctuation">,</span> s1<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>       <span class="token comment"># 字符串操作</span>\n    <span class="token string">\'a %s parrot\'</span> <span class="token operator">%</span> <span class="token string">\'kind\'</span>                  <span class="token comment"># 字符串格式化表达式</span>\n    <span class="token string">\'a {1} {0} parrot\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'kind\'</span><span class="token punctuation">,</span> <span class="token string">\'red\'</span><span class="token punctuation">)</span><span class="token comment"># 字符串格式化方法</span>\n    <span class="token keyword">for</span> x <span class="token keyword">in</span> s<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                    <span class="token comment"># 字符串迭代，成员关系</span>\n    <span class="token punctuation">[</span>x<span class="token operator">*</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> s<span class="token punctuation">]</span>                        <span class="token comment"># 字符串列表解析</span>\n    <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 字符串输出，结果：a,b,c</span>\n\n<span class="token comment">#-- 内置str处理函数：</span>\n    str1 <span class="token operator">=</span> <span class="token string">"stringobject"</span>\n    str1<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>swapcase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>capitalize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 全部大写，全部小写、大小写转换，首字母大写，每个单词的首字母都大写</span>\n    str1<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，左对齐，右边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，右对齐，左边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>center<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                      <span class="token comment"># 获取固定长度，中间对齐，两边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>zfill<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，右对齐，左边不足用0补齐</span>\n    str1<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">,</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span>                <span class="token comment"># 查找字符串，可以指定起始及结束位置搜索</span>\n    str1<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span>                         <span class="token comment"># 从右边开始查找字符串</span>\n    str1<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span>                         <span class="token comment"># 查找字符串出现的次数</span>\n    <span class="token comment">#上面所有方法都可用index代替，不同的是使用index查找不到会抛异常，而find返回-1</span>\n    str1<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'old\'</span><span class="token punctuation">,</span><span class="token string">\'new\'</span><span class="token punctuation">)</span>               <span class="token comment"># 替换函数，替换old为new，参数中可以指定maxReplaceTimes，即替换指定次数的old为new</span>\n    str1<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment"># 默认删除空白符</span>\n    str1<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment"># 删除str1字符串中开头、结尾处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    str1<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment"># 删除str1字符串中开头处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    str1<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span>                        <span class="token comment"># 删除str1字符串中结尾处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span>                <span class="token comment"># 是否以start开头</span>\n    str1<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">\'end\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 是否以end结尾</span>\n    str1<span class="token punctuation">.</span>isalnum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isalpha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>islower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># 判断字符串是否全为字符、数字、小写、大写</span>\n\n<span class="token comment">#-- 三重引号编写多行字符串块，并且在代码折行处嵌入换行字符\\n</span>\n    mantra <span class="token operator">=</span> <span class="token triple-quoted-string string">"""hello world\n            hello python\n            hello my friend"""</span>\n    <span class="token comment"># mantra为"""hello world \\n hello python \\n hello my friend"""</span>\n\n<span class="token comment">#-- 索引和分片：</span>\n    S<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>–<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>                <span class="token comment"># 索引</span>\n    S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>        <span class="token comment"># 分片，第三个参数指定步长，如`S[1:10:2]`是从1位到10位没隔2位获取一个字符。</span>\n\n<span class="token comment">#-- 字符串转换工具：</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'42\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回(42, \'42\')</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'4.13\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4.13</span><span class="token punctuation">)</span>                <span class="token comment"># 返回(4.13, \'4.13\')</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'s\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回(115, \'s\')</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'1001\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                          <span class="token comment"># 将字符串作为二进制数字，转化为数字，返回9</span>\n    <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">oct</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>               <span class="token comment"># 将整数转化为二进制/八进制/十六进制字符串，返回(\'0b1101\', \'015\', \'0xd\')</span>\n\n<span class="token comment">#-- 另类字符串连接</span>\n    name <span class="token operator">=</span> <span class="token string">"wang"</span> <span class="token string">"hong"</span>                    <span class="token comment"># 单行，name = "wanghong"</span>\n    name <span class="token operator">=</span> <span class="token string">"wang"</span> \\\n            <span class="token string">"hong"</span>                          <span class="token comment"># 多行，name = "wanghong"</span>\n\n<span class="token comment">#-- Python中的字符串格式化实现1--字符串格式化表达式</span>\n    <span class="token triple-quoted-string string">"""\n    基于C语言的\'print\'模型，并且在大多数的现有的语言中使用。\n    通用结构：%[(name)][flag][width].[precision]typecode\n    """</span>\n    <span class="token string">"this is %d %s bird"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'dead\'</span><span class="token punctuation">)</span>                          <span class="token comment"># 一般的格式化表达式</span>\n    <span class="token string">"%s---%s---%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                      <span class="token comment"># 字符串输出：\'42---3.14---[1, 2, 3]\'</span>\n    <span class="token string">"%d...%6d...%-6d...%06d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span>         <span class="token comment"># 对齐方式及填充："1234...  1234...1234  ...001234"</span>\n    x <span class="token operator">=</span> <span class="token number">1.23456789</span>\n    <span class="token string">"%e | %f | %g"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>                                  <span class="token comment"># 对齐方式："1.234568e+00 | 1.234568 | 1.23457"</span>\n    <span class="token string">"%6.2f*%-6.2f*%06.2f*%+6.2f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>                 <span class="token comment"># 对齐方式：\'  1.23*1.23  *001.23* +1.23\'</span>\n    <span class="token string">"%(name1)d---%(name2)s"</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">"name1"</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"name2"</span><span class="token punctuation">:</span><span class="token string">"value2"</span><span class="token punctuation">}</span>    <span class="token comment"># 基于字典的格式化表达式</span>\n    <span class="token string">"%(name)s is %(age)d"</span> <span class="token operator">%</span> <span class="token builtin">vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># vars()函数调用返回一个字典，包含了所有本函数调用时存在的变量</span>\n\n<span class="token comment">#-- Python中的字符串格式化实现2--字符串格式化调用方法</span>\n    <span class="token comment"># 普通调用</span>\n    <span class="token string">"{0}, {1} and {2}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token string">\'ham\'</span><span class="token punctuation">,</span> <span class="token string">\'eggs\'</span><span class="token punctuation">)</span>            <span class="token comment"># 基于位置的调用</span>\n    <span class="token string">"{motto} and {pork}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>motto <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">,</span> pork <span class="token operator">=</span> <span class="token string">\'ham\'</span><span class="token punctuation">)</span>   <span class="token comment"># 基于Key的调用</span>\n    <span class="token string">"{motto} and {0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'ham\'</span><span class="token punctuation">,</span> motto <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">)</span>             <span class="token comment"># 混合调用</span>\n    <span class="token comment"># 添加键 属性 偏移量 (import sys)</span>\n    <span class="token string">"my {1[spam]} runs {0.platform}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token string">\'laptop\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                 <span class="token comment"># 基于位置的键和属性</span>\n    <span class="token string">"{config[spam]} {sys.platform}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys <span class="token operator">=</span> sys<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token string">\'laptop\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 基于Key的键和属性</span>\n    <span class="token string">"first = {0[0]}, second = {0[1]}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 基于位置的偏移量</span>\n    <span class="token comment"># 具体格式化</span>\n    <span class="token string">"{0:e}, {1:.3e}, {2:g}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">3.14159</span><span class="token punctuation">,</span> <span class="token number">3.14159</span><span class="token punctuation">,</span> <span class="token number">3.14159</span><span class="token punctuation">)</span>   <span class="token comment"># 输出\'3.141590e+00, 3.142e+00, 3.14159\'</span>\n    <span class="token string">"{fieldname:format_spec}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n    <span class="token comment"># 说明:</span>\n    <span class="token triple-quoted-string string">"""\n        fieldname是指定参数的一个数字或关键字, 后边可跟可选的".name"或"[index]"成分引用\n        format_spec ::=  [[fill]align][sign][#][0][width][,][.precision][type]\n        fill        ::=  &lt;any character>              #填充字符\n        align       ::=  "&lt;" | ">" | "=" | "^"        #对齐方式\n        sign        ::=  "+" | "-" | " "              #符号说明\n        width       ::=  integer                      #字符串宽度\n        precision   ::=  integer                      #浮点数精度\n        type        ::=  "b" | "c" | "d" | "e" | "E" | "f" | "F" | "g" | "G" | "n" | "o" | "s" | "x" | "X" | "%"\n    """</span>\n    <span class="token comment"># 例子:</span>\n        <span class="token string">\'={0:10} = {1:10}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token number">123.456</span><span class="token punctuation">)</span>    <span class="token comment"># 输出\'=spam       =    123.456\'</span>\n        <span class="token string">\'={0:>10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=      test=\'</span>\n        <span class="token string">\'={0:&lt;10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=test      =\'</span>\n        <span class="token string">\'={0:^10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=   test   =\'</span>\n        <span class="token string">\'{0:X}, {1:o}, {2:b}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>   <span class="token comment"># 输出\'FF, 377, 11111111\'</span>\n        <span class="token string">\'My name is {0:{1}}.\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'Fred\'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>       <span class="token comment"># 输出\'My name is Fred    .\'  动态指定参数</span>\n\n<span class="token comment">#-- 常用列表常量和操作</span>\n    L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'string\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>                        <span class="token comment"># 嵌套列表</span>\n    L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span>                                  <span class="token comment"># 列表初始化</span>\n    L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                             <span class="token comment"># 列表初始化</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">,</span> <span class="token string">\'spam\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token comment"># 列表解析</span>\n    <span class="token builtin">len</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>                                            <span class="token comment"># 求列表长度</span>\n    L<span class="token punctuation">.</span>count<span class="token punctuation">(</span>value<span class="token punctuation">)</span>                                    <span class="token comment"># 求列表中某个值的个数</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>                                     <span class="token comment"># 向列表的尾部添加数据，比如append(2)，添加元素2</span>\n    L<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>index<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>                              <span class="token comment"># 向列表的指定index位置添加数据，index及其之后的数据后移</span>\n    L<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>interable<span class="token punctuation">)</span>                               <span class="token comment"># 通过添加iterable中的元素来扩展列表，比如extend([2])，添加元素2，注意和append的区别</span>\n    L<span class="token punctuation">.</span>index<span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">[</span>start<span class="token punctuation">,</span> <span class="token punctuation">[</span>stop<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 返回列表中值value的第一个索引</span>\n    L<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>                                    <span class="token comment"># 删除并返回index处的元素，默认为删除并返回最后一个元素</span>\n    L<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>value<span class="token punctuation">)</span>                                   <span class="token comment"># 删除列表中的value值，只删除第一次出现的value的值</span>\n    L<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># 反转列表</span>\n    L<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token builtin">cmp</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>         <span class="token comment"># 排序列表</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                         <span class="token comment"># 注意，这里不会引发IndexError异常，只会返回一个空的列表[]</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                                  <span class="token comment"># 这里实在原有列表的基础上进行操作，即列表的id没有改变</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                               <span class="token comment"># 这里最后的a要构建一个新的列表，即a的id发生了变化</span>\n\n<span class="token comment">#-- 用切片来删除序列的某一段</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>\n    a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                       <span class="token comment"># a = [1, 5, 6, 7]</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>\n    <span class="token keyword">del</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                                        <span class="token comment"># 去除偶数项(偶数索引的)，a = [1, 3, 5, 7]</span>\n\n<span class="token comment">#-- 常用字典常量和操作</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'tol\'</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">\'ham\'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>                   <span class="token comment"># 嵌套字典</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>                  <span class="token comment"># {\'s\': 8, \'d\': 8}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">\'tom\'</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">)</span>                  <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'tom\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'age\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'tom\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment"># 字典键、值以及键值对</span>\n    D<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span>                               <span class="token comment"># get函数</span>\n    D<span class="token punctuation">.</span>update<span class="token punctuation">(</span>D_other<span class="token punctuation">)</span>                                 <span class="token comment"># 合并字典，如果存在相同的键值，D_other的数据会覆盖掉D的数据</span>\n    D<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span>D<span class="token punctuation">]</span><span class="token punctuation">)</span>                                   <span class="token comment"># 删除字典中键值为key的项，返回键值为key的值，如果不存在，返回默认值D，否则异常</span>\n    D<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># pop字典中随机的一项（一个键值对）</span>\n    D<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>k<span class="token punctuation">[</span><span class="token punctuation">,</span> d<span class="token punctuation">]</span><span class="token punctuation">)</span>                              <span class="token comment"># 设置D中某一项的默认值。如果k存在，则返回D[k]，否则设置D[k]=d，同时返回D[k]。</span>\n    <span class="token keyword">del</span> D                                             <span class="token comment"># 删除字典</span>\n    <span class="token keyword">del</span> D<span class="token punctuation">[</span><span class="token string">\'key\'</span><span class="token punctuation">]</span>                                      <span class="token comment"># 删除字典的某一项</span>\n    <span class="token keyword">if</span> key <span class="token keyword">in</span> D<span class="token punctuation">:</span>   <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> D<span class="token punctuation">:</span>                   <span class="token comment"># 测试字典键是否存在</span>\n    <span class="token comment"># 字典注意事项：（1）对新索引赋值会添加一项（2）字典键不一定非得是字符串，也可以为任何的不可变对象</span>\n    <span class="token comment"># 不可变对象：调用对象自身的任意方法，也不会改变该对象自身的内容，这些方法会创建新的对象并返回。</span>\n    <span class="token comment"># 字符串、整数、tuple都是不可变对象，dict、set、list都是可变对象</span>\n    D<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>                                    <span class="token comment"># tuple作为字典的key</span>\n\n<span class="token comment">#-- 字典解析</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span><span class="token number">8</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>                     <span class="token comment"># {\'s\': 8, \'d\': 8}</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span>v <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'tom\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>       <span class="token comment"># {\'age\': 12, \'name\': tom}</span>\n\n<span class="token comment">#-- 字典的特殊方法__missing__：当查找找不到key时，会执行该方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n    dct <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    dct<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 这有点类似于collections.defalutdict</span>\n    dct<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span>              <span class="token comment"># [1]</span>\n\n<span class="token comment">#-- 元组和列表的唯一区别在于元组是不可变对象，列表是可变对象</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>           <span class="token comment"># a[1] = 0, OK</span>\n    a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>           <span class="token comment"># a[1] = 0, Error</span>\n    a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span>           <span class="token comment"># a[0][1] = 0, OK</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token comment"># a[0][1] = 0, Error</span>\n\n<span class="token comment">#-- 元组的特殊语法: 逗号和圆括号</span>\n    D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>                <span class="token comment"># 此时D为一个整数 即D = 12</span>\n    D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>              <span class="token comment"># 此时D为一个元组 即D = (12, )</span>\n\n<span class="token comment">#-- 文件基本操作</span>\n    output <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r\'C:\\spam\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>          <span class="token comment"># 打开输出文件，用于写</span>\n    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>               <span class="token comment"># 打开输入文件，用于读。打开的方式可以为\'w\', \'r\', \'a\', \'wb\', \'rb\', \'ab\'等</span>\n    fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># size为读取的长度，以byte为单位</span>\n    fp<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 读一行，如果定义了size，有可能返回的只是一行的一部分</span>\n    fp<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 把文件每一行作为一个list的一个成员，并返回这个list。其实它的内部是通过循环调用readline()来实现的。如果提供size参数，size是表示读取内容的总长。</span>\n    fp<span class="token punctuation">.</span>readable<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 是否可读</span>\n    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>                           <span class="token comment"># 把str写到文件中，write()并不会在str后加上一个换行符</span>\n    fp<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>seq<span class="token punctuation">)</span>                      <span class="token comment"># 把seq的内容全部写到文件中(多行一次性写入)</span>\n    fp<span class="token punctuation">.</span>writeable<span class="token punctuation">(</span><span class="token punctuation">)</span>                          <span class="token comment"># 是否可写</span>\n    fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 关闭文件。</span>\n    fp<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 把缓冲区的内容写入硬盘</span>\n    fp<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># 返回一个长整型的”文件标签“</span>\n    fp<span class="token punctuation">.</span>isatty<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># 文件是否是一个终端设备文件（unix系统中的）</span>\n    fp<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># 返回文件操作标记的当前位置，以文件的开头为原点</span>\n    fp<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># 返回下一行，并将文件操作标记位移到下一行。把一个file用于for … in file这样的语句时，就是调用next()函数来实现遍历的。</span>\n    fp<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token punctuation">,</span>whence<span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token comment"># 将文件打开操作标记移到offset的位置。whence为0表示从头开始计算，1表示以当前位置为原点计算。2表示以文件末尾为原点进行计算。</span>\n    fp<span class="token punctuation">.</span>seekable<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 是否可以seek</span>\n    fp<span class="token punctuation">.</span>truncate<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 把文件裁成规定的大小，默认的是裁到当前文件操作标记的位置。</span>\n    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>                         <span class="token comment"># 使用for语句，比较适用于打开比较大的文件</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment"># 使用with语句，可以保证文件关闭</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>\n        lines <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 一次读入文件所有行，并关闭文件</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'f.txt\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>     <span class="token comment"># Python3.x Unicode文本文件</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'f.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>                     <span class="token comment"># Python3.x 二进制bytes文件</span>\n    <span class="token comment"># 文件对象还有相应的属性：buffer closed encoding errors line_buffering name newlines等</span>\n\n<span class="token comment">#-- 其他</span>\n    <span class="token comment"># Python中的真假值含义：1. 数字如果非零，则为真，0为假。 2. 其他对象如果非空，则为真</span>\n    <span class="token comment"># 通常意义下的类型分类：1. 数字、序列、映射。 2. 可变类型和不可变类型</span>\n\n\n<span class="token triple-quoted-string string">"""语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句"""</span>\n\n<span class="token comment">#-- 赋值语句的形式</span>\n    spam <span class="token operator">=</span> <span class="token string">\'spam\'</span>                          <span class="token comment"># 基本形式</span>\n    spam<span class="token punctuation">,</span> ham <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token string">\'ham\'</span>              <span class="token comment"># 元组赋值形式</span>\n    <span class="token punctuation">[</span>spam<span class="token punctuation">,</span> ham<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>               <span class="token comment"># 列表赋值形式</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token string">\'abcd\'</span>                    <span class="token comment"># 序列赋值形式</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token string">\'spam\'</span>                      <span class="token comment"># 序列解包形式（Python3.x中才有）</span>\n    spam <span class="token operator">=</span> ham <span class="token operator">=</span> <span class="token string">\'no\'</span>                      <span class="token comment"># 多目标赋值运算，涉及到共享引用</span>\n    spam <span class="token operator">+=</span> <span class="token number">42</span>                             <span class="token comment"># 增强赋值，涉及到共享引用</span>\n\n<span class="token comment">#-- 序列赋值 序列解包</span>\n    <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                  <span class="token comment"># a = 1, b = 2, c = 3</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token string">"spam"</span>                    <span class="token comment"># a = \'s\', b = \'p\', c = \'a\', d = \'m\'</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                     <span class="token comment"># a = 0, b = 1, c = 2</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                   <span class="token comment"># a = 1, b = [2, 3, 4]</span>\n    <span class="token operator">*</span>a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                   <span class="token comment"># a = [1, 2, 3], b = 4</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                <span class="token comment"># a = 1, b = [2, 3], c = 4</span>\n    <span class="token comment"># 带有*时 会优先匹配*之外的变量 如</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>                      <span class="token comment"># a = 1, c = 2, b = []</span>\n\n<span class="token comment">#-- print函数原型</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">\' \'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">\'\\n\'</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>\n    <span class="token comment"># 流的重定向</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>                   <span class="token comment"># 等于sys.stdout.write(\'hello world\')</span>\n    temp <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdout                      <span class="token comment"># 原有流的保存</span>\n    sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'log.log\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span>      <span class="token comment"># 流的重定向</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>                   <span class="token comment"># 写入到文件log.log</span>\n    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> temp                      <span class="token comment"># 原有流的复原</span>\n\n<span class="token comment">#-- Python中and或or总是返回对象(左边的对象或右边的对象) 且具有短路求值的特性</span>\n    <span class="token number">1</span> <span class="token keyword">or</span> <span class="token number">2</span> <span class="token keyword">or</span> <span class="token number">3</span>                            <span class="token comment"># 返回 1</span>\n    <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">2</span> <span class="token keyword">and</span> <span class="token number">3</span>                          <span class="token comment"># 返回 3</span>\n\n<span class="token comment">#-- if/else三元表达符（if语句在行内）</span>\n    A <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> X <span class="token keyword">else</span> <span class="token number">2</span>\n    A <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> X <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token keyword">if</span> Y <span class="token keyword">else</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token comment"># 也可以使用and-or语句（一条语句实现多个if-else）</span>\n    a <span class="token operator">=</span> <span class="token number">6</span>\n    result <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token number">20</span> <span class="token keyword">and</span> <span class="token string">"big than 20"</span> <span class="token keyword">or</span> a <span class="token operator">></span> <span class="token number">10</span> <span class="token keyword">and</span> <span class="token string">"big than 10"</span> <span class="token keyword">or</span> a <span class="token operator">></span> <span class="token number">5</span> <span class="token keyword">and</span> <span class="token string">"big than 5"</span><span class="token punctuation">)</span>    <span class="token comment"># 返回"big than 5"</span>\n\n<span class="token comment">#-- Python的while语句或者for语句可以带else语句 当然也可以带continue/break/pass语句</span>\n    <span class="token keyword">while</span> a <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>\n        anything\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        anything\n    <span class="token comment"># else语句会在循环结束后执行，除非在循环中执行了break，同样的还有for语句</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        anything\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        anything\n\n<span class="token comment">#-- for循环的元组赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                   <span class="token comment"># 最简单的赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token comment"># 自动解包赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"XY"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>      <span class="token comment"># 自动解包 a = X, b = Y, c = 6</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token comment"># 自动解包赋值</span>\n\n<span class="token comment">#-- 列表解析语法</span>\n    M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">]</span>                     <span class="token comment"># G = [6, 15, 24] 一般的列表解析 生成一个列表</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token string">\'spam\'</span><span class="token punctuation">]</span>                     <span class="token comment"># [\'ss\', \'pp\', \'aa\', \'mm\']</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token operator">*</span> b <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 多解析过程 返回[4, 5, 8, 10]</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">if</span> a <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">]</span>             <span class="token comment"># 带判断条件的解析过程</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token keyword">if</span> a <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 带判断条件的高级解析过程</span>\n    <span class="token comment"># 两个列表同时解析：使用zip函数</span>\n    <span class="token keyword">for</span> teama<span class="token punctuation">,</span> teamb <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Packers"</span><span class="token punctuation">,</span> <span class="token string">"49ers"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"Ravens"</span><span class="token punctuation">,</span> <span class="token string">"Patriots"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>teama <span class="token operator">+</span> <span class="token string">" vs. "</span> <span class="token operator">+</span> teamb<span class="token punctuation">)</span>\n    <span class="token comment"># 带索引的列表解析：使用enumerate函数</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> team <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Packers"</span><span class="token punctuation">,</span> <span class="token string">"49ers"</span><span class="token punctuation">,</span> <span class="token string">"Ravens"</span><span class="token punctuation">,</span> <span class="token string">"Patriots"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> team<span class="token punctuation">)</span>                            <span class="token comment"># 输出0, Packers \\n 1, 49ers \\n ......</span>\n\n<span class="token comment">#-- 生成器表达式</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">)</span>                       <span class="token comment"># 使用小括号可以创建所需结果的生成器generator object</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                         <span class="token comment"># 输出(6, 15, 24)</span>\n    G <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">}</span>                       <span class="token comment"># G = {6, 15, 24} 解析语法还可以生成集合和字典</span>\n    G <span class="token operator">=</span> <span class="token punctuation">{</span>i<span class="token punctuation">:</span><span class="token builtin">sum</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span>               <span class="token comment"># G = {0: 6, 1: 15, 2: 24}</span>\n\n<span class="token comment">#-- 文档字符串:出现在Module的开端以及其中函数或类的开端 使用三重引号字符串</span>\n    <span class="token triple-quoted-string string">"""\n    module document\n    """</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">"""\n        function document\n        """</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span> <span class="token class-name">Employee</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">"""\n        class document\n        """</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span>                <span class="token comment"># 输出函数文档字符串</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>Employee<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span>            <span class="token comment"># 输出类的文档字符串</span>\n\n<span class="token comment">#-- 命名惯例:</span>\n    <span class="token triple-quoted-string string">"""\n    以单一下划线开头的变量名(_X)不会被from module import*等语句导入\n    前后有两个下划线的变量名(__X__)是系统定义的变量名，对解释器有特殊意义\n    以两个下划线开头但不以下划线结尾的变量名(__X)是类的本地(私有)变量\n    """</span>\n\n<span class="token comment">#-- 列表解析 in成员关系测试 map sorted zip enumerate内置函数等都使用了迭代协议</span>\n    <span class="token string">\'first line\'</span> <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span>   <span class="token comment"># in测试 返回True或False</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">.</span>upper<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># map内置函数</span>\n    <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment"># sorted内置函数</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># zip内置函数 [(1, 3), (2, 4)]</span>\n\n<span class="token comment">#-- del语句: 手动删除某个变量</span>\n    <span class="token keyword">del</span> X\n\n<span class="token comment">#-- 获取列表的子表的方法:</span>\n    x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>\n    x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>                              <span class="token comment"># 前3个[1,2,3]</span>\n    x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>                             <span class="token comment"># 中间4个[2,3,4,5]</span>\n    x<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                             <span class="token comment"># 最后3个[4,5,6]</span>\n    x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                             <span class="token comment"># 奇数项[1,3,5]</span>\n    x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                            <span class="token comment"># 偶数项[2,4,6]</span>\n\n<span class="token comment">#-- 手动迭代：iter和next</span>\n    L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n    I <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>                        <span class="token comment"># I为L的迭代器</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回1</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回2</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># Error:StopIteration</span>\n\n<span class="token comment">#-- Python中的可迭代对象</span>\n    <span class="token triple-quoted-string string">"""\n    1.range迭代器\n    2.map、zip和filter迭代器\n    3.字典视图迭代器：D.keys()), D.items()等\n    4.文件类型\n    """</span>\n\n\n<span class="token triple-quoted-string string">"""函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则"""</span>\n\n<span class="token comment">#-- 函数相关的语句和表达式</span>\n    myfunc<span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span>                     <span class="token comment"># 函数调用</span>\n    <span class="token keyword">def</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                      <span class="token comment"># 函数定义</span>\n    <span class="token keyword">return</span> <span class="token boolean">None</span>                        <span class="token comment"># 函数返回值</span>\n    <span class="token keyword">global</span> a                           <span class="token comment"># 全局变量</span>\n    <span class="token keyword">nonlocal</span> x                         <span class="token comment"># 在函数或其他作用域中使用外层（非全局）变量</span>\n    <span class="token keyword">yield</span> x                            <span class="token comment"># 生成器函数返回</span>\n    <span class="token keyword">lambda</span>                             <span class="token comment"># 匿名函数</span>\n\n<span class="token comment">#-- Python函数变量名解析:LEGB原则，即:</span>\n    <span class="token triple-quoted-string string">"""\n    local(functin) --> encloseing function locals --> global(module) --> build-in(python)\n    说明:以下边的函数maker为例 则相对于action而言 X为Local N为Encloseing\n    """</span>\n\n<span class="token comment">#-- 嵌套函数举例:工厂函数</span>\n    <span class="token keyword">def</span> <span class="token function">maker</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> X <span class="token operator">**</span> N\n        <span class="token keyword">return</span> action\n    f <span class="token operator">=</span> maker<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># pass 2 to N</span>\n    f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                               <span class="token comment"># 9, pass 3 to X</span>\n\n<span class="token comment">#-- 嵌套函数举例:lambda实例</span>\n    <span class="token keyword">def</span> <span class="token function">maker</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> X<span class="token punctuation">:</span> X<span class="token operator">**</span>N<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> action\n    f <span class="token operator">=</span> maker<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># pass 2 to N</span>\n    f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                               <span class="token comment"># 9, pass 3 to X</span>\n\n<span class="token comment">#-- nonlocal和global语句的区别</span>\n    <span class="token comment"># nonlocal应用于一个嵌套的函数的作用域中的一个名称 例如:</span>\n    start <span class="token operator">=</span> <span class="token number">100</span>\n    <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">nonlocal</span> start             <span class="token comment"># 指定start为tester函数内的local变量 而不是global变量start</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> start<span class="token punctuation">)</span>\n            start <span class="token operator">+=</span> <span class="token number">3</span>\n        <span class="token keyword">return</span> nested\n    <span class="token comment"># global为全局的变量 即def之外的变量</span>\n    <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">global</span> start               <span class="token comment"># 指定start为global变量start</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> start<span class="token punctuation">)</span>\n            start <span class="token operator">+=</span> <span class="token number">3</span>\n        <span class="token keyword">return</span> nested\n\n<span class="token comment">#-- 函数参数，不可变参数通过“值”传递，可变参数通过“引用”传递</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment"># 参数位置匹配</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>                 <span class="token comment"># 参数关键字匹配</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                               <span class="token comment"># 默认参数匹配</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                            <span class="token comment"># 默认参数匹配</span>\n    f<span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>                    <span class="token comment"># 关键字参数和默认参数的混合</span>\n    <span class="token comment"># Keyword-Only参数:出现在*args之后 必须用关键字进行匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span>   <span class="token comment"># c就为keyword-only匹配 必须使用关键字c = value匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># b c为keyword-only匹配 必须使用关键字匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token comment"># b有默认值 或者省略 或者使用关键字参数b = value</span>\n\n<span class="token comment">#-- 可变参数匹配: * 和 **</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>          <span class="token comment"># 在元组中收集不匹配的位置参数</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment"># 输出(1, 2, 3)</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>         <span class="token comment"># 在字典中收集不匹配的关键字参数</span>\n    f<span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出{\'a\':1, \'b\':2}</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token operator">**</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment"># 两者混合使用</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>               <span class="token comment"># 输出1, (2, 3), {\'x\':4, \'y\':5}</span>\n\n<span class="token comment">#-- 函数调用时的参数解包: * 和 ** 分别解包元组和字典</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token string">\'c\'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token string">\'c\'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 函数属性:(自己定义的)函数可以添加属性</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    func<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span>                     <span class="token comment"># 自定义函数添加属性</span>\n    <span class="token keyword">print</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span>                    <span class="token comment"># Error 内置函数不可以添加属性</span>\n\n<span class="token comment">#-- 函数注解: 编写在def头部行 主要用于说明参数范围、参数类型、返回值类型等</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span><span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span> <span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    func<span class="token punctuation">.</span>__annotations__               <span class="token comment"># {\'c\':&lt;class \'float\'>, \'b\':(1, 10), \'a\':\'spam\', \'return\':&lt;class \'int\'>}</span>\n    <span class="token comment"># 编写注解的同时 还是可以使用函数默认值 并且注解的位置位于=号的前边</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token string">\'spam\'</span><span class="token operator">=</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span><span class="token builtin">float</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span> <span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 匿名函数:lambda</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">:</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z     <span class="token comment"># 普通匿名函数，使用方法f(1, 2, 3)</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> x <span class="token operator">+</span> y     <span class="token comment"># 带默认参数的lambda函数</span>\n    <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>                     <span class="token comment"># 嵌套lambda函数</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> y <span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> a <span class="token keyword">if</span> xxx<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> b      <span class="token comment"># 无参数的lambda函数，使用方法f()</span>\n\n<span class="token comment">#-- lambda函数与map filter reduce函数的结合</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment"># [2, 3, 4]</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># [1, 2, 3, 4]</span>\n    functools<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 6</span>\n    functools<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 24</span>\n\n<span class="token comment">#-- 生成器函数:yield VS return</span>\n    <span class="token keyword">def</span> <span class="token function">gensquare</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i<span class="token operator">**</span> <span class="token number">2</span>                <span class="token comment"># 状态挂起 可以恢复到此时的状态</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> gensquare<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 使用方法</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">\' \'</span><span class="token punctuation">)</span>            <span class="token comment"># [0, 1, 4, 9, 16]</span>\n    x <span class="token operator">=</span> gensquare<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                   <span class="token comment"># x是一个生成对象</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 返回0</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 返回1</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 抛出异常StopIteration</span>\n\n<span class="token comment">#-- 生成器表达式:小括号进行列表解析</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">**</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 使用小括号可以创建所需结果的生成器generator object</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>          <span class="token comment"># 和上述中的生成器函数的返回值一致</span>\n    <span class="token comment">#（1）生成器(生成器函数/生成器表达式)是单个迭代对象</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">**</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    I1 <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                       <span class="token comment"># 这里实际上iter(G) = G</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span>                           <span class="token comment"># 输出0</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                            <span class="token comment"># 输出1</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span>                           <span class="token comment"># 输出4</span>\n    <span class="token comment">#（2）生成器不保留迭代后的结果</span>\n    gen <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token number">2</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回True</span>\n    <span class="token number">3</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回True</span>\n    <span class="token number">1</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回False，其实检测2的时候，1已经就不在生成器中了，即1已经被迭代过了，同理2、3也不在了</span>\n\n<span class="token comment">#-- 本地变量是静态检测的</span>\n    X <span class="token operator">=</span> <span class="token number">22</span>                             <span class="token comment"># 全局变量X的声明和定义</span>\n    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                       <span class="token comment"># 如果没有下一语句 则该句合法 打印全局变量X</span>\n        X <span class="token operator">=</span> <span class="token number">88</span>                         <span class="token comment"># 这一语句使得上一语句非法 因为它使得X变成了本地变量 上一句变成了打印一个未定义的本地变量(局部变量)</span>\n        <span class="token keyword">if</span> <span class="token boolean">False</span><span class="token punctuation">:</span>                      <span class="token comment"># 即使这样的语句 也会把print语句视为非法语句 因为:</span>\n            X <span class="token operator">=</span> <span class="token number">88</span>                     <span class="token comment"># Python会无视if语句而仍然声明了局部变量X</span>\n    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token comment"># 改进</span>\n        <span class="token keyword">global</span> X                       <span class="token comment"># 声明变量X为全局变量</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                       <span class="token comment"># 打印全局变量X</span>\n        X <span class="token operator">=</span> <span class="token number">88</span>                         <span class="token comment"># 改变全局变量X</span>\n\n<span class="token comment">#-- 函数的默认值是在函数定义的时候实例化的 而不是在调用的时候 例子:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>numbers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>               <span class="token comment"># 这里的[]是可变的</span>\n        numbers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># first time, like before, [9]</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># second time, not like before, [9, 9]</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># third time, not like before too, [9, 9, 9]</span>\n    <span class="token comment"># 改进:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>numbers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> numbers <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        numbers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    <span class="token comment"># 另外一个例子 参数的默认值为不可变的:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                  <span class="token comment"># 这里的0是数字, 是不可变的</span>\n        count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 输出1</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 还是输出1</span>\n    foo<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                             <span class="token comment"># 输出4</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 还是输出1</span>\n\n\n<span class="token triple-quoted-string string">"""函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子"""</span>\n\n    <span class="token triple-quoted-string string">"""数学运算类"""</span>\n    <span class="token builtin">abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 求绝对值，参数可以是整型，也可以是复数，若参数是复数，则返回复数的模</span>\n    <span class="token builtin">complex</span><span class="token punctuation">(</span><span class="token punctuation">[</span>real<span class="token punctuation">[</span><span class="token punctuation">,</span> imag<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># 创建一个复数</span>\n    <span class="token builtin">divmod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>                        <span class="token comment"># 分别取商和余数，注意：整型、浮点型都可以</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>                          <span class="token comment"># 将一个字符串或数转换为浮点数。如果无参数将返回0.0</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> base<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 将一个字符串或浮点数转换为int类型，base表示进制</span>\n    <span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> base<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 将一个字符串或浮点数转换为long类型</span>\n    <span class="token builtin">pow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>                           <span class="token comment"># 返回x的y次幂</span>\n    <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">,</span> stop<span class="token punctuation">[</span><span class="token punctuation">,</span> step<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment"># 产生一个序列，默认从0开始</span>\n    <span class="token builtin">round</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> n<span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 四舍五入</span>\n    <span class="token builtin">sum</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> start<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token comment"># 对集合求和</span>\n    <span class="token builtin">oct</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将一个数字转化为8进制字符串</span>\n    <span class="token builtin">hex</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将一个数字转换为16进制字符串</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>                              <span class="token comment"># 返回给定int类型对应的ASCII字符</span>\n    <span class="token builtin">unichr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>                           <span class="token comment"># 返回给定int类型的unicode</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>                              <span class="token comment"># 返回ASCII字符对应的整数</span>\n    <span class="token builtin">bin</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将整数x转换为二进制字符串</span>\n    <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>                           <span class="token comment"># 将x转换为Boolean类型</span>\n\n    <span class="token triple-quoted-string string">"""集合类操作"""</span>\n    <span class="token builtin">basestring</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># str和unicode的超类，不能直接调用，可以用作isinstance判断</span>\n    <span class="token builtin">format</span><span class="token punctuation">(</span>value <span class="token punctuation">[</span><span class="token punctuation">,</span> format_spec<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 格式化输出字符串，格式化的参数顺序从0开始，如“I am {0},I like {1}”</span>\n    <span class="token builtin">enumerate</span><span class="token punctuation">(</span>sequence<span class="token punctuation">[</span><span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token comment"># 返回一个可枚举的对象，注意它有第二个参数</span>\n    <span class="token builtin">iter</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token punctuation">,</span> sentinel<span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 生成一个对象的迭代器，第二个参数表示分隔符</span>\n    <span class="token builtin">max</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 返回集合中的最大值</span>\n    <span class="token builtin">min</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 返回集合中的最小值</span>\n    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># 创建数据字典</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 将一个集合类转换为另外一个集合类</span>\n    <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># set对象实例化</span>\n    <span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 产生一个不可变的set</span>\n    <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 生成一个tuple类型</span>\n    <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 转换为string类型</span>\n    <span class="token builtin">sorted</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token builtin">cmp</span><span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">,</span> reverse<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># 集合排序</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n        <span class="token builtin">sorted</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>       <span class="token comment"># 使用Key参数和reverse参数</span>\n        <span class="token builtin">sorted</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token comment"># 使用key参数进行多条件排序，即如果x[0]相同，则比较x[1]</span>\n\n    <span class="token triple-quoted-string string">"""逻辑判断"""</span>\n    <span class="token builtin">all</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>                       <span class="token comment"># 集合中的元素都为真的时候为真，特别的，若为空串返回为True</span>\n    <span class="token builtin">any</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>                       <span class="token comment"># 集合中的元素有一个为真的时候为真，特别的，若为空串返回为False</span>\n    <span class="token builtin">cmp</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>                           <span class="token comment"># 如果x &lt; y ,返回负数；x == y, 返回0；x > y,返回正数</span>\n\n    <span class="token triple-quoted-string string">"""IO操作"""</span>\n    <span class="token builtin">file</span><span class="token punctuation">(</span>filename <span class="token punctuation">[</span><span class="token punctuation">,</span> mode <span class="token punctuation">[</span><span class="token punctuation">,</span> bufsize<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># file类型的构造函数。</span>\n    <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 获取用户输入，推荐使用raw_input，因为该函数将不会捕获用户的错误输入，意思是自行判断类型</span>\n    <span class="token comment"># 在 Built-in Functions 里有一句话是这样写的：Consider using the raw_input() function for general input from users.</span>\n    <span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">)</span>                 <span class="token comment"># 设置输入，输入都是作为字符串处理</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">[</span><span class="token punctuation">,</span> buffering<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># 打开文件，与file有什么不同？推荐使用open</span>\n\n    <span class="token triple-quoted-string string">"""其他"""</span>\n    <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                    <span class="token comment"># 检查对象object是否可调用</span>\n    <span class="token builtin">classmethod</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>                   <span class="token comment"># 用来说明这个func是个类方法</span>\n    <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>                  <span class="token comment"># 用来说明这个func为静态方法</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 不带参数时，返回当前范围内的变量、方法和定义的类型列表；带参数时，返回参数的属性、方法列表。</span>\n    <span class="token builtin">help</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>                           <span class="token comment"># 返回obj的帮助信息</span>\n    <span class="token builtin">eval</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span>                    <span class="token comment"># 计算表达式expression的值，并返回</span>\n    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>                           <span class="token comment"># 将str作为Python语句执行</span>\n    <span class="token builtin">execfile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>                  <span class="token comment"># 用法类似exec()，不同的是execfile的参数filename为文件名，而exec的参数为字符串。</span>\n    <span class="token builtin">filter</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">)</span>          <span class="token comment"># 构造一个序列，等价于[item for item in iterable if function(item)]，function返回值为True或False的函数</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 返回[-3, -2, -1, 1, 2, 3], 没有0</span>\n    <span class="token builtin">hasattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>               <span class="token comment"># 判断对象object是否包含名为name的特性</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name <span class="token punctuation">[</span><span class="token punctuation">,</span> defalut<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 获取一个类的属性</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>        <span class="token comment"># 设置属性值</span>\n    <span class="token builtin">delattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>               <span class="token comment"># 删除object对象名为name的属性</span>\n    <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回一个描述当前全局符号表的字典</span>\n    <span class="token builtin">hash</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 如果对象object为哈希表类型，返回对象object的哈希值</span>\n    <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                          <span class="token comment"># 返回对象的唯一标识，一串数字</span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> classinfo<span class="token punctuation">)</span>       <span class="token comment"># 判断object是否是class的实例</span>\n        <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>              <span class="token comment"># 判断是不是int类型</span>\n        <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># isinstance的第二个参数接受一个元组类型</span>\n    <span class="token builtin">issubclass</span><span class="token punctuation">(</span><span class="token keyword">class</span><span class="token punctuation">,</span> classinfo<span class="token punctuation">)</span>        <span class="token comment"># 判断class是否为classinfo的子类</span>\n    <span class="token builtin">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment"># 返回当前的变量列表</span>\n    <span class="token builtin">map</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>        <span class="token comment"># 遍历每个元素，执行function操作</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 返回[3, 2, 1, 0, 1, 2, 3]</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>iterator<span class="token punctuation">[</span><span class="token punctuation">,</span> default<span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment"># 类似于iterator.next()</span>\n    <span class="token builtin">property</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fget<span class="token punctuation">[</span><span class="token punctuation">,</span> fset<span class="token punctuation">[</span><span class="token punctuation">,</span> fdel<span class="token punctuation">[</span><span class="token punctuation">,</span> doc<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment"># 属性访问的包装类，设置后可以通过c.x=value等来访问setter和getter</span>\n    <span class="token builtin">reduce</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> initializer<span class="token punctuation">]</span><span class="token punctuation">)</span>         <span class="token comment"># 合并操作，从第一个开始是前两个参数，然后是前两个的结果与第三个合并进行处理，以此类推</span>\n        <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">return</span> x <span class="token operator">+</span> y\n        <span class="token builtin">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment"># 返回55 (注:1+2+3+4+5+6+7+8+9+10 = 55)</span>\n        <span class="token builtin">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>                 <span class="token comment"># 返回75</span>\n    <span class="token builtin">reload</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>                      <span class="token comment"># 重新加载模块</span>\n    <span class="token builtin">repr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 将一个对象变幻为可打印的格式</span>\n    <span class="token builtin">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">[</span><span class="token punctuation">,</span> step<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment"># 产生分片对象</span>\n    <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 返回该object的类型</span>\n    <span class="token builtin">vars</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回对象的变量名、变量值的字典</span>\n        a <span class="token operator">=</span> Class<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment"># Class为一个空类</span>\n        a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'qi\'</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">9</span>\n        <span class="token builtin">vars</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                         <span class="token comment"># {\'name\':\'qi\', \'age\':9}</span>\n    <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token comment"># 返回对应数组</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># [(1, 4), (2, 5), (3, 6)]</span>\n        a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span>\n        z <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>                   <span class="token comment"># 压缩：[(1, "a"), (2, "b"), (3, "c")]</span>\n        <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>z<span class="token punctuation">)</span>                         <span class="token comment"># 解压缩：[(1, 2, 3), ("a", "b", "c")]</span>\n    <span class="token builtin">unicode</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>   <span class="token comment"># 将字符串string转化为unicode形式，string为encoded string。</span>\n\n\n<span class="token triple-quoted-string string">"""模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle"""</span>\n\n<span class="token comment">#-- Python模块搜索路径:</span>\n    <span class="token triple-quoted-string string">"""\n    (1)程序的主目录    (2)PYTHONPATH目录 (3)标准链接库目录 (4)任何.pth文件的内容\n    """</span>\n\n<span class="token comment">#-- 查看全部的模块搜索路径</span>\n    <span class="token keyword">import</span> sys\n    sys<span class="token punctuation">.</span>path\n    sys<span class="token punctuation">.</span>argv                            <span class="token comment"># 获得脚本的参数</span>\n    sys<span class="token punctuation">.</span>builtin_module_names            <span class="token comment"># 查找内建模块</span>\n    sys<span class="token punctuation">.</span>platform                        <span class="token comment"># 返回当前平台 出现如： "win32" "linux" "darwin"等</span>\n    sys<span class="token punctuation">.</span>modules                         <span class="token comment"># 查找已导入的模块</span>\n    sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stdout                          <span class="token comment"># stdout 和 stderr 都是类文件对象，但是它们都是只写的。它们都没有 read 方法，只有 write 方法</span>\n    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stderr\n    sys<span class="token punctuation">.</span>stdin\n\n<span class="token comment">#-- 模块的使用代码</span>\n    <span class="token keyword">import</span> module1<span class="token punctuation">,</span> module2             <span class="token comment"># 导入module1 使用module1.printer()</span>\n    <span class="token keyword">from</span> module1 <span class="token keyword">import</span> printer         <span class="token comment"># 导入module1中的printer变量 使用printer()</span>\n    <span class="token keyword">from</span> module1 <span class="token keyword">import</span> <span class="token operator">*</span>               <span class="token comment"># 导入module1中的全部变量 使用不必添加module1前缀</span>\n\n<span class="token comment">#-- 重载模块reload: 这是一个内置函数 而不是一条语句</span>\n    <span class="token keyword">from</span> imp <span class="token keyword">import</span> <span class="token builtin">reload</span>\n    <span class="token builtin">reload</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 模块的包导入:使用点号(.)而不是路径(dir1\\dir2)进行导入</span>\n    <span class="token keyword">import</span> dir1<span class="token punctuation">.</span>dir2<span class="token punctuation">.</span>mod                <span class="token comment"># d导入包(目录)dir1中的包dir2中的mod模块 此时dir1必须在Python可搜索路径中</span>\n    <span class="token keyword">from</span> dir1<span class="token punctuation">.</span>dir2<span class="token punctuation">.</span>mod <span class="token keyword">import</span> <span class="token operator">*</span>         <span class="token comment"># from语法的包导入</span>\n\n<span class="token comment">#-- __init__.py包文件:每个导入的包中都应该包含这么一个文件</span>\n    <span class="token triple-quoted-string string">"""\n    该文件可以为空\n    首次进行包导入时 该文件会自动执行\n    高级功能:在该文件中使用__all__列表来定义包(目录)以from*的形式导入时 需要导入什么\n    """</span>\n\n<span class="token comment">#-- 包相对导入:使用点号(.) 只能使用from语句</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> spam                  <span class="token comment"># 导入当前目录下的spam模块（Python2: 当前目录下的模块, 直接导入即可）</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span>spam <span class="token keyword">import</span> name              <span class="token comment"># 导入当前目录下的spam模块的name属性（Python2: 当前目录下的模块, 直接导入即可，不用加.）</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> spam                 <span class="token comment"># 导入当前目录的父目录下的spam模块</span>\n\n<span class="token comment">#-- 包相对导入与普通导入的区别</span>\n    <span class="token keyword">from</span> string <span class="token keyword">import</span> <span class="token operator">*</span>                <span class="token comment"># 这里导入的string模块为sys.path路径上的 而不是本目录下的string模块(如果存在也不是)</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span>string <span class="token keyword">import</span> <span class="token operator">*</span>               <span class="token comment"># 这里导入的string模块为本目录下的(不存在则导入失败) 而不是sys.path路径上的</span>\n\n<span class="token comment">#-- 模块数据隐藏:最小化from*的破坏</span>\n    _X                                  <span class="token comment"># 变量名前加下划线可以防止from*导入时该变量名被复制出去</span>\n    __all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'x1\'</span><span class="token punctuation">,</span> <span class="token string">\'x2\'</span><span class="token punctuation">]</span>         <span class="token comment"># 使用__all__列表指定from*时复制出去的变量名(变量名在列表中为字符串形式)</span>\n\n<span class="token comment">#-- 可以使用__name__进行模块的单元测试:当模块为顶层执行文件时值为\'__main__\' 当模块被导入时为模块名</span>\n    <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n        doSomething\n    <span class="token comment"># 模块属性中还有其他属性，例如：</span>\n    __doc__                             <span class="token comment"># 模块的说明文档</span>\n    __file__                            <span class="token comment"># 模块文件的文件名，包括全路径</span>\n    __name__                            <span class="token comment"># 主文件或者被导入文件</span>\n    __package__                         <span class="token comment"># 模块所在的包</span>\n\n<span class="token comment">#-- import语句from语句的as扩展</span>\n    <span class="token keyword">import</span> modulename <span class="token keyword">as</span> name\n    <span class="token keyword">from</span> modulename <span class="token keyword">import</span> attrname <span class="token keyword">as</span> name\n\n<span class="token comment">#-- 得到模块属性的几种方法 假设为了得到name属性的值</span>\n    M<span class="token punctuation">.</span>name\n    M<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span>\n    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">\'M\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">)</span>\n\n\n<span class="token triple-quoted-string string">"""类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象"""</span>\n\n<span class="token comment">#-- 最普通的类</span>\n    <span class="token keyword">class</span> <span class="token class-name">C1</span><span class="token punctuation">(</span>C2<span class="token punctuation">,</span> C3<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        spam <span class="token operator">=</span> <span class="token number">42</span>                       <span class="token comment"># 数据属性</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token comment"># 函数属性:构造函数</span>\n            self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token comment"># 函数属性:析构函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"goodbey "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n    I1 <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python的类没有基于参数的函数重载</span>\n    <span class="token keyword">class</span> <span class="token class-name">FirstClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>                 <span class="token comment"># 此时类中只有一个test函数 即后者test(self) 它覆盖掉前者带参数的test函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 子类扩展超类: 尽量调用超类的方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Manager</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">giveRaise</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> percent<span class="token punctuation">,</span> bonus <span class="token operator">=</span> <span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>pay <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pay<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> percent <span class="token operator">+</span> bonus<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 不好的方式 复制粘贴超类代码</span>\n            Person<span class="token punctuation">.</span>giveRaise<span class="token punctuation">(</span>self<span class="token punctuation">,</span> percent <span class="token operator">+</span> bonus<span class="token punctuation">)</span>            <span class="token comment"># 好的方式 尽量调用超类方法</span>\n\n<span class="token comment">#-- 类内省工具</span>\n    bob <span class="token operator">=</span> Person<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span>\n    bob<span class="token punctuation">.</span>__class__                       <span class="token comment"># &lt;class \'Person\'></span>\n    bob<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__              <span class="token comment"># \'Person\'</span>\n    bob<span class="token punctuation">.</span>__dict__                        <span class="token comment"># {\'pay\':0, \'name\':\'bob\', \'job\':\'Manager\'}</span>\n\n<span class="token comment">#-- 返回1中 数据属性spam是属于类 而不是对象</span>\n    I1 <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> I2 <span class="token operator">=</span> C2<span class="token punctuation">(</span><span class="token string">\'tom\'</span><span class="token punctuation">)</span>      <span class="token comment"># 此时I1和I2的spam都为42 但是都是返回的C1的spam属性</span>\n    C1<span class="token punctuation">.</span>spam <span class="token operator">=</span> <span class="token number">24</span>                        <span class="token comment"># 此时I1和I2的spam都为24</span>\n    I1<span class="token punctuation">.</span>spam <span class="token operator">=</span> <span class="token number">3</span>                         <span class="token comment"># 此时I1新增自有属性spam 值为3 I2和C1的spam还都为24</span>\n\n<span class="token comment">#-- 类方法调用的两种方式</span>\n    instance<span class="token punctuation">.</span>method<span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span><span class="token punctuation">.</span>method<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arg<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 抽象超类的实现方法</span>\n    <span class="token comment"># (1)某个函数中调用未定义的函数 子类中定义该函数</span>\n        <span class="token keyword">def</span> <span class="token function">delegate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>action<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment"># 本类中不定义action函数 所以使用delegate函数时就会出错</span>\n    <span class="token comment"># (2)定义action函数 但是返回异常</span>\n        <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">"action must be defined"</span><span class="token punctuation">)</span>\n    <span class="token comment"># (3)上述的两种方法还都可以定义实例对象 实际上可以利用@装饰器语法生成不能定义的抽象超类</span>\n        <span class="token keyword">from</span> abc <span class="token keyword">import</span> ABCMeta<span class="token punctuation">,</span> abstractmethod\n        <span class="token keyword">class</span> <span class="token class-name">Super</span><span class="token punctuation">(</span>metaclass <span class="token operator">=</span> ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            @abstractmethod\n            <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>\n        x <span class="token operator">=</span> Super<span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token comment"># 返回 TypeError: Can\'t instantiate abstract class Super with abstract methods action</span>\n\n<span class="token comment">#-- # OOP和继承: "is-a"的关系</span>\n    <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n    a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> B<span class="token punctuation">)</span>                    <span class="token comment"># 返回True, A是B的子类 a也是B的一种</span>\n    <span class="token comment"># OOP和组合: "has-a"的关系</span>\n    <span class="token keyword">pass</span>\n    <span class="token comment"># OOP和委托: "包装"对象 在Python中委托通常是以"__getattr__"钩子方法实现的, 这个方法会拦截对不存在属性的读取</span>\n    <span class="token comment"># 包装类(或者称为代理类)可以使用__getattr__把任意读取转发给被包装的对象</span>\n    <span class="token keyword">class</span> <span class="token class-name">wrapper</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>wrapped <span class="token operator">=</span> <span class="token builtin">object</span>\n        <span class="token keyword">def</span> <span class="token function">__getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrname<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Trace: \'</span><span class="token punctuation">,</span> attrname<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wrapped<span class="token punctuation">,</span> attrname<span class="token punctuation">)</span>\n    <span class="token comment"># 注:这里使用getattr(X, N)内置函数以变量名字符串N从包装对象X中取出属性 类似于X.__dict__[N]</span>\n    x <span class="token operator">=</span> wrapper<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    x<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                         <span class="token comment"># 返回 "Trace: append" [1, 2, 3, 4]</span>\n    x <span class="token operator">=</span> wrapper<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回 "Trace: keys" [\'a\', \'b\']</span>\n\n<span class="token comment">#-- 类的伪私有属性:使用__attr</span>\n    <span class="token keyword">class</span> <span class="token class-name">C1</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__name <span class="token operator">=</span> name          <span class="token comment"># 此时类的__name属性为伪私有属性 原理 它会自动变成self._C1__name = name</span>\n        <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'self.name = %s\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__name\n    I <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'tom\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span>                            <span class="token comment"># 返回 self.name = tom</span>\n    I<span class="token punctuation">.</span>__name <span class="token operator">=</span> <span class="token string">\'jeey\'</span>                   <span class="token comment"># 这里无法访问 __name为伪私有属性</span>\n    I<span class="token punctuation">.</span>_C1__name <span class="token operator">=</span> <span class="token string">\'jeey\'</span>                <span class="token comment"># 这里可以修改成功 self.name = jeey</span>\n\n<span class="token comment">#-- 类方法是对象:无绑定类方法对象 / 绑定实例方法对象</span>\n    <span class="token keyword">class</span> <span class="token class-name">Spam</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">doit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">selfless</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    obj <span class="token operator">=</span> Spam<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> obj<span class="token punctuation">.</span>doit                        <span class="token comment"># 类的绑定方法对象 实例 + 函数</span>\n    x<span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> Spam<span class="token punctuation">.</span>doit                       <span class="token comment"># 类的无绑定方法对象 类名 + 函数</span>\n    x<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> Spam<span class="token punctuation">.</span>selfless                   <span class="token comment"># 类的无绑定方法函数 在3.0之前无效</span>\n    x<span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 获取对象信息: 属性和方法</span>\n    a <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                              <span class="token comment"># 使用dir函数</span>\n    <span class="token builtin">hasattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span>                     <span class="token comment"># 测试是否有x属性或方法 即a.x是否已经存在</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>                 <span class="token comment"># 设置属性或方法 等同于a.y = 19</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                  <span class="token comment"># 获取属性或方法 如果属性不存在 则返回默认值0</span>\n    <span class="token comment">#这里有个小技巧，setattr可以设置一个不能访问到的属性，即只能用getattr获取</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"can\'t touch"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>      <span class="token comment"># 这里的属性名带有空格，不能直接访问</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"can\'t touch"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment"># 但是可以用getattr获取</span>\n\n<span class="token comment">#-- 为类动态绑定属性或方法: MethodType方法</span>\n    <span class="token comment"># 一般创建了一个class的实例后, 可以给该实例绑定任何属性和方法, 这就是动态语言的灵活性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>                  <span class="token comment"># 动态给实例绑定一个属性</span>\n    <span class="token keyword">def</span> <span class="token function">set_age</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 定义一个函数作为实例方法</span>\n        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n    <span class="token keyword">from</span> types <span class="token keyword">import</span> MethodType\n    s<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> s<span class="token punctuation">)</span>  <span class="token comment"># 给实例绑定一个方法 类的其他实例不受此影响</span>\n    s<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>                       <span class="token comment"># 调用实例方法</span>\n    Student<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> Student<span class="token punctuation">)</span>    <span class="token comment"># 为类绑定一个方法 类的所有实例都拥有该方法</span>\n\n\n<span class="token triple-quoted-string string">"""类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题"""</span>\n\n<span class="token comment">#-- 多重继承: "混合类", 搜索方式"从下到上 从左到右 广度优先"</span>\n    <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n<span class="token comment">#-- 类的继承和子类的初始化</span>\n    <span class="token comment"># 1.子类定义了__init__方法时，若未显示调用基类__init__方法，python不会帮你调用。</span>\n    <span class="token comment"># 2.子类未定义__init__方法时，python会自动帮你调用首个基类的__init__方法，注意是首个。</span>\n    <span class="token comment"># 3.子类显示调用基类的初始化函数：</span>\n    <span class="token keyword">class</span> <span class="token class-name">FooParent</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token string">\'I\\\'m the Parent.\'</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent:a=\'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">\' from Parent\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span> <span class="token class-name">FooChild</span><span class="token punctuation">(</span>FooParent<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            FooParent<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child:a=\'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            FooParent<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">\' from Child\'</span><span class="token punctuation">)</span>\n    fooChild <span class="token operator">=</span> FooChild<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n    fooChild<span class="token punctuation">.</span>bar<span class="token punctuation">(</span><span class="token string">\'HelloWorld\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- #实例方法 / 静态方法 / 类方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Methods</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">imeth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span>      <span class="token comment"># 实例方法：传入的是实例和数据，操作的是实例的属性</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                  <span class="token comment"># 静态方法：只传入数据 不传入实例，操作的是类的属性而不是实例的属性</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span>        <span class="token comment"># 类方法：传入的是类对象和数据</span>\n        smeth <span class="token operator">=</span> <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>smeth<span class="token punctuation">)</span>             <span class="token comment"># 调用内置函数，也可以使用@staticmethod</span>\n        cmeth <span class="token operator">=</span> <span class="token builtin">classmethod</span><span class="token punctuation">(</span>cmeth<span class="token punctuation">)</span>              <span class="token comment"># 调用内置函数，也可以使用@classmethod</span>\n    obj <span class="token operator">=</span> Methods<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    obj<span class="token punctuation">.</span>imeth<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                                <span class="token comment"># 实例方法调用 &lt;__main__.Methods object...> 1</span>\n    Methods<span class="token punctuation">.</span>imeth<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># &lt;__main__.Methods object...> 2</span>\n    Methods<span class="token punctuation">.</span>smeth<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                            <span class="token comment"># 静态方法调用 3</span>\n    obj<span class="token punctuation">.</span>smeth<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                                <span class="token comment"># 这里可以使用实例进行调用</span>\n    Methods<span class="token punctuation">.</span>cmeth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                            <span class="token comment"># 类方法调用 &lt;class \'__main__.Methods\'> 5</span>\n    obj<span class="token punctuation">.</span>cmeth<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                                <span class="token comment"># &lt;class \'__main__.Methods\'> 6</span>\n\n<span class="token comment">#-- 函数装饰器:是它后边的函数的运行时的声明 由@符号以及后边紧跟的"元函数"(metafunction)组成</span>\n        <span class="token decorator annotation punctuation">@staticmethod</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于:</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n        smeth <span class="token operator">=</span> <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>smeth<span class="token punctuation">)</span>\n    <span class="token comment"># 同理</span>\n        <span class="token decorator annotation punctuation">@classmethod</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n        cmeth <span class="token operator">=</span> <span class="token builtin">classmethod</span><span class="token punctuation">(</span>cmeth<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 类修饰器:是它后边的类的运行时的声明 由@符号以及后边紧跟的"元函数"(metafunction)组成</span>\n        <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>aClass<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        @decorator\n        <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    <span class="token comment"># 等同于:</span>\n        <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        C <span class="token operator">=</span> decorator<span class="token punctuation">(</span>C<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 限制class属性: __slots__属性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">)</span>             <span class="token comment"># 限制Student及其实例只能拥有name和age属性</span>\n    <span class="token comment"># __slots__属性只对当前类起作用, 对其子类不起作用</span>\n    <span class="token comment"># __slots__属性能够节省内存</span>\n    <span class="token comment"># __slots__属性可以为列表list，或者元组tuple</span>\n\n<span class="token comment">#-- 类属性高级话题: @property</span>\n    <span class="token comment"># 假设定义了一个类:C，该类必须继承自object类，有一私有变量_x</span>\n    <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__x <span class="token operator">=</span> <span class="token boolean">None</span>\n    <span class="token comment"># 第一种使用属性的方法</span>\n        <span class="token keyword">def</span> <span class="token function">getx</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__x\n        <span class="token keyword">def</span> <span class="token function">setx</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__x <span class="token operator">=</span> value\n        <span class="token keyword">def</span> <span class="token function">delx</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">del</span> self<span class="token punctuation">.</span>__x\n        x <span class="token operator">=</span> <span class="token builtin">property</span><span class="token punctuation">(</span>getx<span class="token punctuation">,</span> setx<span class="token punctuation">,</span> delx<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># property函数原型为property(fget=None,fset=None,fdel=None,doc=None)</span>\n    <span class="token comment"># 使用</span>\n    c <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">100</span>                         <span class="token comment"># 自动调用setx方法</span>\n    y <span class="token operator">=</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用getx方法</span>\n    <span class="token keyword">del</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用delx方法</span>\n    <span class="token comment"># 第二种方法使用属性的方法</span>\n        <span class="token decorator annotation punctuation">@property</span>\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__x\n        @x<span class="token punctuation">.</span>setter\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           self<span class="token punctuation">.</span>__x <span class="token operator">=</span> value\n        @x<span class="token punctuation">.</span>deleter\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           <span class="token keyword">del</span> self<span class="token punctuation">.</span>__x\n    <span class="token comment"># 使用</span>\n    c <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">100</span>                         <span class="token comment"># 自动调用setter方法</span>\n    y <span class="token operator">=</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用x方法</span>\n    <span class="token keyword">del</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用deleter方法</span>\n\n<span class="token comment">#-- 定制类: 重写类的方法</span>\n    <span class="token comment"># (1)__str__方法、__repr__方法: 定制类的输出字符串</span>\n    <span class="token comment"># (2)__iter__方法、next方法: 定制类的可迭代性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token comment"># 初始化两个计数器a，b</span>\n        <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self               <span class="token comment"># 实例本身就是迭代对象，故返回自己</span>\n        <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a <span class="token operator">+</span> self<span class="token punctuation">.</span>b\n            <span class="token keyword">if</span> self<span class="token punctuation">.</span>a <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">:</span>       <span class="token comment"># 退出循环的条件</span>\n                <span class="token keyword">raise</span> StopIteration<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>a             <span class="token comment"># 返回下一个值</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>                      <span class="token comment"># 使用</span>\n    <span class="token comment"># (3)__getitem__方法、__setitem__方法: 定制类的下标操作[] 或者切片操作slice</span>\n    <span class="token keyword">class</span> <span class="token class-name">Indexer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 定义getitem方法</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'getitem:\'</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>n<span class="token punctuation">]</span>\n        <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 定义setitem方法</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'setitem:key = {0}, value = {1}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n    test <span class="token operator">=</span> Indexer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   test<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'3\'</span>              <span class="token comment"># 调用setitem方法</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                            <span class="token comment"># 调用getitem方法</span>\n    <span class="token comment"># (4)__getattr__方法: 定制类的属性操作</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token comment"># 定义当获取类的属性时的返回值</span>\n            <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n                <span class="token keyword">return</span> <span class="token number">25</span>                     <span class="token comment"># 当获取age属性时返回25</span>\n        <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">\'object has no attribute: %s\'</span> <span class="token operator">%</span> attr<span class="token punctuation">)</span>\n        <span class="token comment"># 注意: 只有当属性不存在时 才会调用该方法 且该方法默认返回None 需要在函数最后引发异常</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">.</span>age                                     <span class="token comment"># s中age属性不存在 故调用__getattr__方法 返回25</span>\n    <span class="token comment"># (5)__call__方法: 定制类的\'可调用\'性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>                   <span class="token comment"># 也可以带参数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Calling......\'</span><span class="token punctuation">)</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># s变成了可调用的 也可以带参数</span>\n    <span class="token builtin">callable</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>                               <span class="token comment"># 测试s的可调用性 返回True</span>\n    <span class="token comment">#    (6)__len__方法：求类的长度</span>\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 动态创建类type()</span>\n    <span class="token comment"># 一般创建类 需要在代码中提前定义</span>\n        <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># Hello, world</span>\n        <span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span>                           <span class="token comment"># Hello是一个type类型 返回&lt;class \'type\'></span>\n        <span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>                               <span class="token comment"># h是一个Hello类型 返回&lt;class \'Hello\'></span>\n    <span class="token comment"># 动态类型语言中 类可以动态创建 type函数可用于创建新类型</span>\n        <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>           <span class="token comment"># 先定义函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        Hello <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>hello<span class="token operator">=</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 创建Hello类 type原型: type(name, bases, dict)</span>\n        h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 此时的h和上边的h一致</span>\n\n\n<span class="token triple-quoted-string string">"""异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关"""</span>\n\n<span class="token comment">#-- #捕获异常:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">except</span><span class="token punctuation">:</span>                               <span class="token comment"># 捕获所有的异常 等同于except Exception:</span>\n        <span class="token keyword">except</span> name<span class="token punctuation">:</span>                          <span class="token comment"># 捕获指定的异常</span>\n        <span class="token keyword">except</span> name<span class="token punctuation">,</span> value<span class="token punctuation">:</span>                   <span class="token comment"># 捕获指定的异常和额外的数据(实例)</span>\n        <span class="token keyword">except</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">except</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span>\n        <span class="token keyword">except</span> name4 <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>                                 <span class="token comment"># 如果没有发生异常</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>                              <span class="token comment"># 总会执行的部分</span>\n    <span class="token comment"># 引发异常: raise子句(raise IndexError)</span>\n        <span class="token keyword">raise</span> <span class="token operator">&lt;</span>instance<span class="token operator">></span>                      <span class="token comment"># raise instance of a class, raise IndexError()</span>\n        <span class="token keyword">raise</span> <span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token operator">></span>                         <span class="token comment"># make and raise instance of a class, raise IndexError</span>\n        <span class="token keyword">raise</span>                                 <span class="token comment"># reraise the most recent exception</span>\n\n<span class="token comment">#-- Python3.x中的异常链: raise exception from otherException</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string">\'Bad\'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> X\n\n<span class="token comment">#-- assert子句: assert &lt;test>, &lt;data></span>\n    <span class="token keyword">assert</span> x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'x must be negative\'</span>\n\n<span class="token comment">#-- with/as环境管理器:作为常见的try/finally用法模式的替代方案</span>\n    <span class="token keyword">with</span> expression <span class="token punctuation">[</span><span class="token keyword">as</span> variable<span class="token punctuation">]</span><span class="token punctuation">,</span> expression <span class="token punctuation">[</span><span class="token keyword">as</span> variable<span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token comment"># 例子:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> myfile<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> myfile<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于:</span>\n        myfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> myfile<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            myfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 用户自定义异常: class Bad(Exception):.....</span>\n    <span class="token triple-quoted-string string">"""\n    Exception超类 / except基类即可捕获到其所有子类\n    Exception超类有默认的打印消息和状态 当然也可以定制打印显示:\n    """</span>\n    <span class="token keyword">class</span> <span class="token class-name">MyBad</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'定制的打印消息\'</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        MyBad<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> MyBad <span class="token keyword">as</span> x<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 用户定制异常数据</span>\n    <span class="token keyword">class</span> <span class="token class-name">FormatError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line <span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>line <span class="token operator">=</span> line\n            self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">file</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FormatError<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> FormatError <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Error at \'</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>line<span class="token punctuation">)</span>\n    <span class="token comment"># 用户定制异常行为(方法):以记录日志为例</span>\n    <span class="token keyword">class</span> <span class="token class-name">FormatError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        logfile <span class="token operator">=</span> <span class="token string">\'formaterror.txt\'</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line <span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>line <span class="token operator">=</span> line\n            self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">file</span>\n        <span class="token keyword">def</span> <span class="token function">logger</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>logfile<span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Error at \'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>line<span class="token punctuation">)</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FormatError<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> FormatError <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        X<span class="token punctuation">.</span>logger<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 关于sys.exc_info:允许一个异常处理器获取对最近引发的异常的访问</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    <span class="token keyword">except</span><span class="token punctuation">:</span>\n        <span class="token comment"># 此时sys.exc_info()返回一个元组(type, value, traceback)</span>\n        <span class="token comment"># type:正在处理的异常的异常类型</span>\n        <span class="token comment"># value:引发的异常的实例</span>\n        <span class="token comment"># traceback:堆栈信息</span>\n\n<span class="token comment">#-- 异常层次</span>\n    BaseException\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SystemExit\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> KeyboardInterrupt\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> GeneratorExit\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> Exception\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> StopIteration\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ArithmeticError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> AssertionError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> AttributeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> BufferError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> EOFError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ImportError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> LookupError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> MemoryError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> NameError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> OSError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ReferenceError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> RuntimeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SyntaxError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SystemError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> TypeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ValueError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> Warning\n\n\n<span class="token triple-quoted-string string">"""Unicode和字节字符串---Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串"""</span>\n\n<span class="token comment">#-- Python的字符串类型</span>\n    <span class="token triple-quoted-string string">"""Python2.x"""</span>\n    <span class="token comment"># 1.str表示8位文本和二进制数据</span>\n    <span class="token comment"># 2.unicode表示宽字符Unicode文本</span>\n    <span class="token triple-quoted-string string">"""Python3.x"""</span>\n    <span class="token comment"># 1.str表示Unicode文本（8位或者更宽）</span>\n    <span class="token comment"># 2.bytes表示不可变的二进制数据</span>\n    <span class="token comment"># 3.bytearray是一种可变的bytes类型</span>\n\n<span class="token comment">#-- 字符编码方法</span>\n    <span class="token triple-quoted-string string">"""ASCII"""</span>                   <span class="token comment"># 一个字节，只包含英文字符，0到127，共128个字符，利用函数可以进行字符和数字的相互转换</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>                      <span class="token comment"># 字符a的ASCII码为97，所以这里返回97</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span>                       <span class="token comment"># 和上边的过程相反，返回字符\'a\'</span>\n    <span class="token triple-quoted-string string">"""Latin-1"""</span>                 <span class="token comment"># 一个字节，包含特殊字符，0到255，共256个字符，相当于对ASCII码的扩展</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回一个特殊字符：Ä</span>\n    <span class="token triple-quoted-string string">"""Unicode"""</span>                 <span class="token comment"># 宽字符，一个字符包含多个字节，一般用于亚洲的字符集，比如中文有好几万字</span>\n    <span class="token triple-quoted-string string">"""UTF-8"""</span>                   <span class="token comment"># 可变字节数，小于128的字符表示为单个字节，128到0X7FF之间的代码转换为两个字节，0X7FF以上的代码转换为3或4个字节</span>\n    <span class="token comment"># 注意：可以看出来，ASCII码是Latin-1和UTF-8的一个子集</span>\n    <span class="token comment"># 注意：utf-8是unicode的一种实现方式，unicode、gbk、gb2312是编码字符集</span>\n\n<span class="token comment">#-- 查看Python中的字符串编码名称，查看系统的编码</span>\n    <span class="token keyword">import</span> encodings\n    <span class="token builtin">help</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span>\n    <span class="token keyword">import</span> sys\n    sys<span class="token punctuation">.</span>platform                  <span class="token comment"># \'win64\'</span>\n    sys<span class="token punctuation">.</span>getdefaultencoding<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># \'utf-8\'</span>\n    sys<span class="token punctuation">.</span>getdefaultencoding<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># 返回当前系统平台的编码类型</span>\n    sys<span class="token punctuation">.</span>getsizeof<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>         <span class="token comment"># 返回object占有的bytes的大小</span>\n\n<span class="token comment">#-- 源文件字符集编码声明: 添加注释来指定想要的编码形式 从而改变默认值 注释必须出现在脚本的第一行或者第二行</span>\n    <span class="token triple-quoted-string string">"""说明：其实这里只会检查#和coding:utf-8，其余的字符都是为了美观加上的"""</span>\n    <span class="token comment"># _*_ coding: utf-8 _*_</span>\n    <span class="token comment"># coding = utf-8</span>\n\n<span class="token comment">#-- #编码: 字符串 --> 原始字节       #解码: 原始字节 --> 字符串</span>\n\n<span class="token comment">#-- Python3.x中的字符串应用</span>\n    s <span class="token operator">=</span> <span class="token string">\'...\'</span>                     <span class="token comment"># 构建一个str对象，不可变对象</span>\n    b <span class="token operator">=</span> <span class="token string">b\'...\'</span>                    <span class="token comment"># 构建一个bytes对象，不可变对象</span>\n    s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                    <span class="token comment"># 返回(\'.\', 113)</span>\n    s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                  <span class="token comment"># 返回(\'..\', b\'..\')</span>\n    B <span class="token operator">=</span> <span class="token triple-quoted-string string">B"""\n        xxxx\n        yyyy\n        """</span>\n    <span class="token comment"># B = b\'\\nxxxx\\nyyyy\\n\'</span>\n    <span class="token comment"># 编码，将str字符串转化为其raw bytes形式：</span>\n        <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors <span class="token operator">=</span> <span class="token string">\'strict\'</span><span class="token punctuation">)</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> encoding<span class="token punctuation">)</span>\n    <span class="token comment"># 编码例子：</span>\n        S <span class="token operator">=</span> <span class="token string">\'egg\'</span>\n        S<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment"># b\'egg\'</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span>  <span class="token comment"># b\'egg\'</span>\n    <span class="token comment"># 解码，将raw bytes字符串转化为str形式：</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors <span class="token operator">=</span> <span class="token string">\'strict\'</span><span class="token punctuation">)</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>bytes_or_buffer<span class="token punctuation">[</span><span class="token punctuation">,</span> encoding<span class="token punctuation">[</span><span class="token punctuation">,</span> errors<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token comment"># 解码例子：</span>\n        B <span class="token operator">=</span> <span class="token string">b\'spam\'</span>\n        B<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment"># \'spam\'</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span>                    <span class="token comment"># "b\'spam\'"，不带编码的str调用，结果为打印该bytes对象</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span><span class="token comment"># \'spam\'，带编码的str调用，结果为转化该bytes对象</span>\n\n<span class="token comment">#-- Python2.x的编码问题</span>\n    u <span class="token operator">=</span> <span class="token string">u\'汉\'</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>                 <span class="token comment"># u\'\\xba\\xba\'</span>\n    s <span class="token operator">=</span> u<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>                 <span class="token comment"># \'\\xc2\\xba\\xc2\\xba\'</span>\n    u2 <span class="token operator">=</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span>                <span class="token comment"># u\'\\xba\\xba\'</span>\n    <span class="token comment"># 对unicode进行解码是错误的</span>\n    s2 <span class="token operator">=</span> u<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>        <span class="token comment"># UnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)</span>\n    <span class="token comment"># 同样，对str进行编码也是错误的</span>\n    u2 <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>        <span class="token comment"># UnicodeDecodeError: \'ascii\' codec can\'t decode byte 0xc2 in position 0: ordinal not in range(128)</span>\n\n<span class="token comment">#-- bytes对象</span>\n    B <span class="token operator">=</span> <span class="token string">b\'abc\'</span>\n    B <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n    B <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    B <span class="token operator">=</span> <span class="token string">\'abc\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># bytes对象的方法调用基本和str类型一致 但:B[0]返回的是ASCII码值97, 而不是b\'a\'</span>\n\n<span class="token comment">#-- #文本文件: 根据Unicode编码来解释文件内容，要么是平台的默认编码，要么是指定的编码类型</span>\n    <span class="token comment"># 二进制文件：表示字节值的整数的一个序列 open(\'bin.txt\', \'rb\')</span>\n\n<span class="token comment">#-- Unicode文件</span>\n    s <span class="token operator">=</span> <span class="token string">\'A\\xc4B\\xe8C\'</span>             <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n    <span class="token comment">#手动编码</span>\n        l <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>   <span class="token comment"># l = b\'A\\xc4B\\xe8C\'  len(l) = 5</span>\n        u <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>     <span class="token comment"># u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7</span>\n    <span class="token comment">#文件输出编码</span>\n        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n        l <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># l = b\'A\\xc4B\\xe8C\'  len(l) = 5</span>\n        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'uft8data\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n        u <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'uft8data\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment"># u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7</span>\n    <span class="token comment">#文件输入编码</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>      <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'utf8data\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'utf8data\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>         <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n\n\n<span class="token triple-quoted-string string">"""其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他"""</span>\n\n<span class="token comment">#-- Python实现任意深度的赋值 例如a[0] = \'value1\'; a[1][2] = \'value2\'; a[3][4][5] = \'value3\'</span>\n    <span class="token keyword">class</span> <span class="token class-name">MyDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>                 <span class="token comment"># 该函数不做任何改动 这里只是为了输出</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'setitem:\'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> self<span class="token punctuation">)</span>\n            <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>                       <span class="token comment"># 主要技巧在该函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'getitem:\'</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> self<span class="token punctuation">)</span>                  <span class="token comment"># 输出信息</span>\n            <span class="token comment"># 基本思路: a[1][2]赋值时 需要先取出a[1] 然后给a[1]的[2]赋值</span>\n            <span class="token keyword">if</span> item <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">:</span>                           <span class="token comment"># 如果a[1]不存在 则需要新建一个dict 并使得a[1] = dict</span>\n                temp <span class="token operator">=</span> MyDict<span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment"># 新建的dict: temp</span>\n                <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span>item<span class="token punctuation">,</span> temp<span class="token punctuation">)</span>            <span class="token comment"># 赋值a[1] = temp</span>\n                <span class="token keyword">return</span> temp                                <span class="token comment"># 返回temp 使得temp[2] = value有效</span>\n            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span>item<span class="token punctuation">)</span>               <span class="token comment"># 如果a[1]存在 则直接返回a[1]</span>\n    <span class="token comment"># 例子:</span>\n        test <span class="token operator">=</span> MyDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test1\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test2\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python中的多维数组</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span>                                        <span class="token comment"># 扩展list，结果为[0, 0, 0]</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span>                                       <span class="token comment"># 多维数组，结果为[[], [], []]，但有问题，往下看</span>\n    lists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                     <span class="token comment"># 期望看到的结果[[3], [], []]，实际结果[[3], [3], [3]]，原因：list*n操作，是浅拷贝，如何避免？往下看</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>                         <span class="token comment"># 多维数组，结果为[[], [], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [6], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [6], [9]]</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>     <span class="token comment"># 3行4列，且每一个元素为[]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="版本二"><a href="#%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本二</h1>\n<h2 id="工具"><a href="#%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具</h2>\n<h3 id="虚拟环境"><a href="#%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>虚拟环境</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35579739816739877000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 安装\n\\$ pip install virtualenv\n\n# 创建环境\n\\$ virtualenv myproject\n\\$ source myproject/bin/activate\n\n# virtualenv 使用系统全局模块\n\\$ virtualenv --system-site-packages mycoolproject\n\n# 退出这个 virtualenv\n\\$ deactivate`, `35579739816739877000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 安装</span>\n$ pip <span class="token function">install</span> virtualenv\n\n<span class="token comment"># 创建环境</span>\n$ virtualenv myproject\n$ <span class="token builtin class-name">source</span> myproject/bin/activate\n\n<span class="token comment"># virtualenv 使用系统全局模块</span>\n$ virtualenv --system-site-packages mycoolproject\n\n<span class="token comment"># 退出这个 virtualenv</span>\n$ deactivate</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="对象自省"><a href="#%E5%AF%B9%E8%B1%A1%E8%87%AA%E7%9C%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象自省</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35617555322624848000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_list = [1, 2, 3]\n# 列出一个对象所拥有的属性和方法\ndir(my_list)\n# 返回当前作用域的所有名字\ndir()\n\n# type 函数返回一个对象的类型\nprint(type(\'\')) # Output: <type \'str\'>\n\n# 函数返回任意不同种类对象的唯一 ID\nname = &quot;Yasoob&quot;\nprint(id(name)) # Output: 139972439030304\n\n# 查看一个对象的成员\nimport inspect\nprint(inspect.getmembers(str)) # Output: [(\'__add__\', <slot wrapper \'__add__\' of ... ...`, `35617555322624848000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token comment"># 列出一个对象所拥有的属性和方法</span>\n<span class="token builtin">dir</span><span class="token punctuation">(</span>my_list<span class="token punctuation">)</span>\n<span class="token comment"># 返回当前作用域的所有名字</span>\n<span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># type 函数返回一个对象的类型</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: &lt;type \'str\'></span>\n\n<span class="token comment"># 函数返回任意不同种类对象的唯一 ID</span>\nname <span class="token operator">=</span> <span class="token string">"Yasoob"</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: 139972439030304</span>\n\n<span class="token comment"># 查看一个对象的成员</span>\n<span class="token keyword">import</span> inspect\n<span class="token keyword">print</span><span class="token punctuation">(</span>inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: [(\'__add__\', &lt;slot wrapper \'__add__\' of ... ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="语法"><a href="#%E8%AF%AD%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法</h2>\n<h3 id="异常"><a href="#%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异常</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3614898505935881700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 正常例子\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept IOError as e:\n    print(\'An IOError occurred. {}\'.format(e.args[-1]))\n\n# 处理多个异常，有 3 种方法\n## 方法 1：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept (IOError, EOFError) as e:\n    print(&quot;An error occurred. {}&quot;.format(e.args[-1]))\n##　方法 2：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept EOFError as e:\n    print(&quot;An EOF error occurred.&quot;)\n    raise e\nexcept IOError as e:\n    print(&quot;An error occurred.&quot;)\n    raise e\n## 方法 3：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept Exception:\n    # 打印一些异常日志，如果你想要的话\n    raise\n\n# finally 从句\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept IOError as e:\n    print(\'An IOError occurred. {}\'.format(e.args[-1]))\nfinally:\n    print(&quot;This would be printed whether or not an exception occurred!&quot;)\n# Output: An IOError occurred. No such file or directory\n# This would be printed whether or not an exception occurred!\n\n# try/else 从句\ntry:\n    print(\'I am sure no exception is going to occur!\')\nexcept Exception:\n    print(\'exception\')\nelse:\n    # 这里的代码只会在 try 语句里没有触发异常时运行,\n    # 但是这里的异常将 *不会* 被捕获\n    print(\'This would only run if no exception occurs. And an error here would NOT be caught.\')\nfinally:\n    print(\'This would be printed in every case.\')\n\n# Output: I am sure no exception is going to occur!\n# This would only run if no exception occurs. And an error here would NOT be caught.\n# This would be printed in every case.`, `3614898505935881700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 正常例子</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'An IOError occurred. {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 处理多个异常，有 3 种方法</span>\n<span class="token comment">## 方法 1：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> <span class="token punctuation">(</span>IOError<span class="token punctuation">,</span> EOFError<span class="token punctuation">)</span> <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An error occurred. {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment">##　方法 2：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> EOFError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An EOF error occurred."</span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span> e\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An error occurred."</span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span> e\n<span class="token comment">## 方法 3：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n    <span class="token comment"># 打印一些异常日志，如果你想要的话</span>\n    <span class="token keyword">raise</span>\n\n<span class="token comment"># finally 从句</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'An IOError occurred. {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"This would be printed whether or not an exception occurred!"</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: An IOError occurred. No such file or directory</span>\n<span class="token comment"># This would be printed whether or not an exception occurred!</span>\n\n<span class="token comment"># try/else 从句</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I am sure no exception is going to occur!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exception\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token comment"># 这里的代码只会在 try 语句里没有触发异常时运行,</span>\n    <span class="token comment"># 但是这里的异常将 *不会* 被捕获</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'This would only run if no exception occurs. And an error here would NOT be caught.\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'This would be printed in every case.\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Output: I am sure no exception is going to occur!</span>\n<span class="token comment"># This would only run if no exception occurs. And an error here would NOT be caught.</span>\n<span class="token comment"># This would be printed in every case.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="for---else"><a href="#for---else" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>For - Else</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44088599096758150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for n in range(2, 10):\n    for x in range(2, n):\n        if n % x == 0:\n            print(n, \'equals\', x, \'*\', n / x)\n            break\n    else: # 这个 else 从句会在循环正常结束时执行即循环没有遇到任何 break\n        # loop fell through without finding a factor\n        print(n, \'is a prime number\')`, `44088599096758150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> n <span class="token operator">%</span> x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">\'equals\'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">,</span> n <span class="token operator">/</span> x<span class="token punctuation">)</span>\n            <span class="token keyword">break</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 这个 else 从句会在循环正常结束时执行即循环没有遇到任何 break</span>\n        <span class="token comment"># loop fell through without finding a factor</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">\'is a prime number\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="三元运算符"><a href="#%E4%B8%89%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三元运算符</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1364557645661146400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 正常例子\nis_fat = True\nstate = &quot;fat&quot; if is_fat else &quot;not fat&quot;\n\n# 另一种用法，较少使用，会把 2 个条件都执行\nfat = True\nfitness = (&quot;skinny&quot;, &quot;fat&quot;)[fat]\nprint(&quot;Ali is&quot;, fitness)\n# 输出: Ali is fat`, `1364557645661146400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 正常例子</span>\nis_fat <span class="token operator">=</span> <span class="token boolean">True</span>\nstate <span class="token operator">=</span> <span class="token string">"fat"</span> <span class="token keyword">if</span> is_fat <span class="token keyword">else</span> <span class="token string">"not fat"</span>\n\n<span class="token comment"># 另一种用法，较少使用，会把 2 个条件都执行</span>\nfat <span class="token operator">=</span> <span class="token boolean">True</span>\nfitness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"skinny"</span><span class="token punctuation">,</span> <span class="token string">"fat"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>fat<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ali is"</span><span class="token punctuation">,</span> fitness<span class="token punctuation">)</span>\n<span class="token comment"># 输出: Ali is fat</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="global"><a href="#global" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Global</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20265285367295705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 首先，是没有使用 global 变量\ndef add(value1, value2):\n    result = value1 + value2\n\nadd(2, 4)\nprint(result)\n\n# Oh 糟了，我们遇到异常了。为什么会这样？\n# python 解释器报错说没有一个叫 result 的变量。\n# 这是因为 result 变量只能在创建它的函数内部才允许访问，除非它是全局的(global)。\nTraceback (most recent call last):\n  File &quot;&quot;, line 1, in\n    result\nNameError: name \'result\' is not defined\n\n# 现在我们运行相同的代码，不过是在将 result 变量设为 global 之后\ndef add(value1, value2):\n    global result\n    result = value1 + value2\n\nadd(2, 4)\nprint(result)\n6`, `20265285367295705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 首先，是没有使用 global 变量</span>\n<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2\n\nadd<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token comment"># Oh 糟了，我们遇到异常了。为什么会这样？</span>\n<span class="token comment"># python 解释器报错说没有一个叫 result 的变量。</span>\n<span class="token comment"># 这是因为 result 变量只能在创建它的函数内部才允许访问，除非它是全局的(global)。</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">""</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span>\n    result\nNameError<span class="token punctuation">:</span> name <span class="token string">\'result\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined\n\n<span class="token comment"># 现在我们运行相同的代码，不过是在将 result 变量设为 global 之后</span>\n<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">global</span> result\n    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2\n\nadd<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="return"><a href="#return" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Return</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98683628002805220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 方法 1：\ndef profile():\n    name = &quot;Danny&quot;\n    age = 30\n    return (name, age)\n\nprofile_data = profile()\nprint(profile_data[0])\n# Output: Danny\n\nprint(profile_data[1])\n# Output: 30\n\n# 方法二：\ndef profile():\n    name = &quot;Danny&quot;\n    age = 30\n    return name, age`, `98683628002805220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 方法 1：</span>\n<span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">"Danny"</span>\n    age <span class="token operator">=</span> <span class="token number">30</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>\n\nprofile_data <span class="token operator">=</span> profile<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: Danny</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: 30</span>\n\n<span class="token comment"># 方法二：</span>\n<span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">"Danny"</span>\n    age <span class="token operator">=</span> <span class="token number">30</span>\n    <span class="token keyword">return</span> name<span class="token punctuation">,</span> age</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="open-函数"><a href="#open-%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>open 函数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4363128475061040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 以下代码有问题\nf = open(\'photo.jpg\', \'r+\')\njpgdata = f.read()\nf.close()\n\n# 异常产生不会调用到 f.close()，需要包裹成 with 语句\n# 读取文件，传入 r；\n# 读取并写入文件，传入 r+；\n# 覆盖写入文件，传入 w；\n# 在文件末尾附加内容，传入 a；\nwith open(\'photo.jpg\', \'r+\') as f:\n    jpgdata = f.read()\n\n# 检测文件格式\nimport io\n# 二进制模式打开\nwith open(\'photo.jpg\', \'rb\') as inf:\n    jpgdata = inf.read()\n# 检测文件格式\nif jpgdata.startswith(b\'\\xff\\xd8\'):\n    text = u\'This is a JPEG file (%d bytes long)\\n\'\nelse:\n    text = u\'This is a random file (%d bytes long)\\n\'\n# io.open 兼容 python2.x 和 python3.x\nwith io.open(\'summary.txt\', \'w\', encoding=\'utf-8\') as outf:\n    outf.write(text % len(jpgdata))`, `4363128475061040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 以下代码有问题</span>\nf <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'r+\'</span><span class="token punctuation">)</span>\njpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\nf<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 异常产生不会调用到 f.close()，需要包裹成 with 语句</span>\n<span class="token comment"># 读取文件，传入 r；</span>\n<span class="token comment"># 读取并写入文件，传入 r+；</span>\n<span class="token comment"># 覆盖写入文件，传入 w；</span>\n<span class="token comment"># 在文件末尾附加内容，传入 a；</span>\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'r+\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    jpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 检测文件格式</span>\n<span class="token keyword">import</span> io\n<span class="token comment"># 二进制模式打开</span>\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> inf<span class="token punctuation">:</span>\n    jpgdata <span class="token operator">=</span> inf<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 检测文件格式</span>\n<span class="token keyword">if</span> jpgdata<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b\'\\xff\\xd8\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    text <span class="token operator">=</span> <span class="token string">u\'This is a JPEG file (%d bytes long)\\n\'</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    text <span class="token operator">=</span> <span class="token string">u\'This is a random file (%d bytes long)\\n\'</span>\n<span class="token comment"># io.open 兼容 python2.x 和 python3.x</span>\n<span class="token keyword">with</span> io<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'summary.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> outf<span class="token punctuation">:</span>\n    outf<span class="token punctuation">.</span>write<span class="token punctuation">(</span>text <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>jpgdata<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="args-和-kwargs"><a href="#args-%E5%92%8C-kwargs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">*args</code> 和 <code class="language-text">**kwargs</code></h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97060848810432220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# *args\ndef test_var_args(f_arg, *argv):\n    print(&quot;first normal arg:&quot;, f_arg)\n    for arg in argv:\n        print(&quot;another arg through *argv:&quot;, arg)\n\ntest_var_args(\'yasoob\', \'python\', \'eggs\', \'test\')\n# Output:\n# first normal arg: yasoob\n# another arg through *argv: python\n# another arg through *argv: eggs\n# another arg through *argv: test\n\n## **kwargs\ndef greet_me(**kwargs):\n    for key, value in kwargs.items():\n        print(&quot;{0} == {1}&quot;.format(key, value))\ngreet_me(name=&quot;yasoob&quot;)\n# Output:\n# name == yasoob`, `97060848810432220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># *args</span>\n<span class="token keyword">def</span> <span class="token function">test_var_args</span><span class="token punctuation">(</span>f_arg<span class="token punctuation">,</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"first normal arg:"</span><span class="token punctuation">,</span> f_arg<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> arg <span class="token keyword">in</span> argv<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"another arg through *argv:"</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span>\n\ntest_var_args<span class="token punctuation">(</span><span class="token string">\'yasoob\'</span><span class="token punctuation">,</span> <span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'eggs\'</span><span class="token punctuation">,</span> <span class="token string">\'test\'</span><span class="token punctuation">)</span>\n<span class="token comment"># Output:</span>\n<span class="token comment"># first normal arg: yasoob</span>\n<span class="token comment"># another arg through *argv: python</span>\n<span class="token comment"># another arg through *argv: eggs</span>\n<span class="token comment"># another arg through *argv: test</span>\n\n<span class="token comment">## **kwargs</span>\n<span class="token keyword">def</span> <span class="token function">greet_me</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{0} == {1}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\ngreet_me<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"yasoob"</span><span class="token punctuation">)</span>\n<span class="token comment"># Output:</span>\n<span class="token comment"># name == yasoob</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="上下文管理器"><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上下文管理器</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12815307814832112000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'some_file\', \'w\') as opened_file:\n    opened_file.write(\'Hola!\')\n# 等价于\nfile = open(\'some_file\', \'w\')\ntry:\n    file.write(\'Hola!\')\nfinally:\n    file.close()\n\n# 实现上下文管理器\n# 1. with 语句先暂存了 File 类的 __exit__ 方法。\n# 2. 然后它调用 File 类的 __enter__ 方法。\n# 3. __enter__ 方法打开文件并返回给 with 语句。\n# 4. 打开的文件句柄被传递给 opened_file 参数。\n# 5. 我们使用 .write() 来写文件。\n# 6. with 语句调用之前暂存的 __exit__ 方法。\n# 7. __exit__ 方法关闭了文件。\nclass File(object):\n    def __init__(self, file_name, method):\n        self.file_obj = open(file_name, method)\n    def __enter__(self):\n        return self.file_obj\n    def __exit__(self, type, value, traceback):\n        self.file_obj.close()\n# 使用\nwith File(\'demo.txt\', \'w\') as opened_file:\n    opened_file.write(\'Hola!\')\n\n# 尝试下在 __exit__ 方法中处理异常\n# 1. 它把异常的 type，value 和 traceback 传递给 __exit__方法。\n# 2. 它让 __exit__ 方法来处理异常。\n# 3. 如果 __exit__ 返回的是 True，那么这个异常就被优雅地处理了。\n# 4. 如果 __exit__ 返回的是 True 以外的任何东西，那么这个异常将被 with 语句抛出。\nclass File(object):\n    def __init__(self, file_name, method):\n        self.file_obj = open(file_name, method)\n    def __enter__(self):\n        return self.file_obj\n    def __exit__(self, type, value, traceback):\n        print(&quot;Exception has been handled&quot;)\n        self.file_obj.close()\n        return True\nwith File(\'demo.txt\', \'w\') as opened_file:\n    opened_file.undefined_function()\n# Output: Exception has been handled\n\n# 基于生成器的实现\n# 1. Python 解释器遇到了 yield 关键字。因为这个缘故它创建了一个生成器而不是一个普通的函数。\n# 2. 因为这个装饰器，contextmanager 会被调用并传入函数名（open_file）作为参数。\n# 3. contextmanager 函数返回一个以 GeneratorContextManager 对象封装过的生成器。\n# 4. 这个 GeneratorContextManager 被赋值给 open_file 函数，我们实际上是在调用 GeneratorContextManager 对象。\nfrom contextlib import contextmanager\n\n@contextmanager\ndef open_file(name):\n    f = open(name, \'w\')\n    yield f\n    f.close()\n# 使用\nwith open_file(\'some_file\') as f:\n    f.write(\'hola!\')`, `12815307814832112000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 等价于</span>\n<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 实现上下文管理器</span>\n<span class="token comment"># 1. with 语句先暂存了 File 类的 __exit__ 方法。</span>\n<span class="token comment"># 2. 然后它调用 File 类的 __enter__ 方法。</span>\n<span class="token comment"># 3. __enter__ 方法打开文件并返回给 with 语句。</span>\n<span class="token comment"># 4. 打开的文件句柄被传递给 opened_file 参数。</span>\n<span class="token comment"># 5. 我们使用 .write() 来写文件。</span>\n<span class="token comment"># 6. with 语句调用之前暂存的 __exit__ 方法。</span>\n<span class="token comment"># 7. __exit__ 方法关闭了文件。</span>\n<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj\n    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用</span>\n<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">\'demo.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 尝试下在 __exit__ 方法中处理异常</span>\n<span class="token comment"># 1. 它把异常的 type，value 和 traceback 传递给 __exit__方法。</span>\n<span class="token comment"># 2. 它让 __exit__ 方法来处理异常。</span>\n<span class="token comment"># 3. 如果 __exit__ 返回的是 True，那么这个异常就被优雅地处理了。</span>\n<span class="token comment"># 4. 如果 __exit__ 返回的是 True 以外的任何东西，那么这个异常将被 with 语句抛出。</span>\n<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj\n    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Exception has been handled"</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token boolean">True</span>\n<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">\'demo.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>undefined_function<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: Exception has been handled</span>\n\n<span class="token comment"># 基于生成器的实现</span>\n<span class="token comment"># 1. Python 解释器遇到了 yield 关键字。因为这个缘故它创建了一个生成器而不是一个普通的函数。</span>\n<span class="token comment"># 2. 因为这个装饰器，contextmanager 会被调用并传入函数名（open_file）作为参数。</span>\n<span class="token comment"># 3. contextmanager 函数返回一个以 GeneratorContextManager 对象封装过的生成器。</span>\n<span class="token comment"># 4. 这个 GeneratorContextManager 被赋值给 open_file 函数，我们实际上是在调用 GeneratorContextManager 对象。</span>\n<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager\n\n@contextmanager\n<span class="token keyword">def</span> <span class="token function">open_file</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> f\n    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用</span>\n<span class="token keyword">with</span> open_file<span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'hola!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO <a href="https://py.eastlakeside.cn/book/FunctionalProgramming/README.html" target="_blank" rel="nofollow noreferrer noopener">https://py.eastlakeside.cn/book/FunctionalProgramming/README.html</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python语法一览/index.md absPath of file >>> MarkdownRemark",timeToRead:28,frontmatter:{date:"2022-04-18 14:16:27",path:"/python-syntax-overview/",tags:"后端, python, 读书笔记",title:"Python语法一览",draft:null}},{excerpt:"背景资料 Python-100-Days Python 教程 因本人具有前端背景，以下内容只列举和 javascript 不同的地方 解释器 Python 的解释器很多，但使用最广泛的还是 CPython。如果要和 Java 或 .Net 平台交互，最好的办法不是用 Jython 或 IronPython，而是通过网络调用来交互，确保各程序之间的独立性。 直接运行 py 文件 一般是通过   运行，但是可以按照以下步骤在 Mac 和 Linux 上直接运行  然后，通过命令给 hello.py…",html:'<h1 id="背景资料"><a href="#%E8%83%8C%E6%99%AF%E8%B5%84%E6%96%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景资料</h1>\n<ul>\n<li><a href="https://github.com/jackfrued/Python-100-Days" target="_blank" rel="nofollow noreferrer noopener">Python-100-Days</a></li>\n<li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400" target="_blank" rel="nofollow noreferrer noopener">Python 教程</a></li>\n</ul>\n<p>因本人具有前端背景，以下内容只列举和 javascript 不同的地方</p>\n<h1 id="解释器"><a href="#%E8%A7%A3%E9%87%8A%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解释器</h1>\n<p>Python 的解释器很多，但使用最广泛的还是 CPython。如果要和 Java 或 .Net 平台交互，最好的办法不是用 Jython 或 IronPython，而是通过网络调用来交互，确保各程序之间的独立性。</p>\n<h2 id="直接运行-py-文件"><a href="#%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C-py-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接运行 py 文件</h2>\n<p>一般是通过 <code class="language-text">python hello.py</code> 运行，但是可以按照以下步骤在 Mac 和 Linux 上直接运行 <code class="language-text">./hello.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83761425379727020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n\nprint(\'hello, world\')`, `83761425379727020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello, world\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，通过命令给 hello.py 以执行权限，就可以直接运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58215633768263510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`chmod a+x hello.py`, `58215633768263510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">chmod</span> a+x hello.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="基础"><a href="#%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基础</h1>\n<ul>\n<li>解释型动态语言，运行速度慢，代码安全性差（不能加密）</li>\n<li><code class="language-text">#</code> 开头的是注释，语句以 <code class="language-text">:</code> 结尾时，缩进的语句是为代码块，一般缩进 4 个空格</li>\n<li>大小写敏感</li>\n</ul>\n<h2 id="数据类型与变量"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型与变量</h2>\n<h3 id="数据类型"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型</h3>\n<ul>\n<li>\n<p>整数：允许在数字中间以 <code class="language-text">_</code> 分隔，没有大小限制，<code class="language-text">//</code> 称为地板除，即只保留整数部分</p>\n</li>\n<li>\n<p>浮点数：浮点数运算有四舍五入的误差，整数运算是精确的，没有大小限制，超过一定范围表示为 <code class="language-text">inf</code>（无限大）</p>\n</li>\n<li>\n<p>字符串：</p>\n<ul>\n<li>以 <code class="language-text">&#39;</code> 或 <code class="language-text">&quot;</code> 括起来的文本，转义字符 <code class="language-text">\\</code> 可以用来转义</li>\n<li>使用 <code class="language-text">r&#39;&#39;</code> 表示 <code class="language-text">&#39;&#39;</code> 内部的字符串默认不转义</li>\n<li>用 <code class="language-text">&#39;&#39;&#39;...&#39;&#39;&#39;</code> 表示多行内容，可以和上面的 <code class="language-text">r</code> 结合使用，即 <code class="language-text">r&#39;&#39;&#39;...&#39;&#39;&#39;</code></li>\n</ul>\n</li>\n<li>\n<p>布尔值：值为 <code class="language-text">True</code> 或 <code class="language-text">False</code>，运算符为 <code class="language-text">and</code>、<code class="language-text">or</code>、<code class="language-text">not</code></p>\n</li>\n<li>\n<p>空值：值为 <code class="language-text">None</code></p>\n</li>\n</ul>\n<h3 id="变量与常量"><a href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B8%B8%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量与常量</h3>\n<p>变量可以动态赋值，常量可以用全部大写的变量名表示，但没有任何机制可以保证不改变</p>\n<h2 id="字符串和编码"><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符串和编码</h2>\n<h3 id="字符编码"><a href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符编码</h3>\n<p>Unicode 把所有语言都统一到一套编码里，最常用的是 UCS-16 编码，用两个字节表示一个字符（如果要用到非常偏僻的字符，就需要 4 个字节）。现代操作系统和大多数编程语言都直接支持 Unicode。</p>\n<p>ASCII 编码和 Unicode 编码的区别：ASCII 编码是 1 个字节，而 Unicode 编码通常是 2 个字节。</p>\n<p>如果统一成 Unicode 编码，乱码问题从此消失了。但是，如果你写的文本基本上全部是英文的话，用 Unicode 编码比 ASCII 编码需要多一倍的存储空间，在存储和传输上就十分不划算。</p>\n<p>于是出现了把 Unicode 编码转化为“可变长编码”的 UTF-8 编码，如下表</p>\n<table>\n<thead>\n<tr>\n<th align="left">字符</th>\n<th align="left">ASCII</th>\n<th align="left">Unicode</th>\n<th align="left">UTF-8</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">A</td>\n<td align="left">01000001</td>\n<td align="left">00000000 01000001</td>\n<td align="left">01000001</td>\n</tr>\n<tr>\n<td align="left">中</td>\n<td align="left">x</td>\n<td align="left">01001110 00101101</td>\n<td align="left">11100100 10111000 10101101</td>\n</tr>\n</tbody>\n</table>\n<p>UTF-8 编码有一个额外的好处，就是 ASCII 编码实际上可以被看成是 UTF-8 编码的一部分，所以，大量只支持 ASCII 编码的历史遗留软件可以在 UTF-8 编码下继续工作。</p>\n<p>总结一下现在计算机系统通用的字符编码工作方式：</p>\n<p>在计算机内存中，统一使用 Unicode 编码，当需要保存到硬盘或者需要传输的时候，就转换为 UTF-8 编码。</p>\n<p>用记事本编辑的时候，从文件读取的 UTF-8 字符被转换为 Unicode 字符到内存里，编辑完成后，保存的时候再把 Unicode 转换为 UTF-8 保存到文件：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 307px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.55374592833876%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACQklEQVQ4y42Ty5KiQBBF+f9f8BdcdK+McNmGC3yEYRjtiI+xbaFFXgUIBQw+5hQ147CbzkihrMrKvHnzYiRJej57Lj/PjyIRhpHyqOVhFIQhzoIA7UEQxnFinE7u8v19OBz+WC6v1+vj2yZEbJCv+qWsruv7/c6iLEvWHPOXdFJKisZxnOe53sR4p2lqgKe19Ti77mg0mk6ni8ViPB4PBoNer9fpdF5fX+bzuY7UlelXXa6vynRlypIyyzJKJUkcNy/P83hfLtntdqv/Gp0bRIsmIrmkrnv+/DxmeZ6k6QXLMhy0sihyKdkjC7ucUYCLxhMG1uSL2tgo1SAgHiwJIyEV+SIhqqoyiCiKUhNGhB8EdFGWVVEUj4Y/duiWcYBvtVq9vQ1Mc+Q4TkFl7nD80Rgc/NzvPw4H23Y83+cmXFCQIkJEu91uvV5vt1spc3oiu0GEEGI2m00mE9pjYZomEciAEQKbLPQMJ7bjnE4n1ATSs+cTDGEVBQEPks1mczgcSE/PNCZlwT5lKVI1hsZoCsDcJ6+CHSgNJFqJztcXT9Lxl8ptSakGfb9NJ7BrauBMAvf9gDWXSQd/T2dk6BFCdCQ79GsEQXA8HiEDkHwblCU9p1WFTqvyn4GaiVx54sAmksshl6EaVPv93rZt13XVnP5nSp6o7Klt3QzqIR20IRjLstA5cyav1syfsPs95TLVnxzoJyig3bJWMM+H0e12+/0+I2xThanvuZF1qkSX5dqVmKXUjUEEz2ZapaZNO5zxRfwGn2n3zQIgDBkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 04 03 18 12 23" title="" data-src="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png" data-srcset="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-73b08.png 200w,\n/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png 307w" data-sizes="(max-width: 307px) 100vw, 307px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>浏览网页的时候，服务器会把动态生成的 Unicode 内容转换为 UTF-8 再传输到浏览器：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 302px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.0794701986755%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQ4y41T226CQBDl///B37AP9c14w1s0phhTEiONILDAAstVoYdF0brSODkZlmHOzhXJgbgu4HkUCi9vghBHwuNLUWaz2Xg8PhwOZVkWRVG+IXmeS/wax7IsXddd1/2fUNzkSiaO8xgtCALDMAghuIhSanCRZXmxWOx2u9sV5TO55iOF+Xy+2WygQej3+8PhsNPpdLsfsJzP5yZSRbZsG6fL5dLw27JtfGq3NMsk3/erdrteDd52CAVgNy3LoxSmK9w78FUSg4Rh6AcBNK48HnXGGF59P8jS7MlZalKtHzUTRpSUpmmcJDkXnOvu/CHfY3Kdptm3qk7lqaqq+/3+R9OU7XYwGMBIqd9O5imwKDqZpqZppmlibIiJLmBafA+9VnJ5jZyiVYxFqLqinU4oBGeERdmtNTeCkWCe0HEcI2DBRwqL6CkVgjTfoijCzjYViZ71bruPA6yBJDFum9goAWfRB82XbELEPylJkslkgvUcjUbYUEVRRJ9qPW3ivCSv1+vlcolftdf7XK1Wr8l8BN4T0PCQMa9qcQAFiD4g/gLi+gXiblyElAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 04 03 18 13 07" title="" data-src="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png" data-srcset="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-8a177.png 200w,\n/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png 302w" data-sizes="(max-width: 302px) 100vw, 302px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="python-的字符串"><a href="#python-%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python 的字符串</h3>\n<p>对于单个字符的编码，Python 提供了 ord() 函数获取字符的整数表示，chr() 函数把编码转换为对应的字符：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28605265819623195000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> ord(\'A\')\n65\n>>> ord(\'中\')\n20013\n>>> chr(66)\n\'B\'\n>>> chr(25991)\n\'文\'`, `28605265819623195000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token number">65</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'中\'</span><span class="token punctuation">)</span>\n<span class="token number">20013</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">66</span><span class="token punctuation">)</span>\n<span class="token string">\'B\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">25991</span><span class="token punctuation">)</span>\n<span class="token string">\'文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果知道字符的整数编码，还可以用十六进制这么写 str：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80076236974365700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'\\u4e2d\\u6587\'\n\'中文\'`, `80076236974365700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'\\u4e2d\\u6587\'</span>\n<span class="token string">\'中文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>两种写法完全是等价的。</p>\n<p>由于 Python 的字符串类型是 str，在内存中以 Unicode 表示，一个字符对应若干个字节。如果要在网络上传输，或者保存到磁盘上，就需要把 str 变为以字节为单位的 bytes。</p>\n<p>Python 对 bytes 类型的数据用带 b 前缀的单引号或双引号表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35437714017643905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = b\'ABC\'`, `35437714017643905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">b\'ABC\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>要注意区分 <code class="language-text">&#39;ABC&#39;</code> 和 <code class="language-text">b&#39;ABC&#39;</code>，前者是 str，后者虽然内容显示得和前者一样，但 bytes 的每个字符都只占用一个字节。</p>\n<p>以 Unicode 表示的 str 通过 <code class="language-text">encode()</code> 方法可以编码为指定的 bytes，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17579986027694883000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABC\'.encode(\'ascii\')\nb\'ABC\'\n>>> \'中文\'.encode(\'utf-8\')\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'\n>>> \'中文\'.encode(\'ascii\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nUnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)`, `17579986027694883000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n<span class="token string">b\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nUnicodeEncodeError<span class="token punctuation">:</span> <span class="token string">\'ascii\'</span> codec can\'t encode characters <span class="token keyword">in</span> position <span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> ordinal <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>纯英文的 str 可以用 ASCII 编码为 bytes，内容是一样的，含有中文的 str 可以用 UTF-8 编码为 bytes。含有中文的 str 无法用 ASCII 编码，因为中文编码的范围超过了 ASCII 编码的范围，Python 会报错。</p>\n<p>在 bytes 中，无法显示为 ASCII 字符的字节，用 <code class="language-text">\\x##</code> 显示。</p>\n<p>反过来，如果我们从网络或磁盘上读取了字节流，那么读到的数据就是 bytes。要把 bytes 变为 str，就需要用 <code class="language-text">decode()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29159371852421345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'ABC\'.decode(\'ascii\')\n\'ABC\'\n>>> b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'.decode(\'utf-8\')\n\'中文\'`, `29159371852421345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'ABC\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n<span class="token string">\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n<span class="token string">\'中文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 bytes 中包含无法解码的字节，<code class="language-text">decode()</code> 方法会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46972520566281270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'\\xe4\\xb8\\xad\\xff\'.decode(\'utf-8\')\nTraceback (most recent call last):\n  ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xff in position 3: invalid start byte`, `46972520566281270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xff\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xff</span> <span class="token keyword">in</span> position <span class="token number">3</span><span class="token punctuation">:</span> invalid start byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 bytes 中只有一小部分无效的字节，可以传入 <code class="language-text">errors=&#39;ignore&#39;</code> 忽略错误的字节：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42036947483029996000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'\\xe4\\xb8\\xad\\xff\'.decode(\'utf-8\', errors=\'ignore\')\n\'中\'`, `42036947483029996000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xff\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'ignore\'</span><span class="token punctuation">)</span>\n<span class="token string">\'中\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要计算 str 包含多少个字符，可以用 <code class="language-text">len()</code> 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18777401911591920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(\'ABC\')\n3\n>>> len(\'中文\')\n2`, `18777401911591920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">)</span>\n<span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">len()</code> 函数计算的是 str 的字符数，如果换成 bytes，<code class="language-text">len()</code> 函数就计算字节数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24291544935120355000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(b\'ABC\')\n3\n>>> len(b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\')\n6\n>>> len(\'中文\'.encode(\'utf-8\'))\n6`, `24291544935120355000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，1 个中文字符经过 UTF-8 编码后通常会占用 3 个字节，而 1 个英文字符只占用 1 个字节。</p>\n<p>在操作字符串时，我们经常遇到 str 和 bytes 的互相转换。为了避免乱码问题，应当始终坚持使用 UTF-8 编码对 str 和 bytes 进行转换。</p>\n<p>由于 Python 源代码也是一个文本文件，所以，当你的源代码中包含中文的时候，在保存源代码时，就需要务必指定保存为 UTF-8 编码。当 Python 解释器读取源代码时，为了让它按 UTF-8 编码读取，我们通常在文件开头写上这两行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26407853211026457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n# -*- coding: utf-8 -*-`, `26407853211026457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n<span class="token comment"># -*- coding: utf-8 -*-</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>第一行注释是为了告诉 Linux/OS X 系统，这是一个 Python 可执行程序，Windows 系统会忽略这个注释；</p>\n<p>第二行注释是为了告诉 Python 解释器，按照 UTF-8 编码读取源代码，否则，你在源代码中写的中文输出可能会有乱码。</p>\n<p>申明了 UTF-8 编码并不意味着你的 .py 文件就是 UTF-8 编码的，必须并且要确保文本编辑器正在使用 UTF-8 without BOM 编码：</p>\n<p>如果 .py 文件本身使用 UTF-8 编码，并且也申明了 <code class="language-text"># -*- coding: utf-8 -*-</code>，打开命令提示符测试就可以正常显示中文：</p>\n<h3 id="格式化"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化</h3>\n<p>最后一个常见的问题是如何输出格式化的字符串。我们经常会输出类似’亲爱的 xxx 你好！你 xx 月的话费是 xx，余额是 xx’之类的字符串，而 xxx 的内容都是根据变量变化的，所以，需要一种简便的格式化字符串的方式。</p>\n<p>在 Python 中，采用的格式化方式和 C 语言是一致的，用 % 实现，举例如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79343209312554500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Hello, %s\' % \'world\'\n\'Hello, world\'\n>>> \'Hi, %s, you have \\$%d.\' % (\'Michael\', 1000000)\n\'Hi, Michael, you have \\$1000000.\'`, `79343209312554500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hello, %s\'</span> <span class="token operator">%</span> <span class="token string">\'world\'</span>\n<span class="token string">\'Hello, world\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hi, %s, you have $%d.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>\n<span class="token string">\'Hi, Michael, you have $1000000.\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能猜到了，% 运算符就是用来格式化字符串的。在字符串内部，%s 表示用字符串替换，%d 表示用整数替换，有几个 %? 占位符，后面就跟几个变量或者值，顺序要对应好。如果只有一个 %?，括号可以省略。</p>\n<p>常见的占位符有：</p>\n<table>\n<thead>\n<tr>\n<th align="left">占位符</th>\n<th align="left">替换内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">%d</td>\n<td align="left">整数</td>\n</tr>\n<tr>\n<td align="left">%f</td>\n<td align="left">浮点数</td>\n</tr>\n<tr>\n<td align="left">%s</td>\n<td align="left">字符串</td>\n</tr>\n<tr>\n<td align="left">%x</td>\n<td align="left">十六进制整数</td>\n</tr>\n</tbody>\n</table>\n<p>其中，格式化整数和浮点数还可以指定是否补 0 和整数与小数的位数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96228196764755950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'%2d-%02d\' % (3, 1)) # 3-01\nprint(\'%.2f\' % 3.1415926) # 3.14`, `96228196764755950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%2d-%02d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 3-01</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%.2f\'</span> <span class="token operator">%</span> <span class="token number">3.1415926</span><span class="token punctuation">)</span> <span class="token comment"># 3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你不太确定应该用什么，%s 永远起作用，它会把任何数据类型转换为字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83187397305692590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Age: %s. Gender: %s\' % (25, True)\n\'Age: 25. Gender: True\'`, `83187397305692590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Age: %s. Gender: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token string">\'Age: 25. Gender: True\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>有些时候，字符串里面的 % 是一个普通字符怎么办？这个时候就需要转义，用 %% 来表示一个 %：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43832022282819530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'growth rate: %d %%\' % 7\n\'growth rate: 7 %\'`, `43832022282819530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'growth rate: %d %%\'</span> <span class="token operator">%</span> <span class="token number">7</span>\n<span class="token string">\'growth rate: 7 %\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="format"><a href="#format" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>format()</h4>\n<p>另一种格式化字符串的方法是使用字符串的 format() 方法，它会用传入的参数依次替换字符串内的占位符 <code class="language-text">{0}、{1}……</code>，不过这种方式写起来比 % 要麻烦得多：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57572059738426670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Hello, {0}, 成绩提升了 {1:.1f}%\'.format(\'小明\', 17.125)\n\'Hello, 小明, 成绩提升了 17.1%\'`, `57572059738426670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hello, {0}, 成绩提升了 {1:.1f}%\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'小明\'</span><span class="token punctuation">,</span> <span class="token number">17.125</span><span class="token punctuation">)</span>\n<span class="token string">\'Hello, 小明, 成绩提升了 17.1%\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="f-string"><a href="#f-string" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>f-string</h4>\n<p>最后一种格式化字符串的方法是使用以 f 开头的字符串，称之为 f-string，它和普通字符串不同之处在于，字符串如果包含 {xxx}，就会以对应的变量替换：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78784780335416070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = 2.5\n>>> s = 3.14 * r ** 2\n>>> print(f\'The area of a circle with radius {r} is {s:.2f}\')\nThe area of a circle with radius 2.5 is 19.62`, `78784780335416070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token number">2.5</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token number">3.14</span> <span class="token operator">*</span> r <span class="token operator">**</span> <span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'The area of a circle with radius </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\nThe area of a circle <span class="token keyword">with</span> radius <span class="token number">2.5</span> <span class="token keyword">is</span> <span class="token number">19.62</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中，{r} 被变量 r 的值替换，{s:.2f} 被变量 s 的值替换，并且 : 后面的 .2f 指定了格式化参数（即保留两位小数），因此，{s:.2f} 的替换结果是 19.62。</p>\n<h2 id="使用-list-和-tuple"><a href="#%E4%BD%BF%E7%94%A8-list-%E5%92%8C-tuple" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 list 和 tuple</h2>\n<h3 id="list"><a href="#list" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>list</h3>\n<p>Python 内置的一种数据类型是列表：list。list 是一种有序的集合，可以随时添加和删除其中的元素。</p>\n<p>比如，列出班里所有同学的名字，就可以用一个 list 表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46508057281946490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates = [\'Michael\', \'Bob\', \'Tracy\']\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\']`, `46508057281946490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>变量 classmates 就是一个 list。用 len() 函数可以获得 list 元素的个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91520289349887250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(classmates)\n3`, `91520289349887250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>classmates<span class="token punctuation">)</span>\n<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>用索引来访问 list 中每一个位置的元素，记得索引是从 0 开始的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85581414849950370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[0]\n\'Michael\'\n>>> classmates[1]\n\'Bob\'\n>>> classmates[2]\n\'Tracy\'\n>>> classmates[3]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nIndexError: list index out of range`, `85581414849950370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token string">\'Bob\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'Tracy\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当索引超出了范围时，Python 会报一个 IndexError 错误，所以，要确保索引不要越界，记得最后一个元素的索引是 <code class="language-text">len(classmates) - 1</code>。</p>\n<p>如果要取最后一个元素，除了计算索引位置外，还可以用 -1 做索引，直接获取最后一个元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4242481824887956000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[-1]\n\'Tracy\'`, `4242481824887956000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token string">\'Tracy\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>以此类推，可以获取倒数第 2 个、倒数第 3 个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88391443366913720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[-2]\n\'Bob\'\n>>> classmates[-3]\n\'Michael\'\n>>> classmates[-4]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nIndexError: list index out of range`, `88391443366913720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'Bob\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，倒数第 4 个就越界了。</p>\n<p>list 是一个可变的有序表，所以，可以往 list 中追加元素到末尾：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69782648841262130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.append(\'Adam\')\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\', \'Adam\']`, `69782648841262130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Adam\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Adam\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>也可以把元素插入到指定的位置，比如索引号为 1 的位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38360280193421950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.insert(1, \'Jack\')\n>>> classmates\n[\'Michael\', \'Jack\', \'Bob\', \'Tracy\', \'Adam\']`, `38360280193421950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Adam\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要删除 list 末尾的元素，用 pop() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34632093555545660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.pop()\n\'Adam\'\n>>> classmates\n[\'Michael\', \'Jack\', \'Bob\', \'Tracy\']`, `34632093555545660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Adam\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要删除指定位置的元素，用 pop(i) 方法，其中 i 是索引位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97739112651168600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.pop(1)\n\'Jack\'\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\']`, `97739112651168600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token string">\'Jack\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要把某个元素替换成别的元素，可以直接赋值给对应的索引位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46456160327480300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[1] = \'Sarah\'\n>>> classmates\n[\'Michael\', \'Sarah\', \'Tracy\']`, `46456160327480300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Sarah\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>list 里面的元素的数据类型也可以不同，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75365290316274760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Apple\', 123, True]`, `75365290316274760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Apple\'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>list 元素也可以是另一个 list，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85757492880527980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = [\'python\', \'java\', [\'asp\', \'php\'], \'scheme\']\n>>> len(s)\n4`, `85757492880527980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'java\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'asp\'</span><span class="token punctuation">,</span> <span class="token string">\'php\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'scheme\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要注意 s 只有 4 个元素，其中 <code class="language-text">s[2]</code> 又是一个 list，如果拆开写就更容易理解了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9563148339184945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> p = [\'asp\', \'php\']\n>>> s = [\'python\', \'java\', p, \'scheme\']`, `9563148339184945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'asp\'</span><span class="token punctuation">,</span> <span class="token string">\'php\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'java\'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">\'scheme\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要拿到 <code class="language-text">&#39;php&#39;</code> 可以写 <code class="language-text">p[1]</code> 或者 <code class="language-text">s[2][1]</code>，因此 s 可以看成是一个二维数组，类似的还有三维、四维……数组，不过很少用到。</p>\n<p>如果一个 list 中一个元素也没有，就是一个空的 list，它的长度为 0：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11401925762673625000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = []\n>>> len(L)\n0`, `11401925762673625000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="tuple"><a href="#tuple" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tuple</h3>\n<p>另一种有序列表叫元组：tuple。tuple 和 list 非常类似，但是 tuple 一旦初始化就不能修改，比如同样是列出同学的名字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35070935847320285000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates = (\'Michael\', \'Bob\', \'Tracy\')`, `35070935847320285000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在，classmates 这个 tuple 不能变了，它也没有 append()，insert() 这样的方法。其他获取元素的方法和 list 是一样的，你可以正常地使用 <code class="language-text">classmates[0]</code>，<code class="language-text">classmates[-1]</code>，但不能赋值成另外的元素。</p>\n<p>不可变的 tuple 有什么意义？因为 tuple 不可变，所以代码更安全。如果可能，能用 tuple 代替 list 就尽量用 tuple。</p>\n<p>tuple 的陷阱：当你定义一个 tuple 时，在定义的时候，tuple 的元素就必须被确定下来，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50601419687892510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1, 2)\n>>> t\n(1, 2)`, `50601419687892510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果要定义一个空的 tuple，可以写成 ()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22410117879451152000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = ()\n>>> t\n()`, `22410117879451152000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但是，要定义一个只有 1 个元素的 tuple，如果你这么定义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53142116328086140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1)\n>>> t\n1`, `53142116328086140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>定义的不是 tuple，是 1 这个数，这是因为括号 () 既可以表示 tuple，又可以表示数学公式中的小括号，这就产生了歧义，因此，Python 规定，这种情况下，按小括号进行计算，计算结果自然是 1。</p>\n<p>所以，只有 1 个元素的 tuple 定义时必须加一个逗号 <code class="language-text">,</code>，来消除歧义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70885356182575410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1,)\n>>> t\n(1,)`, `70885356182575410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Python 在显示只有 1 个元素的 tuple 时，也会加一个逗号 <code class="language-text">,</code>，以免你误解成数学计算意义上的括号。</p>\n<p>最后来看一个 “可变的” tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52154783760982080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (\'a\', \'b\', [\'A\', \'B\'])\n>>> t[2][0] = \'X\'\n>>> t[2][1] = \'Y\'\n>>> t\n(\'a\', \'b\', [\'X\', \'Y\'])`, `52154783760982080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'X\'</span>\n<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Y\'</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'X\'</span><span class="token punctuation">,</span> <span class="token string">\'Y\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>tuple 所谓的“不变”是说，tuple 的每个元素，指向永远不变。即指向 ‘a’，就不能改成指向 ‘b’，指向一个 list，就不能改成指向其他对象，但指向的这个 list 本身是可变的！</p>\n<h2 id="条件判断"><a href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>条件判断</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36720352810513334000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`age = 3\nif age >= 18:\n    print(\'adult\')\nelif age >= 6:\n    print(\'teenager\')\nelse:\n    print(\'kid\')`, `36720352810513334000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">age <span class="token operator">=</span> <span class="token number">3</span>\n<span class="token keyword">if</span> age <span class="token operator">>=</span> <span class="token number">18</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'adult\'</span><span class="token punctuation">)</span>\n<span class="token keyword">elif</span> age <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'teenager\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'kid\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>if 判断条件还可以简写，比如写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70634607838677120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if x:\n    print(\'True\')`, `70634607838677120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> x<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'True\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>只要 x 是非零数值、非空字符串、非空 list 等，就判断为 True，否则为 False。</p>\n<h3 id="再议-input"><a href="#%E5%86%8D%E8%AE%AE-input" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再议 input</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10514721430882656000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`birth = input(\'birth: \')\nif birth < 2000:\n    print(\'00前\')\nelse:\n    print(\'00后\')`, `10514721430882656000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">birth <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">\'birth: \'</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> birth <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00前\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00后\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入 1982，结果报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="592185408444612100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: unorderable types: str() > int()`, `592185408444612100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Traceback (most recent call last):\n  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;\nTypeError: unorderable types: str() &gt; int()</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是因为 input() 返回的数据类型是 str，str 不能直接和整数比较，必须先把 str 转换成整数。Python 提供了 int() 函数来完成这件事情：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51226155438721870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = input(\'birth: \')\nbirth = int(s)\nif birth < 2000:\n    print(\'00前\')\nelse:\n    print(\'00后\')`, `51226155438721870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">\'birth: \'</span><span class="token punctuation">)</span>\nbirth <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token keyword">if</span> birth <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00前\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00后\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再次运行，就可以得到正确地结果。但是，如果输入 abc 呢？又会得到一个错误信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37835539986559350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nValueError: invalid literal for int() with base 10: \'abc\'`, `37835539986559350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nValueError<span class="token punctuation">:</span> invalid literal <span class="token keyword">for</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">with</span> base <span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>原来 int() 函数发现一个字符串并不是合法的数字时就会报错，程序就退出了。</p>\n<p>如何检查并捕获程序运行期的错误呢？后面的错误和调试会讲到。</p>\n<h2 id="循环"><a href="#%E5%BE%AA%E7%8E%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>循环</h2>\n<p>Python 的循环有两种，一种是 for…in 循环，依次把 list 或 tuple 中的每个元素迭代出来，看例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80982745173189950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Michael\', \'Bob\', \'Tracy\']\nfor name in names:\n    print(name)`, `80982745173189950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>第二种循环是 while 循环，只要条件满足，就不断循环，条件不满足时退出循环。比如我们要计算 100 以内所有奇数之和，可以用 while 循环实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42380130154135600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = 0\nn = 99\nwhile n > 0:\n    sum = sum + n\n    n = n - 2\nprint(sum)`, `42380130154135600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\nn <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">while</span> n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n\n    n <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>break 提前结束循环，continue 提前结束本轮循环，并直接开始下一轮循环。</p>\n<h2 id="使用-dict-和-set"><a href="#%E4%BD%BF%E7%94%A8-dict-%E5%92%8C-set" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 dict 和 set</h2>\n<h3 id="dict"><a href="#dict" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dict</h3>\n<p>Python 内置了字典：dict 的支持，dict 全称 dictionary，在其他语言中也称为 map，使用键-值（key-value）存储，具有极快的查找速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33063402937724183000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'Michael\': 95, \'Bob\': 75, \'Tracy\': 85}\n>>> d[\'Michael\']\n95`, `33063402937724183000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'Michael\'</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">:</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">]</span>\n<span class="token number">95</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果 key 不存在，dict 就会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20268022208842605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d[\'Thomas\']\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nKeyError: \'Thomas\'`, `20268022208842605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token string">\'Thomas\'</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nKeyError<span class="token punctuation">:</span> <span class="token string">\'Thomas\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要避免 key 不存在的错误，有两种办法，一是通过 in 判断 key 是否存在：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44464909362736415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Thomas\' in d\nFalse`, `44464909362736415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Thomas\'</span> <span class="token keyword">in</span> d\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>二是通过 dict 提供的 get() 方法，如果 key 不存在，可以返回 None，或者自己指定的 value：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45664081350902915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d.get(\'Thomas\')\n>>> d.get(\'Thomas\', -1)\n-1`, `45664081350902915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Thomas\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Thomas\'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">-</span><span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意：返回 None 的时候 Python 的交互环境不显示结果。</p>\n<p>要删除一个 key，用 pop(key) 方法，对应的 value 也会从 dict 中删除：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49019772190513300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d.pop(\'Bob\')\n75\n>>> d\n{\'Michael\': 95, \'Tracy\': 85}`, `49019772190513300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">)</span>\n<span class="token number">75</span>\n<span class="token operator">>></span><span class="token operator">></span> d\n<span class="token punctuation">{</span><span class="token string">\'Michael\'</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请务必注意，dict 内部存放的顺序和 key 放入的顺序是没有关系的。</p>\n<p>和 list 比较，dict 有以下几个特点：</p>\n<ol>\n<li>查找和插入的速度极快，不会随着 key 的增加而变慢；</li>\n<li>需要占用大量的内存，内存浪费多。</li>\n</ol>\n<p>而 list 相反：</p>\n<ol>\n<li>查找和插入的时间随着元素的增加而增加；</li>\n<li>占用空间小，浪费内存很少。</li>\n</ol>\n<p>所以，dict 是用空间来换取时间的一种方法。</p>\n<p>dict 可以用在需要高速查找的很多地方，在 Python 代码中几乎无处不在，正确使用 dict 非常重要，需要牢记的第一条就是 dict 的 key 必须是不可变对象。</p>\n<p>这是因为 dict 根据 key 来计算 value 的存储位置，如果每次计算相同的 key 得出的结果不同，那 dict 内部就完全混乱了。这个通过 key 计算位置的算法称为哈希算法（Hash）。</p>\n<p>要保证 hash 的正确性，作为 key 的对象就不能变。在 Python 中，字符串、整数等都是不可变的，因此，可以放心地作为 key。而 list 是可变的，就不能作为 key：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22563872719986500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> key = [1, 2, 3]\n>>> d[key] = \'a list\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: unhashable type: \'list\'`, `22563872719986500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'a list\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> unhashable <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token string">\'list\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="set"><a href="#set" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>set</h3>\n<p>set 和 dict 类似，也是一组 key 的集合，但不存储 value。由于 key 不能重复，所以，在 set 中，没有重复的 key。</p>\n<p>要创建一个 set，需要提供一个 list 作为输入集合：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39405188574009030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = set([1, 2, 3])\n>>> s\n{1, 2, 3}`, `39405188574009030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意，传入的参数[1, 2, 3]是一个 list，而显示的{1, 2, 3}只是告诉你这个 set 内部有 1，2，3 这 3 个元素，显示的顺序也不表示 set 是有序的。。</p>\n<p>重复元素在 set 中自动被过滤：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83125727291732750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = set([1, 1, 2, 2, 3, 3])\n>>> s\n{1, 2, 3}`, `83125727291732750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>通过 add(key) 方法可以添加元素到 set 中，可以重复添加，但不会有效果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43294930537473260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.add(4)\n>>> s\n{1, 2, 3, 4}\n>>> s.add(4)\n>>> s\n{1, 2, 3, 4}`, `43294930537473260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 remove(key) 方法可以删除元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24234643266235770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.remove(4)\n>>> s\n{1, 2, 3}`, `24234643266235770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>set 可以看成数学意义上的无序和无重复元素的集合，因此，两个 set 可以做数学意义上的交集、并集等操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89194707684895100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s1 = set([1, 2, 3])\n>>> s2 = set([2, 3, 4])\n>>> s1 & s2\n{2, 3}\n>>> s1 | s2\n{1, 2, 3, 4}`, `89194707684895100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">&amp;</span> s2\n<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">|</span> s2\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>set 和 dict 的唯一区别仅在于没有存储对应的 value，但是，set 的原理和 dict 一样，所以，同样不可以放入可变对象，因为无法判断两个可变对象是否相等，也就无法保证 set 内部“不会有重复元素”。试试把 list 放入 set，看看是否会报错。</p>\n<h3 id="再议不可变对象"><a href="#%E5%86%8D%E8%AE%AE%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再议不可变对象</h3>\n<p>上面我们讲了，str 是不变对象，而 list 是可变对象。</p>\n<p>对于可变对象，比如 list，对 list 进行操作，list 内部的内容是会变化的，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10424789221867870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = [\'c\', \'b\', \'a\']\n>>> a.sort()\n>>> a\n[\'a\', \'b\', \'c\']`, `10424789221867870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而对于不可变对象，比如 str，对 str 进行操作呢：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83551461952606220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = \'abc\'\n>>> a.replace(\'a\', \'A\')\n\'Abc\'\n>>> a\n\'abc\'`, `83551461952606220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">\'abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token string">\'Abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然字符串有个 replace() 方法，也确实变出了 ‘Abc’，但变量 a 最后仍是 ‘abc’，应该怎么理解呢？</p>\n<p>我们先把代码改成下面这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62807618395241185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = \'abc\'\n>>> b = a.replace(\'a\', \'A\')\n>>> b\n\'Abc\'\n>>> a\n\'abc\'`, `62807618395241185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">\'abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> b\n<span class="token string">\'Abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要始终牢记的是，a 是变量，而 ‘abc’ 才是字符串对象！有些时候，我们经常说，对象 a 的内容是 ‘abc’，但其实是指，a 本身是一个变量，它指向的对象的内容才是 ‘abc’</p>\n<p>当我们调用 a.replace(‘a’, ‘A’) 时，实际上调用方法 replace 是作用在字符串对象 ‘abc’ 上的，而这个方法虽然名字叫 replace，但却没有改变字符串 ‘abc’ 的内容。相反，replace 方法创建了一个新字符串 ‘Abc’ 并返回，如果我们用变量 b 指向该新字符串，就容易理解了，变量 a 仍指向原有的字符串 ‘abc’，但变量 b 却指向新字符串 ‘Abc’ 了</p>\n<p>所以，对于不变对象来说，调用对象自身的任意方法，也不会改变该对象自身的内容。相反，这些方法会创建新的对象并返回，这样，就保证了不可变对象本身永远是不可变的。</p>\n<h1 id="函数"><a href="#%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数</h1>\n<h2 id="调用函数"><a href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用函数</h2>\n<p>Python 内置了很多有用的函数，我们可以直接调用</p>\n<p>可以直接从 Python 的官方网站查看<a href="http://docs.python.org/3/library/functions.html#abs" target="_blank" rel="nofollow noreferrer noopener">文档</a>，也可以在交互式命令行通过 help(abs) 查看 abs 函数的帮助信息</p>\n<h3 id="数据类型转换"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型转换</h3>\n<p>Python 内置的常用函数还包括数据类型转换函数，比如 int() 函数可以把其他数据类型转换为整数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66720901339212470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(\'123\')\n123\n>>> int(12.34)\n12\n>>> float(\'12.34\')\n12.34\n>>> str(1.23)\n\'1.23\'\n>>> str(100)\n\'100\'\n>>> bool(1)\nTrue\n>>> bool(\'\')\nFalse`, `66720901339212470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'123\'</span><span class="token punctuation">)</span>\n<span class="token number">123</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">12.34</span><span class="token punctuation">)</span>\n<span class="token number">12</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'12.34\'</span><span class="token punctuation">)</span>\n<span class="token number">12.34</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1.23</span><span class="token punctuation">)</span>\n<span class="token string">\'1.23\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token string">\'100\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>函数名其实就是指向一个函数对象的引用，完全可以把函数名赋给一个变量，相当于给这个函数起了一个“别名”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99002321808597980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = abs # 变量 a 指向 abs 函数\n>>> a(-1) # 所以也可以通过 a 调用 abs 函数\n1`, `99002321808597980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token builtin">abs</span> <span class="token comment"># 变量 a 指向 abs 函数</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 所以也可以通过 a 调用 abs 函数</span>\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="定义函数"><a href="#%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定义函数</h3>\n<p>在 Python 中，定义一个函数要使用 def 语句，依次写出函数名、括号、括号中的参数和冒号 :，然后，在缩进块中编写函数体，函数的返回值用 return 语句返回。</p>\n<p>我们以自定义一个求绝对值的 my_abs 函数为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72018927832679020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_abs(x):\n    if x >= 0:\n        return x\n    else:\n        return -x\n\nprint(my_abs(-99))`, `72018927832679020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token operator">-</span>x\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>my_abs<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果没有 return 语句，函数执行完毕后也会返回结果，只是结果为 None。return None 可以简写为 return。</p>\n<h3 id="空函数"><a href="#%E7%A9%BA%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>空函数</h3>\n<p>如果想定义一个什么事也不做的空函数，可以用 pass 语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27894460154052370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def nop():\n    pass`, `27894460154052370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>pass 语句什么都不做，那有什么用？实际上 pass 可以用来作为占位符，比如现在还没想好怎么写函数的代码，就可以先放一个 pass，让代码能运行起来。</p>\n<p>pass 还可以用在其他语句里，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69161404574169130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if age >= 18:\n    pass`, `69161404574169130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> age <span class="token operator">>=</span> <span class="token number">18</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>缺少了 pass，代码运行就会有语法错误。</p>\n<h3 id="参数检查"><a href="#%E5%8F%82%E6%95%B0%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参数检查</h3>\n<p>调用函数时，如果参数个数不对，Python 解释器会自动检查出来，并抛出 TypeError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2541016040310251000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(1, 2)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: my_abs() takes 1 positional argument but 2 were given`, `2541016040310251000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> my_abs<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">1</span> positional argument but <span class="token number">2</span> were given</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是如果参数类型不对，Python 解释器就无法帮我们检查。试试 my_abs 和内置函数 abs 的差别：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1095573123179627300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\n  File &quot;<stdin>&quot;, line 2, in my_abs\nTypeError: unorderable types: str() >= int()\n>>> abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: bad operand type for abs(): \'str\'`, `1095573123179627300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">in</span> my_abs\nTypeError<span class="token punctuation">:</span> unorderable types<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> bad operand <span class="token builtin">type</span> <span class="token keyword">for</span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当传入了不恰当的参数时，内置函数 abs 会检查出参数错误，而我们定义的 my_abs 没有参数检查，会导致 if 语句出错，出错信息和 abs 不一样。所以，这个函数定义不够完善。</p>\n<p>让我们修改一下 my_abs 的定义，对参数类型做检查，只允许整数和浮点数类型的参数。数据类型检查可以用内置函数 isinstance() 实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34551474184674190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_abs(x):\n    if not isinstance(x, (int, float)):\n        raise TypeError(\'bad operand type\')\n    if x >= 0:\n        return x\n    else:\n        return -x`, `34551474184674190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'bad operand type\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token operator">-</span>x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加了参数检查后，如果传入错误的参数类型，函数就可以抛出一个错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75480382825136870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\n  File &quot;<stdin>&quot;, line 3, in my_abs\nTypeError: bad operand type`, `75480382825136870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">in</span> my_abs\nTypeError<span class="token punctuation">:</span> bad operand <span class="token builtin">type</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误和异常处理将在后续讲到。</p>\n<h3 id="返回多个值"><a href="#%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回多个值</h3>\n<p>函数可以返回多个值吗？答案是肯定的。</p>\n<p>比如在游戏中经常需要从一个点移动到另一个点，给出坐标、位移和角度，就可以计算出新的坐标：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29049093707758653000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\ndef move(x, y, step, angle=0):\n    nx = x + step * math.cos(angle)\n    ny = y - step * math.sin(angle)\n    return nx, ny`, `29049093707758653000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n<span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> step<span class="token punctuation">,</span> angle<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    nx <span class="token operator">=</span> x <span class="token operator">+</span> step <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>\n    ny <span class="token operator">=</span> y <span class="token operator">-</span> step <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> nx<span class="token punctuation">,</span> ny</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>import math 语句表示导入 math 包，并允许后续代码引用 math 包里的 sin、cos 等函数。</p>\n<p>然后，我们就可以同时获得返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5547982559750686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> x, y = move(100, 100, 60, math.pi / 6)\n>>> print(x, y)\n151.96152422706632 70.0`, `5547982559750686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> move<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token number">151.96152422706632</span> <span class="token number">70.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但其实这只是一种假象，Python 函数返回的仍然是单一值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73794651441012060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = move(100, 100, 60, math.pi / 6)\n>>> print(r)\n(151.96152422706632, 70.0)`, `73794651441012060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> move<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token number">151.96152422706632</span><span class="token punctuation">,</span> <span class="token number">70.0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>原来返回值是一个 tuple！但是，在语法上，返回一个 tuple 可以省略括号，而多个变量可以同时接收一个 tuple，按位置赋给对应的值，所以，Python 的函数返回多值其实就是返回一个 tuple，但写起来更方便。</p>\n<h2 id="函数的参数"><a href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数的参数</h2>\n<h3 id="位置参数"><a href="#%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>位置参数</h3>\n<p>power(x, n)函数有两个参数：x 和 n，这两个参数都是位置参数，调用函数时，传入的两个值按照位置顺序依次赋给参数 x 和 n。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61030024976794200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def power(x, n):\n    s = 1\n    while n > 0:\n        n = n - 1\n        s = s * x\n    return s`, `61030024976794200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">power</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    s <span class="token operator">=</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span>\n        s <span class="token operator">=</span> s <span class="token operator">*</span> x\n    <span class="token keyword">return</span> s</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="默认参数"><a href="#%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>默认参数</h3>\n<p>设置默认参数时，注意点如下：</p>\n<ol>\n<li>必选参数在前，默认参数在后，否则 Python 的解释器会报错（思考一下为什么默认参数不能放在必选参数前面）</li>\n<li>当函数有多个参数时，把变化大的参数放前面，变化小的参数放后面。变化小的参数就可以作为默认参数</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58958676018405590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def enroll(name, gender, age=6, city=\'Beijing\'):\n    print(\'name:\', name)\n    print(\'gender:\', gender)\n    print(\'age:\', age)\n    print(\'city:\', city)`, `58958676018405590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">enroll</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'gender:\'</span><span class="token punctuation">,</span> gender<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'city:\'</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有多个默认参数时，调用的时候，既可以按顺序提供默认参数，比如调用 <code class="language-text">enroll(&#39;Bob&#39;, &#39;M&#39;, 7)</code>，意思是，除了 name，gender 这两个参数外，最后 1 个参数应用在参数 age 上，city 参数由于没有提供，仍然使用默认值。</p>\n<p>也可以不按顺序提供部分默认参数。当不按顺序提供部分默认参数时，需要把参数名写上。比如调用 <code class="language-text">enroll(&#39;Adam&#39;, &#39;M&#39;, city=&#39;Tianjin&#39;)</code>，意思是，city 参数用传进去的值，其他默认参数继续使用默认值。</p>\n<p>默认参数很有用，但使用不当，也会掉坑里。默认参数有个最大的坑，演示如下：</p>\n<p>先定义一个函数，传入一个 list，添加一个 END 再返回：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60147268623499530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add_end(L=[]):\n    L.append(\'END\')\n    return L`, `60147268623499530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add_end</span><span class="token punctuation">(</span>L<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当你正常调用时，结果似乎不错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17841112933392011000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end([1, 2, 3])\n[1, 2, 3, \'END\']\n>>> add_end([\'x\', \'y\', \'z\'])\n[\'x\', \'y\', \'z\', \'END\']`, `17841112933392011000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当你使用默认参数调用时，一开始结果也是对的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17523737088399049000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\']`, `17523737088399049000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是，再次调用 add_end() 时，结果就不对了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2965367527633477600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\', \'END\']\n>>> add_end()\n[\'END\', \'END\', \'END\']`, `2965367527633477600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因解释如下：</p>\n<p>Python 函数在定义的时候，默认参数 L 的值就被计算出来了，即 []，因为默认参数 L 也是一个变量，它指向对象 []，每次调用该函数，如果改变了 L 的内容，则下次调用时，默认参数的内容就变了，不再是函数定义时的 [] 了。</p>\n<blockquote>\n<p>定义默认参数要牢记一点：默认参数必须指向不变对象！</p>\n</blockquote>\n<p>要修改上面的例子，我们可以用 None 这个不变对象来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64064685002097410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add_end(L=None):\n    if L is None:\n        L = []\n    L.append(\'END\')\n    return L`, `64064685002097410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add_end</span><span class="token punctuation">(</span>L<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> L <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，无论调用多少次，都不会有问题：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48881326606810100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\']\n>>> add_end()\n[\'END\']`, `48881326606810100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么要设计 str、None 这样的不变对象呢？因为不变对象一旦创建，对象内部的数据就不能修改，这样就减少了由于修改数据导致的错误。此外，由于对象不变，多任务环境下同时读取对象不需要加锁，同时读一点问题都没有。我们在编写程序时，如果可以设计一个不变对象，那就尽量设计成不变对象。</p>\n<h3 id="可变参数"><a href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可变参数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55966034910639470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def calc(numbers):\n    sum = 0\n    for n in numbers:\n        sum = sum + n * n\n    return sum`, `55966034910639470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n <span class="token operator">*</span> n\n    <span class="token keyword">return</span> <span class="token builtin">sum</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是调用的时候，需要先组装出一个 list 或 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50911376085355454000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc([1, 2, 3])\n14\n>>> calc((1, 3, 5, 7))\n84`, `50911376085355454000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token number">14</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">84</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果利用可变参数，调用函数的方式可以简化成这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35705954265053364000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc(1, 2, 3)\n14\n>>> calc(1, 3, 5, 7)\n84`, `35705954265053364000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token number">14</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n<span class="token number">84</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，我们把函数的参数改为可变参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24573085742534873000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def calc(*numbers):\n    sum = 0\n    for n in numbers:\n        sum = sum + n * n\n    return sum`, `24573085742534873000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token operator">*</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n <span class="token operator">*</span> n\n    <span class="token keyword">return</span> <span class="token builtin">sum</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在函数内部，参数 numbers 接收到的是一个 tuple，因此，函数代码完全不变。但是，调用该函数时，可以传入任意个参数，包括 0 个参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72983308317927850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc(1, 2)\n5\n>>> calc()\n0`, `72983308317927850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果已经有一个 list 或者 tuple，要调用一个可变参数怎么办？可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46899807389668250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> nums = [1, 2, 3]\n>>> calc(nums[0], nums[1], nums[2])\n14`, `46899807389668250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span>nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这种写法当然是可行的，问题是太繁琐，所以 Python 允许你在 list 或 tuple 前面加一个 * 号，把 list 或 tuple 的元素变成可变参数传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16160028169637685000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> nums = [1, 2, 3]\n>>> calc(*nums)\n14`, `16160028169637685000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token operator">*</span>nums<span class="token punctuation">)</span>\n<span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>*nums 表示把 nums 这个 list 的所有元素作为可变参数传进去。这种写法相当有用，而且很常见。</p>\n<h3 id="关键字参数"><a href="#%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关键字参数</h3>\n<p>可变参数允许你传入 0 个或任意个参数，这些可变参数在函数调用时自动组装为一个 tuple。而关键字参数允许你传入 0 个或任意个含参数名的参数，这些关键字参数在函数内部自动组装为一个 dict。请看示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87708521703024410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, **kw):\n    print(\'name:\', name, \'age:\', age, \'other:\', kw)`, `87708521703024410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token string">\'other:\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>函数 person 除了必选参数 name 和 age 外，还接受关键字参数 kw。在调用该函数时，可以只传入必选参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83584429316550590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Michael\', 30)\nname: Michael age: 30 other: {}`, `83584429316550590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Michael age<span class="token punctuation">:</span> <span class="token number">30</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以传入任意个数的关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96807766073835570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Bob\', 35, city=\'Beijing\')\nname: Bob age: 35 other: {\'city\': \'Beijing\'}\n>>> person(\'Adam\', 45, gender=\'M\', job=\'Engineer\')\nname: Adam age: 45 other: {\'gender\': \'M\', \'job\': \'Engineer\'}`, `96807766073835570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Bob age<span class="token punctuation">:</span> <span class="token number">35</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Adam\'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token string">\'M\'</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Adam age<span class="token punctuation">:</span> <span class="token number">45</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'gender\'</span><span class="token punctuation">:</span> <span class="token string">\'M\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键字参数有什么用？它可以扩展函数的功能。比如，在 person 函数里，我们保证能接收到 name 和 age 这两个参数，但是，如果调用者愿意提供更多的参数，我们也能收到。试想你正在做一个用户注册的功能，除了用户名和年龄是必填项外，其他都是可选项，利用关键字参数来定义这个函数就能满足注册的需求。</p>\n<p>和可变参数类似，也可以先组装出一个 dict，然后，把该 dict 转换为关键字参数传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57761305320733310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> extra = {\'city\': \'Beijing\', \'job\': \'Engineer\'}\n>>> person(\'Jack\', 24, city=extra[\'city\'], job=extra[\'job\'])\nname: Jack age: 24 other: {\'city\': \'Beijing\', \'job\': \'Engineer\'}`, `57761305320733310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span>extra<span class="token punctuation">[</span><span class="token string">\'city\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> job<span class="token operator">=</span>extra<span class="token punctuation">[</span><span class="token string">\'job\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Jack age<span class="token punctuation">:</span> <span class="token number">24</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当然，上面复杂的调用可以用简化的写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92760484650798500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> extra = {\'city\': \'Beijing\', \'job\': \'Engineer\'}\n>>> person(\'Jack\', 24, **extra)\nname: Jack age: 24 other: {\'city\': \'Beijing\', \'job\': \'Engineer\'}`, `92760484650798500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token operator">**</span>extra<span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Jack age<span class="token punctuation">:</span> <span class="token number">24</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">**extra</code> 表示把 extra 这个 dict 的所有 key-value 用关键字参数传入到函数的 <code class="language-text">**kw</code> 参数，kw 将获得一个 dict，注意 kw 获得的 dict 是 extra 的一份拷贝，对 kw 的改动不会影响到函数外的 extra。</p>\n<h3 id="命名关键字参数"><a href="#%E5%91%BD%E5%90%8D%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命名关键字参数</h3>\n<p>对于关键字参数，函数的调用者可以传入任意不受限制的关键字参数。至于到底传入了哪些，就需要在函数内部通过 kw 检查。</p>\n<p>仍以 person() 函数为例，我们希望检查是否有 city 和 job 参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50539803102633930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, **kw):\n    if \'city\' in kw:\n        # 有 city 参数\n        pass\n    if \'job\' in kw:\n        # 有 job 参数\n        pass\n    print(\'name:\', name, \'age:\', age, \'other:\', kw)`, `50539803102633930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token string">\'city\'</span> <span class="token keyword">in</span> kw<span class="token punctuation">:</span>\n        <span class="token comment"># 有 city 参数</span>\n        <span class="token keyword">pass</span>\n    <span class="token keyword">if</span> <span class="token string">\'job\'</span> <span class="token keyword">in</span> kw<span class="token punctuation">:</span>\n        <span class="token comment"># 有 job 参数</span>\n        <span class="token keyword">pass</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token string">\'other:\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是调用者仍可以传入不受限制的关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96873242692423700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, city=\'Beijing\', addr=\'Chaoyang\', zipcode=123456)`, `96873242692423700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> addr<span class="token operator">=</span><span class="token string">\'Chaoyang\'</span><span class="token punctuation">,</span> zipcode<span class="token operator">=</span><span class="token number">123456</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果要限制关键字参数的名字，就可以用命名关键字参数，例如，只接收 city 和 job 作为关键字参数。这种方式定义的函数如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57029604527466170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *, city, job):\n    print(name, age, city, job)`, `57029604527466170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和关键字参数 <code class="language-text">**kw</code> 不同，命名关键字参数需要一个特殊分隔符 <code class="language-text">*</code>，<code class="language-text">*</code> 后面的参数被视为命名关键字参数。</p>\n<p>调用方式如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28631451068959166000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, city=\'Beijing\', job=\'Engineer\')\nJack 24 Beijing Engineer`, `28631451068959166000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nJack <span class="token number">24</span> Beijing Engineer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果函数定义中已经有了一个可变参数，后面跟着的命名关键字参数就不再需要一个特殊分隔符 <code class="language-text">*</code> 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52307530519914594000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *args, city, job):\n    print(name, age, args, city, job)`, `52307530519914594000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> args<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>命名关键字参数必须传入参数名，这和位置参数不同。如果没有传入参数名，调用将报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58420571345134805000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, \'Beijing\', \'Engineer\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: person() missing 2 required keyword-only arguments: \'city\' and \'job\'`, `58420571345134805000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> person<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">2</span> required keyword<span class="token operator">-</span>only arguments<span class="token punctuation">:</span> <span class="token string">\'city\'</span> <span class="token keyword">and</span> <span class="token string">\'job\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于调用时缺少参数名 city 和 job，Python 解释器把前两个参数视为位置参数，后两个参数传给 <code class="language-text">*args</code>，但缺少命名关键字参数导致报错。</p>\n<p>命名关键字参数可以有缺省值，从而简化调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51001828738439080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *, city=\'Beijing\', job):\n    print(name, age, city, job)`, `51001828738439080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于命名关键字参数 city 具有默认值，调用时，可不传入 city 参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51519518720434455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, job=\'Engineer\')\nJack 24 Beijing Engineer`, `51519518720434455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nJack <span class="token number">24</span> Beijing Engineer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>使用命名关键字参数时，要特别注意，如果没有可变参数，就必须加一个 <code class="language-text">*</code> 作为特殊分隔符。如果缺少 <code class="language-text">*</code>，Python 解释器将无法识别位置参数和命名关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84876098790658410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, city, job):\n    # 缺少 *，city 和 job 被视为位置参数\n    pass`, `84876098790658410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 缺少 *，city 和 job 被视为位置参数</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="参数组合"><a href="#%E5%8F%82%E6%95%B0%E7%BB%84%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参数组合</h3>\n<p>在 Python 中定义函数，可以用必选参数、默认参数、可变参数、关键字参数和命名关键字参数，这 5 种参数都可以组合使用。但是请注意，参数定义的顺序必须是：必选参数、默认参数、可变参数、命名关键字参数和关键字参数。</p>\n<p>比如定义一个函数，包含上述若干种参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81183201037887210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def f1(a, b, c=0, *args, **kw):\n    print(\'a =\', a, \'b =\', b, \'c =\', c, \'args =\', args, \'kw =\', kw)\n\ndef f2(a, b, c=0, *, d, **kw):\n    print(\'a =\', a, \'b =\', b, \'c =\', c, \'d =\', d, \'kw =\', kw)`, `81183201037887210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'a =\'</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">\'b =\'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">\'c =\'</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">\'args =\'</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token string">\'kw =\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'a =\'</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">\'b =\'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">\'c =\'</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">\'d =\'</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token string">\'kw =\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在函数调用的时候，Python 解释器自动按照参数位置和参数名把对应的参数传进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73458191084903210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f1(1, 2)\na = 1 b = 2 c = 0 args = () kw = {}\n>>> f1(1, 2, c=3)\na = 1 b = 2 c = 3 args = () kw = {}\n>>> f1(1, 2, 3, \'a\', \'b\')\na = 1 b = 2 c = 3 args = (\'a\', \'b\') kw = {}\n>>> f1(1, 2, 3, \'a\', \'b\', x=99)\na = 1 b = 2 c = 3 args = (\'a\', \'b\') kw = {\'x\': 99}\n>>> f2(1, 2, d=99, ext=None)\na = 1 b = 2 c = 0 d = 99 kw = {\'ext\': None}`, `73458191084903210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">0</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">,</span> ext<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">0</span> d <span class="token operator">=</span> <span class="token number">99</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'ext\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最神奇的是通过一个 tuple 和 dict，你也可以调用上述函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2222536667866936800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> args = (1, 2, 3, 4)\n>>> kw = {\'d\': 99, \'x\': \'#\'}\n>>> f1(*args, **kw)\na = 1 b = 2 c = 3 args = (4,) kw = {\'d\': 99, \'x\': \'#\'}\n>>> args = (1, 2, 3)\n>>> kw = {\'d\': 88, \'x\': \'#\'}\n>>> f2(*args, **kw)\na = 1 b = 2 c = 3 d = 88 kw = {\'x\': \'#\'}`, `2222536667866936800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> d <span class="token operator">=</span> <span class="token number">88</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，对于任意函数，都可以通过类似 <code class="language-text">func(*args, **kw)</code> 的形式调用它，无论它的参数是如何定义的。</p>\n<blockquote>\n<p>虽然可以组合多达 5 种参数，但不要同时使用太多的组合，否则函数接口的可理解性很差。</p>\n</blockquote>\n<h3 id="小结"><a href="#%E5%B0%8F%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的函数具有非常灵活的参数形态，既可以实现简单的调用，又可以传入非常复杂的参数。</p>\n<p>默认参数一定要用不可变对象，如果是可变对象，程序运行时会有逻辑错误！</p>\n<p>要注意定义可变参数和关键字参数的语法：</p>\n<ul>\n<li><code class="language-text">*args</code> 是可变参数，args 接收的是一个 tuple；</li>\n<li><code class="language-text">**kw</code> 是关键字参数，kw 接收的是一个 dict。</li>\n</ul>\n<p>以及调用函数时如何传入可变参数和关键字参数的语法：</p>\n<ul>\n<li>可变参数既可以直接传入：<code class="language-text">func(1, 2, 3)</code>，又可以先组装 list 或 tuple，再通过 <code class="language-text">*args</code> 传入：<code class="language-text">func(*(1, 2, 3))</code>；</li>\n<li>关键字参数既可以直接传入：<code class="language-text">func(a=1, b=2)</code>，又可以先组装 dict，再通过 <code class="language-text">**kw</code> 传入：<code class="language-text">func(**{&#39;a&#39;: 1, &#39;b&#39;: 2})</code>。</li>\n</ul>\n<p>使用 <code class="language-text">*args</code> 和 <code class="language-text">**kw</code> 是 Python 的习惯写法，当然也可以用其他参数名，但最好使用习惯用法。</p>\n<p>命名的关键字参数是为了限制调用者可以传入的参数名，同时可以提供默认值。</p>\n<p>定义命名的关键字参数在没有可变参数的情况下不要忘了写分隔符 <code class="language-text">*</code>，否则定义的将是位置参数。</p>\n<h2 id="递归函数"><a href="#%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>递归函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46556256022586260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fact(n):\n    return fact_iter(n, 1)\n\ndef fact_iter(num, product):\n    if num == 1:\n        return product\n    return fact_iter(num - 1, num * product)`, `46556256022586260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fact</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> fact_iter<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">fact_iter</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> product\n    <span class="token keyword">return</span> fact_iter<span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> num <span class="token operator">*</span> product<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，<code class="language-text">return fact_iter(num - 1, num * product)</code> 仅返回递归函数本身，<code class="language-text">num - 1</code> 和 <code class="language-text">num * product</code> 在函数调用前就会被计算，不影响函数调用。</p>\n<p><code class="language-text">fact(5)</code> 对应的 <code class="language-text">fact_iter(5, 1)</code> 的调用如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1375002434431982300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`===> fact_iter(5, 1)\n===> fact_iter(4, 5)\n===> fact_iter(3, 20)\n===> fact_iter(2, 60)\n===> fact_iter(1, 120)\n===> 120`, `1375002434431982300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">120</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>尾递归调用时，如果做了优化，栈不会增长，因此，无论多少次调用也不会导致栈溢出。</p>\n<p>遗憾的是，大多数编程语言没有针对尾递归做优化，Python 解释器也没有做优化，所以，即使把上面的 fact(n) 函数改成尾递归方式，也会导致栈溢出。</p>\n<h3 id="小结-1"><a href="#%E5%B0%8F%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>使用递归函数的优点是逻辑简单清晰，缺点是过深的调用会导致栈溢出。</p>\n<p>针对尾递归优化的语言可以通过尾递归防止栈溢出。尾递归事实上和循环是等价的，没有循环语句的编程语言只能通过尾递归实现循环。</p>\n<p>Python 标准的解释器没有针对尾递归做优化，任何递归函数都存在栈溢出的问题。</p>\n<h1 id="高级特性"><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级特性</h1>\n<h2 id="切片"><a href="#%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切片</h2>\n<p>取一个 list 或 tuple 的部分元素是非常常见的操作。比如，一个 list 如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70687292138417110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Michael\', \'Sarah\', \'Tracy\', \'Bob\', \'Jack\']`, `70687292138417110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>取前 3 个元素，应该怎么做？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45885410540721220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[0:3]\n[\'Michael\', \'Sarah\', \'Tracy\']`, `45885410540721220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果第一个索引是 0，还可以省略：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56050476741599680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:3]\n[\'Michael\', \'Sarah\', \'Tracy\']`, `56050476741599680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以从索引 1 开始，取出 2 个元素出来：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43168900277843570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[1:3]\n[\'Sarah\', \'Tracy\']`, `43168900277843570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>类似的，既然 Python 支持 <code class="language-text">L[-1]</code> 取倒数第一个元素，那么它同样支持倒数切片，试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90347803593169630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[-2:]\n[\'Bob\', \'Jack\']\n>>> L[-2:-1]\n[\'Bob\']`, `90347803593169630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Bob\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>记住倒数第一个元素的索引是 -1。</p>\n<p>切片操作十分有用。我们先创建一个 0-99 的数列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4162926418168311300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = list(range(100))\n>>> L\n[0, 1, 2, 3, ..., 99]`, `4162926418168311300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以通过切片轻松取出某一段数列。比如前 10 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18241954930418559000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:10]\n[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]`, `18241954930418559000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>后 10 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85568717401137020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[-10:]\n[90, 91, 92, 93, 94, 95, 96, 97, 98, 99]`, `85568717401137020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>前 11-20 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99255254081231110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[10:20]\n[10, 11, 12, 13, 14, 15, 16, 17, 18, 19]`, `99255254081231110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>前 10 个数，每两个取一个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46868080922895180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:10:2]\n[0, 2, 4, 6, 8]`, `46868080922895180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>所有数，每 5 个取一个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46388744803446700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[::5]\n[0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95]`, `46388744803446700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>甚至什么都不写，只写 <code class="language-text">[:]</code> 就可以原样复制一个 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82180514264424300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:]\n[0, 1, 2, 3, ..., 99]`, `82180514264424300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>tuple 也是一种 list，唯一区别是 tuple 不可变。因此，tuple 也可以用切片操作，只是操作的结果仍是 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1609179201813515300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> (0, 1, 2, 3, 4, 5)[:3]\n(0, 1, 2)`, `1609179201813515300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>字符串 ‘xxx’ 也可以看成是一种 list，每个元素就是一个字符。因此，字符串也可以用切片操作，只是操作结果仍是字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9220542151321398000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABCDEFG\'[:3]\n\'ABC\'\n>>> \'ABCDEFG\'[::2]\n\'ACEG\'`, `9220542151321398000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABCDEFG\'</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token string">\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABCDEFG\'</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'ACEG\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在很多编程语言中，针对字符串提供了很多各种截取函数（例如，substring），其实目的就是对字符串切片。Python 没有针对字符串的截取函数，只需要切片一个操作就可以完成，非常简单。</p>\n<h2 id="迭代"><a href="#%E8%BF%AD%E4%BB%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>迭代</h2>\n<p>Python 的 for 循环不仅可以用在 list 或 tuple 上，还可以作用在其他可迭代对象上。</p>\n<p>list 这种数据类型虽然有下标，但很多其他数据类型是没有下标的，但是，只要是可迭代对象，无论有无下标，都可以迭代，比如 dict 就可以迭代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4792021795416068000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'a\': 1, \'b\': 2, \'c\': 3}\n>>> for key in d:\n...     print(key)\n...\na\nc\nb`, `4792021795416068000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> key <span class="token keyword">in</span> d<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\na\nc\nb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因为 dict 的存储不是按照 list 的方式顺序排列，所以，迭代出的结果顺序很可能不一样。</p>\n<p>默认情况下，dict 迭代的是 key。如果要迭代 value，可以用 <code class="language-text">for value in d.values()</code>，如果要同时迭代 key 和 value，可以用 <code class="language-text">for k, v in d.items()</code>。</p>\n<p>由于字符串也是可迭代对象，因此，也可以作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57860378544927695000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for ch in \'ABC\':\n...     print(ch)\n...\nA\nB\nC`, `57860378544927695000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> ch <span class="token keyword">in</span> <span class="token string">\'ABC\'</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nA\nB\nC</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，当我们使用 for 循环时，只要作用于一个可迭代对象，for 循环就可以正常运行，而我们不太关心该对象究竟是 list 还是其他数据类型。</p>\n<p>那么，如何判断一个对象是可迭代对象呢？方法是通过 collections.abc 模块的 Iterable 类型判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70388112524983300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterable\n>>> isinstance(\'abc\', Iterable) # str 是否可迭代\nTrue\n>>> isinstance([1,2,3], Iterable) # list 是否可迭代\nTrue\n>>> isinstance(123, Iterable) # 整数是否可迭代\nFalse`, `70388112524983300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># str 是否可迭代</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># list 是否可迭代</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># 整数是否可迭代</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后一个小问题，如果要对 list 实现类似 Java 那样的下标循环怎么办？Python 内置的 enumerate 函数可以把一个 list 变成索引-元素对，这样就可以在 for 循环中同时迭代索引和元素本身：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82631083492636660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for i, value in enumerate([\'A\', \'B\', \'C\']):\n...     print(i, value)\n...\n0 A\n1 B\n2 C`, `82631083492636660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">0</span> A\n<span class="token number">1</span> B\n<span class="token number">2</span> C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的 for 循环里，同时引用了两个变量，在 Python 里是很常见的，比如下面的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29943936445298050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for x, y in [(1, 1), (2, 4), (3, 9)]:\n...     print(x, y)\n...\n1 1\n2 4\n3 9`, `29943936445298050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span> <span class="token number">1</span>\n<span class="token number">2</span> <span class="token number">4</span>\n<span class="token number">3</span> <span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-2"><a href="#%E5%B0%8F%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>任何可迭代对象都可以作用于 for 循环，包括我们自定义的数据类型，只要符合迭代条件，就可以使用 for 循环。</p>\n<h2 id="列表生成式"><a href="#%E5%88%97%E8%A1%A8%E7%94%9F%E6%88%90%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表生成式</h2>\n<p>列表生成式即 List Comprehensions，是 Python 内置的非常简单却强大的可以用来创建 list 的生成式。</p>\n<p>举个例子，要生成 list <code class="language-text">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code> 可以用 <code class="language-text">list(range(1, 11))</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81143132830485330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(range(1, 11))\n[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]`, `81143132830485330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但如果要生成 <code class="language-text">[1x1, 2x2, 3x3, ..., 10x10]</code> 怎么做？方法一是循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91249503051936650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = []\n>>> for x in range(1, 11):\n...    L.append(x * x)\n...\n>>> L\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `91249503051936650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x <span class="token operator">*</span> x<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是循环太繁琐，而列表生成式则可以用一行语句代替循环生成上面的 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77145892634333500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x * x for x in range(1, 11)]\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `77145892634333500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>写列表生成式时，把要生成的元素 <code class="language-text">x * x</code> 放到前面，后面跟 for 循环，就可以把 list 创建出来，十分有用，多写几次，很快就可以熟悉这种语法。</p>\n<p>for 循环后面还可以加上 if 判断，这样我们就可以筛选出仅偶数的平方：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79662055592411220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x * x for x in range(1, 11) if x % 2 == 0]\n[4, 16, 36, 64, 100]`, `79662055592411220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>还可以使用两层循环，可以生成全排列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31632188479038636000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [m + n for m in \'ABC\' for n in \'XYZ\']\n[\'AX\', \'AY\', \'AZ\', \'BX\', \'BY\', \'BZ\', \'CX\', \'CY\', \'CZ\']`, `31632188479038636000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>m <span class="token operator">+</span> n <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token string">\'ABC\'</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token string">\'XYZ\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'AX\'</span><span class="token punctuation">,</span> <span class="token string">\'AY\'</span><span class="token punctuation">,</span> <span class="token string">\'AZ\'</span><span class="token punctuation">,</span> <span class="token string">\'BX\'</span><span class="token punctuation">,</span> <span class="token string">\'BY\'</span><span class="token punctuation">,</span> <span class="token string">\'BZ\'</span><span class="token punctuation">,</span> <span class="token string">\'CX\'</span><span class="token punctuation">,</span> <span class="token string">\'CY\'</span><span class="token punctuation">,</span> <span class="token string">\'CZ\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>三层和三层以上的循环就很少用到了。</p>\n<p>运用列表生成式，可以写出非常简洁的代码。例如，列出当前目录下的所有文件和目录名，可以通过一行代码实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32978222718926275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import os # 导入 os 模块，模块的概念后面讲到\n>>> [d for d in os.listdir(\'.\')] # os.listdir 可以列出文件和目录\n[\'.emacs.d\', \'.ssh\', \'.Trash\', \'Adlm\', \'Applications\', \'Desktop\', \'Documents\', \'Downloads\', \'Library\', \'Movies\', \'Music\', \'Pictures\', \'Public\', \'VirtualBox VMs\', \'Workspace\', \'XCode\']`, `32978222718926275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os <span class="token comment"># 导入 os 模块，模块的概念后面讲到</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># os.listdir 可以列出文件和目录</span>\n<span class="token punctuation">[</span><span class="token string">\'.emacs.d\'</span><span class="token punctuation">,</span> <span class="token string">\'.ssh\'</span><span class="token punctuation">,</span> <span class="token string">\'.Trash\'</span><span class="token punctuation">,</span> <span class="token string">\'Adlm\'</span><span class="token punctuation">,</span> <span class="token string">\'Applications\'</span><span class="token punctuation">,</span> <span class="token string">\'Desktop\'</span><span class="token punctuation">,</span> <span class="token string">\'Documents\'</span><span class="token punctuation">,</span> <span class="token string">\'Downloads\'</span><span class="token punctuation">,</span> <span class="token string">\'Library\'</span><span class="token punctuation">,</span> <span class="token string">\'Movies\'</span><span class="token punctuation">,</span> <span class="token string">\'Music\'</span><span class="token punctuation">,</span> <span class="token string">\'Pictures\'</span><span class="token punctuation">,</span> <span class="token string">\'Public\'</span><span class="token punctuation">,</span> <span class="token string">\'VirtualBox VMs\'</span><span class="token punctuation">,</span> <span class="token string">\'Workspace\'</span><span class="token punctuation">,</span> <span class="token string">\'XCode\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>for 循环其实可以同时使用两个甚至多个变量，比如 dict 的 items() 可以同时迭代 key 和 value：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49596923230660050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'x\': \'A\', \'y\': \'B\', \'z\': \'C\' }\n>>> for k, v in d.items():\n...     print(k, \'=\', v)\n...\ny = B\nx = A\nz = C`, `49596923230660050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">:</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">:</span> <span class="token string">\'C\'</span> <span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">\'=\'</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\ny <span class="token operator">=</span> B\nx <span class="token operator">=</span> A\nz <span class="token operator">=</span> C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此，列表生成式也可以使用两个变量来生成 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40257593890187440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'x\': \'A\', \'y\': \'B\', \'z\': \'C\' }\n>>> [k + \'=\' + v for k, v in d.items()]\n[\'y=B\', \'x=A\', \'z=C\']`, `40257593890187440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">:</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">:</span> <span class="token string">\'C\'</span> <span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token string">\'=\'</span> <span class="token operator">+</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'y=B\'</span><span class="token punctuation">,</span> <span class="token string">\'x=A\'</span><span class="token punctuation">,</span> <span class="token string">\'z=C\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>最后把一个 list 中所有的字符串变成小写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78501011276938670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Hello\', \'World\', \'IBM\', \'Apple\']\n>>> [s.lower() for s in L]\n[\'hello\', \'world\', \'ibm\', \'apple\']`, `78501011276938670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token string">\'World\'</span><span class="token punctuation">,</span> <span class="token string">\'IBM\'</span><span class="token punctuation">,</span> <span class="token string">\'Apple\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> L<span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'world\'</span><span class="token punctuation">,</span> <span class="token string">\'ibm\'</span><span class="token punctuation">,</span> <span class="token string">\'apple\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在一个列表生成式中，for 前面的 <code class="language-text">if ... else</code> 是表达式，而 for 后面的 if 是过滤条件，不能带 else。</p>\n<p>即以下 2 种形式是错误的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63270011418075600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in range(1, 11) if x % 2 == 0 else 0]\n  File &quot;<stdin>&quot;, line 1\n    [x for x in range(1, 11) if x % 2 == 0 else 0]\n                                              ^\nSyntaxError: invalid syntax`, `63270011418075600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">]</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span>\n    <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">]</span>\n                                              <span class="token operator">^</span>\nSyntaxError<span class="token punctuation">:</span> invalid syntax</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68110756829705850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x if x % 2 == 0 for x in range(1, 11)]\n  File &quot;<stdin>&quot;, line 1\n    [x if x % 2 == 0 for x in range(1, 11)]\n                       ^\nSyntaxError: invalid syntax`, `68110756829705850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span>\n    <span class="token punctuation">[</span>x <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n                       <span class="token operator">^</span>\nSyntaxError<span class="token punctuation">:</span> invalid syntax</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="生成器"><a href="#%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器</h2>\n<p>在 Python 中一边循环一边计算的机制，称为生成器：generator。</p>\n<p>要创建一个 generator，有很多种方法。第一种方法很简单，只要把一个列表生成式的 [] 改成 ()，就创建了一个 generator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39022193083288980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [x * x for x in range(10)]\n>>> L\n[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]\n>>> g = (x * x for x in range(10))\n>>> g\n<generator object <genexpr> at 0x1022ef630>`, `39022193083288980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x1022ef630</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建 L 和 g 的区别仅在于最外层的 [] 和 ()，L 是一个 list，而 g 是一个 generator。</p>\n<p>我们可以直接打印出 list 的每一个元素，但我们怎么打印出 generator 的每一个元素呢？</p>\n<p>如果要一个一个打印出来，可以通过 next() 函数获得 generator 的下一个返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91939557146304460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> next(g)\n0\n>>> next(g)\n1\n>>> next(g)\n4\n>>> next(g)\n9\n>>> next(g)\n16\n>>> next(g)\n25\n>>> next(g)\n36\n>>> next(g)\n49\n>>> next(g)\n64\n>>> next(g)\n81\n>>> next(g)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nStopIteration`, `91939557146304460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">0</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">4</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">16</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">25</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">36</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">49</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">64</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">81</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nStopIteration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们讲过，generator 保存的是算法，每次调用 next(g)，就计算出 g 的下一个元素的值，直到计算到最后一个元素，没有更多的元素时，抛出 StopIteration 的错误。</p>\n<p>当然，上面这种不断调用 next(g) 实在是太变态了，正确的方法是使用 for 循环，因为 generator 也是可迭代对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6536977474559480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = (x * x for x in range(10))\n>>> for n in g:\n...     print(n)\n...\n0\n1\n4\n9\n16\n25\n36\n49\n64\n81`, `6536977474559480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> g<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">0</span>\n<span class="token number">1</span>\n<span class="token number">4</span>\n<span class="token number">9</span>\n<span class="token number">16</span>\n<span class="token number">25</span>\n<span class="token number">36</span>\n<span class="token number">49</span>\n<span class="token number">64</span>\n<span class="token number">81</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，我们创建了一个 generator 后，基本上永远不会调用 next()，而是通过 for 循环来迭代它，并且不需要关心 StopIteration 的错误。</p>\n<p>generator 非常强大。如果推算的算法比较复杂，用类似列表生成式的 for 循环无法实现的时候，还可以用函数来实现。</p>\n<p>比如，著名的斐波拉契数列（Fibonacci），除第一个和第二个数外，任意一个数都可由前两个数相加得到：</p>\n<p>1, 1, 2, 3, 5, 8, 13, 21, 34, …</p>\n<p>斐波拉契数列用列表生成式写不出来，但是，用函数把它打印出来却很容易：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98597634516467800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fib(max):\n    n, a, b = 0, 0, 1\n    while n < max:\n        print(b)\n        a, b = b, a + b\n        n = n + 1\n    return \'done\'`, `98597634516467800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> <span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，赋值语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26992210317587583000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a, b = b, a + b`, `26992210317587583000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相当于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86558514275897070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`t = (b, a + b) # t 是一个 tuple\na = t[0]\nb = t[1]`, `86558514275897070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">t <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token comment"># t 是一个 tuple</span>\na <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但不必显式写出临时变量 t 就可以赋值。</p>\n<p>上面的函数可以输出斐波那契数列的前 N 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83759464298726470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> fib(6)\n1\n1\n2\n3\n5\n8\n\'done\'`, `83759464298726470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token number">8</span>\n<span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>仔细观察，可以看出，fib 函数实际上是定义了斐波拉契数列的推算规则，可以从第一个元素开始，推算出后续任意的元素，这种逻辑其实非常类似 generator。</p>\n<p>也就是说，上面的函数和 generator 仅一步之遥。要把 fib 函数变成 generator 函数，只需要把 print(b) 改为 yield b 就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11140268746478266000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fib(max):\n    n, a, b = 0, 0, 1\n    while n < max:\n        yield b\n        a, b = b, a + b\n        n = n + 1\n    return \'done\'`, `11140268746478266000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> b\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> <span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这就是定义 generator 的另一种方法。如果一个函数定义中包含 yield 关键字，那么这个函数就不再是一个普通函数，而是一个 generator 函数，调用一个 generator 函数将返回一个 generator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19387270082955887000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = fib(6)\n>>> f\n<generator object fib at 0x104feaaa0>`, `19387270082955887000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> fib at <span class="token number">0x104feaaa0</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里，最难理解的就是 generator 函数和普通函数的执行流程不一样。普通函数是顺序执行，遇到 return 语句或者最后一行函数语句就返回。而变成 generator 的函数，在每次调用 next() 的时候执行，遇到 yield 语句返回，再次执行时从上次返回的 yield 语句处继续执行。</p>\n<p>举个简单的例子，定义一个 generator 函数，依次返回数字 1，3，5：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82283076686997320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def odd():\n    print(\'step 1\')\n    yield 1\n    print(\'step 2\')\n    yield(3)\n    print(\'step 3\')\n    yield(5)`, `82283076686997320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 3\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用该 generator 函数时，首先要生成一个 generator 对象，然后用 next() 函数不断获得下一个返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51137076197675246000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> o = odd()\n>>> next(o)\nstep 1\n1\n>>> next(o)\nstep 2\n3\n>>> next(o)\nstep 3\n5\n>>> next(o)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nStopIteration`, `51137076197675246000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> o <span class="token operator">=</span> odd<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nStopIteration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，odd 不是普通函数，而是 generator 函数，在执行过程中，遇到 yield 就中断，下次又继续执行。执行 3 次 yield 后，已经没有 yield 可以执行了，所以，第 4 次调用 <code class="language-text">next(o)</code> 就报错。</p>\n<blockquote>\n<p>请务必注意：调用 generator 函数会创建一个 generator 对象，多次调用 generator 函数会创建多个相互独立的 generator。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44509401904550720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> next(odd())\nstep 1\n1\n>>> next(odd())\nstep 1\n1\n>>> next(odd())\nstep 1\n1`, `44509401904550720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因在于 odd() 会创建一个新的 generator 对象，上述代码实际上创建了 3 个完全独立的 generator，对 3 个 generator 分别调用 next() 当然每个都会返回第一个值。</p>\n<p>正确的写法是创建一个 generator 对象，然后不断对这一个 generator 对象调用 next()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8272720606074846000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = odd()\n>>> next(g)\nstep 1\n1\n>>> next(g)\nstep 2\n3\n>>> next(g)\nstep 3\n5`, `8272720606074846000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> odd<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">3</span>\n<span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>回到 fib 的例子，我们在循环过程中不断调用 yield，就会不断中断。当然要给循环设置一个条件来退出循环，不然就会产生一个无限数列出来。</p>\n<p>同样的，把函数改成 generator 函数后，我们基本上从来不会用 next() 来获取下一个返回值，而是直接使用 for 循环来迭代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48305514995483750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for n in fib(6):\n...     print(n)\n...\n1\n1\n2\n3\n5\n8`, `48305514995483750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token number">8</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是用 for 循环调用 generator 时，发现拿不到 generator 的 return 语句的返回值。如果想要拿到返回值，必须捕获 StopIteration 错误，返回值包含在 StopIteration 的 value 中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13713261005426047000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = fib(6)\n>>> while True:\n...     try:\n...         x = next(g)\n...         print(\'g:\', x)\n...     except StopIteration as e:\n...         print(\'Generator return value:\', e.value)\n...         break\n...\ng: 1\ng: 1\ng: 2\ng: 3\ng: 5\ng: 8\nGenerator return value: done`, `13713261005426047000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">try</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         x <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'g:\'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Generator return value:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">break</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\ng<span class="token punctuation">:</span> <span class="token number">1</span>\ng<span class="token punctuation">:</span> <span class="token number">1</span>\ng<span class="token punctuation">:</span> <span class="token number">2</span>\ng<span class="token punctuation">:</span> <span class="token number">3</span>\ng<span class="token punctuation">:</span> <span class="token number">5</span>\ng<span class="token punctuation">:</span> <span class="token number">8</span>\nGenerator <span class="token keyword">return</span> value<span class="token punctuation">:</span> done</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于如何捕获错误，后面的错误处理还会详细讲解。</p>\n<h3 id="小结-3"><a href="#%E5%B0%8F%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>generator 是非常强大的工具，在 Python 中，可以简单地把列表生成式改成 generator，也可以通过函数实现复杂逻辑的 generator。</p>\n<p>要理解 generator 的工作原理，它是在 for 循环的过程中不断计算出下一个元素，并在适当的条件结束 for 循环。对于函数改成的 generator 来说，遇到 return 语句或者执行到函数体最后一行语句，就是结束 generator 的指令，for 循环随之结束。</p>\n<p>请注意区分普通函数和 generator 函数，普通函数调用直接返回结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45646097736968020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = abs(6)\n>>> r\n6`, `45646097736968020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> r\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>generator 函数的调用实际返回一个 generator 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32947754887531500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = fib(6)\n>>> g\n<generator object fib at 0x1022ef948>`, `32947754887531500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> fib at <span class="token number">0x1022ef948</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="迭代器"><a href="#%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>迭代器</h2>\n<p>我们已经知道，可以直接作用于 for 循环的数据类型有以下几种：</p>\n<p>一类是集合数据类型，如 list、tuple、dict、set、str 等；</p>\n<p>一类是 generator，包括生成器和带 yield 的 generator function。</p>\n<p>这些可以直接作用于 for 循环的对象统称为可迭代对象：Iterable。</p>\n<p>可以使用 isinstance() 判断一个对象是否是 Iterable 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9615073029953081000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterable\n>>> isinstance([], Iterable)\nTrue\n>>> isinstance({}, Iterable)\nTrue\n>>> isinstance(\'abc\', Iterable)\nTrue\n>>> isinstance((x for x in range(10)), Iterable)\nTrue\n>>> isinstance(100, Iterable)\nFalse`, `9615073029953081000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而生成器不但可以作用于 for 循环，还可以被 next() 函数不断调用并返回下一个值，直到最后抛出 StopIteration 错误表示无法继续返回下一个值了。</p>\n<p>可以被 next() 函数调用并不断返回下一个值的对象称为迭代器：Iterator。</p>\n<p>可以使用 isinstance() 判断一个对象是否是 Iterator 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82334757096022200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterator\n>>> isinstance((x for x in range(10)), Iterator)\nTrue\n>>> isinstance([], Iterator)\nFalse\n>>> isinstance({}, Iterator)\nFalse\n>>> isinstance(\'abc\', Iterator)\nFalse`, `82334757096022200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterator\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成器都是 Iterator 对象，但 list、dict、str 虽然是 Iterable，却不是 Iterator。</p>\n<p>把 list、dict、str 等 Iterable 变成 Iterator 可以使用 iter() 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68049215305394090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(iter([]), Iterator)\nTrue\n>>> isinstance(iter(\'abc\'), Iterator)\nTrue`, `68049215305394090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能会问，为什么 list、dict、str 等数据类型不是 Iterator？</p>\n<p>这是因为 Python 的 Iterator 对象表示的是一个数据流，Iterator 对象可以被 next() 函数调用并不断返回下一个数据，直到没有数据时抛出 StopIteration 错误。可以把这个数据流看做是一个有序序列，但我们却不能提前知道序列的长度，只能不断通过 next() 函数实现按需计算下一个数据，所以 Iterator 的计算是惰性的，只有在需要返回下一个数据时它才会计算。</p>\n<p>Iterator 甚至可以表示一个无限大的数据流，例如全体自然数。而使用 list 是永远不可能存储全体自然数的。</p>\n<h3 id="小结-4"><a href="#%E5%B0%8F%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>凡是可作用于 for 循环的对象都是 Iterable 类型；</p>\n<p>凡是可作用于 next() 函数的对象都是 Iterator 类型，它们表示一个惰性计算的序列；</p>\n<p>集合数据类型如 list、dict、str 等是 Iterable 但不是 Iterator，不过可以通过 iter() 函数获得一个 Iterator 对象。</p>\n<p>Python 的 for 循环本质上就是通过不断调用 next() 函数实现的，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62582422991578210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for x in [1, 2, 3, 4, 5]:\n    pass`, `62582422991578210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>实际上完全等价于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29310866118058353000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 首先获得 Iterator 对象:\nit = iter([1, 2, 3, 4, 5])\n# 循环:\nwhile True:\n    try:\n        # 获得下一个值:\n        x = next(it)\n    except StopIteration:\n        # 遇到 StopIteration 就退出循环\n        break`, `29310866118058353000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 首先获得 Iterator 对象:</span>\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># 循环:</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token comment"># 获得下一个值:</span>\n        x <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n        <span class="token comment"># 遇到 StopIteration 就退出循环</span>\n        <span class="token keyword">break</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="函数式编程"><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数式编程</h1>\n<h2 id="高阶函数"><a href="#%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高阶函数</h2>\n<h3 id="变量可以指向函数"><a href="#%E5%8F%98%E9%87%8F%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%90%91%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量可以指向函数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48863274885050290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = abs\n>>> f(-10)\n10`, `48863274885050290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">abs</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>\n<span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="函数名也是变量"><a href="#%E5%87%BD%E6%95%B0%E5%90%8D%E4%B9%9F%E6%98%AF%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数名也是变量</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97920205766271600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> abs = 10\n>>> abs(-10)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: \'int\' object is not callable`, `97920205766271600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span> <span class="token operator">=</span> <span class="token number">10</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'int\'</span> <span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token builtin">callable</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>由于 abs 函数实际上是定义在 <code class="language-text">import builtins</code> 模块中的，所以要让修改 abs 变量的指向在其它模块也生效，要用 <code class="language-text">import builtins; builtins.abs = 10</code>。</p>\n</blockquote>\n<h3 id="传入函数"><a href="#%E4%BC%A0%E5%85%A5%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入函数</h3>\n<p>一个函数就可以接收另一个函数作为参数，这种函数就称之为高阶函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28270067975560350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add(x, y, f):\n    return f(x) + f(y)\n\nprint(add(-5, 6, abs))`, `28270067975560350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> f<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>add<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">abs</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="map"><a href="#map" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>map</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11182052783356334000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def f(x):\n...     return x * x\n...\n>>> r = map(f, [1, 2, 3, 4, 5, 6, 7, 8, 9])\n>>> list(r)\n[1, 4, 9, 16, 25, 36, 49, 64, 81]\n>>> list(map(str, [1, 2, 3, 4, 5, 6, 7, 8, 9]))\n[\'1\', \'2\', \'3\', \'4\', \'5\', \'6\', \'7\', \'8\', \'9\']`, `11182052783356334000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">*</span> x\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="reduce"><a href="#reduce" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>reduce</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77325604145366830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`reduce(f, [x1, x2, x3, x4]) = f(f(f(x1, x2), x3), x4)`, `77325604145366830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">reduce</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x4<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> x4<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35248013786881958000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import reduce\n\nDIGITS = {\'0\': 0, \'1\': 1, \'2\': 2, \'3\': 3, \'4\': 4, \'5\': 5, \'6\': 6, \'7\': 7, \'8\': 8, \'9\': 9}\n\ndef str2int(s):\n    def fn(x, y):\n        return x * 10 + y\n    def char2num(s):\n        return DIGITS[s]\n    return reduce(fn, map(char2num, s))`, `35248013786881958000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>\n\nDIGITS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y\n    <span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以用 lambda 函数进一步简化成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82922741593637390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import reduce\n\nDIGITS = {\'0\': 0, \'1\': 1, \'2\': 2, \'3\': 3, \'4\': 4, \'5\': 5, \'6\': 6, \'7\': 7, \'8\': 8, \'9\': 9}\n\ndef char2num(s):\n    return DIGITS[s]\n\ndef str2int(s):\n    return reduce(lambda x, y: x * 10 + y, map(char2num, s))`, `82922741593637390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>\n\nDIGITS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span>\n\n<span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="filter"><a href="#filter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>filter</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51331389384578040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def is_odd(n):\n    return n % 2 == 1\n\nlist(filter(is_odd, [1, 2, 4, 5, 6, 9, 10, 15]))\n# 结果: [1, 5, 9, 15]`, `51331389384578040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">is_odd</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span>\n\n<span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_odd<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment"># 结果: [1, 5, 9, 15]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 filter() 函数返回的是一个 Iterator，也就是一个惰性序列，所以要强迫 filter() 完成计算结果，需要用 list() 函数获得所有结果并返回 list。</p>\n<h4 id="用-filter-求素数"><a href="#%E7%94%A8-filter-%E6%B1%82%E7%B4%A0%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 filter 求素数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16533821766588353000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _odd_iter():\n    n = 1\n    while True:\n        n = n + 2\n        yield n\n\ndef _not_divisible(n):\n    # def _can_be_devided(x):\n    #    return x % n > 0\n    return lambda x: x % n > 0\n\ndef primes():\n    yield 2\n    it = _odd_iter() # 初始序列\n    while True:\n        n = next(it) # 返回序列的第一个数\n        yield n\n        it = filter(_not_divisible(n), it) # 构造新序列\n\n# 打印 1000 以内的素数:\nfor n in primes():\n    if n < 1000:\n        print(n)\n    else:\n        break`, `16533821766588353000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_odd_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">2</span>\n        <span class="token keyword">yield</span> n\n\n<span class="token keyword">def</span> <span class="token function">_not_divisible</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># def _can_be_devided(x):</span>\n    <span class="token comment">#    return x % n > 0</span>\n    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> n <span class="token operator">></span> <span class="token number">0</span>\n\n<span class="token keyword">def</span> <span class="token function">primes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">2</span>\n    it <span class="token operator">=</span> _odd_iter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 初始序列</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token comment"># 返回序列的第一个数</span>\n        <span class="token keyword">yield</span> n\n        it <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>_not_divisible<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token comment"># 构造新序列</span>\n\n<span class="token comment"># 打印 1000 以内的素数:</span>\n<span class="token keyword">for</span> n <span class="token keyword">in</span> primes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">break</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="sort"><a href="#sort" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sort</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7333484588733352000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sorted([36, 5, -12, 9, -21])\n[-21, -12, 5, 9, 36]\n>>> sorted([36, 5, -12, 9, -21], key=abs) # 自定义排序\n[5, 9, -12, -21, 36]\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\']) # 按照 ASCII 的大小比较\n[\'Credit\', \'Zoo\', \'about\', \'bob\']\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\'], key=str.lower) # 忽略大小写的排序\n[\'about\', \'bob\', \'Credit\', \'Zoo\']\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\'], key=str.lower, reverse=True) # 倒序\n[\'Zoo\', \'Credit\', \'bob\', \'about\']`, `7333484588733352000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">abs</span><span class="token punctuation">)</span> <span class="token comment"># 自定义排序</span>\n<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 按照 ASCII 的大小比较</span>\n<span class="token punctuation">[</span><span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">)</span> <span class="token comment"># 忽略大小写的排序</span>\n<span class="token punctuation">[</span><span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 倒序</span>\n<span class="token punctuation">[</span><span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="返回函数"><a href="#%E8%BF%94%E5%9B%9E%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回函数</h2>\n<h3 id="函数作为返回值"><a href="#%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数作为返回值</h3>\n<p>高阶函数除了可以接受函数作为参数外，还可以把函数作为结果值返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7928786813763611000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def lazy_sum(*args):\n    def sum():\n        ax = 0\n        for n in args:\n            ax = ax + n\n        return ax\n    return sum\n\n>>> f = lazy_sum(1, 3, 5, 7, 9)\n>>> f\n<function lazy_sum.<locals>.sum at 0x101c6ed90>\n>>> f()\n25`, `7928786813763611000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">lazy_sum</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ax <span class="token operator">=</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> n <span class="token keyword">in</span> args<span class="token punctuation">:</span>\n            ax <span class="token operator">=</span> ax <span class="token operator">+</span> n\n        <span class="token keyword">return</span> ax\n    <span class="token keyword">return</span> <span class="token builtin">sum</span>\n\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>function lazy_sum<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token builtin">sum</span> at <span class="token number">0x101c6ed90</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每次调用都会返回一个新的函数，即使传入相同的参数，f1() 和 f2() 的调用结果互不影响。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77235200523827890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f1 = lazy_sum(1, 3, 5, 7, 9)\n>>> f2 = lazy_sum(1, 3, 5, 7, 9)\n>>> f1==f2\nFalse`, `77235200523827890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f1 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f2 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token operator">==</span>f2\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="闭包"><a href="#%E9%97%AD%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>闭包</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45357677259555110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def count():\n    fs = []\n    for i in range(1, 4):\n        def f():\n             return i*i\n        fs.append(f)\n    return fs\n\nf1, f2, f3 = count()\n\n>>> f1()\n9\n>>> f2()\n9\n>>> f3()\n9`, `45357677259555110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n             <span class="token keyword">return</span> i<span class="token operator">*</span>i\n        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> fs\n\nf1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似于 js，python 也有闭包，解决方式同 js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52084926920157870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def count():\n    def f(j):\n        def g():\n            return j*j\n        return g\n    fs = []\n    for i in range(1, 4):\n        fs.append(f(i)) # f(i) 立刻被执行，因此 i 的当前值被传入 f()\n    return fs\n\n>>> f1, f2, f3 = count()\n>>> f1()\n1\n>>> f2()\n4\n>>> f3()\n9`, `52084926920157870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> j<span class="token operator">*</span>j\n        <span class="token keyword">return</span> g\n    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># f(i) 立刻被执行，因此 i 的当前值被传入 f()</span>\n    <span class="token keyword">return</span> fs\n\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">4</span>\n<span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="nonlocal"><a href="#nonlocal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nonlocal</h3>\n<p>使用闭包，就是内层函数引用了外层函数的局部变量。如果只是读外层变量的值，我们会发现返回的闭包函数调用一切正常：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53090257733195555000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def inc():\n    x = 0\n    def fn():\n        # 仅读取 x 的值:\n        return x + 1\n    return fn\n\nf = inc()\nprint(f()) # 1\nprint(f()) # 1`, `53090257733195555000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 仅读取 x 的值:</span>\n        <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> fn\n\nf <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，如果对外层变量赋值，由于 Python 解释器会把 x 当作函数 fn() 的局部变量，它会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87242473696004060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def inc():\n    x = 0\n    def fn():\n        # nonlocal x # 去掉注释可以正常运行\n        x = x + 1 # 不加 nonlocal，这里会报错，会被当成 fn 的局部变量\n        return x\n    return fn\n\nf = inc()\nprint(f()) # 1\nprint(f()) # 2`, `87242473696004060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># nonlocal x # 去掉注释可以正常运行</span>\n        x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment"># 不加 nonlocal，这里会报错，会被当成 fn 的局部变量</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">return</span> fn\n\nf <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因是 x 作为局部变量并没有初始化，直接计算 x+1 是不行的。但我们其实是想引用 inc() 函数内部的 x，所以需要在 fn() 函数内部加一个 nonlocal x 的声明。加上这个声明后，解释器把 fn() 的 x 看作外层函数的局部变量，它已经被初始化了，可以正确计算 x+1。</p>\n<h2 id="匿名函数"><a href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>匿名函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32548856707732130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(map(lambda x: x * x, [1, 2, 3, 4, 5, 6, 7, 8, 9]))\n[1, 4, 9, 16, 25, 36, 49, 64, 81]`, `32548856707732130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>匿名函数类似于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85880272407180590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def f(x):\n    return x * x`, `85880272407180590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">*</span> x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>匿名函数有个限制，就是只能有一个表达式，不用写 return，返回值就是该表达式的结果。</p>\n<p>用匿名函数有个好处，因为函数没有名字，不必担心函数名冲突。此外，匿名函数也是一个函数对象，也可以把匿名函数赋值给一个变量，再利用变量来调用该函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60281910350485710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = lambda x: x * x\n>>> f\n<function <lambda> at 0x101c6ef28>\n>>> f(5)\n25`, `60281910350485710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> x\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>function <span class="token operator">&lt;</span><span class="token keyword">lambda</span><span class="token operator">></span> at <span class="token number">0x101c6ef28</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样，也可以把匿名函数作为返回值返回，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48818460065799440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def build(x, y):\n    return lambda: x * x + y * y`, `48818460065799440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">build</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="装饰器"><a href="#%E8%A3%85%E9%A5%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>装饰器</h2>\n<p>由于函数也是一个对象，而且函数对象可以被赋值给变量，所以，通过变量也能调用该函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42152672345410120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def now():\n...     print(\'2015-3-25\')\n...\n>>> f = now\n>>> f()\n2015-3-25`, `42152672345410120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> now\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>函数对象有一个 <code class="language-text">__name__</code> 属性，可以拿到函数的名字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13910218731734060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now.__name__\n\'now\'\n>>> f.__name__\n\'now\'`, `13910218731734060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__\n<span class="token string">\'now\'</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__name__\n<span class="token string">\'now\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设我们要增强 now() 函数的功能，比如，在函数调用前后自动打印日志，但又不希望修改 now() 函数的定义，这种在代码运行期间动态增加功能的方式，称之为“装饰器”（Decorator）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12921599803273830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(func):\n    def wrapper(*args, **kw):\n        print(\'call %s():\' % func.__name__)\n        return func(*args, **kw)\n    return wrapper`, `12921599803273830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'call %s():\'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> wrapper</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察上面的 log，因为它是一个 decorator，所以接受一个函数作为参数，并返回一个函数。我们要借助 Python 的 @ 语法，把 decorator 置于函数的定义处：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87006150073026120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@log\ndef now():\n    print(\'2015-3-25\')`, `87006150073026120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@log</span>\n<span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>调用 now() 函数，不仅会运行 now() 函数本身，还会在运行 now() 函数前打印一行日志：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50532451114550340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now()\ncall now():\n2015-3-25`, `50532451114550340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncall now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>把 @log 放到 now() 函数的定义处，相当于执行了语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56409228405909225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`now = log(now)`, `56409228405909225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">now <span class="token operator">=</span> log<span class="token punctuation">(</span>now<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果 decorator 本身需要传入参数，那就需要编写一个返回 decorator 的高阶函数，写出来会更复杂。比如，要自定义 log 的文本：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48749451890313970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(text):\n    def decorator(func):\n        def wrapper(*args, **kw):\n            print(\'%s %s():\' % (text, func.__name__))\n            return func(*args, **kw)\n        return wrapper\n    return decorator`, `48749451890313970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s %s():\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> wrapper\n    <span class="token keyword">return</span> decorator</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 3 层嵌套的 decorator 用法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38183886575994585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@log(\'execute\')\ndef now():\n    print(\'2015-3-25\')\n\n>>> now()\nexecute now():\n2015-3-25`, `38183886575994585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@log</span><span class="token punctuation">(</span><span class="token string">\'execute\'</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>\nexecute now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和两层嵌套的 decorator 相比，3 层嵌套的效果是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93880000169338420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now = log(\'execute\')(now)`, `93880000169338420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now <span class="token operator">=</span> log<span class="token punctuation">(</span><span class="token string">\'execute\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们来剖析上面的语句，首先执行 <code class="language-text">log(&#39;execute&#39;)</code>，返回的是 decorator 函数，再调用返回的函数，参数是 now 函数，返回值最终是 wrapper 函数。</p>\n<p>以上两种 decorator 的定义都没有问题，但还差最后一步。因为我们讲了函数也是对象，它有 <code class="language-text">__name__</code> 等属性，但你去看经过 decorator 装饰之后的函数，它们的 <code class="language-text">__name__</code> 已经从原来的 now 变成了 wrapper：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90647802137926880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now.__name__\n\'wrapper\'`, `90647802137926880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__\n<span class="token string">\'wrapper\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>因为返回的那个 wrapper() 函数名字就是 wrapper，所以，需要把原始函数的 <code class="language-text">__name__</code> 等属性复制到 wrapper() 函数中，否则，有些依赖函数签名的代码执行就会出错。</p>\n<p>不需要编写 <code class="language-text">wrapper.__name__ = func.__name__</code> 这样的代码，Python 内置的 functools.wraps 就是干这个事的，所以，一个完整的 decorator 的写法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69869323941441650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import functools\n\ndef log(func):\n    @functools.wraps(func)\n    def wrapper(*args, **kw):\n        print(\'call %s():\' % func.__name__)\n        return func(*args, **kw)\n    return wrapper`, `69869323941441650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> functools\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @functools<span class="token punctuation">.</span>wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'call %s():\'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> wrapper</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者针对带参数的 decorator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17075727647444693000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import functools\n\ndef log(text):\n    def decorator(func):\n        @functools.wraps(func)\n        def wrapper(*args, **kw):\n            print(\'%s %s():\' % (text, func.__name__))\n            return func(*args, **kw)\n        return wrapper\n    return decorator`, `17075727647444693000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> functools\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        @functools<span class="token punctuation">.</span>wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s %s():\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> wrapper\n    <span class="token keyword">return</span> decorator</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="偏函数"><a href="#%E5%81%8F%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>偏函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92290090559170410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import functools\n>>> int2 = functools.partial(int, base=2)\n>>> int2(\'1000000\')\n64\n>>> int2(\'1010101\')\n85`, `92290090559170410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> functools\n<span class="token operator">>></span><span class="token operator">></span> int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1000000\'</span><span class="token punctuation">)</span>\n<span class="token number">64</span>\n<span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1010101\'</span><span class="token punctuation">)</span>\n<span class="token number">85</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，简单总结 functools.partial 的作用就是，把一个函数的某些参数给固定住（也就是设置默认值），返回一个新的函数，调用这个新函数会更简单。</p>\n<p>注意到上面的新的 int2 函数，仅仅是把 base 参数重新设定默认值为 2，但也可以在函数调用时传入其他值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56808302227412310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int2(\'1000000\', base=10)\n1000000`, `56808302227412310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1000000\'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>\n<span class="token number">1000000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>最后，创建偏函数时，实际上可以接收函数对象、<code class="language-text">*args</code> 和 <code class="language-text">**kw</code> 这 3 个参数，当传入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9667762268514490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int2 = functools.partial(int, base=2)`, `9667762268514490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>实际上固定了 int() 函数的关键字参数 base，也就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88065989022596220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int2(\'10010\')`, `88065989022596220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">int2<span class="token punctuation">(</span><span class="token string">\'10010\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相当于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99569344844806820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kw = { \'base\': 2 }\nint(\'10010\', **kw)`, `99569344844806820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">kw <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'base\'</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>\n<span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'10010\'</span><span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="模块"><a href="#%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块</h1>\n<p>使用模块有什么好处？</p>\n<p>最大的好处是大大提高了代码的可维护性。其次，编写代码不必从零开始。当一个模块编写完毕，就可以被其他地方引用。我们在编写程序的时候，也经常引用其他模块，包括 Python 内置的模块和来自第三方的模块。</p>\n<p>使用模块还可以避免函数名和变量名冲突。相同名字的函数和变量完全可以分别存在不同的模块中，因此，我们自己在编写模块时，不必考虑名字会与其他模块冲突。但是也要注意，尽量不要与内置函数名字冲突。点<a href="https://docs.python.org/3/library/functions.html#built-in-functions" target="_blank" rel="nofollow noreferrer noopener">这里</a>查看 Python 的所有内置函数。</p>\n<p>如果不同的人编写的模块名相同怎么办？为了避免模块名冲突，Python 又引入了按目录来组织模块的方法，称为包（Package）。</p>\n<p>举个例子，一个 abc.py 的文件就是一个名字叫 abc 的模块，一个 xyz.py 的文件就是一个名字叫 xyz 的模块。</p>\n<p>现在，假设我们的 abc 和 xyz 这两个模块名字与其他模块冲突了，于是我们可以通过包来组织模块，避免冲突。方法是选择一个顶层包名，比如 mycompany，按照如下目录存放：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72146790077136510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mycompany\n├─ __init__.py\n├─ abc.py\n└─ xyz.py`, `72146790077136510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">mycompany\n├─ __init__.py\n├─ abc.py\n└─ xyz.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>引入了包以后，只要顶层的包名不与别人冲突，那所有模块都不会与别人冲突。现在，abc.py 模块的名字就变成了 mycompany.abc，类似的，xyz.py 的模块名变成了 mycompany.xyz。</p>\n<p>请注意，每一个包目录下面都会有一个 <code class="language-text">__init__.py</code> 的文件，这个文件是必须存在的，否则，Python 就把这个目录当成普通目录，而不是一个包。<code class="language-text">__init__.py</code> 可以是空文件，也可以有 Python 代码，因为 <code class="language-text">__init__.py</code> 本身就是一个模块，而它的模块名就是 mycompany。</p>\n<p>类似的，可以有多级目录，组成多级层次的包结构。比如如下的目录结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9734122383885113000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mycompany\n ├─ web\n │  ├─ __init__.py\n │  ├─ utils.py\n │  └─ www.py\n ├─ __init__.py\n ├─ abc.py\n └─ utils.py`, `9734122383885113000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">mycompany\n ├─ web\n │  ├─ __init__.py\n │  ├─ utils.py\n │  └─ www.py\n ├─ __init__.py\n ├─ abc.py\n └─ utils.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件 www.py 的模块名就是 mycompany.web.www，两个文件 utils.py 的模块名分别是 mycompany.utils 和 mycompany.web.utils</p>\n<blockquote>\n<p>自己创建模块时要注意命名，不能和 Python 自带的模块名称冲突。例如，系统自带了 sys 模块，自己的模块就不可命名为 sys.py，否则将无法导入系统自带的 sys 模块。</p>\n</blockquote>\n<h2 id="使用模块"><a href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用模块</h2>\n<p>Python 本身就内置了很多非常有用的模块，只要安装完毕，这些模块就可以立刻使用。</p>\n<p>我们以内建的 sys 模块为例，编写一个 hello 的模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67461273794119926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\n\' a test module \'\n\n__author__ = \'Michael Liao\'\n\nimport sys\n\ndef test():\n    args = sys.argv\n    if len(args)==1:\n        print(\'Hello, world!\')\n    elif len(args)==2:\n        print(\'Hello, %s!\' % args[1])\n    else:\n        print(\'Too many arguments!\')\n\nif __name__==\'__main__\':\n    test()`, `67461273794119926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n<span class="token comment"># -*- coding: utf-8 -*-</span>\n\n<span class="token string">\' a test module \'</span>\n\n__author__ <span class="token operator">=</span> <span class="token string">\'Michael Liao\'</span>\n\n<span class="token keyword">import</span> sys\n\n<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    args <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv\n    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s!\'</span> <span class="token operator">%</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Too many arguments!\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    test<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第 1 行和第 2 行是标准注释，第 1 行注释可以让这个 hello.py 文件直接在 Unix/Linux/Mac 上运行，第 2 行注释表示 .py 文件本身使用标准 UTF-8 编码；</p>\n<p>第 4 行是一个字符串，表示模块的文档注释，任何模块代码的第一个字符串都被视为模块的文档注释；</p>\n<p>第 6 行使用 <code class="language-text">__author__</code> 变量把作者写进去，这样当你公开源代码后别人就可以瞻仰你的大名；</p>\n<p>以上就是 Python 模块的标准文件模板，当然也可以全部删掉不写，但是，按标准办事肯定没错。</p>\n<p>后面开始就是真正的代码部分。</p>\n<p>你可能注意到了，使用 sys 模块的第一步，就是导入该模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2802210300583030300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import sys`, `2802210300583030300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> sys</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>导入 sys 模块后，我们就有了变量 sys 指向该模块，利用 sys 这个变量，就可以访问 sys 模块的所有功能。</p>\n<p>sys 模块有一个 argv 变量，用 list 存储了命令行的所有参数。argv 至少有一个元素，因为第一个参数永远是该 .py 文件的名称，例如：</p>\n<p>运行 python3 hello.py 获得的 sys.argv 就是 <code class="language-text">[&#39;hello.py&#39;]</code>；</p>\n<p>运行 python3 hello.py Michael 获得的 sys.argv 就是 <code class="language-text">[&#39;hello.py&#39;, &#39;Michael&#39;]</code>。</p>\n<p>最后，注意到这两行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36691570723555200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if __name__==\'__main__\':\n    test()`, `36691570723555200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    test<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们在命令行运行 hello 模块文件时，Python 解释器把一个特殊变量 <code class="language-text">__name__</code> 置为 <code class="language-text">__main__</code>，而如果在其他地方导入该 hello 模块时，if 判断将失败，因此，这种 if 测试可以让一个模块通过命令行运行时执行一些额外的代码，最常见的就是运行测试。</p>\n<p>我们可以用命令行运行 hello.py 看看效果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24038760179620610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 hello.py\nHello, world!\n\\$ python3 hello.py Michael\nHello, Michael!`, `24038760179620610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 hello.py\nHello, world!\n$ python3 hello.py Michael\nHello, Michael!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果启动 Python 交互环境，再导入 hello 模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80651963508427370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3\nPython 3.4.3 (v3.4.3:9b73f1c3e601, Feb 23 2015, 02:52:03)\n[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n>>> import hello\n>>>`, `80651963508427370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3\nPython 3.4.3 (v3.4.3:9b73f1c3e601, Feb 23 2015, 02:52:03)\n[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n&gt;&gt;&gt; import hello\n&gt;&gt;&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>导入时，没有打印 Hello, word!，因为没有执行 test() 函数。</p>\n<p>调用 hello.test() 时，才能打印出 Hello, word!：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97839658804947270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hello.test()\nHello, world!`, `97839658804947270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> hello<span class="token punctuation">.</span>test<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="作用域"><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作用域</h3>\n<p>在一个模块中，我们可能会定义很多函数和变量，但有的函数和变量我们希望给别人使用，有的函数和变量我们希望仅仅在模块内部使用。在 Python 中，是通过 <code class="language-text">_</code> 前缀来实现的。</p>\n<p>正常的函数和变量名是公开的（public），可以被直接引用，比如：abc，x123，PI 等；</p>\n<p>类似 <code class="language-text">__xxx__</code> 这样的变量是特殊变量，可以被直接引用，但是有特殊用途，比如上面的 <code class="language-text">__author__</code>，<code class="language-text">__name__</code> 就是特殊变量，hello 模块定义的文档注释也可以用特殊变量 <code class="language-text">__doc__</code> 访问，我们自己的变量一般不要用这种变量名；</p>\n<p>类似 <code class="language-text">_xxx</code> 和 <code class="language-text">__xxx</code> 这样的函数或变量就是非公开的（private），不应该被直接引用，比如 <code class="language-text">_abc</code>，<code class="language-text">__abc</code> 等；</p>\n<p>之所以我们说，private 函数和变量“不应该”被直接引用，而不是“不能”被直接引用，是因为 Python 并没有一种方法可以完全限制访问 private 函数或变量，但是，从编程习惯上不应该引用 private 函数或变量。</p>\n<p>private 函数或变量不应该被别人引用，那它们有什么用呢？请看例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27454804256135467000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _private_1(name):\n    return \'Hello, %s\' % name\n\ndef _private_2(name):\n    return \'Hi, %s\' % name\n\ndef greeting(name):\n    if len(name) > 3:\n        return _private_1(name)\n    else:\n        return _private_2(name)`, `27454804256135467000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_private_1</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hello, %s\'</span> <span class="token operator">%</span> name\n\n<span class="token keyword">def</span> <span class="token function">_private_2</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hi, %s\'</span> <span class="token operator">%</span> name\n\n<span class="token keyword">def</span> <span class="token function">greeting</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> _private_1<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> _private_2<span class="token punctuation">(</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在模块里公开 greeting() 函数，而把内部逻辑用 private 函数隐藏起来了，这样，调用 greeting() 函数不用关心内部的 private 函数细节，这也是一种非常有用的代码封装和抽象的方法，即：</p>\n<p>外部不需要引用的函数全部定义成 private，只有外部需要引用的函数才定义为 public。</p>\n<h2 id="安装第三方模块"><a href="#%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装第三方模块</h2>\n<p>安装 Pillow 的命令就是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94080062952476150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pip install Pillow`, `94080062952476150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">pip install Pillow</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="安装常用模块"><a href="#%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装常用模块</h3>\n<p>推荐直接使用 <a href="https://www.anaconda.com/products/distribution" target="_blank" rel="nofollow noreferrer noopener">Anaconda</a>，内置了许多非常有用的第三方库</p>\n<h3 id="模块搜索路径"><a href="#%E6%A8%A1%E5%9D%97%E6%90%9C%E7%B4%A2%E8%B7%AF%E5%BE%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块搜索路径</h3>\n<p>当我们试图加载一个模块时，Python 会在指定的路径下搜索对应的 .py 文件，如果找不到，就会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91859142639257710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import mymodule\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nImportError: No module named mymodule`, `91859142639257710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&gt;&gt;&gt; import mymodule\nTraceback (most recent call last):\n  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;\nImportError: No module named mymodule</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>默认情况下，Python 解释器会搜索当前目录、所有已安装的内置模块和第三方模块，搜索路径存放在 sys 模块的 path 变量中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45163649420986970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.path\n[\'\', \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python36.zip\', \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6\', ..., \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages\']`, `45163649420986970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>path\n<span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python36.zip\'</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果我们要添加自己的搜索目录，有两种方法：</p>\n<ol>\n<li>\n<p>直接修改 sys.path，添加要搜索的目录，但是运行结束后失效。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27258673582070346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.path.append(\'/Users/michael/my_py_scripts\')`, `27258673582070346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'/Users/michael/my_py_scripts\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>设置环境变量 PYTHONPATH，该环境变量的内容会被自动添加到模块搜索路径中。设置方式与设置 Path 环境变量类似。注意只需要添加你自己的搜索路径，Python 自己本身的搜索路径不受影响。</p>\n</li>\n</ol>\n<h1 id="面向对象编程"><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>面向对象编程</h1>\n<p>在 Python 中，所有数据类型都可以视为对象，当然也可以自定义对象。自定义的对象数据类型就是面向对象中的类（Class）的概念。</p>\n<p>我们以一个例子来说明面向过程和面向对象在程序流程上的不同之处。</p>\n<p>假设我们要处理学生的成绩表，为了表示一个学生的成绩，面向过程的程序可以用一个 dict 表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15612773243667677000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`std1 = { \'name\': \'Michael\', \'score\': 98 }\nstd2 = { \'name\': \'Bob\', \'score\': 81 }`, `15612773243667677000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">std1 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">98</span> <span class="token punctuation">}</span>\nstd2 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">81</span> <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>而处理学生成绩可以通过函数实现，比如打印学生的成绩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87472796315958230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def print_score(std):\n    print(\'%s: %s\' % (std[\'name\'], std[\'score\']))`, `87472796315958230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token punctuation">[</span><span class="token string">\'score\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果采用面向对象的程序设计思想，我们首选思考的不是程序的执行流程，而是 Student 这种数据类型应该被视为一个对象，这个对象拥有 name 和 score 这两个属性（Property）。如果要打印一个学生的成绩，首先必须创建出这个学生对应的对象，然后，给对象发一个 print_score 消息，让对象自己把自己的数据打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79988934838992260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.name, self.score))`, `79988934838992260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>给对象发消息实际上就是调用对象对应的关联函数，我们称之为对象的方法（Method）。面向对象的程序写出来就像这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10009316238319354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bart = Student(\'Bart Simpson\', 59)\nlisa = Student(\'Lisa Simpson\', 87)\nbart.print_score()\nlisa.print_score()`, `10009316238319354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\nlisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa Simpson\'</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span>\nbart<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\nlisa<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>数据封装、继承和多态是面向对象的三大特点</p>\n<h2 id="类和实例"><a href="#%E7%B1%BB%E5%92%8C%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类和实例</h2>\n<p>在 Python 中，定义类是通过 class 关键字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74880843429151000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    pass`, `74880843429151000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>class 后面紧接着是类名，即 Student，类名通常是大写开头的单词，紧接着是(object)，表示该类是从哪个类继承下来的，继承的概念我们后面再讲，通常，如果没有合适的继承类，就使用 object 类，这是所有类最终都会继承的类。</p>\n<p>定义好了 Student 类，就可以根据 Student 类创建出 Student 的实例，创建实例是通过 <code class="language-text">类名()</code> 实现的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50314529722975790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student()\n>>> bart\n<__main__.Student object at 0x10a67a590>\n>>> Student\n<class \'__main__.Student\'>`, `50314529722975790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x10a67a590</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> Student\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Student\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，变量 bart 指向的就是一个 Student 的实例，后面的 0x10a67a590 是内存地址，每个 object 的地址都不一样，而 Student 本身则是一个类。</p>\n<p>可以自由地给一个实例变量绑定属性，比如，给实例 bart 绑定一个 name 属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63021744946649825000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.name = \'Bart Simpson\'\n>>> bart.name\n\'Bart Simpson\'`, `63021744946649825000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于类可以起到模板的作用，因此，可以在创建实例的时候，把一些我们认为必须绑定的属性强制填写进去。通过定义一个特殊的 <code class="language-text">__init__</code> 方法，在创建实例的时候，就把 name，score 等属性绑上去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41003855583818410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score`, `41003855583818410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：特殊方法 <code class="language-text">__init__</code> 前后分别有两个下划线！！！</p>\n</blockquote>\n<p>注意到 <code class="language-text">__init__</code> 方法的第一个参数永远是 self，表示创建的实例本身，因此，在 <code class="language-text">__init__</code> 方法内部，就可以把各种属性绑定到 self，因为 self 就指向创建的实例本身。</p>\n<p>有了 <code class="language-text">__init__</code> 方法，在创建实例的时候，就不能传入空的参数了，必须传入与 <code class="language-text">__init__</code> 方法匹配的参数，但 self 不需要传，Python 解释器自己会把实例变量传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48945280300402524000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.name\n\'Bart Simpson\'\n>>> bart.score\n59`, `48945280300402524000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name\n<span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和普通的函数相比，在类中定义的函数只有一点不同，就是第一个参数永远是实例变量 self，并且，调用时，不用传递该参数。除此之外，类的方法和普通函数没有什么区别，所以，你仍然可以用默认参数、可变参数、关键字参数和命名关键字参数。</p>\n<h3 id="数据封装"><a href="#%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据封装</h3>\n<p>面向对象编程的一个重要特点就是数据封装。在上面的 Student 类中，每个实例就拥有各自的 name 和 score 这些数据。我们可以通过函数来访问这些数据，比如打印一个学生的成绩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83000412449318370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def print_score(std):\n...     print(\'%s: %s\' % (std.name, std.score))\n...\n>>> print_score(bart)\nBart Simpson: 59`, `83000412449318370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">.</span>name<span class="token punctuation">,</span> std<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> print_score<span class="token punctuation">(</span>bart<span class="token punctuation">)</span>\nBart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，既然 Student 实例本身就拥有这些数据，要访问这些数据，就没有必要从外面的函数去访问，可以直接在 Student 类的内部定义访问数据的函数，这样，就把“数据”给封装起来了。这些封装数据的函数是和 Student 类本身是关联起来的，我们称之为类的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37080097504911110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.name, self.score))`, `37080097504911110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要定义一个方法，除了第一个参数是 self 外，其他和普通函数一样。要调用一个方法，只需要在实例变量上直接调用，除了 self 不用传递，其他参数正常传入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77172550693521500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.print_score()\nBart Simpson: 59`, `77172550693521500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\nBart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样一来，我们从外部看 Student 类，就只需要知道，创建实例需要给出 name 和 score，而如何打印，都是在 Student 类的内部定义的，这些数据和逻辑被“封装”起来了，调用很容易，但却不用知道内部实现的细节。</p>\n<p>封装的另一个好处是可以给 Student 类增加新的方法，比如 get_grade：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2110611098284520400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def get_grade(self):\n        if self.score >= 90:\n            return \'A\'\n        elif self.score >= 60:\n            return \'B\'\n        else:\n            return \'C\'`, `2110611098284520400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">90</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'A\'</span>\n        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">60</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'B\'</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'C\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，get_grade 方法可以直接在实例变量上调用，不需要知道内部实现细节：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45885416488390020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def get_grade(self):\n        if self.score >= 90:\n            return \'A\'\n        elif self.score >= 60:\n            return \'B\'\n        else:\n            return \'C\'\n\nlisa = Student(\'Lisa\', 99)\nbart = Student(\'Bart\', 59)\nprint(lisa.name, lisa.get_grade()) # Lisa A\nprint(bart.name, bart.get_grade()) # Bart C`, `45885416488390020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">get_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">90</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'A\'</span>\n        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">60</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'B\'</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'C\'</span>\n\nlisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>\nbart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>lisa<span class="token punctuation">.</span>name<span class="token punctuation">,</span> lisa<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Lisa A</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bart<span class="token punctuation">.</span>name<span class="token punctuation">,</span> bart<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Bart C</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-5"><a href="#%E5%B0%8F%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>类是创建实例的模板，而实例则是一个一个具体的对象，各个实例拥有的数据都互相独立，互不影响；</p>\n<p>方法就是与实例绑定的函数，和普通函数不同，方法可以直接访问实例的数据；</p>\n<p>通过在实例上调用方法，我们就直接操作了对象内部的数据，但无需知道方法内部的实现细节。</p>\n<p>和静态语言不同，Python 允许对实例变量绑定任何数据，也就是说，对于两个实例变量，虽然它们都是同一个类的不同实例，但拥有的变量名称都可能不同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8101967504538266000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> lisa = Student(\'Lisa Simpson\', 87)\n>>> bart.age = 8\n>>> bart.age\n8\n>>> lisa.age\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'age\'`, `8101967504538266000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> lisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa Simpson\'</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">8</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age\n<span class="token number">8</span>\n<span class="token operator">>></span><span class="token operator">></span> lisa<span class="token punctuation">.</span>age\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'age\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="访问限制"><a href="#%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问限制</h2>\n<p>在 Class 内部，可以有属性和方法，而外部代码可以通过直接调用实例变量的方法来操作数据，这样，就隐藏了内部的复杂逻辑。</p>\n<p>但是，从前面 Student 类的定义来看，外部代码还是可以自由地修改一个实例的 name、score 属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81083364098765470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.score\n59\n>>> bart.score = 99\n>>> bart.score\n99`, `81083364098765470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">59</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要让内部属性不被外部访问，可以把属性的名称前加上两个下划线 <code class="language-text">__</code>，在 Python 中，实例的变量名如果以 <code class="language-text">__</code> 开头，就变成了一个私有变量（private），只有内部可以访问，外部不能访问，所以，我们把 Student 类改一改：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53370506027104690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.__name = name\n        self.__score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.__name, self.__score))`, `53370506027104690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>__score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>改完后，对于外部代码来说，没什么变动，但是已经无法从外部访问 <code class="language-text">实例变量.__name</code> 和 <code class="language-text">实例变量.__score</code> 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24240677335162597000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.__name\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'__name\'`, `24240677335162597000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'__name\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就确保了外部代码不能随意修改对象内部的状态，这样通过访问限制的保护，代码更加健壮。</p>\n<p>但是如果外部代码要获取 name 和 score 怎么办？可以给 Student 类增加 <code class="language-text">get_name</code> 和 <code class="language-text">get_score</code> 这样的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2763976865242723300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def get_name(self):\n        return self.__name\n\n    def get_score(self):\n        return self.__score`, `2763976865242723300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__name\n\n    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果又要允许外部代码修改 score 怎么办？可以再给 Student 类增加 set_score 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90804849598342510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def set_score(self, score):\n        self.__score = score`, `90804849598342510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你也许会问，原先那种直接通过 bart.score = 99 也可以修改啊，为什么要定义一个方法大费周折？因为在方法中，可以对参数做检查，避免传入无效的参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59493383436859040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def set_score(self, score):\n        if 0 <= score <= 100:\n            self.__score = score\n        else:\n            raise ValueError(\'bad score\')`, `59493383436859040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> score <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'bad score\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>需要注意的是，在 Python 中，变量名类似 <code class="language-text">__xxx__</code> 的，也就是以双下划线开头，并且以双下划线结尾的，是特殊变量，特殊变量是可以直接访问的，不是 private 变量，所以，不能用 <code class="language-text">__name__</code>、 <code class="language-text">__score__</code> 这样的变量名。</p>\n<p>有些时候，你会看到以一个下划线开头的实例变量名，比如 <code class="language-text">_name</code>，这样的实例变量外部是可以访问的，但是，按照约定俗成的规定，当你看到这样的变量时，意思就是，“虽然我可以被访问，但是，请把我视为私有变量，不要随意访问”。</p>\n<p>双下划线开头的实例变量是不是一定不能从外部访问呢？其实也不是。不能直接访问 <code class="language-text">__name</code> 是因为 Python 解释器对外把 <code class="language-text">__name</code> 变量改成了 <code class="language-text">_Student__name</code>，所以，仍然可以通过 <code class="language-text">_Student__name</code> 来访问 <code class="language-text">__name</code> 变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59608224436635830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart._Student__name\n\'Bart Simpson\'`, `59608224436635830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>_Student__name\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是强烈建议你不要这么干，因为不同版本的 Python 解释器可能会把 <code class="language-text">__name</code> 改成不同的变量名。</p>\n<p>总的来说就是，Python 本身没有任何机制阻止你干坏事，一切全靠自觉。</p>\n<p>最后注意下面的这种错误写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84538750292869790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.get_name()\n\'Bart Simpson\'\n>>> bart.__name = \'New Name\' # 设置 __name 变量！\n>>> bart.__name\n\'New Name\'`, `84538750292869790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name <span class="token operator">=</span> <span class="token string">\'New Name\'</span> <span class="token comment"># 设置 __name 变量！</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name\n<span class="token string">\'New Name\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表面上看，外部代码“成功”地设置了 <code class="language-text">__name</code> 变量，但实际上这个 <code class="language-text">__name</code> 变量和 class 内部的 <code class="language-text">__name</code> 变量不是一个变量！内部的 <code class="language-text">__name</code> 变量已经被 Python 解释器自动改成了 <code class="language-text">_Student__name</code>，而外部代码给 bart 新增了一个 <code class="language-text">__name</code> 变量。不信试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47444501168948180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.get_name() # get_name() 内部返回 self.__name\n\'Bart Simpson\'`, `47444501168948180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># get_name() 内部返回 self.__name</span>\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="继承和多态"><a href="#%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>继承和多态</h2>\n<p>在 OOP 程序设计中，当我们定义一个 class 的时候，可以从某个现有的 class 继承，新的 class 称为子类（Subclass），而被继承的 class 称为基类、父类或超类（Base class、Super class）。</p>\n<p>比如，我们已经编写了一个名为 Animal 的 class，有一个 run() 方法可以直接打印：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88370522649788800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Animal(object):\n    def run(self):\n        print(\'Animal is running...\')`, `88370522649788800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Animal is running...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们需要编写 Dog 和 Cat 类时，就可以直接从 Animal 类继承：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24447803990351090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n    pass\n\nclass Cat(Animal):\n    pass`, `24447803990351090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于 Dog 来说，Animal 就是它的父类，对于 Animal 来说，Dog 就是它的子类。Cat 和 Dog 类似。</p>\n<p>继承有什么好处？最大的好处是子类获得了父类的全部功能。由于 Animial 实现了 run() 方法，因此，Dog 和 Cat 作为它的子类，什么事也没干，就自动拥有了 run() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26271583762621330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dog = Dog()\ndog.run()\n\ncat = Cat()\ncat.run()`, `26271583762621330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">dog <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndog<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\ncat <span class="token operator">=</span> Cat<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncat<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94056703111745650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Animal is running...\nAnimal is running...`, `94056703111745650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Animal is running...\nAnimal is running...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，也可以对子类增加一些方法，比如 Dog 类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33123405627389380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n\n    def run(self):\n        print(\'Dog is running...\')\n\n    def eat(self):\n        print(\'Eating meat...\')`, `33123405627389380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Dog is running...\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">eat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Eating meat...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>继承的第二个好处需要我们对代码做一点改进。你看到了，无论是 Dog 还是 Cat，它们 run() 的时候，显示的都是 Animal is running…，符合逻辑的做法是分别显示 Dog is running… 和 Cat is running…，因此，对 Dog 和 Cat 类改进如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36127555880543506000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n\n    def run(self):\n        print(\'Dog is running...\')\n\nclass Cat(Animal):\n\n    def run(self):\n        print(\'Cat is running...\')`, `36127555880543506000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Dog is running...\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Cat is running...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再次运行，结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="811348416938351100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Dog is running...\nCat is running...`, `811348416938351100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Dog is running...\nCat is running...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当子类和父类都存在相同的 run() 方法时，我们说，子类的 run() 覆盖了父类的 run()，在代码运行的时候，总是会调用子类的 run()。这样，我们就获得了继承的另一个好处：多态。</p>\n<p>要理解什么是多态，我们首先要对数据类型再作一点说明。当我们定义一个 class 的时候，我们实际上就定义了一种数据类型。我们定义的数据类型和 Python 自带的数据类型，比如 str、list、dict 没什么两样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10160166637539580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = list() # a 是 list 类型\nb = Animal() # b 是 Animal 类型\nc = Dog() # c 是 Dog 类型`, `10160166637539580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># a 是 list 类型</span>\nb <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># b 是 Animal 类型</span>\nc <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># c 是 Dog 类型</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>判断一个变量是否是某个类型可以用 isinstance() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48916368549936930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(a, list)\nTrue\n>>> isinstance(b, Animal)\nTrue\n>>> isinstance(c, Dog)\nTrue`, `48916368549936930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看来 a、b、c 确实对应着 list、Animal、Dog 这 3 种类型。</p>\n<p>但是等等，试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51697276558750335000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(c, Animal)\nTrue`, `51697276558750335000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>看来 c 不仅仅是 Dog，c 还是 Animal！</p>\n<p>不过仔细想想，这是有道理的，因为 Dog 是从 Animal 继承下来的，当我们创建了一个 Dog 的实例 c 时，我们认为 c 的数据类型是 Dog 没错，但 c 同时也是 Animal 也没错，Dog 本来就是 Animal 的一种！</p>\n<p>所以，在继承关系中，如果一个实例的数据类型是某个子类，那它的数据类型也可以被看做是父类。但是，反过来就不行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43264250723638020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b = Animal()\n>>> isinstance(b, Dog)\nFalse`, `43264250723638020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Dog 可以看成 Animal，但 Animal 不可以看成 Dog。</p>\n<p>要理解多态的好处，我们还需要再编写一个函数，这个函数接受一个 Animal 类型的变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94497917011211530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def run_twice(animal):\n    animal.run()\n    animal.run()`, `94497917011211530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">run_twice</span><span class="token punctuation">(</span>animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Animal 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35058821883574720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Animal())\nAnimal is running...\nAnimal is running...`, `35058821883574720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Animal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nAnimal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAnimal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Dog 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20961182565521752000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Dog())\nDog is running...\nDog is running...`, `20961182565521752000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Dog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nDog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nDog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Cat 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7356063391511203000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Cat())\nCat is running...\nCat is running...`, `7356063391511203000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Cat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nCat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nCat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>看上去没啥意思，但是仔细想想，现在，如果我们再定义一个 Tortoise 类型，也从 Animal 派生：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45911945793954456000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tortoise(Animal):\n    def run(self):\n        print(\'Tortoise is running slowly...\')`, `45911945793954456000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tortoise</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tortoise is running slowly...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们调用 run_twice() 时，传入 Tortoise 的实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89522081639556350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Tortoise())\nTortoise is running slowly...\nTortoise is running slowly...`, `89522081639556350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Tortoise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nTortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你会发现，新增一个 Animal 的子类，不必对 run_twice() 做任何修改，实际上，任何依赖 Animal 作为参数的函数或者方法都可以不加修改地正常运行，原因就在于多态。</p>\n<p>多态的好处就是，当我们需要传入 Dog、Cat、Tortoise…… 时，我们只需要接收 Animal 类型就可以了，因为 Dog、Cat、Tortoise…… 都是 Animal 类型，然后，按照 Animal 类型进行操作即可。由于 Animal 类型有 run() 方法，因此，传入的任意类型，只要是 Animal 类或者子类，就会自动调用实际类型的 run() 方法，这就是多态的意思：</p>\n<p>对于一个变量，我们只需要知道它是 Animal 类型，无需确切地知道它的子类型，就可以放心地调用 run() 方法，而具体调用的 run() 方法是作用在 Animal、Dog、Cat 还是 Tortoise 对象上，由运行时该对象的确切类型决定，这就是多态真正的威力：调用方只管调用，不管细节，而当我们新增一种 Animal 的子类时，只要确保 run() 方法编写正确，不用管原来的代码是如何调用的。这就是著名的“开闭”原则：</p>\n<ul>\n<li>对扩展开放：允许新增 Animal 子类；</li>\n<li>对修改封闭：不需要修改依赖 Animal 类型的 run_twice() 等函数。</li>\n</ul>\n<p>继承还可以一级一级地继承下来，就好比从爷爷到爸爸、再到儿子这样的关系。而任何类，最终都可以追溯到根类 object，这些继承关系看上去就像一颗倒着的树。</p>\n<h3 id="静态语言-vs-动态语言"><a href="#%E9%9D%99%E6%80%81%E8%AF%AD%E8%A8%80-vs-%E5%8A%A8%E6%80%81%E8%AF%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态语言 vs 动态语言</h3>\n<p>对于静态语言（例如 Java）来说，如果需要传入 Animal 类型，则传入的对象必须是 Animal 类型或者它的子类，否则，将无法调用 run() 方法。</p>\n<p>对于 Python 这样的动态语言来说，则不一定需要传入 Animal 类型。我们只需要保证传入的对象有一个 run() 方法就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63410625542666350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Timer(object):\n    def run(self):\n        print(\'Start...\')`, `63410625542666350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Start...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这就是动态语言的“鸭子类型”，它并不要求严格的继承体系，一个对象只要“看起来像鸭子，走起路来像鸭子”，那它就可以被看做是鸭子。</p>\n<p>Python 的 <code class="language-text">file-like object</code> 就是一种鸭子类型。对真正的文件对象，它有一个 read() 方法，返回其内容。但是，许多对象，只要有 read() 方法，都被视为“file-like object“。许多函数接收的参数就是 <code class="language-text">file-like object</code>，你不一定要传入真正的文件对象，完全可以传入任何实现了 read() 方法的对象。</p>\n<h3 id="小结-6"><a href="#%E5%B0%8F%E7%BB%93-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>继承可以把父类的所有功能都直接拿过来，这样就不必重零做起，子类只需要新增自己特有的方法，也可以把父类不适合的方法覆盖重写。</p>\n<p>动态语言的鸭子类型特点决定了继承不像静态语言那样是必须的。</p>\n<h2 id="获取对象信息"><a href="#%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取对象信息</h2>\n<h3 id="使用-type"><a href="#%E4%BD%BF%E7%94%A8-type" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 type()</h3>\n<p>首先，我们来判断对象类型，使用 type() 函数：</p>\n<p>基本类型都可以用 type() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16529531230093330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(123)\n<class \'int\'>\n>>> type(\'str\')\n<class \'str\'>\n>>> type(None)\n<type(None) \'NoneType\'>`, `16529531230093330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'int\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'str\'</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'str\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token string">\'NoneType\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果一个变量指向函数或者类，也可以用 type() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19964085893038887000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(abs)\n<class \'builtin_function_or_method\'>\n>>> type(a)\n<class \'__main__.Animal\'>`, `19964085893038887000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'builtin_function_or_method\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Animal\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 type() 函数返回的是什么类型呢？它返回对应的 Class 类型。如果我们要在 if 语句中判断，就需要比较两个变量的 type 类型是否相同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89751316568548160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(123)==type(456)\nTrue\n>>> type(123)==int\nTrue\n>>> type(\'abc\')==type(\'123\')\nTrue\n>>> type(\'abc\')==str\nTrue\n>>> type(\'abc\')==type(123)\nFalse`, `89751316568548160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">456</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">int</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'123\'</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">str</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>判断基本数据类型可以直接写 int，str 等，但如果要判断一个对象是否是函数怎么办？可以使用 types 模块中定义的常量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1052760102841832100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import types\n>>> def fn():\n...     pass\n...\n>>> type(fn)==types.FunctionType\nTrue\n>>> type(abs)==types.BuiltinFunctionType\nTrue\n>>> type(lambda x: x)==types.LambdaType\nTrue\n>>> type((x for x in range(10)))==types.GeneratorType\nTrue`, `1052760102841832100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> types\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">pass</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>FunctionType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>BuiltinFunctionType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>LambdaType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>GeneratorType\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用-isinstance"><a href="#%E4%BD%BF%E7%94%A8-isinstance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 isinstance()</h3>\n<p>对于 class 的继承关系来说，使用 type() 就很不方便。我们要判断 class 的类型，可以使用 isinstance() 函数。</p>\n<p>我们回顾上次的例子，如果继承关系是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99709535812725440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`object -> Animal -> Dog -> Husky`, `99709535812725440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">object -&gt; Animal -&gt; Dog -&gt; Husky</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那么，isinstance() 就可以告诉我们，一个对象是否是某种类型。先创建 3 种类型的对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6469177068887633000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = Animal()\n>>> d = Dog()\n>>> h = Husky()`, `6469177068887633000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Husky<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36613077664328507000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Husky)\nTrue`, `36613077664328507000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Husky<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>没有问题，因为 h 变量指向的就是 Husky 对象。</p>\n<p>再判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1977321653507768600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Dog)\nTrue`, `1977321653507768600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>h 虽然自身是 Husky 类型，但由于 Husky 是从 Dog 继承下来的，所以，h 也还是 Dog 类型。换句话说，isinstance() 判断的是一个对象是否是该类型本身，或者位于该类型的父继承链上。</p>\n<p>因此，我们可以确信，h 还是 Animal 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97730694284575330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Animal)\nTrue`, `97730694284575330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>同理，实际类型是 Dog 的 d 也是 Animal 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70008185528744680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(d, Dog) and isinstance(d, Animal)\nTrue`, `70008185528744680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是，d 不是 Husky 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56927977243320420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(d, Husky)\nFalse`, `56927977243320420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Husky<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>能用 type() 判断的基本类型也可以用 isinstance() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89024114452488000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(\'a\', str)\nTrue\n>>> isinstance(123, int)\nTrue\n>>> isinstance(b\'a\', bytes)\nTrue`, `89024114452488000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">b\'a\'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且还可以判断一个变量是否是某些类型中的一种，比如下面的代码就可以判断是否是 list 或者 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72606996981764450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance([1, 2, 3], (list, tuple))\nTrue\n>>> isinstance((1, 2, 3), (list, tuple))\nTrue`, `72606996981764450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>总是优先使用 isinstance() 判断类型，可以将指定类型及其子类“一网打尽”。</p>\n</blockquote>\n<h3 id="使用-dir"><a href="#%E4%BD%BF%E7%94%A8-dir" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 dir()</h3>\n<p>如果要获得一个对象的所有属性和方法，可以使用 dir() 函数，它返回一个包含字符串的 list，比如，获得一个 str 对象的所有属性和方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35939318052358550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> dir(\'ABC\')\n[\'__add__\', \'__class__\',..., \'__subclasshook__\', \'capitalize\', \'casefold\',..., \'zfill\']`, `35939318052358550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'__add__\'</span><span class="token punctuation">,</span> <span class="token string">\'__class__\'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'__subclasshook__\'</span><span class="token punctuation">,</span> <span class="token string">\'capitalize\'</span><span class="token punctuation">,</span> <span class="token string">\'casefold\'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'zfill\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>类似 <code class="language-text">__xxx__</code> 的属性和方法在 Python 中都是有特殊用途的，比如 <code class="language-text">__len__</code> 方法返回长度。在 Python 中，如果你调用 len() 函数试图获取一个对象的长度，实际上，在 len() 函数内部，它自动去调用该对象的 <code class="language-text">__len__()</code> 方法，所以，下面的代码是等价的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26082749919873516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(\'ABC\')\n3\n>>> \'ABC\'.__len__()\n3`, `26082749919873516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>__len__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们自己写的类，如果也想用 len(myObj) 的话，就自己写一个 <code class="language-text">__len__()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20728620385317732000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class MyDog(object):\n...     def __len__(self):\n...         return 100\n...\n>>> dog = MyDog()\n>>> len(dog)\n100`, `20728620385317732000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyDog</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token number">100</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> dog <span class="token operator">=</span> MyDog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span>\n<span class="token number">100</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>剩下的都是普通属性或方法，比如 lower() 返回小写的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53659512710473310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABC\'.lower()\n\'abc\'`, `53659512710473310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>仅仅把属性和方法列出来是不够的，配合 getattr()、setattr() 以及 hasattr()，我们可以直接操作一个对象的状态：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22380795072380023000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class MyObject(object):\n...     def __init__(self):\n...         self.x = 9\n...     def power(self):\n...         return self.x * self.x\n...\n>>> obj = MyObject()`, `22380795072380023000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">9</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">power</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self<span class="token punctuation">.</span>x <span class="token operator">*</span> self<span class="token punctuation">.</span>x\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> obj <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>紧接着，可以测试该对象的属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79011491768137480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hasattr(obj, \'x\') # 有属性 \'x\' 吗？\nTrue\n>>> obj.x\n9\n>>> hasattr(obj, \'y\') # 有属性 \'y\' 吗？\nFalse\n>>> setattr(obj, \'y\', 19) # 设置一个属性 \'y\'\n>>> hasattr(obj, \'y\') # 有属性 \'y\' 吗？\nTrue\n>>> getattr(obj, \'y\') # 获取属性 \'y\'\n19\n>>> obj.y # 获取属性 \'y\'\n19`, `79011491768137480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'x\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>x\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'y\' 吗？</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">setattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span> <span class="token comment"># 设置一个属性 \'y\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'y\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'y\'</span>\n<span class="token number">19</span>\n<span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>y <span class="token comment"># 获取属性 \'y\'</span>\n<span class="token number">19</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果试图获取不存在的属性，会抛出 AttributeError 的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1564186415878765600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> getattr(obj, \'z\') # 获取属性 \'z\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'MyObject\' object has no attribute \'z\'`, `1564186415878765600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'z\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'z\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以传入一个 default 参数，如果属性不存在，就返回默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89245681944273270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> getattr(obj, \'z\', 404) # 获取属性 \'z\'，如果不存在，返回默认值 404\n404`, `89245681944273270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'z\'，如果不存在，返回默认值 404</span>\n<span class="token number">404</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以获得对象的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10777380654210011000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hasattr(obj, \'power\') # 有属性 \'power\' 吗？\nTrue\n>>> getattr(obj, \'power\') # 获取属性 \'power\'\n<bound method MyObject.power of <__main__.MyObject object at 0x10077a6a0>>\n>>> fn = getattr(obj, \'power\') # 获取属性 \'power\' 并赋值到变量 fn\n>>> fn # fn 指向 obj.power\n<bound method MyObject.power of <__main__.MyObject object at 0x10077a6a0>>\n>>> fn() # 调用 fn() 与调用 obj.power() 是一样的\n81`, `10777380654210011000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'power\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'power\'</span>\n<span class="token operator">&lt;</span>bound method MyObject<span class="token punctuation">.</span>power of <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>MyObject <span class="token builtin">object</span> at <span class="token number">0x10077a6a0</span><span class="token operator">>></span>\n<span class="token operator">>></span><span class="token operator">></span> fn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'power\' 并赋值到变量 fn</span>\n<span class="token operator">>></span><span class="token operator">></span> fn <span class="token comment"># fn 指向 obj.power</span>\n<span class="token operator">&lt;</span>bound method MyObject<span class="token punctuation">.</span>power of <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>MyObject <span class="token builtin">object</span> at <span class="token number">0x10077a6a0</span><span class="token operator">>></span>\n<span class="token operator">>></span><span class="token operator">></span> fn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用 fn() 与调用 obj.power() 是一样的</span>\n<span class="token number">81</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-7"><a href="#%E5%B0%8F%E7%BB%93-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>通过内置的一系列函数，我们可以对任意一个 Python 对象进行剖析，拿到其内部的数据。要注意的是，只有在不知道对象信息的时候，我们才会去获取对象信息。如果可以直接写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="770165837192360300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = obj.x + obj.y`, `770165837192360300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>x <span class="token operator">+</span> obj<span class="token punctuation">.</span>y</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就不要写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16301032782551284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = getattr(obj, \'x\') + getattr(obj, \'y\')`, `16301032782551284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>一个正确的用法的例子如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79208989410487350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def readImage(fp):\n    if hasattr(fp, \'read\'):\n        return readData(fp)\n    return None`, `79208989410487350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">readImage</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">\'read\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> readData<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设我们希望从文件流 fp 中读取图像，我们首先要判断该 fp 对象是否存在 read 方法，如果存在，则该对象是一个流，如果不存在，则无法读取。hasattr() 就派上了用场。</p>\n<p>请注意，在 Python 这类动态语言中，根据鸭子类型，有 read() 方法，不代表该 fp 对象就是一个文件流，它也可能是网络流，也可能是内存中的一个字节流，但只要 read() 方法返回的是有效的图像数据，就不影响读取图像的功能。</p>\n<h2 id="实例属性和类属性"><a href="#%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7%E5%92%8C%E7%B1%BB%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实例属性和类属性</h2>\n<p>由于 Python 是动态语言，根据类创建的实例可以任意绑定属性。</p>\n<p>给实例绑定属性的方法是通过实例变量，或者通过 self 变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11458867765472713000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n\ns = Student(\'Bob\')\ns.score = 90`, `11458867765472713000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n\ns <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">)</span>\ns<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">90</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，如果 Student 类本身需要绑定一个属性呢？可以直接在 class 中定义属性，这种属性是类属性，归 Student 类所有：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30992484234702890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    name = \'Student\'`, `30992484234702890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">\'Student\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们定义了一个类属性后，这个属性虽然归类所有，但类的所有实例都可以访问到。来测试一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51306286987240645000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     name = \'Student\'\n...\n>>> s = Student() # 创建实例 s\n>>> print(s.name) # 打印 name 属性，因为实例并没有 name 属性，所以会继续查找 class 的 name 属性\nStudent\n>>> print(Student.name) # 打印类的 name 属性\nStudent\n>>> s.name = \'Michael\' # 给实例绑定 name 属性\n>>> print(s.name) # 由于实例属性优先级比类属性高，因此，它会屏蔽掉类的 name 属性\nMichael\n>>> print(Student.name) # 但是类属性并未消失，用 Student.name 仍然可以访问\nStudent\n>>> del s.name # 如果删除实例的 name 属性\n>>> print(s.name) # 再次调用 s.name，由于实例的 name 属性没有找到，类的 name 属性就显示出来了\nStudent`, `51306286987240645000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     name <span class="token operator">=</span> <span class="token string">\'Student\'</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建实例 s</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 打印 name 属性，因为实例并没有 name 属性，所以会继续查找 class 的 name 属性</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 打印类的 name 属性</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 给实例绑定 name 属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 由于实例属性优先级比类属性高，因此，它会屏蔽掉类的 name 属性</span>\nMichael\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 但是类属性并未消失，用 Student.name 仍然可以访问</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> s<span class="token punctuation">.</span>name <span class="token comment"># 如果删除实例的 name 属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 再次调用 s.name，由于实例的 name 属性没有找到，类的 name 属性就显示出来了</span>\nStudent</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从上面的例子可以看出，在编写程序的时候，千万不要对实例属性和类属性使用相同的名字，因为相同名称的实例属性将屏蔽掉类属性，但是当你删除实例属性后，再使用相同的名称，访问到的将是类属性。</p>\n<h3 id="小结-8"><a href="#%E5%B0%8F%E7%BB%93-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>实例属性属于各个实例所有，互不干扰；</p>\n<p>类属性属于类所有，所有实例共享一个属性；</p>\n<p>不要对实例属性和类属性使用相同的名字，否则将产生难以发现的错误。</p>\n<h1 id="面向对象高级编程"><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>面向对象高级编程</h1>\n<h2 id="使用-__slots__"><a href="#%E4%BD%BF%E7%94%A8-__slots__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 <code class="language-text">__slots__</code></h2>\n<p>正常情况下，当我们定义了一个 class，创建了一个 class 的实例后，我们可以给该实例绑定任何属性和方法，这就是动态语言的灵活性。先定义 class：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43177148615035350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    pass`, `43177148615035350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后，尝试给实例绑定一个属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73233465312634100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.name = \'Michael\' # 动态给实例绑定一个属性\n>>> print(s.name)\nMichael`, `73233465312634100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 动态给实例绑定一个属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nMichael</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以尝试给实例绑定一个方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71366853824558785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def set_age(self, age): # 定义一个函数作为实例方法\n...     self.age = age\n...\n>>> from types import MethodType\n>>> s.set_age = MethodType(set_age, s) # 给实例绑定一个方法, 第二个参数作为 self 传入方法\n>>> s.set_age(25) # 调用实例方法\n>>> s.age # 测试结果\n25`, `71366853824558785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_age</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 定义一个函数作为实例方法</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> types <span class="token keyword">import</span> MethodType\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment"># 给实例绑定一个方法, 第二个参数作为 self 传入方法</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 调用实例方法</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token comment"># 测试结果</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，给一个实例绑定的方法，对另一个实例是不起作用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91400051843407430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s2 = Student() # 创建新的实例\n>>> s2.set_age(25) # 尝试调用方法\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'set_age\'`, `91400051843407430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 尝试调用方法</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'set_age\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了给所有实例都绑定方法，可以给 class 绑定方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16952168596391614000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def set_score(self, score):\n...     self.score = score\n...\n>>> Student.set_score = set_score`, `16952168596391614000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> Student<span class="token punctuation">.</span>set_score <span class="token operator">=</span> set_score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>给 class 绑定方法后，所有实例均可调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53147808325885280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.set_score(100)\n>>> s.score\n100\n>>> s2.set_score(99)\n>>> s2.score\n99`, `53147808325885280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score\n<span class="token number">100</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通常情况下，上面的 set_score 方法可以直接定义在 class 中，但动态绑定允许我们在程序运行的过程中动态给 class 加上功能，这在静态语言中很难实现。</p>\n<h3 id="使用-__slots__-1"><a href="#%E4%BD%BF%E7%94%A8-__slots__-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 <code class="language-text">__slots__</code></h3>\n<p>但是，如果我们想要限制实例的属性怎么办？比如，只允许对 Student 实例添加 name 和 age 属性。</p>\n<p>为了达到限制的目的，Python 允许在定义 class 的时候，定义一个特殊的 <code class="language-text">__slots__</code> 变量，来限制该 class 实例能添加的属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60557600748626170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    __slots__ = (\'name\', \'age\') # 用 tuple 定义允许绑定的属性名称`, `60557600748626170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">)</span> <span class="token comment"># 用 tuple 定义允许绑定的属性名称</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后，我们试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41336480996774960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student() # 创建新的实例\n>>> s.name = \'Michael\' # 绑定属性 \'name\'\n>>> s.age = 25 # 绑定属性 \'age\'\n>>> s.score = 99 # 绑定属性 \'score\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'score\'`, `41336480996774960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 绑定属性 \'name\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span> <span class="token comment"># 绑定属性 \'age\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span> <span class="token comment"># 绑定属性 \'score\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'score\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 score 没有被放到 <code class="language-text">__slots__</code> 中，所以不能绑定 score 属性，试图绑定 score 将得到 AttributeError 的错误。</p>\n<p>使用 <code class="language-text">__slots__</code> 要注意，<code class="language-text">__slots__</code> 定义的属性仅对当前类实例起作用，对继承的子类是不起作用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39703528293853995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class GraduateStudent(Student):\n...     pass\n...\n>>> g = GraduateStudent()\n>>> g.score = 9999`, `39703528293853995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">GraduateStudent</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">pass</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> GraduateStudent<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除非在子类中也定义 <code class="language-text">__slots__</code>，这样，子类实例允许定义的属性就是自身的 <code class="language-text">__slots__</code> 加上父类的 <code class="language-text">__slots__</code>。</p>\n<h2 id="使用-property"><a href="#%E4%BD%BF%E7%94%A8-property" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 @property</h2>\n<p>在绑定属性时，如果我们直接把属性暴露出去，虽然写起来很简单，但是，没办法检查参数，导致可以把成绩随便改：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60516945770068435000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = Student()\ns.score = 9999`, `60516945770068435000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\ns<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这显然不合逻辑。为了限制 score 的范围，可以通过一个 <code class="language-text">set_score()</code> 方法来设置成绩，再通过一个 <code class="language-text">get_score()</code> 来获取成绩，这样，在 set_score() 方法里，就可以检查参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3631840400360531000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def get_score(self):\n         return self._score\n\n    def set_score(self, value):\n        if not isinstance(value, int):\n            raise ValueError(\'score must be an integer!\')\n        if value < 0 or value > 100:\n            raise ValueError(\'score must between 0 ~ 100!\')\n        self._score = value`, `3631840400360531000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n         <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must be an integer!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must between 0 ~ 100!\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，对任意的 Student 实例进行操作，就不能随心所欲地设置 score 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76544661698798260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.set_score(60) # ok!\n>>> s.get_score()\n60\n>>> s.set_score(9999)\nTraceback (most recent call last):\n  ...\nValueError: score must between 0 ~ 100!`, `76544661698798260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment"># ok!</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>get_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">60</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，上面的调用方法又略显复杂，没有直接用属性这么直接简单。</p>\n<p>有没有既能检查参数，又可以用类似属性这样简单的方式来访问类的变量呢？对于追求完美的 Python 程序员来说，这是必须要做到的！</p>\n<p>还记得装饰器（decorator）可以给函数动态加上功能吗？对于类的方法，装饰器一样起作用。Python 内置的 @property 装饰器就是负责把一个方法变成属性调用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55538211175960895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    @property\n    def score(self):\n        return self._score\n\n    @score.setter\n    def score(self, value):\n        if not isinstance(value, int):\n            raise ValueError(\'score must be an integer!\')\n        if value < 0 or value > 100:\n            raise ValueError(\'score must between 0 ~ 100!\')\n        self._score = value`, `55538211175960895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score\n\n    @score<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must be an integer!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must between 0 ~ 100!\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>@property 的实现比较复杂，我们先考察如何使用。把一个 getter 方法变成属性，只需要加上 @property 就可以了，此时，@property 本身又创建了另一个装饰器 @score.setter，负责把一个 setter 方法变成属性赋值，于是，我们就拥有一个可控的属性操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73927319568111350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.score = 60 # OK，实际转化为 s.set_score(60)\n>>> s.score # OK，实际转化为 s.get_score()\n60\n>>> s.score = 9999\nTraceback (most recent call last):\n  ...\nValueError: score must between 0 ~ 100!`, `73927319568111350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">60</span> <span class="token comment"># OK，实际转化为 s.set_score(60)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token comment"># OK，实际转化为 s.get_score()</span>\n<span class="token number">60</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到这个神奇的 @property，我们在对实例属性操作的时候，就知道该属性很可能不是直接暴露的，而是通过 getter 和 setter 方法来实现的。</p>\n<p>还可以定义只读属性，只定义 getter 方法，不定义 setter 方法就是一个只读属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15879905821397400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    @property\n    def birth(self):\n        return self._birth\n\n    @birth.setter\n    def birth(self, value):\n        self._birth = value\n\n    @property\n    def age(self):\n        return 2015 - self._birth`, `15879905821397400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_birth\n\n    @birth<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_birth <span class="token operator">=</span> value\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">age</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token number">2015</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>_birth</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的 birth 是可读写属性，而 age 就是一个只读属性，因为 age 可以根据 birth 和当前时间计算出来。</p>\n<p>要特别注意：属性的方法名不要和实例变量重名。例如，以下的代码是错误的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42072546643131850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    # 方法名称和实例变量均为 birth:\n    @property\n    def birth(self):\n        return self.birth`, `42072546643131850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token comment"># 方法名称和实例变量均为 birth:</span>\n    <span class="token decorator annotation punctuation">@property</span>\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>birth</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是因为调用 s.birth 时，首先转换为方法调用，在执行 return self.birth 时，又视为访问 self 的属性，于是又转换为方法调用，造成无限递归，最终导致栈溢出报错 RecursionError。</p>\n<h3 id="小结-9"><a href="#%E5%B0%8F%E7%BB%93-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>@property 广泛应用在类的定义中，可以让调用者写出简短的代码，同时保证对参数进行必要的检查，这样，程序运行时就减少了出错的可能性。</p>\n<h2 id="多重继承"><a href="#%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多重继承</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20689582456048350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Animal(object):\n    pass\n\n# 大类:\nclass Mammal(Animal):\n    pass\n\nclass Bird(Animal):\n    pass\n\n# 各种动物:\nclass Dog(Mammal):\n    pass\n\nclass Bat(Mammal):\n    pass\n\nclass Parrot(Bird):\n    pass\n\nclass Ostrich(Bird):\n    pass`, `20689582456048350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 大类:</span>\n<span class="token keyword">class</span> <span class="token class-name">Mammal</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Bird</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 各种动物:</span>\n<span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Bat</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Parrot</span><span class="token punctuation">(</span>Bird<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Ostrich</span><span class="token punctuation">(</span>Bird<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们要给动物再加上 Runnable 和 Flyable 的功能，只需要先定义好 Runnable 和 Flyable 的类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15016920233900177000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Runnable(object):\n    def run(self):\n        print(\'Running...\')\n\nclass Flyable(object):\n    def fly(self):\n        print(\'Flying...\')`, `15016920233900177000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Running...\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Flyable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">fly</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Flying...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于需要 Runnable 功能的动物，就多继承一个 Runnable，例如 Dog：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91789769552044210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Mammal, Runnable):\n    pass`, `91789769552044210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> Runnable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>对于需要 Flyable 功能的动物，就多继承一个 Flyable，例如 Bat：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1155516525808764200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Bat(Mammal, Flyable):\n    pass`, `1155516525808764200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Bat</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> Flyable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>通过多重继承，一个子类就可以同时获得多个父类的所有功能。</p>\n<h3 id="mixin"><a href="#mixin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MixIn</h3>\n<p>在设计类的继承关系时，通常，主线都是单一继承下来的，例如，Ostrich 继承自 Bird。但是，如果需要“混入”额外的功能，通过多重继承就可以实现，比如，让 Ostrich 除了继承自 Bird 外，再同时继承 Runnable。这种设计通常称之为 MixIn。</p>\n<p>为了更好地看出继承关系，我们把 Runnable 和 Flyable 改为 RunnableMixIn 和 FlyableMixIn。类似的，你还可以定义出肉食动物 CarnivorousMixIn 和植食动物 HerbivoresMixIn，让某个动物同时拥有好几个 MixIn：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90017571430217500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Mammal, RunnableMixIn, CarnivorousMixIn):\n    pass`, `90017571430217500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> RunnableMixIn<span class="token punctuation">,</span> CarnivorousMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>MixIn 的目的就是给一个类增加多个功能，这样，在设计类的时候，我们优先考虑通过多重继承来组合多个 MixIn 的功能，而不是设计多层次的复杂的继承关系。</p>\n<p>Python 自带的很多库也使用了 MixIn。举个例子，Python 自带了 TCPServer 和 UDPServer 这两类网络服务，而要同时服务多个用户就必须使用多进程或多线程模型，这两种模型由 ForkingMixIn 和 ThreadingMixIn 提供。通过组合，我们就可以创造出合适的服务来。</p>\n<p>比如，编写一个多进程模式的 TCP 服务，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54130072015120240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyTCPServer(TCPServer, ForkingMixIn):\n    pass`, `54130072015120240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyTCPServer</span><span class="token punctuation">(</span>TCPServer<span class="token punctuation">,</span> ForkingMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>编写一个多线程模式的 UDP 服务，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5171592218201604000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyUDPServer(UDPServer, ThreadingMixIn):\n    pass`, `5171592218201604000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyUDPServer</span><span class="token punctuation">(</span>UDPServer<span class="token punctuation">,</span> ThreadingMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你打算搞一个更先进的协程模型，可以编写一个 CoroutineMixIn：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85591110687498200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyTCPServer(TCPServer, CoroutineMixIn):\n    pass`, `85591110687498200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyTCPServer</span><span class="token punctuation">(</span>TCPServer<span class="token punctuation">,</span> CoroutineMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样一来，我们不需要复杂而庞大的继承链，只要选择组合不同的类的功能，就可以快速构造出所需的子类。</p>\n<h3 id="小结-10"><a href="#%E5%B0%8F%E7%BB%93-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>由于 Python 允许使用多重继承，因此，MixIn 就是一种常见的设计。</p>\n<p>只允许单一继承的语言（如 Java）不能使用 MixIn 的设计。</p>\n<h2 id="定制类"><a href="#%E5%AE%9A%E5%88%B6%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定制类</h2>\n<p>看到类似 <code class="language-text">__slots__</code> 这种形如 <code class="language-text">__xxx__</code> 的变量或者函数名就要注意，这些在 Python 中是有特殊用途的。</p>\n<p><code class="language-text">__slots__</code> 我们已经知道怎么用了，<code class="language-text">__len__()</code> 方法我们也知道是为了能让 class 作用于 len() 函数。</p>\n<p>除此之外，Python 的 class 中还有许多这样有特殊用途的函数，可以帮助我们定制类。</p>\n<h3 id="__str__"><a href="#__str__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__str__</code></h3>\n<p>我们先定义一个 Student 类，打印一个实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85670853311697760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     def __init__(self, name):\n...         self.name = name\n...\n>>> print(Student(\'Michael\'))\n<__main__.Student object at 0x109afb190>`, `85670853311697760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb190</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>打印出一堆 <code class="language-text">&lt;__main__.Student object at 0x109afb190&gt;</code>，不好看。</p>\n<p>怎么才能打印得好看呢？只需要定义好 <code class="language-text">__str__()</code> 方法，返回一个好看的字符串就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73441192756277670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     def __init__(self, name):\n...         self.name = name\n...     def __str__(self):\n...         return \'Student object (name: %s)\' % self.name\n...\n>>> print(Student(\'Michael\'))\nStudent object (name: Michael)`, `73441192756277670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token string">\'Student object (name: %s)\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nStudent <span class="token builtin">object</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> Michael<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样打印出来的实例，不但好看，而且容易看出实例内部重要的数据。</p>\n<p>但是细心的朋友会发现直接敲变量不用 print，打印出来的实例还是不好看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10943881105645060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student(\'Michael\')\n>>> s\n<__main__.Student object at 0x109afb310>`, `10943881105645060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb310</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是因为直接显示变量调用的不是 <code class="language-text">__str__()</code>，而是 <code class="language-text">__repr__()</code>，两者的区别是 <code class="language-text">__str__()</code> 返回用户看到的字符串，而 <code class="language-text">__repr__()</code> 返回程序开发者看到的字符串，也就是说，<code class="language-text">__repr__()</code> 是为调试服务的。</p>\n<p>解决办法是再定义一个 <code class="language-text">__repr__()</code>。但是通常 <code class="language-text">__str__()</code> 和 <code class="language-text">__repr__()</code> 代码都是一样的，所以，有个偷懒的写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57327378600567940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n    def __str__(self):\n        return \'Student object (name=%s)\' % self.name\n    __repr__ = __str__`, `57327378600567940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'Student object (name=%s)\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name\n    __repr__ <span class="token operator">=</span> __str__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__iter__"><a href="#__iter__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__iter__</code></h3>\n<p>如果一个类想被用于 for … in 循环，类似 list 或 tuple 那样，就必须实现一个 <code class="language-text">__iter__()</code> 方法，该方法返回一个迭代对象，然后，Python 的 for 循环就会不断调用该迭代对象的 <code class="language-text">__next__()</code> 方法拿到循环的下一个值，直到遇到 StopIteration 错误时退出循环。</p>\n<p>我们以斐波那契数列为例，写一个 Fib 类，可以作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4696517202821893000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __init__(self):\n        self.a, self.b = 0, 1 # 初始化两个计数器 a，b\n\n    def __iter__(self):\n        return self # 实例本身就是迭代对象，故返回自己\n\n    def __next__(self):\n        self.a, self.b = self.b, self.a + self.b # 计算下一个值\n        if self.a > 100000: # 退出循环的条件\n            raise StopIteration()\n        return self.a # 返回下一个值`, `4696517202821893000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment"># 初始化两个计数器 a，b</span>\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self <span class="token comment"># 实例本身就是迭代对象，故返回自己</span>\n\n    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a <span class="token operator">+</span> self<span class="token punctuation">.</span>b <span class="token comment"># 计算下一个值</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>a <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">:</span> <span class="token comment"># 退出循环的条件</span>\n            <span class="token keyword">raise</span> StopIteration<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>a <span class="token comment"># 返回下一个值</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，试试把 Fib 实例作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57280064821035760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for n in Fib():\n...     print(n)\n...\n1\n1\n2\n3\n5\n...\n46368\n75025`, `57280064821035760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">46368</span>\n<span class="token number">75025</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__getitem__"><a href="#__getitem__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__getitem__</code></h3>\n<p>Fib 实例虽然能作用于 for 循环，看起来和 list 有点像，但是，把它当成 list 来使用还是不行，比如，取第 5 个元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82464859929032080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> Fib()[5]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: \'Fib\' object does not support indexing`, `82464859929032080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'Fib\'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support indexing</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要表现得像 list 那样按照下标取出元素，需要实现 <code class="language-text">__getitem__()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30888224216905050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __getitem__(self, n):\n        a, b = 1, 1\n        for x in range(n):\n            a, b = b, a + b\n        return a`, `30888224216905050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        <span class="token keyword">return</span> a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，就可以按下标访问数列的任意一项了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15748600156540783000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = Fib()\n>>> f[0]\n1\n>>> f[1]\n1\n>>> f[2]\n2\n>>> f[3]\n3\n>>> f[10]\n89\n>>> f[100]\n573147844013817084101`, `15748600156540783000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token number">89</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>\n<span class="token number">573147844013817084101</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 list 有个神奇的切片方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91402303179076960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(range(100))[5:10]\n[5, 6, 7, 8, 9]`, `91402303179076960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>对于 Fib 却报错。原因是 <code class="language-text">__getitem__()</code> 传入的参数可能是一个 int，也可能是一个切片对象 slice，所以要做判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17244938723510116000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __getitem__(self, n):\n        if isinstance(n, int): # n 是索引\n            a, b = 1, 1\n            for x in range(n):\n                a, b = b, a + b\n            return a\n        if isinstance(n, slice): # n 是切片\n            start = n.start\n            stop = n.stop\n            if start is None:\n                start = 0\n            a, b = 1, 1\n            L = []\n            for x in range(stop):\n                if x >= start:\n                    L.append(a)\n                a, b = b, a + b\n            return L`, `17244938723510116000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n 是索引</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n            <span class="token keyword">return</span> a\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n 是切片</span>\n            start <span class="token operator">=</span> n<span class="token punctuation">.</span>start\n            stop <span class="token operator">=</span> n<span class="token punctuation">.</span>stop\n            <span class="token keyword">if</span> start <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n                start <span class="token operator">=</span> <span class="token number">0</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n            L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">if</span> x <span class="token operator">>=</span> start<span class="token punctuation">:</span>\n                    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n            <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在试试 Fib 的切片：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26052701676164450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = Fib()\n>>> f[0:5]\n[1, 1, 2, 3, 5]\n>>> f[:10]\n[1, 1, 2, 3, 5, 8, 13, 21, 34, 55]`, `26052701676164450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是没有对 step 参数作处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55114772760061580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f[:10:2]\n[1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89]`, `55114772760061580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也没有对负数作处理，所以，要正确实现一个 <code class="language-text">__getitem__()</code> 还是有很多工作要做的。</p>\n<p>此外，如果把对象看成 dict，<code class="language-text">__getitem__()</code> 的参数也可能是一个可以作 key 的 object，例如 str。</p>\n<p>与之对应的是 <code class="language-text">__setitem__()</code> 方法，把对象视作 list 或 dict 来对集合赋值。最后，还有一个 <code class="language-text">__delitem__()</code> 方法，用于删除某个元素。</p>\n<p>总之，通过上面的方法，我们自己定义的类表现得和 Python 自带的 list、tuple、dict 没什么区别，这完全归功于动态语言的“鸭子类型”，不需要强制继承某个接口。</p>\n<h3 id="__getattr__"><a href="#__getattr__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__getattr__</code></h3>\n<p>正常情况下，当我们调用类的方法或属性时，如果不存在，就会报错。比如定义 Student 类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29002821672751210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'`, `29002821672751210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 name 属性，没问题，但是，调用不存在的 score 属性，就有问题了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20639449000905000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> print(s.name)\nMichael\n>>> print(s.score)\nTraceback (most recent call last):\n  ...\nAttributeError: \'Student\' object has no attribute \'score\'`, `20639449000905000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nMichael\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>score<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'score\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误信息很清楚地告诉我们，没有找到 score 这个 attribute。</p>\n<p>要避免这个错误，除了可以加上一个 score 属性外，Python 还有另一个机制，那就是写一个 <code class="language-text">__getattr__()</code> 方法，动态返回一个属性。修改如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47031957664580900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'\n\n    def __getattr__(self, attr):\n        if attr==\'score\':\n            return 99`, `47031957664580900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'score\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当调用不存在的属性时，比如 score，Python 解释器会试图调用 <code class="language-text">__getattr__(self, &#39;score&#39;)</code> 来尝试获得属性，这样，我们就有机会返回 score 的值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25403012185000473000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'\n\n    def __getattr__(self, attr):\n        if attr==\'score\':\n            return 99`, `25403012185000473000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'score\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当调用不存在的属性时，比如 score，Python 解释器会试图调用 <code class="language-text">__getattr__(self, &#39;score&#39;)</code> 来尝试获得属性，这样，我们就有机会返回 score 的值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56107279501712970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.name\n\'Michael\'\n>>> s.score\n99`, `56107279501712970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回函数也是完全可以的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39476044822284665000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __getattr__(self, attr):\n        if attr==\'age\':\n            return lambda: 25`, `39476044822284665000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只是调用方式要变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61172596015457526000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.age()\n25`, `61172596015457526000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意，只有在没有找到属性的情况下，才调用 <code class="language-text">__getattr__</code>，已有的属性，比如 name，不会在 <code class="language-text">__getattr__</code> 中查找。</p>\n<p>此外，注意到任意调用如 s.abc 都会返回 None，这是因为我们定义的 <code class="language-text">__getattr__</code> 默认返回就是 None。要让 class 只响应特定的几个属性，我们就要按照约定，抛出 AttributeError 的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76389714354609460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __getattr__(self, attr):\n        if attr==\'age\':\n            return lambda: 25\n        raise AttributeError(\'\\\'Student\\\' object has no attribute \\\'%s\\\'\' % attr)`, `76389714354609460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span>\n        <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">\'\\\'Student\\\' object has no attribute \\\'%s\\\'\'</span> <span class="token operator">%</span> attr<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这实际上可以把一个类的所有属性和方法调用全部动态化处理了，不需要任何特殊手段。</p>\n<p>这种完全动态调用的特性有什么实际作用呢？作用就是，可以针对完全动态的情况作调用。</p>\n<p>举个例子：</p>\n<p>现在很多网站都搞 REST API，比如新浪微博、豆瓣啥的，调用 API 的 URL 类似：</p>\n<ul>\n<li><code class="language-text">http://api.server/user/friends</code></li>\n<li><code class="language-text">http://api.server/user/timeline/list</code></li>\n</ul>\n<p>如果要写 SDK，给每个 URL 对应的 API 都写一个方法，那得累死，而且，API 一旦改动，SDK 也要改。</p>\n<p>利用完全动态的 <code class="language-text">__getattr__</code>，我们可以写出一个链式调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17848174633278636000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Chain(object):\n\n    def __init__(self, path=\'\'):\n        self._path = path\n\n    def __getattr__(self, path):\n        return Chain(\'%s/%s\' % (self._path, path))\n\n    def __str__(self):\n        return self._path\n\n    __repr__ = __str__`, `17848174633278636000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_path\n\n    __repr__ <span class="token operator">=</span> __str__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22181687690537923000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> Chain().status.user.timeline.list\n\'/status/user/timeline/list\'`, `22181687690537923000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status<span class="token punctuation">.</span>user<span class="token punctuation">.</span>timeline<span class="token punctuation">.</span><span class="token builtin">list</span>\n<span class="token string">\'/status/user/timeline/list\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样，无论 API 怎么变，SDK 都可以根据 URL 实现完全动态的调用，而且，不随 API 的增加而改变！</p>\n<p>还有些 REST API 会把参数放到 URL 中，比如 GitHub 的 API：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78537354067381010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`GET /users/:user/repos`, `78537354067381010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">GET /users/:user/repos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>调用时，需要把 :user 替换为实际用户名。如果我们能写出这样的链式调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65433565899325540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Chain().users(\'michael\').repos`, `65433565899325540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>users<span class="token punctuation">(</span><span class="token string">\'michael\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就可以非常方便地调用 API 了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42664498836289380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Chain(object):\n    def __init__(self, path=\'\'):\n       self.__path = path\n\n   def __getattr__(self, path):\n       return Chain(\'%s/%s\' % (self.__path, path))\n\n   def __call__(self, path):\n       return Chain(\'%s/%s\' % (self.__path, path))\n\n   def __str__(self):\n       return self.__path\n\n   __repr__ = __str__\n\nprint(Chain().users(\'michael\').repos) # /users/michael/repos`, `42664498836289380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n       self<span class="token punctuation">.</span>__path <span class="token operator">=</span> path\n\n   <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n   <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n   <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> self<span class="token punctuation">.</span>__path\n\n   __repr__ <span class="token operator">=</span> __str__\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>users<span class="token punctuation">(</span><span class="token string">\'michael\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repos<span class="token punctuation">)</span> <span class="token comment"># /users/michael/repos</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__call__"><a href="#__call__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__call__</code></h3>\n<p>一个对象实例可以有自己的属性和方法，当我们调用实例方法时，我们用 instance.method() 来调用。能不能直接在实例本身上调用呢？在 Python 中，答案是肯定的。</p>\n<p>任何类，只需要定义一个 <code class="language-text">__call__()</code> 方法，就可以直接对实例进行调用。请看示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38401187857266450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n\n    def __call__(self):\n        print(\'My name is %s.\' % self.name)`, `38401187857266450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'My name is %s.\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用方式如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78606551564025760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student(\'Michael\')\n>>> s() # self 参数不要传入\nMy name is Michael.`, `78606551564025760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># self 参数不要传入</span>\nMy name <span class="token keyword">is</span> Michael<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">__call__()</code> 还可以定义参数。对实例进行直接调用就好比对一个函数进行调用一样，所以你完全可以把对象看成函数，把函数看成对象，因为这两者之间本来就没啥根本的区别。</p>\n<p>如果你把对象看成函数，那么函数本身其实也可以在运行期动态创建出来，因为类的实例都是运行期创建出来的，这么一来，我们就模糊了对象和函数的界限。</p>\n<p>那么，怎么判断一个变量是对象还是函数呢？其实，更多的时候，我们需要判断一个对象是否能被调用，能被调用的对象就是一个 Callable 对象，比如函数和我们上面定义的带有 <code class="language-text">__call__()</code> 的类实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70161786947332350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> callable(Student())\nTrue\n>>> callable(max)\nTrue\n>>> callable([1, 2, 3])\nFalse\n>>> callable(None)\nFalse\n>>> callable(\'str\')\nFalse`, `70161786947332350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token string">\'str\'</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 callable() 函数，我们就可以判断一个对象是否是“可调用”对象。</p>\n<h3 id="小结-11"><a href="#%E5%B0%8F%E7%BB%93-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的 class 允许定义许多定制方法，可以让我们非常方便地生成特定的类。</p>\n<h2 id="使用元类"><a href="#%E4%BD%BF%E7%94%A8%E5%85%83%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用元类</h2>\n<h3 id="type"><a href="#type" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>type()</h3>\n<p>动态语言和静态语言最大的不同，就是函数和类的定义，不是编译时定义的，而是运行时动态创建的。</p>\n<p>比方说我们要定义一个 Hello 的 class，就写一个 hello.py 模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76798101073698980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Hello(object):\n    def hello(self, name=\'world\'):\n        print(\'Hello, %s.\' % name)`, `76798101073698980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当 Python 解释器载入 hello 模块时，就会依次执行该模块的所有语句，执行结果就是动态创建出一个 Hello 的 class 对象，测试如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53443807859743410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from hello import Hello\n>>> h = Hello()\n>>> h.hello()\nHello, world.\n>>> print(type(Hello))\n<class \'type\'>\n>>> print(type(h))\n<class \'hello.Hello\'>`, `53443807859743410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> hello <span class="token keyword">import</span> Hello\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world<span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'hello.Hello\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>type() 函数可以查看一个类型或变量的类型，Hello 是一个 class，它的类型就是 type，而 h 是一个实例，它的类型就是 class Hello。</p>\n<p>我们说 class 的定义是运行时动态创建的，而创建 class 的方法就是使用 type() 函数。</p>\n<p>type() 函数既可以返回一个对象的类型，又可以创建出新的类型，比如，我们可以通过 type() 函数创建出 Hello 类，而无需通过 class Hello(object)… 的定义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6501445617614410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def fn(self, name=\'world\'): # 先定义函数\n...     print(\'Hello, %s.\' % name)\n...\n>>> Hello = type(\'Hello\', (object,), dict(hello=fn)) # 创建 Hello class\n>>> h = Hello()\n>>> h.hello()\nHello, world.\n>>> print(type(Hello))\n<class \'type\'>\n>>> print(type(h))\n<class \'__main__.Hello\'>`, `6501445617614410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 先定义函数</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> Hello <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>hello<span class="token operator">=</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 创建 Hello class</span>\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world<span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Hello\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要创建一个 class 对象，type() 函数依次传入 3 个参数：</p>\n<ol>\n<li>class 的名称；</li>\n<li>继承的父类集合，注意 Python 支持多重继承，如果只有一个父类，别忘了 tuple 的单元素写法；</li>\n<li>class 的方法名称与函数绑定，这里我们把函数 fn 绑定到方法名 hello 上。</li>\n</ol>\n<p>通过 type() 函数创建的类和直接写 class 是完全一样的，因为 Python 解释器遇到 class 定义时，仅仅是扫描一下 class 定义的语法，然后调用 type() 函数创建出 class。</p>\n<p>正常情况下，我们都用 class Xxx… 来定义类，但是，type() 函数也允许我们动态创建出类来，也就是说，动态语言本身支持运行期动态创建类，这和静态语言有非常大的不同，要在静态语言运行期创建类，必须构造源代码字符串再调用编译器，或者借助一些工具生成字节码实现，本质上都是动态编译，会非常复杂。</p>\n<h3 id="metaclass"><a href="#metaclass" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>metaclass</h3>\n<p>除了使用 type() 动态创建类以外，要控制类的创建行为，还可以使用 metaclass。</p>\n<p>metaclass，直译为元类，简单的解释就是：</p>\n<p>当我们定义了类以后，就可以根据这个类创建出实例，所以先定义类，然后创建实例。</p>\n<p>但是如果我们想创建出类呢？那就必须根据 metaclass 创建出类，所以先定义 metaclass，然后创建类。</p>\n<p>连接起来就是：先定义 metaclass，就可以创建类，最后创建实例。</p>\n<p>所以，metaclass 允许你创建类或者修改类。换句话说，你可以把类看成是 metaclass 创建出来的“实例”。</p>\n<p>metaclass 是 Python 面向对象里最难理解，也是最难使用的魔术代码。正常情况下，你不会碰到需要使用 metaclass 的情况，所以，以下内容看不懂也没关系，因为基本上你不会用到。</p>\n<p>我们先看一个简单的例子，这个 metaclass 可以给我们自定义的 MyList 增加一个 add 方法：</p>\n<p>定义 ListMetaclass，按照默认习惯，metaclass 的类名总是以 Metaclass 结尾，以便清楚地表示这是一个 metaclass：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82557473794295730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# metaclass 是类的模板，所以必须从 \\`type\\` 类型派生：\nclass ListMetaclass(type):\n    def __new__(cls, name, bases, attrs):\n        attrs[\'add\'] = lambda self, value: self.append(value)\n        return type.__new__(cls, name, bases, attrs)`, `82557473794295730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># metaclass 是类的模板，所以必须从 `type` 类型派生：</span>\n<span class="token keyword">class</span> <span class="token class-name">ListMetaclass</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'add\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">lambda</span> self<span class="token punctuation">,</span> value<span class="token punctuation">:</span> self<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了 ListMetaclass，我们在定义类的时候还要指示使用 ListMetaclass 来定制类，传入关键字参数 metaclass：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71715867863085520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyList(list, metaclass=ListMetaclass):\n    pass`, `71715867863085520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ListMetaclass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们传入关键字参数 metaclass 时，魔术就生效了，它指示 Python 解释器在创建 MyList 时，要通过 <code class="language-text">ListMetaclass.__new__()</code> 来创建，在此，我们可以修改类的定义，比如，加上新的方法，然后，返回修改后的定义。</p>\n<p><code class="language-text">__new__()</code> 方法接收到的参数依次是：</p>\n<ol>\n<li>当前准备创建的类的对象；</li>\n<li>类的名字；</li>\n<li>类继承的父类集合；</li>\n<li>类的方法集合。</li>\n</ol>\n<p>测试一下 MyList 是否可以调用 add() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61431233112063070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = MyList()\n>>> L.add(1)\n>> L\n[1]`, `61431233112063070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> MyList<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">>></span> L\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而普通的 list 没有 add() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43213802122079970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L2 = list()\n>>> L2.add(1)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'list\' object has no attribute \'add\'`, `43213802122079970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L2 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L2<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'list\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'add\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>动态修改有什么意义？直接在 MyList 定义中写上 add() 方法不是更简单吗？正常情况下，确实应该直接写，通过 metaclass 修改纯属变态。</p>\n<p>但是，总会遇到需要通过 metaclass 修改类定义的。ORM 就是一个典型的例子。</p>\n<p>ORM 全称 “Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作 SQL 语句。</p>\n<p>要编写一个 ORM 框架，所有的类都只能动态定义，因为只有使用者才能根据表的结构定义出对应的类来。</p>\n<p>让我们来尝试编写一个 ORM 框架。</p>\n<p>编写底层模块的第一步，就是先把调用接口写出来。比如，使用者如果使用这个 ORM 框架，想定义一个 User 类来操作对应的数据库表 User，我们期待他写出这样的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52049777056516250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class User(Model):\n    # 定义类的属性到列的映射：\n    id = IntegerField(\'id\')\n    name = StringField(\'username\')\n    email = StringField(\'email\')\n    password = StringField(\'password\')\n\n# 创建一个实例：\nu = User(id=12345, name=\'Michael\', email=\'test@orm.org\', password=\'my-pwd\')\n# 保存到数据库：\nu.save()`, `52049777056516250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 定义类的属性到列的映射：</span>\n    <span class="token builtin">id</span> <span class="token operator">=</span> IntegerField<span class="token punctuation">(</span><span class="token string">\'id\'</span><span class="token punctuation">)</span>\n    name <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'username\'</span><span class="token punctuation">)</span>\n    email <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'email\'</span><span class="token punctuation">)</span>\n    password <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'password\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 创建一个实例：</span>\nu <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">12345</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 保存到数据库：</span>\nu<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，父类 Model 和属性类型 StringField、IntegerField 是由 ORM 框架提供的，剩下的魔术方法比如 save() 全部由父类 Model 自动完成。虽然 metaclass 的编写会比较复杂，但 ORM 的使用者用起来却异常简单。</p>\n<p>现在，我们就按上面的接口来实现该 ORM。</p>\n<p>首先来定义 Field 类，它负责保存数据库表的字段名和字段类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53617556956974236000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field(object):\n\n    def __init__(self, name, column_type):\n        self.name = name\n        self.column_type = column_type\n\n    def __str__(self):\n        return \'<%s:%s>\' % (self.__class__.__name__, self.name)`, `53617556956974236000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> column_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>column_type <span class="token operator">=</span> column_type\n\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'&lt;%s:%s>\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Field 的基础上，进一步定义各种类型的 Field，比如 StringField，IntegerField 等等：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64925841886406040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class StringField(Field):\n\n    def __init__(self, name):\n        super(StringField, self).__init__(name, \'varchar(100)\')\n\nclass IntegerField(Field):\n\n    def __init__(self, name):\n        super(IntegerField, self).__init__(name, \'bigint\')`, `64925841886406040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">StringField</span><span class="token punctuation">(</span>Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>StringField<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'varchar(100)\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">IntegerField</span><span class="token punctuation">(</span>Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>IntegerField<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'bigint\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下一步，就是编写最复杂的 ModelMetaclass 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7711792171274556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ModelMetaclass(type):\n\n    def __new__(cls, name, bases, attrs):\n        if name==\'Model\':\n            return type.__new__(cls, name, bases, attrs)\n        print(\'Found model: %s\' % name)\n        mappings = dict()\n        for k, v in attrs.items():\n            if isinstance(v, Field):\n                print(\'Found mapping: %s ==> %s\' % (k, v))\n                mappings[k] = v\n        for k in mappings.keys():\n            attrs.pop(k)\n        attrs[\'__mappings__\'] = mappings # 保存属性和列的映射关系\n        attrs[\'__table__\'] = name # 假设表名和类名一致\n        return type.__new__(cls, name, bases, attrs)`, `7711792171274556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ModelMetaclass</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> name<span class="token operator">==</span><span class="token string">\'Model\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found model: %s\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        mappings <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> attrs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found mapping: %s ==> %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>\n                mappings<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v\n        <span class="token keyword">for</span> k <span class="token keyword">in</span> mappings<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            attrs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>k<span class="token punctuation">)</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'__mappings__\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mappings <span class="token comment"># 保存属性和列的映射关系</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'__table__\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> name <span class="token comment"># 假设表名和类名一致</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及基类 Model：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56493605410050530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Model(dict, metaclass=ModelMetaclass):\n\n    def __init__(self, **kw):\n        super(Model, self).__init__(**kw)\n\n    def __getattr__(self, key):\n        try:\n            return self[key]\n        except KeyError:\n            raise AttributeError(r&quot;\'Model\' object has no attribute \'%s\'&quot; % key)\n\n    def __setattr__(self, key, value):\n        self[key] = value\n\n    def save(self):\n        fields = []\n        params = []\n        args = []\n        for k, v in self.__mappings__.items():\n            fields.append(v.name)\n            params.append(\'?\')\n            args.append(getattr(self, k, None))\n        sql = \'insert into %s (%s) values (%s)\' % (self.__table__, \',\'.join(fields), \',\'.join(params))\n        print(\'SQL: %s\' % sql)\n        print(\'ARGS: %s\' % str(args))`, `56493605410050530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ModelMetaclass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>Model<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kw<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">r"\'Model\' object has no attribute \'%s\'"</span> <span class="token operator">%</span> key<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> self<span class="token punctuation">.</span>__mappings__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            fields<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n            params<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">)</span>\n            args<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        sql <span class="token operator">=</span> <span class="token string">\'insert into %s (%s) values (%s)\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__table__<span class="token punctuation">,</span> <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'SQL: %s\'</span> <span class="token operator">%</span> sql<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ARGS: %s\'</span> <span class="token operator">%</span> <span class="token builtin">str</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当用户定义一个 class User(Model) 时，Python 解释器首先在当前类 User 的定义中查找 metaclass，如果没有找到，就继续在父类 Model 中查找 metaclass，找到了，就使用 Model 中定义的 metaclass 的 ModelMetaclass 来创建 User 类，也就是说，metaclass 可以隐式地继承到子类，但子类自己却感觉不到。</p>\n<p>在 ModelMetaclass 中，一共做了几件事情：</p>\n<ol>\n<li>排除掉对 Model 类的修改；</li>\n<li>在当前类（比如 User）中查找定义的类的所有属性，如果找到一个 Field 属性，就把它保存到一个 <code class="language-text">__mappings__</code> 的 dict 中，同时从类属性中删除该 Field 属性，否则，容易造成运行时错误（实例的属性会遮盖类的同名属性）；</li>\n<li>把表名保存到 <code class="language-text">__table__</code> 中，这里简化为表名默认为类名。</li>\n</ol>\n<p>在 Model 类中，就可以定义各种操作数据库的方法，比如 save()，delete()，find()，update() 等等。</p>\n<p>我们实现了 save() 方法，把一个实例保存到数据库中。因为有表名，属性到字段的映射和属性值的集合，就可以构造出 INSERT 语句。</p>\n<p>编写代码试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29330196407373110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`u = User(id=12345, name=\'Michael\', email=\'test@orm.org\', password=\'my-pwd\')\nu.save()`, `29330196407373110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">u <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">12345</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">)</span>\nu<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>输出如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38675806295610670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Found model: User\nFound mapping: email ==> <StringField:email>\nFound mapping: password ==> <StringField:password>\nFound mapping: id ==> <IntegerField:uid>\nFound mapping: name ==> <StringField:username>\nSQL: insert into User (password,email,username,id) values (?,?,?,?)\nARGS: [\'my-pwd\', \'test@orm.org\', \'Michael\', 12345]`, `38675806295610670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Found model<span class="token punctuation">:</span> User\nFound mapping<span class="token punctuation">:</span> email <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>email<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> password <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>password<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> <span class="token builtin">id</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>IntegerField<span class="token punctuation">:</span>uid<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> name <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>username<span class="token operator">></span>\nSQL<span class="token punctuation">:</span> insert into User <span class="token punctuation">(</span>password<span class="token punctuation">,</span>email<span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span> values <span class="token punctuation">(</span>?<span class="token punctuation">,</span>?<span class="token punctuation">,</span>?<span class="token punctuation">,</span>?<span class="token punctuation">)</span>\nARGS<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">,</span> <span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> <span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">12345</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，save() 方法已经打印出了可执行的 SQL 语句，以及参数列表，只需要真正连接到数据库，执行该 SQL 语句，就可以完成真正的功能。</p>\n<p>不到 100 行代码，我们就通过 metaclass 实现了一个精简的 ORM 框架，是不是非常简单？</p>\n<h3 id="小结-12"><a href="#%E5%B0%8F%E7%BB%93-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>metaclass 是 Python 中非常具有魔术性的对象，它可以改变类创建时的行为。这种强大的功能使用起来务必小心。</p>\n<h1 id="错误、调试和测试"><a href="#%E9%94%99%E8%AF%AF%E3%80%81%E8%B0%83%E8%AF%95%E5%92%8C%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误、调试和测试</h1>\n<h2 id="错误处理"><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误处理</h2>\n<h3 id="try"><a href="#try" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>try</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31897244406027104000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / 0\n    print(\'result:\', r)\nexcept ZeroDivisionError as e:\n    print(\'except:\', e)\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `31897244406027104000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'except:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们认为某些代码可能会出错时，就可以用 try 来运行这段代码，如果执行出错，则后续代码不会继续执行，而是直接跳转至错误处理代码，即 except 语句块，执行完 except 后，如果有 finally 语句块，则执行 finally 语句块，至此，执行完毕。</p>\n<p>上面的代码在计算 10 / 0 时会产生一个除法运算错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21672722588947480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try...\nexcept: division by zero\nfinally...\nEND`, `21672722588947480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token keyword">except</span><span class="token punctuation">:</span> division by zero\n<span class="token keyword">finally</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从输出可以看到，当错误发生时，后续语句 <code class="language-text">print(&#39;result:&#39;, r)</code> 不会被执行，except 由于捕获到 ZeroDivisionError，因此被执行。最后，finally 语句被执行。然后，程序继续按照流程往下走。</p>\n<p>如果把除数 0 改成 2，则执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65055021831665250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try...\nresult: 5\nfinally...\nEND`, `65055021831665250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nresult<span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token keyword">finally</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于没有错误发生，所以 except 语句块不会被执行，但是 finally 如果有，则一定会被执行（可以没有 finally 语句）。</p>\n<p>你还可以猜测，错误应该有很多种类，如果发生了不同类型的错误，应该由不同的 except 语句块处理。没错，可以有多个 except 来捕获不同类型的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37778473863919034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / int(\'a\')\n    print(\'result:\', r)\nexcept ValueError as e:\n    print(\'ValueError:\', e)\nexcept ZeroDivisionError as e:\n    print(\'ZeroDivisionError:\', e)\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `37778473863919034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ZeroDivisionError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>int() 函数可能会抛出 ValueError，所以我们用一个 except 捕获 ValueError，用另一个 except 捕获 ZeroDivisionError。</p>\n<p>此外，如果没有错误发生，可以在 except 语句块后面加一个 else，当没有错误发生时，会自动执行 else 语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66436708991949640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / int(\'2\')\n    print(\'result:\', r)\nexcept ValueError as e:\n    print(\'ValueError:\', e)\nexcept ZeroDivisionError as e:\n    print(\'ZeroDivisionError:\', e)\nelse:\n    print(\'no error!\')\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `66436708991949640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ZeroDivisionError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'no error!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 的错误其实也是 class，所有的错误类型都继承自 BaseException，所以在使用 except 时需要注意的是，它不但捕获该类型的错误，还把其子类也“一网打尽”。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9636781461104781000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    foo()\nexcept ValueError as e:\n    print(\'ValueError\')\nexcept UnicodeError as e:\n    print(\'UnicodeError\')`, `9636781461104781000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> UnicodeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'UnicodeError\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第二个 except 永远也捕获不到 UnicodeError，因为 UnicodeError 是 ValueError 的子类，如果有，也被第一个 except 给捕获了。</p>\n<p>Python 所有的错误都是从 BaseException 类派生的，常见的错误类型和继承关系看<a href="https://docs.python.org/3/library/exceptions.html#exception-hierarchy" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>使用 try…except 捕获错误还有一个巨大的好处，就是可以跨越多层调用，比如函数 main() 调用 bar()，bar() 调用 foo()，结果 foo() 出错了，这时，只要 main() 捕获到了，就可以处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25758824863057605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    try:\n        bar(\'0\')\n    except Exception as e:\n        print(\'Error:\', e)\n    finally:\n        print(\'finally...\')`, `25758824863057605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Error:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n    <span class="token keyword">finally</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也就是说，不需要在每个可能出错的地方去捕获错误，只要在合适的层次去捕获错误就可以了。这样一来，就大大减少了写 try…except…finally 的麻烦。</p>\n<h3 id="调用栈"><a href="#%E8%B0%83%E7%94%A8%E6%A0%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用栈</h3>\n<p>如果错误没有被捕获，它就会一直往上抛，最后被 Python 解释器捕获，打印一个错误信息，然后程序退出。来看看 err.py：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28791825650471047000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py:\ndef foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    bar(\'0\')\n\nmain()`, `28791825650471047000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py:</span>\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行，结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70281910357728840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err.py\nTraceback (most recent call last): # 错误的跟踪信息\n  File &quot;err.py&quot;, line 11, in <module> # 调用 main() 出错了，在代码文件 err.py 的第 11 行代码，但原因是第 9 行\n    main()\n  File &quot;err.py&quot;, line 9, in main # 调用 bar(\'0\') 出错了，在代码文件 err.py 的第 9 行代码，但原因是第 6 行\n    bar(\'0\')\n  File &quot;err.py&quot;, line 6, in bar # 原因是 return foo(s) * 2 这个语句出错了，但这还不是最终原因，继续往下看\n    return foo(s) * 2\n  File &quot;err.py&quot;, line 3, in foo # 原因是 return 10 / int(s) 这个语句出错了，这是错误产生的源头，因为下面打印了：ZeroDivisionError: division by zero\n    return 10 / int(s)\nZeroDivisionError: division by zero`, `70281910357728840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>: <span class="token comment"># 错误的跟踪信息</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">11</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span> <span class="token comment"># 调用 main() 出错了，在代码文件 err.py 的第 11 行代码，但原因是第 9 行</span>\n    main<span class="token punctuation">(</span><span class="token punctuation">)</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">9</span>, <span class="token keyword">in</span> main <span class="token comment"># 调用 bar(\'0\') 出错了，在代码文件 err.py 的第 9 行代码，但原因是第 6 行</span>\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">6</span>, <span class="token keyword">in</span> bar <span class="token comment"># 原因是 return foo(s) * 2 这个语句出错了，但这还不是最终原因，继续往下看</span>\n    <span class="token builtin class-name">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> * <span class="token number">2</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">3</span>, <span class="token keyword">in</span> foo <span class="token comment"># 原因是 return 10 / int(s) 这个语句出错了，这是错误产生的源头，因为下面打印了：ZeroDivisionError: division by zero</span>\n    <span class="token builtin class-name">return</span> <span class="token number">10</span> / int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出错并不可怕，可怕的是不知道哪里出错了。解读错误信息是定位错误的关键，如上面的代码注释</p>\n<h3 id="记录错误"><a href="#%E8%AE%B0%E5%BD%95%E9%94%99%E8%AF%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>记录错误</h3>\n<p>如果不捕获错误，自然可以让 Python 解释器来打印出错误堆栈，但程序也被结束了。既然我们能捕获错误，就可以把错误堆栈打印出来，然后分析错误原因，同时，让程序继续执行下去。</p>\n<p>Python 内置的 logging 模块可以非常容易地记录错误信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75878457474125550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_logging.py\n\nimport logging\n\ndef foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    try:\n        bar(\'0\')\n    except Exception as e:\n        logging.exception(e)\n\nmain()\nprint(\'END\')`, `75878457474125550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_logging.py</span>\n\n<span class="token keyword">import</span> logging\n\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        logging<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样是出错，但程序打印完错误信息后会继续执行，并正常退出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21660808871590433000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err_logging.py\nERROR:root:division by zero\nTraceback (most recent call last):\n  File &quot;err_logging.py&quot;, line 13, in main\n    bar(\'0\')\n  File &quot;err_logging.py&quot;, line 9, in bar\n    return foo(s) * 2\n  File &quot;err_logging.py&quot;, line 6, in foo\n    return 10 / int(s)\nZeroDivisionError: division by zero\nEND`, `21660808871590433000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err_logging.py\nERROR:root:division by zero\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">13</span>, <span class="token keyword">in</span> main\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">9</span>, <span class="token keyword">in</span> bar\n    <span class="token builtin class-name">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> * <span class="token number">2</span>\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">6</span>, <span class="token keyword">in</span> foo\n    <span class="token builtin class-name">return</span> <span class="token number">10</span> / int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nZeroDivisionError: division by zero\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过配置，logging 还可以把错误记录到日志文件里，方便事后排查。</p>\n<h3 id="抛出错误"><a href="#%E6%8A%9B%E5%87%BA%E9%94%99%E8%AF%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>抛出错误</h3>\n<p>因为错误是 class，捕获一个错误就是捕获到该 class 的一个实例。因此，错误并不是凭空产生的，而是有意创建并抛出的。Python 的内置函数会抛出很多类型的错误，我们自己编写的函数也可以抛出错误。</p>\n<p>如果要抛出错误，首先根据需要，可以定义一个错误的 class，选择好继承关系，然后，用 raise 语句抛出一个错误的实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13747524366856511000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_raise.py\nclass FooError(ValueError):\n    pass\n\ndef foo(s):\n    n = int(s)\n    if n==0:\n        raise FooError(\'invalid value: %s\' % s)\n    return 10 / n\n\nfoo(\'0\')`, `13747524366856511000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_raise.py</span>\n<span class="token keyword">class</span> <span class="token class-name">FooError</span><span class="token punctuation">(</span>ValueError<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FooError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> <span class="token operator">%</span> s<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\nfoo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行，可以最后跟踪到我们自己定义的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35556633227838775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err_raise.py\nTraceback (most recent call last):\n  File &quot;err_throw.py&quot;, line 11, in <module>\n    foo(\'0\')\n  File &quot;err_throw.py&quot;, line 8, in foo\n    raise FooError(\'invalid value: %s\' % s)\n__main__.FooError: invalid value: 0`, `35556633227838775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err_raise.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err_throw.py"</span>, line <span class="token number">11</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err_throw.py"</span>, line <span class="token number">8</span>, <span class="token keyword">in</span> foo\n    raise FooError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> % s<span class="token punctuation">)</span>\n__main__.FooError: invalid value: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有在必要的时候才定义我们自己的错误类型。如果可以选择 Python 已有的内置的错误类型（比如 ValueError，TypeError），尽量使用 Python 内置的错误类型。</p>\n<p>最后，我们来看另一种错误处理的方式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52317795561621410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_reraise.py\ndef foo(s):\n    n = int(s)\n    if n==0:\n        raise ValueError(\'invalid value: %s\' % s)\n    return 10 / n\n\ndef bar():\n    try:\n        foo(\'0\')\n    except ValueError as e:\n        print(\'ValueError!\')\n        raise\n\nbar()`, `52317795561621410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_reraise.py</span>\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> <span class="token operator">%</span> s<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\nbar<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 bar() 函数中，我们明明已经捕获了错误，但是，打印一个 ValueError! 后，又把错误通过 raise 语句抛出去了，这不有病么？</p>\n<p>其实这种错误处理方式不但没病，而且相当常见。捕获错误目的只是记录一下，便于后续追踪。但是，由于当前函数不知道应该怎么处理该错误，所以，最恰当的方式是继续往上抛，让顶层调用者去处理。好比一个员工处理不了一个问题时，就把问题抛给他的老板，如果他的老板也处理不了，就一直往上抛，最终会抛给 CEO 去处理。</p>\n<p>raise 语句如果不带参数，就会把当前错误原样抛出。此外，在 except 中 raise 一个 Error，还可以把一种类型的错误转化成另一种类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53630240251597190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    10 / 0\nexcept ZeroDivisionError:\n    raise ValueError(\'input error!\')`, `53630240251597190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span>\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'input error!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只要是合理的转换逻辑就可以，但是，决不应该把一个 IOError 转换成毫不相干的 ValueError。</p>\n<h3 id="小结-13"><a href="#%E5%B0%8F%E7%BB%93-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 内置的 try…except…finally 用来处理错误十分方便。出错时，会分析错误信息并定位错误发生的代码位置才是最关键的。</p>\n<p>程序也可以主动抛出错误，让调用者来处理相应的错误。但是，应该在文档中写清楚可能会抛出哪些错误，以及错误产生的原因。</p>\n<h2 id="调试"><a href="#%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调试</h2>\n<p>第一种方法简单直接粗暴有效，就是用 print() 把可能有问题的变量打印出来看看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11583981957446787000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    n = int(s)\n    print(\'>>> n = %d\' % n)\n    return 10 / n\n\ndef main():\n    foo(\'0\')\n\nmain()`, `11583981957446787000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'>>> n = %d\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行后在输出中查找打印的变量值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42708881747024855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\n>>> n = 0\nTraceback (most recent call last):\n  ...\nZeroDivisionError: integer division or modulo by zero`, `42708881747024855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\n<span class="token operator">>></span><span class="token operator">></span> n <span class="token operator">=</span> <span class="token number">0</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nZeroDivisionError: integer division or modulo by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用 print() 最大的坏处是将来还得删掉它，想想程序里到处都是 print()，运行结果也会包含很多垃圾信息。所以，我们又有第二种方法。</p>\n<h3 id="断言"><a href="#%E6%96%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>断言</h3>\n<p>凡是用 print() 来辅助查看的地方，都可以用断言（assert）来替代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98797001876281070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    n = int(s)\n    assert n != 0, \'n is zero!\'\n    return 10 / n\n\ndef main():\n    foo(\'0\')`, `98797001876281070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'n is zero!\'</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>assert 的意思是，表达式 n != 0 应该是 True，否则，根据程序运行的逻辑，后面的代码肯定会出错。</p>\n<p>如果断言失败，assert 语句本身就会抛出 AssertionError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28159919849965440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\nTraceback (most recent call last):\n  ...\nAssertionError: n is zero!`, `28159919849965440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nAssertionError: n is zero<span class="token operator">!</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序中如果到处充斥着 assert，和 print() 相比也好不到哪去。不过，启动 Python 解释器时可以用 -O 参数来关闭 assert：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21489619526929650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python -O err.py\nTraceback (most recent call last):\n  ...\nZeroDivisionError: division by zero`, `21489619526929650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python -O err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：断言的开关“-O”是英文大写字母 O，不是数字 0。</p>\n</blockquote>\n<p>关闭后，你可以把所有的 assert 语句当成 pass 来看。</p>\n<h3 id="logging"><a href="#logging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logging</h3>\n<p>把 print() 替换为 logging 是第 3 种方式，和 assert 比，logging 不会抛出错误，而且可以输出到文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84649086599453100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import logging\n\ns = \'0\'\nn = int(s)\nlogging.info(\'n = %d\' % n)\nprint(10 / n)`, `84649086599453100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> logging\n\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nlogging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'n = %d\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>logging.info() 就可以输出一段文本。运行，发现除了 ZeroDivisionError，没有任何信息。怎么回事？</p>\n<p>别急，在 import logging 之后添加一行配置再试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31488589290375590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import logging\nlogging.basicConfig(level=logging.INFO)`, `31488589290375590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> logging\nlogging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>看到输出了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23101238376389800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\nINFO:root:n = 0\nTraceback (most recent call last):\n  File &quot;err.py&quot;, line 8, in <module>\n    print(10 / n)\nZeroDivisionError: division by zero`, `23101238376389800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\nINFO:root:n <span class="token operator">=</span> <span class="token number">0</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err.py"</span>, line <span class="token number">8</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这就是 logging 的好处，它允许你指定记录信息的级别，有 debug，info，warning，error 等几个级别，当我们指定 level=INFO 时，logging.debug 就不起作用了。同理，指定 level=WARNING 后，debug 和 info 就不起作用了。这样一来，你可以放心地输出不同级别的信息，也不用删除，最后统一控制输出哪个级别的信息。</p>\n<p>logging 的另一个好处是通过简单的配置，一条语句可以同时输出到不同的地方，比如 console 和文件。</p>\n<h3 id="pdb"><a href="#pdb" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pdb</h3>\n<p>第 4 种方式是启动 Python 的调试器 pdb，让程序以单步方式运行，可以随时查看运行状态。我们先准备好程序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48862003531826995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py\ns = \'0\'\nn = int(s)\nprint(10 / n)`, `48862003531826995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py</span>\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后启动：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32445632918199950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python -m pdb err.py\n> /Users/michael/Github/learn-python3/samples/debug/err.py(2)<module>()\n-> s = \'0\'`, `32445632918199950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python -m pdb err.py\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">\'0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>以参数 <code class="language-text">-m pdb</code> 启动后，pdb 定位到下一步要执行的代码 <code class="language-text">-&gt; s = &#39;0&#39;</code>。输入命令 l 来查看代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66648011356058000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) l\n  1     # err.py\n  2  -> s = \'0\'\n  3     n = int(s)\n  4     print(10 / n)`, `66648011356058000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> l\n  <span class="token number">1</span>     <span class="token comment"># err.py</span>\n  <span class="token number">2</span>  <span class="token operator">-</span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">\'0\'</span>\n  <span class="token number">3</span>     n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n  <span class="token number">4</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入命令 n 可以单步执行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85501796438450320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) n\n> /Users/michael/Github/learn-python3/samples/debug/err.py(3)<module>()\n-> n = int(s)\n(Pdb) n\n> /Users/michael/Github/learn-python3/samples/debug/err.py(4)<module>()\n-> print(10 / n)`, `85501796438450320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> n\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> n <span class="token operator">=</span> int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> n\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>任何时候都可以输入命令 p 变量名来查看变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7233069864266594000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) p s\n\'0\'\n(Pdb) p n\n0`, `7233069864266594000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p s\n<span class="token string">\'0\'</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p n\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入命令 q 结束调试，退出程序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96753838348890490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) q`, `96753838348890490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> q</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这种通过 pdb 在命令行调试的方法理论上是万能的，但实在是太麻烦了，如果有一千行代码，要运行到第 999 行得敲多少命令啊。还好，我们还有另一种调试方法。</p>\n<h3 id="pdbset_trace"><a href="#pdbset_trace" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pdb.set_trace()</h3>\n<p>这个方法也是用 pdb，但是不需要单步执行，我们只需要 import pdb，然后，在可能出错的地方放一个 pdb.set_trace()，就可以设置一个断点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63269022035242580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py\nimport pdb\n\ns = \'0\'\nn = int(s)\npdb.set_trace() # 运行到这里会自动暂停\nprint(10 / n)`, `63269022035242580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py</span>\n<span class="token keyword">import</span> pdb\n\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\npdb<span class="token punctuation">.</span>set_trace<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 运行到这里会自动暂停</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行代码，程序会自动在 pdb.set_trace() 暂停并进入 pdb 调试环境，可以用命令 p 查看变量，或者用命令 c 继续运行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81636906830863350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\n> /Users/michael/Github/learn-python3/samples/debug/err.py(7)<module>()\n-> print(10 / n)\n(Pdb) p n\n0\n(Pdb) c\nTraceback (most recent call last):\n  File &quot;err.py&quot;, line 7, in <module>\n    print(10 / n)\nZeroDivisionError: division by zero`, `81636906830863350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p n\n<span class="token number">0</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> c\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err.py"</span>, line <span class="token number">7</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方式比直接启动 pdb 单步调试效率要高很多，但也高不到哪去。</p>\n<h3 id="ide"><a href="#ide" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IDE</h3>\n<p>如果要比较爽地设置断点、单步执行，就需要一个支持调试功能的 IDE。</p>\n<h3 id="小结-14"><a href="#%E5%B0%8F%E7%BB%93-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>写程序最痛苦的事情莫过于调试，程序往往会以你意想不到的流程来运行，你期待执行的语句其实根本没有执行，这时候，就需要调试了。</p>\n<p>虽然用 IDE 调试起来比较方便，但是最后你会发现，logging 才是终极武器。</p>\n<h2 id="单元测试"><a href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单元测试</h2>\n<h2 id="文档测试"><a href="#%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文档测试</h2>\n<h1 id="io-编程"><a href="#io-%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO 编程</h1>\n<p>注意，本章的 IO 编程都是同步模式，异步 IO 由于复杂度太高，后续涉及到服务器端程序开发时我们再讨论。</p>\n<h2 id="文件读写"><a href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件读写</h2>\n<p>读写文件是最常见的 IO 操作。Python 内置了读写文件的函数，用法和 C 是兼容的。</p>\n<h3 id="读文件"><a href="#%E8%AF%BB%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读文件</h3>\n<p>要以读文件的模式打开一个文件对象，使用 Python 内置的 open() 函数，传入文件名和标示符：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55299060061750030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.txt\', \'r\')`, `55299060061750030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>标示符 ‘r’ 表示读，这样，我们就成功地打开了一个文件。</p>\n<p>如果文件不存在，open() 函数就会抛出一个 IOError 的错误，并且给出错误码和详细的信息告诉你文件不存在：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91613116220872930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f=open(\'/Users/michael/notfound.txt\', \'r\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nFileNotFoundError: [Errno 2] No such file or directory: \'/Users/michael/notfound.txt\'`, `91613116220872930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token assign-left variable">f</span><span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string">\'/Users/michael/notfound.txt\'</span>, <span class="token string">\'r\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nFileNotFoundError: <span class="token punctuation">[</span>Errno <span class="token number">2</span><span class="token punctuation">]</span> No such <span class="token function">file</span> or directory: <span class="token string">\'/Users/michael/notfound.txt\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果文件打开成功，接下来，调用 read() 方法可以一次读取文件的全部内容，Python 把内容读到内存，用一个 str 对象表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22587122131298963000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f.read()\n\'Hello, world!\'`, `22587122131298963000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Hello, world!\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>最后一步是调用 close() 方法关闭文件。文件使用完毕后必须关闭，因为文件对象会占用操作系统的资源，并且操作系统同一时间能打开的文件数量也是有限的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32917898566582760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f.close()`, `32917898566582760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于文件读写时都有可能产生 IOError，一旦出错，后面的 f.close() 就不会调用。所以，为了保证无论是否出错都能正确地关闭文件，我们可以使用 try … finally 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15406205556766683000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    f = open(\'/path/to/file\', \'r\')\n    print(f.read())\nfinally:\n    if f:\n        f.close()`, `15406205556766683000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> f<span class="token punctuation">:</span>\n        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是每次都这么写实在太繁琐，所以，Python 引入了 with 语句来自动帮我们调用 close() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67541732115838620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'/path/to/file\', \'r\') as f:\n    print(f.read())`, `67541732115838620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这和前面的 try … finally 是一样的，但是代码更加简洁，并且不必调用 f.close() 方法。</p>\n<p>调用 read() 会一次性读取文件的全部内容，如果文件有 10G，内存就爆了，所以，要保险起见，可以反复调用 read(size) 方法，每次最多读取 size 个字节的内容。另外，调用 readline() 可以每次读取一行内容，调用 readlines() 一次读取所有内容并按行返回 list。因此，要根据需要决定怎么调用。</p>\n<p>如果文件很小，read() 一次性读取最方便；如果不能确定文件大小，反复调用 read(size) 比较保险；如果是配置文件，调用 readlines() 最方便：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33700669545093186000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for line in f.readlines():\n    print(line.strip()) # 把末尾的 \'\\n\' 删掉`, `33700669545093186000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 把末尾的 \'\\n\' 删掉</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="file-like-object"><a href="#file-like-object" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>file-like Object</h3>\n<p>像 open() 函数返回的这种有个 read() 方法的对象，在 Python 中统称为 file-like Object。除了 file 外，还可以是内存的字节流，网络流，自定义流等等。file-like Object 不要求从特定类继承，只要写个 read() 方法就行。</p>\n<p>StringIO 就是在内存中创建的 file-like Object，常用作临时缓冲。</p>\n<h3 id="二进制文件"><a href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二进制文件</h3>\n<p>前面讲的默认都是读取文本文件，并且是 UTF-8 编码的文本文件。要读取二进制文件，比如图片、视频等等，用 ‘rb’ 模式打开文件即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68699372008462850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.jpg\', \'rb\')\n>>> f.read()\nb\'\\xff\\xd8\\xff\\xe1\\x00\\x18Exif\\x00\\x00...\' # 十六进制表示的字节`, `68699372008462850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xff\\xd8\\xff\\xe1\\x00\\x18Exif\\x00\\x00...\'</span> <span class="token comment"># 十六进制表示的字节</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="字符编码-1"><a href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符编码</h3>\n<p>要读取非 UTF-8 编码的文本文件，需要给 open() 函数传入 encoding 参数，例如，读取 GBK 编码的文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73671169167614340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/gbk.txt\', \'r\', encoding=\'gbk\')\n>>> f.read()\n\'测试\'`, `73671169167614340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/gbk.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'gbk\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'测试\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>遇到有些编码不规范的文件，你可能会遇到 UnicodeDecodeError，因为在文本文件中可能夹杂了一些非法编码的字符。遇到这种情况，open() 函数还接收一个 errors 参数，表示如果遇到编码错误后如何处理。最简单的方式是直接忽略：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10187547765972015000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/gbk.txt\', \'r\', encoding=\'gbk\', errors=\'ignore\')`, `10187547765972015000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/gbk.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'gbk\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'ignore\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="写文件"><a href="#%E5%86%99%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写文件</h3>\n<p>写文件和读文件是一样的，唯一区别是调用 open() 函数时，传入标识符 ‘w’ 或者 ‘wb’ 表示写文本文件或写二进制文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93945070173543500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.txt\', \'w\')\n>>> f.write(\'Hello, world!\')\n>>> f.close()`, `93945070173543500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你可以反复调用 write() 来写入文件，但是务必要调用 f.close() 来关闭文件。当我们写文件时，操作系统往往不会立刻把数据写入磁盘，而是放到内存缓存起来，空闲的时候再慢慢写入。只有调用 close() 方法时，操作系统才保证把没有写入的数据全部写入磁盘。忘记调用 close() 的后果是数据可能只写了一部分到磁盘，剩下的丢失了。所以，还是用 with 语句来得保险：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47775404625834850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'/Users/michael/test.txt\', \'w\') as f:\n    f.write(\'Hello, world!\')`, `47775404625834850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要写入特定编码的文本文件，请给 open() 函数传入 encoding 参数，将字符串自动转换成指定编码。</p>\n<p>细心的童鞋会发现，以 ‘w’ 模式写入文件时，如果文件已存在，会直接覆盖（相当于删掉后新写入一个文件）。如果我们希望追加到文件末尾怎么办？可以传入 ‘a’ 以追加（append）模式写入。</p>\n<p>所有模式的定义及含义可以参考 Python 的官方<a href="https://docs.python.org/3/library/functions.html#open" target="_blank" rel="nofollow noreferrer noopener">文档</a>。</p>\n<h3 id="小结-15"><a href="#%E5%B0%8F%E7%BB%93-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>在 Python 中，文件读写是通过 open() 函数打开的文件对象完成的。使用 with 语句操作文件 IO 是个好习惯。</p>\n<h2 id="stringio-和-bytesio"><a href="#stringio-%E5%92%8C-bytesio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StringIO 和 BytesIO</h2>\n<h3 id="stringio"><a href="#stringio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StringIO</h3>\n<p>很多时候，数据读写不一定是文件，也可以在内存中读写。</p>\n<p>StringIO 顾名思义就是在内存中读写 str。</p>\n<p>要把 str 写入 StringIO，我们需要先创建一个 StringIO，然后，像文件一样写入即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77651187659370770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import StringIO\n>>> f = StringIO()\n>>> f.write(\'hello\')\n5\n>>> f.write(\' \')\n1\n>>> f.write(\'world!\')\n6\n>>> print(f.getvalue())\nhello world!`, `77651187659370770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'world!\'</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nhello world!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>getvalue() 方法用于获得写入后的 str。</p>\n<p>要读取 StringIO，可以用一个 str 初始化 StringIO，然后，像读文件一样读取：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51482310383821275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import StringIO\n>>> f = StringIO(\'Hello!\\nHi!\\nGoodbye!\')\n>>> while True:\n...     s = f.readline()\n...     if s == \'\':\n...         break\n...     print(s.strip())\n...\nHello!\nHi!\nGoodbye!`, `51482310383821275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token string">\'Hello!\\nHi!\\nGoodbye!\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">\'\'</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">break</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nHello!\nHi!\nGoodbye!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="bytesio"><a href="#bytesio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BytesIO</h3>\n<p>StringIO 操作的只能是 str，如果要操作二进制数据，就需要使用 BytesIO。</p>\n<p>BytesIO 实现了在内存中读写 bytes，我们创建一个 BytesIO，然后写入一些 bytes：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99793071602893950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import BytesIO\n>>> f = BytesIO()\n>>> f.write(\'中文\'.encode(\'utf-8\'))\n6\n>>> print(f.getvalue())\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'`, `99793071602893950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，写入的不是 str，而是经过 UTF-8 编码的 bytes。</p>\n<p>和 StringIO 类似，可以用一个 bytes 初始化 BytesIO，然后，像读文件一样读取：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39411744657329775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import BytesIO\n>>> f = BytesIO(b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\')\n>>> f.read()\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'`, `39411744657329775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-16"><a href="#%E5%B0%8F%E7%BB%93-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>StringIO 和 BytesIO 是在内存中操作 str 和 bytes 的方法，使得和读写文件具有一致的接口。</p>\n<h2 id="操作文件和目录"><a href="#%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作文件和目录</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95212431943296120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import os\n>>> os.name # 操作系统类型\n\'posix\'`, `95212431943296120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>name <span class="token comment"># 操作系统类型</span>\n<span class="token string">\'posix\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果是 posix，说明系统是 Linux、Unix 或 Mac OS X，如果是 nt，就是 Windows 系统。</p>\n<p>要获取详细的系统信息，可以调用 uname() 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19784979409772840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.uname()\nposix.uname_result(sysname=\'Darwin\', nodename=\'MichaelMacPro.local\', release=\'14.3.0\', version=\'Darwin Kernel Version 14.3.0: Mon Mar 23 11:59:05 PDT 2015; root:xnu-2782.20.48~5/RELEASE_X86_64\', machine=\'x86_64\')`, `19784979409772840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>uname<span class="token punctuation">(</span><span class="token punctuation">)</span>\nposix<span class="token punctuation">.</span>uname_result<span class="token punctuation">(</span>sysname<span class="token operator">=</span><span class="token string">\'Darwin\'</span><span class="token punctuation">,</span> nodename<span class="token operator">=</span><span class="token string">\'MichaelMacPro.local\'</span><span class="token punctuation">,</span> release<span class="token operator">=</span><span class="token string">\'14.3.0\'</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token string">\'Darwin Kernel Version 14.3.0: Mon Mar 23 11:59:05 PDT 2015; root:xnu-2782.20.48~5/RELEASE_X86_64\'</span><span class="token punctuation">,</span> machine<span class="token operator">=</span><span class="token string">\'x86_64\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意 uname() 函数在 Windows 上不提供，也就是说，os 模块的某些函数是跟操作系统相关的。</p>\n<h3 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h3>\n<p>在操作系统中定义的环境变量，全部保存在 os.environ 这个变量中，可以直接查看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90734478279176980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.environ\nenviron({\'VERSIONER_PYTHON_PREFER_32_BIT\': \'no\', \'TERM_PROGRAM_VERSION\': \'326\', \'LOGNAME\': \'michael\', \'USER\': \'michael\', \'PATH\': \'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\', ...})`, `90734478279176980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ\nenviron<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'VERSIONER_PYTHON_PREFER_32_BIT\'</span><span class="token punctuation">:</span> <span class="token string">\'no\'</span><span class="token punctuation">,</span> <span class="token string">\'TERM_PROGRAM_VERSION\'</span><span class="token punctuation">:</span> <span class="token string">\'326\'</span><span class="token punctuation">,</span> <span class="token string">\'LOGNAME\'</span><span class="token punctuation">:</span> <span class="token string">\'michael\'</span><span class="token punctuation">,</span> <span class="token string">\'USER\'</span><span class="token punctuation">:</span> <span class="token string">\'michael\'</span><span class="token punctuation">,</span> <span class="token string">\'PATH\'</span><span class="token punctuation">:</span> <span class="token string">\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要获取某个环境变量的值，可以调用 os.environ.get(‘key’)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38357298416903740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.environ.get(\'PATH\')\n\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'\n>>> os.environ.get(\'x\', \'default\')\n\'default\'`, `38357298416903740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'PATH\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'default\'</span><span class="token punctuation">)</span>\n<span class="token string">\'default\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="操作文件和目录-1"><a href="#%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作文件和目录</h3>\n<p>操作文件和目录的函数一部分放在 os 模块中，一部分放在 os.path 模块中，这一点要注意一下。查看、创建和删除目录可以这么调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76667040505391280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 查看当前目录的绝对路径:\n>>> os.path.abspath(\'.\')\n\'/Users/michael\'\n# 在某个目录下创建一个新目录，首先把新目录的完整路径表示出来:\n>>> os.path.join(\'/Users/michael\', \'testdir\')\n\'/Users/michael/testdir\'\n# 然后创建一个目录:\n>>> os.mkdir(\'/Users/michael/testdir\')\n# 删掉一个目录:\n>>> os.rmdir(\'/Users/michael/testdir\')`, `76667040505391280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 查看当前目录的绝对路径:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/Users/michael\'</span>\n<span class="token comment"># 在某个目录下创建一个新目录，首先把新目录的完整路径表示出来:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">\'/Users/michael\'</span><span class="token punctuation">,</span> <span class="token string">\'testdir\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/Users/michael/testdir\'</span>\n<span class="token comment"># 然后创建一个目录:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 删掉一个目录:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>rmdir<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把两个路径合成一个时，不要直接拼字符串，而要通过 os.path.join() 函数，这样可以正确处理不同操作系统的路径分隔符。在 Linux/Unix/Mac 下，os.path.join() 返回这样的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46302901873203140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`part-1/part-2`, `46302901873203140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">part-1/part-2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>而 Windows 下会返回这样的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5672308678123472000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`part-1\\part-2`, `5672308678123472000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">part-1\\part-2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>同样的道理，要拆分路径时，也不要直接去拆字符串，而要通过 os.path.split() 函数，这样可以把一个路径拆分为两部分，后一部分总是最后级别的目录或文件名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17307142478048630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.path.split(\'/Users/michael/testdir/file.txt\')\n(\'/Users/michael/testdir\', \'file.txt\')`, `17307142478048630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir/file.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">,</span> <span class="token string">\'file.txt\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>os.path.splitext() 可以直接让你得到文件扩展名，很多时候非常方便：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4996333455801794000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.path.splitext(\'/path/to/file.txt\')\n(\'/path/to/file\', \'.txt\')`, `4996333455801794000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span><span class="token string">\'/path/to/file.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'.txt\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这些合并、拆分路径的函数并不要求目录和文件要真实存在，它们只对字符串进行操作。</p>\n<p>文件操作使用下面的函数。假定当前目录下有一个 test.txt 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63587131968583810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 对文件重命名:\n>>> os.rename(\'test.txt\', \'test.py\')\n# 删掉文件:\n>>> os.remove(\'test.py\')`, `63587131968583810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 对文件重命名:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 删掉文件:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">\'test.py\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是复制文件的函数居然在 os 模块中不存在！原因是复制文件并非由操作系统提供的系统调用。理论上讲，我们通过上一节的读写文件可以完成文件复制，只不过要多写很多代码。</p>\n<p>幸运的是 shutil 模块提供了 copyfile() 的函数，你还可以在 shutil 模块中找到很多实用函数，它们可以看做是 os 模块的补充。</p>\n<p>最后看看如何利用 Python 的特性来过滤文件。比如我们要列出当前目录下的所有目录，只需要一行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62579893723487690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in os.listdir(\'.\') if os.path.isdir(x)]\n[\'.lein\', \'.local\', \'.m2\', \'.npm\', \'.ssh\', \'.Trash\', \'.vim\', \'Applications\', \'Desktop\', ...]`, `62579893723487690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'.lein\'</span><span class="token punctuation">,</span> <span class="token string">\'.local\'</span><span class="token punctuation">,</span> <span class="token string">\'.m2\'</span><span class="token punctuation">,</span> <span class="token string">\'.npm\'</span><span class="token punctuation">,</span> <span class="token string">\'.ssh\'</span><span class="token punctuation">,</span> <span class="token string">\'.Trash\'</span><span class="token punctuation">,</span> <span class="token string">\'.vim\'</span><span class="token punctuation">,</span> <span class="token string">\'Applications\'</span><span class="token punctuation">,</span> <span class="token string">\'Desktop\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要列出所有的 .py 文件，也只需一行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55272608490455410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in os.listdir(\'.\') if os.path.isfile(x) and os.path.splitext(x)[1]==\'.py\']\n[\'apis.py\', \'config.py\', \'models.py\', \'pymonitor.py\', \'test_db.py\', \'urls.py\', \'wsgiapp.py\']`, `55272608490455410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">and</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">\'.py\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'apis.py\'</span><span class="token punctuation">,</span> <span class="token string">\'config.py\'</span><span class="token punctuation">,</span> <span class="token string">\'models.py\'</span><span class="token punctuation">,</span> <span class="token string">\'pymonitor.py\'</span><span class="token punctuation">,</span> <span class="token string">\'test_db.py\'</span><span class="token punctuation">,</span> <span class="token string">\'urls.py\'</span><span class="token punctuation">,</span> <span class="token string">\'wsgiapp.py\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>是不是非常简洁？</p>\n<h3 id="小结-17"><a href="#%E5%B0%8F%E7%BB%93-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的 os 模块封装了操作系统的目录和文件操作，要注意这些函数有的在 os 模块中，有的在 os.path 模块中。</p>\n<h2 id="序列化"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化</h2>\n<p>在程序运行的过程中，所有的变量都是在内存中，比如，定义一个 dict：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16030905110386252000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`d = dict(name=\'Bob\', age=20, score=88)`, `16030905110386252000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以随时修改变量，比如把 name 改成 ‘Bill’，但是一旦程序结束，变量所占用的内存就被操作系统全部回收。如果没有把修改后的 ‘Bill’ 存储到磁盘上，下次重新运行程序，变量又被初始化为 ‘Bob’。</p>\n<p>我们把变量从内存中变成可存储或传输的过程称之为序列化，在 Python 中叫 pickling，在其他语言中也被称之为 serialization，marshalling，flattening 等等，都是一个意思。</p>\n<p>序列化之后，就可以把序列化后的内容写入磁盘，或者通过网络传输到别的机器上。</p>\n<p>反过来，把变量内容从序列化的对象重新读到内存里称之为反序列化，即 unpickling。</p>\n<p>Python 提供了 pickle 模块来实现序列化。</p>\n<p>首先，我们尝试把一个对象序列化并写入文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57945239147129860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import pickle\n>>> d = dict(name=\'Bob\', age=20, score=88)\n>>> pickle.dumps(d)\nb\'\\x80\\x03}q\\x00(X\\x03\\x00\\x00\\x00ageq\\x01K\\x14X\\x05\\x00\\x00\\x00scoreq\\x02KXX\\x04\\x00\\x00\\x00nameq\\x03X\\x03\\x00\\x00\\x00Bobq\\x04u.\'`, `57945239147129860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> pickle\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>d<span class="token punctuation">)</span>\n<span class="token string">b\'\\x80\\x03}q\\x00(X\\x03\\x00\\x00\\x00ageq\\x01K\\x14X\\x05\\x00\\x00\\x00scoreq\\x02KXX\\x04\\x00\\x00\\x00nameq\\x03X\\x03\\x00\\x00\\x00Bobq\\x04u.\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>pickle.dumps() 方法把任意对象序列化成一个 bytes，然后，就可以把这个 bytes 写入文件。或者用另一个方法 pickle.dump() 直接把对象序列化后写入一个 file-like Object：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96653635010358950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'dump.txt\', \'wb\')\n>>> pickle.dump(d, f)\n>>> f.close()`, `96653635010358950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'dump.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'wb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>d<span class="token punctuation">,</span> f<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>看看写入的 dump.txt 文件，一堆乱七八糟的内容，这些都是 Python 保存的对象内部信息。</p>\n<p>当我们要把对象从磁盘读到内存时，可以先把内容读到一个 bytes，然后用 pickle.loads() 方法反序列化出对象，也可以直接用 pickle.load() 方法从一个 file-like Object 中直接反序列化出对象。我们打开另一个 Python 命令行来反序列化刚才保存的对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55137481060062730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'dump.txt\', \'rb\')\n>>> d = pickle.load(f)\n>>> f.close()\n>>> d\n{\'age\': 20, \'score\': 88, \'name\': \'Bob\'}`, `55137481060062730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'dump.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d\n<span class="token punctuation">{</span><span class="token string">\'age\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>变量的内容又回来了！</p>\n<p>当然，这个变量和原来的变量是完全不相干的对象，它们只是内容相同而已。</p>\n<p>Pickle 的问题和所有其他编程语言特有的序列化问题一样，就是它只能用于 Python，并且可能不同版本的 Python 彼此都不兼容，因此，只能用 Pickle 保存那些不重要的数据，不能成功地反序列化也没关系。</p>\n<h3 id="json"><a href="#json" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSON</h3>\n<p>如果我们要在不同的编程语言之间传递对象，就必须把对象序列化为标准格式，比如 XML，但更好的方法是序列化为 JSON，因为 JSON 表示出来就是一个字符串，可以被所有语言读取，也可以方便地存储到磁盘或者通过网络传输。JSON 不仅是标准格式，并且比 XML 更快，而且可以直接在 Web 页面中读取，非常方便。</p>\n<p>JSON 表示的对象就是标准的 JavaScript 语言的对象，JSON 和 Python 内置的数据类型对应如下：</p>\n<table>\n<thead>\n<tr>\n<th align="left">JSON 类型</th>\n<th align="left">Python 类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">{}</td>\n<td align="left">dict</td>\n</tr>\n<tr>\n<td align="left">[]</td>\n<td align="left">list</td>\n</tr>\n<tr>\n<td align="left">“string”</td>\n<td align="left">str</td>\n</tr>\n<tr>\n<td align="left">1234.56</td>\n<td align="left">int 或 float</td>\n</tr>\n<tr>\n<td align="left">true/false</td>\n<td align="left">True/False</td>\n</tr>\n<tr>\n<td align="left">null</td>\n<td align="left">None</td>\n</tr>\n</tbody>\n</table>\n<p>Python 内置的 json 模块提供了非常完善的 Python 对象到 JSON 格式的转换。我们先看看如何把 Python 对象变成一个 JSON：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98506326689470870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import json\n>>> d = dict(name=\'Bob\', age=20, score=88)\n>>> json.dumps(d)\n\'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'`, `98506326689470870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> json\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>d<span class="token punctuation">)</span>\n<span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>dumps() 方法返回一个 str，内容就是标准的 JSON。类似的，dump() 方法可以直接把 JSON 写入一个 file-like Object。</p>\n<p>要把 JSON 反序列化为 Python 对象，用 loads() 或者对应的 load() 方法，前者把 JSON 的字符串反序列化，后者从 file-like Object 中读取字符串并反序列化：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41692054523073920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> json_str = \'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'\n>>> json.loads(json_str)\n{\'age\': 20, \'score\': 88, \'name\': \'Bob\'}`, `41692054523073920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> json_str <span class="token operator">=</span> <span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span>\n<span class="token operator">>></span><span class="token operator">></span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'age\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于 JSON 标准规定 JSON 编码是 UTF-8，所以我们总是能正确地在 Python 的 str 与 JSON 的字符串之间转换。</p>\n<h3 id="json-进阶"><a href="#json-%E8%BF%9B%E9%98%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSON 进阶</h3>\n<p>Python 的 dict 对象可以直接序列化为 JSON 的 {}，不过，很多时候，我们更喜欢用 class 表示对象，比如定义 Student 类，然后序列化：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83620545004777900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\nclass Student(object):\n    def __init__(self, name, age, score):\n        self.name = name\n        self.age = age\n        self.score = score\n\ns = Student(\'Bob\', 20, 88)\nprint(json.dumps(s))`, `83620545004777900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\ns <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行代码，毫不留情地得到一个 TypeError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40839171288684590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  ...\nTypeError: <__main__.Student object at 0x10603cc50> is not JSON serializable`, `40839171288684590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nTypeError: <span class="token operator">&lt;</span>__main__.Student object at 0x10603cc5<span class="token operator"><span class="token file-descriptor important">0</span>></span> is not JSON serializable</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>错误的原因是 Student 对象不是一个可序列化为 JSON 的对象。</p>\n<p>如果连 class 的实例对象都无法序列化为 JSON，这肯定不合理！</p>\n<p>别急，我们仔细看看 dumps() 方法的参数列表，可以发现，除了第一个必须的 obj 参数外，dumps() 方法还提供了一大堆的可选<a href="https://docs.python.org/3/library/json.html#json.dumps" target="_blank" rel="nofollow noreferrer noopener">参数</a></p>\n<p>这些可选参数就是让我们来定制 JSON 序列化。前面的代码之所以无法把 Student 类实例序列化为 JSON，是因为默认情况下，dumps() 方法不知道如何将 Student 实例变为一个 JSON 的 {} 对象。</p>\n<p>可选参数 default 就是把任意一个对象变成一个可序列为 JSON 的对象，我们只需要为 Student 专门写一个转换函数，再把函数传进去即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75576826193591140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def student2dict(std):\n    return {\n        \'name\': std.name,\n        \'age\': std.age,\n        \'score\': std.score\n    }`, `75576826193591140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">student2dict</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">\'name\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>name<span class="token punctuation">,</span>\n        <span class="token string">\'age\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>age<span class="token punctuation">,</span>\n        <span class="token string">\'score\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>score\n    <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，Student 实例首先被 student2dict() 函数转换成 dict，然后再被顺利序列化为 JSON：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71002395465765280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> print(json.dumps(s, default=student2dict))\n{&quot;age&quot;: 20, &quot;name&quot;: &quot;Bob&quot;, &quot;score&quot;: 88}`, `71002395465765280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">,</span> default<span class="token operator">=</span>student2dict<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>不过，下次如果遇到一个 Teacher 类的实例，照样无法序列化为 JSON。我们可以偷个懒，把任意 class 的实例变为 dict：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82514561622641460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(json.dumps(s, default=lambda obj: obj.__dict__))`, `82514561622641460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token keyword">lambda</span> obj<span class="token punctuation">:</span> obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>因为通常 class 的实例都有一个 <code class="language-text">__dict__</code> 属性，它就是一个 dict，用来存储实例变量。也有少数例外，比如定义了 <code class="language-text">__slots__</code> 的 class。</p>\n<p>同样的道理，如果我们要把 JSON 反序列化为一个 Student 对象实例，loads() 方法首先转换出一个 dict 对象，然后，我们传入的 object_hook 函数负责把 dict 转换为 Student 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40971908312734960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def dict2student(d):\n    return Student(d[\'name\'], d[\'age\'], d[\'score\'])`, `40971908312734960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">dict2student</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> Student<span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">\'score\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69808728968390566000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> json_str = \'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'\n>>> print(json.loads(json_str, object_hook=dict2student))\n<__main__.Student object at 0x10cd3c190>`, `69808728968390566000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> json_str <span class="token operator">=</span> <span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">,</span> object_hook<span class="token operator">=</span>dict2student<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x10cd3c190</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>打印出的是反序列化的 Student 实例对象。</p>\n<h3 id="小结-18"><a href="#%E5%B0%8F%E7%BB%93-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 语言特定的序列化模块是 pickle，但如果要把序列化搞得更通用、更符合 Web 标准，就可以使用 json 模块。</p>\n<p>json 模块的 dumps() 和 loads() 函数是定义得非常好的接口的典范。当我们使用时，只需要传入一个必须的参数。但是，当默认的序列化或反序列机制不满足我们的要求时，我们又可以传入更多的参数来定制序列化或反序列化的规则，既做到了接口简单易用，又做到了充分的扩展性和灵活性。</p>\n<h1 id="进程和线程"><a href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程和线程</h1>\n<h2 id="多进程"><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多进程</h2>\n<p>要让 Python 程序实现多进程（multiprocessing），我们先了解操作系统的相关知识。</p>\n<p>Unix/Linux 操作系统提供了一个 fork() 系统调用，它非常特殊。普通的函数调用，调用一次，返回一次，但是 fork() 调用一次，返回两次，因为操作系统自动把当前进程（称为父进程）复制了一份（称为子进程），然后，分别在父进程和子进程内返回。</p>\n<p>子进程永远返回 0，而父进程返回子进程的 ID。这样做的理由是，一个父进程可以 fork 出很多子进程，所以，父进程要记下每个子进程的 ID，而子进程只需要调用 getppid() 就可以拿到父进程的 ID。</p>\n<p>Python 的 os 模块封装了常见的系统调用，其中就包括 fork，可以在 Python 程序中轻松创建子进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55463447861133380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import os\n\nprint(\'Process (%s) start...\' % os.getpid())\n# Only works on Unix/Linux/Mac:\npid = os.fork()\nif pid == 0:\n    print(\'I am child process (%s) and my parent is %s.\' % (os.getpid(), os.getppid()))\nelse:\n    print(\'I (%s) just created a child process (%s).\' % (os.getpid(), pid))`, `55463447861133380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> os\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process (%s) start...\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment"># Only works on Unix/Linux/Mac:</span>\npid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I am child process (%s) and my parent is %s.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I (%s) just created a child process (%s).\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29355426731154990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Process (876) start...\nI (876) just created a child process (877).\nI am child process (877) and my parent is 876.`, `29355426731154990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Process <span class="token punctuation">(</span><span class="token number">876</span><span class="token punctuation">)</span> start<span class="token punctuation">..</span>.\nI <span class="token punctuation">(</span><span class="token number">876</span><span class="token punctuation">)</span> just created a child process <span class="token punctuation">(</span><span class="token number">877</span><span class="token punctuation">)</span>.\nI am child process <span class="token punctuation">(</span><span class="token number">877</span><span class="token punctuation">)</span> and my parent is <span class="token number">876</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于 Windows 没有 fork 调用，上面的代码在 Windows 上无法运行。</p>\n<p>有了 fork 调用，一个进程在接到新任务时就可以复制出一个子进程来处理新任务，常见的 Apache 服务器就是由父进程监听端口，每当有新的 http 请求时，就 fork 出子进程来处理新的 http 请求。</p>\n<h3 id="multiprocessing"><a href="#multiprocessing" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>multiprocessing</h3>\n<p>如果你打算编写多进程的服务程序，Unix/Linux 无疑是正确的选择。由于 Windows 没有 fork 调用，难道在 Windows 上无法用 Python 编写多进程的程序？</p>\n<p>由于 Python 是跨平台的，自然也应该提供一个跨平台的多进程支持。multiprocessing 模块就是跨平台版本的多进程模块。</p>\n<p>multiprocessing 模块提供了一个 Process 类来代表一个进程对象，下面的例子演示了启动一个子进程并等待其结束：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94875505788385890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Process\nimport os\n\n# 子进程要执行的代码\ndef run_proc(name):\n    print(\'Run child process %s (%s)...\' % (name, os.getpid()))\n\nif __name__==\'__main__\':\n    print(\'Parent process %s.\' % os.getpid())\n    p = Process(target=run_proc, args=(\'test\',))\n    print(\'Child process will start.\')\n    p.start()\n    p.join()\n    print(\'Child process end.\')`, `94875505788385890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process\n<span class="token keyword">import</span> os\n\n<span class="token comment"># 子进程要执行的代码</span>\n<span class="token keyword">def</span> <span class="token function">run_proc</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Run child process %s (%s)...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent process %s.\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>run_proc<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child process will start.\'</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child process end.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30645089200281215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Parent process 928.\nChild process will start.\nRun child process test (929)...\nProcess end.`, `30645089200281215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Parent process <span class="token number">928</span>.\nChild process will start.\nRun child process <span class="token builtin class-name">test</span> <span class="token punctuation">(</span><span class="token number">929</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nProcess end.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建子进程时，只需要传入一个执行函数和函数的参数，创建一个 Process 实例，用 start() 方法启动，这样创建进程比 fork() 还要简单。</p>\n<p>join() 方法可以等待子进程结束后再继续往下运行，通常用于进程间的同步。</p>\n<h3 id="pool"><a href="#pool" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pool</h3>\n<p>如果要启动大量的子进程，可以用进程池的方式批量创建子进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89319498081180290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Pool\nimport os, time, random\n\ndef long_time_task(name):\n    print(\'Run task %s (%s)...\' % (name, os.getpid()))\n    start = time.time()\n    time.sleep(random.random() * 3)\n    end = time.time()\n    print(\'Task %s runs %0.2f seconds.\' % (name, (end - start)))\n\nif __name__==\'__main__\':\n    print(\'Parent process %s.\' % os.getpid())\n    p = Pool(4)\n    for i in range(5):\n        p.apply_async(long_time_task, args=(i,))\n    print(\'Waiting for all subprocesses done...\')\n    p.close()\n    p.join()\n    print(\'All subprocesses done.\')`, `89319498081180290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool\n<span class="token keyword">import</span> os<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random\n\n<span class="token keyword">def</span> <span class="token function">long_time_task</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Run task %s (%s)...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Task %s runs %0.2f seconds.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent process %s.\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>long_time_task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Waiting for all subprocesses done...\'</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'All subprocesses done.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30334397949538226000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Parent process 669.\nWaiting for all subprocesses done...\nRun task 0 (671)...\nRun task 1 (672)...\nRun task 2 (673)...\nRun task 3 (674)...\nTask 2 runs 0.14 seconds.\nRun task 4 (673)...\nTask 1 runs 0.27 seconds.\nTask 3 runs 0.86 seconds.\nTask 0 runs 1.41 seconds.\nTask 4 runs 1.91 seconds.\nAll subprocesses done.`, `30334397949538226000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Parent process <span class="token number">669</span>.\nWaiting <span class="token keyword">for</span> all subprocesses done<span class="token punctuation">..</span>.\nRun task <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">671</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">672</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">673</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">674</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nTask <span class="token number">2</span> runs <span class="token number">0.14</span> seconds.\nRun task <span class="token number">4</span> <span class="token punctuation">(</span><span class="token number">673</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nTask <span class="token number">1</span> runs <span class="token number">0.27</span> seconds.\nTask <span class="token number">3</span> runs <span class="token number">0.86</span> seconds.\nTask <span class="token number">0</span> runs <span class="token number">1.41</span> seconds.\nTask <span class="token number">4</span> runs <span class="token number">1.91</span> seconds.\nAll subprocesses done.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>代码解读：</p>\n<p>对 Pool 对象调用 join() 方法会等待所有子进程执行完毕，调用 join() 之前必须先调用 close()，调用 close() 之后就不能继续添加新的 Process 了。</p>\n<p>请注意输出的结果，task 0，1，2，3 是立刻执行的，而 task 4 要等待前面某个 task 完成后才执行，这是因为 Pool 的默认大小在我的电脑上是 4，因此，最多同时执行 4 个进程。这是 Pool 有意设计的限制，并不是操作系统的限制。如果改成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22072834662433706000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`p = Pool(5)`, `22072834662433706000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">p = Pool(5)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就可以同时跑 5 个进程。</p>\n<p>由于 Pool 的默认大小是 CPU 的核数，如果你不幸拥有 8 核 CPU，你要提交至少 9 个子进程才能看到上面的等待效果。</p>\n<h3 id="子进程"><a href="#%E5%AD%90%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子进程</h3>\n<p>很多时候，子进程并不是自身，而是一个外部进程。我们创建了子进程后，还需要控制子进程的输入和输出。</p>\n<p>subprocess 模块可以让我们非常方便地启动一个子进程，然后控制其输入和输出。</p>\n<p>下面的例子演示了如何在 Python 代码中运行命令 nslookup www.python.org，这和命令行直接运行的效果是一样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11280642070805236000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nprint(\'\\$ nslookup www.python.org\')\nr = subprocess.call([\'nslookup\', \'www.python.org\'])\nprint(\'Exit code:\', r)`, `11280642070805236000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'$ nslookup www.python.org\'</span><span class="token punctuation">)</span>\nr <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'nslookup\'</span><span class="token punctuation">,</span> <span class="token string">\'www.python.org\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit code:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32826117546093347000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ nslookup www.python.org\nServer:  192.168.19.4\nAddress: 192.168.19.4#53\n\nNon-authoritative answer:\nwww.python.org canonical name = python.map.fastly.net.\nName: python.map.fastly.net\nAddress: 199.27.79.223\n\nExit code: 0`, `32826117546093347000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">nslookup</span> www.python.org\nServer:  <span class="token number">192.168</span>.19.4\nAddress: <span class="token number">192.168</span>.19.4<span class="token comment">#53</span>\n\nNon-authoritative answer:\nwww.python.org canonical name <span class="token operator">=</span> python.map.fastly.net.\nName: python.map.fastly.net\nAddress: <span class="token number">199.27</span>.79.223\n\nExit code: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果子进程还需要输入，则可以通过 communicate() 方法输入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99932474243396800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nprint(\'\\$ nslookup\')\np = subprocess.Popen([\'nslookup\'], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\noutput, err = p.communicate(b\'set q=mx\\npython.org\\nexit\\n\')\nprint(output.decode(\'utf-8\'))\nprint(\'Exit code:\', p.returncode)`, `99932474243396800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'$ nslookup\'</span><span class="token punctuation">)</span>\np <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'nslookup\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>\noutput<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token string">b\'set q=mx\\npython.org\\nexit\\n\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit code:\'</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>returncode<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码相当于在命令行执行命令 nslookup，然后手动输入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67078065592135710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set q=mx\npython.org\nexit`, `67078065592135710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token assign-left variable">q</span><span class="token operator">=</span>mx\npython.org\n<span class="token builtin class-name">exit</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32820330664264176000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ nslookup\nServer:  192.168.19.4\nAddress: 192.168.19.4#53\n\nNon-authoritative answer:\npython.org mail exchanger = 50 mail.python.org.\n\nAuthoritative answers can be found from:\nmail.python.org internet address = 82.94.164.166\nmail.python.org has AAAA address 2001:888:2000:d::a6\n\n\nExit code: 0`, `32820330664264176000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">nslookup</span>\nServer:  <span class="token number">192.168</span>.19.4\nAddress: <span class="token number">192.168</span>.19.4<span class="token comment">#53</span>\n\nNon-authoritative answer:\npython.org mail exchanger <span class="token operator">=</span> <span class="token number">50</span> mail.python.org.\n\nAuthoritative answers can be found from:\nmail.python.org internet address <span class="token operator">=</span> <span class="token number">82.94</span>.164.166\nmail.python.org has AAAA address <span class="token number">2001</span>:888:2000:d::a6\n\n\nExit code: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="进程间通信"><a href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程间通信</h3>\n<p>Process 之间肯定是需要通信的，操作系统提供了很多机制来实现进程间的通信。Python 的 multiprocessing 模块包装了底层的机制，提供了 Queue、Pipes 等多种方式来交换数据。</p>\n<p>我们以 Queue 为例，在父进程中创建两个子进程，一个往 Queue 里写数据，一个从 Queue 里读数据：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85581263091261080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Process, Queue\nimport os, time, random\n\n# 写数据进程执行的代码:\ndef write(q):\n    print(\'Process to write: %s\' % os.getpid())\n    for value in [\'A\', \'B\', \'C\']:\n        print(\'Put %s to queue...\' % value)\n        q.put(value)\n        time.sleep(random.random())\n\n# 读数据进程执行的代码:\ndef read(q):\n    print(\'Process to read: %s\' % os.getpid())\n    while True:\n        value = q.get(True)\n        print(\'Get %s from queue.\' % value)\n\nif __name__==\'__main__\':\n    # 父进程创建 Queue，并传给各个子进程：\n    q = Queue()\n    pw = Process(target=write, args=(q,))\n    pr = Process(target=read, args=(q,))\n    # 启动子进程 pw，写入:\n    pw.start()\n    # 启动子进程 pr，读取:\n    pr.start()\n    # 等待 pw 结束:\n    pw.join()\n    # pr 进程里是死循环，无法等待其结束，只能强行终止:\n    pr.terminate()`, `85581263091261080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue\n<span class="token keyword">import</span> os<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random\n\n<span class="token comment"># 写数据进程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process to write: %s\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Put %s to queue...\'</span> <span class="token operator">%</span> value<span class="token punctuation">)</span>\n        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 读数据进程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process to read: %s\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Get %s from queue.\'</span> <span class="token operator">%</span> value<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token comment"># 父进程创建 Queue，并传给各个子进程：</span>\n    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    pw <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>write<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    pr <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>read<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment"># 启动子进程 pw，写入:</span>\n    pw<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># 启动子进程 pr，读取:</span>\n    pr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># 等待 pw 结束:</span>\n    pw<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># pr 进程里是死循环，无法等待其结束，只能强行终止:</span>\n    pr<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80499592920536700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Process to write: 50563\nPut A to queue...\nProcess to read: 50564\nGet A from queue.\nPut B to queue...\nGet B from queue.\nPut C to queue...\nGet C from queue.`, `80499592920536700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Process to write: <span class="token number">50563</span>\nPut A to queue<span class="token punctuation">..</span>.\nProcess to read: <span class="token number">50564</span>\nGet A from queue.\nPut B to queue<span class="token punctuation">..</span>.\nGet B from queue.\nPut C to queue<span class="token punctuation">..</span>.\nGet C from queue.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Unix/Linux 下，multiprocessing 模块封装了 fork() 调用，使我们不需要关注 fork() 的细节。由于 Windows 没有 fork 调用，因此，multiprocessing 需要“模拟”出 fork 的效果，父进程所有 Python 对象都必须通过 pickle 序列化再传到子进程去，所以，如果 multiprocessing 在 Windows 下调用失败了，要先考虑是不是 pickle 失败了。</p>\n<h3 id="小结-19"><a href="#%E5%B0%8F%E7%BB%93-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>在 Unix/Linux 下，可以使用 fork() 调用实现多进程。</p>\n<p>要实现跨平台的多进程，可以使用 multiprocessing 模块。</p>\n<p>进程间通信是通过 Queue、Pipes 等实现的。</p>\n<h2 id="多线程"><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多线程</h2>\n<p>多任务可以由多进程完成，也可以由一个进程内的多线程完成。</p>\n<p>由于线程是操作系统直接支持的执行单元，因此，高级语言通常都内置多线程的支持，Python 也不例外，并且，Python 的线程是真正的 Posix Thread，而不是模拟出来的线程。</p>\n<p>Python 的标准库提供了两个模块：<code class="language-text">_thread</code> 和 threading，<code class="language-text">_thread</code> 是低级模块，threading 是高级模块，对 <code class="language-text">_thread</code> 进行了封装。绝大多数情况下，我们只需要使用 threading 这个高级模块。</p>\n<p>启动一个线程就是把一个函数传入并创建 Thread 实例，然后调用 start() 开始执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10094089380241523000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time, threading\n\n# 新线程执行的代码:\ndef loop():\n    print(\'thread %s is running...\' % threading.current_thread().name)\n    n = 0\n    while n < 5:\n        n = n + 1\n        print(\'thread %s >>> %s\' % (threading.current_thread().name, n))\n        time.sleep(1)\n    print(\'thread %s ended.\' % threading.current_thread().name)\n\nprint(\'thread %s is running...\' % threading.current_thread().name)\nt = threading.Thread(target=loop, name=\'LoopThread\')\nt.start()\nt.join()\nprint(\'thread %s ended.\' % threading.current_thread().name)`, `10094089380241523000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time<span class="token punctuation">,</span> threading\n\n<span class="token comment"># 新线程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s is running...\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n    n <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s >>> %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s ended.\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s is running...\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nt <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'LoopThread\'</span><span class="token punctuation">)</span>\nt<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s ended.\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于任何进程默认就会启动一个线程，我们把该线程称为主线程，主线程又可以启动新的线程，Python 的 threading 模块有个 current_thread() 函数，它永远返回当前线程的实例。主线程实例的名字叫 MainThread，子线程的名字在创建时指定，我们用 LoopThread 命名子线程。名字仅仅在打印时用来显示，完全没有其他意义，如果不起名字 Python 就自动给线程命名为 Thread-1，Thread-2……</p>\n<h3 id="lock"><a href="#lock" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lock</h3>\n<p>多线程和多进程最大的不同在于，多进程中，同一个变量，各自有一份拷贝存在于每个进程中，互不影响，而多线程中，所有变量都由所有线程共享，所以，任何一个变量都可以被任何一个线程修改，因此，线程之间共享数据最大的危险在于多个线程同时改一个变量，把内容给改乱了。</p>\n<p>来看看多个线程同时操作一个变量怎么把内容给改乱了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81556862455584880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time, threading\n\n# 假定这是你的银行存款:\nbalance = 0\n\ndef change_it(n):\n    # 先存后取，结果应该为 0:\n    global balance\n    balance = balance + n\n    balance = balance - n\n\ndef run_thread(n):\n    for i in range(2000000):\n        change_it(n)\n\nt1 = threading.Thread(target=run_thread, args=(5,))\nt2 = threading.Thread(target=run_thread, args=(8,))\nt1.start()\nt2.start()\nt1.join()\nt2.join()\nprint(balance)`, `81556862455584880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time<span class="token punctuation">,</span> threading\n\n<span class="token comment"># 假定这是你的银行存款:</span>\nbalance <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">def</span> <span class="token function">change_it</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 先存后取，结果应该为 0:</span>\n    <span class="token keyword">global</span> balance\n    balance <span class="token operator">=</span> balance <span class="token operator">+</span> n\n    balance <span class="token operator">=</span> balance <span class="token operator">-</span> n\n\n<span class="token keyword">def</span> <span class="token function">run_thread</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        change_it<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n\nt1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nt2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们定义了一个共享变量 balance，初始值为 0，并且启动两个线程，先存后取，理论上结果应该为 0，但是，由于线程的调度是由操作系统决定的，当 t1、t2 交替执行时，只要循环次数足够多，balance 的结果就不一定是 0 了。</p>\n<p>原因是因为高级语言的一条语句在 CPU 执行时是若干条语句，即使一个简单的计算：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93952897286671930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`balance = balance + n`, `93952897286671930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">balance <span class="token operator">=</span> balance <span class="token operator">+</span> n</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也分两步：</p>\n<ol>\n<li>计算 balance + n，存入临时变量中；</li>\n<li>将临时变量的值赋给 balance。</li>\n</ol>\n<p>也就是可以看成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77322704697187700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = balance + n\nbalance = x`, `77322704697187700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> balance <span class="token operator">+</span> n\nbalance <span class="token operator">=</span> x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于 x 是局部变量，两个线程各自都有自己的 x，当代码正常执行时：</p>\n<p>初始值 balance = 0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30240159796958265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`t1: x1 = balance + 5 # x1 = 0 + 5 = 5\nt1: balance = x1     # balance = 5\nt1: x1 = balance - 5 # x1 = 5 - 5 = 0\nt1: balance = x1     # balance = 0\n\nt2: x2 = balance + 8 # x2 = 0 + 8 = 8\nt2: balance = x2     # balance = 8\nt2: x2 = balance - 8 # x2 = 8 - 8 = 0\nt2: balance = x2     # balance = 0\n\n结果 balance = 0`, `30240159796958265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">t1: x1 = balance + 5 # x1 = 0 + 5 = 5\nt1: balance = x1     # balance = 5\nt1: x1 = balance - 5 # x1 = 5 - 5 = 0\nt1: balance = x1     # balance = 0\n\nt2: x2 = balance + 8 # x2 = 0 + 8 = 8\nt2: balance = x2     # balance = 8\nt2: x2 = balance - 8 # x2 = 8 - 8 = 0\nt2: balance = x2     # balance = 0\n\n结果 balance = 0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 t1 和 t2 是交替运行的，如果操作系统以下面的顺序执行 t1、t2：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78525945346836350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`初始值 balance = 0\n\nt1: x1 = balance + 5  # x1 = 0 + 5 = 5\n\nt2: x2 = balance + 8  # x2 = 0 + 8 = 8\nt2: balance = x2      # balance = 8\n\nt1: balance = x1      # balance = 5\nt1: x1 = balance - 5  # x1 = 5 - 5 = 0\nt1: balance = x1      # balance = 0\n\nt2: x2 = balance - 8  # x2 = 0 - 8 = -8\nt2: balance = x2      # balance = -8\n\n结果 balance = -8`, `78525945346836350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">初始值 balance = 0\n\nt1: x1 = balance + 5  # x1 = 0 + 5 = 5\n\nt2: x2 = balance + 8  # x2 = 0 + 8 = 8\nt2: balance = x2      # balance = 8\n\nt1: balance = x1      # balance = 5\nt1: x1 = balance - 5  # x1 = 5 - 5 = 0\nt1: balance = x1      # balance = 0\n\nt2: x2 = balance - 8  # x2 = 0 - 8 = -8\nt2: balance = x2      # balance = -8\n\n结果 balance = -8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>究其原因，是因为修改 balance 需要多条语句，而执行这几条语句时，线程可能中断，从而导致多个线程把同一个对象的内容改乱了。</p>\n<p>两个线程同时一存一取，就可能导致余额不对，你肯定不希望你的银行存款莫名其妙地变成了负数，所以，我们必须确保一个线程在修改 balance 的时候，别的线程一定不能改。</p>\n<p>如果我们要确保 balance 计算正确，就要给 <code class="language-text">change_it()</code> 上一把锁，当某个线程开始执行 <code class="language-text">change_it()</code> 时，我们说，该线程因为获得了锁，因此其他线程不能同时执行 <code class="language-text">change_it()</code>，只能等待，直到锁被释放后，获得该锁以后才能改。由于锁只有一个，无论多少线程，同一时刻最多只有一个线程持有该锁，所以，不会造成修改的冲突。创建一个锁就是通过 threading.Lock() 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26018491082881590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`balance = 0\nlock = threading.Lock()\n\ndef run_thread(n):\n    for i in range(100000):\n        # 先要获取锁:\n        lock.acquire()\n        try:\n            # 放心地改吧:\n            change_it(n)\n        finally:\n            # 改完了一定要释放锁:\n            lock.release()`, `26018491082881590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">balance <span class="token operator">=</span> <span class="token number">0</span>\nlock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">run_thread</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 先要获取锁:</span>\n        lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token comment"># 放心地改吧:</span>\n            change_it<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token comment"># 改完了一定要释放锁:</span>\n            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当多个线程同时执行 lock.acquire() 时，只有一个线程能成功地获取锁，然后继续执行代码，其他线程就继续等待直到获得锁为止。</p>\n<p>获得锁的线程用完后一定要释放锁，否则那些苦苦等待锁的线程将永远等待下去，成为死线程。所以我们用 try…finally 来确保锁一定会被释放。</p>\n<p>锁的好处就是确保了某段关键代码只能由一个线程从头到尾完整地执行，坏处当然也很多，首先是阻止了多线程并发执行，包含锁的某段代码实际上只能以单线程模式执行，效率就大大地下降了。其次，由于可以存在多个锁，不同的线程持有不同的锁，并试图获取对方持有的锁时，可能会造成死锁，导致多个线程全部挂起，既不能执行，也无法结束，只能靠操作系统强制终止。</p>\n<h3 id="多核-cpu"><a href="#%E5%A4%9A%E6%A0%B8-cpu" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多核 CPU</h3>\n<p>如果你不幸拥有一个多核 CPU，你肯定在想，多核应该可以同时执行多个线程。</p>\n<p>如果写一个死循环的话，会出现什么情况呢？</p>\n<p>打开 Mac OS X 的 Activity Monitor，或者 Windows 的 Task Manager，都可以监控某个进程的 CPU 使用率。</p>\n<p>我们可以监控到一个死循环线程会 100% 占用一个 CPU。</p>\n<p>如果有两个死循环线程，在多核 CPU 中，可以监控到会占用 200% 的 CPU，也就是占用两个 CPU 核心。</p>\n<p>要想把 N 核 CPU 的核心全部跑满，就必须启动 N 个死循环线程。</p>\n<p>试试用 Python 写个死循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45623838947002390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading, multiprocessing\n\ndef loop():\n    x = 0\n    while True:\n        x = x ^ 1\n\nfor i in range(multiprocessing.cpu_count()):\n    t = threading.Thread(target=loop)\n    t.start()`, `45623838947002390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading<span class="token punctuation">,</span> multiprocessing\n\n<span class="token keyword">def</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        x <span class="token operator">=</span> x <span class="token operator">^</span> <span class="token number">1</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop<span class="token punctuation">)</span>\n    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>启动与 CPU 核心数量相同的 N 个线程，在 4 核 CPU 上可以监控到 CPU 占用率仅有 102%，也就是仅使用了一核。</p>\n<p>但是用 C、C++或 Java 来改写相同的死循环，直接可以把全部核心跑满，4 核就跑到 400%，8 核就跑到 800%，为什么 Python 不行呢？</p>\n<p>因为 Python 的线程虽然是真正的线程，但解释器执行代码时，有一个 GIL 锁：Global Interpreter Lock，任何 Python 线程执行前，必须先获得 GIL 锁，然后，每执行 100 条字节码，解释器就自动释放 GIL 锁，让别的线程有机会执行。这个 GIL 全局锁实际上把所有线程的执行代码都给上了锁，所以，多线程在 Python 中只能交替执行，即使 100 个线程跑在 100 核 CPU 上，也只能用到 1 个核。</p>\n<p>GIL 是 Python 解释器设计的历史遗留问题，通常我们用的解释器是官方实现的 CPython，要真正利用多核，除非重写一个不带 GIL 的解释器。</p>\n<p>所以，在 Python 中，可以使用多线程，但不要指望能有效利用多核。如果一定要通过多线程利用多核，那只能通过 C 扩展来实现，不过这样就失去了 Python 简单易用的特点。</p>\n<p>不过，也不用过于担心，Python 虽然不能利用多线程实现多核任务，但可以通过多进程实现多核任务。多个 Python 进程有各自独立的 GIL 锁，互不影响。</p>\n<h3 id="小结-20"><a href="#%E5%B0%8F%E7%BB%93-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>多线程编程，模型复杂，容易发生冲突，必须用锁加以隔离，同时，又要小心死锁的发生。</p>\n<p>Python 解释器由于设计时有 GIL 全局锁，导致了多线程无法利用多核。多线程的并发在 Python 中就是一个美丽的梦。</p>\n<h2 id="threadlocal"><a href="#threadlocal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ThreadLocal</h2>\n<p>在多线程环境下，每个线程都有自己的数据。一个线程使用自己的局部变量比使用全局变量好，因为局部变量只有线程自己能看见，不会影响其他线程，而全局变量的修改必须加锁。</p>\n<p>但是局部变量也有问题，就是在函数调用的时候，传递起来很麻烦：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13649129125061087000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def process_student(name):\n    std = Student(name)\n    # std 是局部变量，但是每个函数都要用它，因此必须传进去：\n    do_task_1(std)\n    do_task_2(std)\n\ndef do_task_1(std):\n    do_subtask_1(std)\n    do_subtask_2(std)\n\ndef do_task_2(std):\n    do_subtask_2(std)\n    do_subtask_2(std)`, `13649129125061087000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">process_student</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    std <span class="token operator">=</span> Student<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token comment"># std 是局部变量，但是每个函数都要用它，因此必须传进去：</span>\n    do_task_1<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_task_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_1</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    do_subtask_1<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_2</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个函数一层一层调用都这么传参数那还得了？用全局变量？也不行，因为每个线程处理不同的 Student 对象，不能共享。</p>\n<p>如果用一个全局 dict 存放所有的 Student 对象，然后以 thread 自身作为 key 获得线程对应的 Student 对象如何？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21092217589091344000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global_dict = {}\n\ndef std_thread(name):\n    std = Student(name)\n    # 把 std 放到全局变量 global_dict 中：\n    global_dict[threading.current_thread()] = std\n    do_task_1()\n    do_task_2()\n\ndef do_task_1():\n    # 不传入 std，而是根据当前线程查找：\n    std = global_dict[threading.current_thread()]\n    ...\n\ndef do_task_2():\n    # 任何函数都可以查找出当前线程的 std 变量：\n    std = global_dict[threading.current_thread()]\n    ...`, `21092217589091344000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">global_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">std_thread</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    std <span class="token operator">=</span> Student<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token comment"># 把 std 放到全局变量 global_dict 中：</span>\n    global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> std\n    do_task_1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    do_task_2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 不传入 std，而是根据当前线程查找：</span>\n    std <span class="token operator">=</span> global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 任何函数都可以查找出当前线程的 std 变量：</span>\n    std <span class="token operator">=</span> global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种方式理论上是可行的，它最大的优点是消除了 std 对象在每层函数中的传递问题，但是，每个函数获取 std 的代码有点丑。</p>\n<p>有没有更简单的方式？</p>\n<p>ThreadLocal 应运而生，不用查找 dict，ThreadLocal 帮你自动做这件事：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89999219966722080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading\n\n# 创建全局 ThreadLocal 对象:\nlocal_school = threading.local()\n\ndef process_student():\n    # 获取当前线程关联的 student:\n    std = local_school.student\n    print(\'Hello, %s (in %s)\' % (std, threading.current_thread().name))\n\ndef process_thread(name):\n    # 绑定 ThreadLocal 的 student:\n    local_school.student = name\n    process_student()\n\nt1 = threading.Thread(target=process_thread, args=(\'Alice\',), name=\'Thread-A\')\nt2 = threading.Thread(target=process_thread, args=(\'Bob\',), name=\'Thread-B\')\nt1.start()\nt2.start()\nt1.join()\nt2.join()`, `89999219966722080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading\n\n<span class="token comment"># 创建全局 ThreadLocal 对象:</span>\nlocal_school <span class="token operator">=</span> threading<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">process_student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 获取当前线程关联的 student:</span>\n    std <span class="token operator">=</span> local_school<span class="token punctuation">.</span>student\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s (in %s)\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">process_thread</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 绑定 ThreadLocal 的 student:</span>\n    local_school<span class="token punctuation">.</span>student <span class="token operator">=</span> name\n    process_student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nt1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'Alice\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Thread-A\'</span><span class="token punctuation">)</span>\nt2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Thread-B\'</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58478741233366140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello, Alice (in Thread-A)\nHello, Bob (in Thread-B)`, `58478741233366140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Hello, Alice <span class="token punctuation">(</span>in Thread-A<span class="token punctuation">)</span>\nHello, Bob <span class="token punctuation">(</span>in Thread-B<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>全局变量 <code class="language-text">local_school</code> 就是一个 ThreadLocal 对象，每个 Thread 对它都可以读写 student 属性，但互不影响。你可以把 <code class="language-text">local_school</code> 看成全局变量，但每个属性如 <code class="language-text">local_school.student</code> 都是线程的局部变量，可以任意读写而互不干扰，也不用管理锁的问题，ThreadLocal 内部会处理。</p>\n<p>可以理解为全局变量 <code class="language-text">local_school</code> 是一个 dict，不但可以用 <code class="language-text">local_school.student</code>，还可以绑定其他变量，如 <code class="language-text">local_school.teacher</code> 等等。</p>\n<p>ThreadLocal 最常用的地方就是为每个线程绑定一个数据库连接，HTTP 请求，用户身份信息等，这样一个线程的所有调用到的处理函数都可以非常方便地访问这些资源。</p>\n<h3 id="小结-21"><a href="#%E5%B0%8F%E7%BB%93-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>一个 ThreadLocal 变量虽然是全局变量，但每个线程都只能读写自己线程的独立副本，互不干扰。ThreadLocal 解决了参数在一个线程中各个函数之间互相传递的问题。</p>\n<h2 id="进程-vs-线程"><a href="#%E8%BF%9B%E7%A8%8B-vs-%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程 vs 线程</h2>\n<p>首先，要实现多任务，通常我们会设计 Master-Worker 模式，Master 负责分配任务，Worker 负责执行任务，因此，多任务环境下，通常是一个 Master，多个 Worker。</p>\n<ol>\n<li>如果用多进程实现 Master-Worker，主进程就是 Master，其他进程就是 Worker。</li>\n<li>如果用多线程实现 Master-Worker，主线程就是 Master，其他线程就是 Worker。</li>\n</ol>\n<p>多进程模式最大的优点就是稳定性高，因为一个子进程崩溃了，不会影响主进程和其他子进程。（当然主进程挂了所有进程就全挂了，但是 Master 进程只负责分配任务，挂掉的概率低）著名的 Apache 最早就是采用多进程模式。</p>\n<p>多进程模式的缺点是创建进程的代价大，在 Unix/Linux 系统下，用 fork 调用还行，在 Windows 下创建进程开销巨大。另外，操作系统能同时运行的进程数也是有限的，在内存和 CPU 的限制下，如果有几千个进程同时运行，操作系统连调度都会成问题。</p>\n<p>多线程模式通常比多进程快一点，但是也快不到哪去，而且，多线程模式致命的缺点就是任何一个线程挂掉都可能直接造成整个进程崩溃，因为所有线程共享进程的内存。在 Windows 上，如果一个线程执行的代码出了问题，你经常可以看到这样的提示：“该程序执行了非法操作，即将关闭”，其实往往是某个线程出了问题，但是操作系统会强制结束整个进程。</p>\n<p>在 Windows 下，多线程的效率比多进程要高，所以微软的 IIS 服务器默认采用多线程模式。由于多线程存在稳定性的问题，IIS 的稳定性就不如 Apache。为了缓解这个问题，IIS 和 Apache 现在又有多进程+多线程的混合模式，真是把问题越搞越复杂。</p>\n<h3 id="线程切换"><a href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程切换</h3>\n<p>无论是多进程还是多线程，只要数量一多，效率肯定上不去，为什么呢？</p>\n<p>我们打个比方，假设你不幸正在准备中考，每天晚上需要做语文、数学、英语、物理、化学这 5 科的作业，每项作业耗时 1 小时。</p>\n<p>如果你先花 1 小时做语文作业，做完了，再花 1 小时做数学作业，这样，依次全部做完，一共花 5 小时，这种方式称为单任务模型，或者批处理任务模型。</p>\n<p>假设你打算切换到多任务模型，可以先做 1 分钟语文，再切换到数学作业，做 1 分钟，再切换到英语，以此类推，只要切换速度足够快，这种方式就和单核 CPU 执行多任务是一样的了，以幼儿园小朋友的眼光来看，你就正在同时写 5 科作业。</p>\n<p>但是，切换作业是有代价的，比如从语文切到数学，要先收拾桌子上的语文书本、钢笔（这叫保存现场），然后，打开数学课本、找出圆规直尺（这叫准备新环境），才能开始做数学作业。操作系统在切换进程或者线程时也是一样的，它需要先保存当前执行的现场环境（CPU 寄存器状态、内存页等），然后，把新任务的执行环境准备好（恢复上次的寄存器状态，切换内存页等），才能开始执行。这个切换过程虽然很快，但是也需要耗费时间。如果有几千个任务同时进行，操作系统可能就主要忙着切换任务，根本没有多少时间去执行任务了，这种情况最常见的就是硬盘狂响，点窗口无反应，系统处于假死状态。</p>\n<p>所以，多任务一旦多到一个限度，就会消耗掉系统所有的资源，结果效率急剧下降，所有任务都做不好。</p>\n<h3 id="计算密集型-vs-io-密集型"><a href="#%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-vs-io-%E5%AF%86%E9%9B%86%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算密集型 vs IO 密集型</h3>\n<p>是否采用多任务的第二个考虑是任务的类型。我们可以把任务分为计算密集型和 IO 密集型。</p>\n<p>计算密集型任务的特点是要进行大量的计算，消耗 CPU 资源，比如计算圆周率、对视频进行高清解码等等，全靠 CPU 的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU 执行任务的效率就越低，所以，要最高效地利用 CPU，计算密集型任务同时进行的数量应当等于 CPU 的核心数。</p>\n<p>计算密集型任务由于主要消耗 CPU 资源，因此，代码运行效率至关重要。Python 这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用 C 语言编写。</p>\n<p>第二种任务的类型是 IO 密集型，涉及到网络、磁盘 IO 的任务都是 IO 密集型任务，这类任务的特点是 CPU 消耗很少，任务的大部分时间都在等待 IO 操作完成（因为 IO 的速度远远低于 CPU 和内存的速度）。对于 IO 密集型任务，任务越多，CPU 效率越高，但也有一个限度。常见的大部分任务都是 IO 密集型任务，比如 Web 应用。</p>\n<p>IO 密集型任务执行期间，99% 的时间都花在 IO 上，花在 CPU 上的时间很少，因此，用运行速度极快的 C 语言替换用 Python 这样运行速度极低的脚本语言，完全无法提升运行效率。对于 IO 密集型任务，最合适的语言就是开发效率最高（代码量最少）的语言，脚本语言是首选，C 语言最差。</p>\n<h3 id="异步-io"><a href="#%E5%BC%82%E6%AD%A5-io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步 IO</h3>\n<p>考虑到 CPU 和 IO 之间巨大的速度差异，一个任务在执行的过程中大部分时间都在等待 IO 操作，单进程单线程模型会导致别的任务无法并行执行，因此，我们才需要多进程模型或者多线程模型来支持多任务并发执行。</p>\n<p>现代操作系统对 IO 操作已经做了巨大的改进，最大的特点就是支持异步 IO。如果充分利用操作系统提供的异步 IO 支持，就可以用单进程单线程模型来执行多任务，这种全新的模型称为事件驱动模型，Nginx 就是支持异步 IO 的 Web 服务器，它在单核 CPU 上采用单进程模型就可以高效地支持多任务。在多核 CPU 上，可以运行多个进程（数量与 CPU 核心数相同），充分利用多核 CPU。由于系统总的进程数量十分有限，因此操作系统调度非常高效。用异步 IO 编程模型来实现多任务是一个主要的趋势。</p>\n<p>对应到 Python 语言，单线程的异步编程模型称为协程，有了协程的支持，就可以基于事件驱动编写高效的多任务程序。我们会在后面讨论如何编写协程。</p>\n<h2 id="分布式进程"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式进程</h2>\n<p>在 Thread 和 Process 中，应当优选 Process，因为 Process 更稳定，而且，Process 可以分布到多台机器上，而 Thread 最多只能分布到同一台机器的多个 CPU 上。</p>\n<p>Python 的 multiprocessing 模块不但支持多进程，其中 managers 子模块还支持把多进程分布到多台机器上。一个服务进程可以作为调度者，将任务分布到其他多个进程中，依靠网络通信。由于 managers 模块封装很好，不必了解网络通信的细节，就可以很容易地编写分布式多进程程序。</p>\n<p>举个例子：如果我们已经有一个通过 Queue 通信的多进程程序在同一台机器上运行，现在，由于处理任务的进程任务繁重，希望把发送任务的进程和处理任务的进程分布到两台机器上。怎么用分布式进程实现？</p>\n<p>原有的 Queue 可以继续使用，但是，通过 managers 模块把 Queue 通过网络暴露出去，就可以让其他机器的进程访问 Queue 了。</p>\n<p>我们先看服务进程，服务进程负责启动 Queue，把 Queue 注册到网络上，然后往 Queue 里面写入任务：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15038948832969546000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# task_master.py\n\nimport random, time, queue\nfrom multiprocessing.managers import BaseManager\n\n# 发送任务的队列:\ntask_queue = queue.Queue()\n# 接收结果的队列:\nresult_queue = queue.Queue()\n\n# 从 BaseManager 继承的 QueueManager:\nclass QueueManager(BaseManager):\n    pass\n\n# 把两个 Queue 都注册到网络上, callable 参数关联了 Queue 对象:\nQueueManager.register(\'get_task_queue\', callable=lambda: task_queue)\nQueueManager.register(\'get_result_queue\', callable=lambda: result_queue)\n# 绑定端口 5000, 设置验证码 \'abc\':\nmanager = QueueManager(address=(\'\', 5000), authkey=b\'abc\')\n# 启动 Queue:\nmanager.start()\n\n# 获得通过网络访问的 Queue 对象:\ntask = manager.get_task_queue()\nresult = manager.get_result_queue()\n# 放几个任务进去:\nfor i in range(10):\n    n = random.randint(0, 10000)\n    print(\'Put task %d...\' % n)\n    task.put(n)\n# 从 result 队列读取结果:\nprint(\'Try get results...\')\nfor i in range(10):\n    r = result.get(timeout=10)\n    print(\'Result: %s\' % r)\n# 关闭:\nmanager.shutdown()\nprint(\'master exit.\')`, `15038948832969546000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># task_master.py</span>\n\n<span class="token keyword">import</span> random<span class="token punctuation">,</span> time<span class="token punctuation">,</span> queue\n<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager\n\n<span class="token comment"># 发送任务的队列:</span>\ntask_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 接收结果的队列:</span>\nresult_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 从 BaseManager 继承的 QueueManager:</span>\n<span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 把两个 Queue 都注册到网络上, callable 参数关联了 Queue 对象:</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_task_queue\'</span><span class="token punctuation">,</span> <span class="token builtin">callable</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> task_queue<span class="token punctuation">)</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_result_queue\'</span><span class="token punctuation">,</span> <span class="token builtin">callable</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> result_queue<span class="token punctuation">)</span>\n<span class="token comment"># 绑定端口 5000, 设置验证码 \'abc\':</span>\nmanager <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span><span class="token string">b\'abc\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 启动 Queue:</span>\nmanager<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 获得通过网络访问的 Queue 对象:</span>\ntask <span class="token operator">=</span> manager<span class="token punctuation">.</span>get_task_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> manager<span class="token punctuation">.</span>get_result_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 放几个任务进去:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Put task %d...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n    task<span class="token punctuation">.</span>put<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token comment"># 从 result 队列读取结果:</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Try get results...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    r <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Result: %s\'</span> <span class="token operator">%</span> r<span class="token punctuation">)</span>\n<span class="token comment"># 关闭:</span>\nmanager<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'master exit.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，当我们在一台机器上写多进程程序时，创建的 Queue 可以直接拿来用，但是，在分布式多进程环境下，添加任务到 Queue 不可以直接对原始的 <code class="language-text">task_queue</code> 进行操作，那样就绕过了 QueueManager 的封装，必须通过 <code class="language-text">manager.get_task_queue()</code> 获得的 Queue 接口添加。</p>\n<p>然后，在另一台机器上启动任务进程（本机上启动也可以）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93471007076249600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# task_worker.py\n\nimport time, sys, queue\nfrom multiprocessing.managers import BaseManager\n\n# 创建类似的 QueueManager:\nclass QueueManager(BaseManager):\n    pass\n\n# 由于这个 QueueManager 只从网络上获取 Queue，所以注册时只提供名字:\nQueueManager.register(\'get_task_queue\')\nQueueManager.register(\'get_result_queue\')\n\n# 连接到服务器，也就是运行 task_master.py 的机器:\nserver_addr = \'127.0.0.1\'\nprint(\'Connect to server %s...\' % server_addr)\n# 端口和验证码注意保持与 task_master.py 设置的完全一致:\nm = QueueManager(address=(server_addr, 5000), authkey=b\'abc\')\n# 从网络连接:\nm.connect()\n# 获取 Queue 的对象:\ntask = m.get_task_queue()\nresult = m.get_result_queue()\n# 从 task 队列取任务,并把结果写入 result 队列:\nfor i in range(10):\n    try:\n        n = task.get(timeout=1)\n        print(\'run task %d * %d...\' % (n, n))\n        r = \'%d * %d = %d\' % (n, n, n*n)\n        time.sleep(1)\n        result.put(r)\n    except Queue.Empty:\n        print(\'task queue is empty.\')\n# 处理结束:\nprint(\'worker exit.\')`, `93471007076249600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># task_worker.py</span>\n\n<span class="token keyword">import</span> time<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> queue\n<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager\n\n<span class="token comment"># 创建类似的 QueueManager:</span>\n<span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 由于这个 QueueManager 只从网络上获取 Queue，所以注册时只提供名字:</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_task_queue\'</span><span class="token punctuation">)</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_result_queue\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 连接到服务器，也就是运行 task_master.py 的机器:</span>\nserver_addr <span class="token operator">=</span> <span class="token string">\'127.0.0.1\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Connect to server %s...\'</span> <span class="token operator">%</span> server_addr<span class="token punctuation">)</span>\n<span class="token comment"># 端口和验证码注意保持与 task_master.py 设置的完全一致:</span>\nm <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span><span class="token string">b\'abc\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 从网络连接:</span>\nm<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 获取 Queue 的对象:</span>\ntask <span class="token operator">=</span> m<span class="token punctuation">.</span>get_task_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> m<span class="token punctuation">.</span>get_result_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 从 task 队列取任务,并把结果写入 result 队列:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'run task %d * %d...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        r <span class="token operator">=</span> <span class="token string">\'%d * %d = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">,</span> n<span class="token operator">*</span>n<span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n        result<span class="token punctuation">.</span>put<span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Queue<span class="token punctuation">.</span>Empty<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'task queue is empty.\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 处理结束:</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'worker exit.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>任务进程要通过网络连接到服务进程，所以要指定服务进程的 IP。</p>\n<p>现在，可以试试分布式进程的工作效果了。先启动 <code class="language-text">task_master.py</code> 服务进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11137018431946033000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 task_master.py\nPut task 3411...\nPut task 1605...\nPut task 1398...\nPut task 4729...\nPut task 5300...\nPut task 7471...\nPut task 68...\nPut task 4219...\nPut task 339...\nPut task 7866...\nTry get results...`, `11137018431946033000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 task_master.py\nPut task <span class="token number">3411</span><span class="token punctuation">..</span>.\nPut task <span class="token number">1605</span><span class="token punctuation">..</span>.\nPut task <span class="token number">1398</span><span class="token punctuation">..</span>.\nPut task <span class="token number">4729</span><span class="token punctuation">..</span>.\nPut task <span class="token number">5300</span><span class="token punctuation">..</span>.\nPut task <span class="token number">7471</span><span class="token punctuation">..</span>.\nPut task <span class="token number">68</span><span class="token punctuation">..</span>.\nPut task <span class="token number">4219</span><span class="token punctuation">..</span>.\nPut task <span class="token number">339</span><span class="token punctuation">..</span>.\nPut task <span class="token number">7866</span><span class="token punctuation">..</span>.\nTry get results<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">task_master.py</code> 进程发送完任务后，开始等待 result 队列的结果。现在启动 <code class="language-text">task_worker.py</code> 进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40670302725161320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 task_worker.py\nConnect to server 127.0.0.1...\nrun task 3411 * 3411...\nrun task 1605 * 1605...\nrun task 1398 * 1398...\nrun task 4729 * 4729...\nrun task 5300 * 5300...\nrun task 7471 * 7471...\nrun task 68 * 68...\nrun task 4219 * 4219...\nrun task 339 * 339...\nrun task 7866 * 7866...\nworker exit.`, `40670302725161320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 task_worker.py\nConnect to server <span class="token number">127.0</span>.0.1<span class="token punctuation">..</span>.\nrun task <span class="token number">3411</span> * <span class="token number">3411</span><span class="token punctuation">..</span>.\nrun task <span class="token number">1605</span> * <span class="token number">1605</span><span class="token punctuation">..</span>.\nrun task <span class="token number">1398</span> * <span class="token number">1398</span><span class="token punctuation">..</span>.\nrun task <span class="token number">4729</span> * <span class="token number">4729</span><span class="token punctuation">..</span>.\nrun task <span class="token number">5300</span> * <span class="token number">5300</span><span class="token punctuation">..</span>.\nrun task <span class="token number">7471</span> * <span class="token number">7471</span><span class="token punctuation">..</span>.\nrun task <span class="token number">68</span> * <span class="token number">68</span><span class="token punctuation">..</span>.\nrun task <span class="token number">4219</span> * <span class="token number">4219</span><span class="token punctuation">..</span>.\nrun task <span class="token number">339</span> * <span class="token number">339</span><span class="token punctuation">..</span>.\nrun task <span class="token number">7866</span> * <span class="token number">7866</span><span class="token punctuation">..</span>.\nworker exit.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">task_worker.py</code> 进程结束，在 <code class="language-text">task_master.py</code> 进程中会继续打印出结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4977682276020979000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Result: 3411 * 3411 = 11634921\nResult: 1605 * 1605 = 2576025\nResult: 1398 * 1398 = 1954404\nResult: 4729 * 4729 = 22363441\nResult: 5300 * 5300 = 28090000\nResult: 7471 * 7471 = 55815841\nResult: 68 * 68 = 4624\nResult: 4219 * 4219 = 17799961\nResult: 339 * 339 = 114921\nResult: 7866 * 7866 = 61873956`, `4977682276020979000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Result: <span class="token number">3411</span> * <span class="token number">3411</span> <span class="token operator">=</span> <span class="token number">11634921</span>\nResult: <span class="token number">1605</span> * <span class="token number">1605</span> <span class="token operator">=</span> <span class="token number">2576025</span>\nResult: <span class="token number">1398</span> * <span class="token number">1398</span> <span class="token operator">=</span> <span class="token number">1954404</span>\nResult: <span class="token number">4729</span> * <span class="token number">4729</span> <span class="token operator">=</span> <span class="token number">22363441</span>\nResult: <span class="token number">5300</span> * <span class="token number">5300</span> <span class="token operator">=</span> <span class="token number">28090000</span>\nResult: <span class="token number">7471</span> * <span class="token number">7471</span> <span class="token operator">=</span> <span class="token number">55815841</span>\nResult: <span class="token number">68</span> * <span class="token number">68</span> <span class="token operator">=</span> <span class="token number">4624</span>\nResult: <span class="token number">4219</span> * <span class="token number">4219</span> <span class="token operator">=</span> <span class="token number">17799961</span>\nResult: <span class="token number">339</span> * <span class="token number">339</span> <span class="token operator">=</span> <span class="token number">114921</span>\nResult: <span class="token number">7866</span> * <span class="token number">7866</span> <span class="token operator">=</span> <span class="token number">61873956</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个简单的 Master/Worker 模型有什么用？其实这就是一个简单但真正的分布式计算，把代码稍加改造，启动多个 worker，就可以把任务分布到几台甚至几十台机器上，比如把计算 n*n 的代码换成发送邮件，就实现了邮件队列的异步发送。</p>\n<p>Queue 对象存储在哪？注意到 <code class="language-text">task_worker.py</code> 中根本没有创建 Queue 的代码，所以，Queue 对象存储在 <code class="language-text">task_master.py</code> 进程中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43299941274248544000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`                                             │\n┌─────────────────────────────────────────┐     ┌──────────────────────────────────────┐\n│task_master.py                           │  │  │task_worker.py                        │\n│                                         │     │                                      │\n│  task = manager.get_task_queue()        │  │  │  task = manager.get_task_queue()     │\n│  result = manager.get_result_queue()    │     │  result = manager.get_result_queue() │\n│              │                          │  │  │              │                       │\n│              │                          │     │              │                       │\n│              ▼                          │  │  │              │                       │\n│  ┌─────────────────────────────────┐    │     │              │                       │\n│  │QueueManager                     │    │  │  │              │                       │\n│  │ ┌────────────┐ ┌──────────────┐ │    │     │              │                       │\n│  │ │ task_queue │ │ result_queue │ │<───┼──┼──┼──────────────┘                       │\n│  │ └────────────┘ └──────────────┘ │    │     │                                      │\n│  └─────────────────────────────────┘    │  │  │                                      │\n└─────────────────────────────────────────┘     └──────────────────────────────────────┘\n                                             │\n\n                                          Network`, `43299941274248544000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">                                             │\n┌─────────────────────────────────────────┐     ┌──────────────────────────────────────┐\n│task_master.py                           │  │  │task_worker.py                        │\n│                                         │     │                                      │\n│  task = manager.get_task_queue()        │  │  │  task = manager.get_task_queue()     │\n│  result = manager.get_result_queue()    │     │  result = manager.get_result_queue() │\n│              │                          │  │  │              │                       │\n│              │                          │     │              │                       │\n│              ▼                          │  │  │              │                       │\n│  ┌─────────────────────────────────┐    │     │              │                       │\n│  │QueueManager                     │    │  │  │              │                       │\n│  │ ┌────────────┐ ┌──────────────┐ │    │     │              │                       │\n│  │ │ task_queue │ │ result_queue │ │&lt;───┼──┼──┼──────────────┘                       │\n│  │ └────────────┘ └──────────────┘ │    │     │                                      │\n│  └─────────────────────────────────┘    │  │  │                                      │\n└─────────────────────────────────────────┘     └──────────────────────────────────────┘\n                                             │\n\n                                          Network</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而 Queue 之所以能通过网络访问，就是通过 QueueManager 实现的。由于 QueueManager 管理的不止一个 Queue，所以，要给每个 Queue 的网络调用接口起个名字，比如 <code class="language-text">get_task_queue</code>。</p>\n<p>authkey 有什么用？这是为了保证两台机器正常通信，不被其他机器恶意干扰。如果 <code class="language-text">task_worker.py</code> 的 authkey 和 <code class="language-text">task_master.py</code> 的 authkey 不一致，肯定连接不上。</p>\n<h3 id="小结-22"><a href="#%E5%B0%8F%E7%BB%93-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的分布式进程接口简单，封装良好，适合需要把繁重任务分布到多台机器的环境下。</p>\n<p>注意 Queue 的作用是用来传递任务和接收结果，每个任务的描述数据量要尽量小。比如发送一个处理日志文件的任务，就不要发送几百兆的日志文件本身，而是发送日志文件存放的完整路径，由 Worker 进程再去共享的磁盘上读取文件。</p>\n<h1 id="正则表达式"><a href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正则表达式</h1>\n<h2 id="re-模块"><a href="#re-%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>re 模块</h2>\n<p>Python 提供 re 模块，包含所有正则表达式的功能。由于 Python 的字符串本身也用 \\ 转义，所以要特别注意：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68974069588239910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = \'ABC\\\\-001\' # Python 的字符串\n# 对应的正则表达式字符串变成：\n# \'ABC\\-001\'`, `68974069588239910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token string">\'ABC\\\\-001\'</span> <span class="token comment"># Python 的字符串</span>\n<span class="token comment"># 对应的正则表达式字符串变成：</span>\n<span class="token comment"># \'ABC\\-001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>因此我们强烈建议使用 Python 的 r 前缀，就不用考虑转义的问题了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63403926917546110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = r\'ABC\\-001\' # Python 的字符串\n# 对应的正则表达式字符串不变：\n# \'ABC\\-001\'`, `63403926917546110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token string">r\'ABC\\-001\'</span> <span class="token comment"># Python 的字符串</span>\n<span class="token comment"># 对应的正则表达式字符串不变：</span>\n<span class="token comment"># \'ABC\\-001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>先看看如何判断正则表达式是否匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89147797972954810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import re\n>>> re.match(r\'^\\d{3}\\-\\d{3,8}\\$\', \'010-12345\')\n<_sre.SRE_Match object; span=(0, 9), match=\'010-12345\'>\n>>> re.match(r\'^\\d{3}\\-\\d{3,8}\\$\', \'010 12345\')\n>>>`, `89147797972954810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re\n<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^\\d{3}\\-\\d{3,8}$\'</span><span class="token punctuation">,</span> <span class="token string">\'010-12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Match <span class="token builtin">object</span><span class="token punctuation">;</span> span<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> match<span class="token operator">=</span><span class="token string">\'010-12345\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^\\d{3}\\-\\d{3,8}$\'</span><span class="token punctuation">,</span> <span class="token string">\'010 12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>match() 方法判断是否匹配，如果匹配成功，返回一个 Match 对象，否则返回 None。常见的判断方法就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98885074654117580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`test = \'用户输入的字符串\'\nif re.match(r\'正则表达式\', test):\n    print(\'ok\')\nelse:\n    print(\'failed\')`, `98885074654117580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">test <span class="token operator">=</span> <span class="token string">\'用户输入的字符串\'</span>\n<span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'正则表达式\'</span><span class="token punctuation">,</span> test<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ok\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="切分字符串"><a href="#%E5%88%87%E5%88%86%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切分字符串</h3>\n<p>用正则表达式切分字符串比用固定的字符更灵活，请看正常的切分代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28619854274222002000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'a b   c\'.split(\' \')\n[\'a\', \'b\', \'\', \'\', \'c\']`, `28619854274222002000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'a b   c\'</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>嗯，无法识别连续的空格，用正则表达式试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87982446479028240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'\\s+\', \'a b   c\')\n[\'a\', \'b\', \'c\']`, `87982446479028240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'\\s+\'</span><span class="token punctuation">,</span> <span class="token string">\'a b   c\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>无论多少个空格都可以正常分割。加入 <code class="language-text">,</code> 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45059357475561640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'[\\s\\,]+\', \'a,b, c  d\')\n[\'a\', \'b\', \'c\', \'d\']`, `45059357475561640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'[\\s\\,]+\'</span><span class="token punctuation">,</span> <span class="token string">\'a,b, c  d\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>再加入 <code class="language-text">;</code> 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5231159824503129000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'[\\s\\,\\;]+\', \'a,b;; c  d\')\n[\'a\', \'b\', \'c\', \'d\']`, `5231159824503129000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'[\\s\\,\\;]+\'</span><span class="token punctuation">,</span> <span class="token string">\'a,b;; c  d\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果用户输入了一组标签，下次记得用正则表达式来把不规范的输入转化成正确的数组。</p>\n<h3 id="分组"><a href="#%E5%88%86%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分组</h3>\n<p>除了简单地判断是否匹配之外，正则表达式还有提取子串的强大功能。用 () 表示的就是要提取的分组（Group）。比如：</p>\n<p><code class="language-text">^(\\d{3})-(\\d{3,8})$</code> 分别定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88201471654751880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> m = re.match(r\'^(\\d{3})-(\\d{3,8})\\$\', \'010-12345\')\n>>> m\n<_sre.SRE_Match object; span=(0, 9), match=\'010-12345\'>\n>>> m.group(0)\n\'010-12345\'\n>>> m.group(1)\n\'010\'\n>>> m.group(2)\n\'12345\'`, `88201471654751880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d{3})-(\\d{3,8})$\'</span><span class="token punctuation">,</span> <span class="token string">\'010-12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> m\n<span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Match <span class="token builtin">object</span><span class="token punctuation">;</span> span<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> match<span class="token operator">=</span><span class="token string">\'010-12345\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token string">\'010-12345\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token string">\'010\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token string">\'12345\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果正则表达式中定义了组，就可以在 Match 对象上用 group() 方法提取出子串来。</p>\n<p>注意到 group(0) 永远是与整个正则表达式相匹配的字符串，group(1)、group(2)…… 表示第 1、2、…… 个子串。</p>\n<p>提取子串非常有用。来看一个更凶残的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54976123970513190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = \'19:05:30\'\n>>> m = re.match(r\'^(0[0-9]|1[0-9]|2[0-3]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\$\', t)\n>>> m.groups()\n(\'19\', \'05\', \'30\')`, `54976123970513190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token string">\'19:05:30\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(0[0-9]|1[0-9]|2[0-3]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])$\'</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'19\'</span><span class="token punctuation">,</span> <span class="token string">\'05\'</span><span class="token punctuation">,</span> <span class="token string">\'30\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个正则表达式可以直接识别合法的时间。但是有些时候，用正则表达式也无法做到完全验证，比如识别日期：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66015637260067450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'^(0[1-9]|1[0-2]|[0-9])-(0[1-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])\\$\'`, `66015637260067450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">\'^(0[1-9]|1[0-2]|[0-9])-(0[1-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])$\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于 ‘2-30’，‘4-31’ 这样的非法日期，用正则还是识别不了，或者说写出来非常困难，这时就需要程序配合识别了。</p>\n<h3 id="贪婪匹配"><a href="#%E8%B4%AA%E5%A9%AA%E5%8C%B9%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>贪婪匹配</h3>\n<p>最后需要特别指出的是，正则匹配默认是贪婪匹配，也就是匹配尽可能多的字符。举例如下，匹配出数字后面的 0：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29502602659176680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.match(r\'^(\\d+)(0*)\\$\', \'102300\').groups()\n(\'102300\', \'\')`, `29502602659176680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d+)(0*)$\'</span><span class="token punctuation">,</span> <span class="token string">\'102300\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'102300\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于 <code class="language-text">\\d+</code> 采用贪婪匹配，直接把后面的 0 全部匹配了，结果 <code class="language-text">0*</code> 只能匹配空字符串了。</p>\n<p>必须让 <code class="language-text">\\d+</code> 采用非贪婪匹配（也就是尽可能少匹配），才能把后面的 0 匹配出来，加个 <code class="language-text">?</code> 就可以让 <code class="language-text">\\d+</code> 采用非贪婪匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98372807805774410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.match(r\'^(\\d+?)(0*)\\$\', \'102300\').groups()\n(\'1023\', \'00\')`, `98372807805774410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d+?)(0*)$\'</span><span class="token punctuation">,</span> <span class="token string">\'102300\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'1023\'</span><span class="token punctuation">,</span> <span class="token string">\'00\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="编译"><a href="#%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译</h3>\n<p>当我们在 Python 中使用正则表达式时，re 模块内部会干两件事情：</p>\n<ol>\n<li>编译正则表达式，如果正则表达式的字符串本身不合法，会报错；</li>\n<li>用编译后的正则表达式去匹配字符串。</li>\n</ol>\n<p>如果一个正则表达式要重复使用几千次，出于效率的考虑，我们可以预编译该正则表达式，接下来重复使用时就不需要编译这个步骤了，直接匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80540324467597570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import re\n# 编译:\n>>> re_telephone = re.compile(r\'^(\\d{3})-(\\d{3,8})\\$\')\n# 使用：\n>>> re_telephone.match(\'010-12345\').groups()\n(\'010\', \'12345\')\n>>> re_telephone.match(\'010-8086\').groups()\n(\'010\', \'8086\')`, `80540324467597570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re\n<span class="token comment"># 编译:</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r\'^(\\d{3})-(\\d{3,8})$\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用：</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">\'010-12345\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'010\'</span><span class="token punctuation">,</span> <span class="token string">\'12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">\'010-8086\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'010\'</span><span class="token punctuation">,</span> <span class="token string">\'8086\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编译后生成 Regular Expression 对象，由于该对象自己包含了正则表达式，所以调用对应的方法时不用给出正则字符串。</p>\n<h3 id="小结-23"><a href="#%E5%B0%8F%E7%BB%93-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>正则表达式非常强大，要在短短的一节里讲完是不可能的。要讲清楚正则的所有内容，可以写一本厚厚的书了。如果你经常遇到正则表达式的问题，你可能需要一本正则表达式的参考书。</p>\n<h1 id="virtualenv"><a href="#virtualenv" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>virtualenv</h1>\n<p>virtualenv 就是用来为一个应用创建一套“隔离”的 Python 运行环境。</p>\n<p>首先，我们用 pip 安装 virtualenv：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56670008707207460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ pip3 install virtualenv`, `56670008707207460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ pip3 <span class="token function">install</span> virtualenv</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后，假定我们要开发一个新的项目，需要一套独立的 Python 运行环境，可以这么做：</p>\n<p>第一步，创建目录：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38918392130663860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:~ michael\\$ mkdir myproject\nMac:~ michael\\$ cd myproject/\nMac:myproject michael\\$`, `38918392130663860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:~ michael$ <span class="token function">mkdir</span> myproject\nMac:~ michael$ <span class="token builtin class-name">cd</span> myproject/\nMac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>第二步，创建一个独立的 Python 运行环境，命名为 venv：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79248273420137780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:myproject michael\\$ virtualenv --no-site-packages venv\nUsing base prefix \'/usr/local/.../Python.framework/Versions/3.4\'\nNew python executable in venv/bin/python3.4\nAlso creating executable in venv/bin/python\nInstalling setuptools, pip, wheel...done.`, `79248273420137780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:myproject michael$ virtualenv --no-site-packages venv\nUsing base prefix <span class="token string">\'/usr/local/.../Python.framework/Versions/3.4\'</span>\nNew python executable <span class="token keyword">in</span> venv/bin/python3.4\nAlso creating executable <span class="token keyword">in</span> venv/bin/python\nInstalling setuptools, pip, wheel<span class="token punctuation">..</span>.done.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>命令 virtualenv 就可以创建一个独立的 Python 运行环境，我们还加上了参数 —no-site-packages，这样，已经安装到系统 Python 环境中的所有第三方包都不会复制过来，这样，我们就得到了一个不带任何第三方包的“干净”的 Python 运行环境。</p>\n<p>新建的 Python 环境被放到当前目录下的 venv 目录。有了 venv 这个 Python 环境，可以用 source 进入该环境：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8807077007858255000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:myproject michael\\$ source venv/bin/activate\n(venv)Mac:myproject michael\\$`, `8807077007858255000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:myproject michael$ <span class="token builtin class-name">source</span> venv/bin/activate\n<span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意到命令提示符变了，有个 <code class="language-text">(venv)</code> 前缀，表示当前环境是一个名为 venv 的 Python 环境。</p>\n<p>下面正常安装各种第三方包，并运行 python 命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95135650276994470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(venv)Mac:myproject michael\\$ pip install jinja2\n...\nSuccessfully installed jinja2-2.7.3 markupsafe-0.23\n(venv)Mac:myproject michael\\$ python myapp.py\n...`, `95135650276994470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ pip <span class="token function">install</span> jinja2\n<span class="token punctuation">..</span>.\nSuccessfully installed jinja2-2.7.3 markupsafe-0.23\n<span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ python myapp.py\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 venv 环境下，用 pip 安装的包都被安装到 venv 这个环境下，系统 Python 环境不受任何影响。也就是说，venv 环境是专门针对 myproject 这个应用创建的。</p>\n<p>退出当前的 venv 环境，使用 deactivate 命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2898392322709209000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(venv)Mac:myproject michael\\$ deactivate\nMac:myproject michael\\$`, `2898392322709209000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ deactivate\nMac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时就回到了正常的环境，现在 pip 或 python 均是在系统 Python 环境下执行。</p>\n<p>完全可以针对每个应用创建独立的 Python 运行环境，这样就可以对每个应用的 Python 环境进行隔离。</p>\n<p>virtualenv 是如何创建“独立”的 Python 运行环境的呢？原理很简单，就是把系统 Python 复制一份到 virtualenv 的环境，用命令 <code class="language-text">source venv/bin/activate</code> 进入一个 virtualenv 环境时，virtualenv 会修改相关环境变量，让命令 python 和 pip 均指向当前的 virtualenv 环境。</p>\n<h2 id="小结-24"><a href="#%E5%B0%8F%E7%BB%93-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h2>\n<p>virtualenv 为应用提供了隔离的 Python 运行环境，解决了不同应用间多版本的冲突问题。</p>\n<h1 id="异步-io-1"><a href="#%E5%BC%82%E6%AD%A5-io-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步 IO</h1>\n<p>在 IO 编程一节中，我们已经知道，CPU 的速度远远快于磁盘、网络等 IO。在一个线程中，CPU 执行代码的速度极快，然而，一旦遇到 IO 操作，如读写文件、发送网络数据时，就需要等待 IO 操作完成，才能继续进行下一步操作。这种情况称为同步 IO。</p>\n<p>在 IO 操作的过程中，当前线程被挂起，而其他需要 CPU 执行的代码就无法被当前线程执行了。</p>\n<p>因为一个 IO 操作就阻塞了当前线程，导致其他代码无法执行，所以我们必须使用多线程或者多进程来并发执行代码，为多个用户服务。每个用户都会分配一个线程，如果遇到 IO 导致线程被挂起，其他用户的线程不受影响。</p>\n<p>多线程和多进程的模型虽然解决了并发问题，但是系统不能无上限地增加线程。由于系统切换线程的开销也很大，所以，一旦线程数量过多，CPU 的时间就花在线程切换上了，真正运行代码的时间就少了，结果导致性能严重下降。</p>\n<p>由于我们要解决的问题是 CPU 高速执行能力和 IO 设备的龟速严重不匹配，多线程和多进程只是解决这一问题的一种方法。</p>\n<p>另一种解决 IO 问题的方法是异步 IO。当代码需要执行一个耗时的 IO 操作时，它只发出 IO 指令，并不等待 IO 结果，然后就去执行其他代码了。一段时间后，当 IO 返回结果时，再通知 CPU 进行处理。</p>\n<p>可以想象如果按普通顺序写出的代码实际上是没法完成异步 IO 的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8670020497777586000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`do_some_code()\nf = open(\'/path/to/file\', \'r\')\nr = f.read() # <== 线程停在此处等待 IO 操作结果\n# IO 操作完成后线程才能继续执行:\ndo_some_code(r)`, `8670020497777586000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">do_some_code<span class="token punctuation">(</span><span class="token punctuation">)</span>\nf <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>\nr <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># &lt;== 线程停在此处等待 IO 操作结果</span>\n<span class="token comment"># IO 操作完成后线程才能继续执行:</span>\ndo_some_code<span class="token punctuation">(</span>r<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，同步 IO 模型的代码是无法实现异步 IO 模型的。</p>\n<p>异步 IO 模型需要一个消息循环，在消息循环中，主线程不断地重复“读取消息-处理消息”这一过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41054890895845880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`loop = get_event_loop()\nwhile True:\n    event = loop.get_event()\n    process_event(event)`, `41054890895845880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">loop <span class="token operator">=</span> get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n    event <span class="token operator">=</span> loop<span class="token punctuation">.</span>get_event<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    process_event<span class="token punctuation">(</span>event<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>消息模型其实早在应用在桌面应用程序中了。一个 GUI 程序的主线程就负责不停地读取消息并处理消息。所有的键盘、鼠标等消息都被发送到 GUI 程序的消息队列中，然后由 GUI 程序的主线程处理。</p>\n<p>由于 GUI 线程处理键盘、鼠标等消息的速度非常快，所以用户感觉不到延迟。某些时候，GUI 线程在一个消息处理的过程中遇到问题导致一次消息处理时间过长，此时，用户会感觉到整个 GUI 程序停止响应了，敲键盘、点鼠标都没有反应。这种情况说明在消息模型中，处理一个消息必须非常迅速，否则，主线程将无法及时处理消息队列中的其他消息，导致程序看上去停止响应。</p>\n<p>消息模型是如何解决同步 IO 必须等待 IO 操作这一问题的呢？当遇到 IO 操作时，代码只负责发出 IO 请求，不等待 IO 结果，然后直接结束本轮消息处理，进入下一轮消息处理过程。当 IO 操作完成后，将收到一条“IO 完成”的消息，处理该消息时就可以直接获取 IO 操作结果。</p>\n<p>在“发出 IO 请求”到收到“IO 完成”的这段时间里，同步 IO 模型下，主线程只能挂起，但异步 IO 模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样，在异步 IO 模型下，一个线程就可以同时处理多个 IO 请求，并且没有切换线程的操作。对于大多数 IO 密集型的应用程序，使用异步 IO 将大大提升系统的多任务处理能力。</p>\n<h2 id="协程"><a href="#%E5%8D%8F%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>协程</h2>\n<p>在学习异步 IO 模型前，我们先来了解协程。</p>\n<p>协程，又称微线程，纤程。英文名 Coroutine。</p>\n<p>协程的概念很早就提出来了，但直到最近几年才在某些语言（如 Lua）中得到广泛应用。</p>\n<p>子程序，或者称为函数，在所有语言中都是层级调用，比如 A 调用 B，B 在执行过程中又调用了 C，C 执行完毕返回，B 执行完毕返回，最后是 A 执行完毕。</p>\n<p>所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。</p>\n<p>子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。</p>\n<p>协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。</p>\n<p>注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似 CPU 的中断。比如子程序 A、B：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67977182343396336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def A():\n    print(\'1\')\n    print(\'2\')\n    print(\'3\')\n\ndef B():\n    print(\'x\')\n    print(\'y\')\n    print(\'z\')`, `67977182343396336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'3\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'y\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'z\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设由协程执行，在执行 A 的过程中，可以随时中断，去执行 B，B 也可能在执行过程中中断再去执行 A，结果可能是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91921790151326480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\nx\ny\n3\nz`, `91921790151326480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\nx\ny\n3\nz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是在 A 中是没有调用 B 的，所以协程的调用比函数调用理解起来要难一些。</p>\n<p>看起来 A、B 的执行有点像多线程，但协程的特点在于是一个线程执行，那和多线程比，协程有何优势？</p>\n<ol>\n<li>最大的优势就是协程极高的执行效率。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</li>\n<li>第二大优势就是不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</li>\n</ol>\n<p>因为协程是一个线程执行，那怎么利用多核 CPU 呢？最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p>\n<p>Python 对协程的支持是通过 generator 实现的。</p>\n<p>在 generator 中，我们不但可以通过 for 循环来迭代，还可以不断调用 next() 函数获取由 yield 语句返回的下一个值。</p>\n<p>但是 Python 的 yield 不但可以返回一个值，它还可以接收调用者发出的参数。</p>\n<p>来看例子：</p>\n<p>传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。</p>\n<p>如果改用协程，生产者生产消息后，直接通过 yield 跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41885270411297300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def consumer():\n    r = \'\'\n    while True:\n        n = yield r\n        if not n:\n            return\n        print(\'[CONSUMER] Consuming %s...\' % n)\n        r = \'200 OK\'\n\ndef produce(c):\n    c.send(None)\n    n = 0\n    while n < 5:\n        n = n + 1\n        print(\'[PRODUCER] Producing %s...\' % n)\n        r = c.send(n)\n        print(\'[PRODUCER] Consumer return: %s\' % r)\n    c.close()\n\nc = consumer()\nproduce(c)`, `41885270411297300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    r <span class="token operator">=</span> <span class="token string">\'\'</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> <span class="token keyword">yield</span> r\n        <span class="token keyword">if</span> <span class="token keyword">not</span> n<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[CONSUMER] Consuming %s...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n        r <span class="token operator">=</span> <span class="token string">\'200 OK\'</span>\n\n<span class="token keyword">def</span> <span class="token function">produce</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    c<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n    n <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[PRODUCER] Producing %s...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n        r <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[PRODUCER] Consumer return: %s\'</span> <span class="token operator">%</span> r<span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nc <span class="token operator">=</span> consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>\nproduce<span class="token punctuation">(</span>c<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54789186058282600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[PRODUCER] Producing 1...\n[CONSUMER] Consuming 1...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 2...\n[CONSUMER] Consuming 2...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 3...\n[CONSUMER] Consuming 3...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 4...\n[CONSUMER] Consuming 4...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 5...\n[CONSUMER] Consuming 5...\n[PRODUCER] Consumer return: 200 OK`, `54789186058282600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">1</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">1</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">2</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">2</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">3</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">3</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">4</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">4</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">5</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">5</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 consumer 函数是一个 generator，把一个 consumer 传入 produce 后：</p>\n<ol>\n<li>首先调用 c.send(None) 启动生成器；</li>\n<li>然后，一旦生产了东西，通过 c.send(n) 切换到 consumer 执行；</li>\n<li>consumer 通过 yield 拿到消息处理，又通过 yield 把结果传回；</li>\n<li>produce 拿到 consumer 处理的结果，继续生产下一条消息；</li>\n<li>produce 决定不生产了，通过 c.close() 关闭 consumer，整个过程结束。</li>\n</ol>\n<p>整个流程无锁，由一个线程执行，produce 和 consumer 协作完成任务，所以称为“协程”，而非线程的抢占式多任务。</p>\n<p>最后套用 Donald Knuth 的一句话总结协程的特点：</p>\n<p>“子程序就是协程的一种特例。”</p>\n<h2 id="asyncio"><a href="#asyncio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>asyncio</h2>\n<p>asyncio 是 Python 3.4 版本引入的标准库，直接内置了对异步 IO 的支持。</p>\n<p>asyncio 的编程模型就是一个消息循环。我们从 asyncio 模块中直接获取一个 EventLoop 的引用，然后把需要执行的协程扔到 EventLoop 中执行，就实现了异步 IO。</p>\n<p>用 asyncio 实现 Hello world 代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8060719907818936000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\n@asyncio.coroutine\ndef hello():\n    print(&quot;Hello world!&quot;)\n    # 异步调用 asyncio.sleep(1):\n    r = yield from asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)\n\n# 获取 EventLoop:\nloop = asyncio.get_event_loop()\n# 执行 coroutine\nloop.run_until_complete(hello())\nloop.close()`, `8060719907818936000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    <span class="token comment"># 异步调用 asyncio.sleep(1):</span>\n    r <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 获取 EventLoop:</span>\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 执行 coroutine</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">@asyncio.coroutine</code> 把一个 generator 标记为 coroutine 类型，然后，我们就把这个 coroutine 扔到 EventLoop 中执行。</p>\n<p>hello() 会首先打印出 Hello world!，然后，yield from 语法可以让我们方便地调用另一个 generator。由于 asyncio.sleep() 也是一个 coroutine，所以线程不会等待 asyncio.sleep()，而是直接中断并执行下一个消息循环。当 asyncio.sleep() 返回时，线程就可以从 yield from 拿到返回值（此处是 None），然后接着执行下一行语句。</p>\n<p>把 asyncio.sleep(1) 看成是一个耗时 1 秒的 IO 操作，在此期间，主线程并未等待，而是去执行 EventLoop 中其他可以执行的 coroutine 了，因此可以实现并发执行。</p>\n<p>我们用 Task 封装两个 coroutine 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41769803883535020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading\nimport asyncio\n\n@asyncio.coroutine\ndef hello():\n    print(\'Hello world! (%s)\' % threading.currentThread())\n    yield from asyncio.sleep(1)\n    print(\'Hello again! (%s)\' % threading.currentThread())\n\nloop = asyncio.get_event_loop()\ntasks = [hello(), hello()]\nloop.run_until_complete(asyncio.wait(tasks))\nloop.close()`, `41769803883535020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading\n<span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello world! (%s)\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello again! (%s)\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\ntasks <span class="token operator">=</span> <span class="token punctuation">[</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察执行过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99385291498680760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello world! (<_MainThread(MainThread, started 140735195337472)>)\nHello world! (<_MainThread(MainThread, started 140735195337472)>)\n(暂停约1秒)\nHello again! (<_MainThread(MainThread, started 140735195337472)>)\nHello again! (<_MainThread(MainThread, started 140735195337472)>)`, `99385291498680760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Hello world<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\nHello world<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span>暂停约1秒<span class="token punctuation">)</span>\nHello again<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\nHello again<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由打印的当前线程名称可以看出，两个 coroutine 是由同一个线程并发执行的。</p>\n<p>如果把 asyncio.sleep() 换成真正的 IO 操作，则多个 coroutine 就可以由一个线程并发执行。</p>\n<p>我们用 asyncio 的异步网络连接来获取 sina、sohu 和 163 的网站首页：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69430099598087300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\n@asyncio.coroutine\ndef wget(host):\n    print(\'wget %s...\' % host)\n    connect = asyncio.open_connection(host, 80)\n    reader, writer = yield from connect\n    header = \'GET / HTTP/1.0\\r\\nHost: %s\\r\\n\\r\\n\' % host\n    writer.write(header.encode(\'utf-8\'))\n    yield from writer.drain()\n    while True:\n        line = yield from reader.readline()\n        if line == b\'\\r\\n\':\n            break\n        print(\'%s header > %s\' % (host, line.decode(\'utf-8\').rstrip()))\n    # Ignore the body, close the socket\n    writer.close()\n\nloop = asyncio.get_event_loop()\ntasks = [wget(host) for host in [\'www.sina.com.cn\', \'www.sohu.com\', \'www.163.com\']]\nloop.run_until_complete(asyncio.wait(tasks))\nloop.close()`, `69430099598087300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">wget</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'wget %s...\'</span> <span class="token operator">%</span> host<span class="token punctuation">)</span>\n    connect <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>open_connection<span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span>\n    reader<span class="token punctuation">,</span> writer <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> connect\n    header <span class="token operator">=</span> <span class="token string">\'GET / HTTP/1.0\\r\\nHost: %s\\r\\n\\r\\n\'</span> <span class="token operator">%</span> host\n    writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>header<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        line <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> reader<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> line <span class="token operator">==</span> <span class="token string">b\'\\r\\n\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">break</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s header > %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span> line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment"># Ignore the body, close the socket</span>\n    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\ntasks <span class="token operator">=</span> <span class="token punctuation">[</span>wget<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token keyword">for</span> host <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'www.sina.com.cn\'</span><span class="token punctuation">,</span> <span class="token string">\'www.sohu.com\'</span><span class="token punctuation">,</span> <span class="token string">\'www.163.com\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81992687126841440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`wget www.sohu.com...\nwget www.sina.com.cn...\nwget www.163.com...\n(等待一段时间)\n(打印出sohu的header)\nwww.sohu.com header > HTTP/1.1 200 OK\nwww.sohu.com header > Content-Type: text/html\n...\n(打印出sina的header)\nwww.sina.com.cn header > HTTP/1.1 200 OK\nwww.sina.com.cn header > Date: Wed, 20 May 2015 04:56:33 GMT\n...\n(打印出163的header)\nwww.163.com header > HTTP/1.0 302 Moved Temporarily\nwww.163.com header > Server: Cdn Cache Server V2.0\n...`, `81992687126841440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">wget</span> www.sohu.com<span class="token punctuation">..</span>.\n<span class="token function">wget</span> www.sina.com.cn<span class="token punctuation">..</span>.\n<span class="token function">wget</span> www.163.com<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>等待一段时间<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>打印出sohu的header<span class="token punctuation">)</span>\nwww.sohu.com header <span class="token operator">></span> HTTP/1.1 <span class="token number">200</span> OK\nwww.sohu.com header <span class="token operator">></span> Content-Type: text/html\n<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>打印出sina的header<span class="token punctuation">)</span>\nwww.sina.com.cn header <span class="token operator">></span> HTTP/1.1 <span class="token number">200</span> OK\nwww.sina.com.cn header <span class="token operator">></span> Date: Wed, <span class="token number">20</span> May <span class="token number">2015</span> 04:56:33 GMT\n<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>打印出163的header<span class="token punctuation">)</span>\nwww.163.com header <span class="token operator">></span> HTTP/1.0 <span class="token number">302</span> Moved Temporarily\nwww.163.com header <span class="token operator">></span> Server: Cdn Cache Server V2.0\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见 3 个连接由一个线程通过 coroutine 并发完成。</p>\n<h3 id="小结-25"><a href="#%E5%B0%8F%E7%BB%93-25" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>asyncio 提供了完善的异步 IO 支持；</p>\n<p>异步操作需要在 coroutine 中通过 yield from 完成；</p>\n<p>多个 coroutine 可以封装成一组 Task 然后并发执行。</p>\n<h2 id="async--await"><a href="#async--await" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>async / await</h2>\n<p>用 asyncio 提供的 <code class="language-text">@asyncio.coroutine</code> 可以把一个 generator 标记为 coroutine 类型，然后在 coroutine 内部用 yield from 调用另一个 coroutine 实现异步操作。</p>\n<p>为了简化并更好地标识异步 IO，从 Python 3.5 开始引入了新的语法 async 和 await，可以让 coroutine 的代码更简洁易读。</p>\n<p>请注意，async 和 await 是针对 coroutine 的新语法，要使用新的语法，只需要做两步简单的替换：</p>\n<ol>\n<li>把 <code class="language-text">@asyncio.coroutine</code> 替换为 async；</li>\n<li>把 yield from 替换为 await。</li>\n</ol>\n<p>让我们对比一下上一节的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70847414604555190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@asyncio.coroutine\ndef hello():\n    print(&quot;Hello world!&quot;)\n    r = yield from asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)`, `70847414604555190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用新语法重新编写如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60847542653924380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async def hello():\n    print(&quot;Hello world!&quot;)\n    r = await asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)`, `60847542653924380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>剩下的代码保持不变。</p>\n<h3 id="小结-26"><a href="#%E5%B0%8F%E7%BB%93-26" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 从 3.5 版本开始为 asyncio 提供了 async 和 await 的新语法；</p>\n<p>注意新语法只能用在 Python 3.5 以及后续版本，如果使用 3.4 版本，则仍需使用上一节的方案。</p>\n<h2 id="aiohttp"><a href="#aiohttp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>aiohttp</h2>\n<p>asyncio 可以实现单线程并发 IO 操作。如果仅用在客户端，发挥的威力不大。如果把 asyncio 用在服务器端，例如 Web 服务器，由于 HTTP 连接就是 IO 操作，因此可以用单线程 + coroutine 实现多用户的高并发支持。</p>\n<p>asyncio 实现了 TCP、UDP、SSL 等协议，aiohttp 则是基于 asyncio 实现的 HTTP 框架。</p>\n<p>我们先安装 aiohttp：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14925339862966514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pip install aiohttp`, `14925339862966514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">pip <span class="token function">install</span> aiohttp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后编写一个 HTTP 服务器，分别处理以下 URL：</p>\n<ul>\n<li><code class="language-text">/</code> - 首页返回 <code class="language-text">b&#39;&lt;h1&gt;Index&lt;/h1&gt;&#39;</code>；</li>\n<li><code class="language-text">/hello/{name}</code> - 根据 URL 参数返回文本 <code class="language-text">hello, %s!</code>。</li>\n</ul>\n<p>代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52159619463766200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\nfrom aiohttp import web\n\nasync def index(request):\n    await asyncio.sleep(0.5)\n    return web.Response(body=b\'<h1>Index</h1>\')\n\nasync def hello(request):\n    await asyncio.sleep(0.5)\n    text = \'<h1>hello, %s!</h1>\' % request.match_info[\'name\']\n    return web.Response(body=text.encode(\'utf-8\'))\n\nasync def init(loop):\n    app = web.Application(loop=loop)\n    app.router.add_route(\'GET\', \'/\', index)\n    app.router.add_route(\'GET\', \'/hello/{name}\', hello)\n    srv = await loop.create_server(app.make_handler(), \'127.0.0.1\', 8000)\n    print(\'Server started at http://127.0.0.1:8000...\')\n    return srv\n\nloop = asyncio.get_event_loop()\nloop.run_until_complete(init(loop))\nloop.run_forever()`, `52159619463766200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span><span class="token string">b\'&lt;h1>Index&lt;/h1>\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>\n    text <span class="token operator">=</span> <span class="token string">\'&lt;h1>hello, %s!&lt;/h1>\'</span> <span class="token operator">%</span> request<span class="token punctuation">.</span>match_info<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span>\n    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>loop<span class="token operator">=</span>loop<span class="token punctuation">)</span>\n    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">\'GET\'</span><span class="token punctuation">,</span> <span class="token string">\'/\'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>\n    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">\'GET\'</span><span class="token punctuation">,</span> <span class="token string">\'/hello/{name}\'</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>\n    srv <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>app<span class="token punctuation">.</span>make_handler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'127.0.0.1\'</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Server started at http://127.0.0.1:8000...\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> srv\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>init<span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意 aiohttp 的初始化函数 init() 也是一个 coroutine，loop.create_server() 则利用 asyncio 创建 TCP 服务。</p>\n<p>// TODO Python 入门学习待完成</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:117,frontmatter:{date:"2022-04-02 16:40:55",path:"/python-introduce-learn/",tags:"后端, python, 读书笔记",title:"Python入门学习",draft:null}},{excerpt:"JS 基础问题 简述 与前端 Js 不同, 后端方面除了 SSR/爬虫之外很少会接触 DOM, 所以关于 DOM 方面的各种知识基本不会讨论.浏览器端除了图形业务外很少碰到内存问题, 但是后端几乎是直面服务器内存的, 更加偏向内存方面, 对于一些更基础的问题也会更加关注. 类型判断 看  lodash 作用域 看《你不知道的 js》 引用传递 js…",html:'<h1 id="js-基础问题"><a href="#js-%E5%9F%BA%E7%A1%80%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JS 基础问题</h1>\n<h2 id="简述"><a href="#%E7%AE%80%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>与前端 Js 不同, 后端方面除了 SSR/爬虫之外很少会接触 DOM, 所以关于 DOM 方面的各种知识基本不会讨论.浏览器端除了图形业务外很少碰到内存问题, 但是后端几乎是直面服务器内存的, 更加偏向内存方面, 对于一些更基础的问题也会更加关注.</p>\n<h2 id="类型判断"><a href="#%E7%B1%BB%E5%9E%8B%E5%88%A4%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类型判断</h2>\n<p>看 <a href="https://github.com/lodash/lodash" target="_blank" rel="nofollow noreferrer noopener">lodash</a></p>\n<h2 id="作用域"><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作用域</h2>\n<p>看《你不知道的 js》</p>\n<h2 id="引用传递"><a href="#%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>引用传递</h2>\n<blockquote>\n<p>js 中什么类型是引用传递, 什么类型是值传递? 如何将值类型的变量以引用的方式传递?</p>\n</blockquote>\n<p>简单点说, 对象是引用传递, 基础类型是值传递, 通过将基础类型包装 (boxing) 可以以引用的方式传递.</p>\n<p>引用传递和值传递是一个非常简单的问题, 也是理解 JavaScript 中的内存方面问题的一个基础. 如果不了解引用可能很难去看很多问题.</p>\n<p>面试写代码的话, 可以通过 <code class="language-text">如何编写一个 json 对象的拷贝函数</code> 等类似的问题来考察对引用的了解. 不过笔者偶尔会有恶趣味, 喜欢先问应聘者对于 == 的 === 的区别的了解. 然后再问 <code class="language-text">[1]</code> == <code class="language-text">[1]</code> 是 true 还是 false. 如果基础不好的同学可能会被自己对于 == 和 === 的结论影响然后得出错误的结论.</p>\n<p>对于技术好的, 希望能直接反驳这个问题本身是有问题的, 比如讲清楚 JavaScript 中没有引用传递只是传递引用. 参见 Is JavaScript a pass-by-reference or pass-by-value language?. 虽然说是复杂版, 但是这些知识对于 3 年经验的同学真的应该是很简单的问题了.</p>\n<p>另外如果简历中有写 C++, 则必问 <code class="language-text">指针与引用的区别</code>.</p>\n<h2 id="内存释放"><a href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存释放</h2>\n<blockquote>\n<p>JavaScript 中不同类型以及不同环境下变量的内存都是何时释放?</p>\n</blockquote>\n<p>引用类型是在没有引用之后, 通过 v8 的 GC 自动回收, 值类型如果是处于闭包的情况下, 要等闭包没有引用才会被 GC 回收, 非闭包的情况下等待 v8 的新生代 (new space) 切换的时候回收.</p>\n<p>与前端 Js 不同, 2 年以上经验的 Node.js 一定要开始注意内存了, 不说对 v8 的 GC 有多了解, 基础的内存释放一定有概念了, 并且要开始注意内存泄漏的问题了.</p>\n<p>你需要了解哪些操作一定会导致内存泄漏, 或者可以崩掉内存. 比如如下代码能否爆掉 V8 的内存?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99297882117015180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push(1);`, `99297882117015180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后上述代码与下方的情况有什么区别?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96498415124939900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push();`, `96498415124939900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果 push 的是 Buffer 情况又会有什么区别?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30682579925155127000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push(new Buffer(1000));`, `30682579925155127000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>思考完之后可以尝试找找别的情况如何爆掉 V8 的内存. 以及来聊聊内存泄漏?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18866464999576960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function out() {\n  const bigData = new Buffer(100);\n  inner = function() {\n    void bigData;\n  };\n}`, `18866464999576960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> bigData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function-variable function">inner</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">void</span> bigData<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>闭包会引用到父级函数中的变量，如果闭包未释放，就会导致内存泄漏。上面例子是 inner 直接挂在了 root 上，从而导致内存泄漏（bigData 不会释放）。详见 <a href="https://zhuanlan.zhihu.com/p/25736931" target="_blank" rel="nofollow noreferrer noopener">如何分析 Node.js 中的内存泄漏</a></p>\n<p>对于一些高水平的同学, 要求能清楚的了解 V8 内存 GC 的机制, 懂得内存快照等 (之后会在调试/优化的小结中讨论) 了. 比如 V8 中不同类型的数据存储的位置, 在内存释放的时候不同区域的不同策略等等.</p>\n<h2 id="es6-新特性"><a href="#es6-%E6%96%B0%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES6 新特性</h2>\n<p>看阮一峰的 <a href="http://es6.ruanyifeng.com/" target="_blank" rel="nofollow noreferrer noopener">ECMAScript 6 入门</a></p>\n<p>比较简单的会问 let 与 var 的区别, 以及 <code class="language-text">箭头函数</code> 与 <code class="language-text">function</code> 的区别等等.</p>\n<p>深入的话, es6 有太多细节可以深入了. 比如结合 <code class="language-text">引用</code> 的知识点来询问 const 方面的知识. 结合 <code class="language-text">{}</code> 的使用与缺点来谈 Set, Map 等. 比如私有化的问题与 symbol 等等.</p>\n<p>其他像是闭包是什么? 这种问烂了问题已经感觉没必要问了, 取而代之的是询问闭包应用的场景更加合理. 比如说, 如果回答者通常使用闭包实现数据的私有, 那么可以接着问 es6 的一些新特性 (例如 class, symbol) 能否实现私有, 如果能的话那为什么要用闭包? 亦或者是什么闭包中的数据/私有化的数据的内存什么时候释放? 等等.</p>\n<p><code class="language-text">...</code> 的使用上, 如何实现一个数组的去重 (使用 Set 可以加分).</p>\n<blockquote>\n<p>const 定义的 Array 中间元素能否被修改? 如果可以, 那 const 修饰对象有什么意义?</p>\n</blockquote>\n<p>其中的值可以被修改. 意义上, 主要保护引用不被修改 (如用 Map 等接口对引用的变化很敏感, 使用 const 保护引用始终如一是有意义的), 也适合用在 immutable 的场景.</p>\n<h1 id="模块"><a href="#%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块</h1>\n<h2 id="常见问题"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见问题</h2>\n<blockquote>\n<p>如何在不重启 node 进程的情况下热更新一个 js/json 文件? 这个问题本身是否有问题?</p>\n</blockquote>\n<p>可以清除掉 require.cache 的缓存重新 require(xxx), 视具体情况还可以用 VM 模块重新执行.</p>\n<p>当然这个问题可能是典型的 X-Y Problem, 使用 js 实现热更新很容易碰到 v8 优化之后各地拿到缓存的引用导致热更新 js 没意义. 当然热更新 json 还是可以简单一点比如用读取文件的方式来热更新, 但是这样也不如从 redis 之类的数据库中读取比较合理.</p>\n<h2 id="简述-1"><a href="#%E7%AE%80%E8%BF%B0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>其他还有很多内容也是属于很 ‘基础’ 的 Node.js 问题 (例如异步/线程等等), 但是由于归类的问题并没有放在这个分类中. 所以这里只简单讲几个之后没归类的基础问题.</p>\n<h2 id="模块机制"><a href="#%E6%A8%A1%E5%9D%97%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块机制</h2>\n<p>node 的基础中毫无疑问的应该是有关于模块机制的方面的, 也即 require 这个内置功能的一些原理的问题.</p>\n<p>关于模块互相引用之类的, 不了解的推荐先好好读读官方文档.</p>\n<p>其实官方文档已经说得很清楚了, 每个 node 进程只有一个 VM 的上下文, 不会跟浏览器相差多少, 模块机制在文档中也描述的非常清楚了:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99816669704375420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function require(...) {\n  var module = { exports: {} };\n  ((module, exports) => {\n    // Your module code here. In this example, define a function.\n    function some_func() {};\n    exports = some_func;\n    // At this point, exports is no longer a shortcut to module.exports, and\n    // this module will still export an empty default object.\n    module.exports = some_func;\n    // At this point, the module will now export some_func, instead of the\n    // default object.\n  })(module, module.exports);\n  return module.exports;\n}`, `99816669704375420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// Your module code here. In this example, define a function.</span>\n    <span class="token keyword">function</span> <span class="token function">some_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    exports <span class="token operator">=</span> some_func<span class="token punctuation">;</span>\n    <span class="token comment">// At this point, exports is no longer a shortcut to module.exports, and</span>\n    <span class="token comment">// this module will still export an empty default object.</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> some_func<span class="token punctuation">;</span>\n    <span class="token comment">// At this point, the module will now export some_func, instead of the</span>\n    <span class="token comment">// default object.</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>如果 a.js require 了 b.js, 那么在 b 中定义全局变量 t = 111 能否在 a 中直接打印出来?</p>\n</blockquote>\n<p>每个 .js 能独立一个环境只是因为 node 帮你在外层包了一圈自执行, 所以你使用 t = 111 定义全局变量在其他地方当然能拿到. 情况如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19831557284798420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// b.js\n(function(exports, require, module, __filename, __dirname) {\n  t = 111;\n})();\n\n// a.js\n(function(exports, require, module, __filename, __dirname) {\n  // ...\n  console.log(t); // 111\n})();`, `19831557284798420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// b.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  t <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// a.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 111</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>a.js 和 b.js 两个文件互相 require 是否会死循环? 双方是否能导出变量? 如何从设计上避免这种问题?</p>\n</blockquote>\n<p>不会, 先执行的导出其未完成的副本, 通过导出工厂函数让对方从函数去拿比较好避免. 模块在导出的只是 var module = { exports: {…} }; 中的 exports, 以从 a.js 启动为例, a.js 还没执行完会返回一个 a.js 的 exports 对象的未完成的副本给 b.js 模块。 然后 b.js 完成加载，并将 exports 对象提供给 a.js 模块。</p>\n<p>另外还有非常基础和常见的问题, 比如 module.exports 和 exports 的区别这里也能一并解决了 exports 只是 module.exports 的一个引用.</p>\n<p>再晋级一点, 众所周知, node 的模块机制是基于 CommonJS 规范的. 对于从前端转 node 的同学, 如果面试官想问的难一点会考查关于 CommonJS 的一些问题. 比如比较 AMD（提前执行、依赖前置）, CMD（延迟执行、依赖就近）, CommonJS 三者的区别, 包括询问关于 node 中 require 的实现原理等.</p>\n<blockquote>\n<p>node 中 require 的实现原理</p>\n</blockquote>\n<p>require 命令是 CommonJS 规范之中，用来加载其他模块的命令。它其实不是一个全局命令，而是指向当前模块的 module.require 命令，而后者又调用 Node 的内部命令 Module._load。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97747704849601200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Module._load = function(request, parent, isMain) {\n  // 1. 检查 Module._cache，是否缓存之中有指定模块\n  // 2. 如果缓存之中没有，就创建一个新的 Module 实例\n  // 3. 将它保存到缓存\n  // 4. 使用 module.load() 加载指定的模块文件，\n  //    读取文件内容之后，使用 module.compile() 执行文件代码\n  // 5. 如果加载/解析过程报错，就从缓存删除该模块\n  // 6. 返回该模块的 module.exports\n};`, `97747704849601200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. 检查 Module._cache，是否缓存之中有指定模块</span>\n  <span class="token comment">// 2. 如果缓存之中没有，就创建一个新的 Module 实例</span>\n  <span class="token comment">// 3. 将它保存到缓存</span>\n  <span class="token comment">// 4. 使用 module.load() 加载指定的模块文件，</span>\n  <span class="token comment">//    读取文件内容之后，使用 module.compile() 执行文件代码</span>\n  <span class="token comment">// 5. 如果加载/解析过程报错，就从缓存删除该模块</span>\n  <span class="token comment">// 6. 返回该模块的 module.exports</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的第 4 步，采用 module.compile() 执行指定模块的脚本，逻辑如下。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74098408718476400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Module.prototype._compile = function(content, filename) {\n  // 1. 生成一个 require 函数，指向 module.require\n  // 2. 加载其他辅助方法到 require\n  // 3. 将文件内容放到一个函数之中，该函数可调用 require\n  // 4. 执行该函数\n};`, `74098408718476400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. 生成一个 require 函数，指向 module.require</span>\n  <span class="token comment">// 2. 加载其他辅助方法到 require</span>\n  <span class="token comment">// 3. 将文件内容放到一个函数之中，该函数可调用 require</span>\n  <span class="token comment">// 4. 执行该函数</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的第 1 步和第 2 步，require 函数及其辅助方法主要如下。</p>\n<ol>\n<li>require(): 加载外部模块</li>\n<li>require.resolve()：将模块名解析到一个绝对路径</li>\n<li>require.main：指向主模块</li>\n<li>require.cache：指向所有缓存的模块</li>\n<li>require.extensions：根据文件的后缀名，调用不同的执行函数</li>\n</ol>\n<p>一旦 require 函数准备完毕，整个所要加载的脚本内容，就被放到一个新的函数之中，这样可以避免污染全局环境。该函数的参数包括 require、module、exports，以及其他一些参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79828834267794310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(exports, require, module, __filename, __dirname) {\n  // YOUR CODE INJECTED HERE!\n});`, `79828834267794310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// YOUR CODE INJECTED HERE!</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">Module._compile</code> 方法是同步执行的，所以 <code class="language-text">Module._load</code> 要等它执行完成，才会向用户返回 module.exports 的值。</p>\n<h2 id="热更新"><a href="#%E7%83%AD%E6%9B%B4%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>热更新</h2>\n<p>从面试官的角度看, 热更新是很多程序常见的问题. 对客户端而言, 热更新意味着不用换包, 当然也包含着 md5 校验/差异更新等复杂问题; 对服务端而言, 热更新意味着服务不用重启, 这样可用性较高同时也优雅和有逼格. 问的过程中可以一定程度的暴露应聘程序员的水平.</p>\n<p>从 PHP 转 node 的同学可能会有些想法, 比如 PHP 的代码直接刷上去就好了, 并没有所谓的重启. 而 node 重启看起来动作还挺大. 当然这里面的区别, 主要是与同时有 PHP 与 node 开发经验的同学可以讨论, 也是很好的切入点.</p>\n<p>在 Node.js 中做热更新代码, 牵扯到的知识点可能主要是 require 会有一个 cache, 有这个 cache 在, 即使你更新了 .js 文件, 在代码中再次 require 还是会拿到之前的编译好缓存在 v8 内存 (code space) 中的的旧代码. 但是如果只是单纯的清除掉 require 中的 cache, 再次 require 确实能拿到新的代码, 但是这时候很容易碰到各地维持旧的引用依旧跑的旧的代码的问题. 如果还要继续推行这种热更新代码的话, 可能要推翻当前的架构, 从头开始重新设计一下目前的框架.</p>\n<p>不过热更新 json 之类的配置文件的话, 还是可以简单的实现的, 更新 require 的 cache 可以实现, 不会有持有旧引用的问题, 可以参见我 2 年前写着玩的<a href="https://www.npmjs.com/package/auto-reload" target="_blank" rel="nofollow noreferrer noopener">例子</a>, 但是如果旧的引用一直被持有很容易出现内存泄漏, 而要热更新配置的话, 为什么不存数据库? 或者用 zookeeper 之类的服务? 通过更新文件还要再发布一次, 但是存数据库直接写个接口配个界面多爽你说是不是?</p>\n<p>所以这个问题其实本身其实是值得商榷的, 可能是典型的 X-Y Problem, 不过聊起来确实是可以暴露水平.</p>\n<h2 id="上下文"><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上下文</h2>\n<p>对于 Node.js 而言, 正常情况下只有一个上下文, 甚至于内置的很多方面例如 require 的实现只是在启动的时候运行了内置的函数.</p>\n<p>每个单独的 .js 文件并不意味着单独的上下文, 在某个 .js 文件中污染了全局的作用域一样能影响到其他的地方.</p>\n<p>而目前的 Node.js 将 VM 的接口暴露了出来, 可以让你自己创建一个新的 js 上下文, 这一点上跟前端 js 还是区别挺大的. 在执行外部代码的时候, 通过创建新的上下文沙盒 (sandbox) 可以避免上下文被污染:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76393195540640420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'use strict\';\nconst vm = require(\'vm\');\n\nlet code = \\`(function(require) {\n\n  const http = require(\'http\');\n\n  http.createServer( (request, response) => {\n    response.writeHead(200, {\'Content-Type\': \'text/plain\'});\n    response.end(\'Hello World\\\\n\');\n  }).listen(8124);\n\n  console.log(\'Server running at http://127.0.0.1:8124/\');\n})\\`;\n\nvm.runInThisContext(code)(require);`, `76393195540640420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'vm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(require) {\n\n  const http = require(\'http\');\n\n  http.createServer( (request, response) => {\n    response.writeHead(200, {\'Content-Type\': \'text/plain\'});\n    response.end(\'Hello World\\\\n\');\n  }).listen(8124);\n\n  console.log(\'Server running at http://127.0.0.1:8124/\');\n})</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\nvm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span>require<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种执行方式与 eval 和 Function 有明显的区别. 关于 VM 更多的一些接口可以先阅读官方文档 VM (虚拟机)</p>\n<p>讲完这个知识点, 这里留下一个简单的问题, 既然可以通过新的上下文来避免污染, 那么为什么 Node.js 不给每一个 .js 文件以独立的上下文来避免作用域被污染?</p>\n<blockquote>\n<p>为什么 Node.js 不给每一个 .js 文件以独立的上下文来避免作用域被污染?</p>\n</blockquote>\n<p>node 中 require 的实现原理里面有说明，_compile 函数有调用 vm.runInThisContext 函数，即 Node.js 模块正常情况对作用域不会造成污染，意外创建全局变量是一种例外</p>\n<h1 id="事件异步"><a href="#%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件/异步</h1>\n<h2 id="promise"><a href="#promise" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise</h2>\n<p>相信很多同学在面试的时候都碰到过这样一个问题, 如何处理 Callback Hell. 在早些年的时候, 大家会看到有很多的解决方案例如 Q, async, EventProxy 等等. 最后从流行程度来看 Promise 当之无愧的独领风骚, 并且是在 ES6 的 JavaScript 标准上赢得了支持.</p>\n<p>关于它的基础知识/概念推荐看阮一峰的 Promise 对象 这里就不多不赘述.</p>\n<blockquote>\n<p>Promise 中 .then 的第二参数与 .catch 有什么区别?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20612385648349307000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`somePromise()\n  .then(function() {\n    throw new Error(\'oh noes\');\n  })\n  .catch(function(err) {\n    // I caught your error! :)\n  });\n\nsomePromise().then(\n  function() {\n    throw new Error(\'oh noes\');\n  },\n  function(err) {\n    // I didn\'t catch your error! :(\n  }\n);`, `20612385648349307000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">somePromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oh noes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// I caught your error! :)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">somePromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oh noes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// I didn\'t catch your error! :(</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>建议使用 catch</p>\n<p>另外关于同步与异步, 有个问题希望大家看一下, 这是很简单的 Promise 的使用例子:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68931582203595740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let doSth = new Promise((resolve, reject) => {\n  console.log(\'hello\');\n  resolve();\n});\n\ndoSth.then(() => {\n  console.log(\'over\');\n});`, `68931582203595740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> doSth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndoSth<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'over\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>毫无疑问的可以得到以下输出结果:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80151338115504010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hello\nover`, `80151338115504010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">hello\nover</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是首先的问题是, 该 Promise 封装的代码肯定是同步的, 那么这个 then 的执行是异步的吗?（异步）</p>\n<p>其次的问题是, 如下代码, setTimeout 到 10s 之后再 .then 调用, 那么 hello 是会在 10s 之后在打印吗, 还是一开始就打印?（hello 是会在 10s 之后在打印）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77788164488644030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let doSth = new Promise((resolve, reject) => {\n  console.log(\'hello\');\n  resolve();\n});\n\nsetTimeout(() => {\n  doSth.then(() => {\n    console.log(\'over\');\n  });\n}, 10000);`, `77788164488644030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> doSth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  doSth<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'over\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及理解如下代码的执行顺序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48669797511688270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setTimeout(function() {\n  console.log(1);\n}, 0);\nnew Promise(function executor(resolve) {\n  console.log(2);\n  for (var i = 0; i < 10000; i++) {\n    i == 9999 && resolve();\n  }\n  console.log(3);\n}).then(function() {\n  console.log(4);\n});\nconsole.log(5);`, `48669797511688270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70995426151998870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2\n3\n5\n4\n1`, `70995426151998870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">2\n3\n5\n4\n1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="events"><a href="#events" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Events</h2>\n<p>Events 是 Node.js 中一个非常重要的 core 模块, 在 node 中有许多重要的 core API 都是依赖其建立的. 比如 Stream 是基于 Events 实现的, 而 fs, net, http 等模块都依赖 Stream, 所以 Events 模块的重要性可见一斑.</p>\n<p>通过继承 EventEmitter 来使得一个类具有 node 提供的基本的 event 方法, 这样的对象可以称作 emitter, 而触发(emit)事件的 cb 则称作 listener. 与前端 DOM 树上的事件并不相同, emitter 的触发不存在冒泡, 逐层捕获等事件行为, 也没有处理事件传递的方法.</p>\n<blockquote>\n<p>Eventemitter 的 emit 是同步还是异步?</p>\n</blockquote>\n<p>Node.js 中 Eventemitter 的 emit 是同步的.</p>\n<p>另外, 可以讨论如下的执行结果是输出 <code class="language-text">hi 1</code> 还是 <code class="language-text">hi 2</code>?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63350228988689785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi 1\');\n});\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi 2\');\n});\n\nemitter.emit(\'myEvent\');`, `63350228988689785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi 1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi 2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="991736649030827600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hi 1\nhi 2`, `991736649030827600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">hi 1\nhi 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>或者如下情况是否会死循环?（会出现）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23536552653126775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi\');\n  emitter.emit(\'myEvent\');\n});\n\nemitter.emit(\'myEvent\');`, `23536552653126775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及这样会不会死循环?（不会出现，只是多了一个监听）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84677879790729270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', function sth() {\n  emitter.on(\'myEvent\', sth);\n  console.log(\'hi\');\n});\n\nemitter.emit(\'myEvent\');`, `84677879790729270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">sth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> sth<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 emitter 处理问题可以处理比较复杂的状态场景, 比如 TCP 的复杂状态机, 做多项异步操作的时候每一步都可能报错, 这个时候 .emit 错误并且执行某些 .once 的操作可以将你从泥沼中拯救出来.</p>\n<p>另外可以注意一下的是, 有些同学喜欢用 emitter 来监控某些类的状态, 但是在这些类释放的时候可能会忘记释放 emitter, 而这些类的内部可能持有该 emitter 的 listener 的引用从而导致内存泄漏.</p>\n<h2 id="阻塞异步"><a href="#%E9%98%BB%E5%A1%9E%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻塞/异步</h2>\n<blockquote>\n<p>如何判断接口是否异步? 是否只要有回调函数就是异步?</p>\n</blockquote>\n<p>开放性问题, 每个写 node 的人都有一套自己的判断方式.</p>\n<ul>\n<li>看文档</li>\n<li>console.log 打印看看</li>\n<li>看是否有 IO 操作</li>\n</ul>\n<p>单纯使用回调函数并不会异步, IO 操作才可能会异步, 除此之外还有使用 setTimeout 等方式实现异步.</p>\n<blockquote>\n<p>有这样一个场景, 你在线上使用 koa 搭建了一个网站, 这个网站项目中有一个你同事写的接口 A, 而 A 接口中在特殊情况下会变成死循环. 那么首先问题是, 如果触发了这个死循环, 会对网站造成什么影响?</p>\n</blockquote>\n<p>Node.js 中执行 js 代码的过程是单线程的. 只有当前代码都执行完, 才会切入事件循环, 然后从事件队列中 pop 出下一个回调函数开始执行代码. 所以实现一个 sleep 函数, 只要通过一个死循环就可以阻塞整个 js 的执行流程. (关于如何避免坑爹的同事写出死循环, 在后面的测试环节有写到.)</p>\n<blockquote>\n<p>如何实现一个 sleep 函数?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42042346709705060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function sleep(ms) {\n  var start = Date.now(),\n    expire = start + ms;\n  while (Date.now() < expire);\n  return;\n}`, `42042346709705060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    expire <span class="token operator">=</span> start <span class="token operator">+</span> ms<span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而异步, 是使用 libuv 来实现的 (C/C++的同学可以参见 libev 和 libevent) 另一个线程里的事件队列.</p>\n<p>如果在线上的网站中出现了死循环的逻辑被触发, 整个进程就会一直卡在死循环中, 如果没有多进程部署的话, 之后的网站请求全部会超时, js 代码没有结束那么事件队列就会停下等待不会执行异步, 整个网站无法响应.</p>\n<blockquote>\n<p>如何实现一个异步的 reduce? (注:不是异步完了之后同步 reduce)</p>\n</blockquote>\n<p>需要了解 reduce 的情况, 是第 n 个与 n + 1 的结果异步处理完之后, 在用新的结果与第 n + 2 个元素继续依次异步下去.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14895422110649270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当 await memo 不是最先出现时，所有的 sleep 并行执行，因为 await memo 使得函数等待上一个函数完成后执行\n// utility function for sleeping\nconst sleep = (n) => new Promise((res) => setTimeout(res, n));\n\nconst arr = [1, 2, 3];\nconst startTime = new Date().getTime();\nconst asyncRes = await arr.reduce(async (memo, e) => {\n  await sleep(2000);\n  console.log(e);\n  return (await memo) + e;\n}, 0);\n\nconsole.log(asyncRes, \\`Took \\${new Date().getTime() - startTime} ms\\`);`, `14895422110649270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当 await memo 不是最先出现时，所有的 sleep 并行执行，因为 await memo 使得函数等待上一个函数完成后执行</span>\n<span class="token comment">// utility function for sleeping</span>\n<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token keyword">await</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> memo<span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Took </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1897213283626242300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\n3\n6 &quot;Took 2001 ms&quot;`, `1897213283626242300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\n3\n6 &quot;Took 2001 ms&quot;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43864352243679190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当 await memo 最先出现时，这些函数按顺序运行，所有的 sleep 串行执行\nconst sleep = (n) => new Promise((res) => setTimeout(res, n));\nconst arr = [1, 2, 3];\n\nconst startTime = new Date().getTime();\n\nconst asyncRes = await arr.reduce(async (memo, e) => {\n  await memo;\n  await sleep(2000);\n  console.log(e);\n  return (await memo) + e;\n}, 0);\n\nconsole.log(asyncRes, \\`Took \\${new Date().getTime() - startTime} ms\\`);`, `43864352243679190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当 await memo 最先出现时，这些函数按顺序运行，所有的 sleep 串行执行</span>\n<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token keyword">await</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">await</span> memo<span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> memo<span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Took </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77217577556433930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\n3\n6 &quot;Took 6003 ms&quot;`, `77217577556433930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\n3\n6 &quot;Took 6003 ms&quot;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="timers"><a href="#timers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Timers</h2>\n<p>在笔者这里将 Node.js 中的异步简单的划分为两种, 硬异步和软异步.</p>\n<p>硬异步是指由于 IO 操作或者外部调用走 libuv 而需要异步的情况. 当然, 也存在 readFileSync, execSync 等例外情况, 不过 node 由于是单线程的, 所以如果常规业务在普通时段执行可能比较耗时同步的 IO 操作会使得其执行过程中其他的所有操作都不能响应, 有点作死的感觉. 不过在启动/初始化以及一些工具脚本的应用场景下是完全没问题的. 而一般的场景下 IO 操作都是需要异步的.</p>\n<p>软异步是指, 通过 setTimeout 等方式来实现的异步.</p>\n<blockquote>\n<p>关于 nextTick, setTimeout 以及 setImmediate 三者的区别</p>\n</blockquote>\n<p>setImmediate vs process.nextTick</p>\n<ul>\n<li>setImmediate() 属于 check 观察者，其设置的回调函数，会插入到下次事件循环的末尾。</li>\n<li>process.nextTick() 设置的回调函数，会在代码运行完成后立即执行，会在下次事件循环之前被调用，原文是 “the callback will fire as soon as the code runs to completion, but before going back to the event loop.”</li>\n<li>process.nextTick() 所设置的回调函数会存放到数组中，一次性执行所有回调函数。</li>\n<li>setImmediate() 所设置的回调函数会存到到链表中，每次事件循环只执行链表中的一个回调函数。</li>\n</ul>\n<p>setTimeout(fn, 0) vs setImmediate</p>\n<p>执行 setTimeout(fn, 0) 其实就是在执行 setTimeout(fn, 1)，也就是说 setImmediate() 是有可能先于 setTimeout(fn, 0) 执行的。</p>\n<p><strong>Event loop 示例</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63339056777945070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`   ┌───────────────────────┐\n┌─>│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │<─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘`, `63339056777945070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   ┌───────────────────────┐\n┌─&gt;│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │&lt;─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于事件循环, Timers 以及 nextTick 的关系详见官方文档 The Node.js Event Loop, Timers, and process.nextTick()，<a href="https://cnodejs.org/topic/57d68794cb6f605d360105bf" target="_blank" rel="nofollow noreferrer noopener">论坛中文讨论</a></p>\n<h2 id="并行并发"><a href="#%E5%B9%B6%E8%A1%8C%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并行/并发</h2>\n<p>并行 (Parallel) 与并发 (Concurrent) 是两个很常见的概念.</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-12-28-16-48-29-2c9dcd4d600f1c599ca6da6b36ec75a4-81a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 600px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABZ0lEQVQoz5WT627CMAyF9/7vB4P9QKJA2ySlaZve6WVf460TU4e0I2EZJ8c+PoG3eZ77vu+67vF4NE0zjuOaS51Y13VeFEvM87Zt52+88aGaWpvleZIkXC1ckdnsfr9rrXOPqqrIy7KkmKbpE1nATA4SD20M7aI4IrfWjtME32hzvV7p9Zs8TROx7brL5cKNKIrOQRCGoVKKPPeijDG7/T7Lso3J0mLZUyzoezYfhoGIKBKTGIsea9dhT+TXgDB4PE0ePahOHr2f2XuI+RxhPr5SIaHyMxkPozi+3W4cQEOYcw6RSmsIfCWyvywfqxi4svwiix4ZK3sycBUpdXnRoihc6eR0wzDan04nIvaG0TINQtMumrVWu/3u+HHcdvs1eGoWpynq/iSzOb/BxqPtWjEMVNXCxCDRvEEW5bglxpBwG811U8dKvR8OQXBmZ7n5D9k8Acrp9Ur2qmr1WcAu/D2QgzRa0OsTRU1mtMrl/5sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 12 28 16 48 29" title="" data-src="/static/2020-12-28-16-48-29-2c9dcd4d600f1c599ca6da6b36ec75a4-81a6c.png" data-srcset="/static/2020-12-28-16-48-29-2c9dcd4d600f1c599ca6da6b36ec75a4-468c3.png 200w,\n/static/2020-12-28-16-48-29-2c9dcd4d600f1c599ca6da6b36ec75a4-3ff2b.png 400w,\n/static/2020-12-28-16-48-29-2c9dcd4d600f1c599ca6da6b36ec75a4-81a6c.png 600w" data-sizes="(max-width: 600px) 100vw, 600px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>并发 (Concurrent) = 2 队列对应 1 咖啡机.</p>\n<p>并行 (Parallel) = 2 队列对应 2 咖啡机.</p>\n<p>Node.js 通过事件循环来挨个抽取事件队列中的一个个 Task 执行, 从而避免了传统的多线程情况下 <code class="language-text">2个队列对应 1个咖啡机</code> 的时候上下文切换以及资源争抢/同步的问题, 所以获得了高并发的成就.</p>\n<p>至于在 node 中并行, 你可以通过 cluster 来再添加一个咖啡机.</p>\n<h1 id="进程"><a href="#%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程</h1>\n<h2 id="简述-2"><a href="#%E7%AE%80%E8%BF%B0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>关于 Process, 我们需要讨论的是两个概念：操作系统的进程、Node.js 中的 Process 对象. 操作进程对于服务端而言, 好比 html 之于前端一样基础. 想做服务端编程是不可能绕过 Unix/Linux 的. 在 Linux/Unix/Mac 系统中运行 ps -ef 命令可以看到当前系统中运行的进程. 各个参数如下:</p>\n<table>\n<thead>\n<tr>\n<th>列名称</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UID</td>\n<td>执行该进程的用户 ID</td>\n</tr>\n<tr>\n<td>PID</td>\n<td>进程编号</td>\n</tr>\n<tr>\n<td>PPID</td>\n<td>该进程的父进程编号</td>\n</tr>\n<tr>\n<td>C</td>\n<td>该进程所在的 CPU 利用率</td>\n</tr>\n<tr>\n<td>STIME</td>\n<td>进程执行时间</td>\n</tr>\n<tr>\n<td>TTY</td>\n<td>进程相关的终端类型</td>\n</tr>\n<tr>\n<td>TIME</td>\n<td>进程所占用的 CPU 时间</td>\n</tr>\n<tr>\n<td>CMD</td>\n<td>创建该进程的指令</td>\n</tr>\n</tbody>\n</table>\n<p>关于进程以及操作系统一些更深入的细节推荐阅读 APUE, 即《Unix 高级编程》等书籍来了解.</p>\n<h2 id="process"><a href="#process" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Process</h2>\n<p>这里来讨论 Node.js 中的 process 对象. 直接在代码中通过 console.log(process) 即可打印出来. 可以看到 process 对象暴露了非常多有用的属性以及方法, 具体的细节见<a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>, 已经说的挺详细了. 其中包括但不限于:</p>\n<ul>\n<li>进程基础信息</li>\n<li>进程 Usage</li>\n<li>进程级事件</li>\n<li>依赖模块/版本信息</li>\n<li>OS 基础信息</li>\n<li>账户信息</li>\n<li>信号收发</li>\n<li>三个标准流</li>\n</ul>\n<h3 id="processnexttick"><a href="#processnexttick" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>process.nextTick</h3>\n<p>上一节已经提到过 process.nextTick 了, 这是一个你需要了解的, 重要的, 基础方法.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41051881970389670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`   ┌───────────────────────┐\n┌─>│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │<─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘`, `41051881970389670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   ┌───────────────────────┐\n┌─&gt;│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │&lt;─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>process.nextTick 并不属于 Event loop 中的某一个阶段, 而是在 Event loop 的每一个阶段结束后, 直接执行 nextTickQueue 中插入的 “Tick”, 并且直到整个 Queue 处理完. 所以面试时又有可以问的问题了, 递归调用 process.nextTick 会怎么样?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62758789415777680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  process.nextTick(() => test());\n}`, `62758789415777680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>超过 1000 次会提示调用栈过多</p>\n<p>这种情况与以下情况, 有什么区别? 为什么?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26381968848826597000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  setTimeout(() => test(), 0);\n}`, `26381968848826597000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>process.nextTick 是将异步回调放到当前帧的末尾、io 回调之前，如果 nextTick 过多，会导致 io 回调不断延后,最后 callback 堆积太多.</li>\n<li>setImmediate 是将异步回调放到下一帧，不影响 io 回调，不会造成 callback 堆积.</li>\n<li>process.nextTick() 所设置的回调函数会存放到数组中，一次性执行所有回调函数。</li>\n<li>setImmediate() 所设置的回调函数会存到到链表中，每次事件循环只执行链表中的一个回调函数。</li>\n</ul>\n<h3 id="配置"><a href="#%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置</h3>\n<p>配置是开发部署中一个很常见的问题，普通的配置有两种方式，一是定义配置文件，二是使用环境变量</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-9cc21.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.53094705443698%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB8klEQVQoz5VTzW7TQBD2M8Cdx6k4gDggpHIATiAkKt6AAzceoBIcQU0L6gX1Uio1gHCkQpXEaX7sOMFNgaiEOLbXdtY/u94fxjaUNoJKjL4djXb2m5lvpFXk/5soAKYIIVzPD/wwDOZhCMAQz0PsuGhquxhHcZQApjMXocCeeY6DGGNlFQVO+/Cophu1nvGhq6s9Y98cfuwP1I5ebR58Moet0VHDOnzf6qhdfc8wa119gsNZEhHGcnImRCoYEbz0UkJhCtdFAEkiBC2Dct6McwCMrCzqKEj0FLJ/i1f+rEHwOI4jjLPPj6S5LAd35OB2jv4t2boptWWp3SCoH6f8pI9S0ASlNE1Tz/Omtr316uGL1aX1Z9fWn159vnple+060e6z9gPZWyGBlZCzZM655yHk+xhj4C89Vi/e27208hZw4e7O5ScNFMuUifPGLoSL4/GkXTVdz80yWApjnIEvMgD+FzKMne9O5LVjHE/HDqUZqCCExkmSpLklBQil8IiX7xc6/y4EOgTLnVjIybM3OXkUeBaapbDqOCr5v6ZIUq3Tr3eMum7WzWHDsppfRtr4q/b9W3MynhOSkzvOjwP72PeQ47on/cG7KKi83l7b2qm82a1U322o6sv9vU2tvtnVNnRtgufK+X+A5xpEKfI0yuo/AXKSCb5V5ycaAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 04 10 46 00" title="" data-src="/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-fee1c.png" data-srcset="/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-a67b7.png 200w,\n/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-0b187.png 400w,\n/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-fee1c.png 800w,\n/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-b1a91.png 1200w,\n/static/2021-01-04-10-46-00-ac04491ad264ea0b2564a706e995dd40-9cc21.png 1341w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可以通过设置环境变量来指定配置, 然后通过 process.env 来获取配置项. 另外也可以通过读取定义好的配置文件来获取, 在这方面有很多不错的库例如 dotenv, node-config 等, 而在使用这些库来加载配置文件的时候, 通常都会碰到一个当前工作目录的问题</p>\n<blockquote>\n<p>进程的当前工作目录是什么? 有什么作用?</p>\n</blockquote>\n<p>当前进程启动的目录, 通过 process.cwd() 获取当前工作目录 (current working directory), 通常是命令行启动的时候所在的目录 (也可以在启动时指定), 文件操作等使用相对路径的时候会相对当前工作目录来获取文件.</p>\n<p>一些获取配置的第三方模块就是通过你的当前目录来找配置文件的. 所以如果你错误的目录启动脚本, 可能没法得到正确的结果. 在程序中可以通过 process.chdir() 来改变当前的工作目录.</p>\n<h3 id="标准流"><a href="#%E6%A0%87%E5%87%86%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标准流</h3>\n<p>在 process 对象上还暴露了 process.stderr, process.stdout 以及 process.stdin 三个标准流, 熟悉 C/C++/Java 的同学应该对此比较熟悉. 关于这几个流, 常见的面试问题是问 console.log 是同步还是异步? 如何实现一个 console.log?</p>\n<p>如果简历中有出现 C/C++ 关键字, 一般都会问到如何实现一个同步的输入 (类似实现 C 语言的 scanf, C++ 的 cin, Python 的 raw_input 等).</p>\n<h3 id="维护方面"><a href="#%E7%BB%B4%E6%8A%A4%E6%96%B9%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>维护方面</h3>\n<p>熟悉与进程有关的基础命令, 如 top, ps, pstree 等命令</p>\n<h2 id="child-process"><a href="#child-process" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Child Process</h2>\n<p>子进程 (Child Process) 是进程中一个重要的概念. 你可以通过 Node.js 的 child_process 模块来执行可执行文件, 调用命令行命令, 比如其他语言的程序等. 也可以通过该模块来将 .js 代码以子进程的方式启动. 比较有名的网易的分布式架构 pomelo 就是基于该模块 (而不是 cluster) 来实现多进程分布式架构的.</p>\n<blockquote>\n<p>child_process.fork 与 POSIX 的 fork 有什么区别?</p>\n</blockquote>\n<p>Node.js 的 child<em>process.fork() 在 Unix 上的实现最终调用了 POSIX <a href="http://man7.org/linux/man-pages/man2/fork.2.html" target="_blank" rel="nofollow noreferrer noopener">fork(2)</a>, 而 POSIX 的 fork 需要手动管理子进程的资源释放 (waitpid), child</em>process.fork 则不用关心这个问题, Node.js 会自动释放, 并且可以在 option 中选择父进程死后是否允许子进程存活.</p>\n<ul>\n<li>\n<p>spawn() 启动一个子进程来执行命令</p>\n<ul>\n<li>options.detached 父进程死后是否允许子进程存活</li>\n<li>options.stdio 指定子进程的三个标准流</li>\n</ul>\n</li>\n<li>spawnSync() 同步版的 spawn, 可指定超时, 返回的对象可获得子进程的情况</li>\n<li>exec() 启动一个子进程来执行命令, 带回调参数获知子进程的情况, 可指定进程运行的超时时间</li>\n<li>execSync() 同步版的 exec(), 可指定超时, 返回子进程的输出 (stdout)</li>\n<li>execFile() 启动一个子进程来执行一个可执行文件, 可指定进程运行的超时时间</li>\n<li>execFileSync() 同步版的 execFile(), 返回子进程的输出, 如何超时或者 exit code 不为 0, 会直接 throw Error</li>\n<li>fork() 加强版的 spawn(), 返回值是 ChildProcess 对象可以与子进程交互</li>\n</ul>\n<p>其中 exec/execSync 方法会直接调用 bash 来解释命令, 所以如果有命令有外部参数, 则需要注意被注入的情况.</p>\n<h3 id="childkill-与-childsend"><a href="#childkill-%E4%B8%8E-childsend" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>child.kill 与 child.send</h3>\n<p>常见会问的面试题, 如 child.kill 与 child.send 的区别. 二者一个是基于信号系统, 一个是基于 IPC.</p>\n<blockquote>\n<p>父进程或子进程的死亡是否会影响对方? 什么是孤儿进程?</p>\n</blockquote>\n<p>子进程死亡不会影响父进程, 不过子进程死亡时（线程组的最后一个线程，通常是“领头”线程死亡时），会向它的父进程发送死亡信号. 反之父进程死亡, 一般情况下子进程也会随之死亡, 但如果此时子进程处于可运行态、僵死状态等等的话, 子进程将被进程 1（init 进程）收养，从而成为孤儿进程. 另外, 子进程死亡的时候（处于“终止状态”），父进程没有及时调用 wait() 或 waitpid() 来返回死亡进程的相关信息，此时子进程还有一个 PCB 残留在进程表中，被称作僵尸进程.</p>\n<h2 id="cluster"><a href="#cluster" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cluster</h2>\n<p>Cluster 是常见的 Node.js 利用多核的办法. 它是基于 child_process.fork() 实现的, 所以 cluster 产生的进程之间是通过 IPC 来通信的, 并且它也没有拷贝父进程的空间, 而是通过加入 cluster.isMaster 这个标识, 来区分父进程以及子进程, 达到类似 POSIX 的 fork 的效果.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67335379544123010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cluster = require(\'cluster\'); // | |\nconst http = require(\'http\'); // | |\nconst numCPUs = require(\'os\').cpus().length; // | |    都执行了\n// | |\nif (cluster.isMaster) {\n  // |-|-----------------\n  // Fork workers.                             //   |\n  for (var i = 0; i < numCPUs; i++) {\n    //   |\n    cluster.fork(); //   |\n  } //   | 仅父进程执行 (a.js)\n  cluster.on(\'exit\', (worker) => {\n    //   |\n    console.log(\\`\\${worker.process.pid} died\\`); //   |\n  }); //   |\n} else {\n  // |-------------------\n  // Workers can share any TCP connection      // |\n  // In this case it is an HTTP server         // |\n  http\n    .createServer((req, res) => {\n      // |\n      res.writeHead(200); // |   仅子进程执行 (b.js)\n      res.end(\'hello world\\n\'); // |\n    })\n    .listen(8000); // |\n} // |-------------------\n// | |\nconsole.log(\'hello\'); // | |    都执行了`, `67335379544123010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'cluster\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |</span>\n<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |</span>\n<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// | |    都执行了</span>\n<span class="token comment">// | |</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// |-|-----------------</span>\n  <span class="token comment">// Fork workers.                             //   |</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//   |</span>\n    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n  <span class="token punctuation">}</span> <span class="token comment">//   | 仅父进程执行 (a.js)</span>\n  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">//   |</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> died</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// |-------------------</span>\n  <span class="token comment">// Workers can share any TCP connection      // |</span>\n  <span class="token comment">// In this case it is an HTTP server         // |</span>\n  http\n    <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// |</span>\n      res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |   仅子进程执行 (b.js)</span>\n      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">\'hello world\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |</span>\n<span class="token punctuation">}</span> <span class="token comment">// |-------------------</span>\n<span class="token comment">// | |</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |    都执行了</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中 numCPUs 虽然是全局变量但是, 在父进程中修改它, 子进程中并不会改变, 因为父进程与子进程是完全独立的两个空间. 他们所谓的共有仅仅只是都执行了, 并不是同一份.</p>\n<p>你可以把父进程执行的部分当做 a.js, 子进程执行的部分当做 b.js, 你可以把他们想象成是先执行了 node a.js 然后 cluster.fork 了几次, 就执行了几次 node b.js. 而 cluster 模块则是二者之间的一个桥梁, 你可以通过 cluster 提供的方法, 让其二者之间进行沟通交流.</p>\n<h3 id="how-it-works"><a href="#how-it-works" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How It Works</h3>\n<p>worker 进程是由 child_process.fork() 方法创建的, 所以可以通过 IPC 在主进程和子进程之间相互传递服务器句柄.</p>\n<p>cluster 模块提供了两种分发连接的方式.</p>\n<p>第一种方式 (默认方式, 不适用于 windows), 通过时间片轮转法（round-robin）分发连接. 主进程监听端口, 接收到新连接之后, 通过时间片轮转法来决定将接收到的客户端的 socket 句柄传递给指定的 worker 处理. 至于每个连接由哪个 worker 来处理, 完全由内置的循环算法决定.</p>\n<p>第二种方式是由主进程创建 socket 监听端口后, 将 socket 句柄直接分发给相应的 worker, 然后当连接进来时, 就直接由相应的 worker 来接收连接并处理.</p>\n<p>使用第二种方式时理论上性能应该较高, 然而时间上存在负载不均衡的问题, 比如通常 70% 的连接仅被 8 个进程中的 2 个处理, 而其他进程比较清闲.</p>\n<h2 id="进程间通信"><a href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程间通信</h2>\n<p>IPC (Inter-process communication) 进程间通信技术. 常见的进程间通信技术列表如下:</p>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>无连接</th>\n<th>可靠</th>\n<th>流控制</th>\n<th>优先级</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>普通 PIPE</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>命名 PIPE</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>消息队列</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>信号量</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>共享存储</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>UNIX 流 SOCKET</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>UNIX 数据包 SOCKET</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n<td>N</td>\n</tr>\n</tbody>\n</table>\n<p>Node.js 中的 IPC 通信是由 libuv 通过管道技术实现的, 在 windows 下由命名管道（named pipe）实现也就是上表中的最后第二个, *nix 系统则采用 UDS (Unix Domain Socket) 实现.</p>\n<p>普通的 socket 是为网络通讯设计的, 而网络本身是不可靠的, 而为 IPC 设计的 socket 则不然, 因为默认本地的网络环境是可靠的, 所以可以简化大量不必要的 encode/decode 以及计算校验等, 得到效率更高的 UDS 通信.</p>\n<p>如果了解 Node.js 的 IPC 的话, 可以问个比较有意思的问题</p>\n<blockquote>\n<p>在 IPC 通道建立之前, 父进程与子进程是怎么通信的? 如果没有通信, 那 IPC 是怎么建立的?</p>\n</blockquote>\n<p>这个问题也挺简单, 只是个思路的问题. 在通过 <code class="language-text">child_process</code> 建立子进程的时候, 是可以指定子进程的 env (环境变量) 的. 所以 Node.js 在启动子进程的时候, 主进程先建立 IPC 频道, 然后将 IPC 频道的 fd (文件描述符) 通过环境变量 (<code class="language-text">NODE_CHANNEL_FD</code>) 的方式传递给子进程, 然后子进程通过 fd 连上 IPC 与父进程建立连接.</p>\n<p>最后于进程间通信 (IPC) 的问题, 一般不会直接问 IPC 的实现, 而是会问什么情况下需要 IPC, 以及使用 IPC 处理过什么业务场景等.</p>\n<h2 id="守护进程"><a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>守护进程</h2>\n<p>最后的守护进程, 是服务端方面一个很基础的概念了. 很多人可能只知道通过 pm2 之类的工具可以将进程以守护进程的方式启动, 却不了解什么是守护进程, 为什么要用守护进程. 对于水平好的同学, 我们是希望能了解守护进程的实现的.</p>\n<p>普通的进程, 在用户退出终端之后就会直接关闭. 通过 &#x26; 启动到后台的进程, 之后会由于会话（session 组）被回收而终止进程. 守护进程是不依赖终端（tty）的进程, 不会因为用户退出终端而停止运行的进程.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61797073805997910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 守护进程实现 (C语言版本)\nvoid init_daemon()\n{\n    pid_t pid;\n    int i = 0;\n\n    if ((pid = fork()) == -1) {\n        printf(&quot;Fork error !\\n&quot;);\n        exit(1);\n    }\n\n    if (pid != 0) {\n        exit(0);        // 父进程退出\n    }\n\n    setsid();           // 子进程开启新会话, 并成为会话首进程和组长进程\n    if ((pid = fork()) == -1) {\n        printf(&quot;Fork error !\\n&quot;);\n        exit(-1);\n    }\n    if (pid != 0) {\n        exit(0);        // 结束第一子进程, 第二子进程不再是会话首进程\n                        // 避免当前会话组重新与tty连接\n    }\n    chdir(&quot;/tmp&quot;);      // 改变工作目录\n    umask(0);           // 重设文件掩码\n    for (; i < getdtablesize(); ++i) {\n       close(i);        // 关闭打开的文件描述符\n    }\n\n    return;\n}`, `61797073805997910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// 守护进程实现 (C语言版本)</span>\n<span class="token keyword">void</span> <span class="token function">init_daemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    pid_t pid<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fork error !\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父进程退出</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 子进程开启新会话, 并成为会话首进程和组长进程</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fork error !\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 结束第一子进程, 第二子进程不再是会话首进程</span>\n                        <span class="token comment">// 避免当前会话组重新与tty连接</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 改变工作目录</span>\n    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 重设文件掩码</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getdtablesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n       <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 关闭打开的文件描述符</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6947220841048462000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var spawn = require(\'child_process\').spawn;\nvar process = require(\'process\');\n\nvar p = spawn(\'node\', [\'b.js\'], {\n  detached: true\n});\nconsole.log(process.pid, p.pid);\nprocess.exit(0);`, `6947220841048462000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> spawn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>spawn<span class="token punctuation">;</span>\n<span class="token keyword">var</span> process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'node\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'b.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  detached<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>\nprocess<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="io"><a href="#io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO</h1>\n<h2 id="简述-3"><a href="#%E7%AE%80%E8%BF%B0-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>Node.js 是以 IO 密集型业务著称. 那么问题来了, 你真的了解什么叫 IO, 什么又叫 IO 密集型业务吗?</p>\n<h2 id="buffer"><a href="#buffer" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Buffer</h2>\n<p>Buffer 是 Node.js 中用于处理二进制数据的类, 其中与 IO 相关的操作 (网络/文件等) 均基于 Buffer. Buffer 类的实例非常类似整数数组, 但其大小是固定不变的, 并且其内存在 V8 堆栈外分配原始内存空间. Buffer 类的实例创建之后, 其所占用的内存大小就不能再进行调整.</p>\n<p>在 Node.js v6.x 之后 new Buffer() 接口开始被废弃, 理由是参数类型不同会返回不同类型的 Buffer 对象, 所以当开发者没有正确校验参数或没有正确初始化 Buffer 对象的内容时, 以及不了解的情况下初始化 就会在不经意间向代码中引入安全性和可靠性问题.</p>\n<table>\n<thead>\n<tr>\n<th>接口</th>\n<th>用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Buffer.from()</td>\n<td>根据已有数据生成一个 Buffer 对象</td>\n</tr>\n<tr>\n<td>Buffer.alloc()</td>\n<td>创建一个初始化后的 Buffer 对象</td>\n</tr>\n<tr>\n<td>Buffer.allocUnsafe()</td>\n<td>创建一个未初始化的 Buffer 对象</td>\n</tr>\n</tbody>\n</table>\n<h3 id="typedarray"><a href="#typedarray" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TypedArray</h3>\n<p>Node.js 的 Buffer 在 ES6 增加了 TypedArray 类型之后, 修改了原来的 Buffer 的实现, 选择基于 TypedArray 中 Uint8Array 来实现, 从而提升了一波性能.</p>\n<p>使用上, 你需要了解如下情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4582685621472504300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const arr = new Uint16Array(2);\narr[0] = 5000;\narr[1] = 4000;\n\nconst buf1 = Buffer.from(arr); // 拷贝了该 buffer\nconst buf2 = Buffer.from(arr.buffer); // 与该数组共享了内存\n\nconsole.log(buf1);\n// 输出: <Buffer 88 a0>, 拷贝的 buffer 只有两个元素\nconsole.log(buf2);\n// 输出: <Buffer 88 13 a0 0f>\n\narr[1] = 6000;\nconsole.log(buf1);\n// 输出: <Buffer 88 a0>\nconsole.log(buf2);\n// 输出: <Buffer 88 13 70 17>`, `4582685621472504300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\narr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝了该 buffer</span>\n<span class="token keyword">const</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 与该数组共享了内存</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 a0>, 拷贝的 buffer 只有两个元素</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 13 a0 0f></span>\n\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 a0></span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 13 70 17></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="string-decoder"><a href="#string-decoder" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>String Decoder</h2>\n<p>字符串解码器 (String Decoder) 是一个用于将 Buffer 拿来 decode 到 string 的模块, 是作为 Buffer.toString 的一个补充, 它支持多字节 UTF-8 和 UTF-16 字符. 例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73555055325350584000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const StringDecoder = require(\'string_decoder\').StringDecoder;\nconst decoder = new StringDecoder(\'utf8\');\n\nconst cent = Buffer.from([0xc2, 0xa2]);\nconsole.log(decoder.write(cent)); // ¢\n\nconst euro = Buffer.from([0xe2, 0x82, 0xac]);\nconsole.log(decoder.write(euro)); // €`, `73555055325350584000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'string_decoder\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>\n<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cent <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xc2</span><span class="token punctuation">,</span> <span class="token number">0xa2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ¢</span>\n\n<span class="token keyword">const</span> euro <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xe2</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xac</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>euro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// €</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>stringDecoder.write 会确保返回的字符串不包含 Buffer 末尾残缺的多字节字符，残缺的多字节字符会被保存在一个内部的 buffer 中用于下次调用 stringDecoder.write() 或 stringDecoder.end()。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35622610602830053000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const StringDecoder = require(\'string_decoder\').StringDecoder;\nconst decoder = new StringDecoder(\'utf8\');\n\ndecoder.write(Buffer.from([0xe2]));\ndecoder.write(Buffer.from([0x82]));\nconsole.log(decoder.end(Buffer.from([0xac]))); // €`, `35622610602830053000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'string_decoder\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>\n<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndecoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xe2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ndecoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x82</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xac</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// €</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="stream"><a href="#stream" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stream</h2>\n<p>Node.js 内置的 stream 模块是多个核心模块的基础. 但是流 (stream) 是一种很早之前流行的编程方式. 可以用大家比较熟悉的 C 语言来看这种流式操作:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47967896923413320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int copy(const char *src, const char *dest)\n{\n    FILE *fpSrc, *fpDest;\n    char buf[BUF_SIZE] = {0};\n    int lenSrc, lenDest;\n\n    // 打开 src 的文件\n    if ((fpSrc = fopen(src, &quot;r&quot;)) == NULL)\n    {\n        printf(&quot;文件 \'%s\' 无法打开\\n&quot;, src);\n        return FAILURE;\n    }\n\n    // 打开 dest 的文件\n    if ((fpDest = fopen(dest, &quot;w&quot;)) == NULL)\n    {\n        printf(&quot;文件 \'%s\' 无法打开\\n&quot;, dest);\n        fclose(fpSrc);\n        return FAILURE;\n    }\n\n    // 从 src 中读取 BUF_SIZE 长的数据到 buf 中\n    while ((lenSrc = fread(buf, 1, BUF_SIZE, fpSrc)) > 0)\n    {\n        // 将 buf 中的数据写入 dest 中\n        if ((lenDest = fwrite(buf, 1, lenSrc, fpDest)) != lenSrc)\n        {\n            printf(&quot;写入文件 \'%s\' 失败\\n&quot;, dest);\n            fclose(fpSrc);\n            fclose(fpDest);\n            return FAILURE;\n        }\n        // 写入成功后清空 buf\n        memset(buf, 0, BUF_SIZE);\n    }\n\n    // 关闭文件\n    fclose(fpSrc);\n    fclose(fpDest);\n    return SUCCESS;\n}`, `47967896923413320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    FILE <span class="token operator">*</span>fpSrc<span class="token punctuation">,</span> <span class="token operator">*</span>fpDest<span class="token punctuation">;</span>\n    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">int</span> lenSrc<span class="token punctuation">,</span> lenDest<span class="token punctuation">;</span>\n\n    <span class="token comment">// 打开 src 的文件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpSrc <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件 \'%s\' 无法打开\\n"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 打开 dest 的文件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpDest <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件 \'%s\' 无法打开\\n"</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 从 src 中读取 BUF_SIZE 长的数据到 buf 中</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenSrc <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> fpSrc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// 将 buf 中的数据写入 dest 中</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenDest <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lenSrc<span class="token punctuation">,</span> fpDest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> lenSrc<span class="token punctuation">)</span>\n        <span class="token punctuation">{</span>\n            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入文件 \'%s\' 失败\\n"</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 写入成功后清空 buf</span>\n        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 关闭文件</span>\n    <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>应用的场景很简单, 你要拷贝一个 20G 大的文件, 如果你一次性将 20G 的数据读入到内存, 你的内存条可能不够用, 或者严重影响性能. 但是你如果使用一个 1MB 大小的缓存 (buf) 每次读取 1Mb, 然后写入 1Mb, 那么不论这个文件多大都只会占用 1Mb 的内存.</p>\n<p>而在 Node.js 中, 原理与上述 C 代码类似, 不过在读写的实现上通过 libuv 与 EventEmitter 加上了异步的特性. 在 linux/unix 中你可以通过 | 来感受到流式操作.</p>\n<h3 id="stream-的类型"><a href="#stream-%E7%9A%84%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stream 的类型</h3>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>使用场景</th>\n<th>重写方法</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#readable-streams" target="_blank" rel="nofollow noreferrer noopener">Readable</a></td>\n<td>只读</td>\n<td>_\nread</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#writable-streams" target="_blank" rel="nofollow noreferrer noopener">Writable</a></td>\n<td>只写</td>\n<td>_\nwrite</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#duplex" target="_blank" rel="nofollow noreferrer noopener">Duplex</a></td>\n<td>读写</td>\n<td>_\nread, \n_\nwrite</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#transform" target="_blank" rel="nofollow noreferrer noopener">Transform</a></td>\n<td>操作被写入数据, 然后读出结果</td>\n<td>_\ntransform, \n_\nflush</td>\n</tr>\n</tbody>\n</table>\n<h3 id="对象模式"><a href="#%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象模式</h3>\n<p>通过 Node API 创建的流, 只能够对字符串或者 buffer 对象进行操作. 但其实流的实现是可以基于其他的 JavaScript 类型(除了 null, 它在流中有特殊的含义)的. 这样的流就处在 “对象模式(objectMode)” 中. 在创建流对象的时候, 可以通过提供 <code class="language-text">objectMode</code> 参数来生成对象模式的流. 试图将现有的流转换为对象模式是不安全的</p>\n<h3 id="缓冲区"><a href="#%E7%BC%93%E5%86%B2%E5%8C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓冲区</h3>\n<p>Node.js 中 stream 的缓冲区, 以开头的 C 语言拷贝文件的代码为模板讨论, (抛开异步的区别看) 则是从 <code class="language-text">src</code> 中读出数据到 <code class="language-text">buf</code> 中后, 并没有直接写入 <code class="language-text">dest</code> 中, 而是先放在一个比较大的缓冲区中, 等待写入(消费) <code class="language-text">dest</code> 中. 即, 在缓冲区的帮助下可以使读与写的过程分离.</p>\n<p>Readable 和 Writable 流都会将数据储存在内部的缓冲区中. 缓冲区可以分别通过 <code class="language-text">writable._writableState.getBuffer()</code> 和 <code class="language-text">readable._readableState.buffer</code> 来访问. 缓冲区的大小, 由构造 stream 时候的 <code class="language-text">highWaterMark</code> 标志指定可容纳的 byte 大小, 对于 <code class="language-text">objectMode</code> 的 stream, 该标志表示可以容纳的对象个数.</p>\n<h4 id="可读流"><a href="#%E5%8F%AF%E8%AF%BB%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可读流</h4>\n<p>当一个可读实例调用 <code class="language-text">stream.push()</code> 方法的时候, 数据将会被推入缓冲区. 如果数据没有被消费, 即调用 <code class="language-text">stream.read()</code> 方法读取的话, 那么数据会一直留在缓冲队列中. 当缓冲区中的数据到达 <code class="language-text">highWaterMark</code> 指定的阈值, 可读流将停止从底层汲取数据, 直到当前缓冲的报备成功消耗为止.</p>\n<h4 id="可写流"><a href="#%E5%8F%AF%E5%86%99%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可写流</h4>\n<p>在一个在可写实例上不停地调用 writable.write(chunk) 的时候数据会被写入可写流的缓冲区. 如果当前缓冲区的缓冲的数据量低于 <code class="language-text">highWaterMark</code> 设定的值, 调用 writable.write() 方法会返回 true (表示数据已经写入缓冲区), 否则当缓冲的数据量达到了阈值, 数据无法写入缓冲区 write 方法会返回 false, 直到 drain 事件触发之后才能继续调用 write 写入.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79650028172169970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Write the data to the supplied writable stream one million times.\n// Be attentive to back-pressure.\nfunction writeOneMillionTimes(writer, data, encoding, callback) {\n  let i = 1000000;\n  write();\n  function write() {\n    var ok = true;\n    do {\n      i--;\n      if (i === 0) {\n        // last time!\n        writer.write(data, encoding, callback);\n      } else {\n        // see if we should continue, or wait\n        // don\'t pass the callback, because we\'re not done yet.\n        ok = writer.write(data, encoding);\n      }\n    } while (i > 0 && ok);\n    if (i > 0) {\n      // had to stop early!\n      // write some more once it drains\n      writer.once(\'drain\', write);\n    }\n  }\n}`, `79650028172169970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Write the data to the supplied writable stream one million times.</span>\n<span class="token comment">// Be attentive to back-pressure.</span>\n<span class="token keyword">function</span> <span class="token function">writeOneMillionTimes</span><span class="token punctuation">(</span><span class="token parameter">writer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">do</span> <span class="token punctuation">{</span>\n      i<span class="token operator">--</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// last time!</span>\n        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// see if we should continue, or wait</span>\n        <span class="token comment">// don\'t pass the callback, because we\'re not done yet.</span>\n        ok <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// had to stop early!</span>\n      <span class="token comment">// write some more once it drains</span>\n      writer<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">\'drain\'</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="duplex-与-transform"><a href="#duplex-%E4%B8%8E-transform" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Duplex 与 Transform</h4>\n<p>Duplex 流和 Transform 流都是同时可读写的, 他们会在内部维持两个缓冲区, 分别对应读取和写入, 这样就可以允许两边同时独立操作, 维持高效的数据流. 比如说 net.Socket 是一个 Duplex 流, Readable 端允许从 socket 获取、消耗数据, Writable 端允许向 socket 写入数据. 数据写入的速度很有可能与消耗的速度有差距, 所以两端可以独立操作和缓冲是很重要的.</p>\n<h3 id="pipe"><a href="#pipe" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipe</h3>\n<p>stream 的 <code class="language-text">.pipe()</code>, 将一个可写流附到可读流上, 同时将可写流切换到流模式, 并把所有数据推给可写流. 在 pipe 传递数据的过程中, <code class="language-text">objectMode</code> 是传递引用, 非 <code class="language-text">objectMode</code> 则是拷贝一份数据传递下去.</p>\n<p>pipe 方法最主要的目的就是将数据的流动缓冲到一个可接受的水平, 不让不同速度的数据源之间的差异导致内存被占满. 关于 pipe 的实现参见 David Cai 的 <a href="https://cnodejs.org/topic/56ba030271204e03637a3870" target="_blank" rel="nofollow noreferrer noopener">通过源码解析 Node.js 中导流（pipe）的实现</a></p>\n<h2 id="console"><a href="#console" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Console</h2>\n<p><a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_a_note_on_process_i_o" target="_blank" rel="nofollow noreferrer noopener">console.log 同步还是异步取决于与谁相连和<code class="language-text">os</code></a>. 不过一般情况下的实现都是如下 (<a href="https://github.com/nodejs/node/blob/v6.x/lib/console.js#L42" target="_blank" rel="nofollow noreferrer noopener">6.x 源代码</a>)，其中 <code class="language-text">this._stdout</code> 默认是 <code class="language-text">process.stdout</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76786798895840030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// As of v8 5.0.71.32, the combination of rest param, template string\n// and .apply(null, args) benchmarks consistently faster than using\n// the spread operator when calling util.format.\nConsole.prototype.log = function(...args) {\n  this._stdout.write(\\`\\${util.format.apply(null, args)}\\n\\`);\n};`, `76786798895840030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// As of v8 5.0.71.32, the combination of rest param, template string</span>\n<span class="token comment">// and .apply(null, args) benchmarks consistently faster than using</span>\n<span class="token comment">// the spread operator when calling util.format.</span>\n<span class="token class-name">Console</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>_stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>自己实现一个 console.log 可以参考如下代码:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75385376362440430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let print = (str) => process.stdout.write(str + \'\\n\');\n\nprint(\'hello world\');`, `75385376362440430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=></span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意: 该代码并没有处理多参数, 也没有处理占位符 (即 util.format 的功能).</p>\n<h3 id="consolelogbindconsole-问题"><a href="#consolelogbindconsole-%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>console.log.bind(console) 问题</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88541145073784850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 源码出处 https://github.com/nodejs/node/blob/v6.x/lib/console.js\nfunction Console(stdout, stderr) {\n  // ... init ...\n\n  // bind the prototype functions to this Console instance\n  var keys = Object.keys(Console.prototype);\n  for (var v = 0; v < keys.length; v++) {\n    var k = keys[v];\n    this[k] = this[k].bind(this);\n  }\n}`, `88541145073784850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 源码出处 https://github.com/nodejs/node/blob/v6.x/lib/console.js</span>\n<span class="token keyword">function</span> <span class="token function">Console</span><span class="token punctuation">(</span><span class="token parameter">stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ... init ...</span>\n\n  <span class="token comment">// bind the prototype functions to this Console instance</span>\n  <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token class-name">Console</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> k <span class="token operator">=</span> keys<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="file"><a href="#file" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>File</h2>\n<p>“一切皆是文件”是 Unix/Linux 的基本哲学之一, 不仅普通的文件、目录、字符设备、块设备、套接字等在 Unix/Linux 中都是以文件被对待, 也就是说这些资源的操作对象均为 fd (文件描述符), 都可以通过同一套 system call 来读写. 在 linux 中你可以通过 ulimit 来对 fd 资源进行一定程度的管理限制.</p>\n<p>Node.js 封装了标准 POSIX 文件 I/O 操作的集合. 通过 require(‘fs’) 可以加载该模块. 该模块中的所有方法都有异步执行和同步执行两个版本. 你可以通过 fs.open 获得一个文件的文件描述符.</p>\n<h3 id="编码"><a href="#%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编码</h3>\n<p>UTF8, GBK, es6 中对编码的支持, 如何计算一个汉字的长度</p>\n<p>BOM</p>\n<h3 id="stdio"><a href="#stdio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stdio</h3>\n<p>stdio (standard input output) 标准的输入输出流, 即输入流 (stdin), 输出流 (stdout), 错误流 (stderr) 三者. 在 Node.js 中分别对应 <code class="language-text">process.stdin</code> (Readable), <code class="language-text">process.stdout</code> (Writable) 以及 <code class="language-text">process.stderr</code> (Writable) 三个 stream.</p>\n<p>输出函数是每个人在学习任何一门编程语言时所需要学到的第一个函数. 例如 C 语言的 <code class="language-text">printf(&quot;hello, world!&quot;);</code> python/ruby 的 <code class="language-text">print &#39;hello, world!&#39;</code> 以及 JavaScript 中的 <code class="language-text">console.log(&#39;hello, world!&#39;);</code></p>\n<p>以 C 语言的伪代码来看的话, 这类输出函数的实现思路如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34160317744055790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int printf(FILE *stream, 要打印的内容)\n{\n  // ...\n\n  // 1. 申请一个临时内存空间\n  char *s = malloc(4096);\n\n  // 2. 处理好要打印的的内容, 其值存储在 s 中\n  //      ...\n\n  // 3. 将 s 上的内容写入到 stream 中\n  fwrite(s, stream);\n\n  // 4. 释放临时空间\n  free(s);\n\n  // ...\n}`, `34160317744055790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> <span class="token function">printf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> 要打印的内容<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 1. 申请一个临时内存空间</span>\n  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 2. 处理好要打印的的内容, 其值存储在 s 中</span>\n  <span class="token comment">//      ...</span>\n\n  <span class="token comment">// 3. 将 s 上的内容写入到 stream 中</span>\n  <span class="token function">fwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 4. 释放临时空间</span>\n  <span class="token function">free</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要了解的是第 3 步, 其中的 stream 则是指 stdout (输出流). 实际上在 shell 上运行一个应用程序的时候, shell 做的第一个操作是 fork 当前 shell 的进程 (所以, 如果你通过 ps 去查看你从 shell 上启动的进程, 其父进程 pid 就是当前 shell 的 pid), 在这个过程中也把 shell 的 stdio 继承给了你当前的应用进程, 所以你在当前进程里面将数据写入到 stdout, 也就是写入到了 shell 的 stdout, 即在当前 shell 上显示了.</p>\n<p>输入也是同理, 当前进程继承了 shell 的 stdin, 所以当你从 stdin 中读取数据时, 其实就获取到你在 shell 上输入的数据. (PS: shell 可以是 windows 下的 cmd, powershell, 也可以是 linux 下 bash 或者 zsh 等)</p>\n<p>当你使用 ssh 在远程服务器上运行一个命令的时候, 在服务器上的命令输出虽然也是写入到服务器上 shell 的 stdout, 但是这个远程的 shell 是从 sshd 服务上 fork 出来的, 其 stdout 是继承自 sshd 的一个 fd, 这个 fd 其实是个 socket, 所以最终其实是写入到了一个 socket 中, 通过这个 socket 传输你本地的计算机上的 shell 的 stdout.</p>\n<p>如果你理解了上述情况, 那么你也就能理解为什么守护进程需要关闭 stdio, 如果切到后台的守护进程没有关闭 stdio 的话, 那么你在用 shell 操作的过程中, 屏幕上会莫名其妙的多出来一些输出. 此处对应<a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">守护进程</a>的 C 实现中的这一段:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50425003346216400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (; i < getdtablesize(); ++i) {\n  close(i);  // 关闭打开的 fd\n}`, `50425003346216400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getdtablesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 关闭打开的 fd</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Linux/unix 的 fd 都被设计为整型数字, 从 0 开始. 你可以尝试运行如下代码查看.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98255373693336390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(process.stdin.fd); // 0\nconsole.log(process.stdout.fd); // 1\nconsole.log(process.stderr.fd); // 2`, `98255373693336390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">console.log(process.stdin.fd); // 0\nconsole.log(process.stdout.fd); // 1\nconsole.log(process.stderr.fd); // 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在上一节中的 <a href="#childkill-%E4%B8%8E-childsend">在 IPC 通道建立之前, 父进程与子进程是怎么通信的? 如果没有通信, 那 IPC 是怎么建立的?</a> 中使用环境变量传递 fd 的方法, 这么看起来就很直白了, 因为传递 fd 其实是直接传递了一个整型数字.</p>\n<h3 id="如何同步的获取用户的输入"><a href="#%E5%A6%82%E4%BD%95%E5%90%8C%E6%AD%A5%E7%9A%84%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9A%84%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何同步的获取用户的输入?</h3>\n<p>如果你理解了上述的内容, 那么放到 Node.js 中来看, 获取用户的输入其实就是读取 Node.js 进程中的输入流 (即 process.stdin 这个 stream) 的数据.</p>\n<p>而要同步读取, 则是不用异步的 read 接口, 而是用同步的 readSync 接口去读取 stdin 的数据即可实现. 以下来自万能的 stackoverflow:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23730745963179810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/*\n * http://stackoverflow.com/questions/3430939/node-js-readsync-from-stdin\n * @mklement0\n */\nvar fs = require(\'fs\');\n\nvar BUFSIZE = 256;\nvar buf = new Buffer(BUFSIZE);\nvar bytesRead;\n\nmodule.exports = function() {\n  var fd = \'win32\' === process.platform ? process.stdin.fd : fs.openSync(\'/dev/stdin\', \'rs\');\n  bytesRead = 0;\n\n  try {\n    bytesRead = fs.readSync(fd, buf, 0, BUFSIZE);\n  } catch (e) {\n    if (e.code === \'EAGAIN\') {\n      // \'resource temporarily unavailable\'\n      // Happens on OS X 10.8.3 (not Windows 7!), if there\'s no\n      // stdin input - typically when invoking a script without any\n      // input (for interactive stdin input).\n      // If you were to just continue, you\'d create a tight loop.\n      console.error(\'ERROR: interactive stdin input not supported.\');\n      process.exit(1);\n    } else if (e.code === \'EOF\') {\n      // Happens on Windows 7, but not OS X 10.8.3:\n      // simply signals the end of *piped* stdin input.\n      return \'\';\n    }\n    throw e; // unexpected exception\n  }\n\n  if (bytesRead === 0) {\n    // No more stdin input available.\n    // OS X 10.8.3: regardless of input method, this is how the end\n    //   of input is signaled.\n    // Windows 7: this is how the end of input is signaled for\n    //   *interactive* stdin input.\n    return \'\';\n  }\n  // Process the chunk read.\n\n  var content = buf.toString(null, 0, bytesRead - 1);\n\n  return content;\n};`, `23730745963179810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/*\n * http://stackoverflow.com/questions/3430939/node-js-readsync-from-stdin\n * @mklement0\n */</span>\n<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> <span class="token constant">BUFSIZE</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> bytesRead<span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token string">\'win32\'</span> <span class="token operator">===</span> process<span class="token punctuation">.</span>platform <span class="token operator">?</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fd <span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">\'/dev/stdin\'</span><span class="token punctuation">,</span> <span class="token string">\'rs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  bytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    bytesRead <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'EAGAIN\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \'resource temporarily unavailable\'</span>\n      <span class="token comment">// Happens on OS X 10.8.3 (not Windows 7!), if there\'s no</span>\n      <span class="token comment">// stdin input - typically when invoking a script without any</span>\n      <span class="token comment">// input (for interactive stdin input).</span>\n      <span class="token comment">// If you were to just continue, you\'d create a tight loop.</span>\n      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'ERROR: interactive stdin input not supported.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'EOF\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Happens on Windows 7, but not OS X 10.8.3:</span>\n      <span class="token comment">// simply signals the end of *piped* stdin input.</span>\n      <span class="token keyword">return</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// unexpected exception</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// No more stdin input available.</span>\n    <span class="token comment">// OS X 10.8.3: regardless of input method, this is how the end</span>\n    <span class="token comment">//   of input is signaled.</span>\n    <span class="token comment">// Windows 7: this is how the end of input is signaled for</span>\n    <span class="token comment">//   *interactive* stdin input.</span>\n    <span class="token keyword">return</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Process the chunk read.</span>\n\n  <span class="token keyword">var</span> content <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> content<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="readline"><a href="#readline" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Readline</h2>\n<p><code class="language-text">readline</code> 模块提供了一个用于从 Readble 的 stream (例如 process.stdin) 中一次读取一行的接口. 当然你也可以用来读取文件或者 net, http 的 stream, 比如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5628653851973975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const readline = require(\'readline\');\nconst fs = require(\'fs\');\n\nconst rl = readline.createInterface({\n  input: fs.createReadStream(\'sample.txt\')\n});\n\nrl.on(\'line\', (line) => {\n  console.log(\\`Line from file: \\${line}\\`);\n});`, `5628653851973975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'readline\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  input<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">\'sample.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'line\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">line</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Line from file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实现上, realine 在读取 TTY 的数据时, 是通过 <code class="language-text">input.on(&#39;keypress&#39;, onkeypress)</code> 时发现用户按下了回车键来判断是新的 line 的, 而读取一般的 stream 时, 则是通过缓存数据然后用正则 .test 来判断是否为 new line 的.</p>\n<p>PS: 打个广告, 如果在编写脚本时, 不习惯这样异步获取输入, 想要同步获取同步的用户输入可以看一看这个 Node.js 版本类 C 语言使用的 <a href="https://github.com/Lellansin/node-scanf/" target="_blank" rel="nofollow noreferrer noopener">scanf</a> 模块 (支持 ts).</p>\n<h2 id="repl"><a href="#repl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>REPL</h2>\n<p>Read-Eval-Print-Loop (REPL)</p>\n<h1 id="network"><a href="#network" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Network</h1>\n<h2 id="net"><a href="#net" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Net</h2>\n<p>目前互联化的核心是建立在 TCP/IP 协议的基础上的, 这些协议将数据分割成小的数据包进行传输, 并且解决传输过程中各种各样复杂的问题. 关于协议的具体细节推荐阅读 W.Richard Stevens 的<a href="https://www.amazon.cn/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71-%E5%8D%8F%E8%AE%AE-W-Richard-Stevens/dp/B00116OTVS/" target="_blank" rel="nofollow noreferrer noopener">《TCP/IP 详解 卷 1：协议》</a>, 本文不做赘述, 只是列举一些常见的知识点, 新人推荐看<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00DMS9990/" target="_blank" rel="nofollow noreferrer noopener">《图解 TCP/IP》</a>, 抓包工具推荐看<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00PB5QQ84/" target="_blank" rel="nofollow noreferrer noopener">《Wireshark 网络分析就这么简单》</a>.</p>\n<h3 id="粘包"><a href="#%E7%B2%98%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>粘包</h3>\n<p>默认情况下, TCP 连接会启用延迟传送算法 (Nagle 算法), 在数据发送之前缓存他们. 如果短时间有多个数据发送, 会缓冲到一起作一次发送 (缓冲大小见 <code class="language-text">socket.bufferSize</code>), 这样可以减少 IO 消耗提高性能.</p>\n<p>如果是传输文件的话, 那么根本不用处理粘包的问题, 来一个包拼一个包就好了. 但是如果是多条消息, 或者是别的用途的数据那么就需要处理粘包.</p>\n<p>可以参见网上流传比较广的一个例子, 连续调用两次 send 分别发送两段数据 data1 和 data2, 在接收端有以下几种常见的情况:</p>\n<ul>\n<li>A. 先接收到 data1, 然后接收到 data2 .</li>\n<li>B. 先接收到 data1 的部分数据, 然后接收到 data1 余下的部分以及 data2 的全部.</li>\n<li>C. 先接收到了 data1 的全部数据和 data2 的部分数据, 然后接收到了 data2 的余下的数据.</li>\n<li>D. 一次性接收到了 data1 和 data2 的全部数据.</li>\n</ul>\n<p>其中的 BCD 就是我们常见的粘包的情况. 而对于处理粘包的问题, 常见的解决方案有:</p>\n<ol>\n<li>多次发送之前间隔一个等待时间</li>\n<li>关闭 Nagle 算法</li>\n<li>进行封包/拆包</li>\n</ol>\n<p><strong><em>方案 1</em></strong></p>\n<p>只需要等上一段时间再进行下一次 send 就好, 适用于交互频率特别低的场景. 缺点也很明显, 对于比较频繁的场景而言传输效率实在太低. 不过几乎不用做什么处理.</p>\n<p><strong><em>方案 2</em></strong></p>\n<p>关闭 Nagle 算法, 在 Node.js 中你可以通过 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_socket_setnodelay_nodelay" target="_blank" rel="nofollow noreferrer noopener"><code class="language-text">socket.setNoDelay()</code></a> 方法来关闭 Nagle 算法, 让每一次 send 都不缓冲直接发送.</p>\n<p>该方法比较适用于每次发送的数据都比较大 (但不是文件那么大), 并且频率不是特别高的场景. 如果是每次发送的数据量比较小, 并且频率特别高的, 关闭 Nagle 纯属自废武功.</p>\n<p>另外, 该方法不适用于网络较差的情况, 因为 Nagle 算法是在服务端进行的包合并情况, 但是如果短时间内客户端的网络情况不好, 或者应用层由于某些原因不能及时将 TCP 的数据 recv, 就会造成多个包在客户端缓冲从而粘包的情况. (如果是在稳定的机房内部通信那么这个概率是比较小可以选择忽略的)</p>\n<p><strong><em>方案 3</em></strong></p>\n<p>封包/拆包是目前业内常见的解决方案了. 即给每个数据包在发送之前, 于其前/后放一些有特征的数据, 然后收到数据的时候根据特征数据分割出来各个数据包.</p>\n<h3 id="可靠传输"><a href="#%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可靠传输</h3>\n<p>为每一个发送的数据包分配一个序列号(SYN, Synchronize packet), 每一个包在对方收到后要返回一个对应的应答数据包(ACK, Acknowledgement), 发送方如果发现某个包没有被对方 ACK, 则会选择重发. 接收方通过 SYN 序号来保证数据的不会乱序(reordering), 发送方通过 ACK 来保证数据不缺漏, 以此参考决定是否重传. 关于具体的序号计算, 丢包时的重传机制等可以参见阅读陈皓的 <a href="http://coolshell.cn/articles/11564.html" target="_blank" rel="nofollow noreferrer noopener">《TCP 的那些事儿（上）》</a> 此处不做赘述.</p>\n<h3 id="window"><a href="#window" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>window</h3>\n<p>TCP 头里有一个 Window 字段, 是接收端告诉发送端自己还有多少缓冲区可以接收数据的. 发送端就可以根据接收端的处理能力来发送数据, 从而避免接收端处理不过来. 详细参见陈皓的 <a href="http://coolshell.cn/articles/11609.html" target="_blank" rel="nofollow noreferrer noopener">《TCP 的那些事儿（下）》</a></p>\n<blockquote>\n<p>window 是否设置的越大越好?</p>\n</blockquote>\n<p>类似木桶理论, 一个木桶能装多少水, 是由最短的那块木板决定的. 一个 TCP 连接的 window 是由该连接中间一连串设备中 window 最小的那一个设备决定的.</p>\n<h3 id="backlog"><a href="#backlog" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>backlog</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-fa1ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.48121645796065%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABmElEQVQoz31Ry24UMRDc/yWHICFxisItfwBfwAUJRZxz4cQJKSiIx2WT7GYemdmMZ/xuv7qxZ7OBJCtKlm1Zrqru6gUiJoyJUsJEj4GE5Z1Svlhjphmc877v854/LG7E5cmXV8dnB+/OT7LQlrYV+j1cvPl8cHz24v3PtxSTs0ZrrWZ47wsZItTypuKrW9VsyUj3m/Xisv726+prOyyZcbcjr6p6vV4zNjrnpJQLygTvEYBipKd1R88H3dUgppffzdEPHVKpKO2QydFpXlerrmshoovEHQakkEg7L8RklDBGf7hSn1bSh/DQWil7ewgD3SgHBcLjRmOnE7PYMNnejSOXRquxb1nXNk2Towoh5J6zyj3ZOq+0MeCzc/b0MdsmJrUDu5zg9YX8eC0wJ2bB2hy8AYAdGSP9M6cwD6f0VmKLSyYOz8fTys5TeJTJglIIhnfNWvMBfLCBNga1L+ZKybt2xfuKQNA+zGljFFJuBsY1+FSc87IBc7ebvuMTy6mn/WTajfU5MEXQRowUgP5HLv5PFXC/5F/8AdjfsWxnaongAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 03 09 14 09 15" title="" data-src="/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-fee1c.png" data-srcset="/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-a67b7.png 200w,\n/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-0b187.png 400w,\n/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-fee1c.png 800w,\n/static/2021-03-09-14-09-15-98ff8ff1459488509b5198c3041f7169-fa1ac.png 1118w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于该 backlog 的定义参见 <a href="https://linux.die.net/man/2/listen" target="_blank" rel="nofollow noreferrer noopener">man</a> 手册:</p>\n<blockquote>\n<p>The behavior of the backlog argument on TCP sockets changed with Linux 2.2. Now it specifies the queue length for completely established sockets waiting to be accepted, instead of the number of incomplete connection requests.</p>\n</blockquote>\n<p>backlog 用于设置客户端与服务端 <code class="language-text">ESTABLISHED</code> 之后等待 accept 的队列长图 (如上图中的 accept queue). 如果 backlog 过小, 在并发连接大的情况下容易导致 accept queue 装满之后断开连接. 但是如果将这个队列设置的特别大, 那么假定连接数并发量是 65525, 以 php-fpm 的 qps 5000 为例, 处理完约耗时 13s, 而这段时间中连接可能早已被 nginx 或者客户端断开, 那么我们去 accept 这个 socket 时只会拿到一个 broken pipe (该例子出处见 <a href="https://github.com/php/php-src/commit/ebf4ffc9354f316f19c839a114b26a564033708a" target="_blank" rel="nofollow noreferrer noopener">PHP 源码 Set FPM<em>BACKLOG</em>DEFAULT to 511</a>). 经过<del>我也不懂的</del>计算 backlog 的长度默认是 511.</p>\n<p>另外提一句, 这个 backlog 是通过系统指定时是通过 <code class="language-text">somaxconn</code> 参数来指定 accept queue 的. 而 <code class="language-text">tcp_max_syn_backlog</code> 参数指定的是 SYN queue 的长度.</p>\n<h3 id="状态机"><a href="#%E7%8A%B6%E6%80%81%E6%9C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态机</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-03-09-14-57-03-09d8859cd3d4a5439fe634c01b637d4b-b1c4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 562px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 142.52669039145906%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAIAAAAl5NuSAAAACXBIWXMAAAsSAAALEgHS3X78AAAFT0lEQVQ4y22V13PbRhCH+f+/JeMk4zh2bLkosR3HUmQ1m1QDxQqig+i9d7ABIAFcjrLHecnNDmYf7rstv8VdB/zf2u12bdOyLCPLsud5cRwlSfzVoocVx7Hruh24tdmBZvvN6qoFLbBMe4bNzs/Orq6u53Na140sW0VRmuebpgF13UKqKIpO24KFBWK5TVVo0GlWJlApHx1PkLtev383naA0E8lyqygNjseCUCoKyHNQlptvcK6BSNqpREoh2vAzO70SqHvTtd0krRWlNQygaa1tA5pOZblSVbBYgKoqOjDJzGgCsSLvNQJRTDqXZqFOZp5QgmYfAW7VtL3xXIFOfYrKZOU7DIBGpdRp3n3Fnj+niE+JToYw80xr23oPwyQhqevg5lrodtnLS1oQ6+UCpv0AW/OcvfKGn7j+MUP1TI30Mg0kavs18neYJJLraxFFfVj/t8iw5pULFDwg+xIz0hUiWKgglfddgBXt04awCo9oTRMwTCZJlfI9bQgvHaDiEdrjp194FU/SGIReaxtluimctBSMrREC02tdC8xQT1VKeMp/NRt0PjkJT95RH4/wW9q9MzRutepxXI/jv7AsomrybovYwSXp/v7h/vizdHUb5Fn7DRbHwd+PmMOXsxfH06cI+ueoTy/yaeD3BB7RNTLP6Dw91dR3jPL8Ejs4Zo9OjSytq6rcw6mxY4cq0RexvmjweRq1WQLiEKzrNlq3egicDMylbDCQ+vcSgoh3d0qaNnsY1pxbwOMqCQ0pxLDplUUuTSIPoM5wBPKGppYsvWToZR/RTz9hd7cyQS5hIx8a1rS52cDBzLTa4wp3vrHZpcsW+JVSFztDSfu3liAUc3YFBxM6ht5C5RYQhuMJ07b5XJiG7MiRZjF0hEmo8Mnb7tFYn5xi3aPBrahUk1mEEcl46k9QfzD04qTebsvOJgs9Vdc5UWU5dc67qlaF+dzEfxn/8DPy40+DHw/QXyPLWtiJxWsyLQo4JxJCoFmpbXXW+yrphUHCb6rhS4suXNZg+sz087pMEkdRBjfm8N4ZDXUEWbFMRhJLmoLfGMc7INcfzKhjpY4kX5j0L/5S8btUpWFFdZIuCNIaDvX7QTDDqIvLguf3v5imF6LYaRPYK7X0BZe8kAaH3PiQJ14HxueNx63XWRG6W5lvTK21rAhB8GdPyYMD+uBA+vhhxbMdABud67tI9pmuPH0/u3shzd/5fjcKsSBAfR8NQnSbSUAz4tG9fvaReP+G+/jW7J2uOKYDUy09vnA5kxna85HNjR1jzM17knhr22M4uwDoYK0BVV9x85gknMnERdGMpgte6FQ+H4hThxubzCDTiYXJNJUcxViW0ZY1qmsV8i2ENSOnaa7Xg0ZcnNvjMRR9D5cOI6NdcfIFOrtQBI1RVkJZMiT5yXHu1xu6XsowcsHNt+wcP/4nHE8qjtvwXCeRxsrN69nJY/zsN+n2VaZNAfCiCFGVl9PJYwx7YjrvMwcDhu1fX+l/vMafPaGePTWPPiw4urNxGJvqCqMTaDbThSLDq2W1IgP/RpJOLfOLH96WKZTHDCZDtXc+PztWuufO4GYtcB2wshKdIvuX3OR65QpgYYJaXSyZKIY1T+KYTnOmgt1W9RDHYpIyhiNrPA4xLKNoqLMC1cp1MtUIqNn+7m7N9Wqehig2PbLNfprOtpUJdnVbN6Btq/V6GcfFcqnChn3VufB5hxslKhHD28zFpjeHxujN8OIROXxiaYe6gWb50nEdx3MNw3A9L8tz+Og8wA+2fzISpU32d1+moTbbdXXUs3HfxcpysX+VHlZd10391W3+BYq3+c7VMMMEAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 03 09 14 57 03" title="" data-src="/static/2021-03-09-14-57-03-09d8859cd3d4a5439fe634c01b637d4b-b1c4a.png" data-srcset="/static/2021-03-09-14-57-03-09d8859cd3d4a5439fe634c01b637d4b-3ced9.png 200w,\n/static/2021-03-09-14-57-03-09d8859cd3d4a5439fe634c01b637d4b-4c4f5.png 400w,\n/static/2021-03-09-14-57-03-09d8859cd3d4a5439fe634c01b637d4b-b1c4a.png 562w" data-sizes="(max-width: 562px) 100vw, 562px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于网络连接的建立以及断开, 存在着一个复杂的状态转换机制, 完整的状态表参见 [《The TCP/IP Guide》](<a href="http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm" target="_blank" rel="nofollow noreferrer noopener">http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm</a></p>\n<table>\n<thead>\n<tr>\n<th>state</th>\n<th>简述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLOSED</td>\n<td>连接关闭, 所有连接的初始状态</td>\n</tr>\n<tr>\n<td>LISTEN</td>\n<td>监听状态, 等待客户端发送 SYN</td>\n</tr>\n<tr>\n<td>SYN-SENT</td>\n<td>客户端发送了 SYN, 等待服务端回复</td>\n</tr>\n<tr>\n<td>SYN-RECEIVED</td>\n<td>双方都收到了 SYN, 等待 ACK</td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td>SYN-RECEIVED 收到 ACK 之后, 状态切换为连接已建立.</td>\n</tr>\n<tr>\n<td>CLOSE-WAIT</td>\n<td>被动方收到了关闭请求(FIN)后, 发送 ACK, 如果有数据要发送, 则发送数据, 无数据发送则回复 FIN. 状态切换到 LAST-ACK</td>\n</tr>\n<tr>\n<td>LAST-ACK</td>\n<td>等待对方 ACK 当前设备的 CLOSE-WAIT 时发送的 FIN, 等到则切换 CLOSED</td>\n</tr>\n<tr>\n<td>FIN-WAIT-1</td>\n<td>主动方发送 FIN, 等待 ACK</td>\n</tr>\n<tr>\n<td>FIN-WAIT-2</td>\n<td>主动方收到被动方的 ACK, 等待 FIN</td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>主动方收到了 FIN, 却没收到 FIN-WAIT-1 时发的 ACK, 此时等待那个 ACK</td>\n</tr>\n<tr>\n<td>TIME-WAIT</td>\n<td>主动方收到 FIN, 返回收到对方 FIN 的 ACK, 等待对方是否真的收到了 ACK, 如果过一会又来一个 FIN, 表示对方没收到, 这时要再 ACK 一次</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><code class="language-text">TIME_WAIT</code> 是什么情况? 出现过多的 <code class="language-text">TIME_WAIT</code> 可能是什么原因?</p>\n</blockquote>\n<p><code class="language-text">TIME_WAIT</code> 是连接的某一方 (可能是服务端也可能是客户端) 主动断开连接时, 四次挥手等待被断开的一方是否收到最后一次挥手 (ACK) 的状态. 如果在等待时间中, 再次收到第三次挥手 (FIN) 表示对方没收到最后一次挥手, 这时要再 ACK 一次. 这个等待的作用是避免出现连接混用的情况 (<code class="language-text">prevent potential overlap with new connections</code> see <a href="http://www.tcpipguide.com/free/t_TCPConnectionTermination.htm" target="_blank" rel="nofollow noreferrer noopener">TCP Connection Termination</a> for more).</p>\n<p>出现大量的 <code class="language-text">TIME_WAIT</code> 比较常见的情况是, 并发量大, 服务器在短时间断开了大量连接. 对应 HTTP server 的情况可能是没开启 <code class="language-text">keepAlive</code>. 如果有开 <code class="language-text">keepAlive</code>, 一般是等待客户端自己主动断开, 那么<code class="language-text">TIME_WAIT</code> 就只存在客户端, 而服务端则是 <code class="language-text">CLOSE_WAIT</code> 的状态, 如果服务端出现大量 <code class="language-text">CLOSE_WAIT</code>, 意味着当前服务端建立的连接大面积的被断开, 可能是目标服务集群重启之类.</p>\n<h2 id="udp"><a href="#udp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UDP</h2>\n<blockquote>\n<p>TCP/UDP 的区别? UDP 有粘包吗?</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>协议</th>\n<th>连接性</th>\n<th>双工性</th>\n<th>可靠性</th>\n<th>有序性</th>\n<th>有界性</th>\n<th>拥塞控制</th>\n<th>传输速度</th>\n<th>量级</th>\n<th>头部大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TCP</td>\n<td>面向连接\n<br>\n(Connection oriented)</td>\n<td>全双工(1:1)</td>\n<td>可靠\n<br>\n(重传机制)</td>\n<td>有序\n<br>\n(通过 SYN 排序)</td>\n<td>无, 有\n<a href="#%E7%B2%98%E5%8C%85">粘包情况</a></td>\n<td>有</td>\n<td>慢</td>\n<td>低</td>\n<td>20~60 字节</td>\n</tr>\n<tr>\n<td>UDP</td>\n<td>无连接\n<br>\n(Connection less)</td>\n<td>n:m</td>\n<td>不可靠\n<br>\n(丢包后数据丢失)</td>\n<td>无序</td>\n<td>有消息边界, \n<strong>无粘包</strong></td>\n<td>无</td>\n<td>快</td>\n<td>高</td>\n<td>8 字节</td>\n</tr>\n</tbody>\n</table>\n<p>UDP socket 支持 n 对 m 的连接状态, 在<a href="https://nodejs.org/dist/latest-v6.x/docs/api/dgram.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>中有写到在 <code class="language-text">dgram.createSocket(options[, callback])</code> 中的 option 可以指定 <code class="language-text">reuseAddr</code> 即 <code class="language-text">SO_REUSEADDR</code> 标志. 通过 <code class="language-text">SO_REUSEADDR</code> 可以简单的实现 n 对 m 的多播特性 (不过仅在支持多播的系统上才有).</p>\n<h3 id="常见的应用场景"><a href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见的应用场景</h3>\n<table>\n  <tr><th>传输层协议</th><th>应用</th><th>应用层协议</th></tr>\n  <tr><td rowspan="5">TCP</td><td>电子邮件</td><td>SMTP</td></tr>\n  <tr><td>终端连接</td><td>TELNET</td></tr>\n  <tr><td>终端连接</td><td>SSH</td></tr>\n  <tr><td>万维网</td><td>HTTP</td></tr>\n  <tr><td>文件传输</td><td>FTP</td></tr>\n  <tr><td rowspan="8">UDP</td><td>域名解析</td><td>DNS</td></tr>\n  <tr><td>简单文件传输</td><td>TFTP</td></tr>\n  <tr><td>网络时间校对</td><td>NTP</td></tr>\n  <tr><td>网络文件系统</td><td>NFS</td></tr>\n  <tr><td>路由选择</td><td>RIP</td></tr>\n  <tr><td>IP电话</td><td>-</td></tr>\n  <tr><td>流式多媒体通信</td><td>-</td></tr>\n</table>\n<p>简单的说, UDP 速度快, 开销低, 不用封包/拆包允许丢一部分数据, 监控统计/日志数据上报/流媒体通信等场景都可以用 UDP. 目前 Node.js 的项目中使用 UDP 比较流行的是 <a href="https://github.com/etsy/statsd" target="_blank" rel="nofollow noreferrer noopener">StatsD</a> 监控服务.</p>\n<h2 id="http"><a href="#http" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP</h2>\n<p>目前世界上运行最良好的分布式集群, 莫过于当前的万维网 (http servers) 了. 目前前端工程师也都是靠 HTTP 协议吃饭的, 所以 2-3 年的前端同学都应该对 HTTP 有比较深的理解了, 所以这里不做太多的赘述. 推荐书籍<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00JTQK1L4/" target="_blank" rel="nofollow noreferrer noopener">《图解 HTTP》</a>, 博客<a href="http://www.ruanyifeng.com/blog/2016/08/http.html" target="_blank" rel="nofollow noreferrer noopener">HTTP 协议入门</a>.</p>\n<p>另外最近几年开始大家对 HTTP 的面试的考察也渐渐偏向<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="nofollow noreferrer noopener">理解 RESTful 架构</a>. 简单的说, RESTful 是把每个 URI 当做资源 (Resources), 通过 method 作为动词来对资源做不同的动作, 然后服务器返回 status 来得知资源状态的变化 (State Transfer);</p>\n<h3 id="methodstatus"><a href="#methodstatus" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>method/status</h3>\n<p>因为 HTTP 的方法 (method) 与状态码 (status) 讲解太常见, 你可以使用如下代码打印出来自己看 Node.js 官方定义的, 完整的就不列举了.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39187208208894410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const http = require(\'http\');\n\nconsole.log(http.METHODS);\nconsole.log(http.STATUS_CODES);`, `39187208208894410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">STATUS_CODES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个常见的 method 列表, 关于这些 method 在 RESTful 中的一些应用的详细可以参见<a href="http://www.restapitutorial.com/lessons/httpmethods.html" target="_blank" rel="nofollow noreferrer noopener">Using HTTP Methods for RESTful Services</a></p>\n<table>\n<thead>\n<tr>\n<th>methods</th>\n<th>CRUD</th>\n<th>幂等</th>\n<th>缓存</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>Read</td>\n<td>✓</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>POST</td>\n<td>Create</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>PUT</td>\n<td>Update/Replace</td>\n<td>✓</td>\n<td></td>\n</tr>\n<tr>\n<td>PATCH</td>\n<td>Update/Modify</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>DELETE</td>\n<td>Delete</td>\n<td>✓</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>GET 和 POST 有什么区别?</p>\n</blockquote>\n<p>网上有很多讲这个的, 比如从书签, url 等前端的角度去看他们的区别这里不赘述. 而从后端的角度看, 前两年出来一个 《GET 和 POST 没有区别》(出处不好考究, 就没贴了) 的文章比较有名, 早在我刚学 PHP 的时候也有过这种疑惑, 刚学 Node 的时候发现不能像 PHP 那样同时处理 GET 和 POST 的时候还很不适应. 后来接触 RESTful 才意识到, 这两个东西最根本的差别是语义, 引申了看, 协议 (protocol) 这种东西就是人与人之间协商的约定, 什么行为是什么作用都是”约定”好的, 而不是强制使用的, 非要把 GET 当 POST 这样不遵守约定的做法我们也爱莫能助.</p>\n<p>跑题了, 简而言之, 讨论这二者的区别最好从 RESTful 提倡的语义角度来讲<del>比较符合当代程序员的逼格</del>比较合理.</p>\n<blockquote>\n<p>POST 和 PUT 有什么区别?</p>\n</blockquote>\n<p>POST 是新建 (create) 资源, 非幂等, 同一个请求如果重复 POST 会新建多个资源. PUT 是 Update/Replace, 幂等, 同一个 PUT 请求重复操作会得到同样的结果.</p>\n<h3 id="headers"><a href="#headers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>headers</h3>\n<p>HTTP headers 是在进行 HTTP 请求的交互过程中互相支会对方一些信息的主要字段. 比如请求 (Request) 的时候告诉服务端自己能接受的各项参数, 以及之前就存在本地的一些数据等. 详细各位可以参见 wikipedia:</p>\n<ul>\n<li><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Request_fields" target="_blank" rel="nofollow noreferrer noopener">Request fields</a></li>\n<li><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Response_fields" target="_blank" rel="nofollow noreferrer noopener">Response fields</a></li>\n</ul>\n<blockquote>\n<p>cookie 与 session 的区别? 服务端如何清除 cookie?</p>\n</blockquote>\n<p>主要区别在于, session 存在服务端, cookie 存在客户端. session 比 cookie 更安全. 而且 cookie 不一定一直能用 (可能被浏览器关掉). 服务端可以通过设置 cookie 的值为空并设置一个及时的 expires 来清除存在客户端上的 cookie.</p>\n<blockquote>\n<p>什么是跨域请求? 如何允许跨域?</p>\n</blockquote>\n<p>出于安全考虑, 默认情况下使用 XMLHttpRequest 和 Fetch 发起 HTTP 请求必须遵守同源策略, 即只能向相同 host 请求 (host = hostname : port) 注[1]. 向不同 host 的请求被称作跨域请求 (cross-origin HTTP request). 可以通过设置 <a href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" target="_blank" rel="nofollow noreferrer noopener">CORS headers</a> 即 <code class="language-text">Access-Control-Allow-</code> 系列来允许跨域. 例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29385459067986485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ~* ^/(?:v1|_) {\n  if (\\$request_method = OPTIONS) { return 200 \'\'; }\n  header_filter_by_lua \'\n    ngx.header[&quot;Access-Control-Allow-Origin&quot;] = ngx.var.http_origin; # 这样相当于允许所有来源了\n    ngx.header[&quot;Access-Control-Allow-Methods&quot;] = &quot;GET, POST, PUT, DELETE, PATCH, OPTIONS&quot;;\n    ngx.header[&quot;Access-Control-Allow-Credentials&quot;] = &quot;true&quot;;\n    ngx.header[&quot;Access-Control-Allow-Headers&quot;] = &quot;Content-Type&quot;;\n  \';\n  proxy_pass http://localhost:3001;\n}`, `29385459067986485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location ~* ^/(?:v1|_) {\n  if ($request_method = OPTIONS) { return 200 &#39;&#39;; }\n  header_filter_by_lua &#39;\n    ngx.header[&quot;Access-Control-Allow-Origin&quot;] = ngx.var.http_origin; # 这样相当于允许所有来源了\n    ngx.header[&quot;Access-Control-Allow-Methods&quot;] = &quot;GET, POST, PUT, DELETE, PATCH, OPTIONS&quot;;\n    ngx.header[&quot;Access-Control-Allow-Credentials&quot;] = &quot;true&quot;;\n    ngx.header[&quot;Access-Control-Allow-Headers&quot;] = &quot;Content-Type&quot;;\n  &#39;;\n  proxy_pass http://localhost:3001;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注[1]：同源除了相同 host 也包括相同协议. 所以即使 host 相同, 从 HTTP 到 HTTPS 也属于跨域, 见<a href="https://github.com/ElemeFE/node-interview/issues/55" target="_blank" rel="nofollow noreferrer noopener">讨论</a>.</p>\n<blockquote>\n<p><code class="language-text">Script error.</code> 是什么错误? 如何拿到更详细的信息?</p>\n</blockquote>\n<p>接上题, 由于同源性策略 (CORS), 如果你引用的 js 脚本所在的域与当前域不同, 那么浏览器会把 onError 中的 msg 替换为 <code class="language-text">Script error.</code> 要拿到详细错误的方法, 处理配好 <code class="language-text">Access-Control-Allow-Origin</code> 还有在引用脚本的时候指定 <code class="language-text">crossorigin</code> 例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61888929015655680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script src=&quot;http://another-domain.com/app.js&quot; crossorigin=&quot;anonymous&quot;></script>`, `61888929015655680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://another-domain.com/app.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>详见 <a href="https://sentry.io/answers/javascript-script-error/" target="_blank" rel="nofollow noreferrer noopener">JavaScript Script Error.</a></p>\n<h3 id="agent"><a href="#agent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Agent</h3>\n<p>Node.js 中的 <code class="language-text">http.Agent</code> 用于池化 HTTP 客户端请求的 socket (pooling sockets used in HTTP client requests). 也就是复用 HTTP 请求时候的 socket. 如果你没有指定 Agent 的话, 默认用的是 <code class="language-text">http.globalAgent</code>.</p>\n<p>另外, 目前在 Node.js 的 6.8.1（包括）到 6.10（不包括）版本中发现一个问题:</p>\n<ul>\n<li>\n<ol>\n<li>你将 keepAlive 设置为 <code class="language-text">true</code> 时, socket 有复用</li>\n</ol>\n</li>\n<li>\n<ol start="2">\n<li>即使 keepAlive 没有设置成 <code class="language-text">true</code> 但是长时间内有大量请求时, 同样有复用 socket (复用情况参见<a href="https://github.com/zcs19871221" target="_blank" rel="nofollow noreferrer noopener">@zcs19871221</a>的<a href="https://github.com/zcs19871221/mydoc/blob/master/nodejsAgent.md" target="_blank" rel="nofollow noreferrer noopener">解析</a>)</li>\n</ol>\n</li>\n</ul>\n<p>1 和 2 这两种情况下, 一旦设置了 request timeout, 由于 socket 一直未销毁, 如果你在请求完成以后没有注意清除该事件, 会导致事件重复监听, 且该事件闭包引用了 req, 会导致内存泄漏.</p>\n<p>如果有疑虑的话可以参见 Node 官方讨论的 <a href="https://github.com/nodejs/node/issues/9268" target="_blank" rel="nofollow noreferrer noopener">issue</a> 以及引入此 bug 的 <a href="https://github.com/nodejs/node/blob/ee7af01b93cc46f1848f6962ad2d6c93f319341a/lib/_http_client.js#L565" target="_blank" rel="nofollow noreferrer noopener">commit</a>, 如果此处描述有疑问可以在本 repo 的 <a href="https://github.com/ElemeFE/node-interview/issues/19" target="_blank" rel="nofollow noreferrer noopener">issue</a> 中指出.</p>\n<h3 id="socket-hang-up"><a href="#socket-hang-up" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>socket hang up</h3>\n<p>hang up 有挂断的意思, socket hang up 也可以理解为 socket 被挂断. 在 Node.js 中当你要 response 一个请求的时候, 发现该这个 socket 已经被 “挂断”, 就会就会报 socket hang up 错误.</p>\n<p><a href="https://github.com/nodejs/node/blob/v6.x/lib/_http_client.js#L286" target="_blank" rel="nofollow noreferrer noopener">Node.js 中源码的情况:</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88671179547551560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function socketCloseListener() {\n  var socket = this;\n  var req = socket._httpMessage;\n\n  // Pull through final chunk, if anything is buffered.\n  // the ondata function will handle it properly, and this\n  // is a no-op if no final chunk remains.\n  socket.read();\n\n  // NOTE: It\'s important to get parser here, because it could be freed by\n  // the \\`socketOnData\\`.\n  var parser = socket.parser;\n  req.emit(\'close\');\n  if (req.res && req.res.readable) {\n    // Socket closed before we emitted \'end\' below.\n    req.res.emit(\'aborted\');\n    var res = req.res;\n    res.on(\'end\', function() {\n      res.emit(\'close\');\n    });\n    res.push(null);\n  } else if (!req.res && !req.socket._hadError) {\n    // This socket error fired before we started to\n    // receive a response. The error needs to\n    // fire on the request.\n    req.emit(\'error\', createHangUpError()); // <------------------- socket hang up\n    req.socket._hadError = true;\n  }\n\n  // Too bad.  That output wasn\'t getting written.\n  // This is pretty terrible that it doesn\'t raise an error.\n  // Fixed better in v0.10\n  if (req.output) req.output.length = 0;\n  if (req.outputEncodings) req.outputEncodings.length = 0;\n\n  if (parser) {\n    parser.finish();\n    freeParser(parser, req, socket);\n  }\n}`, `88671179547551560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">socketCloseListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> req <span class="token operator">=</span> socket<span class="token punctuation">.</span>_httpMessage<span class="token punctuation">;</span>\n\n  <span class="token comment">// Pull through final chunk, if anything is buffered.</span>\n  <span class="token comment">// the ondata function will handle it properly, and this</span>\n  <span class="token comment">// is a no-op if no final chunk remains.</span>\n  socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// NOTE: It\'s important to get parser here, because it could be freed by</span>\n  <span class="token comment">// the `socketOnData`.</span>\n  <span class="token keyword">var</span> parser <span class="token operator">=</span> socket<span class="token punctuation">.</span>parser<span class="token punctuation">;</span>\n  req<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>res <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>res<span class="token punctuation">.</span>readable<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Socket closed before we emitted \'end\' below.</span>\n    req<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'aborted\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> res <span class="token operator">=</span> req<span class="token punctuation">.</span>res<span class="token punctuation">;</span>\n    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'end\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      res<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>res <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>_hadError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// This socket error fired before we started to</span>\n    <span class="token comment">// receive a response. The error needs to</span>\n    <span class="token comment">// fire on the request.</span>\n    req<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> <span class="token function">createHangUpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;------------------- socket hang up</span>\n    req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>_hadError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Too bad.  That output wasn\'t getting written.</span>\n  <span class="token comment">// This is pretty terrible that it doesn\'t raise an error.</span>\n  <span class="token comment">// Fixed better in v0.10</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>output<span class="token punctuation">)</span> req<span class="token punctuation">.</span>output<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>outputEncodings<span class="token punctuation">)</span> req<span class="token punctuation">.</span>outputEncodings<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    parser<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">freeParser</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> req<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>典型的情况是用户使用浏览器, 请求的时间有点长, 然后用户简单的按了一下 F5 刷新页面. 这个操作会让浏览器取消之前的请求, 然后导致服务端 throw 了一个 socket hang up.</p>\n<p>详见万能的 stackoverflow: <a href="http://stackoverflow.com/questions/16995184/nodejs-what-does-socket-hang-up-actually-mean" target="_blank" rel="nofollow noreferrer noopener">NodeJS - What does “socket hang up” actually mean?</a></p>\n<h2 id="dns"><a href="#dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DNS</h2>\n<p>早期可以用 TCP/IP 通信之后, 有一个比较蛋疼的问题, 就是 ip 都是一串比较长的数字, 比较难记, 于是大家想了个办法, 给每个 ip 取个好记一点的名字比如 <code class="language-text">Alan -&gt; 192.168.0.11</code> 这样只需要记住好记的名字即可, 随着这个名字的规范化最终变成了今天的域名 (Domain name), 而帮助别人记录这个名字的服务就叫域名解析服务 (Domain Name Service).</p>\n<p>DNS 服务主要基于 UDP, 这里简单介绍 Node.js 实现的接口中的两个方法:</p>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>功能</th>\n<th>同步</th>\n<th>网络请求</th>\n<th>速度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.lookup(hostname\n[\n, options\n]\n, cb)</td>\n<td>通过系统自带的 DNS 缓存 (如 \n<code class="language-text">/etc/hosts</code>\n)</td>\n<td>同步</td>\n<td>无</td>\n<td>快</td>\n</tr>\n<tr>\n<td>.resolve(hostname\n[\n, rrtype\n]\n, cb)</td>\n<td>通过系统配置的 DNS 服务器指定的记录 (rrtype 指定)</td>\n<td>异步</td>\n<td>有</td>\n<td>慢</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>DNS 模块中 .lookup 与 .resolve 的区别?</p>\n</blockquote>\n<p>当你要解析一个域名的 ip 时, 通过 .lookup 查询直接调用 <code class="language-text">getaddrinfo</code> 来拿取地址, 速度很快, 但是如果本地的 hosts 文件被修改了, .lookup 就会拿 hosts 文件中的地方, 而 .resolve 依旧是外部正常的地址.</p>\n<p>由于 .lookup 是同步的, 所以如果由于什么不可控的原因导致 <code class="language-text">getaddrinfo</code> 缓慢或者阻塞是会影响整个 Node 进程的, 参见<a href="https://nodejs.org/dist/latest-v6.x/docs/api/dns.html#dns_dns_lookup" target="_blank" rel="nofollow noreferrer noopener">文档</a>.</p>\n<blockquote>\n<p>hosts 文件是什么? 什么叫 DNS 本地解析?</p>\n</blockquote>\n<p>hosts 文件是个没有扩展名的系统文件, 其作用就是将网址域名与其对应的 IP 地址建立一个关联“数据库”, 当用户在浏览器中输入一个需要登录的网址时, 系统会首先自动从 hosts 文件中寻找对应的 IP 地址.</p>\n<p>当我们访问一个域名时, 实际上需要的是访问对应的 IP 地址. 这时候, 获取 IP 地址的方式, 先是读取浏览器缓存, 如果未命中 => 接着读取本地 hosts 文件, 如果还是未命中 => 则向 DNS 服务器发送请求获取. 在向 DNS 服务器获取 IP 地址之前的行为, 叫做 DNS 本地解析.</p>\n<h2 id="zlib"><a href="#zlib" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZLIB</h2>\n<p>在网络传输过程中, 如果网速稳定的情况下, 对数据进行压缩, 压缩比率越大, 那么传输的效率就越高等同于速度越快了. zlib 模块提供了 Gzip/Gunzip, Deflate/Inflate 和 DeflateRaw/InflateRaw 等压缩方法的类, 这些类接收相同的参数, 都属于可读写的 Stream 实例.</p>\n<h2 id="rpc"><a href="#rpc" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RPC</h2>\n<p>RPC (Remote Procedure Call Protocol) 基于 TCP/IP 来实现调用远程服务器的方法, 与 http 同属应用层. 常用于构建集群, 以及微服务 (推荐一本<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B01MXY8ARP" target="_blank" rel="nofollow noreferrer noopener">《Node.js 微服务》</a><del>虽然我还没看完</del>)</p>\n<p>常见的 RPC 方式:</p>\n<ul>\n<li><a href="http://thrift.apache.org/" target="_blank" rel="nofollow noreferrer noopener">Thrift</a></li>\n<li>HTTP</li>\n<li>MQ</li>\n</ul>\n<h3 id="thrift"><a href="#thrift" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thrift</h3>\n<blockquote>\n<p><strong>Thrift</strong>是一种<a href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80" title="接口描述语言" target="_blank" rel="nofollow noreferrer noopener">接口描述语言</a>和二进制通讯协议，它被用来定义和创建跨语言的服务。它被当作一个<a href="https://zh.wikipedia.org/wiki/%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8" title="远程过程调用" target="_blank" rel="nofollow noreferrer noopener">远程过程调用</a>（RPC）框架来使用，是由<a href="https://zh.wikipedia.org/wiki/Facebook" title="Facebook" target="_blank" rel="nofollow noreferrer noopener">Facebook</a>为“大规模跨语言服务开发”而开发的。它通过一个代码生成引擎联合了一个软件栈，来创建不同程度的、无缝的<a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E5%B9%B3%E5%8F%B0" title="跨平台" target="_blank" rel="nofollow noreferrer noopener">跨平台</a>高效服务，可以使用<a href="https://zh.wikipedia.org/wiki/C%E2%99%AF" title="C♯" target="_blank" rel="nofollow noreferrer noopener">C#</a>、<a href="https://zh.wikipedia.org/wiki/C%2B%2B" title="C++" target="_blank" rel="nofollow noreferrer noopener">C++</a>（基于<a href="https://zh.wikipedia.org/wiki/POSIX" title="POSIX" target="_blank" rel="nofollow noreferrer noopener">POSIX</a>兼容系统）、Cappuccino、<a href="https://zh.wikipedia.org/wiki/Cocoa" title="Cocoa" target="_blank" rel="nofollow noreferrer noopener">Cocoa</a>、<a href="https://zh.wikipedia.org/wiki/Delphi" title="Delphi" target="_blank" rel="nofollow noreferrer noopener">Delphi</a>、<a href="https://zh.wikipedia.org/wiki/Erlang" title="Erlang" target="_blank" rel="nofollow noreferrer noopener">Erlang</a>、<a href="https://zh.wikipedia.org/wiki/Go" title="Go" target="_blank" rel="nofollow noreferrer noopener">Go</a>、<a href="https://zh.wikipedia.org/wiki/Haskell" title="Haskell" target="_blank" rel="nofollow noreferrer noopener">Haskell</a>、<a href="https://zh.wikipedia.org/wiki/Java" title="Java" target="_blank" rel="nofollow noreferrer noopener">Java</a>、<a href="https://zh.wikipedia.org/wiki/Node.js" title="Node.js" target="_blank" rel="nofollow noreferrer noopener">Node.js</a>、<a href="https://zh.wikipedia.org/wiki/OCaml" title="OCaml" target="_blank" rel="nofollow noreferrer noopener">OCaml</a>、<a href="https://zh.wikipedia.org/wiki/Perl" title="Perl" target="_blank" rel="nofollow noreferrer noopener">Perl</a>、<a href="https://zh.wikipedia.org/wiki/PHP" title="PHP" target="_blank" rel="nofollow noreferrer noopener">PHP</a>、<a href="https://zh.wikipedia.org/wiki/Python" title="Python" target="_blank" rel="nofollow noreferrer noopener">Python</a>、<a href="https://zh.wikipedia.org/wiki/Ruby" title="Ruby" target="_blank" rel="nofollow noreferrer noopener">Ruby</a>和<a href="https://zh.wikipedia.org/wiki/Smalltalk" title="Smalltalk" target="_blank" rel="nofollow noreferrer noopener">Smalltalk</a>。虽然它以前是由 Facebook 开发的，但它现在是<a href="https://zh.wikipedia.org/wiki/Apache%E8%BD%AF%E4%BB%B6%E5%9F%BA%E9%87%91%E4%BC%9A" title="Apache软件基金会" target="_blank" rel="nofollow noreferrer noopener">Apache 软件基金会</a>的<a href="https://zh.wikipedia.org/wiki/%E5%BC%80%E6%BA%90" title="开源" target="_blank" rel="nofollow noreferrer noopener">开源</a>项目了。该实现被描述在 2007 年 4 月的一篇由 Facebook 发表的技术论文中，该论文现由 Apache 掌管。</p>\n</blockquote>\n<h3 id="http-1"><a href="#http-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP</h3>\n<p>使用 HTTP 协议来进行 RPC 调用也是很常见的, 相比 TCP 连接, 通过 HTTP 的方式性能会差一些, 但是在使用以及调试上会简单一些. 近期比较有名的框架参见 <a href="http://www.grpc.io/" target="_blank" rel="nofollow noreferrer noopener">gRPC</a>:</p>\n<blockquote>\n<p>gRPC is an open source remote procedure call (RPC) system initially developed at Google. It uses HTTP/2 for transport, Protocol Buffers as the interface description language, and provides features such as authentication, bidirectional streaming and flow control, blocking or nonblocking bindings, and cancellation and timeouts. It generates cross-platform client and server bindings for many languages.</p>\n</blockquote>\n<h3 id="mq"><a href="#mq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MQ</h3>\n<p>使用消息队列 (Message Queue) 来进行 RPC 调用 (RPC over mq) 在业内有不少例子, 比较适合业务解耦/广播/限流等场景.</p>\n<h1 id="os"><a href="#os" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS</h1>\n<h2 id="tty"><a href="#tty" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TTY</h2>\n<p>“tty” 原意是指 “teletype” 即打字机, “pty” 则是 “pseudo-teletype” 即伪打字机. 在 Unix 中, <code class="language-text">/dev/tty*</code> 是指任何表现的像打字机的设备, 例如终端 (terminal).</p>\n<p>你可以通过 <code class="language-text">w</code> 命令查看当前登录的用户情况, 你会发现每登录了一个窗口就会有一个新的 tty.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93952927431192700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ w\n 11:49:43 up 482 days, 19:38,  3 users,  load average: 0.03, 0.08, 0.07\nUSER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\ndev      pts/0    10.0.128.252     10:44    1:01m  0.09s  0.07s -bash\ndev      pts/2    10.0.128.252     11:08    2:07   0.17s  0.14s top\nroot     pts/3    10.0.240.2       11:43    7.00s  0.04s  0.00s w`, `93952927431192700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="shell"\n              >\n                <span class="gatsby-code-button-language">shell</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ w\n <span class="token number">11</span>:49:43 up <span class="token number">482</span> days, <span class="token number">19</span>:38,  <span class="token number">3</span> users,  load average: <span class="token number">0.03</span>, <span class="token number">0.08</span>, <span class="token number">0.07</span>\n<span class="token environment constant">USER</span>     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\ndev      pts/0    <span class="token number">10.0</span>.128.252     <span class="token number">10</span>:44    <span class="token number">1</span>:01m  <span class="token number">0</span>.09s  <span class="token number">0</span>.07s -bash\ndev      pts/2    <span class="token number">10.0</span>.128.252     <span class="token number">11</span>:08    <span class="token number">2</span>:07   <span class="token number">0</span>.17s  <span class="token number">0</span>.14s <span class="token function">top</span>\nroot     pts/3    <span class="token number">10.0</span>.240.2       <span class="token number">11</span>:43    <span class="token number">7</span>.00s  <span class="token number">0</span>.04s  <span class="token number">0</span>.00s w</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 ps 命令查看进程信息中也有 tty 的信息:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61729747509477700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ps -x\n  PID TTY      STAT   TIME COMMAND\n 5530 ?        S      0:00 sshd: dev@pts/3\n 5531 pts/3    Ss+    0:00 -bash\n11296 ?        S      0:00 sshd: dev@pts/4\n11297 pts/4    Ss     0:00 -bash\n13318 pts/4    R+     0:00 ps -x\n23733 ?        Ssl    2:53 PM2 v1.1.2: God Daemon`, `61729747509477700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="shell"\n              >\n                <span class="gatsby-code-button-language">shell</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ <span class="token function">ps</span> -x\n  PID TTY      STAT   TIME COMMAND\n <span class="token number">5530</span> ?        S      <span class="token number">0</span>:00 sshd: dev@pts/3\n <span class="token number">5531</span> pts/3    Ss+    <span class="token number">0</span>:00 -bash\n<span class="token number">11296</span> ?        S      <span class="token number">0</span>:00 sshd: dev@pts/4\n<span class="token number">11297</span> pts/4    Ss     <span class="token number">0</span>:00 -bash\n<span class="token number">13318</span> pts/4    R+     <span class="token number">0</span>:00 <span class="token function">ps</span> -x\n<span class="token number">23733</span> ?        Ssl    <span class="token number">2</span>:53 PM2 v1.1.2: God Daemon</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中为 <code class="language-text">?</code> 的是没有依赖 TTY 的进程, 即<a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">守护进程</a>.</p>\n<p>在 Node.js 中你可以通过 stdio 的 isTTY 来判断当前进程是否处于 TTY (如终端) 的环境.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25689610021535715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ node -p -e &quot;Boolean(process.stdout.isTTY)&quot;\ntrue\n\\$ node -p -e &quot;Boolean(process.stdout.isTTY)&quot; | cat\nfalse`, `25689610021535715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="shell"\n              >\n                <span class="gatsby-code-button-language">shell</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ node -p -e <span class="token string">"Boolean(process.stdout.isTTY)"</span>\n<span class="token boolean">true</span>\n$ node -p -e <span class="token string">"Boolean(process.stdout.isTTY)"</span> <span class="token operator">|</span> <span class="token function">cat</span>\n<span class="token boolean">false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="os-1"><a href="#os-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS</h2>\n<p>通过 OS 模块可以获取到当前系统一些基础信息的辅助函数.</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>os.EOL</td>\n<td>根据当前系统, 返回当前系统的 \n<code class="language-text">End Of Line</code></td>\n</tr>\n<tr>\n<td>os.arch()</td>\n<td>返回当前系统的 CPU 架构, 如 \n<code class="language-text">&#39;x86&#39;</code>\n 和 \n<code class="language-text">&#39;x64&#39;</code></td>\n</tr>\n<tr>\n<td>os.constants</td>\n<td>返回系统常量</td>\n</tr>\n<tr>\n<td>os.cpus()</td>\n<td>返回 CPU 每个核的信息</td>\n</tr>\n<tr>\n<td>os.endianness()</td>\n<td>返回 CPU 字节序, 如果是大端字节序返回 \n<code class="language-text">BE</code>\n, 小端字节序则 \n<code class="language-text">LE</code></td>\n</tr>\n<tr>\n<td>os.freemem()</td>\n<td>返回系统空闲内存的大小, 单位是字节</td>\n</tr>\n<tr>\n<td>os.homedir()</td>\n<td>返回当前用户的根目录</td>\n</tr>\n<tr>\n<td>os.hostname()</td>\n<td>返回当前系统的主机名</td>\n</tr>\n<tr>\n<td>os.loadavg()</td>\n<td>返回负载信息</td>\n</tr>\n<tr>\n<td>os.networkInterfaces()</td>\n<td>返回网卡信息 (类似 \n<code class="language-text">ifconfig</code>\n)</td>\n</tr>\n<tr>\n<td>os.platform()</td>\n<td>返回编译时指定的平台信息, 如 \n<code class="language-text">win32</code>\n, \n<code class="language-text">linux</code>\n, 同 \n<code class="language-text">process.platform()</code></td>\n</tr>\n<tr>\n<td>os.release()</td>\n<td>返回操作系统的分发版本号</td>\n</tr>\n<tr>\n<td>os.tmpdir()</td>\n<td>返回系统默认的临时文件夹</td>\n</tr>\n<tr>\n<td>os.totalmem()</td>\n<td>返回总内存大小(同内存条大小)</td>\n</tr>\n<tr>\n<td>os.type()</td>\n<td>根据 \n<code class="language-text">[uname](https://en.wikipedia.org/wiki/Uname#Examples)</code>\n 返回系统的名称</td>\n</tr>\n<tr>\n<td>os.uptime()</td>\n<td>返回系统的运行时间，单位是秒</td>\n</tr>\n<tr>\n<td>os.userInfo(\n[\noptions\n]\n)</td>\n<td>返回当前用户信息</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>不同操作系统的换行符 (EOL) 有什么区别?</p>\n</blockquote>\n<p>end of line (EOL) 同 newline, line ending, 以及 line break.</p>\n<p>通常由 line feed (LF, <code class="language-text">\\n</code>) 和 carriage return (CR, <code class="language-text">\\r</code>) 组成. 常见的情况:</p>\n<table>\n<thead>\n<tr>\n<th>符号</th>\n<th>系统</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>LF</td>\n<td>在 Unix 或 Unix 相容系统 (GNU/Linux, AIX, Xenix, Mac OS X, …)、BeOS、Amiga、RISC OS</td>\n</tr>\n<tr>\n<td>CR+LF</td>\n<td>MS-DOS、微软视窗操作系统 (Microsoft Windows)、大部分非 Unix 的系统</td>\n</tr>\n<tr>\n<td>CR</td>\n<td>Apple II 家族, Mac OS 至版本 9</td>\n</tr>\n</tbody>\n</table>\n<p>如果不了解 EOL 跨系统的兼容情况, 那么在处理文件的行分割/行统计等情况时可能会被坑.</p>\n<h3 id="os-常量"><a href="#os-%E5%B8%B8%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS 常量</h3>\n<ul>\n<li>信号常量 (Signal Constants), 如 <code class="language-text">SIGHUP</code>, <code class="language-text">SIGKILL</code> 等.</li>\n<li>POSIX 错误常量 (POSIX Error Constants), 如 <code class="language-text">EACCES</code>, <code class="language-text">EADDRINUSE</code> 等.</li>\n<li>Windows 错误常量 (Windows Specific Error Constants), 如 <code class="language-text">WSAEACCES</code>, <code class="language-text">WSAEBADF</code> 等.</li>\n<li>libuv 常量 (libuv Constants), 仅 <code class="language-text">UV_UDP_REUSEADDR</code>.</li>\n</ul>\n<h2 id="path"><a href="#path" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Path</h2>\n<p>Node.js 内置的 path 是用于处理路径问题的模块. 不过众所周知, 路径在不同操作系统下有不可调和的差异.</p>\n<h3 id="windows-vs-posix"><a href="#windows-vs-posix" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Windows vs. POSIX</h3>\n<table>\n<thead>\n<tr>\n<th>POSIX</th>\n<th>值</th>\n<th>Windows</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path.posix.sep</td>\n<td><code class="language-text">&#39;/&#39;</code></td>\n<td>path.win32.sep</td>\n<td><code class="language-text">&#39;\\\\&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.normalize(‘/foo/bar//baz/asdf/quux/..‘)</td>\n<td><code class="language-text">&#39;/foo/bar/baz/asdf&#39;</code></td>\n<td>path.win32.normalize(‘C:\n\\\ntemp\n\\\n\\\nfoo\n\\\nbar\n\\\n..\n\\\n‘)</td>\n<td><code class="language-text">&#39;C:\\\\temp\\\\foo\\\\&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.basename(‘/tmp/myfile.html’)</td>\n<td><code class="language-text">&#39;myfile.html&#39;</code></td>\n<td>path.win32.basename(‘C:\n\\\ntemp\n\\\nmyfile.html’)</td>\n<td><code class="language-text">&#39;myfile.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.join(‘/asdf’, ‘/test.html’)</td>\n<td><code class="language-text">&#39;/asdf/test.html&#39;</code></td>\n<td>path.win32.join(‘/asdf’, ‘/test.html’)</td>\n<td><code class="language-text">&#39;\\\\asdf\\\\test.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.relative(‘/root/a’, ‘/root/b’)</td>\n<td><code class="language-text">&#39;../b&#39;</code></td>\n<td>path.win32.relative(‘C:\n\\\na’, ‘c:\n\\\nb’)</td>\n<td><code class="language-text">&#39;..\\\\b&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.isAbsolute(‘/baz/..‘)</td>\n<td><code class="language-text">true</code></td>\n<td>path.win32.isAbsolute(‘C:\n\\\nfoo\n\\\n..‘)</td>\n<td><code class="language-text">true</code></td>\n</tr>\n<tr>\n<td>path.posix.delimiter</td>\n<td><code class="language-text">&#39;:&#39;</code></td>\n<td>path.win32.delimiter</td>\n<td><code class="language-text">&#39;,&#39;</code></td>\n</tr>\n<tr>\n<td>process.env.PATH</td>\n<td><code class="language-text">&#39;/usr/bin:/bin&#39;</code></td>\n<td>process.env.PATH</td>\n<td><code class="language-text">C:\\Windows\\system32;C:\\Program Files\\node\\&#39;</code></td>\n</tr>\n<tr>\n<td>PATH.split(path.posix.delimiter)</td>\n<td><code class="language-text">[&#39;/usr/bin&#39;, &#39;/bin&#39;]</code></td>\n<td>PATH.split(path.win32.delimiter)</td>\n<td><code class="language-text">[&#39;C:\\\\Windows\\\\system32&#39;, &#39;C:\\\\Program Files\\\\node\\\\&#39;]</code></td>\n</tr>\n</tbody>\n</table>\n<p>看了上表之后, 你应该了解到当你处于某个平台之下的时候, 所使用的 <code class="language-text">path</code> 模块的方法其实就是对应的平台的方法, 例如笔者这里用的是 mac, 所以:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98885448553902670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconsole.log(path.basename === path.posix.basename); // true`, `98885448553902670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>basename <span class="token operator">===</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你处于其中某一个平台, 但是要处理另外一个平台的路径, 需要注意这个跨平台的问题.</p>\n<h3 id="path-对象"><a href="#path-%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>path 对象</h3>\n<p>on POSIX:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53600636786324210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path.parse(\'/home/user/dir/file.txt\');\n// Returns:\n// {\n//    root : &quot;/&quot;,\n//    dir : &quot;/home/user/dir&quot;,\n//    base : &quot;file.txt&quot;,\n//    ext : &quot;.txt&quot;,\n//    name : &quot;file&quot;\n// }`, `53600636786324210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'/home/user/dir/file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Returns:</span>\n<span class="token comment">// {</span>\n<span class="token comment">//    root : "/",</span>\n<span class="token comment">//    dir : "/home/user/dir",</span>\n<span class="token comment">//    base : "file.txt",</span>\n<span class="token comment">//    ext : ".txt",</span>\n<span class="token comment">//    name : "file"</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54153597310641360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n&quot;  /    home/user/dir / file  .txt &quot;\n└──────┴──────────────┴──────┴─────┘`, `54153597310641360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n<span class="token string">"  /    home/user/dir / file  .txt "</span>\n└──────┴──────────────┴──────┴─────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>on Windows:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40489549803074580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path.parse(\'C:\\\\path\\\\dir\\\\file.txt\');\n// Returns:\n// {\n//    root : &quot;C:\\\\&quot;,\n//    dir : &quot;C:\\\\path\\\\dir&quot;,\n//    base : &quot;file.txt&quot;,\n//    ext : &quot;.txt&quot;,\n//    name : &quot;file&quot;\n// }`, `40489549803074580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'C:\\\\path\\\\dir\\\\file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Returns:</span>\n<span class="token comment">// {</span>\n<span class="token comment">//    root : "C:\\\\",</span>\n<span class="token comment">//    dir : "C:\\\\path\\\\dir",</span>\n<span class="token comment">//    base : "file.txt",</span>\n<span class="token comment">//    ext : ".txt",</span>\n<span class="token comment">//    name : "file"</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13832709567771228000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n&quot; C:\\      path\\dir   \\ file  .txt &quot;\n└──────┴──────────────┴──────┴─────┘`, `13832709567771228000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n<span class="token string">" C:\\      path\\dir   \\ file  .txt "</span>\n└──────┴──────────────┴──────┴─────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="pathextnamepath"><a href="#pathextnamepath" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>path.extname(path)</h3>\n<table>\n<thead>\n<tr>\n<th>case</th>\n<th>return</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path.extname(‘index.html’)</td>\n<td><code class="language-text">&#39;.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index.coffee.md’)</td>\n<td><code class="language-text">&#39;.md&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index.‘)</td>\n<td><code class="language-text">&#39;.&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index’)</td>\n<td><code class="language-text">&#39;&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘.index’)</td>\n<td><code class="language-text">&#39;&#39;</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id="命令行参数"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行参数</h2>\n<p>命令行参数 (Command Line Options), 即对 CLI 使用上的一些文档. 关于 CLI 主要有 4 种使用方式:</p>\n<ul>\n<li>node <a href="">options</a> <a href="">script.js | -e “script”</a></li>\n<li>node debug [script.js | -e “script” | <code class="language-text">&lt;host&gt;:&lt;port&gt;</code>] …</li>\n<li>node —v8-options</li>\n<li>无参数直接启动 REPL 环境</li>\n</ul>\n<h3 id="options"><a href="#options" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Options</h3>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-v, —version</td>\n<td>查看当前 node 版本</td>\n</tr>\n<tr>\n<td>-h, —help</td>\n<td>查看帮助文档</td>\n</tr>\n<tr>\n<td>-e, —eval “script”</td>\n<td>将参数字符串当做代码执行</td>\n</tr>\n<tr>\n<td>-p, —print “script”</td>\n<td>打印 \n<code class="language-text">-e</code>\n 的返回值</td>\n</tr>\n<tr>\n<td>-c, —check</td>\n<td>检查语法并不执行</td>\n</tr>\n<tr>\n<td>-i, —interactive</td>\n<td>即使 stdin 不是终端也打开 REPL 模式</td>\n</tr>\n<tr>\n<td>-r, —require module</td>\n<td>在启动前预先 \n<code class="language-text">require</code>\n 指定模块</td>\n</tr>\n<tr>\n<td>—no-deprecation</td>\n<td>关闭废弃模块警告</td>\n</tr>\n<tr>\n<td>—trace-deprecation</td>\n<td>打印废弃模块的堆栈跟踪信息</td>\n</tr>\n<tr>\n<td>—throw-deprecation</td>\n<td>执行废弃模块时抛出错误</td>\n</tr>\n<tr>\n<td>—no-warnings</td>\n<td>无视报警（包括废弃警告）</td>\n</tr>\n<tr>\n<td>—trace-warnings</td>\n<td>打印警告的 stack （包括废弃模块）</td>\n</tr>\n<tr>\n<td>—trace-sync-io</td>\n<td>只要检测到异步 I/O 出于 Event loop 的开头就打印 stack trace</td>\n</tr>\n<tr>\n<td>—zero-fill-buffers</td>\n<td>自动初始化(zero-fill) \n<strong>Buffer</strong>\n 和 \n<strong>SlowBuffer</strong></td>\n</tr>\n<tr>\n<td>—preserve-symlinks</td>\n<td>在解析和缓存模块时指示模块加载程序保存符号链接</td>\n</tr>\n<tr>\n<td>—track-heap-objects</td>\n<td>为堆快照跟踪堆对象的分配情况</td>\n</tr>\n<tr>\n<td>—prof-process</td>\n<td>使用 v8 选项 \n<code class="language-text">--prof</code>\n 生成 Profilling 报告</td>\n</tr>\n<tr>\n<td>—v8-options</td>\n<td>显示 v8 命令行选项</td>\n</tr>\n<tr>\n<td>—tls-cipher-list=list</td>\n<td>指明替代的默认 TLS 加密器列表</td>\n</tr>\n<tr>\n<td>—enable-fips</td>\n<td>在启动时开启 FIPS-compliant crypto</td>\n</tr>\n<tr>\n<td>—force-fips</td>\n<td>在启动时强制实施 FIPS-compliant</td>\n</tr>\n<tr>\n<td>—openssl-config=file</td>\n<td>启动时加载 OpenSSL 配置文件</td>\n</tr>\n<tr>\n<td>—icu-data-dir=file</td>\n<td>指定 ICU 数据加载路径</td>\n</tr>\n</tbody>\n</table>\n<h3 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h3>\n<table>\n<thead>\n<tr>\n<th>环境变量</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class="language-text">NODE_DEBUG=module[,…]</code></td>\n<td>指定要打印调试信息的核心模块列表</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_PATH=path[:…]</code></td>\n<td>指定搜索目录模块路径的前缀列表</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_DISABLE_COLORS=1</code></td>\n<td>关闭 REPL 的颜色显示</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_ICU_DATA=file</code></td>\n<td>ICU (Intl object) 数据路径</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_REPL_HISTORY=file</code></td>\n<td>持久化存储 REPL 历史文件的路径</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_TTY_UNSAFE_ASYNC=1</code></td>\n<td>设置为 1 时, 将同步操作 stdio (如 console.log 变成同步)</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_EXTRA_CA_CERTS=file</code></td>\n<td>指定 CA (如 VeriSign) 的额外证书路径</td>\n</tr>\n</tbody>\n</table>\n<h2 id="负载"><a href="#%E8%B4%9F%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载</h2>\n<p>负载是衡量服务器运行状态的一个重要概念. 通过负载情况, 我们可以知道服务器目前状态是空闲、良好、繁忙还是即将 crash.</p>\n<p>通常我们要查看的负载是 CPU 负载, 详细一点的情况你可以通过阅读这篇博客: <a href="http://blog.scoutapp.com/articles/2009/07/31/understanding-load-averages" target="_blank" rel="nofollow noreferrer noopener">Understanding Linux CPU Load</a> 来了解.</p>\n<p>命令行上可以通过 <code class="language-text">uptime</code>, <code class="language-text">top</code> 命令, Node.js 中可以通过 <code class="language-text">os.loadavg()</code> 来获取当前系统的负载情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54291709365749900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`load average: 0.09, 0.05, 0.01`, `54291709365749900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">load average: 0.09, 0.05, 0.01</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其中分别是最近 1 分钟, 5 分钟, 15 分钟内系统 CPU 的平均负载. 当 CPU 的一个核工作饱和的时候负载为 1, 有几核 CPU 那么饱和负载就是几.</p>\n<p>在 Node.js 中单个进程的 CPU 负载查看可以使用 <a href="https://github.com/soyuka/pidusage" target="_blank" rel="nofollow noreferrer noopener">pidusage</a> 模块.</p>\n<p>除了 CPU 负载, 对于服务端 (偏维护) 还需要了解网络负载, 磁盘负载等.</p>\n<h2 id="checklist"><a href="#checklist" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CheckList</h2>\n<blockquote>\n<p>有一个醉汉半夜在路灯下徘徊，路过的人奇怪地问他：“你在路灯下找什么？”醉汉回答：“我在找我的 KEY”,路人更奇怪了：“找钥匙为什么在路灯下?”，醉汉说：“因为这里最亮！”。</p>\n</blockquote>\n<p>很多服务端的同学在说到检查服务器状态时只知道使用 <code class="language-text">top</code> 命令, 其实情况就和上面的笑话一样, 因为对于他们而言 <code class="language-text">top</code> 是最亮的那盏路灯.</p>\n<p>对于服务端程序员而言, 完整的服务器 checklist 首推 <a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B0140I5WPK" target="_blank" rel="nofollow noreferrer noopener">《性能之巅》</a> 第二章中讲述的 <a href="http://www.brendangregg.com/USEmethod/use-linux.html" target="_blank" rel="nofollow noreferrer noopener">USE 方法</a>.</p>\n<p>The USE Method provides a strategy for performing a complete check of system health, identifying common bottlenecks and errors. For each system resource, metrics for utilization, saturation and errors are identified and checked. Any issues discovered are then investigated using further strategies.</p>\n<p>This is an example USE-based metric list for Linux operating systems (eg, Ubuntu, CentOS, Fedora). This is primarily intended for system administrators of the physical systems, who are using command line tools. Some of these metrics can be found in remote monitoring tools.</p>\n<h3 id="physical-resources"><a href="#physical-resources" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Physical Resources</h3>\n<table border="1" cellpadding="2" width="100%">\n<tbody><tr><th>component</th><th>type</th><th>metric</th></tr>\n<tr><td>CPU</td><td>utilization</td><td>system-wide: <tt>vmstat 1</tt>, "us" + "sy" + "st"; <tt>sar -u</tt>, sum fields except "%idle" and "%iowait"; <tt>dstat -c</tt>, sum fields except "idl" and "wai"; per-cpu: <tt>mpstat -P ALL 1</tt>, sum fields except "%idle" and "%iowait"; <tt>sar -P ALL</tt>, same as <tt>mpstat</tt>; per-process: <tt>top</tt>, "%CPU"; <tt>htop</tt>, "CPU%"; <tt>ps -o pcpu</tt>; <tt>pidstat 1</tt>, "%CPU"; per-kernel-thread: <tt>top</tt>/<tt>htop</tt> ("K" to toggle), where VIRT == 0 (heuristic). [1]</td></tr>\n<tr><td>CPU</td><td>saturation</td><td>system-wide: <tt>vmstat 1</tt>, "r" &gt; CPU count [2]; <tt>sar -q</tt>, "runq-sz" &gt; CPU count; <tt>dstat -p</tt>, "run" &gt; CPU count; per-process: /proc/PID/schedstat 2nd field (sched_info.run_delay); <tt>perf sched latency</tt> (shows "Average" and "Maximum" delay per-schedule); dynamic tracing, eg, SystemTap schedtimes.stp "queued(us)" [3]</td></tr>\n<tr><td>CPU</td><td>errors</td><td><tt>perf</tt> (LPE) if processor specific error events (CPC) are available; eg, AMD64\'s "04Ah Single-bit ECC Errors Recorded by Scrubber" [4]</td></tr>\n<tr><td>Memory capacity</td><td>utilization</td><td>system-wide: <tt>free -m</tt>, "Mem:" (main memory), "Swap:" (virtual memory); <tt>vmstat 1</tt>, "free" (main memory), "swap" (virtual memory); <tt>sar -r</tt>, "%memused"; <tt>dstat -m</tt>, "free"; <tt>slabtop -s c</tt> for kmem slab usage; per-process: <tt>top</tt>/<tt>htop</tt>, "RES" (resident main memory), "VIRT" (virtual memory), "Mem" for system-wide summary</td></tr>\n<tr><td>Memory capacity</td><td>saturation</td><td>system-wide: <tt>vmstat 1</tt>, "si"/"so" (swapping); <tt>sar -B</tt>, "pgscank" + "pgscand" (scanning); <tt>sar -W</tt>; per-process: 10th field (min_flt) from /proc/PID/stat for minor-fault rate, or dynamic tracing [5]; OOM killer: <tt>dmesg | grep killed</tt></td></tr>\n<tr><td>Memory capacity</td><td>errors</td><td><tt>dmesg</tt> for physical failures; dynamic tracing, eg, SystemTap uprobes for failed malloc()s</td></tr>\n<tr><td>Network Interfaces</td><td>utilization</td><td><tt>sar -n DEV 1</tt>, "rxKB/s"/max "txKB/s"/max; <tt>ip -s link</tt>, RX/TX tput / max bandwidth; /proc/net/dev, "bytes" RX/TX tput/max; nicstat "%Util" [6]</td></tr>\n<tr><td>Network Interfaces</td><td>saturation</td><td><tt>ifconfig</tt>, "overruns", "dropped"; <tt>netstat -s</tt>, "segments retransmited"; <tt>sar -n EDEV</tt>, *drop and *fifo metrics; /proc/net/dev, RX/TX "drop"; nicstat "Sat" [6]; dynamic tracing for other TCP/IP stack queueing [7]</td></tr>\n<tr><td>Network Interfaces</td><td>errors</td><td><tt>ifconfig</tt>, "errors", "dropped"; <tt>netstat -i</tt>, "RX-ERR"/"TX-ERR"; <tt>ip -s link</tt>, "errors"; <tt>sar -n EDEV</tt>, "rxerr/s" "txerr/s"; /proc/net/dev, "errs", "drop"; extra counters may be under /sys/class/net/...; dynamic tracing of driver function returns 76]</td></tr>\n<tr><td>Storage device I/O</td><td>utilization</td><td>system-wide: <tt>iostat -xz 1</tt>, "%util"; <tt>sar -d</tt>, "%util"; per-process: iotop; <tt>pidstat -d</tt>; /proc/PID/sched "se.statistics.iowait_sum"</td></tr>\n<tr><td>Storage device I/O</td><td>saturation</td><td><tt>iostat -xnz 1</tt>, "avgqu-sz" &gt; 1, or high "await"; <tt>sar -d</tt> same; LPE block probes for queue length/latency; dynamic/static tracing of I/O subsystem (incl. LPE block probes)</td></tr>\n<tr><td>Storage device I/O</td><td>errors</td><td>/sys/devices/.../ioerr_cnt; <tt>smartctl</tt>; dynamic/static tracing of I/O subsystem response codes [8]</td></tr>\n<tr><td>Storage capacity</td><td>utilization</td><td>swap: <tt>swapon -s</tt>; <tt>free</tt>; /proc/meminfo "SwapFree"/"SwapTotal"; file systems: "df -h"</td></tr>\n<tr><td>Storage capacity</td><td>saturation</td><td>not sure this one makes sense - once it\'s full, ENOSPC</td></tr>\n<tr><td>Storage capacity</td><td>errors</td><td><tt>strace</tt> for ENOSPC; dynamic tracing for ENOSPC; /var/log/messages errs, depending on FS</td></tr>\n<tr><td>Storage controller</td><td>utilization</td><td><tt>iostat -xz 1</tt>, sum devices and compare to known IOPS/tput limits per-card</td></tr>\n<tr><td>Storage controller</td><td>saturation</td><td>see storage device saturation, ...</td></tr>\n<tr><td>Storage controller</td><td>errors</td><td>see storage device errors, ...</td></tr>\n<tr><td>Network controller</td><td>utilization</td><td>infer from <tt>ip -s link</tt> (or /proc/net/dev) and known controller max tput for its interfaces</td></tr>\n<tr><td>Network controller</td><td>saturation</td><td>see network interface saturation, ...</td></tr>\n<tr><td>Network controller</td><td>errors</td><td>see network interface errors, ...</td></tr>\n<tr><td>CPU interconnect</td><td>utilization</td><td>LPE (CPC) for CPU interconnect ports, tput / max</td></tr>\n<tr><td>CPU interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>CPU interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available</td></tr>\n<tr><td>Memory interconnect</td><td>utilization</td><td>LPE (CPC) for memory busses, tput / max; or CPI greater than, say, 5; CPC may also have local vs remote counters</td></tr>\n<tr><td>Memory interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>Memory interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available</td></tr>\n<tr><td>I/O interconnect</td><td>utilization</td><td>LPE (CPC) for tput / max if available; inference via known tput from iostat/ip/...</td></tr>\n<tr><td>I/O interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>I/O interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available </td></tr>\n</tbody></table>\n<h3 id="software-resources"><a href="#software-resources" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Software Resources</h3>\n<table border="1" width="100%">\n<tbody><tr><th>component</th><th>type</th><th>metric</th></tr>\n<!--SW-START-->\n<tr><td>Kernel mutex</td><td>utilization</td><td>With CONFIG_LOCK_STATS=y, /proc/lock_stat "holdtime-totat" / "acquisitions" (also see "holdtime-min", "holdtime-max") [8]; dynamic tracing of lock functions or instructions (maybe)</td></tr>\n<tr><td>Kernel mutex</td><td>saturation</td><td>With CONFIG_LOCK_STATS=y, /proc/lock_stat "waittime-total" / "contentions" (also see "waittime-min", "waittime-max"); dynamic tracing of lock functions or instructions (maybe); spinning shows up with profiling (<tt>perf record -a -g -F 997 ...</tt>, <tt>oprofile</tt>, dynamic tracing)</td></tr>\n<tr><td>Kernel mutex</td><td>errors</td><td>dynamic tracing (eg, recusive mutex enter); other errors can cause kernel lockup/panic, debug with kdump/<tt>crash</tt></td></tr>\n<tr><td>User mutex</td><td>utilization</td><td><tt>valgrind --tool=drd --exclusive-threshold=...</tt> (held time); dynamic tracing of lock to unlock function time</td></tr>\n<tr><td>User mutex</td><td>saturation</td><td><tt>valgrind --tool=drd</tt> to infer contention from held time; dynamic tracing of synchronization functions for wait time; profiling (oprofile, PEL, ...) user stacks for spins</td></tr>\n<tr><td>User mutex</td><td>errors</td><td><tt>valgrind --tool=drd</tt> various errors; dynamic tracing of pthread_mutex_lock() for EAGAIN, EINVAL, EPERM, EDEADLK, ENOMEM, EOWNERDEAD, ...</td></tr>\n<tr><td>Task capacity</td><td>utilization</td><td><tt>top</tt>/<tt>htop</tt>, "Tasks" (current); <tt>sysctl kernel.threads-max</tt>, /proc/sys/kernel/threads-max (max)</td></tr>\n<tr><td>Task capacity</td><td>saturation</td><td>threads blocking on memory allocation; at this point the page scanner should be running (sar -B "pgscan*"), else examine using dynamic tracing</td></tr>\n<tr><td>Task capacity</td><td>errors</td><td>"can\'t fork()" errors; user-level threads: pthread_create() failures with EAGAIN, EINVAL, ...; kernel: dynamic tracing of kernel_thread() ENOMEM</td></tr>\n<tr><td>File descriptors</td><td>utilization</td><td>system-wide: <tt>sar -v</tt>, "file-nr" vs /proc/sys/fs/file-max; <tt>dstat --fs</tt>, "files"; or just /proc/sys/fs/file-nr; per-process: <tt>ls /proc/PID/fd | wc -l</tt> vs <tt>ulimit -n</tt></td></tr>\n<tr><td>File descriptors</td><td>saturation</td><td>does this make sense?  I don\'t think there is any queueing or blocking, other than on memory allocation.</td></tr>\n<tr><td>File descriptors</td><td>errors</td><td><tt>strace</tt> errno == EMFILE on syscalls returning fds (eg, open(), accept(), ...).</td></tr>\n</tbody></table>\n<h4 id="ulimit"><a href="#ulimit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ulimit</h4>\n<p>ulimit 用于管理用户对系统资源的访问.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10915378213078663000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-a   显示目前全部限制情况\n-c   设定 core 文件的最大值, 单位为区块\n-d   <数据节区大小> 程序数据节区的最大值, 单位为KB\n-f   <文件大小> shell 所能建立的最大文件, 单位为区块\n-H   设定资源的硬性限制, 也就是管理员所设下的限制\n-m   <内存大小> 指定可使用内存的上限, 单位为 KB\n-n   <文件描述符数目> 指定同一时间最多可开启的 fd 数\n-p   <缓冲区大小> 指定管道缓冲区的大小, 单位512字节\n-s   <堆叠大小> 指定堆叠的上限, 单位为 KB\n-S   设定资源的弹性限制\n-t   指定CPU使用时间的上限, 单位为秒\n-u   <进程数目> 用户最多可开启的进程数目\n-v   <虚拟内存大小> 指定可使用的虚拟内存上限, 单位为 KB`, `10915378213078663000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">-a   显示目前全部限制情况\n-c   设定 core 文件的最大值, 单位为区块\n-d   &lt;数据节区大小&gt; 程序数据节区的最大值, 单位为KB\n-f   &lt;文件大小&gt; shell 所能建立的最大文件, 单位为区块\n-H   设定资源的硬性限制, 也就是管理员所设下的限制\n-m   &lt;内存大小&gt; 指定可使用内存的上限, 单位为 KB\n-n   &lt;文件描述符数目&gt; 指定同一时间最多可开启的 fd 数\n-p   &lt;缓冲区大小&gt; 指定管道缓冲区的大小, 单位512字节\n-s   &lt;堆叠大小&gt; 指定堆叠的上限, 单位为 KB\n-S   设定资源的弹性限制\n-t   指定CPU使用时间的上限, 单位为秒\n-u   &lt;进程数目&gt; 用户最多可开启的进程数目\n-v   &lt;虚拟内存大小&gt; 指定可使用的虚拟内存上限, 单位为 KB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19783191235108480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 127988\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 655360\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 4096\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited`, `19783191235108480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 127988\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 655360\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 4096\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意, open socket 等资源拿到的也是 fd, 所以 <code class="language-text">ulimit -n</code> 比较小除了文件打不开, 还可能建立不了 socket 链接.</p>\n<h1 id="错误处理调试"><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误处理/调试</h1>\n<h2 id="errors"><a href="#errors" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Errors</h2>\n<p>在 Node.js 中的错误主要有以下四种类型：</p>\n<table>\n<thead>\n<tr>\n<th>错误</th>\n<th>名称</th>\n<th>触发</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Standard JavaScript errors</td>\n<td>标准 JavaScript 错误</td>\n<td>由错误代码触发</td>\n</tr>\n<tr>\n<td>System errors</td>\n<td>系统错误</td>\n<td>由操作系统触发</td>\n</tr>\n<tr>\n<td>User-specified errors</td>\n<td>用户自定义错误</td>\n<td>通过 throw 抛出</td>\n</tr>\n<tr>\n<td>Assertion errors</td>\n<td>断言错误</td>\n<td>由 \n<code class="language-text">assert</code>\n 模块触发</td>\n</tr>\n</tbody>\n</table>\n<p>其中标准的 JavaScript 错误常见有：</p>\n<ul>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/EvalError" target="_blank" rel="nofollow noreferrer noopener">EvalError</a>: 调用 eval() 出现错误时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SyntaxError" target="_blank" rel="nofollow noreferrer noopener">SyntaxError</a>: 代码不符合 JavaScript 语法规范时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RangeError" target="_blank" rel="nofollow noreferrer noopener">RangeError</a>: 数组越界时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ReferenceError" target="_blank" rel="nofollow noreferrer noopener">ReferenceError</a>: 引用未定义的变量时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError" target="_blank" rel="nofollow noreferrer noopener">TypeError</a>: 参数类型错误时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/URIError" target="_blank" rel="nofollow noreferrer noopener">URIError</a>: 误用全局的 URI 处理函数时抛出该错误</li>\n</ul>\n<p>而常见的系统错误列表可以通过 Node.js 的 os 对象常看列表：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67449922168564580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const os = require(\'os\');\n\nconsole.log(os.constants.errno);`, `67449922168564580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>目前搜索 Node.js 面试题, 发现很多题目已经跟不上 Node.js 的发展了.比较老的 <a href="https://cnodejs.org/topic/55714dfac4e7fbea6e9a2e5d" target="_blank" rel="nofollow noreferrer noopener">NodeJS 错误处理最佳实践</a>, 译自 Joyent 的官方博客, 其中有这样的描述:</p>\n<blockquote>\n<p>实际上, <code class="language-text">try/catch</code> 唯一常用的是在 <code class="language-text">JSON.parse</code> 和类似验证用户输入的地方</p>\n</blockquote>\n<p>然而实际上现在在 Node.js 中你已经可以轻松的使用 try/catch 去捕获异步的异常了. 并且在 Node.js v7.6 之后使用了升级引擎的新版 v8, 旧版中 try/catch 代码不能优化的问题也解决了. 所以我们现在再来看</p>\n<blockquote>\n<p>怎么处理未预料的出错? 用 try/catch , domains 还是其它什么?</p>\n</blockquote>\n<p>在 Node.js 中错误处理主要有一下几种方法:</p>\n<ul>\n<li>callback(err, data) 回调约定</li>\n<li>throw / try / catch</li>\n<li>EventEmitter 的 error 事件</li>\n</ul>\n<p>callback(err, data) 这种形式的错误处理起来繁琐, 并不具备强制性, 目前已经处于仅需要了解, 不推荐使用的情况. 而 domain 模块则是半只脚踏进棺材了.</p>\n<ol>\n<li>\n<p>感谢 <a href="https://github.com/visionmedia/co" target="_blank" rel="nofollow noreferrer noopener">co</a> 的先河, 现在的你已经简单的使用 try/catch 保护关键的位置, 以 koa 为例, 可以通过中间件的形式来进行错误处理, 详见 <a href="https://github.com/koajs/koa/wiki/Error-Handling" target="_blank" rel="nofollow noreferrer noopener">Koa error handling</a>. 之后的 async/await 均属于这种模式.</p>\n</li>\n<li>\n<p>通过 EventEmitter 的错误监听形式为各大关键的对象加上错误监听的回调. 例如监听 http server, tcp server 等对象的 <code class="language-text">error</code> 事件以及 process 对象提供的 <code class="language-text">uncaughtException</code> 和 <code class="language-text">unhandledRejection</code> 等等.</p>\n</li>\n<li>\n<p>使用 Promise 来封装异步, 并通过 Promise 的错误处理来 handle 错误.</p>\n</li>\n<li>\n<p>如果上述办法不能起到良好的作用, 那么你需要学习如何优雅的 <a href="http://wiki.c2.com/?LetItCrash" target="_blank" rel="nofollow noreferrer noopener">Let It Crash</a></p>\n</li>\n</ol>\n<blockquote>\n<p>为什么要在 cb 的第一参数传 error? 为什么有的 cb 第一个参数不是 error, 例如 http.createServer?</p>\n</blockquote>\n<h3 id="错误栈丢失"><a href="#%E9%94%99%E8%AF%AF%E6%A0%88%E4%B8%A2%E5%A4%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误栈丢失</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70753696123373360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  throw new Error(\'test error\');\n}\n\nfunction main() {\n  test();\n}\n\nmain();`, `70753696123373360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以收获报错:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35393706567943873000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/data/node-interview/error.js:2\n  throw new Error(\'test error\');\n  ^\n\nError: test error\n    at test (/data/node-interview/error.js:2:9)\n    at main (/data/node-interview/error.js:6:3)\n    at Object.<anonymous> (/data/node-interview/error.js:9:1)\n    at Module._compile (module.js:570:32)\n    at Object.Module._extensions..js (module.js:579:10)\n    at Module.load (module.js:487:32)\n    at tryModuleLoad (module.js:446:12)\n    at Function.Module._load (module.js:438:3)\n    at Module.runMain (module.js:604:10)\n    at run (bootstrap_node.js:394:7)`, `35393706567943873000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">^</span>\n\nError<span class="token punctuation">:</span> test error\n    at <span class="token function">test</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>\n    at <span class="token function">main</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>\n    at Object<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">_compile</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">570</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">)</span>\n    at Object<span class="token punctuation">.</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">js</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">579</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">load</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">487</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">)</span>\n    at <span class="token function">tryModuleLoad</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">446</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span>\n    at Function<span class="token punctuation">.</span>Module<span class="token punctuation">.</span><span class="token function">_load</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">438</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">runMain</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">604</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>\n    at <span class="token function">run</span> <span class="token punctuation">(</span>bootstrap_node<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">394</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以发现报错的行数, test 函数, main 函数的调用关系都在 stack 中清晰的体现.</p>\n<p>当你使用 setImmediate 等定时器来设置异步的时候:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42267772680333860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  throw new Error(\'test error\');\n}\n\nfunction main() {\n  setImmediate(() => test());\n}\n\nmain();`, `42267772680333860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们发现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49177031529513075000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/data/node-interview/error.js:2\n  throw new Error(\'test error\');\n  ^\n\nError: test error\n    at test (/data/node-interview/error.js:2:9)\n    at Immediate.setImmediate (/data/node-interview/error.js:6:22)\n    at runCallback (timers.js:637:20)\n    at tryOnImmediate (timers.js:610:5)\n    at processImmediate [as _immediateCallback] (timers.js:582:5)`, `49177031529513075000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">^</span>\n\nError<span class="token punctuation">:</span> test error\n    at <span class="token function">test</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>\n    at Immediate<span class="token punctuation">.</span><span class="token function">setImmediate</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">)</span>\n    at <span class="token function">runCallback</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">637</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">)</span>\n    at <span class="token function">tryOnImmediate</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">610</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span>\n    at processImmediate <span class="token punctuation">[</span><span class="token keyword">as</span> _immediateCallback<span class="token punctuation">]</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">582</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误栈中仅输出到 test 函数内调用的地方位置, 再往上 main 的调用信息就丢失了. 也就是说如果你的函数调用深度比较深的情况下, 你使用异步调用某个函数出错了的情况下追溯这个异步的调用是一个很困难的事情, 因为其之上的栈都已经丢失了. 如果你用过 <a href="https://github.com/caolan/async" target="_blank" rel="nofollow noreferrer noopener">async</a> 之类的模块, 你还可能发现, 报错的 stack 会非常的长而且曲折, 光看 stack 很难去定位问题.</p>\n<p>这在项目不大/作者清楚的情况下不是问题, 但是当项目大起来, 开发人员多起来之后, 这样追溯错误会变得异常痛苦. 关于这个问题, 在上文中提到 <a href="https://cnodejs.org/topic/55714dfac4e7fbea6e9a2e5d" target="_blank" rel="nofollow noreferrer noopener">错误处理的最佳实践</a> 中, 关于 <code class="language-text">编写新函数的具体建议</code> 那一带的内容有描述到. 通过使用 <a href="https://www.npmjs.com/package/verror" target="_blank" rel="nofollow noreferrer noopener">verror</a> 这样的方式, 让 Error 一层层封装, 并在每一层将错误的信息一层层的包上, 最后拿到的 Error 直接可以从 message 中获取用于定位问题的关键信息.</p>\n<p>以昨天的数据为准（2017-3-13）各位只要对比一下看看 npm 上上个月 <a href="https://www.npmjs.com/package/verror" target="_blank" rel="nofollow noreferrer noopener">verror</a> 的下载量 <code class="language-text">1100w</code> 比 <a href="https://www.npmjs.com/package/express" target="_blank" rel="nofollow noreferrer noopener">express</a> 的 <code class="language-text">1070w</code> 还高. 应该就能感受到这种写法有多流行了.</p>\n<h3 id="防御性编程"><a href="#%E9%98%B2%E5%BE%A1%E6%80%A7%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>防御性编程</h3>\n<p>错误并不可怕, 可怕的是你不去准备应对错误————<a href="http://blog.jobbole.com/101651/" target="_blank" rel="nofollow noreferrer noopener">防御性编程的介绍和技巧</a></p>\n<h3 id="let-it-crash"><a href="#let-it-crash" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>let it crash</h3>\n<p><a href="http://wiki.c2.com/?LetItCrash" target="_blank" rel="nofollow noreferrer noopener">Let It Crash</a></p>\n<h3 id="uncaughtexception"><a href="#uncaughtexception" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>uncaughtException</h3>\n<p>当异常没有被捕获一路冒泡到 Event Loop 时就会触发该事件 process 对象上的 <code class="language-text">uncaughtException</code> 事件. 默认情况下, Node.js 对于此类异常会直接将其堆栈跟踪信息输出给 <code class="language-text">stderr</code> 并结束进程, 而为 <code class="language-text">uncaughtException</code> 事件添加监听可以覆盖该默认行为, 不会直接结束进程.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86499849069019410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'uncaughtException\', (err) => {\n  console.log(\\`Caught exception: \\${err}\\`);\n});\n\nsetTimeout(() => {\n  console.log(\'This will still run.\');\n}, 500);\n\n// Intentionally cause an exception, but don\'t catch it.\nnonexistentFunc();\nconsole.log(\'This will not run.\');`, `86499849069019410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Caught exception: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This will still run.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Intentionally cause an exception, but don\'t catch it.</span>\n<span class="token function">nonexistentFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This will not run.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="合理使用-uncaughtexception"><a href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8-uncaughtexception" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>合理使用 uncaughtException</h4>\n<p><code class="language-text">uncaughtException</code> 的初衷是可以让你拿到错误之后可以做一些回收处理之后再 process.exit. 官方的同志们还曾经讨论过要移除该事件 (详见 <a href="https://github.com/nodejs/node-v0.x-archive/issues/2582" target="_blank" rel="nofollow noreferrer noopener">issues</a>)</p>\n<p>所以你需要明白 <code class="language-text">uncaughtException</code> 其实已经是非常规手段了, 应尽量避免使用它来处理错误. 因为通过该事件捕获到错误后, 并不代表 <code class="language-text">你可以愉快的继续运行 (On Error Resume Next)</code>. 程序内部存在未处理的异常, 这意味着应用程序处于一种未知的状态. 如果不能适当的恢复其状态, 那么很有可能会触发不可预见的问题. (使用 domain 会很夸张的加剧这个现象, 并产生新人不能理解的各类幽灵问题)</p>\n<p>如果在 <code class="language-text">.on</code> 指定的监听回调中报错不会被捕获, Node.js 的进程会直接终断并返回一个非零的退出码, 最后输出相应的堆栈信息. 否则, 会出现无限递归. 除此之外, 内存崩溃/底层报错等情况也不会被捕获, <strong>目前猜测</strong>是 v8/C++ 那边撂担子不干了, Node.js 完全插不上话导致的 (TODO 整理到这里才想起来这个念头尚未验证, 如果有空的朋友帮忙验证下).</p>\n<p>所以官方建议的使用 <code class="language-text">uncaughtException</code> 的正确姿势是在结束进程前使用同步的方式清理已使用的资源 (文件描述符、句柄等) 然后 process.exit.</p>\n<p>在 uncaughtException 事件之后执行普通的恢复操作并不安全. 官方建议是另外在专门准备一个 monitor 进程来做健康检查并通过 monitor 来管理恢复情况, 并在必要的时候重启 (所以官方是含蓄的提醒各位用 pm2 之类的工具).</p>\n<h3 id="unhandledrejection"><a href="#unhandledrejection" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unhandledRejection</h3>\n<p>当 Promise 被 reject 且没有绑定监听处理时, 就会触发该事件. 该事件对排查和追踪没有处理 reject 行为的 Promise 很有用.</p>\n<p>该事件的回调函数接收以下参数：</p>\n<ul>\n<li><code class="language-text">reason</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" target="_blank" rel="nofollow noreferrer noopener"><code class="language-text">&lt;Error&gt;</code></a> | <code class="language-text">&lt;any&gt;</code> 该 Promise 被 reject 的对象 (通常为 Error 对象)</li>\n<li><code class="language-text">p</code> 被 reject 的 Promise 本身</li>\n</ul>\n<p>例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98500246899549730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'unhandledRejection\', (reason, p) => {\n  console.log(\'Unhandled Rejection at: Promise\', p, \'reason:\', reason);\n  // application specific logging, throwing an error, or other logic here\n});\n\nsomePromise.then((res) => {\n  return reportToUser(JSON.pasre(res)); // note the typo (\\`pasre\\`)\n}); // no \\`.catch\\` or \\`.then\\``, `98500246899549730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Unhandled Rejection at: Promise\'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">\'reason:\'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// application specific logging, throwing an error, or other logic here</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nsomePromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">reportToUser</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">pasre</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// note the typo (`pasre`)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no `.catch` or `.then`</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下代码也会触发 <code class="language-text">unhandledRejection</code> 事件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45097322242146910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function SomeResource() {\n  // Initially set the loaded status to a rejected promise\n  this.loaded = Promise.reject(new Error(\'Resource not yet loaded!\'));\n}\n\nvar resource = new SomeResource();\n// no .catch or .then on resource.loaded for at least a turn`, `45097322242146910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">SomeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Initially set the loaded status to a rejected promise</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Resource not yet loaded!\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// no .catch or .then on resource.loaded for at least a turn</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>In this example case, it is possible to track the rejection as a developer error as would typically be the case for other ‘unhandledRejection’ events. To address such failures, a non-operational <code class="language-text">.catch(() =&gt; { })</code> handler may be attached to resource.loaded, which would prevent the ‘unhandledRejection’ event from being emitted. Alternatively, the ‘rejectionHandled’ event may be used.</p>\n</blockquote>\n<h2 id="domain"><a href="#domain" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Domain</h2>\n<p>Node.js 早期, try/catch 无法捕获异步的错误, 而错误优先的 callback 仅仅是一种约定并没有强制性并且写起来十分繁琐. 所以为了能够很好的捕获异常, Node.js 从 v0.8 开始引入 domain 这个模块.</p>\n<p>domain 本身是一个 EventEmitter 对象, 其中文意思是 “域” 的意思, 捕获异步异常的基本思路是创建一个域, cb 函数会在定义时会继承上一层的域, 报错通过当前域的 <code class="language-text">.emit(&#39;error&#39;, err)</code> 方法触发错误事件将错误传递上去, 从而使得异步错误可以被强制捕获. (更多内容详见 <a href="https://cnodejs.org/topic/516b64596d38277306407936" target="_blank" rel="nofollow noreferrer noopener">Node.js 异步异常的处理与 domain 模块解析</a>)</p>\n<p>但是 domain 的引入也带来了更多新的问题. 比如依赖的模块无法继承你定义的 domain, 导致你写的 domain 无法 cover 依赖模块报错. 而且, 很多人 (特别是新人) 由于不了解 Node.js 的内存/异步流程等问题, 在使用 domain 处理报错的时候, 没有做到完善的处理并盲目的让代码继续走下去, 这很可能导致<strong>项目完全无法维护</strong> (可能出现的问题真是不胜枚举, 各种梦魇…)</p>\n<p>该模块目前的情况: <a href="https://github.com/nodejs/node/issues/66" target="_blank" rel="nofollow noreferrer noopener">deprecate domains</a></p>\n<h2 id="debugger"><a href="#debugger" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Debugger</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-9cc21.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.88665175242357%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACG0lEQVQoz5WS22pTQRSG8xA+gD5AUa99BR/DK2/ES+98AkEvxEJqiqXQICpt2kIrRlujjW011CYxZic0zWkn2Yc57MPMntN2dhJKdxHBnzUDa5hvzeKflYn/X2oaWhmllONC4CIAkAsQxr5OTdPSKYQYIQ9BPDQnE8udWI5lu/r8okpGr9Ozzv5p7bjVLtV/HRmtb41msfKzVK2XavVDwyg3fr8/rujDo6ZxUG9Uu12HhoCSOcxiRZQMBddBpRCxEnE83ZVQiiuZ6lkpJiWXcg5fEWUMk9CjxGPRLDCLEIuYlFduZi7qua5rQ6C84NGPvevF1dsf1m5u5hYKLxcKS7c2czfeLeZbVRGEXIoUzBgDADiOMx6NTNveX17J37u/8ezpeqex1TV2zc7u8Gxr0O4FOHlEqRTMOQ+CgBASYDQAnpd/Ej+8o9ZeaAMU5//4swQOwxDqb8EeRgD68fjksbVzDQ/fejQWkmnPZqFi9ReYC+FMZdmOCNGDxb3M3aXVj41YUsalmjoyGwx1SSnDZCIVS16udVc/NY2+HdGQRlFEqXZa7xGhMm14Avs8ClgUp6smRnIOIAbYg54HfR8GAQpDTAmiJGBsDn8xzw+H59DWbds6lXoMRPJCu9N7/up19k0hu76d3d7JFYvLXz+vfC9nKwcbRm0OE8EjIfRoaV3uihDaHYx6o0lvPOlbdt9xBsAdINDH0Ap9feEPXREIVIwOJqwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 03 20 15 43 51" title="" data-src="/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-fee1c.png" data-srcset="/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-a67b7.png 200w,\n/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-0b187.png 400w,\n/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-fee1c.png 800w,\n/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-b1a91.png 1200w,\n/static/2021-03-20-15-43-51-b57c8a1b61635006231552f033d8860f-9cc21.png 1341w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>类似 gdb 的命令行下 debug 工具 (上图中的 build-in debugger), 同时也支持远程 debug (类似 <a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="nofollow noreferrer noopener">node-inspector</a>, 目前处于试验状态). 当然, 目前有不少同学觉得 <a href="https://code.visualstudio.com/" target="_blank" rel="nofollow noreferrer noopener">vscode</a> 对 debug 工具集成的比较好.</p>\n<p>关于这个 build-in debugger 使用推荐看<a href="https://nodejs.org/dist/latest-v6.x/docs/api/debugger.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>. 如果要深入一点, 你可能对本文感兴趣: <a href="http://code.oneapm.com/nodejs/2015/06/27/intereference/" target="_blank" rel="nofollow noreferrer noopener">动态修改 NodeJS 程序中的变量值</a></p>\n<h2 id="cc-addon"><a href="#cc-addon" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C/C++ Addon</h2>\n<p>在 Node.js 中开发 addon 最痛苦的地方莫过于升级 V8 导致的 C/C++ 代码不能兼容的问题, 这个问题在很早就出现了. 为了解决这个问题前人开了一个叫 <a href="https://github.com/nodejs/nan" target="_blank" rel="nofollow noreferrer noopener">nan</a> 的项目.</p>\n<p>要学习 addon 开发, 除了<a href="https://nodejs.org/docs/latest/api/addons.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>也推荐阅读这个: <a href="https://github.com/nodejs/node-addon-examples" target="_blank" rel="nofollow noreferrer noopener">https://github.com/nodejs/node-addon-examples</a></p>\n<h2 id="v8"><a href="#v8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>V8</h2>\n<p>这里并不是介绍 V8, 而是介绍 Node.js 中的 V8 这个模块. 该模块用于开放 Node.js 内建的 V8 引擎的事件和接口. 这些接口由 V8 底层决定, 所以无法保证绝对的稳定性.</p>\n<table>\n<thead>\n<tr>\n<th>接口</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>v8.getHeapStatistics()</td>\n<td>获取 heap 信息</td>\n</tr>\n<tr>\n<td>v8.getHeapSpaceStatistics()</td>\n<td>获取 heap space 信息</td>\n</tr>\n<tr>\n<td>v8.setFlagsFromString(string)</td>\n<td>动态设置 V8 options</td>\n</tr>\n</tbody>\n</table>\n<h3 id="v8setflagsfromstringstring"><a href="#v8setflagsfromstringstring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>v8.setFlagsFromString(string)</h3>\n<p>该方法用于添加额外的 V8 命令行标志. 该方法需谨慎使用, 在 VM 启动后修改配置可能会发生不可预测的行为、崩溃和数据丢失; 或者什么反应都没有.</p>\n<p>通过 <code class="language-text">node --v8-options</code> 命令可以查询当前 Node.js 环境中有哪些可用的 V8 options. 此外, 还可以参考非官方维护的一个 <a href="https://github.com/thlorenz/v8-flags/blob/master/flags-0.11.md" target="_blank" rel="nofollow noreferrer noopener">V8 options 列表</a>.</p>\n<p>用法:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82209712928996340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Print GC events to stdout for one minute.\nconst v8 = require(\'v8\');\nv8.setFlagsFromString(\'--trace_gc\');\nsetTimeout(function() {\n  v8.setFlagsFromString(\'--notrace_gc\');\n}, 60e3);`, `82209712928996340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Print GC events to stdout for one minute.</span>\n<span class="token keyword">const</span> v8 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'v8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nv8<span class="token punctuation">.</span><span class="token function">setFlagsFromString</span><span class="token punctuation">(</span><span class="token string">\'--trace_gc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  v8<span class="token punctuation">.</span><span class="token function">setFlagsFromString</span><span class="token punctuation">(</span><span class="token string">\'--notrace_gc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60e3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="内存快照"><a href="#%E5%86%85%E5%AD%98%E5%BF%AB%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存快照</h2>\n<p>内存快照常用与解决内存泄漏的问题. 快照工具推荐使用 <a href="https://github.com/bnoordhuis/node-heapdump" target="_blank" rel="nofollow noreferrer noopener">heapdump</a> 用来保存内存快照, 使用 <a href="https://github.com/Jam3/devtool" target="_blank" rel="nofollow noreferrer noopener">devtool</a> 来查看内存快照. 使用 heapdump 保存内存快照时, 只会有 Node.js 环境中的对象, 不会受到干扰（如果使用 <a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="nofollow noreferrer noopener">node-inspector</a> 的话, 快照中会有前端的变量干扰）.</p>\n<p>使用以及内存泄漏的常见原因详见: <a href="https://zhuanlan.zhihu.com/p/25736931?group_id=825001468703674368" target="_blank" rel="nofollow noreferrer noopener">如何分析 Node.js 中的内存泄漏</a>.</p>\n<h2 id="cpu-profiling"><a href="#cpu-profiling" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CPU profiling</h2>\n<p>CPU profiling (剖析) 常用于性能优化. 有许多用于做 profiling 的第三方工具, 但是大部分情况下, 使用 Node.js 内置的是最简单的. 其内置调用的就是 <a href="https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler" target="_blank" rel="nofollow noreferrer noopener">V8 本身的 profiler</a>, 它可以在程序执行过程中中是对 stack 间隔性的抽样分析.</p>\n<p>使用 <code class="language-text">--prof</code> 开启内置的 profilling</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6633558436141928000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --prof app.js`, `6633558436141928000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="shell"\n              >\n                <span class="gatsby-code-button-language">shell</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">node --prof app.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>程序运行之后会生成一个 <code class="language-text">isolate-0xnnnnnnnnnnnn-v8.log</code> 在当前运行目录.</p>\n<p>你可以使用 <code class="language-text">--prof-process</code> 来生成报告查看</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70025652224370850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --prof-process isolate-0xnnnnnnnnnnnn-v8.log`, `70025652224370850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">node --prof-process isolate-0xnnnnnnnnnnnn-v8.log</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>报告形如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36113842251852080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Statistical profiling result from isolate-0x103001200-v8.log, (12042 ticks, 2634 unaccounted, 0 excluded).\n\n [Shared libraries]:\n   ticks  total  nonlib   name\n     35    0.3%          /usr/lib/system/libsystem_platform.dylib\n     27    0.2%          /usr/lib/system/libsystem_pthread.dylib\n      7    0.1%          /usr/lib/system/libsystem_c.dylib\n      3    0.0%          /usr/lib/system/libsystem_kernel.dylib\n      1    0.0%          /usr/lib/system/libsystem_malloc.dylib\n\n [JavaScript]:\n   ticks  total  nonlib   name\n    208    1.7%    1.7%  Stub: LoadICStub\n    187    1.6%    1.6%  KeyedLoadIC: A keyed load IC from the snapshot\n    104    0.9%    0.9%  Stub: VectorStoreICStub\n     69    0.6%    0.6%  LazyCompile: *emit events.js:136:44\n     68    0.6%    0.6%  Builtin: CallFunction_ReceiverIsNotNullOrUndefined\n     65    0.5%    0.5%  KeyedStoreIC: A keyed store IC from the snapshot {2}\n     47    0.4%    0.4%  Builtin: CallFunction_ReceiverIsAny\n     43    0.4%    0.4%  LazyCompile: *storeHeader _http_outgoing.js:312:21\n     34    0.3%    0.3%  LazyCompile: *removeListener events.js:315:28\n     33    0.3%    0.3%  Stub: RegExpExecStub\n     33    0.3%    0.3%  LazyCompile: *_addListener events.js:210:22\n     32    0.3%    0.3%  Stub: CEntryStub\n     32    0.3%    0.3%  Builtin: ArgumentsAdaptorTrampoline\n     31    0.3%    0.3%  Stub: FastNewClosureStub\n     30    0.2%    0.3%  Stub: InstanceOfStub\n     ...\n\n [C++]:\n   ticks  total  nonlib   name\n    460    3.8%    3.8%  _mach_port_extract_member\n    329    2.7%    2.7%  _openat\\$NOCANCEL\n    199    1.7%    1.7%  ___bsdthread_register\n    136    1.1%    1.1%  ___mkdir_extended\n    116    1.0%    1.0%  node::HandleWrap::Close(v8::FunctionCallbackInfo<v8::Value> const&)\n    112    0.9%    0.9%  void v8::internal::BodyDescriptorBase::IterateBodyImpl<v8::internal::StaticScavengeVisitor>(v8::internal::Heap*, v8::internal::HeapObject*, int, int)\n    106    0.9%    0.9%  _http_parser_execute\n    103    0.9%    0.9%  _szone_malloc_should_clear\n     99    0.8%    0.8%  int v8::internal::BinarySearch<(v8::internal::SearchMode)1, v8::internal::DescriptorArray>(v8::internal::DescriptorArray*, v8::internal::Name*, int, int*)\n     89    0.7%    0.7%  node::TCPWrap::Connect(v8::FunctionCallbackInfo<v8::Value> const&)\n     86    0.7%    0.7%  v8::internal::LookupIterator::State v8::internal::LookupIterator::LookupInRegularHolder<false>(v8::internal::Map*, v8::internal::JSReceiver*)\n     ...\n\n [Bottom up (heavy) profile]:\n  Note: percentage shows a share of a particular caller in the total\n  amount of its parent calls.\n  Callers occupying less than 2.0% are not shown.\n\n   ticks parent  name\n   2634   21.9%  UNKNOWN\n    764   29.0%    LazyCompile: *connect net.js:815:17\n    764  100.0%      LazyCompile: ~<anonymous> net.js:966:30\n    764  100.0%        LazyCompile: *_tickCallback internal/process/next_tick.js:87:25\n    193    7.3%    LazyCompile: *createWriteReq net.js:732:24\n    101   52.3%      LazyCompile: *Socket._writeGeneric net.js:660:42\n     99   98.0%        LazyCompile: ~<anonymous> net.js:667:34\n     99  100.0%          LazyCompile: ~g events.js:287:13\n     99  100.0%            LazyCompile: *emit events.js:136:44\n     92   47.7%      LazyCompile: ~Socket._writeGeneric net.js:660:42\n     91   98.9%        LazyCompile: ~<anonymous> net.js:667:34\n     91  100.0%          LazyCompile: ~g events.js:287:13\n     91  100.0%            LazyCompile: *emit events.js:136:44\n  ...`, `36113842251852080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Statistical profiling result from isolate-0x103001200-v8.log, (12042 ticks, 2634 unaccounted, 0 excluded).\n\n [Shared libraries]:\n   ticks  total  nonlib   name\n     35    0.3%          /usr/lib/system/libsystem_platform.dylib\n     27    0.2%          /usr/lib/system/libsystem_pthread.dylib\n      7    0.1%          /usr/lib/system/libsystem_c.dylib\n      3    0.0%          /usr/lib/system/libsystem_kernel.dylib\n      1    0.0%          /usr/lib/system/libsystem_malloc.dylib\n\n [JavaScript]:\n   ticks  total  nonlib   name\n    208    1.7%    1.7%  Stub: LoadICStub\n    187    1.6%    1.6%  KeyedLoadIC: A keyed load IC from the snapshot\n    104    0.9%    0.9%  Stub: VectorStoreICStub\n     69    0.6%    0.6%  LazyCompile: *emit events.js:136:44\n     68    0.6%    0.6%  Builtin: CallFunction_ReceiverIsNotNullOrUndefined\n     65    0.5%    0.5%  KeyedStoreIC: A keyed store IC from the snapshot {2}\n     47    0.4%    0.4%  Builtin: CallFunction_ReceiverIsAny\n     43    0.4%    0.4%  LazyCompile: *storeHeader _http_outgoing.js:312:21\n     34    0.3%    0.3%  LazyCompile: *removeListener events.js:315:28\n     33    0.3%    0.3%  Stub: RegExpExecStub\n     33    0.3%    0.3%  LazyCompile: *_addListener events.js:210:22\n     32    0.3%    0.3%  Stub: CEntryStub\n     32    0.3%    0.3%  Builtin: ArgumentsAdaptorTrampoline\n     31    0.3%    0.3%  Stub: FastNewClosureStub\n     30    0.2%    0.3%  Stub: InstanceOfStub\n     ...\n\n [C++]:\n   ticks  total  nonlib   name\n    460    3.8%    3.8%  _mach_port_extract_member\n    329    2.7%    2.7%  _openat$NOCANCEL\n    199    1.7%    1.7%  ___bsdthread_register\n    136    1.1%    1.1%  ___mkdir_extended\n    116    1.0%    1.0%  node::HandleWrap::Close(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)\n    112    0.9%    0.9%  void v8::internal::BodyDescriptorBase::IterateBodyImpl&lt;v8::internal::StaticScavengeVisitor&gt;(v8::internal::Heap*, v8::internal::HeapObject*, int, int)\n    106    0.9%    0.9%  _http_parser_execute\n    103    0.9%    0.9%  _szone_malloc_should_clear\n     99    0.8%    0.8%  int v8::internal::BinarySearch&lt;(v8::internal::SearchMode)1, v8::internal::DescriptorArray&gt;(v8::internal::DescriptorArray*, v8::internal::Name*, int, int*)\n     89    0.7%    0.7%  node::TCPWrap::Connect(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)\n     86    0.7%    0.7%  v8::internal::LookupIterator::State v8::internal::LookupIterator::LookupInRegularHolder&lt;false&gt;(v8::internal::Map*, v8::internal::JSReceiver*)\n     ...\n\n [Bottom up (heavy) profile]:\n  Note: percentage shows a share of a particular caller in the total\n  amount of its parent calls.\n  Callers occupying less than 2.0% are not shown.\n\n   ticks parent  name\n   2634   21.9%  UNKNOWN\n    764   29.0%    LazyCompile: *connect net.js:815:17\n    764  100.0%      LazyCompile: ~&lt;anonymous&gt; net.js:966:30\n    764  100.0%        LazyCompile: *_tickCallback internal/process/next_tick.js:87:25\n    193    7.3%    LazyCompile: *createWriteReq net.js:732:24\n    101   52.3%      LazyCompile: *Socket._writeGeneric net.js:660:42\n     99   98.0%        LazyCompile: ~&lt;anonymous&gt; net.js:667:34\n     99  100.0%          LazyCompile: ~g events.js:287:13\n     99  100.0%            LazyCompile: *emit events.js:136:44\n     92   47.7%      LazyCompile: ~Socket._writeGeneric net.js:660:42\n     91   98.9%        LazyCompile: ~&lt;anonymous&gt; net.js:667:34\n     91  100.0%          LazyCompile: ~g events.js:287:13\n     91  100.0%            LazyCompile: *emit events.js:136:44\n  ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<table>\n<thead>\n<tr>\n<th>字段</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ticks</td>\n<td>时间片</td>\n</tr>\n<tr>\n<td>total</td>\n<td>当前操作执行的时间占总时间的比率</td>\n</tr>\n<tr>\n<td>nonlib</td>\n<td>当前非 System library 执行时间比率</td>\n</tr>\n</tbody>\n</table>\n<h1 id="util"><a href="#util" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util</h1>\n<h2 id="url"><a href="#url" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URL</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97380641819443430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────────────────────────────────────────────────────────────┐\n│                                    href                                     │\n├──────────┬┬───────────┬─────────────────┬───────────────────────────┬───────┤\n│ protocol ││   auth    │      host       │           path            │ hash  │\n│          ││           ├──────────┬──────┼──────────┬────────────────┤       │\n│          ││           │ hostname │ port │ pathname │     search     │       │\n│          ││           │          │      │          ├─┬──────────────┤       │\n│          ││           │          │      │          │ │    query     │       │\n&quot;  http:   // user:pass @ host.com : 8080   /p/a/t/h  ?  query=string   #hash &quot;\n│          ││           │          │      │          │ │              │       │\n└──────────┴┴───────────┴──────────┴──────┴──────────┴─┴──────────────┴───────┘`, `97380641819443430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────────────────────────────────────────────────────────────┐\n│                                    href                                     │\n├──────────┬┬───────────┬─────────────────┬───────────────────────────┬───────┤\n│ protocol ││   auth    │      host       │           path            │ hash  │\n│          ││           ├──────────┬──────┼──────────┬────────────────┤       │\n│          ││           │ hostname │ port │ pathname │     search     │       │\n│          ││           │          │      │          ├─┬──────────────┤       │\n│          ││           │          │      │          │ │    query     │       │\n<span class="token string">"  http:   // user:pass @ host.com : 8080   /p/a/t/h  ?  query=string   #hash "</span>\n│          ││           │          │      │          │ │              │       │\n└──────────┴┴───────────┴──────────┴──────┴──────────┴─┴──────────────┴───────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="转义字符"><a href="#%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>转义字符</h3>\n<p>常见的需要转义的字符列表:</p>\n<table>\n<thead>\n<tr>\n<th>字符</th>\n<th>encodeURI</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class="language-text">&#39; &#39;</code></td>\n<td><code class="language-text">&#39;%20&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&lt;</code></td>\n<td><code class="language-text">&#39;%3C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&gt;</code></td>\n<td><code class="language-text">&#39;%3E&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&quot;</code></td>\n<td><code class="language-text">&#39;%22&#39;</code></td>\n</tr>\n<tr>\n<td>`</td>\n<td><code class="language-text">&#39;%60&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\r</code></td>\n<td><code class="language-text">&#39;%0D&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\n</code></td>\n<td><code class="language-text">&#39;%0A&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\t</code></td>\n<td><code class="language-text">&#39;%09&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">{</code></td>\n<td><code class="language-text">&#39;%7B&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">}</code></td>\n<td><code class="language-text">&#39;%7D&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">|</code></td>\n<td><code class="language-text">&#39;%7C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\\\</code></td>\n<td><code class="language-text">&#39;%5C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">^</code></td>\n<td><code class="language-text">&#39;%5E&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&#39;</code></td>\n<td><code class="language-text">&#39;%27&#39;</code></td>\n</tr>\n</tbody>\n</table>\n<p>想了解更多? 你可以这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47456277790132400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Array(range)\n  .fill(0)\n  .map((_, i) => String.fromCharCode(i))\n  .map(encodeURI);`, `47456277790132400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">Array</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>encodeURI<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="query-strings"><a href="#query-strings" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Query Strings</h2>\n<p>query string 属于 URL 的一部分, 见上方 URL 的表. 在 Node.js 中有内置提供一个 <code class="language-text">querystring</code> 的模块.</p>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.parse(str[, sep[, eq\n[\n, options\n]\n]])</td>\n<td>将一个 query string 解析为 json 对象</td>\n</tr>\n<tr>\n<td>.unescape(str)</td>\n<td>供 .parse 调用的内置解转义方法, 暴露出来以供用户自行替代</td>\n</tr>\n<tr>\n<td>.stringify(obj[, sep[, eq\n[\n, options\n]\n]])</td>\n<td>将一个 json 对象转换成 query string</td>\n</tr>\n<tr>\n<td>.escape(str)</td>\n<td>供 .stringify 调用的内置转义方法, 暴露出来以供用户自行替代</td>\n</tr>\n</tbody>\n</table>\n<p>Node.js 内置的 querystring 目前对于有深度的结构尚不支持. 见如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27921096157986415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const qs = require(\'qs\'); // 第三方\nconst querystring = require(\'querystring\'); // Node.js 内置\n\nlet obj = { a: { b: { c: 1 } } };\n\nconsole.log(qs.stringify(obj)); // \'a%5Bb%5D%5Bc%5D=1\'\nconsole.log(querystring.stringify(obj)); // \'a=\'\n\nlet str = \'a%5Bb%5D%5Bc%5D=1\';\n\nconsole.log(qs.parse(str)); // { a: { b: { c: \'1\' } } }\nconsole.log(querystring.parse(str)); // { \'a[b][c]\': \'1\' }`, `27921096157986415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'qs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第三方</span>\n<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'querystring\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Node.js 内置</span>\n\n<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token punctuation">{</span> b<span class="token punctuation">:</span> <span class="token punctuation">{</span> c<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'a%5Bb%5D%5Bc%5D=1\'</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'a=\'</span>\n\n<span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">\'a%5Bb%5D%5Bc%5D=1\'</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { a: { b: { c: \'1\' } } }</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { \'a[b][c]\': \'1\' }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p><a name="q-get-param"></a> HTTP 如何通过 GET 方法 (URL) 传递 let arr = [1,2,3,4] 给服务器?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85944645846751530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const qs = require(\'qs\');\n\nlet arr = [1, 2, 3, 4];\nlet str = qs.stringify({ arr });\n\nconsole.log(str); // arr%5B0%5D=1&arr%5B1%5D=2&arr%5B2%5D=3&arr%5B3%5D=4\nconsole.log(decodeURI(str)); // \'arr[0]=1&arr[1]=2&arr[2]=3&arr[3]=4\'\nconsole.log(qs.parse(str)); // { arr: [ \'1\', \'2\', \'3\', \'4\' ] }`, `85944645846751530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'qs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> str <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> arr <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arr%5B0%5D=1&amp;arr%5B1%5D=2&amp;arr%5B2%5D=3&amp;arr%5B3%5D=4</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">decodeURI</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'arr[0]=1&amp;arr[1]=2&amp;arr[2]=3&amp;arr[3]=4\'</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { arr: [ \'1\', \'2\', \'3\', \'4\' ] }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 <code class="language-text">https://your.host/api/?arr[0]=1&amp;arr[1]=2&amp;arr[2]=3&amp;arr[3]=4</code> 即可传递把 arr 数组传递给服务器</p>\n<h2 id="util-1"><a href="#util-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util</h2>\n<p>util.is*() 从 v4.0.0 开始被不建议使用即将废弃 (deprecated). 大概的废弃原因, 笔者个人认为是维护这些功能吃力不讨好, 而且现在流行的轮子那么多. 那么一下是具体列表:</p>\n<ul>\n<li>util.debug(string)</li>\n<li>util.error([…strings])</li>\n<li>util.isArray(object)</li>\n<li>util.isBoolean(object)</li>\n<li>util.isBuffer(object)</li>\n<li>util.isDate(object)</li>\n<li>util.isError(object)</li>\n<li>util.isFunction(object)</li>\n<li>util.isNull(object)</li>\n<li>util.isNullOrUndefined(object)</li>\n<li>util.isNumber(object)</li>\n<li>util.isObject(object)</li>\n<li>util.isPrimitive(object)</li>\n<li>util.isRegExp(object)</li>\n<li>util.isString(object)</li>\n<li>util.isSymbol(object)</li>\n<li>util.isUndefined(object)</li>\n<li>util.log(string)</li>\n<li>util.print([…strings])</li>\n<li>util.puts([…strings])</li>\n<li>util._extend(target, source)</li>\n</ul>\n<p>其中大部分都可以作为面试题来问如何实现.</p>\n<h3 id="utilinherits"><a href="#utilinherits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util.inherits</h3>\n<blockquote>\n<p>Node.js 中继承 (util.inherits) 的实现?</p>\n</blockquote>\n<p><a href="https://github.com/nodejs/node/blob/v7.6.0/lib/util.js#L960" target="_blank" rel="nofollow noreferrer noopener">https://github.com/nodejs/node/blob/v7.6.0/lib/util.js#L960</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37677922384162365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * Inherit the prototype methods from one constructor into another.\n *\n * The Function.prototype.inherits from lang.js rewritten as a standalone\n * function (not on Function.prototype). NOTE: If this file is to be loaded\n * during bootstrapping this function needs to be rewritten using some native\n * functions as prototype setup using normal JavaScript does not work as\n * expected during bootstrapping (see mirror.js in r114903).\n *\n * @param {function} ctor Constructor function which needs to inherit the\n *     prototype.\n * @param {function} superCtor Constructor function to inherit prototype from.\n * @throws {TypeError} Will error if either constructor is null, or if\n *     the super constructor lacks a prototype.\n */\nexports.inherits = function(ctor, superCtor) {\n  if (ctor === undefined || ctor === null)\n    throw new TypeError(\'The constructor to &quot;inherits&quot; must not be \' + \'null or undefined\');\n\n  if (superCtor === undefined || superCtor === null)\n    throw new TypeError(\'The super constructor to &quot;inherits&quot; must not \' + \'be null or undefined\');\n\n  if (superCtor.prototype === undefined)\n    throw new TypeError(\'The super constructor to &quot;inherits&quot; must \' + \'have a prototype\');\n\n  ctor.super_ = superCtor;\n  Object.setPrototypeOf(ctor.prototype, superCtor.prototype);\n};`, `37677922384162365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/**\n * Inherit the prototype methods from one constructor into another.\n *\n * The Function.prototype.inherits from lang.js rewritten as a standalone\n * function (not on Function.prototype). NOTE: If this file is to be loaded\n * during bootstrapping this function needs to be rewritten using some native\n * functions as prototype setup using normal JavaScript does not work as\n * expected during bootstrapping (see mirror.js in r114903).\n *\n * @param {function} ctor Constructor function which needs to inherit the\n *     prototype.\n * @param {function} superCtor Constructor function to inherit prototype from.\n * @throws {TypeError} Will error if either constructor is null, or if\n *     the super constructor lacks a prototype.\n */</span>\nexports<span class="token punctuation">.</span><span class="token function-variable function">inherits</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctor<span class="token punctuation">,</span> superCtor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctor <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> ctor <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The constructor to "inherits" must not be \'</span> <span class="token operator">+</span> <span class="token string">\'null or undefined\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> superCtor <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The super constructor to "inherits" must not \'</span> <span class="token operator">+</span> <span class="token string">\'be null or undefined\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor<span class="token punctuation">.</span>prototype <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The super constructor to "inherits" must \'</span> <span class="token operator">+</span> <span class="token string">\'have a prototype\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  ctor<span class="token punctuation">.</span>super_ <span class="token operator">=</span> superCtor<span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>ctor<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> superCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="正则表达式"><a href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正则表达式</h2>\n<p>正则表达式最早生物学上用来描述大脑神经元的一种表达式, 被 GNU 的大胡子拿来做字符串匹配之后在原本的道路上渐行渐远.</p>\n<p>整理中..</p>\n<h2 id="常用模块"><a href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用模块</h2>\n<p><a href="https://github.com/sindresorhus/awesome-nodejs" target="_blank" rel="nofollow noreferrer noopener">Awesome Node.js</a> <a href="https://www.npmjs.com/browse/depended" target="_blank" rel="nofollow noreferrer noopener">Most depended-upon packages</a></p>\n<blockquote>\n<p><a name="q-traversal"></a> 如何获取某个文件夹下所有的文件名?</p>\n</blockquote>\n<p>一个简单的例子:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75592622128819680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\n\nfunction traversal(dir) {\n  let res = [];\n  for (let item of fs.readdirSync(dir)) {\n    let filepath = path.join(dir, item);\n    try {\n      let fd = fs.openSync(filepath, \'r\');\n      let flag = fs.fstatSync(fd).isDirectory();\n      fs.close(fd);\n      if (flag) {\n        res.push(...traversal(filepath));\n      } else {\n        res.push(filepath);\n      }\n    } catch (err) {\n      if (\n        err.code === \'ENOENT\' && // link 文件打不开\n        !!fs.readlinkSync(filepath)\n      ) {\n        // 判断是否 link 文件\n        res.push(filepath);\n      } else {\n        console.error(\'err\', err);\n      }\n    }\n  }\n  return res.map((file) => path.basename(file));\n}\n\nconsole.log(traversal(\'.\'));`, `75592622128819680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">traversal</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> filepath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> fd <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> flag <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">fstatSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">traversal</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>\n        err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'ENOENT\'</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// link 文件打不开</span>\n        <span class="token operator">!</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">readlinkSync</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 判断是否 link 文件</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'err\'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">traversal</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然也可以 Oh my <a href="https://github.com/isaacs/node-glob" target="_blank" rel="nofollow noreferrer noopener">glob</a>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15062966516081211000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const glob = require(\'glob\');\n\nglob(\'**/*.js\', (err, files) => {\n  if (err) {\n    throw new Error(err);\n  }\n  files.map((filename) => {\n    console.log(\'Here you are:\', filename);\n  });\n});`, `15062966516081211000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="javascript"\n              >\n                <span class="gatsby-code-button-language">javascript</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">\'**/*.js\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here you are:\'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="存储"><a href="#%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储</h1>\n<h2 id="简介"><a href="#%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h2>\n<p>科班的同学可以了解一下<a href="http://www.cnblogs.com/CareySon/archive/2010/02/16/1668803.html" target="_blank" rel="nofollow noreferrer noopener">数据库范式</a>, 在 ElemeFe 面试不会问, 但是其他地方可能会问 (比如阿里).</p>\n<h2 id="mysql"><a href="#mysql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mysql</h2>\n<p>SQL (Structured Query Language) 是<a href="https://en.wikipedia.org/wiki/Relational_database" target="_blank" rel="nofollow noreferrer noopener">关系式数据库管理系统</a>的标准语言, 关于关系型数据库这里主要带大家看一下 Mysql 的几个问题</p>\n<h3 id="存储引擎"><a href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储引擎</h3>\n<table>\n<thead>\n<tr>\n<th>attr</th>\n<th>MyISAM</th>\n<th>InnoDB</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Locking</td>\n<td>Table-level</td>\n<td>Row-level</td>\n</tr>\n<tr>\n<td>designed for</td>\n<td>need of speed</td>\n<td>high volume of data</td>\n</tr>\n<tr>\n<td>foreign keys</td>\n<td>× (DBMS)</td>\n<td>✓ (RDBMS)</td>\n</tr>\n<tr>\n<td>transaction</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>fulltext search</td>\n<td>✓</td>\n<td>×</td>\n</tr>\n<tr>\n<td>scene</td>\n<td>lots of select</td>\n<td>lots of insert/update</td>\n</tr>\n<tr>\n<td>count rows</td>\n<td>fast</td>\n<td>slow</td>\n</tr>\n<tr>\n<td>auto_increment</td>\n<td>fast</td>\n<td>slow</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>你的数据库有外键吗？</li>\n<li>你需要事务支持吗？</li>\n<li>你需要全文索引吗？</li>\n<li>你经常使用什么样的查询模式？</li>\n<li>你的数据有多大？</li>\n</ul>\n<p>参见 <a href="http://coolshell.cn/articles/652.html" target="_blank" rel="nofollow noreferrer noopener">MYSQL: INNODB 还是 MYISAM?</a></p>\n<h3 id="索引"><a href="#%E7%B4%A2%E5%BC%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>索引</h3>\n<p>索引是用空间换时间的一种优化策略. 推荐阅读: <a href="http://www.cnblogs.com/cq-home/p/3482101.html" target="_blank" rel="nofollow noreferrer noopener">mysql 索引类型</a> 以及 <a href="http://blog.mimvp.com/2015/03/the-difference-between-primary-key-and-unique-index/" target="_blank" rel="nofollow noreferrer noopener">主键与唯一索引的区别</a></p>\n<h2 id="mongodb"><a href="#mongodb" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mongodb</h2>\n<blockquote>\n<p>Monogdb 连接问题(超时/断开等)有可能是什么问题导致的?</p>\n</blockquote>\n<ul>\n<li>网络问题</li>\n<li>任务跑不完, 超过了 driver 的默认链接超时时间 (如 30s)</li>\n<li>Monogdb 宕机了</li>\n<li>超过了连接空闲时间 (connection idle time) 被断开</li>\n<li>fd 不够用 (ulimit 设置)</li>\n<li>mongodb 最大连接数不够用 (可能是连接未复用导致)</li>\n<li>etc…</li>\n</ul>\n<h3 id="other"><a href="#other" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>other</h3>\n<p>populate</p>\n<p>aggregate</p>\n<p>pipeline</p>\n<p>Cursor</p>\n<p>整理中</p>\n<h2 id="replication"><a href="#replication" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replication</h2>\n<blockquote>\n<p>备份数据库与 M/S, M/M 等部署方式的区别?</p>\n</blockquote>\n<p>关于数据库基于各种模式的特点全部可以通过以下图片分清:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-e4a38.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.08580343213728%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACTUlEQVQoz22RS08TYRiF+8uMG7wsBEGghEtDwIAYEAKWQDQqNF4wrNwpCeEmEQIWCWJAFyUEAwkrsIJJW7C3mc6lM53epoXO47S69Eu+nMX75sl7znHwnyeJIolYHEPTsKwSiiqRzRmVmaZJGIbO5WWReDxKySoiyQJqUqnsOrK5LKqq2otaRYulS4ypZYJdIwh9r+HgBeR7SYUH0aNDSJEHkB7gXHvCRuQhm0E33pNB1s97+GV4cRhpowIzDFuTSfIXRSzPDPrVbsyqUcIb99nXa9gN1nIYayQjNoBcw4nexrzRwFysltmYrdp1DnNvceRyOSRJ+nelDSzYFrxv8XvaOXvZj++gm+mIk7lAE+uyi9N4C8fRBn7+uMf+Rhc+bzu+lbvsfWwmdLSAo5xLOp2uAE3TrOS0l5lkSa9nNeXCK7eyetaGN+biU8JWwcVStgX/0jDUjKE43SidbmgbwFpcsy/M5+zQFfvKBAn727nyPTnBslCNV2xiRWhkxl/P+2Aja7KT1ZiTxdQdjj70k7oxhNE+iHzciRC4RlqewmGa+QqsbFdRZErlJhemCbl7iI6OoBz0oeaaiIutBMPNaGoLZsa2F+7lmx3H1m4nW8EOtsQ6TlMzOC6KxQrIMFKk7WIsG1h4NoV0pYN01TDmeheF7E0KiVuokVqO5Tr8cjXb0XrmxNvM/q5mPlTHvFDFoW6XYlkWuq6j6X+bLgPNpS+IjybRx96R2nuDKD5FF8bQlAl2kq/Ylj18DoyzHRrn67kHn/CcHfUxgcwmfwDV5lLdLKlL+gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 03 23 13 51 02" title="" data-src="/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-fee1c.png" data-srcset="/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-a67b7.png 200w,\n/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-0b187.png 400w,\n/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-fee1c.png 800w,\n/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-b1a91.png 1200w,\n/static/2021-03-23-13-51-02-5aca2bfe605b0cd57e4de6df284ef4f0-e4a38.png 1282w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>图片出处：Google App Engine 的 co-founder Ryan Barrett 在 2009 年的 google i/o 上的演讲 <a href="http://snarfed.org/transactions_across_datacenters_io.html" target="_blank" rel="nofollow noreferrer noopener">《Transaction Across DataCenter》</a>（视频： <a href="http://www.youtube.com/watch?v=srOgpXECblk%EF%BC%89" target="_blank" rel="nofollow noreferrer noopener">http://www.youtube.com/watch?v=srOgpXECblk）</a></p>\n<p>根据上图, 我们可以知道 Master/Slave 与 Master/Master 的关系.</p>\n<table>\n  <tr><th>attr</th><th>Master/Slave</th><th>Master/Master</th></tr>\n  <tr><td>一致性</td><td colspan="2">Eventually：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如：DNS，电子邮件、Amazon S3，Google搜索引擎这样的系统。</td></tr>\n  <tr><td>事务</td><td align="center">完整</td><td align="center">本地</td></tr>\n  <tr><td>延迟</td><td colspan="2" align="center">低延迟</td></tr>\n  <tr><td>吞吐</td><td colspan="2" align="center">高吞吐</td></tr>\n  <tr><td>数据丢失</td><td colspan="2" align="center">部分丢失</td></tr>\n  <tr><td>熔断</td><td align="center">只读</td><td align="center">读/写</td></tr>\n</table>\n<h3 id="读写分离"><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读写分离</h3>\n<p>读写分离是在 query 量大的情况下减轻单个 DB 节点压力, 优化数据库读/写速度的一种策略. 不论是 MySQL 还是 MongoDB 都可以进行读写分离.</p>\n<p>读写分离的配置方式直接搜索一下 <code class="language-text">数据库名 + 读写分离</code> 即可找到. 通常是 M/S 的情况, 使用 Master 专门写, 用 Slave 节点专门读. 使用读写分离时, 请确认读的请求对一致性要求不高, 因为从写库同步读库是有延迟的.</p>\n<h2 id="数据一致性"><a href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据一致性</h2>\n<p>关于数据一致性推荐看陈皓的<a href="http://www.infoq.com/cn/articles/distributed-system-transaction-processing" target="_blank" rel="nofollow noreferrer noopener">分布式系统的事务处理</a></p>\n<blockquote>\n<p>什么情况下数据会出现脏数据? 如何避免?</p>\n</blockquote>\n<ul>\n<li>从 A 帐号中把余额读出来</li>\n<li>对 A 帐号做减法操作</li>\n<li>把结果写回 A 帐号中</li>\n<li>从 B 帐号中把余额读出来</li>\n<li>对 B 帐号做加法操作</li>\n<li>把结果写回 B 帐号中</li>\n</ul>\n<p>为了数据的一致性, 这 6 件事, 要么都成功做完, 要么都不成功, 而且这个操作的过程中, 对 A、B 帐号的其它访问必需锁死, 所谓锁死就是要排除其它的读写操作, 否则就会出现脏数据 ---- 即数据一致性的问题.</p>\n<p>这个问题并不仅仅出现在数据库操作中, 普通的并发以及并行操作都可能导致出现脏数据. 避免出现脏数据通常是从架构上避免或者采用事务的思想处理.</p>\n<h3 id="矛盾"><a href="#%E7%9F%9B%E7%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矛盾</h3>\n<ul>\n<li>1）要想让数据有高可用性，就得写多份数据</li>\n<li>2）写多份的问题会导致数据一致性的问题</li>\n<li>3）数据一致性的问题又会引发性能问题</li>\n</ul>\n<p>强一致性必然导致性能短板, 而弱一致性则有很好的性能但是存在数据安全(灾备数据丢失)/一致性(脏读/脏写等)的问题.</p>\n<p>目前 Node.js 业内流行的主要是与 Mongodb 配合, 在数据一致性方面属于短板.</p>\n<h3 id="事务"><a href="#%E4%BA%8B%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事务</h3>\n<p>事务并不仅仅是 sql 数据库中的一个功能, 也是分布式系统开发中的一个思想, 事务在分布式的问题中可以称为 “两阶段提交” (以下引用陈皓原文)</p>\n<p>第一阶段：</p>\n<ul>\n<li>协调者会问所有的参与者结点，是否可以执行提交操作。</li>\n<li>各个参与者开始事务执行的准备工作：如：为资源上锁，预留资源，写 undo/redo log……</li>\n<li>参与者响应协调者，如果事务的准备工作成功，则回应“可以提交”，否则回应“拒绝提交”。</li>\n</ul>\n<p>第二阶段：</p>\n<ul>\n<li>如果所有的参与者都回应“可以提交”，那么，协调者向所有的参与者发送“正式提交”的命令。参与者完成正式提交，并释放所有资源，然后回应“完成”，协调者收集各结点的“完成”回应后结束这个 Global Transaction。</li>\n<li>如果有一个参与者回应“拒绝提交”，那么，协调者向所有的参与者发送“回滚操作”，并释放所有资源，然后回应“回滚完成”，协调者收集各结点的“回滚”回应后，取消这个 Global Transaction。</li>\n</ul>\n<p>异常:</p>\n<ul>\n<li>如果第一阶段中，参与者没有收到询问请求，或是参与者的回应没有到达协调者。那么，需要协调者做超时处理，一旦超时，可以当作失败，也可以重试。</li>\n<li>如果第二阶段中，正式提交发出后，如果有的参与者没有收到，或是参与者提交/回滚后的确认信息没有返回，一旦参与者的回应超时，要么重试，要么把那个参与者标记为问题结点剔除整个集群，这样可以保证服务结点都是数据一致性的。</li>\n<li>第二阶段中，如果参与者收不到协调者的 commit/fallback 指令，参与者将处于“状态未知”阶段，参与者完全不知道要怎么办。</li>\n</ul>\n<h2 id="缓存"><a href="#%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h2>\n<blockquote>\n<p>redis 与 memcached 的区别?</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>attr</th>\n<th>memcached</th>\n<th>redis</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>struct</td>\n<td>key/value</td>\n<td>key/value + list, set, hash etc.</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>Persistence</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>transcations</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>consistency</td>\n<td>strong (by cas)</td>\n<td>weak</td>\n</tr>\n<tr>\n<td>thread</td>\n<td>multi</td>\n<td>single</td>\n</tr>\n<tr>\n<td>memory</td>\n<td>physical</td>\n<td>physical &#x26; swap</td>\n</tr>\n</tbody>\n</table>\n<h2 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h2>\n<ul>\n<li>zookeeper</li>\n<li>kafka</li>\n<li>storm</li>\n<li>hadoop</li>\n<li>spark</li>\n</ul>\n<h1 id="安全"><a href="#%E5%AE%89%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安全</h1>\n<h2 id="crypto"><a href="#crypto" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Crypto</h2>\n<p>Node.js 的 <code class="language-text">crypto</code> 模块封装了诸多的加密功能, 包括 OpenSSL 的哈希、HMAC、加密、解密、签名和验证函数等.</p>\n<p>Node.js 的加密貌似有点问题, 某些算法算出来跟别的语言 (比如 Python) 不一样. 具体情况还在整理中 (时间不定), 欢迎补充.</p>\n<blockquote>\n<p>加密是如何保证用户密码的安全性?</p>\n</blockquote>\n<p>在客户端加密, 是增加传输的过程中被第三方嗅探到密码后破解的成本. 对于游戏, 在客户端加密是防止外挂/破解等. 在服务端加密 (如 md5) 是避免管理数据库的 DBA 或者攻击者攻击数据库之后直接拿到明文密码, 从而提高安全性.</p>\n<h2 id="tlsssl"><a href="#tlsssl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TLS/SSL</h2>\n<p>早期的网络传输协议由于只在大学内使用, 所以是默认互相信任的. 所以传统的网络通信可以说是没有考虑网络安全的. 早年的浏览器大厂网景公司为了应对这个情况设计了 SSL (Secure Socket Layer), SSL 的主要用途是:</p>\n<ol>\n<li>认证用户和服务器, 确保数据发送到正确的客户机和服务器;</li>\n<li>加密数据以防止数据中途被窃取;</li>\n<li>维护数据的完整性, 确保数据在传输过程中不被改变.</li>\n</ol>\n<p>存在三个特性:</p>\n<ul>\n<li>机密性：SSL 协议使用密钥加密通信数据</li>\n<li>可靠性：服务器和客户都会被认证, 客户的认证是可选的</li>\n<li>完整性：SSL 协议会对传送的数据进行完整性检查</li>\n</ul>\n<p>1999 年, SSL 因为应用广泛, 已经成为互联网上的事实标准. IETF 就在那年把 SSL 标准化/强化. 标准化之后的名称改为传输层安全协议 (Transport Layer Security, TLS). 很多相关的文章都把这两者并列称呼 (TLS/SSL), 因为这两者可以视作同一个东西的不同阶段.</p>\n<h2 id="https"><a href="#https" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTPS</h2>\n<p>在网络上, 每个网站都在各自的服务器上, 想要确保你访问的是一个正确的网站, 并且访问到这个网站正确的数据 (没有被劫持/篡改), 除了需要传输安全之外, 还需要安全的认证, 认证不能由目标网站进行, 否则恶意/钓鱼网站也可以自己说自己是对的, 所以为了能在网络上维护网络之间的基本信任, 早期的大厂们合力推动了一项名为 PKI 的基础设施, 通过第三方来认证网站.</p>\n<p>公钥基础设施 (Public Key Infrastructure, PKI) 是一种遵循标准的, 利用公钥加密技术为电子商务的开展提供一套安全基础平台的技术和规范. 其基础建置包含认证中心 (Certification Authority, CA) 、注册中心 (Register Authority, RA) 、目录服务 (Directory Service, DS) 服务器.</p>\n<p>由 RA 统筹、审核用户的证书申请, 将证书申请送至 CA 处理后发出证书, 并将证书公告至 DS 中. 在使用证书的过程中, 除了对证书的信任关系与证书本身的正确性做检查外, 并透过产生和发布证书废止列表 (Certificate Revocation List, CRL) 对证书的状态做确认检查, 了解证书是否因某种原因而遭废弃. 证书就像是个人的身分证, 其内容包括证书序号、用户名称、公开金钥 (Public Key) 、证书有效期限等.</p>\n<p>在 TLS/SSL 中你可以使用 OpenSSL 来生成 TLS/SSL 传输时用来认证的 public/private key. 不过这个 public/private key 是自己生成的, 而通过 PKI 基础设施可以获得权威的第三方证书 (key) 从而加密 HTTP 传输安全. 目前博客圈子里比较流行的是 <a href="https://imququ.com/post/letsencrypt-certificate.html" target="_blank" rel="nofollow noreferrer noopener">Let’s Encrypt 签发免费的 HTTPS 证书</a>.</p>\n<p>需要注意的是, 如果 PKI 受到攻击, 那么 HTTPS 也一样不安全. 可以参见 <a href="https://www.zhihu.com/question/22795329" target="_blank" rel="nofollow noreferrer noopener">HTTPS 劫持 - 知乎讨论</a> 中的情况, 证书由 CA 机构签发, 一般浏览器遇到非权威的 CA 机构是会告警的 (参见 <a href="https://kyfw.12306.cn/otn/" target="_blank" rel="nofollow noreferrer noopener">12306</a>), 但是如果你在某些特殊的情况下信任了某个未知机构/证书, 那么也可能被劫持.</p>\n<p>此外有的 CA 机构以邮件方式认证, 那么当某个网站的邮件服务收到攻击/渗透, 那么攻击者也可能以此从 CA 机构获取权威的正确的证书.</p>\n<h2 id="xss"><a href="#xss" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>XSS</h2>\n<p>跨站脚本 (Cross-Site Scripting, XSS) 是一种代码注入方式, 为了与 CSS 区分所以被称作 XSS. 早期常见于网络论坛, 起因是网站没有对用户的输入进行严格的限制, 使得攻击者可以将脚本上传到帖子让其他人浏览到有恶意脚本的页面, 其注入方式很简单包括但不限于 JavaScript / VBScript / CSS / Flash 等.</p>\n<p>当其他用户浏览到这些网页时, 就会执行这些恶意脚本, 对用户进行 Cookie 窃取/会话劫持/钓鱼欺骗等各种攻击. 其原理, 如使用 js 脚本收集当前用户环境的信息 (Cookie 等), 然后通过 img.src, Ajax, onclick/onload/onerror 事件等方式将用户数据传递到攻击者的服务器上. 钓鱼欺骗则常见于使用脚本进行视觉欺骗, 构建假的恶意的 Button 覆盖/替换真实的场景等情况 (该情况在用户上传 CSS 的时候也可能出现, 如早期淘宝网店装修, 使用 CSS 拼接假的评分数据等覆盖在真的评分数据上误导用户).</p>\n<blockquote>\n<p>过滤 Html 标签能否防止 XSS? 请列举不能的情况?</p>\n</blockquote>\n<p>用户除了上传</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69499090692327240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script>\n  alert(\'xss\');\n</script>`, `69499090692327240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">\'xss\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>还可以使用图片 url 等方式来上传脚本进行攻击</p>\n<html><head></head><body><div class="gatsby-code-button-container" data-toaster-id="97457580919649340000" data-toaster-class="gatsby-code-button-toaster" data-toaster-text-class="gatsby-code-button-toaster-text" data-toaster-text="复制成功" data-toaster-duration="3500" onclick="copyToClipboard(`<table background=&quot;javascript:alert(/xss/)&quot;></table>\n<img data-src=&quot;javascript:alert(\'xss\')&quot; />`, `97457580919649340000`)">\n              <div class="gatsby-code-button" title="html">\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div></body></html>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:alert(/xss/)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:alert(\'xss\')<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>还可以使用各种方式来回避检查, 例如空格, 回车, Tab</p>\n<html><head></head><body><div class="gatsby-code-button-container" data-toaster-id="73202877761422400000" data-toaster-class="gatsby-code-button-toaster" data-toaster-text-class="gatsby-code-button-toaster-text" data-toaster-text="复制成功" data-toaster-duration="3500" onclick="copyToClipboard(`<img\n  data-src=&quot;javas cript:\nalert(\'xss\')&quot;\n/>`, `73202877761422400000`)">\n              <div class="gatsby-code-button" title="html">\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div></body></html>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>\n  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javas cript:\nalert(\'xss\')<span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以通过各种编码转换 (URL 编码, Unicode 编码, HTML 编码, ESCAPE 等) 来绕过检查</p>\n<html><head></head><body><div class="gatsby-code-button-container" data-toaster-id="16453064657461703000" data-toaster-class="gatsby-code-button-toaster" data-toaster-text-class="gatsby-code-button-toaster-text" data-toaster-text="复制成功" data-toaster-duration="3500" onclick="copyToClipboard(`<img%20data-src=%22javascript:alert(\'xss\');%22>\n<img src=&quot;javascript:alert(/xss/)&quot;>`, `16453064657461703000`)">\n              <div class="gatsby-code-button" title="">\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div></body></html>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&lt;img%20src=%22javascript:alert(&#39;xss&#39;);%22&gt;\n&lt;img src=&quot;javascrip&amp;#116&amp;#58alert(/xss/)&quot;&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="csp-策略"><a href="#csp-%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CSP 策略</h3>\n<p>在百般无奈, 没有统一解决方案的情况下, 厂商们推出了 CSP 策略.</p>\n<p>以 Node.js 为例, 计算脚本的 hashes 值:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11357726972424675000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const crypto = require(\'crypto\');\n\nfunction getHashByCode(code, algorithm = \'sha256\') {\n  return (\n    algorithm +\n    \'-\' +\n    crypto\n      .createHash(algorithm)\n      .update(code, \'utf8\')\n      .digest(\'base64\')\n  );\n}\n\ngetHashByCode(\'console.log(&quot;hello world&quot;);\'); // \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'`, `11357726972424675000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'crypto\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getHashByCode</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> algorithm <span class="token operator">=</span> <span class="token string">\'sha256\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    algorithm <span class="token operator">+</span>\n    <span class="token string">\'-\'</span> <span class="token operator">+</span>\n    crypto\n      <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">\'base64\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getHashByCode</span><span class="token punctuation">(</span><span class="token string">\'console.log("hello world");\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>设置 CSP 头:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13827455887834583000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`content-security-policy: script-src \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'`, `13827455887834583000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">content-security-policy: script-src &#39;sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99953281872428530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script>\n  console.log(\'hello geemo\');\n</script>\n<!-- 不执行 -->\n<script>\n  console.log(\'hello world\');\n</script>\n<!-- 执行 -->`, `99953281872428530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello geemo\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token comment">&lt;!-- 不执行 --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token comment">&lt;!-- 执行 --></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>策略指令可以参见 <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives" target="_blank" rel="nofollow noreferrer noopener">CSP Policy Directives</a>以及<a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="nofollow noreferrer noopener">阮一峰的博文</a>, <a href="https://imququ.com/post/content-security-policy-reference.html" target="_blank" rel="nofollow noreferrer noopener">屈大神的博文</a></p>\n<h2 id="csrf"><a href="#csrf" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CSRF</h2>\n<p>跨站请求伪造 <code class="language-text">(Cross-Site Request Forgery, CSRF, https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet)</code> 是一种伪造跨站请求的攻击方式. 例如利用你在 A 站 (攻击目标) 的 cookie / 权限等, 在 B 站 (恶意/钓鱼网站) 拼装 A 站的请求.</p>\n<p>比如 Q 君是某论坛管理员. 已知这个论坛 A 删除的接口是 post 到某个地址, 并指定一个帖子的 id. 那么我可以在自己的博客 B 上组织一个 CSRF 请求. 然后诱使 Q 君来访问我的博客. 就可以在 Q 君不知情的情况下删除掉我想删的某个帖子.</p>\n<p>钓鱼方式包括但不限于公开网站 (xss), 攻击者的恶意网站, email 邮件, 微博, 微信, 短信等及时消息.</p>\n<p>同源策略是最早用于防止 CSRF 的一种方式, 即关于跨站请求 (Cross-Site Request) 只有在同源/信任的情况下才可以请求. 但是如果一个网站群, 在互相信任的情况下, 某个网站出现了问题:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69522633035931290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a.public.com\nb.public.com\nc.public.com\n...`, `69522633035931290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">a.public.com\nb.public.com\nc.public.com\n...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上情况下, 如果 c.public.com 上没有预防 xss 等情况, 使得攻击者可以基于此站对其他信任的网站发起 CSRF 攻击.</p>\n<p>另外同源策略主要是浏览器来进行验证的, 并且不同浏览器的实现又各自不同, 所以在某些浏览器上可以直接绕过, 而且也可以直接通过短信等方式直接绕过浏览器.</p>\n<p>预防:</p>\n<ol>\n<li>A 站 (预防站) 检查 http 请求的 header 确认其 origin</li>\n<li>检查 CSRF token</li>\n</ol>\n<h3 id="1同源检查"><a href="#1%E5%90%8C%E6%BA%90%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.同源检查</h3>\n<p>通过检查来过滤简单的 CSRF 攻击, 主要检查一下两个 header:</p>\n<ul>\n<li>Origin Header</li>\n<li>Referer Header</li>\n</ul>\n<h3 id="2csrf-token"><a href="#2csrf-token" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.CSRF token</h3>\n<p>简单来说, 对需要预防的请求, 通过特别的算法生成 token 存在 session 中, 然后将 token 隐藏在正确的界面表单中, 正式请求时带上该 token 在服务端验证, 避免跨站请求.</p>\n<h2 id="中间人攻击"><a href="#%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>中间人攻击</h2>\n<p>中间人 (Man-in-the-middle attack, MITM) 是指攻击者与通讯的两端分别创建独立的联系, 并交换其所收到的数据, 使通讯的两端认为他们正在通过一个私密的连接与对方直接对话, 但事实上整个会话都被攻击者完全控制. 在中间人攻击中, 攻击者可以拦截通讯双方的通话并插入新的内容.</p>\n<p>目前比较常见的是在公共场所放置精心准备的免费 wifi, 劫持/监控通过该 wifi 的流量. 或者攻击路由器, 连上你家 wifi 攻破你家 wifi 之后在上面劫持流量等.</p>\n<p>对于通信过程中的 MITM, 常见的方案是通过 PKI / TLS 预防, 及时是通过存在第三方中间人的 wifi 你通过 HTTPS 访问的页面依旧是安全的. 而 HTTP 协议是明文传输, 则没有任何防护可言.</p>\n<p>不常见的还有强力的互相认证, 你确认他之后, 他也确认你一下; 延迟测试, 统计传输时间, 如果通讯延迟过高则认为可能存在第三方中间人; 等等.</p>\n<h2 id="sqlnosql-注入"><a href="#sqlnosql-%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL/NoSQL 注入</h2>\n<p>注入攻击是指当所执行的一些操作中有部分由用户传入时, 用户可以将其恶意逻辑注入到操作中. 当你使用 eval, new Function 等方式执行的字符串中有用户输入的部分时, 就可能被注入攻击. 上文中的 XSS 就属于一种注入攻击. 前面的章节中也提到过 Node.js 的 child_process.exec 由于调用 bash 解析, 如果执行的命令中有部分属于用户输入, 也可能被注入攻击.</p>\n<h3 id="sql"><a href="#sql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL</h3>\n<p>Sql 注入是网站常见的一种注入攻击方式. 其原因主要是由于登录时需要验证用户名/密码, 其执行 sql 类似:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81592273461879360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SELECT * FROM users WHERE usernae = \'myName\' AND password = \'mySecret\';`, `81592273461879360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="sql"\n              >\n                <span class="gatsby-code-button-language">sql</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> usernae <span class="token operator">=</span> <span class="token string">\'myName\'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token string">\'mySecret\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其中的用户名和密码属于用户输入的部分, 那么在未做检查的情况下, 用户可能拼接恶意的字符串来达到其某种目的, 例如上传密码为 <code class="language-text">&#39;; DROP TABLE users; --</code> 使得最终执行的内容为:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54113774573764780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SELECT * FROM users WHERE usernae = \'myName\' AND password = \'\'; DROP TABLE users; --\';`, `54113774573764780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="sql"\n              >\n                <span class="gatsby-code-button-language">sql</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> usernae <span class="token operator">=</span> <span class="token string">\'myName\'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> users<span class="token punctuation">;</span> <span class="token comment">--\';</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其能实现的功能, 包括但不限于删除数据 (经济损失), 篡改数据 (密码等), 窃取数据 (网站管理权限, 用户数据) 等. 防治手段常见于:</p>\n<ul>\n<li>给表名/字段名加前缀 (避免被猜到)</li>\n<li>报错隐藏表信息 (避免被看到, 12306 早期就出现过的问题)</li>\n<li>过滤可以拼接 SQL 的关键字符</li>\n<li>对用户输入进行转义</li>\n<li>验证用户输入的类型 (避免 limit, order by 等注入)</li>\n</ul>\n<h3 id="nosql"><a href="#nosql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NoSQL</h3>\n<p>看个简单的情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23958866352011854000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let { user, pass, age } = ctx.query;\n\ndb.collection.find({\n  user,\n  pass,\n  \\$where: \\`this.age >= \\${age}\\`\n});`, `23958866352011854000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> pass<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>\n\ndb<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  user<span class="token punctuation">,</span>\n  pass<span class="token punctuation">,</span>\n  $where<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this.age >= </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么这里的 age 就可以注入了. 另外 GET/POST 还可以传递深层结构 (比如 <code class="language-text">?name[0]=alan</code> 传递上来), 通过 qs 之类的模块解析后导致注入, 如 <a href="https://github.com/cnodejs/nodeclub/commit/0f6cc14f6bcbbe6b4de3199c6896efaec637693e" target="_blank" rel="nofollow noreferrer noopener">cnodejs 遭遇 mongodb 注入</a>.</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Node.js面试入门/index.md absPath of file >>> MarkdownRemark",timeToRead:78,frontmatter:{date:"2021-02-26 18:27:10",path:"/nodejs-interview-introduce-learn/",tags:"后端, nodejs, 读书笔记",title:"Node.js面试入门",draft:null}},{excerpt:"前置知识 需求背景 已知始发站、终点站，如何查出满足条件的方案线路？即根据一个表关联多个表时如何查询相关字段？ sql 语句 根据以上的前置知识可得出一对多下的查询应该这样写： Sequelize 下的解决方案 从表的设计上考虑：将始发站、终点站写在主表中，无需考虑一对多的问题 根据以上的 sql 语句利用 Sequelize 去关联 最终为了实现上的简便，直接使用方案 1 // TODO 多对多方案也需要延伸下",html:'<h1 id="前置知识"><a href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前置知识</h1>\n<p><div class="gatsby-highlight">\n        <pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span>  <span class="token keyword">if</span> <span class="token keyword">exists</span> Student_Course_Database <span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">database</span> Student_Course_Database<span class="token punctuation">;</span>\r\n<span class="token keyword">alter</span> <span class="token keyword">database</span> Student_Course_Database <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>\r\n<span class="token keyword">use</span> Student_Course_Database<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> student\r\n<span class="token punctuation">(</span>sno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>\r\n sname <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unique</span><span class="token punctuation">,</span>\r\n ssex <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n sage <span class="token keyword">smallint</span><span class="token punctuation">,</span>\r\n sdept <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> course\r\n<span class="token punctuation">(</span>cno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>\r\n cname <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n cpno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n ccredit <span class="token keyword">smallint</span><span class="token punctuation">,</span>\r\n <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cpno<span class="token punctuation">)</span> <span class="token keyword">references</span> course<span class="token punctuation">(</span>cno<span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> sc\r\n<span class="token punctuation">(</span>sno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\ncno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\ngrade <span class="token keyword">smallint</span> <span class="token punctuation">,</span>\r\n<span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n<span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">references</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n<span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cno<span class="token punctuation">)</span> <span class="token keyword">references</span> course<span class="token punctuation">(</span>cno<span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'李勇\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'刘晨\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'王敏\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215125\'</span><span class="token punctuation">,</span><span class="token string">\'张立\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215124\'</span><span class="token punctuation">,</span><span class="token string">\'刘武汉\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token string">\'PE\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215126\'</span><span class="token punctuation">,</span><span class="token string">\'李四\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215128\'</span><span class="token punctuation">,</span><span class="token string">\'欧阳雨\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215127\'</span><span class="token punctuation">,</span><span class="token string">\'欧阳杰\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">\'PY\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course<span class="token punctuation">(</span>Cno<span class="token punctuation">,</span>Cname<span class="token punctuation">,</span>Ccredit<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token string">\'数据处理\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course<span class="token punctuation">(</span>Cno<span class="token punctuation">,</span>Cname<span class="token punctuation">,</span>Ccredit<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token string">\'数学\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'8\'</span><span class="token punctuation">,</span><span class="token string">\'数字系统设计\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'7\'</span><span class="token punctuation">,</span><span class="token string">\'PASCAL语言\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token string">\'数据结构\'</span><span class="token punctuation">,</span><span class="token string">\'7\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token string">\'操作系统\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token string">\'数据库\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token string">\'信息系统\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'9\'</span><span class="token punctuation">,</span><span class="token string">\'DB_Design\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">92</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">85</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215127\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment">#1</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#2</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#3</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#4</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#5</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span><span class="token string">\'Year of Birth:\'</span><span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>sdept<span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname NAME<span class="token punctuation">,</span><span class="token string">\'Year of Birth:\'</span> BIRTH<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage BIRTHDAY<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>sdept<span class="token punctuation">)</span> DEPARTMENT <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#6</span>\r\n<span class="token keyword">select</span> <span class="token keyword">all</span> sno <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#7</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#8</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token comment">#9</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>\r\n<span class="token comment">#10</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage <span class="token operator">between</span> <span class="token number">20</span> <span class="token operator">and</span> <span class="token number">23</span><span class="token punctuation">;</span>\r\n<span class="token comment">#11</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage <span class="token operator">not</span> <span class="token operator">between</span> <span class="token number">20</span> <span class="token operator">and</span> <span class="token number">23</span><span class="token punctuation">;</span>\r\n<span class="token comment">#12</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">\'CS\'</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#13</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">\'CS\'</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#14</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">like</span> <span class="token string">\'200215121\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#15</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>ssex <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'刘%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#16</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'欧阳_\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#17</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'_阳%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#18</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>ssex <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">\'刘%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#19</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span>ccredit <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">like</span> <span class="token string">\'DB@_Design\'</span> <span class="token keyword">escape</span> <span class="token string">\'@\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span>ccredit <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">=</span> <span class="token string">\'DB_Design\'</span> <span class="token punctuation">;</span>\r\n<span class="token comment">#20</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">like</span> <span class="token string">\'DB@_%i__\'</span><span class="token keyword">escape</span> <span class="token string">\'@\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#21</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n#<span class="token number">22</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n#<span class="token number">23</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">or</span> sdept<span class="token operator">=</span><span class="token string">\'MA\'</span> <span class="token operator">or</span> sdept<span class="token operator">=</span><span class="token string">\'IS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#24</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> grade <span class="token keyword">desc</span><span class="token punctuation">;</span>\r\n<span class="token comment">#25</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">order</span> <span class="token keyword">by</span> sdept<span class="token punctuation">,</span>sage <span class="token keyword">desc</span><span class="token punctuation">;</span>\r\n<span class="token comment">#26</span>\r\n<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#27</span>\r\n<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sno<span class="token punctuation">)</span> <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#28</span>\r\n<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'3\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#29</span>\r\n<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'3\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#30</span>\r\n<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>ccredit<span class="token punctuation">)</span> <span class="token keyword">from</span> sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token comment">#31</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> cno<span class="token punctuation">;</span>\r\n<span class="token comment">#32</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">3</span><span class="token punctuation">;</span>\r\n<span class="token comment">#33 在使用 join 时，on 和 where 条件的区别: on 条件是在生成临时表时使用的条件，它不管 on 中的条件是否为真，都会返回左边表中的记录。where 条件是在临时表生成好后，再对临时表进行过滤的条件。</span>\r\n<span class="token comment"># 同 join</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 在表中存在至少一个匹配时返回行，即求交集</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 同 join</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">inner</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 即使右表中没有匹配，也从左表返回所有的行</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 即使左表中没有匹配，也从右表返回所有的行</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 只要其中一个表中存在匹配，就返回行，mysql 不支持</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment">#34</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment">#35</span>\r\n<span class="token keyword">select</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cno<span class="token punctuation">,</span><span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token keyword">from</span> course <span class="token keyword">first</span><span class="token punctuation">,</span>course <span class="token keyword">second</span> <span class="token keyword">where</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cpno<span class="token operator">=</span><span class="token keyword">second</span><span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cno<span class="token punctuation">,</span><span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token keyword">from</span> course <span class="token keyword">first</span><span class="token punctuation">,</span>course <span class="token keyword">second</span> <span class="token keyword">where</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cpno<span class="token operator">=</span><span class="token keyword">second</span><span class="token punctuation">.</span>cno <span class="token operator">and</span> <span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n<span class="token comment">#36</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">using</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#37</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> grade<span class="token operator">></span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#38</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>cname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token comment">#39 和刘晨是相同专业的同学，一对多查询模板</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> s1<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>sname<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>sdept <span class="token keyword">from</span> student s1<span class="token punctuation">,</span>student s2 <span class="token keyword">where</span> s1<span class="token punctuation">.</span>sdept<span class="token operator">=</span>s2<span class="token punctuation">.</span>sdept <span class="token operator">and</span> s2<span class="token punctuation">.</span>sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student s1 <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s2 <span class="token keyword">where</span> s2<span class="token punctuation">.</span>sdept<span class="token operator">=</span>s1<span class="token punctuation">.</span>sdept <span class="token operator">and</span> s2<span class="token punctuation">.</span>sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#40 学信息系统课程的有谁</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> cno <span class="token keyword">from</span> course <span class="token keyword">where</span> cname<span class="token operator">=</span><span class="token string">\'信息系统\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno <span class="token operator">and</span> cname<span class="token operator">=</span><span class="token string">\'信息系统\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#41 每位同学成绩大于所选课程平均分的课程</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc x <span class="token keyword">where</span> grade<span class="token operator">>=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc y <span class="token keyword">where</span> y<span class="token punctuation">.</span>sno<span class="token operator">=</span>x<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sc<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> A_G <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno<span class="token punctuation">)</span> y <span class="token keyword">where</span> sc<span class="token punctuation">.</span>sno<span class="token operator">=</span>y<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>grade<span class="token operator">>=</span>y<span class="token punctuation">.</span>A_G<span class="token punctuation">;</span>\r\n<span class="token comment">#42 非 CS 专业下年龄小于 CS 的最大年龄的</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token punctuation">(</span><span class="token keyword">select</span> sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span> <span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#43 非 CS 专业下年龄小于 CS 的最小年龄的</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token keyword">all</span><span class="token punctuation">(</span><span class="token keyword">select</span> sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#44 学数据库的同学有谁</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student<span class="token punctuation">,</span> sc <span class="token keyword">where</span> sc<span class="token punctuation">.</span>sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#45 不学数据库的同学有谁</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#46 </span>\r\n<span class="token comment"># 查询选修了全部课程的学生姓名</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment"># 查询选修了全部已开课程的学生姓名</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc x <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc y <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> x<span class="token punctuation">.</span>cno<span class="token operator">=</span>y<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#47</span>\r\n<span class="token comment"># 查询至少选修了学生200215122选修的全部课程的学生号码</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc scx <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc scy <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc scz <span class="token keyword">where</span> scz<span class="token punctuation">.</span>sno<span class="token operator">=</span>scx<span class="token punctuation">.</span>sno <span class="token operator">and</span> scz<span class="token punctuation">.</span>cno<span class="token operator">=</span>scy<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#48</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#49</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#50 学cs同时不小于19岁的</span>\r\n<span class="token comment">-- select * from student where sdept=\'CS\' intersect select * from student where sage&lt;=19;</span>\r\n<span class="token keyword">select</span> s1<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student s1 <span class="token keyword">left</span> <span class="token keyword">join</span> student s2 <span class="token keyword">on</span> s1<span class="token punctuation">.</span>sno<span class="token operator">=</span>s2<span class="token punctuation">.</span>sno <span class="token keyword">where</span> s1<span class="token punctuation">.</span>sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> s1<span class="token punctuation">.</span>sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#51</span>\r\n<span class="token comment">#select sno from sc where cno=\'1\' intersect select sno from sc where cno=\'2\';</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> scx<span class="token punctuation">.</span>sno <span class="token keyword">from</span> sc scx<span class="token punctuation">,</span>sc scy <span class="token keyword">where</span> scx<span class="token punctuation">.</span>sno<span class="token operator">=</span>scy<span class="token punctuation">.</span>sno <span class="token operator">and</span> scx<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> scy<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#52</span>\r\n<span class="token comment">#select * from student where sdept=\'CS\' except select * from student where sage&lt;=19;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">></span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#53</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215129\'</span><span class="token punctuation">,</span><span class="token string">\'陈东\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#54</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215130\'</span><span class="token punctuation">,</span><span class="token string">\'张成民\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#55</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215128\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215129\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#56</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> dept_age\r\n<span class="token punctuation">(</span>\r\n sdept <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n avg_age <span class="token keyword">smallint</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> dept_age <span class="token punctuation">(</span>sdept<span class="token punctuation">,</span>avg_age<span class="token punctuation">)</span> <span class="token keyword">select</span> sdept<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">group</span> <span class="token keyword">by</span> sdept<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_age<span class="token punctuation">;</span>\r\n<span class="token comment">#57</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token number">22</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215121\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#58</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span>sage<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>\r\n<span class="token comment">#59</span>\r\n<span class="token keyword">update</span> sc <span class="token keyword">set</span> grade<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">where</span> <span class="token string">\'CS\'</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">update</span> sc <span class="token keyword">set</span> grade<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span>  student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#60\t建立计算机系学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_Student <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#61\t建立计算机系学生的视图，并按要求进行修改和插入时仍需保证该视图只有计算机系的学生</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_Student_Check <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token keyword">with</span> <span class="token keyword">check</span> <span class="token keyword">option</span><span class="token punctuation">;</span>\r\n<span class="token comment">#62\t建立计算机系选修了1号课程的学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_S1<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#63\t建立计算机系选修了1号课程且成绩在90分以上的学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_S2 <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> CS_S1 <span class="token keyword">where</span> grade<span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#64\t定义一个反映学生出生年份的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> BT_S<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sbirth<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#65 将学生的学号及他的平均成绩定义为一个视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> S_G<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>gavg<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno<span class="token punctuation">;</span>\r\n<span class="token comment">#66\t将student表中的所有女生记录定义为一个视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> F_Student <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> ssex<span class="token operator">=</span><span class="token string">\'女\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#67\t在计算机系学生的视图中找出年龄小于20岁的学生</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sage <span class="token keyword">from</span> CS_Student <span class="token keyword">where</span> sage<span class="token operator">&lt;=</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token comment">#68\t查询选修了1号课程的计算机系的学生</span>\r\n<span class="token keyword">select</span> CS_Student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> CS_Student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> CS_Student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#69\t在S_G视图中查询平均成绩在90分以上的学生学号和平均成绩</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> S_G <span class="token keyword">where</span> gavg<span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno <span class="token keyword">having</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#70\t将计算机系学生视图CS_Student中学号为200215122的学生姓名改为刘辰</span>\r\n<span class="token keyword">update</span> CS_Student <span class="token keyword">set</span> sname<span class="token operator">=</span><span class="token string">\'刘辰\'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sname<span class="token operator">=</span><span class="token string">\'刘辰\'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#71\t向计算机系的学生视图CS_Student中插入一个新的学生记录，其中学号为200215129，姓名为赵新，年龄为20岁</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> CS_Student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215131\'</span><span class="token punctuation">,</span><span class="token string">\'赵新\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215131\'</span><span class="token punctuation">,</span><span class="token string">\'赵新\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#72\t删除计算机学生视图CS_Student中学号为200215129的记录</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> CS_Student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215131\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215131\'</span> <span class="token operator">and</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#60</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215128\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215128\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#61</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> <span class="token string">\'CS\'</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#62</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#67 删除视图</span>\r\n<span class="token keyword">drop</span> <span class="token keyword">view</span>\tBT_S<span class="token punctuation">;</span>\r\n<span class="token keyword">drop</span> <span class="token keyword">view</span> CS_S1 <span class="token keyword">cascade</span><span class="token punctuation">;</span></code></pre>\n        </div></p>\n<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>已知始发站、终点站，如何查出满足条件的方案线路？即根据一个表关联多个表时如何查询相关字段？</p>\n<h1 id="sql-语句"><a href="#sql-%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sql 语句</h1>\n<p>根据以上的前置知识可得出一对多下的查询应该这样写：</p>\n<p><div class="gatsby-highlight">\n        <pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span><span class="token punctuation">;</span>\r\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span>  <span class="token punctuation">(</span>\r\n  <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'创建时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'更新时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>deleted_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'删除时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'主键ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案名称\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案报告状态，生成中：generating，已生成：generated\'</span><span class="token punctuation">,</span>\r\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\r\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">\'车次方案列表 \'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'32\'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'sfaf\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span><span class="token punctuation">;</span>\r\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span>  <span class="token punctuation">(</span>\r\n  <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'创建时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'更新时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>deleted_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'删除时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'主键ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>scheme_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zm<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zmdm<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名代码\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zmlx<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名类型\'</span><span class="token punctuation">,</span>\r\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\r\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">\'车次方案查询条件站点信息 \'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'23\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'长沙\'</span><span class="token punctuation">,</span> <span class="token string">\'23\'</span><span class="token punctuation">,</span> <span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'24\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'武汉\'</span><span class="token punctuation">,</span> <span class="token string">\'555\'</span><span class="token punctuation">,</span> <span class="token string">\'pass\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'25\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'湘潭\'</span><span class="token punctuation">,</span> <span class="token string">\'666\'</span><span class="token punctuation">,</span> <span class="token string">\'end\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'武汉\'</span><span class="token punctuation">,</span> <span class="token string">\'555\'</span><span class="token punctuation">,</span> <span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'湘潭\'</span><span class="token punctuation">,</span> <span class="token string">\'666\'</span><span class="token punctuation">,</span> <span class="token string">\'end\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用 in</span>\r\n<span class="token keyword">SELECT</span>\r\n\t<span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info b \r\n<span class="token keyword">WHERE</span>\r\n\ta<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> a<span class="token punctuation">.</span>id <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> scheme_id <span class="token keyword">FROM</span> sugo_train_scheme_ponit_info <span class="token keyword">WHERE</span> zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> <span class="token operator">AND</span> zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用自连接</span>\r\n<span class="token keyword">SELECT</span>\r\n\ta<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>\r\n\tb<span class="token punctuation">.</span><span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info b<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info c \r\n<span class="token keyword">WHERE</span>\r\n\ta<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> b<span class="token punctuation">.</span>scheme_id <span class="token operator">=</span> c<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> c<span class="token punctuation">.</span>zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> \r\n\t<span class="token operator">AND</span> c<span class="token punctuation">.</span>zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用 exists，一次查询不能顺带查出线路表</span>\r\n<span class="token keyword">SELECT</span>\r\n\t<span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a\r\n<span class="token keyword">WHERE</span>\r\n\t<span class="token keyword">EXISTS</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sugo_train_scheme_ponit_info b <span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>scheme_id<span class="token operator">=</span>a<span class="token punctuation">.</span>id <span class="token operator">and</span> b<span class="token punctuation">.</span>zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> <span class="token operator">AND</span> b<span class="token punctuation">.</span>zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span> <span class="token punctuation">)</span></code></pre>\n        </div></p>\n<h1 id="sequelize-下的解决方案"><a href="#sequelize-%E4%B8%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sequelize 下的解决方案</h1>\n<ol>\n<li>从表的设计上考虑：将始发站、终点站写在主表中，无需考虑一对多的问题</li>\n<li>根据以上的 sql 语句利用 Sequelize 去关联</li>\n</ol>\n<p>最终为了实现上的简便，直接使用方案 1</p>\n<p>// TODO 多对多方案也需要延伸下</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Sequelize一对多查询解决方案/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2021-01-05 13:55:57",path:"/sequelize-one-to-many-find-solution/",tags:"后端, nodejs, Sequelize, SQL",title:"Sequelize一对多查询解决方案",draft:null}}],length:24,tag:"后端",pagesSum:5,page:3}}}});