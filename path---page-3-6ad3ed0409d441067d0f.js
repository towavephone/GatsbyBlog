webpackJsonp([0xc61b59b78031],{1362:function(n,a){n.exports={data:{site:{siteMetadata:{description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"提供的源代码链接如无特殊说明均来自于 CPython repo 中的 Python3.7 分支。 背景 这本书旨在深入 Python 解释器之中，提供 python 程序运行机制的概念上的概述。本书描述的对象是 CPython 的解释器实现，它是目前最主流或者说官方的 Python 实现。 根据对解释器调用方式的不同，一个 Python 程序的执行可以分为两个或三个阶段，这些内容将会被涵盖在本书的不同章节中： 初始化（Initialization）：这个阶段涉及到对于 python…",html:'<p>提供的源代码链接如无特殊说明均来自于 CPython repo 中的 Python3.7 分支。</p>\n<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>这本书旨在深入 Python 解释器之中，提供 python 程序运行机制的概念上的概述。本书描述的对象是 CPython 的解释器实现，它是目前最主流或者说官方的 Python 实现。</p>\n<p>根据对解释器调用方式的不同，一个 Python 程序的执行可以分为两个或三个阶段，这些内容将会被涵盖在本书的不同章节中：</p>\n<ol>\n<li>初始化（Initialization）：这个阶段涉及到对于 python 进程所需要的一系列数据结构的初始化。此阶段在交互模式下不会进行。</li>\n<li>编译（Compiling）：该阶段涉及到将源代码解析成语法树，创建 AST（Abstract Syntax Tree，抽象语法树）对象，创建 symbol tables 以及生成 code objects。</li>\n<li>解释运行（Interpreting）：这个阶段涉及到在一些环境（context）下对 code object 的执行。</li>\n</ol>\n<p>从源代码生成解析树（parse tree）与 AST 的过程是一个与特定语言关系不大的过程，应用在其它语言上的方法一样可以应用在 Python 上，所以本书并不会将重点放在这里。另一方面从抽象语法树创建符号表与 code object 是编译过程中更为有趣的过程，它多多少少与 Python 更加相关，也更值得关注。对编译后的 code object 进行解释以及其中所涉及到的数据结构也将被提及。主题将包括但不限于：符号表、code object 的生成过程、Python objects、frame objects、code objects、function objects、Python opcodes、interpreter loop、生成器以及由用户定义的类。</p>\n<h1 id="执行过程"><a href="#%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>执行过程</h1>\n<p>当我们通过命令行传入参数的方式调用 python 解释器去运行一个模块的时候，比如运行 <code class="language-text">python test.py</code> 则如下过程将开始进行</p>\n<div class="mermaid">stateDiagram\n    a: Initialization\n    state a {\n      direction LR\n      a1: main\n      a2: Py_Main\n      a1 --> a2\n    }\n    b: Compilation\n    a --> b\n    state b {\n      direction LR\n      b1: parse tree generation\n      b2: AST generation\n      b3: bytecode generation\n      b4: bytecode optimization\n      b5: code object generation\n      b1 --> b2\n      b2 --> b3\n      b3 --> b4\n      b4 --> b5\n    }\n    c: code object execution\n    b --> c</div>\n<p>Python 可执行程序是一个用 C 语言编写的程序。当它被执行的时候，所发生的事情其实就和其他 C 语言程序（比如 Linux 内核或是一个简单的 hello world 程序）差不多。请花一点时间来理解一下，Python 可执行程序只是一个用来运行程序的程序，可以结合 C 与 汇编或者 LLVM 的关系来理解。当我们使用解释器运行一个模块的时候，最开始会运行一个与平台相关的标准初始化过程。</p>\n<blockquote>\n<p>本书中的所有讨论都假设在类 Unix 操作系统中，Windows 下会有些许不同。</p>\n</blockquote>\n<p>C 运行时环境包含了所有的初始化操作，像是加载库、检查与设置环境变量等等，然后 python 可执行程序的 main 方法开始运行就像任何其他普通的 C 程序那样。</p>\n<blockquote>\n<p>补充知识：CPyhon 的项目结构</p>\n<p>参考 <a href="https://cpython-devguide.readthedocs.io/setup/#directory-structure" target="_blank" rel="nofollow noreferrer noopener">CPython 开发指南</a> 与 <a href="https://github.com/python/cpython/tree/3.7" target="_blank" rel="nofollow noreferrer noopener">3.7 的源码</a>。CPython 项目中的大多数 C 代码位于少数几个文件夹中：</p>\n<ul>\n<li>Include：存放大多数解释器层面上主要的头文件。</li>\n<li>Objects：包括从 int 到 type 的一系列对象（object）的实现。</li>\n<li>Python：解释器、字节码编译器以及一些其它的基础设施。</li>\n<li>Parser：语法相关的代码，包括 parser，lexer 以及 parser generator。</li>\n<li>Modules：标准库中使用 C 实现的部分，以及 main.c。</li>\n<li>Programs：C 可执行文件的源代码，包括 CPython 解释器的程序入口。</li>\n</ul>\n</blockquote>\n<p>python 的 main 函数位于 <a href="https://github.com/python/cpython/blob/3.7/Programs/python.c#L13" target="_blank" rel="nofollow noreferrer noopener">Programs/python.c</a> 文件中。main 函数会调用位于 <a href="https://github.com/python/cpython/blob/3.7/Modules/main.c#L3085" target="_blank" rel="nofollow noreferrer noopener">Modules/main.c</a> 中的 <code class="language-text">Py_Main</code> 函数，它处理解释器的初始化过程，包括：解析命令行参数、设置程序的 <a href="https://docs.python.org/3.7/using/cmdline.html" target="_blank" rel="nofollow noreferrer noopener">flags</a>、读取环境变量、运行 hook、哈希初始化等等。作为初始化过程的一部分，<a href="https://github.com/python/cpython/blob/3.7/Python/pylifecycle.c#L1046" target="_blank" rel="nofollow noreferrer noopener">Python/pylifecycle.c</a> 中的 <code class="language-text">Py_Initialize</code> 函数会被调用，它会初始化两个比较重要的数据结构：解释器状态与线程状态。</p>\n<p>看一眼解释器状态与线程状态的定义，它能给我们一些关于它们功能的信息。这两个数据结构由一些指向特定字段的指针组成，它们带有程序执行所需要的一些信息。首先我们来看解释器状态在源码中的定义（<a href="https://github.com/python/cpython/blob/3.7/Include/pystate.h#L113" target="_blank" rel="nofollow noreferrer noopener">Include/pystate.h</a>），以下是其中比较重要的部分：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43430938960007980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`typedef struct _is {\n    struct _is *next;\n    struct _ts *tstate_head;\n\n    PyObject *modules;\n    PyObject *modules_by_index;\n    PyObject *sysdict;\n    PyObject *builtins;\n    PyObject *importlib;\n\n    PyObject *codec_search_path;\n    PyObject *codec_search_cache;\n    PyObject *codec_error_registry;\n\n    int codecs_initialized;\n    int fscodec_initialized;\n\n    PyObject *builtins_copy;\n} PyInterpreterState;`, `43430938960007980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_is</span> <span class="token punctuation">{</span>\n    <span class="token keyword">struct</span> <span class="token class-name">_is</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>\n    <span class="token keyword">struct</span> <span class="token class-name">_ts</span> <span class="token operator">*</span>tstate_head<span class="token punctuation">;</span>\n\n    PyObject <span class="token operator">*</span>modules<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>modules_by_index<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>sysdict<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>builtins<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>importlib<span class="token punctuation">;</span>\n\n    PyObject <span class="token operator">*</span>codec_search_path<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>codec_search_cache<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>codec_error_registry<span class="token punctuation">;</span>\n\n    <span class="token keyword">int</span> codecs_initialized<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> fscodec_initialized<span class="token punctuation">;</span>\n\n    PyObject <span class="token operator">*</span>builtins_copy<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> PyInterpreterState<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 程序员应该或多或少会对这些字段名字中的词有一些认识比如：sysdict，builtins，codec 等。</p>\n<ol>\n<li>*next 字段为一个指向另一个解释器实例的引用（译注：多个解释器可以同时存在于一个进程当中，这个特性有望用于解决 CPython 的 GIL 问题，参考 <a href="https://www.python.org/dev/peps/pep-0554/" target="_blank" rel="nofollow noreferrer noopener">PEP554</a>）</li>\n<li>*tstate_head 字段指向运行的主线程。当程序开启多线程时，解释器被它开启的所有线程所共享。线程状态随后将被讨论。</li>\n<li>modules, <code class="language-text">modules_by_index</code>, sysdict, builtins 以及 importlib 从它们的名字就能理解。它们都被定义为 PyObject 的实例，在 Python 虚拟机中 PyObject 为最基本的对象类型。</li>\n<li>codec* 相关的字段持有用于定位、加载编码方式（encodings）的信息，对于字节解码（decoding bytes）非常重要。</li>\n</ol>\n<p>程序的运行必须在一个线程之中进行，thread state structure 包含了一个线程执行 python code object 所需的信息，关于 thread state 定义的其中一部分代码如下（<a href="https://github.com/python/cpython/blob/3.7/Include/pystate.h#L212" target="_blank" rel="nofollow noreferrer noopener">Include/pystate.h</a>）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68782360481136350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`typedef struct _ts {\n\n    struct _ts *prev;\n    struct _ts *next;\n    PyInterpreterState *interp;\n\n    struct _frame *frame;\n    int recursion_depth;\n    char overflowed; /* The stack has overflowed. Allow 50 more calls\n                        to handle the runtime error. */\n    char recursion_critical; /* The current calls must not cause\n                                a stack overflow. */\n    int stackcheck_counter;\n\n    /* \'tracing\' keeps track of the execution depth when tracing/profiling.\n       This is to prevent the actual trace/profile code from being recorded in\n       the trace/profile. */\n    int tracing;\n    int use_tracing;\n\n    Py_tracefunc c_profilefunc;\n    Py_tracefunc c_tracefunc;\n    PyObject *c_profileobj;\n    PyObject *c_traceobj;\n\n    /* The exception currently being raised */\n    PyObject *curexc_type;\n    PyObject *curexc_value;\n    PyObject *curexc_traceback;\n\n    PyObject *dict;  /* Stores per-thread state */\n\n    int gilstate_counter;\n} PyThreadState;`, `68782360481136350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_ts</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">struct</span> <span class="token class-name">_ts</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>\n    <span class="token keyword">struct</span> <span class="token class-name">_ts</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>\n    PyInterpreterState <span class="token operator">*</span>interp<span class="token punctuation">;</span>\n\n    <span class="token keyword">struct</span> <span class="token class-name">_frame</span> <span class="token operator">*</span>frame<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> recursion_depth<span class="token punctuation">;</span>\n    <span class="token keyword">char</span> overflowed<span class="token punctuation">;</span> <span class="token comment">/* The stack has overflowed. Allow 50 more calls\n                        to handle the runtime error. */</span>\n    <span class="token keyword">char</span> recursion_critical<span class="token punctuation">;</span> <span class="token comment">/* The current calls must not cause\n                                a stack overflow. */</span>\n    <span class="token keyword">int</span> stackcheck_counter<span class="token punctuation">;</span>\n\n    <span class="token comment">/* \'tracing\' keeps track of the execution depth when tracing/profiling.\n       This is to prevent the actual trace/profile code from being recorded in\n       the trace/profile. */</span>\n    <span class="token keyword">int</span> tracing<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> use_tracing<span class="token punctuation">;</span>\n\n    Py_tracefunc c_profilefunc<span class="token punctuation">;</span>\n    Py_tracefunc c_tracefunc<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>c_profileobj<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>c_traceobj<span class="token punctuation">;</span>\n\n    <span class="token comment">/* The exception currently being raised */</span>\n    PyObject <span class="token operator">*</span>curexc_type<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>curexc_value<span class="token punctuation">;</span>\n    PyObject <span class="token operator">*</span>curexc_traceback<span class="token punctuation">;</span>\n\n    PyObject <span class="token operator">*</span>dict<span class="token punctuation">;</span>  <span class="token comment">/* Stores per-thread state */</span>\n\n    <span class="token keyword">int</span> gilstate_counter<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> PyThreadState<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于这两个数据结构，后面的章节中还会有进一步讨论。初始化过程还会设置一些重要的机制，比如基本的 stdio 等。</p>\n<p>一旦完成了所有的初始化，<code class="language-text">Py_Main</code> 函数会调用 <a href="https://github.com/python/cpython/blob/3.7/Modules/main.c#L426" target="_blank" rel="nofollow noreferrer noopener"><code class="language-text">pymain_run_file</code></a> 函数，随后发生调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33855594110063845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`PyRun_AnyFileExFlags ->\nPyRun_SimpleFileExFlags ->\nPyRun_FileExFlags ->\nPyParser_ASTFromFileObject`, `33855594110063845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">PyRun_AnyFileExFlags -&gt;\nPyRun_SimpleFileExFlags -&gt;\nPyRun_FileExFlags -&gt;\nPyParser_ASTFromFileObject</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 <a href="https://github.com/python/cpython/blob/3.7/Python/pythonrun.c#L373" target="_blank" rel="nofollow noreferrer noopener">PyRun_SimpleFileExFlags</a> 函数调用中，<code class="language-text">__main__</code> namespace 将被创建，文件内容将在其中被运行。它也将检查文件的 pyc 版本是否存在（pyc 文件是一个储存了已经被执行过的 py 文件编译后的代码（字节码）的文件）。当文件的 pyc 版本存在的时候，将会尝试以二进制形式读取并执行它。而当 pyc 文件不存在的时候，会顺着 <a href="https://github.com/python/cpython/blob/3.7/Python/pythonrun.c#L965" target="_blank" rel="nofollow noreferrer noopener">PyRun_FileExFlags</a> 向下调用，<a href="https://github.com/python/cpython/blob/3.7/Python/pythonrun.c#L1210" target="_blank" rel="nofollow noreferrer noopener">PyParser_ASTFromFileObject</a> 函数会接着调用 <a href="https://github.com/python/cpython/blob/3.7/Parser/parsetok.c#L116" target="_blank" rel="nofollow noreferrer noopener">PyParser_ParseFileObject</a> 函数，它会读取被执行模块的内容并建立 parse tree，然后将 parse tree 传递给 <a href="https://github.com/python/cpython/blob/3.7/Python/ast.c#L768" target="_blank" rel="nofollow noreferrer noopener">PyAST_FromNodeObject</a> 根据 parse tree 创建 AST。</p>\n<blockquote>\n<p>如果你阅读这些代码，你会看到很多的 <code class="language-text">Py_INCREF</code> 和 <code class="language-text">Py_DECREF</code>。这些内存管理函数会在后面详细讨论。CPython 通过引用计数管理对象的生命周期。当一个新的对象引用产生的时候，计数通过 <code class="language-text">Py_INCREF</code> 增加，当一个引用离开作用域的时候会通过 <code class="language-text">Py_DECREF</code> 减少。</p>\n</blockquote>\n<p>AST 生成后会被传给 <a href="https://github.com/python/cpython/blob/3.7/Python/pythonrun.c#L1027" target="_blank" rel="nofollow noreferrer noopener">run_mod</a> 函数，这个函数会接着调用 <a href="https://github.com/python/cpython/blob/3.7/Python/compile.c#L301" target="_blank" rel="nofollow noreferrer noopener">PyAST_CompileObject</a> 根据 AST 生成 code object。并且在调用 <code class="language-text">PyAST_CompileObject</code> 生成字节码的时候会经过一个简单的 peephole optimizer 进行字节码优化。随后 <code class="language-text">run_mod</code> 会调用 <a href="https://github.com/python/cpython/blob/3.7/Python/ceval.c#L522" target="_blank" rel="nofollow noreferrer noopener">PyEval_EvalCode</a> 随之产生函数调用:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74585569553077800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`PyEval_EvalCode ->\nPyEval_EvalCodeEx ->\n_PyEval_EvalCodeWithName ->\nPyEval_EvalFrameEx`, `74585569553077800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">PyEval_EvalCode -&gt;\nPyEval_EvalCodeEx -&gt;\n_PyEval_EvalCodeWithName -&gt;\nPyEval_EvalFrameEx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 <a href="https://github.com/python/cpython/blob/3.7/Python/ceval.c#L544" target="_blank" rel="nofollow noreferrer noopener">PyEval_EvalFrameEx</a> 中的解释器循环（interpreter loop）才会实际进行对 code object 的运行处理。它不只是将 code object 作为参数而是使用一个 frame object，它有一个字段用来保存到 code object 的引用。简单来说，解释器循环会不断读取储存在一个指令数组中的下一个指令进行执行，增加或者删除位于栈上的对象，直到没有新的指令或者中途发生异常中断了循环。</p>\n<p>头文件 <a href="https://github.com/python/cpython/blob/3.7/Include/opcode.h" target="_blank" rel="nofollow noreferrer noopener">Include/opcode.h</a> 中包含了 python 虚拟机支持的 instruction/opcodes 清单。其实 opcodes 的概念很容易理解，在上面的例子中有 4 条 instruction：<code class="language-text">LOAD_FAST</code> 将它的参数对应的值（这里对应 x）加载到栈上。python 虚拟机是基于栈的 （stack based），也就是说 opcode 进行求值的对象以及求值得到的结果都会保存在栈上。<code class="language-text">BINARY_MULTIPLY</code> opcode 会将前两条指令的结果从栈中弹出（pop），执行二进制乘法运算然后将结果放（push）回栈顶。<code class="language-text">RETURN_VALUE</code> 指令会从栈中弹出设置为返回值并中断解释器循环。</p>\n<blockquote>\n<p>这里还涉及到几个暂时没有被解答的问题：</p>\n<ol>\n<li>LOAD_FAST 加载的值来自于哪里？</li>\n<li>指令中使用的参数来自于哪里？</li>\n<li>嵌套的函数与方法调用是如何被管理的？</li>\n<li>解释器循环是如何进行异常处理的？</li>\n</ol>\n</blockquote>\n<p>当所有的指令都被执行以后，<code class="language-text">Py_Main</code> 将继续执行一些清理（clean up）过程。就像 <code class="language-text">Py_Initialize</code> 所做的那样，<a href="https://github.com/python/cpython/blob/3.7/Python/pylifecycle.c#L1120" target="_blank" rel="nofollow noreferrer noopener">Py_Finalize</a> 会被调用完成一些清理任务，比如等待线程退出、调用 exit hooks、清理解释器分配的仍然被使用的内存等等。</p>\n<p>上面我们在一个较高的层面上对 python 解释器如何执行程序进行了描述，但还有大量的细节没有被讨论，接下来的章节中我们将深入进去提供更多的细节信息。</p>\n<h1 id="编译-python-源代码"><a href="#%E7%BC%96%E8%AF%91-python-%E6%BA%90%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译 Python 源代码</h1>\n<p>生成 code object 过程中 4 个主要的数据结构。尽管一般并不认为 Python 是一门编译性的语言，但实际上在代码执行前 Python 源码仍会被编译成可以被 python 虚拟机执行的字节码（byte code）。python 的编译过程非常直接，并不涉及到很多复杂的步骤。一个完整的 python 程序编译过程有以下几个步骤：</p>\n<ol>\n<li>将源代码 parsing 成一个 parse tree。</li>\n<li>将 parse tree 转化为 AST（抽象语法树，abstract syntax tree）。</li>\n<li>生成符号表（symbol table）。</li>\n<li>\n<p>从 AST 生成 code object，这一步包含：</p>\n<ol>\n<li>将 AST 转化为一个 flow control graph。</li>\n<li>从 control flow graph 产生 code object。</li>\n</ol>\n</li>\n</ol>\n<p>其中将从源码到 AST 是一个标准的过程，python 这里并没有什么特别的，所以本书会把关注点更多放在 symbol tables 以及 code objects 的生成过程上。如果你对于 Parsing 的详细原理比较感兴趣，推荐阅读经典的 <a href="https://www.amazon.co.uk/Compilers-Principles-Techniques-Alfred-Aho/dp/0201100886" target="_blank" rel="nofollow noreferrer noopener">龙书</a>。</p>\n<h2 id="从源码到-parse-tree"><a href="#%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0-parse-tree" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从源码到 parse tree</h2>\n<p>按照 Dragon book 中的描述 python 的 parser 属于一种 <a href="https://en.wikipedia.org/wiki/LL_parser" target="_blank" rel="nofollow noreferrer noopener">LL(1)</a> parser。CPython 目录下的 <a href="https://github.com/python/cpython/blob/3.5/Grammar/Grammar" target="_blank" rel="nofollow noreferrer noopener">Grammar/Grammer</a> 文件中包含了 Python 语言文法的 <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form" target="_blank" rel="nofollow noreferrer noopener">EBNF</a>（Extended Backus–Naur Form，扩展巴科斯范式）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71333763457385640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`...\nstmt: simple_stmt | compound_stmt\nsimple_stmt: small_stmt (\';\' small_stmt)* [\';\'] NEWLINE\nsmall_stmt: (expr_stmt | del_stmt | pass_stmt | flow_stmt |\n             import_stmt | global_stmt | nonlocal_stmt | assert_stmt)\nexpr_stmt: testlist_star_expr (augassign (yield_expr|testlist) |\n                     (\'=\' (yield_expr|testlist_star_expr))*)\ntestlist_star_expr: (test|star_expr) (\',\' (test|star_expr))* [\',\']\naugassign: (\'+=\' | \'-=\' | \'*=\' | \'@=\' | \'/=\' | \'%=\' | \'&=\' | \'|=\' | \'^=\' |\n            \'<<=\' | \'>>=\' | \'**=\' | \'//=\')\ndel_stmt: \'del\' exprlist\npass_stmt: \'pass\'\nflow_stmt: break_stmt | continue_stmt | return_stmt | raise_stmt | yield_stmt\nbreak_stmt: \'break\'\ncontinue_stmt: \'continue\'\nreturn_stmt: \'return\' [testlist]\nyield_stmt: yield_expr\nraise_stmt: \'raise\' [test [\'from\' test]]\nimport_stmt: import_name | import_from\nimport_name: \'import\' dotted_as_names\nimport_from: (\'from\' ((\'.\' | \'...\')* dotted_name | (\'.\' | \'...\')+)\n              \'import\' (\'*\' | \'(\' import_as_names \')\' | import_as_names))\nimport_as_name: NAME [\'as\' NAME]\n...`, `71333763457385640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">...\nstmt: simple_stmt | compound_stmt\nsimple_stmt: small_stmt (&#39;;&#39; small_stmt)* [&#39;;&#39;] NEWLINE\nsmall_stmt: (expr_stmt | del_stmt | pass_stmt | flow_stmt |\n             import_stmt | global_stmt | nonlocal_stmt | assert_stmt)\nexpr_stmt: testlist_star_expr (augassign (yield_expr|testlist) |\n                     (&#39;=&#39; (yield_expr|testlist_star_expr))*)\ntestlist_star_expr: (test|star_expr) (&#39;,&#39; (test|star_expr))* [&#39;,&#39;]\naugassign: (&#39;+=&#39; | &#39;-=&#39; | &#39;*=&#39; | &#39;@=&#39; | &#39;/=&#39; | &#39;%=&#39; | &#39;&amp;=&#39; | &#39;|=&#39; | &#39;^=&#39; |\n            &#39;&lt;&lt;=&#39; | &#39;&gt;&gt;=&#39; | &#39;**=&#39; | &#39;//=&#39;)\ndel_stmt: &#39;del&#39; exprlist\npass_stmt: &#39;pass&#39;\nflow_stmt: break_stmt | continue_stmt | return_stmt | raise_stmt | yield_stmt\nbreak_stmt: &#39;break&#39;\ncontinue_stmt: &#39;continue&#39;\nreturn_stmt: &#39;return&#39; [testlist]\nyield_stmt: yield_expr\nraise_stmt: &#39;raise&#39; [test [&#39;from&#39; test]]\nimport_stmt: import_name | import_from\nimport_name: &#39;import&#39; dotted_as_names\nimport_from: (&#39;from&#39; ((&#39;.&#39; | &#39;...&#39;)* dotted_name | (&#39;.&#39; | &#39;...&#39;)+)\n              &#39;import&#39; (&#39;*&#39; | &#39;(&#39; import_as_names &#39;)&#39; | import_as_names))\nimport_as_name: NAME [&#39;as&#39; NAME]\n...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每次从命令行中运行一个 python 模块的时候，<code class="language-text">PyParser_ParseFileObject</code> 函数会启动对这个模块的 parsing 过程，它会调用 tokenization 函数 <code class="language-text">PyTokenizer_FromFile</code>，它接受模块的文件名作为参数，将模块文件的内容分解为一个个合法的 python tokens 或者发现语法错误时进行报错。</p>\n<h2 id="python-tokens"><a href="#python-tokens" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python tokens</h2>\n<p>Python 源码可以看作是一段由 token 组成的序列，比如说 return 就是一个 keyword token，字面量 -2 是一个数值字面量 token 等等。Parsing python 源码的第一步就是将源码分割为一个个的 token。Python 中存在以下几种 token：</p>\n<ol>\n<li>identifiers：由程序员定义的“名字”，包括函数名、变量名、类名等等。它们必须符合 python 文档中指定的<a href="https://docs.python.org/3.5/reference/lexical_analysis.html#identifiers" target="_blank" rel="nofollow noreferrer noopener">规范</a>。</li>\n<li>operators：一些特殊的符号比如 +, * 能够对值进行运算产生结果。</li>\n<li>delimiters：这类符号用来给表达式分组、提供标点、赋值操作，包括 (, ), {,}, =, *= 等。</li>\n<li>literals：字面量，这类符号用于提供一些类型的常量。比如字符串、bytes 类型的字面量：“Fred”, b”Fred”、数值类型的字面量 2、浮点类型字面量 1e100、虚数字面量 10j。</li>\n<li>comments：以 # 开头的字符串字面量，用户代码注释。comments 总是位于一个 physical line 的结尾。（译注：关于什么是 physical line 与 logical line 可以参考<a href="https://stackoverflow.com/questions/31572589/difference-between-logical-line-and-physical-line-in-python" target="_blank" rel="nofollow noreferrer noopener">这里</a>）</li>\n<li>NEWLINE：用于指示一行（logical line）的结束。</li>\n<li>INDENT 与 DEDENT：表示一组复合语句（compound statements）的缩进层级（identation levels）。</li>\n</ol>\n<p>一组 tokens 通过一个 NEWLINE token 被分割，组成一个 logical line，因而我们可以说一个 python 程序由一系列被 NEWLINE token 分割的 logical line 所组成。这些 logical line 可以映射到 python 语句（statements）。每一个 logical line 又由一系列 physical lines 所组成，physical line 的结尾是一个换行符（end-of-line）。多个 physical line 可以被连接在一起，连接可能是隐式的，比如在括号中的时候（包括 (), [], {} 三种），也可能是显式的，也就是在行尾使用一个反斜杠 \\。（译注：原文中说的是 logical line 可以被连接，这里似乎存在错误，想表达的应该是 phycial lines 被连接为 logical line）。复合语句可以跨过多个 physical line，就像图 1.3.2 中所展示的那样。缩进对于 python 语句的分组非常重要，python grammar 中有一条规则用于对它进行描述：<code class="language-text">suite: simple_stmt | NEWLINE INDENT stmt+ DEDENT</code>，因而 python tokenizer 的一项主要任务就是生成 INDENT 和 DEDENT 到 parse tree。Tokenizer 使用一个栈来保持对缩进的跟踪，INDENT 与 DEDENT token 生成算法的伪代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26020797578931876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`使用 0 初始化 indent 栈\nfor 每一个 logical line:\n    if (当前行的缩进级别 > 栈顶的级别):\n        push(当前缩进级别)\n        生成一个 INDENT token\n    if (当前行的缩进级别 < 栈顶的级别):\n        if (栈中不存在一个缩进级别 == 当前缩进级别):\n            报告一个错误\n        for 栈顶的每一个 != 当前行缩进级的值:\n            移除这个值\n            生成一个 DEDENT token\n    tokenize(当前行)\n对每一个栈上的值（除了0）生成 DEDENT token`, `26020797578931876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">使用 0 初始化 indent 栈\nfor 每一个 logical line:\n    if (当前行的缩进级别 &gt; 栈顶的级别):\n        push(当前缩进级别)\n        生成一个 INDENT token\n    if (当前行的缩进级别 &lt; 栈顶的级别):\n        if (栈中不存在一个缩进级别 == 当前缩进级别):\n            报告一个错误\n        for 栈顶的每一个 != 当前行缩进级的值:\n            移除这个值\n            生成一个 DEDENT token\n    tokenize(当前行)\n对每一个栈上的值（除了0）生成 DEDENT token</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>CPython 的实现中 <code class="language-text">PyTokenizer_FromFile</code> 函数会按照从左到右，从上到下的对 python 源码文件进行扫描并进行 tokenize。空格字符除了终止符被用来分隔开 token，但这不是必须的。如果其中存在歧义，则按照从右到左合法的可能的最长字符串来理解。比如说 2 + 2，是一个字面量 2，一个 operator +，另一个字面量 2。</p>\n<blockquote>\n<p>补充知识：调用 python tokenize</p>\n<p>在 python 中提供了 tokenize 的接口（标准模块函数 <a href="https://docs.python.org/3/library/tokenize.html#tokenize.tokenize" target="_blank" rel="nofollow noreferrer noopener">tokenize.tokenize</a>）可以使用它对 python 源代码进行 tokenize，它接受一个 ByteIO.readline 的 callable 对象返回一个 tokens 的 generator，对这个 generator 进行迭代就能得到被解析模块的 tokens 序列，比如：</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76393398976890420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from tokenize import tokenize\n>>> f = open(&quot;./test.py&quot;, \'rb\')  # test.py 的内容只有一行 print(&quot;hello&quot;)\n>>> for t in tokenize(f.readline):\n...     print(t)\n...\nTokenInfo(type=59 (ENCODING), string=\'utf-8\', start=(0, 0), end=(0, 0), line=\'\')\nTokenInfo(type=1 (NAME), string=\'print\', start=(1, 0), end=(1, 5), line=\'print(&quot;hello&quot;)\')\nTokenInfo(type=53 (OP), string=\'(\', start=(1, 5), end=(1, 6), line=\'print(&quot;hello&quot;)\')\nTokenInfo(type=3 (STRING), string=\'&quot;hello&quot;\', start=(1, 6), end=(1, 13), line=\'print(&quot;hello&quot;)\')\nTokenInfo(type=53 (OP), string=\')\', start=(1, 13), end=(1, 14), line=\'print(&quot;hello&quot;)\')\nTokenInfo(type=0 (ENDMARKER), string=\'\', start=(2, 0), end=(2, 0), line=\'\')`, `76393398976890420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> from tokenize <span class="token function">import</span> tokenize\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"./test.py"</span>, <span class="token string">\'rb\'</span><span class="token punctuation">)</span>  <span class="token comment"># test.py 的内容只有一行 print("hello")</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token for-or-select variable">t</span> <span class="token keyword">in</span> tokenize<span class="token punctuation">(</span>f.readline<span class="token punctuation">)</span>:\n<span class="token punctuation">..</span>.     print<span class="token punctuation">(</span>t<span class="token punctuation">)</span>\n<span class="token punctuation">..</span>.\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">59</span> <span class="token punctuation">(</span>ENCODING<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\'utf-8\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span>\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">(</span>NAME<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\'print\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">5</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'print("hello")\'</span><span class="token punctuation">)</span>\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">53</span> <span class="token punctuation">(</span>OP<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\'(\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">5</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">6</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'print("hello")\'</span><span class="token punctuation">)</span>\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">3</span> <span class="token punctuation">(</span>STRING<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\'"hello"\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">6</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">13</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'print("hello")\'</span><span class="token punctuation">)</span>\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">53</span> <span class="token punctuation">(</span>OP<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\')\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">13</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">14</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'print("hello")\'</span><span class="token punctuation">)</span>\nTokenInfo<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">(</span>ENDMARKER<span class="token punctuation">)</span>, <span class="token assign-left variable">string</span><span class="token operator">=</span><span class="token string">\'\'</span>, <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token assign-left variable">line</span><span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>此外，还可以在命令行中调用 tokenize：</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65303062018286264000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python -m tokenize test.py\n0,0-0,0:            ENCODING       \'utf-8\'\n1,0-1,5:            NAME           \'print\'\n1,5-1,6:            OP             \'(\'\n1,6-1,13:           STRING         \'&quot;hello&quot;\'\n1,13-1,14:          OP             \')\'\n2,0-2,0:            ENDMARKER      \'\'`, `65303062018286264000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python -m tokenize test.py\n<span class="token number">0,0</span>-0,0:            ENCODING       <span class="token string">\'utf-8\'</span>\n<span class="token number">1,0</span>-1,5:            NAME           <span class="token string">\'print\'</span>\n<span class="token number">1,5</span>-1,6:            OP             <span class="token string">\'(\'</span>\n<span class="token number">1,6</span>-1,13:           STRING         <span class="token string">\'"hello"\'</span>\n<span class="token number">1,13</span>-1,14:          OP             <span class="token string">\')\'</span>\n<span class="token number">2,0</span>-2,0:            ENDMARKER      <span class="token string">\'\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>tokenizer 生成的 tokens 随后会被传递给 parser 根据 python 的语法来生成 parse tree 。当 parser 发现一个 token 违反了语法规则的时候就会抛出一个 SyntaxError。python 中有一个 <a href="https://docs.python.org/3.5/library/parser.html" target="_blank" rel="nofollow noreferrer noopener">parser</a> 模块提供了有限的对 parse tree 的访问能力：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6075749810359499000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import parser\n>>> from pprint import pprint\n>>> code_str = &quot;&quot;&quot;\n... def hello_world():\n...     return \'hello world\'\n... &quot;&quot;&quot;\n>>> st = parser.suite(code_str)\n>>> pprint(parser.st2list(st))\n[257,\n [269,\n  [295,\n   [263,\n    [1, \'def\'],\n    [1, \'hello_world\'],\n    [264, [7, \'(\'], [8, \')\']],\n    [11, \':\'],\n    [304,\n     [4, \'\'],\n     [5, \'\'],\n     [269,\n      [270,\n       [271,\n        [278,\n         [281,\n          [1, \'return\'],\n          [331,\n           [305,\n            [309,\n             [310,\n              [311,\n               [312,\n                [315,\n                 [316,\n                  [317,\n                   [318,\n                    [319,\n                     [320,\n                      [321,\n                       [322,\n                        [323, [324, [3, &quot;\'hello world\'&quot;]]]]]]]]]]]]]]]]]]]],\n       [4, \'\']]],\n     [6, \'\']]]]],\n [4, \'\'],s\n [0, \'\']]`, `6075749810359499000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> parser\n<span class="token operator">>></span><span class="token operator">></span> from pprint <span class="token function">import</span> pprint\n<span class="token operator">>></span><span class="token operator">></span> code_str <span class="token operator">=</span> <span class="token string">""</span><span class="token string">"\n... def hello_world():\n...     return \'hello world\'\n... "</span><span class="token string">""</span>\n<span class="token operator">>></span><span class="token operator">></span> st <span class="token operator">=</span> parser.suite<span class="token punctuation">(</span>code_str<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> pprint<span class="token punctuation">(</span>parser.st2list<span class="token punctuation">(</span>st<span class="token punctuation">))</span>\n<span class="token punctuation">[</span><span class="token number">257</span>,\n <span class="token punctuation">[</span><span class="token number">269</span>,\n  <span class="token punctuation">[</span><span class="token number">295</span>,\n   <span class="token punctuation">[</span><span class="token number">263</span>,\n    <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token string">\'def\'</span><span class="token punctuation">]</span>,\n    <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token string">\'hello_world\'</span><span class="token punctuation">]</span>,\n    <span class="token punctuation">[</span><span class="token number">264</span>, <span class="token punctuation">[</span><span class="token number">7</span>, <span class="token string">\'(\'</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">8</span>, <span class="token string">\')\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,\n    <span class="token punctuation">[</span><span class="token number">11</span>, <span class="token string">\':\'</span><span class="token punctuation">]</span>,\n    <span class="token punctuation">[</span><span class="token number">304</span>,\n     <span class="token punctuation">[</span><span class="token number">4</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span>,\n     <span class="token punctuation">[</span><span class="token number">5</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span>,\n     <span class="token punctuation">[</span><span class="token number">269</span>,\n      <span class="token punctuation">[</span><span class="token number">270</span>,\n       <span class="token punctuation">[</span><span class="token number">271</span>,\n        <span class="token punctuation">[</span><span class="token number">278</span>,\n         <span class="token punctuation">[</span><span class="token number">281</span>,\n          <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token string">\'return\'</span><span class="token punctuation">]</span>,\n          <span class="token punctuation">[</span><span class="token number">331</span>,\n           <span class="token punctuation">[</span><span class="token number">305</span>,\n            <span class="token punctuation">[</span><span class="token number">309</span>,\n             <span class="token punctuation">[</span><span class="token number">310</span>,\n              <span class="token punctuation">[</span><span class="token number">311</span>,\n               <span class="token punctuation">[</span><span class="token number">312</span>,\n                <span class="token punctuation">[</span><span class="token number">315</span>,\n                 <span class="token punctuation">[</span><span class="token number">316</span>,\n                  <span class="token punctuation">[</span><span class="token number">317</span>,\n                   <span class="token punctuation">[</span><span class="token number">318</span>,\n                    <span class="token punctuation">[</span><span class="token number">319</span>,\n                     <span class="token punctuation">[</span><span class="token number">320</span>,\n                      <span class="token punctuation">[</span><span class="token number">321</span>,\n                       <span class="token punctuation">[</span><span class="token number">322</span>,\n                        <span class="token punctuation">[</span><span class="token number">323</span>, <span class="token punctuation">[</span><span class="token number">324</span>, <span class="token punctuation">[</span><span class="token number">3</span>, <span class="token string">"\'hello world\'"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,\n       <span class="token punctuation">[</span><span class="token number">4</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,\n     <span class="token punctuation">[</span><span class="token number">6</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,\n <span class="token punctuation">[</span><span class="token number">4</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span>,s\n <span class="token punctuation">[</span><span class="token number">0</span>, <span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>函数调用 parser.suite(source) 会返回一个 python 中对 parser tree 的中间表示即 parser tree (ST) 对象。之后的调用 parser.st2list 会将 parser 以 list 的形式返回。list 中第一个元素为一个 int 类型的数字表示 python grammar 中对应的 <a href="https://github.com/python/cpython/blob/3.7/Include/token.h" target="_blank" rel="nofollow noreferrer noopener">identifier 编号</a>。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-25bb8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.138686131386855%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoUlEQVQ4y62S6w6DIAyFQUE36cDp+7/ryvIt6Y9tSrDJCaEJ51Lq3LlaFA9FdJ1ViZJiVzwVmbMohlayu3k80/OKETRVVb8ZV8EQHlZ1MPFwZVaFqBt9gTwiFumnX24+6t7EzUTdEBQEF2YqiGeD8M+5/xJzMPdgZtz9+7MZRYE49BBOxE8tn3W0UgV0VcCZQCpXzdA6Xa+I7MyuJtbnTfoCRoYDs8SIwVwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 02 05 18 29 31" title="" data-src="/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-fee1c.png" data-srcset="/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-a67b7.png 200w,\n/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-0b187.png 400w,\n/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-fee1c.png 800w,\n/static/2024-02-05-18-29-31-cbc7be8e9be81adc14c75c8e7319d86d-25bb8.png 1096w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图展示了代码清单 1.3.2 中产生的 parse tree 结构，可以看到其中每个节点的类型可以用一个整数来表示，这些对于这些整数的定义位于头文件 <a href="https://github.com/python/cpython/blob/3.7/Include/token.h" target="_blank" rel="nofollow noreferrer noopener">Include/token.h</a> 和 <a href="https://github.com/python/cpython/blob/3.7/Include/graminit.h" target="_blank" rel="nofollow noreferrer noopener">Include/graminit.h</a> 中。</p>\n<p>在 CPython 虚拟机中，使用树结构来对 parser tree 进行表示。每一个产生式规则（production rule）是树中的一个节点（node）。对 node 的定义位于头文件 <a href="https://github.com/python/cpython/blob/3.7/Include/node.h#L10" target="_blank" rel="nofollow noreferrer noopener">Include/node.h</a> 中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95424916285736850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`typedef struct _node {\n    short       n_type;\n    char        *n_str;\n    int         n_lineno;\n    int         n_col_offset;\n    int         n_nchildren;\n    struct _node    *n_child;\n} node;`, `95424916285736850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_node</span> <span class="token punctuation">{</span>\n    <span class="token keyword">short</span>       n_type<span class="token punctuation">;</span>\n    <span class="token keyword">char</span>        <span class="token operator">*</span>n_str<span class="token punctuation">;</span>\n    <span class="token keyword">int</span>         n_lineno<span class="token punctuation">;</span>\n    <span class="token keyword">int</span>         n_col_offset<span class="token punctuation">;</span>\n    <span class="token keyword">int</span>         n_nchildren<span class="token punctuation">;</span>\n    <span class="token keyword">struct</span> <span class="token class-name">_node</span>    <span class="token operator">*</span>n_child<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> node<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以对 parser tree 进行遍历，访问节点的类型、子节点、行号等等，这些操作以宏（macro）的形式定义在头文件 <code class="language-text">Include/node.h</code> 中，用于与 parse tree 的节点进行交互。</p>\n<p>// TODO 深入理解 Python 虚拟机 <a href="https://nanguage.gitbook.io/inside-python-vm-cn/untitled" target="_blank" rel="nofollow noreferrer noopener">https://nanguage.gitbook.io/inside-python-vm-cn/untitled</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/深入理解 Python 虚拟机/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2024-02-04 10:39:38",path:"/python-vm-deep-learn/",tags:"后端, python, 读书笔记",title:"深入理解 Python 虚拟机",draft:null}},{excerpt:"背景 在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏 原因与方案 由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新 所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14201023463724294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Uncaught ChunkLoadError: Loading chunk <CHUNK_NAME> failed.\n(error: <WEBSITE_PATH>/<CHUNK_NAME>-<CHUNK_HASH>.js)`, `14201023463724294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Uncaught ChunkLoadError: Loading chunk <span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span> failed.\n<span class="token punctuation">(</span>error: <span class="token operator">&lt;</span>WEBSITE_PATH<span class="token operator">></span>/<span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span>-<span class="token operator">&lt;</span>CHUNK_HASH<span class="token operator">></span>.js<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="原因与方案"><a href="#%E5%8E%9F%E5%9B%A0%E4%B8%8E%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因与方案</h1>\n<p>由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新</p>\n<p>所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk 虽然路径，文件名没变，但是内容改变导致有概率的白屏，所以针对此情况，有以下方案</p>\n<ol>\n<li>缓存所有版本的文件，但会造成空间浪费</li>\n<li>对打包出来的文件都不做缓存，但对服务器有很大压力</li>\n<li>可以通过一个 websocket 链接或者轮询来主动告知浏览器更新版本，但此方案过于繁重且需要后端支持</li>\n<li>对报错的文件重试，超过一定次数白屏，或者主动告知用户刷新页面</li>\n</ol>\n<p>综上，采用方案 4</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>对于方案 4，同样有 2 大类，编译时或运行时，选型对比如下</p>\n<table>\n  <thead>\n    <tr>\n      <th>类型</th>\n      <th>序号</th>\n      <th>选型</th>\n      <th>优点</th>\n      <th>缺点</th>\n   </tr>\n   </thead>\n  <tbody>\n   <tr>\n      <td rowspan="2">运行时</td>\n      <td>1</td>\n      <td>\n         <a href="https://github.com/Nikaple/assets-retry" target="_blank">assets-retry</a> 以及 <a href="https://github.com/Nikaple/assets-retry/blob/master/README-cn.md" target="_blank">原理</a>\n      </td>\n      <td>接入简单</td>\n      <td>重试的元素种类太多，对于白屏问题，只需要保证 js 需要重试</td>\n   </tr>\n   <tr>\n      <td>2</td>\n      <td>\n         重写 react lazy 方法，对报错进行重试\n      </td>\n      <td>实现简单</td>\n      <td>\n         <ol>\n            <li>\n               不能监听到主入口的报错，需要用 window.error 补齐\n            </li>\n            <li>\n               需要改动原始代码\n            </li>\n            <li>\n               由于 webpack 的 chunk 加载机制，失败的 chunk 不能重试，原理见上面\n            </li>\n         </ol>\n      </td>\n    </tr>\n    <tr>\n      <td rowspan="2">编译时</td>\n      <td>3</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a>\n      </td>\n      <td>\n         接入简单，很方便的实现 chunk 重试\n      </td>\n      <td>\n         不能让主入口报错重试\n      </td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a> 以及\n         <a href="https://gist.github.com/mishani0x0ef/b15a969c016fa01b85f413b712c40fa1" target="_blank">html-tag-attributes-plugin</a>\n      </td>\n      <td>\n         接入简单\n      </td>\n      <td>\n         需要自己实现主入口报错重试逻辑\n      </td>\n    </tr>\n   </tbody>\n</table>\n<p>其他参考链接如下:</p>\n<ol>\n<li><a href="https://dev.to/igor_bykov/handle-loading-errors-fallback-with-htmlwebpackplugin-2d31" target="_blank" rel="nofollow noreferrer noopener">handle-loading-errors-fallback-with-htmlwebpackplugin</a></li>\n<li><a href="https://baijiahao.baidu.com/s?id=1776343703094638001&#x26;wfr=spider&#x26;for=pc" target="_blank" rel="nofollow noreferrer noopener">如何解决 JS 脚本加载失败的问题</a></li>\n<li><a href="https://stackoverflow.com/questions/69047420/webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e" target="_blank" rel="nofollow noreferrer noopener">webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e</a></li>\n</ol>\n<p>最终采用选型 4</p>\n<h1 id="实现过程"><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现过程</h1>\n<p>预研过程包含选型 2 与 4，注意这里的重试需要有间隔时间以及需要带额外的 <code class="language-text">?</code> 参数防止缓存生效</p>\n<h2 id="重写-react-lazy-方法"><a href="#%E9%87%8D%E5%86%99-react-lazy-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重写 react lazy 方法</h2>\n<p>使用时可以直接替代 react 的 lazy 方法，但由于上面提到的缺点不采用此方案</p>\n<p>importRetry.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49667016506305250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import * as React from \'react\';\n\nconst noop = () => {};\nconst strategies = {\n   PARSE_ERROR_MESSAGE: (error, _) => {\n      const url = new URL(error.request);\n      return url.href;\n   }\n};\n\nconst defaultOpts = {\n   strategy: \'PARSE_ERROR_MESSAGE\',\n   importFunction: (path) => import(/* @vite-ignore */ path),\n   logger: noop\n};\n\n/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */\n// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts\nfunction createDynamicImportWithRetry(maxRetries, opts = {}) {\n   const resolvedOpts = {\n      ...defaultOpts,\n      ...opts\n   };\n   const { logger, importFunction, strategy } = resolvedOpts;\n\n   return async (importer) => {\n      try {\n         return await importer();\n      } catch (error) {\n         logger(Date.now(), \\`Importing failed: \\`, error);\n\n         const modulePath = strategies[strategy](error, importer);\n         logger(\\`Parsed url using \\${strategy}:\\${modulePath}\\`);\n\n         if (!modulePath) {\n            logger(\'Unable to determine path to module when trying to reload\');\n            // nothing we can do ...\n            throw error;\n         }\n\n         // retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)\n         //\n         for (let i = -1; i < maxRetries; i++) {\n            // add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)\n            let cacheBustedPath = \\`\\${modulePath}?t=\\${+new Date()}\\`;\n            logger(Date.now(), \\`Trying re-import module using cache busted path: \\${cacheBustedPath}\\`);\n\n            try {\n               return await importFunction(cacheBustedPath);\n            } catch (e) {\n               logger(\\`Import for \\${cacheBustedPath} failed\\`);\n               await new Promise((resolve) => setTimeout(resolve, 1000 * 2 ** i));\n            }\n         }\n         throw error;\n      }\n   };\n}\n\nconst MAX_RETRY_COUNT = 5;\n\nconst defaultDynamicImportWithRetry = createDynamicImportWithRetry(MAX_RETRY_COUNT, {\n   logger: console.log\n});\n\nexport function lazy(importer) {\n   return process.env.NODE_ENV === \'development\'\n      ? React.lazy\n      : React.lazy(() => defaultDynamicImportWithRetry(importer));\n}`, `49667016506305250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> strategies <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">PARSE_ERROR_MESSAGE</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> url<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n   strategy<span class="token punctuation">:</span> <span class="token string">\'PARSE_ERROR_MESSAGE\'</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">importFunction</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* @vite-ignore */</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   logger<span class="token punctuation">:</span> noop\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */</span>\n<span class="token comment">// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts</span>\n<span class="token keyword">function</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token parameter">maxRetries<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> resolvedOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultOpts<span class="token punctuation">,</span>\n      <span class="token operator">...</span>opts\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> logger<span class="token punctuation">,</span> importFunction<span class="token punctuation">,</span> strategy <span class="token punctuation">}</span> <span class="token operator">=</span> resolvedOpts<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Importing failed: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">const</span> modulePath <span class="token operator">=</span> strategies<span class="token punctuation">[</span>strategy<span class="token punctuation">]</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parsed url using </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>strategy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">\'Unable to determine path to module when trying to reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// nothing we can do ...</span>\n            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)</span>\n         <span class="token comment">//</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)</span>\n            <span class="token keyword">let</span> cacheBustedPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Trying re-import module using cache busted path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importFunction</span><span class="token punctuation">(</span>cacheBustedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Import for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">**</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_RETRY_COUNT</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultDynamicImportWithRetry <span class="token operator">=</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token constant">MAX_RETRY_COUNT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   logger<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span>\n      <span class="token operator">?</span> React<span class="token punctuation">.</span>lazy\n      <span class="token punctuation">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">defaultDynamicImportWithRetry</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="webpack-retry-chunk-load-plugin--html-tag-attributes-plugin"><a href="#webpack-retry-chunk-load-plugin--html-tag-attributes-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack-retry-chunk-load-plugin + html-tag-attributes-plugin</h2>\n<p>plugins/html-tag-attributes-plugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42489897510937240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n\n// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events\nclass HtmlTagAttributesPlugin {\n   static name = \'HtmlTagAttributesPlugin\';\n\n   constructor(options) {\n      const defaultOptions = {\n         script: {}\n      };\n\n      this.options = { ...defaultOptions, ...options };\n   }\n\n   apply(compiler) {\n      compiler.hooks.compilation.tap(HtmlTagAttributesPlugin.name, (compilation) =>\n         this._hookIntoHtmlAlterAssetTags(compilation)\n      );\n   }\n\n   _hookIntoHtmlAlterAssetTags(compilation) {\n      HtmlWebpackPlugin.getHooks(compilation).alterAssetTags.tapAsync(HtmlTagAttributesPlugin.name, (data, cb) =>\n         cb(null, this._extendScriptTags(data))\n      );\n   }\n\n   _extendScriptTags(data) {\n      data.assetTags.scripts = data.assetTags.scripts.map(({ attributes, ...other }) => ({\n         ...other,\n         attributes: {\n            ...attributes,\n            ...this.options.script\n         }\n      }));\n\n      return data;\n   }\n}\n\nmodule.exports = { HtmlTagAttributesPlugin };`, `42489897510937240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events</span>\n<span class="token keyword">class</span> <span class="token class-name">HtmlTagAttributesPlugin</span> <span class="token punctuation">{</span>\n   <span class="token keyword">static</span> name <span class="token operator">=</span> <span class="token string">\'HtmlTagAttributesPlugin\'</span><span class="token punctuation">;</span>\n\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>alterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_extendScriptTags</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_extendScriptTags</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts <span class="token operator">=</span> data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> attributes<span class="token punctuation">,</span> <span class="token operator">...</span>other <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token operator">...</span>other<span class="token punctuation">,</span>\n         attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span>attributes<span class="token punctuation">,</span>\n            <span class="token operator">...</span>this<span class="token punctuation">.</span>options<span class="token punctuation">.</span>script\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> data<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85564757344255690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { RetryChunkLoadPlugin } = require(\'webpack-retry-chunk-load-plugin\');\nconst { HtmlTagAttributesPlugin } = require(\'./plugins/html-tag-attributes-plugin\');\n\nconst lastResortScript = &quot;window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);&quot;;\nconst retryDelay = 4000;\nconst maxRetries = 5;\n\nconst isProd = env === \'production\';\n\nconst localConfig = override(\n   isProd &&\n      addWebpackPlugin(\n         new RetryChunkLoadPlugin({\n            // optional stringified function to get the cache busting query string appended to the script src\n            // if not set will default to appending the string \\`?cache-bust=true\\`\n            cacheBust: \\`function() {\n              return Date.now();\n            }\\`,\n            // optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0\n            // if string, value must be code to generate a delay value. Receives retryCount as argument\n            // e.g. \\`function(retryAttempt) { return retryAttempt * 1000 }\\`\n            retryDelay,\n            // optional value to set the maximum number of retries to load the chunk. Default is 1\n            maxRetries,\n            // // optional list of chunks to which retry script should be injected\n            // // if not set will add retry script to all chunks that have webpack script loading\n            // chunks: [\'chunkName\'],\n            // optional code to be executed in the browser context if after all retries chunk is not loaded.\n            // if not set - nothing will happen and error will be returned to the chunk loader.\n            lastResortScript\n         })\n      ),\n   isProd &&\n      addWebpackPlugin(\n         new HtmlTagAttributesPlugin({\n            script: {\n               onerror: \\`\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, \\${retryDelay}))\n                      if (retryCount === \\${maxRetries}) {\n                        \\${lastResortScript}\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              \\`\n            }\n         })\n      )\n);`, `85564757344255690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> RetryChunkLoadPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-retry-chunk-load-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/html-tag-attributes-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> lastResortScript <span class="token operator">=</span> <span class="token string">"window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> retryDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">RetryChunkLoadPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// optional stringified function to get the cache busting query string appended to the script src</span>\n            <span class="token comment">// if not set will default to appending the string `?cache-bust=true`</span>\n            cacheBust<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function() {\n              return Date.now();\n            }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0</span>\n            <span class="token comment">// if string, value must be code to generate a delay value. Receives retryCount as argument</span>\n            <span class="token comment">// e.g. `function(retryAttempt) { return retryAttempt * 1000 }`</span>\n            retryDelay<span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the maximum number of retries to load the chunk. Default is 1</span>\n            maxRetries<span class="token punctuation">,</span>\n            <span class="token comment">// // optional list of chunks to which retry script should be injected</span>\n            <span class="token comment">// // if not set will add retry script to all chunks that have webpack script loading</span>\n            <span class="token comment">// chunks: [\'chunkName\'],</span>\n            <span class="token comment">// optional code to be executed in the browser context if after all retries chunk is not loaded.</span>\n            <span class="token comment">// if not set - nothing will happen and error will be returned to the chunk loader.</span>\n            lastResortScript\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">HtmlTagAttributesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            script<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               onerror<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryDelay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))\n                      if (retryCount === </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n                        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastResortScript<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              </span><span class="token template-punctuation string">`</span></span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>在主入口的 js 以及分包后的 chunk 报错后都会做重试 5 次的操作，超过 5 次弹窗提示用户在部署，点击确定后刷新页面再次重试</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-a01e8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.06810035842294%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABUklEQVQ4y6WS3U6EMBCFef/X8Fm89MobY9wNYpbfAi30n4XjdDZrNGrM4iQn0yHk6zltM601xlFCSsldTRNSndQZ97kHtpXnbdsu33uNp5ccefGGsm5wqho0neBeU8/WdeWfrzqvCXDGY+lw96C+AScTIMQAYy0rLgusdYgx8szAn0SID9BVqaxx8D7wxjEuCCHCec/yISDDL7Wy2y0RvwBn1aMoco5bkTrRo+06iH7gdfbZwV9KtTiFuiwI0vOZB3KV7sE6B2PM7cBgJSoGCnLVM2SeZ2ju+nZgdBJlAlI8qRS/jtTThSTw7UAjIU6vkAQMziLQ7Wp6apZiG73DYVASMT9gaWrEcUDUM4IcEWgddgHJYVsc0bcdpnG8iGKb+R8OTX6EJYdOCLhhYPndDieFQMDYNohDz7E5Mm0U9jwbTxB7eIarK7iuJXc0E5wdU/R3tY72ZhqkSJAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 12 05 11 29 43" title="" data-src="/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-fee1c.png" data-srcset="/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-a67b7.png 200w,\n/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-0b187.png 400w,\n/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-fee1c.png 800w,\n/static/2023-12-05-11-29-43-56ee4c20b0d22def0adcbc9427ce5eb8-a01e8.png 1116w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>和 <a href="https://rsbuild.dev/plugins/list/plugin-assets-retry" target="_blank" rel="nofollow noreferrer noopener">plugin-assets-retry</a> 插件的效果异曲同工</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/缓存报错重试机制探究/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2023-11-30 17:47:38",path:"/cache-error-retry-process/",tags:"前端, 预研, webpack, 前端构建工具",title:"缓存报错重试机制探究",draft:null}},{excerpt:"背景 python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢 方案 需要找到哪行代码导致的内存泄漏，有以下方案 pympler scalene  (python3.8 以上，不符合) memray  (python3.7 以上，不符合) 使用 python 内置的 tracemalloc 库 由于项目用的是 python 3.6 的版本，所以采用方案 1 和…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢</p>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>需要找到哪行代码导致的内存泄漏，有以下方案</p>\n<ol>\n<li><a href="https://zhuanlan.zhihu.com/p/436577356" target="_blank" rel="nofollow noreferrer noopener">pympler</a></li>\n<li><a href="https://github.com/plasma-umass/scalene" target="_blank" rel="nofollow noreferrer noopener">scalene</a> (python3.8 以上，不符合)</li>\n<li><a href="https://github.com/bloomberg/memray" target="_blank" rel="nofollow noreferrer noopener">memray</a> (python3.7 以上，不符合)</li>\n<li>使用 python 内置的 tracemalloc 库</li>\n</ol>\n<p>由于项目用的是 python 3.6 的版本，所以采用方案 1 和 4</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="内存占用检测"><a href="#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存占用检测</h2>\n<ol>\n<li>通过接口获取当前内存占用最大的排名前几的代码行数</li>\n<li>通过接口获取当前占用内存最大的对象</li>\n</ol>\n<p><code class="language-text">controllers/app_monitor_controller.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81961185602037940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import tracemalloc\nimport logging\n\nfrom controllers.wrapper import (\n    get_param, get_int_param, request_wrapper)\n\n\n@request_wrapper()\ndef get_tracemalloc(request):\n    key_type = get_param(request, \'key_type\', default=\'traceback\')\n    limit = get_int_param(request, \'limit\', default=\'10\')\n    snapshot = tracemalloc.take_snapshot()\n    snapshot = snapshot.filter_traces((\n        tracemalloc.Filter(False, &quot;<unknown>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap_external>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap>&quot;),\n        tracemalloc.Filter(False, tracemalloc.__file__),\n    ))\n    top_stats = snapshot.statistics(key_type)\n    top_result = []\n    for index, stat in enumerate(top_stats[:limit], 1):\n        frame = stat.traceback[0]\n        desc = &quot;#%s: %s:%s: %.1f KiB&quot; % (\n            index, frame.filename, frame.lineno, stat.size / 1024)\n        top_result.append({\n            \'desc\': desc,\n            \'traceback\': stat.traceback.format()\n        })\n\n    other = top_stats[limit:]\n    if other:\n        size = sum(stat.size for stat in other)\n\n    total = sum(stat.size for stat in top_stats)\n\n    return {\n        \'top_result\': top_result,\n        \'other_result\': &quot;Total %s, other: %.1f KiB&quot; %\n        (len(other), size / 1024),\n        \'total_size\': &quot;%.1f KiB&quot; % (total / 1024)\n    }\n\n\n@request_wrapper()\ndef get_memory(request):\n    limit = get_int_param(request, \'limit\', default=\'1\')\n    from pympler import muppy, summary\n\n    all_objects = muppy.get_objects()\n    sum1 = summary.summarize(all_objects)\n    logging.info(\'Summary -----\')\n    summary.print_(sum1)\n\n    filter_all_objects = muppy.sort(all_objects)\n    dicts = [ao for ao in filter_all_objects if isinstance(ao, dict)]\n    result = []\n    for d in dicts[-limit:]:\n        item = f\'{len(d)}, {str(d).encode(&quot;utf-8&quot;)}\'\n        result.append(item)\n\n    import objgraph\n\n    logging.info(\'Common -----\')\n    objgraph.show_most_common_types()\n\n    logging.info(\'Growth -----\')\n    objgraph.show_growth(limit=5)\n\n    return result`, `81961185602037940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> logging\n\n<span class="token keyword">from</span> controllers<span class="token punctuation">.</span>wrapper <span class="token keyword">import</span> <span class="token punctuation">(</span>\n    get_param<span class="token punctuation">,</span> get_int_param<span class="token punctuation">,</span> request_wrapper<span class="token punctuation">)</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_tracemalloc</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    key_type <span class="token operator">=</span> get_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'key_type\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'traceback\'</span><span class="token punctuation">)</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'10\'</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> tracemalloc<span class="token punctuation">.</span>take_snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>filter_traces<span class="token punctuation">(</span><span class="token punctuation">(</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap_external>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> tracemalloc<span class="token punctuation">.</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">)</span>\n    top_stats <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>statistics<span class="token punctuation">(</span>key_type<span class="token punctuation">)</span>\n    top_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> stat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>top_stats<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        frame <span class="token operator">=</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n        desc <span class="token operator">=</span> <span class="token string">"#%s: %s:%s: %.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n            index<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>lineno<span class="token punctuation">,</span> stat<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n        top_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'desc\'</span><span class="token punctuation">:</span> desc<span class="token punctuation">,</span>\n            <span class="token string">\'traceback\'</span><span class="token punctuation">:</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    other <span class="token operator">=</span> top_stats<span class="token punctuation">[</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> other<span class="token punctuation">:</span>\n        size <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> other<span class="token punctuation">)</span>\n\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> top_stats<span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">\'top_result\'</span><span class="token punctuation">:</span> top_result<span class="token punctuation">,</span>\n        <span class="token string">\'other_result\'</span><span class="token punctuation">:</span> <span class="token string">"Total %s, other: %.1f KiB"</span> <span class="token operator">%</span>\n        <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'total_size\'</span><span class="token punctuation">:</span> <span class="token string">"%.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>total <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_memory</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">from</span> pympler <span class="token keyword">import</span> muppy<span class="token punctuation">,</span> summary\n\n    all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>get_objects<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sum1 <span class="token operator">=</span> summary<span class="token punctuation">.</span>summarize<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Summary -----\'</span><span class="token punctuation">)</span>\n    summary<span class="token punctuation">.</span>print_<span class="token punctuation">(</span>sum1<span class="token punctuation">)</span>\n\n    filter_all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    dicts <span class="token operator">=</span> <span class="token punctuation">[</span>ao <span class="token keyword">for</span> ao <span class="token keyword">in</span> filter_all_objects <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ao<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> d <span class="token keyword">in</span> dicts<span class="token punctuation">[</span><span class="token operator">-</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        item <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>\n\n    <span class="token keyword">import</span> objgraph\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Common -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_most_common_types<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Growth -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_growth<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里需要在项目启动的时候去开启记录内存的功能，否则上面的 <code class="language-text">get_tracemalloc</code> 功能不可用，当然这里的功能需要在使用结束后立即关闭，否则内存占用较大</p>\n<p>apps.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52502797593507550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from django.apps import AppConfig\nimport tracemalloc\nimport os\n\n# 减少 pypinyin 的内存占用\nos.environ[\'PYPINYIN_NO_PHRASES\'] = \'true\'\nos.environ[\'PYPINYIN_NO_DICT_COPY\'] = \'true\'\n\n\nclass Config(AppConfig):\n    def ready(self):\n        from entry.settings import START_RECORD_MEMORY\n        if not START_RECORD_MEMORY:\n            return\n        tracemalloc.start(25)`, `52502797593507550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig\n<span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> os\n\n<span class="token comment"># 减少 pypinyin 的内存占用</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_PHRASES\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_DICT_COPY\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">ready</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">from</span> entry<span class="token punctuation">.</span>settings <span class="token keyword">import</span> START_RECORD_MEMORY\n        <span class="token keyword">if</span> <span class="token keyword">not</span> START_RECORD_MEMORY<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        tracemalloc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="耗时检测"><a href="#%E8%80%97%E6%97%B6%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>耗时检测</h2>\n<p>主要用来统计函数执行过程中每行耗时及调用次数</p>\n<p><code class="language-text">tools/performance_tool.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18284421602891254000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from cProfile import Profile\nfrom pstats import Stats\n\n\ndef print_func_cost():\n    def wrapper2(func):\n        def wrapper1(*args, **kwargs):\n            profiler = Profile()\n            # request = args[0]\n\n            result = profiler.runcall(func, *args, **kwargs)\n\n            stats = Stats(profiler)\n            stats.strip_dirs()\n            stats.sort_stats(\'cumulative\')\n            # stats.print_stats()\n            stats.print_callers()\n\n            return result\n        return wrapper1\n    return wrapper2`, `18284421602891254000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> cProfile <span class="token keyword">import</span> Profile\n<span class="token keyword">from</span> pstats <span class="token keyword">import</span> Stats\n\n\n<span class="token keyword">def</span> <span class="token function">print_func_cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper1</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            profiler <span class="token operator">=</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token comment"># request = args[0]</span>\n\n            result <span class="token operator">=</span> profiler<span class="token punctuation">.</span>runcall<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n            stats <span class="token operator">=</span> Stats<span class="token punctuation">(</span>profiler<span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>strip_dirs<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>sort_stats<span class="token punctuation">(</span><span class="token string">\'cumulative\'</span><span class="token punctuation">)</span>\n            <span class="token comment"># stats.print_stats()</span>\n            stats<span class="token punctuation">.</span>print_callers<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n            <span class="token keyword">return</span> result\n        <span class="token keyword">return</span> wrapper1\n    <span class="token keyword">return</span> wrapper2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>由以下日志可看出，内存占用较大的部分主要在 protobuf 解码，大文件读取，pypinyin，之后的优化就可以进行下去</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32587160663928906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`07:56:48 apps.py:37 INFO #1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB\n07:56:48 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 1580\'\n07:56:48 apps.py:43 INFO     b\'    data = text_format.Parse(data, DataTree())\'\n07:00:05 apps.py:33 INFO #2: 文件路径:1571: 66375.2 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:00:05 apps.py:33 INFO #8: 文件路径:1569: 2053.4 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:56:52 apps.py:37 INFO #5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB\n  07:56:52 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 26\'\n07:56:52 apps.py:43 INFO     b\'    from pypinyin import lazy_pinyin\'`, `32587160663928906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">07:56:48 apps.py:37 INFO <span class="token comment">#1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 1580\'</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'    data = text_format.Parse(data, DataTree())\'</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#2: 文件路径:1571: 66375.2 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#8: 文件路径:1569: 2053.4 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:56:52 apps.py:37 INFO <span class="token comment">#5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB</span>\n  07:56:52 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 26\'</span>\n07:56:52 apps.py:43 INFO     b<span class="token string">\'    from pypinyin import lazy_pinyin\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python 后端 oom 处理过程/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2023-11-30 17:46:51",path:"/python-backend-oom-process/",tags:"后端, python, 预研",title:"Python 后端 oom 处理过程",draft:null}},{excerpt:"背景 在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu 系统下却正常显示（右侧），如下图所示 原因 红点是由  CircleMarker  组件实现，而下面的线则是  PathSimplifier  实现，在 chrome 浏览器下不同系统的表现为： window: CircleMarker 由 canvas…",html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu 系统下却正常显示（右侧），如下图所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-11-28-17-00-49-e34e41355789ea9f86d92dfbd0971c55-16a51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 324px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.1358024691358%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACWElEQVQozz2SWU9TARCF77/0RR80MYawxBaUfW2lUiWllKVFKQSoFJTFaqkgmwgCSgCxRaCAQpe7dW8pxWg+ryHx4cuZzGTOyzlCbVMdhkcN2LvMWNtqsD+pZKTjAVNd5czadXwermKr7y6Hcw7S2QyZeJRUXCKhRokrETIphWxaJZtSSSdlBHHeyvG7DvZ9NjZetrHoMuFxGnH3NDLUWceYw4jFUMKEu5/LyxzpXJxUOkYsoaAmZLL5lEaafCFLrpBByL9vhBUDrLfBjg32nXA0BieTcOrR1AvBaXIna6iiSDawQ/IwQOLAr6lf0z2SR37tHiAb/IbwuKkMU0MRlpZi7KZSBs3FvOmtYNFZxdpQLYFJI2FPE/KuR3s+JOQaJNFjIu9oIGer5sKi4+KpnrzpHvmamwjSro/gRzfbvj5WxtvxOpt57WxlpKuBbpMOi1FP08PbjL54RuHnKT+e20m2V3PpqCc/YKQwZKbg7uRqysHVmA3h98kynH8AcR3ULxqb2rwKZwtw7OPq+1uyWy7EvXnCx0HU7Q3kT0soy3PE15cR/XtE9veRAgEiAT+CuUXPgK2R/vYKRq0VeB2VrA7X8/WVgbOZNmJLVn5t2skdLBAJnRFSRM4ViZAqEY7LnMcVQhqSRlgLSjgaKeHIXc6msxRvdxnDFj09WnX+VchqrqO1WU9LbRETY04y6SQxKUxCiV6jilp1oihyhJh8vRM6zLW4LPfZGNAhjxfB9C2YvMGfqTtczFSSnGvldLSEw9leEqk0STVCMib9J66ZKpqZLEWQxBB/AQBvSOSbuQBPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 11 28 17 00 49" title="" data-src="/static/2023-11-28-17-00-49-e34e41355789ea9f86d92dfbd0971c55-16a51.png" data-srcset="/static/2023-11-28-17-00-49-e34e41355789ea9f86d92dfbd0971c55-6752f.png 200w,\n/static/2023-11-28-17-00-49-e34e41355789ea9f86d92dfbd0971c55-16a51.png 324w" data-sizes="(max-width: 324px) 100vw, 324px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h1>\n<p>红点是由 <a href="https://lbs.amap.com/api/javascript-api-v2/documentation#circlemarker" target="_blank" rel="nofollow noreferrer noopener">CircleMarker</a> 组件实现，而下面的线则是 <a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/mass-data/pathsimplifier" target="_blank" rel="nofollow noreferrer noopener">PathSimplifier</a> 实现，在 chrome 浏览器下不同系统的表现为：</p>\n<ol>\n<li>window: CircleMarker 由 canvas 渲染，且层级和高德地图图层一致，而 PathSimplifier 的层级比高德地图图层要高</li>\n<li>ubuntu: CircleMarker 由 svg 渲染，层级比 PathSimplifier 要高</li>\n</ol>\n<h1 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h1>\n<p>综上所述，需要统一不同系统下的渲染方式，优缺点对比如下</p>\n<table>\n<thead>\n<tr>\n<th align="center">渲染方式</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">canvas</td>\n<td align="center">性能好</td>\n<td align="center">实现成本高，即需要生成比 PathSimplifier 所在层级要高的新图层</td>\n</tr>\n<tr>\n<td align="center">svg</td>\n<td align="center">实现方便，有现成的 \n<a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/overlay/svgmarker" target="_blank" rel="nofollow noreferrer noopener">SvgMarker</a></td>\n<td align="center">性能差，但对于这个场景来说只需要鼠标悬浮上去才渲染一条路线上的点，即性能要求不高</td>\n</tr>\n</tbody>\n</table>\n<p>最终采用 SvgMarker 渲染</p>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>以下都在 chrome 浏览器下测试：</p>\n<h2 id="修复前"><a href="#%E4%BF%AE%E5%A4%8D%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复前</h2>\n<p>windows 下不能正常显示，ubuntu 正常</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x86xtf?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="修复后"><a href="#%E4%BF%AE%E5%A4%8D%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复后</h2>\n<p>windows、ubuntu 都能正常显示</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/9cpd4v?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>',id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/记一次处理高德地图浏览器兼容性问题/index.md absPath of file >>> MarkdownRemark",timeToRead:1,frontmatter:{date:"2023-11-28 16:55:48",path:"/amap-browser-compatibility/",tags:"前端, 地图, 预研",title:"记一次处理高德地图浏览器兼容性问题",draft:null}},{excerpt:"需求背景 针对本博客现有的 Gatsby 框架实现代码复制、代码实时查看编辑的功能 技术选型 以下都是采用最后一种方案，由于插件功能不满足，所以对其源码做出改动 代码复制 技术选型 语法 优点 缺点 项目代码自实现 未实现 定制化程度高 实现难度大； 拓展较差 gatsby-remark-code-buttons 不需特定语法，只要是代码块默认具有复制功能 已具有代码复制功能 有多复制一行的 bug； UI 不符合博客主题 代码实时查看编辑 技术选型 语法 优点 缺点 样例页面 iframe…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>针对本博客现有的 Gatsby 框架实现代码复制、代码实时查看编辑的功能</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>以下都是采用最后一种方案，由于插件功能不满足，所以对其源码做出改动</p>\n<h2 id="代码复制"><a href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码复制</h2>\n<table>\n<thead>\n<tr>\n<th align="left">技术选型</th>\n<th align="left">语法</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">项目代码自实现</td>\n<td align="left">未实现</td>\n<td align="left">定制化程度高</td>\n<td align="left"><ol>\n<li>\n实现难度大；\n</li>\n<li>\n拓展较差\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/iamskok/gatsby-remark-code-buttons" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-code-buttons</a></td>\n<td align="left">不需特定语法，只要是代码块默认具有复制功能</td>\n<td align="left">已具有代码复制功能</td>\n<td align="left"><ol>\n<li>\n有多复制一行的 bug；\n</li>\n<li>\nUI 不符合博客主题\n</li>\n</ol></td>\n</tr>\n</tbody>\n</table>\n<h2 id="代码实时查看编辑"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E6%97%B6%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码实时查看编辑</h2>\n<table>\n<thead>\n<tr>\n<th align="left">技术选型</th>\n<th align="left">语法</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n<th>样例页面</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">iframe + \n<a href="https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-remark-embed-snippet" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-embed-snippet</a></td>\n<td align="left"><code class="language-text">&lt;iframe src=&quot;/examples/snow.html&quot; width=&quot;800&quot; height=&quot;400&quot;&gt;&lt;/iframe&gt;</code>\n \n<br />\n \n<code class="language-text">`embed:snow.html`</code></td>\n<td align="left">实现最为简单，容易出效果</td>\n<td align="left"><ol>\n<li>\n没有实时编辑功能；\n<li>\n嵌入的代码往往需要将其写成一个 html 文件且一般情况下只支持静态页面的展示；\n</li>\n<li>\n需要 iframe、embed 标签声明两次\n</li>\n</ol></td>\n<td><a href="/snow-css/">下雪特效</a></td>\n</tr>\n<tr>\n<td align="left">iframe + code-editor.html 传参</td>\n<td align="left"><code class="language-text">&lt;iframe src=&quot;/examples/code-editor.html?html=转义字符串&amp;css=转义字符串&amp;js=转义字符串</code></td>\n<td align="left">基本实现代码的实时查看编辑</td>\n<td align="left"><ol>\n<li>\n嵌入的代码只支持静态的 html 页面；\n</li>\n<li>\n需要明确拆分出 js、css、html 三个结构；\n</li>\n<li>\n嵌入的 js、css、html 分别需要手动 escape 加密\n</li>\n</ol></td>\n<td><a href="/css-world-four-kinds-of-box/#border-%E7%AD%89%E9%AB%98%E5%B8%83%E5%B1%80%E6%8A%80%E6%9C%AF">CSS 世界四大盒尺寸</a></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/elboman/gatsby-remark-embedded-codesandbox" target="_blank" rel="nofollow noreferrer noopener">gatsby-remark-embedded-codesandbox</a></td>\n<td align="left"><code class="language-text">[pms-example](embedded-codesandbox://gantt-component-optimization/pms-example)</code></td>\n<td align="left">借助 codesandbox 实现了较为丰富的代码实时查看编辑功能</td>\n<td align="left"><ol>\n<li>\n借助第三方实现的功能，不够稳定；\n</li>\n<li>\n不支持带目录的文件夹；\n</li>\n<li>\n单次请求过大（即上传代码过多）会报请求体过大错误；\n</li>\n<li>\n会上传 node_modules 等等大文件\n</li>\n</ol></td>\n<td>需实现</td>\n</tr>\n</tbody>\n</table>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="代码复制-1"><a href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码复制</h2>\n<h3 id="修复复制多一行-bug"><a href="#%E4%BF%AE%E5%A4%8D%E5%A4%8D%E5%88%B6%E5%A4%9A%E4%B8%80%E8%A1%8C-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复复制多一行 bug</h3>\n<p>代码在<a href="https://github.com/towavephone/gatsby-remark-code-buttons/commit/d95bb194d74182a3c5b8118102b3826695c2ff6d" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>src/gatsby-browser.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40239360747069374000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@@ -7,19 +7,9 @@ exports.onClientEntry = () => {\n    el.innerHTML = str;\n    document.body.appendChild(el);\n\n-   const range = document.createRange();\n-   range.selectNode(el);\n-   window.getSelection().removeAllRanges();\n-   window.getSelection().addRange(range);\n-   document.execCommand(\\`copy\\`);\n-   document.activeElement.blur();\n-   setTimeout(() => {\n-     document.getSelection().removeAllRanges();\n-     document.body.removeChild(el);\n-   }, 100);\n+   el.select();\n+   document.execCommand(&quot;copy&quot;);\n+   document.body.removeChild(el);\n    if (toasterId) {\n      window.showClipboardToaster(toasterId);\n    }`, `40239360747069374000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@@ -7,19 +7,9 @@ exports.onClientEntry = () => {\n<span class="token unchanged"><span class="token prefix unchanged"> </span>   el.innerHTML = str;\n<span class="token prefix unchanged"> </span>   document.body.appendChild(el);\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   const range = document.createRange();\n<span class="token prefix deleted">-</span>   range.selectNode(el);\n<span class="token prefix deleted">-</span>   window.getSelection().removeAllRanges();\n<span class="token prefix deleted">-</span>   window.getSelection().addRange(range);\n<span class="token prefix deleted">-</span>   document.execCommand(`copy`);\n<span class="token prefix deleted">-</span>   document.activeElement.blur();\n<span class="token prefix deleted">-</span>   setTimeout(() => {\n<span class="token prefix deleted">-</span>     document.getSelection().removeAllRanges();\n<span class="token prefix deleted">-</span>     document.body.removeChild(el);\n<span class="token prefix deleted">-</span>   }, 100);\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   el.select();\n<span class="token prefix inserted">+</span>   document.execCommand("copy");\n<span class="token prefix inserted">+</span>   document.body.removeChild(el);\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (toasterId) {\n<span class="token prefix unchanged"> </span>     window.showClipboardToaster(toasterId);\n<span class="token prefix unchanged"> </span>   }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="增加显示语言类型的功能；改变按钮文本显示逻辑；任何语言都可以显示复制按钮"><a href="#%E5%A2%9E%E5%8A%A0%E6%98%BE%E7%A4%BA%E8%AF%AD%E8%A8%80%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9B%E6%94%B9%E5%8F%98%E6%8C%89%E9%92%AE%E6%96%87%E6%9C%AC%E6%98%BE%E7%A4%BA%E9%80%BB%E8%BE%91%EF%BC%9B%E4%BB%BB%E4%BD%95%E8%AF%AD%E8%A8%80%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%98%BE%E7%A4%BA%E5%A4%8D%E5%88%B6%E6%8C%89%E9%92%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加显示语言类型的功能；改变按钮文本显示逻辑；任何语言都可以显示复制按钮</h3>\n<p>主要针对原插件做出的一些 UI、功能上的适配，代码在<a href="https://github.com/towavephone/gatsby-remark-code-buttons/commit/90094cd1c6a4a6fa7253f61e898f8a832173d6a9" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>src/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65093631093320890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@@ -21,10 +21,6 @@ module.exports = function gatsbyRemarkCodeButtons(\n    const actions = qs.parse(params);\n    const { clipboard } = actions;\n\n-   if (!language) {\n-     return;\n-   }\n-\n    if (clipboard === \'false\') {\n      delete actions[\'clipboard\'];\n    } else {\n@@ -57,12 +53,12 @@ module.exports = function gatsbyRemarkCodeButtons(\n            >\n              <div\n                class=&quot;\\${buttonClass}&quot;\n-               data-tooltip=&quot;\\${tooltipText}&quot;\n+               \\${tooltipText ? \\`data-tooltip=&quot;\\${tooltipText}&quot;\\` : \'\'}\n              >\n-               \\${buttonText}\\${svgIcon}\n+               \\${[language, buttonText || svgIcon].filter((item) => item).join(\' \')}\n              </div>\n            </div>\n-           \\`.trim()\n+         \\`.trim()\n      };\n\n      parent.children.splice(index, 0, buttonNode);`, `65093631093320890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@@ -21,10 +21,6 @@ module.exports = function gatsbyRemarkCodeButtons(\n<span class="token unchanged"><span class="token prefix unchanged"> </span>   const actions = qs.parse(params);\n<span class="token prefix unchanged"> </span>   const { clipboard } = actions;\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   if (!language) {\n<span class="token prefix deleted">-</span>     return;\n<span class="token prefix deleted">-</span>   }\n<span class="token prefix deleted">-</span>\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (clipboard === \'false\') {\n<span class="token prefix unchanged"> </span>     delete actions[\'clipboard\'];\n<span class="token prefix unchanged"> </span>   } else {\n</span>@@ -57,12 +53,12 @@ module.exports = function gatsbyRemarkCodeButtons(\n<span class="token unchanged"><span class="token prefix unchanged"> </span>           >\n<span class="token prefix unchanged"> </span>             &lt;div\n<span class="token prefix unchanged"> </span>               class="${buttonClass}"\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>               data-tooltip="${tooltipText}"\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               ${tooltipText ? `data-tooltip="${tooltipText}"` : \'\'}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>             >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>               ${buttonText}${svgIcon}\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               ${[language, buttonText || svgIcon].filter((item) => item).join(\' \')}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>             &lt;/div>\n<span class="token prefix unchanged"> </span>           &lt;/div>\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>           `.trim()\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         `.trim()\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     };\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span>     parent.children.splice(index, 0, buttonNode);</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20755541684413960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 测试代码复制功能，这个代码块应该具有复制代码功能`, `20755541684413960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 测试代码复制功能，这个代码块应该具有复制代码功能</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="代码实时查看编辑-1"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E6%97%B6%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%BE%91-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码实时查看编辑</h2>\n<p>代码在<a href="https://github.com/towavephone/gatsby-remark-embedded-codesandbox/commit/6a1947c22566c6ad5baae33dabf99edd16f4c8eb" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h3 id="递归遍历文件夹；增加忽略文件功能"><a href="#%E9%80%92%E5%BD%92%E9%81%8D%E5%8E%86%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%9B%E5%A2%9E%E5%8A%A0%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>递归遍历文件夹；增加忽略文件功能</h3>\n<p>原插件不支持目录的读取，这里拓展了目录下也能递归读取的功能，同时也实现了默认忽略文件的功能</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36121557255383110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const DEFAULT_IGNORED_FILES = [\'node_modules\', \'package-lock.json\', \'yarn.lock\'];\n\nconst ignoredFilesSet = new Set(ignoredFiles);\n\nconst getAllFiles = (dirPath) =>\n   fs.readdirSync(dirPath).reduce((acc, file) => {\n      // 过滤文件立即跳出下一个\n      if (ignoredFilesSet.has(file)) return acc;\n      const relativePath = path.join(dirPath, file);\n      const isDirectory = fs.statSync(relativePath).isDirectory();\n      // 判断是目录继续递归遍历\n      const additions = isDirectory ? getAllFiles(relativePath) : [relativePath.replace(\\`\\${directory}/\\`, \'\')];\n      return [...acc, ...additions];\n   }, []);`, `36121557255383110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">DEFAULT_IGNORED_FILES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">,</span> <span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> ignoredFilesSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>ignoredFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getAllFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 过滤文件立即跳出下一个</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoredFilesSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> acc<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> relativePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> isDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 判断是目录继续递归遍历</span>\n      <span class="token keyword">const</span> additions <span class="token operator">=</span> isDirectory <span class="token operator">?</span> <span class="token function">getAllFiles</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>relativePath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>directory<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>acc<span class="token punctuation">,</span> <span class="token operator">...</span>additions<span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="默认模式为静态服务器"><a href="#%E9%BB%98%E8%AE%A4%E6%A8%A1%E5%BC%8F%E4%B8%BA%E9%9D%99%E6%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>默认模式为静态服务器</h3>\n<p>因为 codesandbox 需要明确模板类型，这里默认为静态模板，否则静态文件不能正常运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18226814279341318000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getFileExist = (fileList, filename = \'package.json\') => {\n   const found = fileList.filter((name) => name === filename);\n   return found.length > null;\n};\n\nif (!getFileExist(folderFiles, \'sandbox.config.json\')) {\n   sandboxFiles.push({\n      name: \'sandbox.config.json\',\n      content: \'{ &quot;template&quot;: &quot;static&quot; }\'\n   });\n}`, `18226814279341318000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> getFileExist <span class="token operator">=</span> <span class="token punctuation">(</span>fileList<span class="token punctuation">,</span> filename <span class="token operator">=</span> <span class="token string">\'package.json\'</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> found <span class="token operator">=</span> fileList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> name <span class="token operator">===</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> found<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getFileExist</span><span class="token punctuation">(</span>folderFiles<span class="token punctuation">,</span> <span class="token string">\'sandbox.config.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   sandboxFiles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'sandbox.config.json\'</span><span class="token punctuation">,</span>\n      content<span class="token punctuation">:</span> <span class="token string">\'{ "template": "static" }\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="codesandbox-请求方式改为-post-异步化"><a href="#codesandbox-%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E6%94%B9%E4%B8%BA-post-%E5%BC%82%E6%AD%A5%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>codesandbox 请求方式改为 post 异步化</h3>\n<p>原插件是基于 get 请求的，一旦上传文件过多就会报错，这里改为 post 请求就不再有请求体大小的限制，同时也要注意 post 的异步</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91761676811628840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const convertNodeToEmbedded = async (node, params, options = {}) => {\n   delete node.children;\n   delete node.position;\n   delete node.title;\n   delete node.url;\n\n   // merge the overriding options with the plugin one\n   const mergedOptions = { ...embedOptions, ...options };\n   const encodedEmbedOptions = queryString.stringify(mergedOptions);\n\n   const { sandbox_id } = await fetch(\'https://codesandbox.io/api/v1/sandboxes/define?json=1\', {\n      method: \'POST\',\n      headers: {\n         \'Content-Type\': \'application/json\',\n         Accept: \'application/json\'\n      },\n      body: params\n   }).then((x) => x.json());\n\n   const sandboxUrl = \\`https://codesandbox.io/embed/\\${sandbox_id}?\\${encodedEmbedOptions}\\`;\n   const embedded = getIframe(sandboxUrl);\n   node.type = \'html\';\n   node.value = embedded;\n\n   return node;\n};\n\nconst nodes = [];\nmap(markdownAST, (node, index, parent) => {\n   if (node.type === \'link\' && node.url.startsWith(protocol)) {\n      // split the url in base and query to allow user\n      // to customise embedding options on a per-node basis\n      const url = getUrlParts(node.url);\n      // get all files in the folder and generate\n      // the embeddeing parameters\n      const dir = getDirectoryPath(url.base);\n      const files = getFilesList(dir);\n      const params = createParams(files);\n      convertNodeToEmbedded(node, params, url.query);\n      const currentNode = convertNodeToEmbedded(node, params, url.query);\n      nodes.push(currentNode);\n   }\n\n   return node;\n});\n\n// 注意这里的异步化，必须等所有的请求成功响应才可继续遍历\nawait Promise.all(nodes);`, `91761676811628840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">convertNodeToEmbedded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>position<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n   <span class="token keyword">delete</span> node<span class="token punctuation">.</span>url<span class="token punctuation">;</span>\n\n   <span class="token comment">// merge the overriding options with the plugin one</span>\n   <span class="token keyword">const</span> mergedOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>embedOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> encodedEmbedOptions <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>mergedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> sandbox_id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'https://codesandbox.io/api/v1/sandboxes/define?json=1\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      method<span class="token punctuation">:</span> <span class="token string">\'POST\'</span><span class="token punctuation">,</span>\n      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token string">\'Content-Type\'</span><span class="token punctuation">:</span> <span class="token string">\'application/json\'</span><span class="token punctuation">,</span>\n         Accept<span class="token punctuation">:</span> <span class="token string">\'application/json\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      body<span class="token punctuation">:</span> params\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> sandboxUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://codesandbox.io/embed/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sandbox_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encodedEmbedOptions<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> embedded <span class="token operator">=</span> <span class="token function">getIframe</span><span class="token punctuation">(</span>sandboxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   node<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'html\'</span><span class="token punctuation">;</span>\n   node<span class="token punctuation">.</span>value <span class="token operator">=</span> embedded<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> node<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token function">map</span><span class="token punctuation">(</span>markdownAST<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> index<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'link\'</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// split the url in base and query to allow user</span>\n      <span class="token comment">// to customise embedding options on a per-node basis</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">getUrlParts</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// get all files in the folder and generate</span>\n      <span class="token comment">// the embeddeing parameters</span>\n      <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token function">getDirectoryPath</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token function">getFilesList</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token function">createParams</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">convertNodeToEmbedded</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> url<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> currentNode <span class="token operator">=</span> <span class="token function">convertNodeToEmbedded</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> params<span class="token punctuation">,</span> url<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> node<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注意这里的异步化，必须等所有的请求成功响应才可继续遍历</span>\n<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="实现效果-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h3>\n<p><a href="/gantt-component-optimization/#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C">甘特图组件源码优化</a></p>\n<h3 id="后续优化"><a href="#%E5%90%8E%E7%BB%AD%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续优化</h3>\n<p><a href="https://github.com/elboman/gatsby-remark-embedded-codesandbox/compare/master...towavephone:gatsby-remark-embedded-codesandbox:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></p>\n<ol>\n<li>增加上传文件忽略功能，支持 post 上传文件</li>\n<li>修复 json 解析报错</li>\n<li>限制请求并发防止 codesandbox 报错</li>\n</ol>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>复制功能需考虑兼容性、复制性能，可参考<a href="https://www.zhangxinxu.com/wordpress/2021/10/js-copy-paste-clipboard/" target="_blank" rel="nofollow noreferrer noopener">JS 复制文字到剪切板的极简实现及扩展</a></li>\n<li>代码实时查看编辑借助于第三方服务不够稳定，可自行搭建第三方服务或者参照 <a href="https://github.com/gfxfundamentals/live-editor" target="_blank" rel="nofollow noreferrer noopener">live-editor</a> 自建本地编辑器，必要时具有分享功能</li>\n</ol>\n<h1 id="其他优化"><a href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他优化</h1>\n<ol>\n<li>把 gatsby-remark-graph 配置化，以支持最新的 mermaid 特性，<a href="https://github.com/konsumer/gatsby-remark-graph/compare/master...towavephone:gatsby-remark-graph-towavephone:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n<li>gatsby-remark-design-system 支持文字转语音（利用百度翻译），<a href="https://github.com/LekoArts/gatsby-remark-design-system/compare/master...towavephone:gatsby-remark-design-system-towavephone:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n<li>img、video、iframe 增加懒加载功能，<a href="https://github.com/1kohei1/gatsby-remark-lazy-load/compare/master...towavephone:gatsby-remark-lazy-load:master" target="_blank" rel="nofollow noreferrer noopener">代码地址</a></li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/博客 Gatsby 插件改造/index.md absPath of file >>> MarkdownRemark",timeToRead:8,frontmatter:{date:"2023-11-28 16:17:27",path:"/gatsby-plugin-transformation/",tags:"前端, 源码优化, 预研",title:"博客 Gatsby 插件改造",draft:null}}],page:3,pagesSum:48,length:237,prevPath:"/page/2",nextPath:"/page/4"}}}});