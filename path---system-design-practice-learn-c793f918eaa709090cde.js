webpackJsonp([0x9d58e427306c],{1401:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h1>\n<p><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md" target="_blank" rel="nofollow noreferrer noopener">系统设计</a></p>\n<h1 id="系统设计主题：从这里开始"><a href="#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%EF%BC%9A%E4%BB%8E%E8%BF%99%E9%87%8C%E5%BC%80%E5%A7%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统设计主题：从这里开始</h1>\n<p>认识以下一般性原则</p>\n<h2 id="可扩展性视频讲座"><a href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E8%A7%86%E9%A2%91%E8%AE%B2%E5%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可扩展性视频讲座</h2>\n<p><a href="https://www.youtube.com/watch?v=-W9F__D3oY4" target="_blank" rel="nofollow noreferrer noopener">哈佛大学可扩展性讲座</a></p>\n<ul>\n<li>垂直扩展（Vertical scaling）</li>\n<li>水平扩展（Horizontal scaling）</li>\n<li>缓存</li>\n<li>负载均衡</li>\n<li>数据库复制</li>\n<li>数据库分区</li>\n</ul>\n<h2 id="可扩展性文章"><a href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E6%96%87%E7%AB%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可扩展性文章</h2>\n<ul>\n<li><a href="http://www.lecloud.net/post/7295452622/scalability-for-dummies-part-1-clones" target="_blank" rel="nofollow noreferrer noopener">Clones</a></li>\n<li><a href="http://www.lecloud.net/post/7994751381/scalability-for-dummies-part-2-database" target="_blank" rel="nofollow noreferrer noopener">数据库</a></li>\n<li><a href="http://www.lecloud.net/post/9246290032/scalability-for-dummies-part-3-cache" target="_blank" rel="nofollow noreferrer noopener">缓存</a></li>\n<li><a href="http://www.lecloud.net/post/9699762917/scalability-for-dummies-part-4-asynchronism" target="_blank" rel="nofollow noreferrer noopener">异步</a></li>\n</ul>\n<h2 id="接下来的步骤"><a href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E6%AD%A5%E9%AA%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接下来的步骤</h2>\n<p>接下来，我们将看看高阶的权衡和取舍:</p>\n<ul>\n<li>性能与可扩展性</li>\n<li>延迟与吞吐量</li>\n<li>可用性与一致性</li>\n</ul>\n<p>记住每个方面都面临取舍和权衡。</p>\n<p>然后，我们将深入更具体的主题，如 DNS、CDN 和负载均衡器。</p>\n<h1 id="性能与拓展性"><a href="#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%8B%93%E5%B1%95%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>性能与拓展性</h1>\n<p>如果服务性能的增长与资源的增加是成比例的，服务就是可扩展的。通常，提高性能意味着服务于更多的工作单元，另一方面，当数据集增长时，同样也可以处理更大的工作单位。</p>\n<p>另一个角度来看待性能与可扩展性:</p>\n<ul>\n<li>如果你的系统有性能问题，对于单个用户来说是缓慢的。</li>\n<li>如果你的系统有可扩展性问题，单个用户较快但在高负载下会变慢。</li>\n</ul>\n<h1 id="延迟与吞吐量"><a href="#%E5%BB%B6%E8%BF%9F%E4%B8%8E%E5%90%9E%E5%90%90%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟与吞吐量</h1>\n<p>延迟是执行操作或运算结果所花费的时间。</p>\n<p>吞吐量是单位时间内（执行）此类操作或运算的数量。</p>\n<p>通常，你应该以可接受级延迟下最大化吞吐量为目标。</p>\n<h1 id="可用性与一致性"><a href="#%E5%8F%AF%E7%94%A8%E6%80%A7%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可用性与一致性</h1>\n<h2 id="cap-理论"><a href="#cap-%E7%90%86%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CAP 理论</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-24-16-55-19-9a02d4dfaa4c704d2855b643a765986e-28759.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 500px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.6%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQoz41T2W7iQBD0//8SL1xCiOMhC8qCiWMOM9j4tsf4wHZt90RJYEHZHak17bampruqRmvbFs/WXZ3yIMrg+glcN0R1rb9+XfISZz/F2XaQphk0IQRGoxEGgwE6nQ56vR6Wy+UdaF03ONohXnULkfECcysQpzn8MMX+6GFl2Ni9/kLgetDquoaUEnEcq4iiSMUtYNO0OAgfxu4McfKoW6lqfBF3bR5c7CwPRXmFhh8WA/5NSfsPerSfwG73vKhUZJfiDuBKfH7US5QVdcjjGYaBzWajQtd15Hl+z2HTwLIDrN5OcIMUwgmVGDIrVP77TWBLY/uhhOZ5HubzOabTqYrJZPLAIQPuicO1cVKcsUAX6iglQOsUYGM6ikO+5L9HliSYtNaIZUW15ntkSqUrIH1H8avxgYY64GDFef8U40GUtnp+e12SFa4fojyo+MToXPOIOzYw85TRaLXMUFcV+fEC202I41BxqpmmiX6/j263i/F4jMVigeFwiNlspnZdXytQY+dgvjAh6KBx8BBtLfjnAO+UL1cH5VMG1yq6JUkSejapEqMoCvXNJg/DUJmee2byGYzj9umxyfdHX6nN9T+typkv/8jZMwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 24 16 55 19" title="" data-src="/static/2022-08-24-16-55-19-9a02d4dfaa4c704d2855b643a765986e-28759.png" data-srcset="/static/2022-08-24-16-55-19-9a02d4dfaa4c704d2855b643a765986e-6ac48.png 200w,\n/static/2022-08-24-16-55-19-9a02d4dfaa4c704d2855b643a765986e-4b8bf.png 400w,\n/static/2022-08-24-16-55-19-9a02d4dfaa4c704d2855b643a765986e-28759.png 500w" data-sizes="(max-width: 500px) 100vw, 500px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在一个分布式计算系统中，只能同时满足下列的两点:</p>\n<ul>\n<li>一致性 ─ 每次访问都能获得最新数据但可能会收到错误响应</li>\n<li>可用性 ─ 每次访问都能收到非错响应，但不保证获取到最新数据</li>\n<li>分区容错性 ─ 在任意分区网络故障的情况下系统仍能继续运行</li>\n</ul>\n<p>网络并不可靠，所以你应要支持分区容错性，并需要在软件可用性和一致性间做出取舍。</p>\n<h3 id="cp---一致性和分区容错性"><a href="#cp---%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CP - 一致性和分区容错性</h3>\n<p>等待分区节点的响应可能会导致延时错误。如果你的业务需求需要原子读写，CP 是一个不错的选择。</p>\n<h3 id="ap---可用性和分区容错性"><a href="#ap---%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AP - 可用性和分区容错性</h3>\n<p>响应节点上可用数据的最近版本可能并不是最新的。当分区解析完后，写入（操作）可能需要一些时间来传播。</p>\n<p>如果业务需求允许最终一致性，或当有外部故障时要求系统继续运行，AP 是一个不错的选择。</p>\n<h1 id="一致模式"><a href="#%E4%B8%80%E8%87%B4%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一致模式</h1>\n<p>有同一份数据的多份副本，我们面临着怎样同步它们的选择，以便让客户端有一致的显示数据。回想 CAP 理论中的一致性定义 ─ 每次访问都能获得最新数据但可能会收到错误响应</p>\n<h2 id="弱一致性"><a href="#%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>弱一致性</h2>\n<p>在写入之后，访问可能看到，也可能看不到（写入数据）。尽力优化之让其能访问最新数据。</p>\n<p>这种方式可以在 memcached 等系统中看到。弱一致性在 VoIP，视频聊天和实时多人游戏等真实用例中表现不错。打个比方，如果你在通话中丢失信号几秒钟时间，当重新连接时你是听不到这几秒钟所说的话的。</p>\n<h2 id="最终一致性"><a href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>最终一致性</h2>\n<p>在写入后，访问最终能看到写入数据（通常在数毫秒内）。数据被异步复制。</p>\n<p>DNS 和 email 等系统使用的是此种方式。最终一致性在高可用性系统中效果不错。</p>\n<h2 id="强一致性"><a href="#%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>强一致性</h2>\n<p>在写入后，访问立即可见。数据被同步复制。</p>\n<p>文件系统和关系型数据库（RDBMS）中使用的是此种方式。强一致性在需要记录的系统中运作良好。</p>\n<h1 id="可用性模式"><a href="#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可用性模式</h1>\n<p>有两种支持高可用性的模式: 故障切换（fail-over）和复制（replication）。</p>\n<h2 id="故障切换"><a href="#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>故障切换</h2>\n<h3 id="工作到备用切换（active-passive）"><a href="#%E5%B7%A5%E4%BD%9C%E5%88%B0%E5%A4%87%E7%94%A8%E5%88%87%E6%8D%A2%EF%BC%88active-passive%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作到备用切换（Active-passive）</h3>\n<p>关于工作到备用的故障切换流程是，工作服务器发送周期信号给待机中的备用服务器。如果周期信号中断，备用服务器切换成工作服务器的 IP 地址并恢复服务。</p>\n<p>宕机时间取决于备用服务器处于“热”待机状态还是需要从“冷”待机状态进行启动。只有工作服务器处理流量。</p>\n<p>工作到备用的故障切换也被称为主从切换。</p>\n<h3 id="双工作切换（active-active）"><a href="#%E5%8F%8C%E5%B7%A5%E4%BD%9C%E5%88%87%E6%8D%A2%EF%BC%88active-active%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>双工作切换（Active-active）</h3>\n<p>在双工作切换中，双方都在管控流量，在它们之间分散负载。</p>\n<p>如果是外网服务器，DNS 将需要对两方都了解。如果是内网服务器，应用程序逻辑将需要对两方都了解。</p>\n<p>双工作切换也可以称为主主切换。</p>\n<h3 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>故障切换需要添加额外硬件并增加复杂性。</li>\n<li>如果新写入数据在能被复制到备用系统之前，工作系统出现了故障，则有可能会丢失数据。</li>\n</ul>\n<h2 id="复制"><a href="#%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>复制</h2>\n<h3 id="主-─-从复制和主-─-主复制"><a href="#%E4%B8%BB-%E2%94%80-%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E4%B8%BB-%E2%94%80-%E4%B8%BB%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主 ─ 从复制和主 ─ 主复制</h3>\n<p>这个主题进一步探讨了数据库部分:</p>\n<ul>\n<li>主 ─ 从复制</li>\n<li>主 ─ 主复制</li>\n</ul>\n<h1 id="域名系统"><a href="#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>域名系统</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-24-17-52-24-07f6446dc7a772c3b39f2fa37edc918b-82fb5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 638px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.37617554858933%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACVklEQVQoz3WTz2/SYBjHuXjy5tmTif4ZXox/gRcvJiZejAdNiFs86KKJiTGabUxDDGbIlMUZs4MG9TCNY7ARNn4M6AotPzoptF2B0pbSH7Tv+9oXxoIZPnkPzfs+n+f5Pj/q6ff7giBIktRoNGS5U68fVqtljmuwLMvzvGVZCCEIIZpmHheLx+MEQWxv7+zt7bsnFkuQJB2LxYrFomEYIz/HcTqdjtRpy92u+6HrOoYnAtkQCAAICElyt+KSFEVBAEZvuqEVCDJbrKYIejeTa7daGHYlAWC7PgDkJOkcQVyo1c4qypWNn79y+YLrAaADEUBD4f6lpdc+P750nJPMuCiIVNPcUtWU2gtb1vq16zfW10LIBg7E8VtGpqqHgu98kS/fMTxU5EHTDVQqrConzOwnScqXtQ+sujGwtVEmNO4fhnW7zasZQUtz6o5iMlgpwoF7qEkyc9XoojlQjwUiNNl3DNO90ELW83Lz/EL6TEKccW8Mp0SLD/LNO0fKZ4F4CKgDW1H6fw6NOmvU63A8AgybtphmgixfaEklDZE1fZMznzPsJYq6XCpdlLWrhvhDCKwkb95K3vMW7noHFD2sDHicYd8Cy+GZF6FnH7993XrUFV5ZYkSg3zdLYbVx32wFb3tnVxd9qFJTOU7neGCax5lxDYZBR3+v+QOrb5Yjb1es8q56sCUXkjKR1Iopmdyfn/clU+nTq4ZlW7l8zTtLPnnKzD22otGRpBNX4Uh0V5VhGF3rj7s2AbsTt9ptV7+DF8bdh38Pgv8Z5+ScIUTTfgA4ttNPfwFNM/CdeOepqAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 24 17 52 24" title="" data-src="/static/2022-08-24-17-52-24-07f6446dc7a772c3b39f2fa37edc918b-82fb5.png" data-srcset="/static/2022-08-24-17-52-24-07f6446dc7a772c3b39f2fa37edc918b-38c7c.png 200w,\n/static/2022-08-24-17-52-24-07f6446dc7a772c3b39f2fa37edc918b-c00bc.png 400w,\n/static/2022-08-24-17-52-24-07f6446dc7a772c3b39f2fa37edc918b-82fb5.png 638w" data-sizes="(max-width: 638px) 100vw, 638px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>域名系统是把 www.example.com 等域名转换成 IP 地址。</p>\n<p>域名系统是分层次的，一些 DNS 服务器位于顶层。当查询（域名）IP 时，路由或 ISP 提供连接 DNS 服务器的信息。较底层的 DNS 服务器缓存映射，它可能会因为 DNS 传播延时而失效。DNS 结果可以缓存在浏览器或操作系统中一段时间，时间长短取决于存活时间 TTL。</p>\n<ul>\n<li>NS 记录（域名服务）─ 指定解析域名或子域名的 DNS 服务器。</li>\n<li>MX 记录（邮件交换）─ 指定接收信息的邮件服务器。</li>\n<li>A 记录（地址）─ 指定域名对应的 IP 地址记录。</li>\n<li>CNAME（规范）─ 一个域名映射到另一个域名或 CNAME 记录（example.com 指向 www.example.com）或映射到一个 A 记录。</li>\n</ul>\n<p>CloudFlare 和 Route 53 等平台提供管理 DNS 的功能。某些 DNS 服务通过集中方式来路由流量:</p>\n<ul>\n<li>\n<p>加权轮询调度</p>\n<ul>\n<li>防止流量进入维护中的服务器</li>\n<li>在不同大小集群间负载均衡</li>\n<li>A/B 测试</li>\n</ul>\n</li>\n<li>基于延迟路由</li>\n<li>基于地理位置路由</li>\n</ul>\n<h2 id="dns-缺点"><a href="#dns-%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DNS 缺点</h2>\n<ul>\n<li>虽说缓存可以减轻 DNS 延迟，但连接 DNS 服务器还是带来了轻微的延迟。</li>\n<li>虽然它们通常由政府，网络服务提供商和大公司管理，但 DNS 服务管理仍可能是复杂的。</li>\n<li>DNS 服务最近遭受 DDoS 攻击，阻止不知道 Twitter IP 地址的用户访问 Twitter。</li>\n</ul>\n<h1 id="cdn"><a href="#cdn" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CDN</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-25-16-41-38-f58e676fc57a9b0a2df241542fb55127-00a75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 710px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.70422535211269%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAB70lEQVQoz4VSa5OaMBT13/dT/0an037pqNPafbijdnV9oFAEeQkICwoCBsIjQKJF6a72U88kM5mbe+49OTeN0xviNAUQBlHIrXhBVupghrK8KNIMYUKOx2N1Pt2gQS7Roix3rgMisPX9ZrP13Ou5UUYwhjEsyqIkJEwzydDtrREncVWi4pzJ/sHbGIq9NTVTlXQtjCNRljhZhlnuwiyII816FRWle3/3qfOwUlaGqVT51tYA4aGRJJBRlOfFXBJZiuMDENh+YPkhRIXB87N2c/ab6Y+G3Z8/RuOhbq63tm7vTHtnpVnaOF4E+IHPjwfjQY9asqbrYUy2UTb58vnh4weKZpayOF2yw/lck/nBgvIAwOQiu346Jrg//PW93WKks1UBTBwAXccS19VbdFbg7kYvnQrt5kJWU5T/Nazal94nQdvYrpMilJelB7N9CGbUZDodS2tx7znKRp/QzGAyDcLoQrnpfKynhRAtCE+Pj47j7A+H5Wo1Gzz1+r0C4yo7RjmnGi6IKqvryTVu54aKkllyk25H36h1uTFNVwuVZZ2Q5gU1p2mWhXnxD7lWkkZg9DLMcVnrYdcqiK86vRC2Op2v31p+FF9l1ygIEWRp73undyfeaO+dPZhor1ZlzbVzfZ+gnFZUQvDpf0DF+dv9AZZHlm2YDREyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 25 16 41 38" title="" data-src="/static/2022-08-25-16-41-38-f58e676fc57a9b0a2df241542fb55127-00a75.png" data-srcset="/static/2022-08-25-16-41-38-f58e676fc57a9b0a2df241542fb55127-139c8.png 200w,\n/static/2022-08-25-16-41-38-f58e676fc57a9b0a2df241542fb55127-08302.png 400w,\n/static/2022-08-25-16-41-38-f58e676fc57a9b0a2df241542fb55127-00a75.png 710w" data-sizes="(max-width: 710px) 100vw, 710px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>内容分发网络（CDN）是一个全球性的代理服务器分布式网络，它从靠近用户的位置提供内容。通常 HTML/CSS/JS，图片和视频等静态内容由 CDN 提供，虽然亚马逊 CloudFront 等也支持动态内容。CDN 的 DNS 解析会告知客户端连接哪台服务器。</p>\n<p>将内容存储在 CDN 上可以从两个方面来提供性能:</p>\n<ul>\n<li>从靠近用户的数据中心提供资源</li>\n<li>通过 CDN 你的服务器不必真的处理请求</li>\n</ul>\n<h2 id="cdn-推送"><a href="#cdn-%E6%8E%A8%E9%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CDN 推送</h2>\n<p>当你服务器上内容发生变动时，推送 CDN 接受新内容。直接推送给 CDN 并重写 URL 地址以指向你的内容的 CDN 地址。你可以配置内容到期时间及何时更新。内容只有在更改或新增时才推送，流量最小化，但储存最大化。</p>\n<h2 id="cdn-拉取"><a href="#cdn-%E6%8B%89%E5%8F%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CDN 拉取</h2>\n<p>CDN 拉取是当第一个用户请求该资源时，从服务器上拉取资源。你将内容留在自己的服务器上并重写 URL 指向 CDN 地址。直到内容被缓存在 CDN 上为止，这样请求只会更慢。</p>\n<p>存活时间（TTL）决定缓存多久时间。CDN 拉取方式最小化 CDN 上的储存空间，但如果过期文件没有在实际更改之前被拉取，则会导致冗余的流量。</p>\n<p>高流量站点使用 CDN 拉取效果不错，因为只有最近请求的内容保存在 CDN 中，流量才能更平衡地分散。</p>\n<h2 id="缺点-1"><a href="#%E7%BC%BA%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h2>\n<ul>\n<li>CDN 成本可能因流量而异，可能在权衡之后你将不会使用 CDN。</li>\n<li>如果在 TTL 过期之前更新内容，CDN 缓存内容可能会过时。</li>\n<li>CDN 需要更改静态内容的 URL 地址以指向 CDN。</li>\n</ul>\n<h1 id="负载均衡器"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡器</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-25-16-56-03-0e090268f58bb51071e9393269b28a4d-f1168.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 796px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.08542713567839%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACSUlEQVQoz31Sy27TQBT1N7FhyQfwE6yQQGLTNUKIXTew66JdVK0qqrYIKlG1FaEVTorzcJOQxHLiOG7cpEmTycNvx56XuUlaYAFY46u5x3PmXt9zhLrR1VrtclWtqpqqGRDlchVSWD1kUcqSfz/C2HLjaDZCqJDPFy9l2ASB7/teFIaOH2JCl+copZwxiIz9vk6wvBBQy7Jq1Zr0XTJNE1DOOUTHn8UYOBxjUpAvxfSFlM0Xyz9mUcwWB+bkhDPbtmVZliRJVVW9qedyOc91gQvF4YIoxiEwoojgmJIY6gezGHChjya2ZRmGodRqxVIJmm9o2tXVFcV44gReGC0amTdZaVtfKoNUZdgeeJCGERaURkvXdVFMZ7O5fL7wTRQ7netr00QIDSYeVLj/C755Zjx7d7KyntnPtA6PTts3Q8EOSUh4QBI/ZjPCAkz9GXFDagds6hO8mDa8jLOChg7z3c+XvVLz9uu5eHM7Eiyjcp3aus3s231zOhqh4dRUz9Xj58bJk87R41FtfTrxB416u1xcO64/fXv6Yi39KWvKpWofTYVe5oOysaLtvERF0VNUp9VBjVRz76Hy/pG++wDJq67aJmOUYKx2nbNyN6MMynp/e/dAN3sCKBc4k9BzGb9TjzFOCU448cMgxvhPV4DSoPVyH2EiwCSWCUwFBJ8vfofMVQZv8CXC9y7MV1vZN7slURnYzlxJIVmw+d/ctyCz5P7rx1zn9fbF6kHpUGptbO7UjY7wH+sSykDMXw2BMymHsSdgmHrTGNvuT+SkwTT2Eu86AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 25 16 56 03" title="" data-src="/static/2022-08-25-16-56-03-0e090268f58bb51071e9393269b28a4d-f1168.png" data-srcset="/static/2022-08-25-16-56-03-0e090268f58bb51071e9393269b28a4d-ad772.png 200w,\n/static/2022-08-25-16-56-03-0e090268f58bb51071e9393269b28a4d-4f4c3.png 400w,\n/static/2022-08-25-16-56-03-0e090268f58bb51071e9393269b28a4d-f1168.png 796w" data-sizes="(max-width: 796px) 100vw, 796px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>负载均衡器将传入的请求分发到应用服务器和数据库等计算资源。无论哪种情况，负载均衡器将从计算资源来的响应返回给恰当的客户端。负载均衡器的效用在于:</p>\n<ul>\n<li>防止请求进入不好的服务器</li>\n<li>防止资源过载</li>\n<li>帮助消除单一的故障点</li>\n</ul>\n<p>负载均衡器可以通过硬件（昂贵）或 HAProxy 等软件来实现。增加的好处包括:</p>\n<ul>\n<li>SSL 终结 ─ 解密传入的请求并加密服务器响应，这样的话后端服务器就不必再执行这些潜在高消耗运算了。不需要在每台服务器上安装 X.509 证书。</li>\n<li>Session 留存 ─ 如果 Web 应用程序不追踪会话，发出 cookie 并将特定客户端的请求路由到同一实例。</li>\n</ul>\n<p>通常会设置采用工作 ─ 备用或双工作模式的多个负载均衡器，以免发生故障。</p>\n<p>负载均衡器能基于多种方式来路由流量:</p>\n<ul>\n<li>随机</li>\n<li>最少负载</li>\n<li>Session / Cookie</li>\n<li>轮询调度或加权轮询调度算法</li>\n<li>四层负载均衡</li>\n<li>七层负载均衡</li>\n</ul>\n<h2 id="四层负载均衡"><a href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>四层负载均衡</h2>\n<p>四层负载均衡根据传输层的信息来决定如何分发请求。通常，这会涉及来源，目标 IP 地址和请求头中的端口，但不包括数据包（报文）内容。四层负载均衡执行网络地址转换（NAT）来向上游服务器转发网络数据包。</p>\n<h2 id="七层负载均衡"><a href="#%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>七层负载均衡</h2>\n<p>七层负载均衡器根据监控应用层来决定怎样分发请求。这会涉及请求头的内容，消息和 cookie。七层负载均衡器终结网络流量，读取消息，做出负载均衡判定，然后传送给特定服务器。比如，一个七层负载均衡器能直接将视频流量连接到托管视频的服务器，同时将更敏感的用户账单流量引导到安全性更强的服务器。</p>\n<p>以损失灵活性为代价，四层负载均衡比七层负载均衡花费更少时间和计算资源，虽然这对现代商用硬件的性能影响甚微。</p>\n<h2 id="水平扩展"><a href="#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>水平扩展</h2>\n<p>负载均衡器还能帮助水平扩展，提高性能和可用性。使用商业硬件的性价比更高，并且比在单台硬件上垂直扩展更贵的硬件具有更高的可用性。相比招聘特定企业系统人才，招聘商业硬件方面的人才更加容易。</p>\n<h3 id="缺点-2"><a href="#%E7%BC%BA%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>\n<p>水平扩展引入了复杂度并涉及服务器复制</p>\n<ul>\n<li>服务器应该是无状态的，它们也不该包含像 session 或资料图片等与用户关联的数据。</li>\n<li>session 可以集中存储在数据库或持久化缓存（Redis、Memcached）的数据存储区中。</li>\n</ul>\n</li>\n<li>缓存和数据库等下游服务器需要随着上游服务器进行扩展，以处理更多的并发连接。</li>\n</ul>\n<h2 id="缺点-3"><a href="#%E7%BC%BA%E7%82%B9-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h2>\n<ul>\n<li>如果没有足够的资源配置或配置错误，负载均衡器会变成一个性能瓶颈。</li>\n<li>引入负载均衡器以帮助消除单点故障但导致了额外的复杂性。</li>\n<li>单个负载均衡器会导致单点故障，但配置多个负载均衡器会进一步增加复杂性。</li>\n</ul>\n<h1 id="反向代理（web-服务器）"><a href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%88web-%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>反向代理（web 服务器）</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-05-39-5bda4e308605b8d7840341f8b88c1707-58792.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 385px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.103896103896105%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABdElEQVQoz21R207CUBDk6/Q79FGjJPqi0e8hUUh49A0fTAiFlHIv0BYRyj3cCr1QCuPuGjUmbrI5ye6e2ZnZGCiiKMJms8F/YZkmskoeiqKg2mzB933sdjsEQYAwDLFarbBYLKTOODH+VKlUkcspaDR0WFYHy+VKhgMaWmy3aCUSaF9eoE2vu9/Dd10BnU6nKBQKyOfzsG1bajHDMASw2/0QME0rIZvNSnNLrO3RCNr9HebnZ9AfHzBmNp6HkPr1eh2qqkLXdck9LYspJMc0LQHkLBY1ZDKvIslxHNjDId5ub/ByeoJMPI7JfA6XWLNEBkmn00gmk6jVal+ALtEvqkXa1hDJzWaTpMzEvz3J9mjISKVQvr5C6/kJEdUPUSR9XsjesqLxePzrYa/XEx8mk8mfg/AAezmazaCWyggPx5/e8XhEp/MOg47GZFzPF1UCyFQ9zxUZ38OcHAzIXjrrNfr9vuRgMIRNL/s/J0+XdGnH2cjsJwJ+AGC7H7nrAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 05 39" title="" data-src="/static/2022-08-26-14-05-39-5bda4e308605b8d7840341f8b88c1707-58792.png" data-srcset="/static/2022-08-26-14-05-39-5bda4e308605b8d7840341f8b88c1707-f436a.png 200w,\n/static/2022-08-26-14-05-39-5bda4e308605b8d7840341f8b88c1707-58792.png 385w" data-sizes="(max-width: 385px) 100vw, 385px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>反向代理是一种可以集中地调用内部服务，并提供统一接口给公共客户的 web 服务器。来自客户端的请求先被反向代理服务器转发到可响应请求的服务器，然后代理再把服务器的响应结果返回给客户端。</p>\n<p>带来的好处包括：</p>\n<ul>\n<li>增加安全性 - 隐藏后端服务器的信息，屏蔽黑名单中的 IP，限制每个客户端的连接数。</li>\n<li>提高可扩展性和灵活性 - 客户端只能看到反向代理服务器的 IP，这使你可以增减服务器或者修改它们的配置。</li>\n<li>\n<p>本地终结 SSL 会话 - 解密传入请求，加密服务器响应，这样后端服务器就不必完成这些潜在的高成本的操作。</p>\n<ul>\n<li>免除了在每个服务器上安装 X.509 证书的需要</li>\n</ul>\n</li>\n<li>压缩 - 压缩服务器响应</li>\n<li>缓存 - 直接返回命中的缓存结果</li>\n<li>\n<p>静态内容 - 直接提供静态内容</p>\n<ul>\n<li>HTML/CSS/JS</li>\n<li>图片</li>\n<li>视频</li>\n<li>等等</li>\n</ul>\n</li>\n</ul>\n<h2 id="负载均衡与反向代理"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡与反向代理</h2>\n<ul>\n<li>当你有多个服务器时，部署负载均衡器非常有用。通常，负载均衡器将流量路由给一组功能相同的服务器上。</li>\n<li>即使只有一台 web 服务器或者应用服务器时，反向代理也有用，可以参考上一节介绍的好处。</li>\n<li>NGINX 和 HAProxy 等解决方案可以同时支持第七层反向代理和负载均衡。</li>\n</ul>\n<h2 id="缺点-4"><a href="#%E7%BC%BA%E7%82%B9-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h2>\n<ul>\n<li>引入反向代理会增加系统的复杂度。</li>\n<li>单独一个反向代理服务器仍可能发生单点故障，配置多台反向代理服务器（如故障转移）会进一步增加复杂度。</li>\n</ul>\n<h1 id="应用层"><a href="#%E5%BA%94%E7%94%A8%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>应用层</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-07-56-285902d2becc1057ed28ca5d12ebe3a3-c05da.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 772px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 28.238341968911918%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABQUlEQVQY012Q226CQABE+f/PaKwx0drWVlRYaVFESOW2IOKyFhHREi8IitaotPvUh85M5m2Sk6F+/pTnpFYIpf3+DiN/vqWb+EOZXa/nqf/VaDmCOFsuo5Wm7lWFJNZU6na55cTXW365kXGMUG7oiTvWICoUeRYox+NBkrX7kkA3Dcu0Y01J+2Lc7X5DgxqfsLo2YGLj7HN92s11PaDpUNdMe1JvOLwwCsOZKA4en5X2O7IsW3198QDALIPagGp5XMV4qo3oFgbDYIwl2XupzTUVWm6xJAJOD4Ipz0vlqtJkbTJGb9yi2wk7/FwQqHSXrjebzXaT7TOCnWCcm3CHXQf5dXoo9JzskA4GsFKVmbbtOCiBeiZLqdg7Wyb177DQhEuWiYam50d3hR7gYJ5fXDcoP+jks8Uiwp3OhGEnABDsXxIrMJkvE5QKAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 07 56" title="" data-src="/static/2022-08-26-14-07-56-285902d2becc1057ed28ca5d12ebe3a3-c05da.png" data-srcset="/static/2022-08-26-14-07-56-285902d2becc1057ed28ca5d12ebe3a3-fc8a7.png 200w,\n/static/2022-08-26-14-07-56-285902d2becc1057ed28ca5d12ebe3a3-51a5a.png 400w,\n/static/2022-08-26-14-07-56-285902d2becc1057ed28ca5d12ebe3a3-c05da.png 772w" data-sizes="(max-width: 772px) 100vw, 772px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>将 Web 服务层与应用层（也被称作平台层）分离，可以独立缩放和配置这两层。添加新的 API 只需要添加应用服务器，而不必添加额外的 web 服务器。</p>\n<p>单一职责原则提倡小型的，自治的服务共同合作。小团队通过提供小型的服务，可以更激进地计划增长。</p>\n<p>应用层中的工作进程也有可以实现异步化。</p>\n<h2 id="微服务"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务</h2>\n<p>与此讨论相关的话题是微服务，可以被描述为一系列可以独立部署的小型的，模块化服务。每个服务运行在一个独立的线程中，通过明确定义的轻量级机制通讯，共同实现业务目标。</p>\n<p>例如，Pinterest 可能有这些微服务： 用户资料、关注者、Feed 流、搜索、照片上传等。</p>\n<h2 id="服务发现"><a href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务发现</h2>\n<p>像 Consul，Etcd 和 Zookeeper 这样的系统可以通过追踪注册名、地址、端口等信息来帮助服务互相发现对方。Health checks 可以帮助确认服务的完整性和是否经常使用一个 HTTP 路径。Consul 和 Etcd 都有一个内建的 key-value 存储用来存储配置信息和其他的共享信息。</p>\n<h2 id="缺点-5"><a href="#%E7%BC%BA%E7%82%B9-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h2>\n<ul>\n<li>添加由多个松耦合服务组成的应用层，从架构、运营、流程等层面来讲将非常不同（相对于单体系统）。</li>\n<li>微服务会增加部署和运营的复杂度。</li>\n</ul>\n<h1 id="数据库"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据库</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-09-39-9d058efca6cfd154a846cb42bc8bdad4-23829.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 773px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.33376455368693%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAC7UlEQVQozy2TS28bZRiF5w+w6poFUPUPsGOFBEJcNhULWKAuUBUoVGxQkEBqF1RKuQWpJRJUhXJRoyY4pAk0Na6TpsZO7GQyviW1Pa4TT2xPZsbx+G7P2M7l4YthcRbfq6PzvdJ5XunJwm20L98hf2MU3axQlAPkv3kXbeIjSmoavdxA81xjZ+xttJnr6DUHfdFD/PO3iHz3MZVyhXa3T7Pl0Gq5SPnrF7Fel7DOP407gMbSJNZZif1zp2g92aR7AJUrb2C+JmZjZ+kBtV8+oyze5sgzmLohAgcisDsMlQq3r1K/cBr90xcp2hb26iz2h2fY++QFjGyMVu8Qa+ICtZFnsX74AKMPhamvsUeeo3DpZXS9hOMeUW90aTS7SEWtQGo1hC8o8yC9gz8ZZ/avafzBvwmqCv5UjHBylXsLHh4qMQLZFIGkgs83R3h9BbWQwrANBoND+kJSLPmYQCjCUjhOYtfmj4jKXX+InxeWmNtIs6Kq/PZomW9n7jC9/CdzMYV/EmGmvR6mfPNktITwLfDFZJgJj4xklauYxj5a0UTJ7rKayhPLFnkU3+a+kiO4tctsJMNiPMtkKEEwnREbyqyn1vEqATRrC084yEuXZd68qiC1Oz0cp0+16XJv02I+URIq4kvt4U8bLGds1vNVVnJltq02ke0KnqjOHbnAZrFKtW4QSm9xZa7C+P0qUr3pMHB7PEhUOf+9ys2HBupejcJ+g+XHNhd/ynHNq9MQDTri827X5e6ayfs3d5gO7eM6A5zuIa22M5R00g6HR9zy5Tn1/DnGZ9IM+oKVgwO8ssnpV0Z57ysvHfcYu9aCY/hxPs5TZ15ldHyWE2u90f6fQxHYEBv23T7KdodLvyZYTNZxewfDTdRSh7GpDL+HTHr9Y068PeGN5hpcvrHEoqKLZo+GuDQF1EMOO4LyYkkUokRJp7OEwxFyOQ3TstnY+G8mywrJzRTtTh9DXFM0GiOjbrO2JpPXSnSdwTDsRP8CJSHk/QNZ/AAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 09 39" title="" data-src="/static/2022-08-26-14-09-39-9d058efca6cfd154a846cb42bc8bdad4-23829.png" data-srcset="/static/2022-08-26-14-09-39-9d058efca6cfd154a846cb42bc8bdad4-a6bd7.png 200w,\n/static/2022-08-26-14-09-39-9d058efca6cfd154a846cb42bc8bdad4-ee980.png 400w,\n/static/2022-08-26-14-09-39-9d058efca6cfd154a846cb42bc8bdad4-23829.png 773w" data-sizes="(max-width: 773px) 100vw, 773px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="关系型数据库管理系统（rdbms）"><a href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%88rdbms%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关系型数据库管理系统（RDBMS）</h2>\n<p>像 SQL 这样的关系型数据库是一系列以表的形式组织的数据项集合。</p>\n<p>ACID 用来描述关系型数据库事务的特性。</p>\n<ul>\n<li>原子性 - 每个事务内部所有操作要么全部完成，要么全部不完成。</li>\n<li>一致性 - 任何事务都使数据库从一个有效的状态转换到另一个有效状态。</li>\n<li>隔离性 - 并发执行事务的结果与顺序执行事务的结果相同。</li>\n<li>持久性 - 事务提交后，对系统的影响是永久的。</li>\n</ul>\n<p>关系型数据库扩展包括许多技术：主从复制、主主复制、联合、分片、非规范化和 SQL 调优。</p>\n<h3 id="主从复制"><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主从复制</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-10-32-1e6a43bb70e362edf1a20f6e51bba906-c1ca4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 752px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.76063829787235%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABjUlEQVQoz3WSS4+CQBCE5///Cj35Jzxw8aKuxmgIiu834gMUXEHZ2Y9pMzGbbB8640xXdVWh+jH1fD7loLUuioKe5/n9fn88HlmWvV4vDt+m5EBP01Rtt9sgCI7HI73f7w8GA/p4PI7jmAlIQV4uF8/zZrPZZDKJokibgl31ej0Aw+GQt+v1ejqdIlMA6NxAMZ1Oq9VqpVKp1Wrr9RqkiFVQAnZdFyb9Ufxkp7hAV6PRcBynXq/vdjsZKMGfgMKUnLEqdLfbDUcYWSwW+/0eOWTxlq3/KcCSopi0cYLByxucJElqimnCw7NVxQ1ICc8qooSulE2Aq9UKJ/P53Pd9YuNLIAxSYucJRkJCvOynw8Wh3PxlqtvtHg4HsW0/I0Q8NZvNVqsFl/0LyOYSDCsLCQORm83mUzZpkzMh0W2iIEejEUKYVwiTZ2Rzi4vE1Pl8Zg76zBTTaJEB9glEoardbiNPZLNNcgaPcwvmgE9gzHc6HeKAXaGTSMIw/POpmMY8MPwLBQfolsslWaAXIb/PUtohsA8mEgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 10 32" title="" data-src="/static/2022-08-26-14-10-32-1e6a43bb70e362edf1a20f6e51bba906-c1ca4.png" data-srcset="/static/2022-08-26-14-10-32-1e6a43bb70e362edf1a20f6e51bba906-d3808.png 200w,\n/static/2022-08-26-14-10-32-1e6a43bb70e362edf1a20f6e51bba906-471e5.png 400w,\n/static/2022-08-26-14-10-32-1e6a43bb70e362edf1a20f6e51bba906-c1ca4.png 752w" data-sizes="(max-width: 752px) 100vw, 752px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>主库同时负责读取和写入操作，并复制写入到一个或多个从库中，从库只负责读操作。树状形式的从库再将写入复制到更多的从库中去。如果主库离线，系统可以以只读模式运行，直到某个从库被提升为主库或有新的主库出现。</p>\n<h4 id="缺点-6"><a href="#%E7%BC%BA%E7%82%B9-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>将从库提升为主库需要额外的逻辑。</li>\n<li>主从复制和主主复制共同的问题。</li>\n</ul>\n<h3 id="主主复制"><a href="#%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主主复制</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-13-53-b29f7e77c781de59dcbfaf06d57bae70-d985b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 740px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQoz32SSYvCQBCF+///BPUgOXjUgycvQgQRURGjGDVuMQpuSYyaxC1xPmxmMgRm6lD08urVq9ct3v/G7XbzPI98v99lJoIgCMPwdDoJ27Yvl4v3Cd/31+v1ZrNZrVbL5ZKr5/MZRRFo1tfrlQxM8gIWpmnO53PzEyw6nU673dY0rdvtDgaD4/G43+9rtVq1WlVVtV6vj0ajpBjQeDyeTCa9Xo99SjYnj8ej1WplMpl8Pp/L5ZrNJudxHCNE6LrOvtFozGYzeZqaGdmMR9tCoYCEw+GQdE61in+FLMYhFlCcz2cEDofDfr/PXLAIQK/XC2NSPX86y2LEG4aBW1BgMJrJwrKs3W4HzXa7dRwHVrixCm4MpxJqbulJsQRLXp5A4DCGMfB0OsVwCsCRF4sFW6CQViqVYrFYKpXK5TKkycxYhc/yhdCWks1nIKMFtxVFyWazwJJi13XlIzPMX4aRre+gBvO4ZeYvHpdcQivuQjAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 13 53" title="" data-src="/static/2022-08-26-14-13-53-b29f7e77c781de59dcbfaf06d57bae70-d985b.png" data-srcset="/static/2022-08-26-14-13-53-b29f7e77c781de59dcbfaf06d57bae70-7a5d1.png 200w,\n/static/2022-08-26-14-13-53-b29f7e77c781de59dcbfaf06d57bae70-99472.png 400w,\n/static/2022-08-26-14-13-53-b29f7e77c781de59dcbfaf06d57bae70-d985b.png 740w" data-sizes="(max-width: 740px) 100vw, 740px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>两个主库都负责读操作和写操作，写入操作时互相协调。如果其中一个主库挂机，系统可以继续读取和写入。</p>\n<h4 id="缺点-7"><a href="#%E7%BC%BA%E7%82%B9-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>你需要添加负载均衡器或者在应用逻辑中做改动，来确定写入哪一个数据库。</li>\n<li>多数主-主系统要么不能保证一致性（违反 ACID），要么因为同步产生了写入延迟。</li>\n<li>随着更多写入节点的加入和延迟的提高，如何解决冲突显得越发重要。</li>\n<li>主从复制和主主复制共同的问题。</li>\n</ul>\n<h3 id="缺点-8"><a href="#%E7%BC%BA%E7%82%B9-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>如果主库在将新写入的数据复制到其他节点前挂掉，则有数据丢失的可能。</li>\n<li>写入会被重放到负责读取操作的副本。副本可能因为过多写操作阻塞住，导致读取功能异常。</li>\n<li>读取从库越多，需要复制的写入数据就越多，导致更严重的复制延迟。</li>\n<li>在某些数据库系统中，写入主库的操作可以用多个线程并行写入，但读取副本只支持单线程顺序地写入。</li>\n<li>复制意味着更多的硬件和额外的复杂度。</li>\n</ul>\n<h3 id="联合"><a href="#%E8%81%94%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>联合</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-17-09-bf010bef31f17e2c4d4343bc2bd5f310-24f57.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 471px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 148.83227176220808%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAAsSAAALEgHS3X78AAAEcUlEQVQ4y41Ua0xbZRg+f/3nH7dsy1xi9McUnRqnWZjReAevU5Ytw8hC2AQtM2M/dCROE3fJvAQnKvM2BcrGuLUgg7KuLZTeS3taCr1AuThoWcspbU9LT8/1821P6Qgx0pMvX77vy3ne7znP85wXS9N8flBpDmaaEcQFyyJY/2YhTvTe/kK5tBhjEEKteKS2P3BaEfATFMbzSEC5gbIzx+dmnkPRFDrWbHn/j7H3fhrV+yNknJR0T799tuONRp1qJokNKpS4Y9w14R53uUe0etzhgkVnZ4/RYOFYPs6jF2rOb32kePv+g0p3eNLjOfDD6I5n3nqo4uLQLIVZLLZRnVFvMKtUGrVmZOimyjXhkcn7tKMGjhVIGpV9I7+/tOaJ49+6w2mgJunyPnjws901Teq5FAZ7YJ4hn+UNs0gbFgybGdMrnNIX73Msdrpil03E71ZCPZs0L9IxisdEhWhGnIW1bWaIYKiLOEZpch1t85RfwSXyuXiag2tATkx8439GihaggC+OnpY07nzq5de/Hw6lMsg0UwA4zQjwGZOE8Hhdy66y+he/VhFUxgi6EDBFC4APJ1ipnWg0hK87iATFi4ebgwUe/efDcQjL67ReKljn1OKQa2lV5iQGPSshkhE45A1Rclds0BMPkyzGcrls5eplbYNHBEOhc5pglSxQ2bOg8sfgvEEfrrg6daTN2++OYctEbFRnMBjNWp3eZB6bmPRphrUtrVIykQJikOaj33U/dvjThw/Xt474/pnxf9iKFx2o3VN9qc0ZxVaiiZtK9cCA4u/+AY1GC/Eyma2dXT0xclUEH7rQfs/Oovv2lXWY55HASjrc216q2lp64k8bkaGNNtAWcrTBDNhetQYlzeb6LqdpngzGmRYbcbLVeKrdZllMYXm1MoLRGwWDMIAkgiA4J6e/vLXw0UD4K3UokuLEaza3KknxLMN5lxLvXFIXV19480ed+06KZXhI3uZgIC+w/BKD9p789d6i55481TK1AoFFBYUEwOB2eBUdkzpKGobLr9gXohCAwuJJZ/+NNC1EKeF2QiBSmTshnlSedj5bG/7HjGbr7ICo3k2rkL2ZF3KdYO1wzapsPCOr3DV85RfjnUFvDE5Iiu8aj142RRTeGEYmKJmsD+Kh0xtvDAxZrXbFkPKWSsNlJYEqeCB1RDp1tGOupmc6QXFTy+nya76yJn2tfBZLJCn/zNzEpBe6FwyAqdUj0MwybjMZGmNB5oGSqt2llc9Wn5sJEHLdRPHptl373y1r1GZpZzOF487evhs2uyPbyYRcG0DIGqR3vFa9bW/p83U/w4GPSO87I9tSfOjV872YqBb8SXZ8HNqwze6EUtD0898cTrJ/WUMXFf7reMgRWNXMkE2GYINyutsVuWuVmGqossEqls3cT5FRqXq8qm+pUhZoxpfFPrvOZwatd2iDz/B2m3350Yqzez448/nQPNxBFRJPsY0BuHlseUvJJ9tfqa7rdsOWZgoDi8oZ5pMfd3qPt7ulthC4APH8FzPOG8dqv0rwAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 17 09" title="" data-src="/static/2022-08-26-14-17-09-bf010bef31f17e2c4d4343bc2bd5f310-24f57.png" data-srcset="/static/2022-08-26-14-17-09-bf010bef31f17e2c4d4343bc2bd5f310-ea629.png 200w,\n/static/2022-08-26-14-17-09-bf010bef31f17e2c4d4343bc2bd5f310-c47ea.png 400w,\n/static/2022-08-26-14-17-09-bf010bef31f17e2c4d4343bc2bd5f310-24f57.png 471w" data-sizes="(max-width: 471px) 100vw, 471px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>联合（或按功能划分）将数据库按对应功能分割。例如，你可以有三个数据库：论坛、用户和产品，而不仅是一个单体数据库，从而减少每个数据库的读取和写入流量，减少复制延迟。较小的数据库意味着更多适合放入内存的数据，进而意味着更高的缓存命中几率。没有只能串行写入的中心化主库，你可以并行写入，提高负载能力。</p>\n<h4 id="缺点-9"><a href="#%E7%BC%BA%E7%82%B9-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>如果你的数据库模式需要大量的功能和数据表，联合的效率并不好。</li>\n<li>你需要更新应用程序的逻辑来确定要读取和写入哪个数据库。</li>\n<li>用 server link 从两个库联结数据更复杂。</li>\n<li>联合需要更多的硬件和额外的复杂度。</li>\n</ul>\n<h3 id="分片"><a href="#%E5%88%86%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分片</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-18-22-1c3db2aadf180c667214441f0893a5db-0f51d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 586px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 112.45733788395904%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAACFklEQVQ4y5VV147CQAzc//+wnJAQTyA6pBEgDQKEDr6M7xyZBXSHpWibPTsu6xi6E/GH4X6vx6IoaLVa0Xq9pu12y3P5LpdLrSc2IkYA9WGWZVSsC14fDgcqy5LKXclnuCiKos8AF4sFzedznkfziLrdHk2nbm3kuu6DN4+ASjTD4XDIbDAXydKM+v1+BT79m6GwhNxuN2bRbrep0+lQo9GgVqtFvV6vZv6K3RPDd0qbzYYZ+75PnufRbrf7jCFGsMQHSdOUXUfGMZ7P5/8B2uUDOZ1ONJuFXDovPbm/cVluE0WUy3g8Js/1KIkTmoUhDQbDOkm2/gOg3tSJGY1G5DgOJ+Try6Fms8k1abur7Y3e1GDH4/HX3RkDAhyskRCc2QRkNDb1/X7PwccIY2QYgkQgjtfrlUfZt+0fXAaADj6MwFbOsZYMw3VdPk8u48HjZYgASNZaR1+IczDWTGtA3CixkTrUbonbwgoCfZul0e5IIQsbW1niqPfAUifmLSCMdYnYDLVnyH4NiAniYBuDoVaUvVd6mrWRW5IkebpZty6Jmd4TXdjKRSYIAi7eyWTCI9iiwUpnCcKAazKOY4IuChwdG3sAxBytzvd/cAyaZZ7j37GisHqviCUO8jyvvoz7H8BgKP8UrNMs5Zj61SXQxWPAhQYs0qoTZ5UCjBAPgMAN7C2XS56DNdxF18YaIAAEibhaAxD231PUrx6d0pRQAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 18 22" title="" data-src="/static/2022-08-26-14-18-22-1c3db2aadf180c667214441f0893a5db-0f51d.png" data-srcset="/static/2022-08-26-14-18-22-1c3db2aadf180c667214441f0893a5db-e7e34.png 200w,\n/static/2022-08-26-14-18-22-1c3db2aadf180c667214441f0893a5db-15827.png 400w,\n/static/2022-08-26-14-18-22-1c3db2aadf180c667214441f0893a5db-0f51d.png 586w" data-sizes="(max-width: 586px) 100vw, 586px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>分片将数据分配在不同的数据库上，使得每个数据库仅管理整个数据集的一个子集。以用户数据库为例，随着用户数量的增加，越来越多的分片会被添加到集群中。</p>\n<p>类似联合的优点，分片可以减少读取和写入流量，减少复制并提高缓存命中率。也减少了索引，通常意味着查询更快，性能更好。如果一个分片出问题，其他的仍能运行，你可以使用某种形式的冗余来防止数据丢失。类似联合，没有只能串行写入的中心化主库，你可以并行写入，提高负载能力。</p>\n<p>常见的做法是用户姓氏的首字母或者用户的地理位置来分隔用户表。</p>\n<h4 id="缺点-10"><a href="#%E7%BC%BA%E7%82%B9-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>你需要修改应用程序的逻辑来实现分片，这会带来复杂的 SQL 查询。</li>\n<li>\n<p>分片不合理可能导致数据负载不均衡。例如，被频繁访问的用户数据会导致其所在分片的负载相对其他分片高。</p>\n<ul>\n<li>再平衡会引入额外的复杂度。基于一致性哈希的分片算法可以减少这种情况。</li>\n</ul>\n</li>\n<li>联结多个分片的数据操作更复杂。</li>\n<li>分片需要更多的硬件和额外的复杂度。</li>\n</ul>\n<h3 id="非规范化"><a href="#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>非规范化</h3>\n<p>非规范化试图以写入性能为代价来换取读取性能。在多个表中冗余数据副本，以避免高成本的联结操作。一些关系型数据库，比如 PostgreSQL 和 Oracle 支持物化视图，可以处理冗余信息存储和保证冗余副本一致。</p>\n<p>当数据使用诸如联合和分片等技术被分割，进一步提高了处理跨数据中心的联结操作复杂度。非规范化可以规避这种复杂的联结操作。</p>\n<p>在多数系统中，读取操作的频率远高于写入操作，比例可达到 100:1，甚至 1000:1。需要复杂的数据库联结的读取操作成本非常高，在磁盘操作上消耗了大量时间。</p>\n<h4 id="缺点-11"><a href="#%E7%BC%BA%E7%82%B9-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>数据会冗余。</li>\n<li>约束可以帮助冗余的信息副本保持同步，但这样会增加数据库设计的复杂度。</li>\n<li>非规范化的数据库在高写入负载下性能可能比规范化的数据库差。</li>\n</ul>\n<h3 id="sql-调优"><a href="#sql-%E8%B0%83%E4%BC%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL 调优</h3>\n<p>SQL 调优是一个范围很广的话题，有很多相关的书可以作为参考。</p>\n<p>利用基准测试和性能分析来模拟和发现系统瓶颈很重要。</p>\n<ul>\n<li>基准测试 - 用 ab 等工具模拟高负载情况。</li>\n<li>性能分析 - 通过启用如慢查询日志等工具来辅助追踪性能问题。</li>\n</ul>\n<p>基准测试和性能分析可能会指引你到以下优化方案。</p>\n<h4 id="改进模式"><a href="#%E6%94%B9%E8%BF%9B%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>改进模式</h4>\n<ul>\n<li>为了实现快速访问，MySQL 在磁盘上用连续的块存储数据。</li>\n<li>\n<p>使用 CHAR 类型存储固定长度的字段，不要用 VARCHAR。</p>\n<ul>\n<li>CHAR 在快速、随机访问时效率很高。如果使用 VARCHAR，如果你想读取下一个字符串，不得不先读取到当前字符串的末尾。</li>\n</ul>\n</li>\n<li>使用 TEXT 类型存储大块的文本，例如博客正文。TEXT 还允许布尔搜索。使用 TEXT 字段需要在磁盘上存储一个用于定位文本块的指针。</li>\n<li>使用 INT 类型存储高达 2^32 或 40 亿的较大数字。</li>\n<li>使用 DECIMAL 类型存储货币可以避免浮点数表示错误。</li>\n<li>避免使用 BLOBS 存储实际对象，而是用来存储存放对象的位置。</li>\n<li>VARCHAR(255) 是以 8 位数字存储的最大字符数，在某些关系型数据库中，最大限度地利用字节。</li>\n<li>在适用场景中设置 NOT NULL 约束来提高搜索性能。</li>\n</ul>\n<h4 id="使用正确的索引"><a href="#%E4%BD%BF%E7%94%A8%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%B4%A2%E5%BC%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用正确的索引</h4>\n<ul>\n<li>你正查询（SELECT、GROUP BY、ORDER BY、JOIN）的列如果用了索引会更快。</li>\n<li>索引通常表示为自平衡的 B 树，可以保持数据有序，并允许在对数时间内进行搜索，顺序访问，插入，删除操作。</li>\n<li>设置索引，会将数据存在内存中，占用了更多内存空间。</li>\n<li>写入操作会变慢，因为索引需要被更新。</li>\n<li>加载大量数据时，禁用索引再加载数据，然后重建索引，这样也许会更快。</li>\n</ul>\n<h4 id="避免高成本的联结操作"><a href="#%E9%81%BF%E5%85%8D%E9%AB%98%E6%88%90%E6%9C%AC%E7%9A%84%E8%81%94%E7%BB%93%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免高成本的联结操作</h4>\n<ul>\n<li>有性能需要，可以进行非规范化。</li>\n</ul>\n<h4 id="分割数据表"><a href="#%E5%88%86%E5%89%B2%E6%95%B0%E6%8D%AE%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分割数据表</h4>\n<ul>\n<li>将热点数据拆分到单独的数据表中，可以有助于缓存。</li>\n</ul>\n<h4 id="调优查询缓存"><a href="#%E8%B0%83%E4%BC%98%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调优查询缓存</h4>\n<ul>\n<li>在某些情况下，查询缓存可能会导致性能问题。</li>\n</ul>\n<h2 id="nosql"><a href="#nosql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NoSQL</h2>\n<p>NoSQL 是键-值数据库、文档型数据库、列型数据库或图数据库的统称。数据库是非规范化的，表联结大多在应用程序代码中完成。大多数 NoSQL 无法实现真正符合 ACID 的事务，支持最终一致。</p>\n<p>BASE 通常被用于描述 NoSQL 数据库的特性。相比 CAP 理论，BASE 强调可用性超过一致性。</p>\n<ul>\n<li>基本可用 - 系统保证可用性。</li>\n<li>软状态 - 即使没有输入，系统状态也可能随着时间变化。</li>\n<li>最终一致性 - 经过一段时间之后，系统最终会变一致，因为系统在此期间没有收到任何输入。</li>\n</ul>\n<p>除了在 SQL 还是 NoSQL 之间做选择，了解哪种类型的 NoSQL 数据库最适合你的用例也是非常有帮助的。我们将在下一节中快速了解下键-值存储、文档型存储、列型存储和图存储数据库。</p>\n<h3 id="键-值存储"><a href="#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>键-值存储</h3>\n<blockquote>\n<p>抽象模型：哈希表</p>\n</blockquote>\n<p>键-值存储通常可以实现 O(1) 时间读写，用内存或 SSD 存储数据。数据存储可以按字典顺序维护键，从而实现键的高效检索。键-值存储可以用于存储元数据。</p>\n<p>键-值存储性能很高，通常用于存储简单数据模型或频繁修改的数据，如存放在内存中的缓存。键-值存储提供的操作有限，如果需要更多操作，复杂度将转嫁到应用程序层面。</p>\n<p>键-值存储是如文档存储，在某些情况下，甚至是图存储等更复杂的存储系统的基础。</p>\n<h3 id="文档存储"><a href="#%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文档存储</h3>\n<blockquote>\n<p>抽象模型：将文档作为值的键-值存储</p>\n</blockquote>\n<p>文档类型存储以文档（XML、JSON、二进制文件等）为中心，文档存储了指定对象的全部信息。文档存储根据文档自身的内部结构提供 API 或查询语句来实现查询。请注意，许多键-值存储数据库有用值存储元数据的特性，这也模糊了这两种存储类型的界限。</p>\n<p>基于底层实现，文档可以根据集合、标签、元数据或者文件夹组织。尽管不同文档可以被组织在一起或者分成一组，但相互之间可能具有完全不同的字段。</p>\n<p>MongoDB 和 CouchDB 等一些文档类型存储还提供了类似 SQL 语言的查询语句来实现复杂查询。DynamoDB 同时支持键-值存储和文档类型存储。</p>\n<p>文档类型存储具备高度的灵活性，常用于处理偶尔变化的数据。</p>\n<h3 id="列型存储"><a href="#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列型存储</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-23-39-66cf9374ef5294eb9c59cf548d8d891f-49396.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 526px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.06463878326996%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABwklEQVQY00WO62+aABTF+a/3aVm2Ls2sXdEs2ersQ9v1JbOFGp/YYqU+UEFUFBBaWBUzFURh2mwfvKMfliW/nJycc29yEHh+BtMEy/rPdAK1GjAMNLkX5TigKHh4gLkN5hQs8x8WAradLjOb8QRKpD/iqZ3rLErkAgTpx5LvI7GNw4uNIwzFsx4B3MvzXoV6Bs+Op97zzCok81/juegVGcUyoW9RFDsInod9e35f2Le1v7W9+yGARYL48U7sYPv0M4qFgpd7wVjo56OKeLP1ltIdLntPC1mxRfqsJ4ZKpUicOMndXdEsydHxNvuF74TL1dD3xGmByVTahWKdnFtTBHRdEfWKNi+KBq85WuHQ6fk1FifT7ZtU/e5G6lO1we07jXo7qu5S17X6bbdT1vii7NguAjwviT+Y4ao+cLlHV6X2jcabPhPD4/f5VIXjRn0ioydeDanXZuVT5iR3j9M8ybM5diEpCKjqUJDFviGrRl/QDfpy3LsYdGm2JLQYQRFHo2R2VD0yWuczMcUWOU3QPdSOthJlBNZrcF1YzMFZgD2DuQPaE7BNkCVoNEASYTIBdwXOct3sQIuHyRiWv16O//z+C38Pfw1Tkt1KAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 23 39" title="" data-src="/static/2022-08-26-14-23-39-66cf9374ef5294eb9c59cf548d8d891f-49396.png" data-srcset="/static/2022-08-26-14-23-39-66cf9374ef5294eb9c59cf548d8d891f-68c83.png 200w,\n/static/2022-08-26-14-23-39-66cf9374ef5294eb9c59cf548d8d891f-d339c.png 400w,\n/static/2022-08-26-14-23-39-66cf9374ef5294eb9c59cf548d8d891f-49396.png 526w" data-sizes="(max-width: 526px) 100vw, 526px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<blockquote>\n<p>抽象模型：嵌套的 <code class="language-text">ColumnFamily&lt;RowKey, Columns&lt;ColKey, Value, Timestamp&gt;&gt;</code> 映射</p>\n</blockquote>\n<p>类型存储的基本数据单元是列（名/值对）。列可以在列族（类似于 SQL 的数据表）中被分组。超级列族再分组普通列族。你可以使用行键独立访问每一列，具有相同行键值的列组成一行。每个值都包含版本的时间戳用于解决版本冲突。</p>\n<p>Google 发布了第一个列型存储数据库 Bigtable，它影响了 Hadoop 生态系统中活跃的开源数据库 HBase 和 Facebook 的 Cassandra。像 BigTable，HBase 和 Cassandra 这样的存储系统将键以字母顺序存储，可以高效地读取键列。</p>\n<p>列型存储具备高可用性和高可扩展性。通常被用于大数据相关存储。</p>\n<h3 id="图数据库"><a href="#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图数据库</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-24-30-3321c91fe6cde7df533e1a2035aaeafa-571e1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 584px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.34931506849314%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACU0lEQVQoz32SfU/aUBTG+dr7BG5/LFNcIhpm5pQpy7RgBSulrjCpFmzBSilIqbTSQl9ErEhbSuturSNLNneS3tx7c3/nOT3niTy9Er7v/3XjgVWVJRxOYOnNG6EZefpvgBSe54Vb8Lmum099KeZSZ4WjfGrj3/BsNtN13bKs8Dgej8FRHajQ3vet2DsM2c/nstlv8UiYfl5kqKNpGkVRGIYVi8VKpVKv1xmGyaE5KA0fpZOZndVMcg1H9iJz7LnAgLRtG2AQBAHMMAxQqqIoNE23uMZEU7pMdT++3LigHMcJlKeO8zh+CFOYpgneASnAgLyDwYAkSZZlzdHI1vt8CWvTZZm/CgUjel/+mU0WDhJc9bTBcSiKXjKMJEnn5+flchlBEKAvy7JrW0aHaxL4yDD4CvFoaAGc29tA4SRRzMPbseXF99ULpitJYq/nuO7w7g78aqfT0XTdse0b+rR3xaldvk38mE7GAZxOrBwfQqcnOLy9iibW1Gve1NX7nnjfu+7zrcfJZD5zc2i0K4TYYG5F3vdmAcxQZ7ufl+CvK+j+Tq1UqJdwRWhLrUajdMximX6TCcmRqtSyu/l49FbtA9J/bm3QMEWW+CsunOpQG3RZRpOurfEDaFK3ybZpkqfIk43lKrRJJmIcjoSzCeA/RhVsJreaIbTaZ4VOjRIYWmyyl0QBji6QWzHxosLlD/BPS479Yp5IaAwQIWzdj0zlZig0QW+9mRteCiyTefuGO4KI9Q/Y+kfvt+tfsefUmVrWi7F933Vn5GHqILqAxKOKKMzL/AVTGuayMlHZvwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 24 30" title="" data-src="/static/2022-08-26-14-24-30-3321c91fe6cde7df533e1a2035aaeafa-571e1.png" data-srcset="/static/2022-08-26-14-24-30-3321c91fe6cde7df533e1a2035aaeafa-2fa92.png 200w,\n/static/2022-08-26-14-24-30-3321c91fe6cde7df533e1a2035aaeafa-52932.png 400w,\n/static/2022-08-26-14-24-30-3321c91fe6cde7df533e1a2035aaeafa-571e1.png 584w" data-sizes="(max-width: 584px) 100vw, 584px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<blockquote>\n<p>抽象模型： 图</p>\n</blockquote>\n<p>在图数据库中，一个节点对应一条记录，一个弧对应两个节点之间的关系。图数据库被优化用于表示外键繁多的复杂关系或多对多关系。</p>\n<p>图数据库为存储复杂关系的数据模型，如社交网络，提供了很高的性能。它们相对较新，尚未广泛应用，查找开发工具或者资源相对较难。许多图只能通过 REST API 访问。</p>\n<h2 id="sql-还是-nosql"><a href="#sql-%E8%BF%98%E6%98%AF-nosql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL 还是 NoSQL</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-25-39-d66605e9c8cbaaf782d68b7a3c261a0e-9c82e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 495px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.93939393939393%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2UlEQVQoz12RW6+aQBSF+f+/oU996VvTtD1J+1L1iHhAFBQCAzMMF2XAS/Ewg2gPit1Km9iu7NnZ2ck3a2VGatvLnH6dkU9m8MUkn+f0SUUfdmV4vV4v7aVt2+tfOWkJRdbihezGeAcbCQ6mCxcbUAibiJiWq5W86GBQR/q50OlPIFHGP06Wsrf91Vxu8CpN4iSKkzBZRlBhRKpDBXuw7WB+bOim6mI8mcyIC5yL49v5BsdJQENMQx96GGFMHCH4I1ydGpSWiHE3Le3Vq59zyH/q4GQFbkEYkyimUIR6VSUeYTDRw+K9HL7r02+LLN4dXMb/OC/TW+Y4oV1s8P8P5vXJY2WwEXQj2L52mND8ddPc4SiBqK6HbQ87fuDAIKp/Yme712B9u66sG2spekbgkbBp3qRjfczzLGVpksQgxtIsZ/v9/hF+LYUTMgPRwcT+PrZsF21yVlWVRCn90etrqjaZ6JqmLeaL6XQmyyN4WYDP5/Pthx1nor2MFVkdK6oynM/N4VDWdV0iBFuWjZDn+b53l2Vbruse7r91uQuWLkKr1RJ5PsbYh0YCGKTtdpvn6+ls2hv0e72+PBplGcvXeX2sAe6cOeeGYYwV5fl5OBj0ldFIVdWiKH4DmKFQttR1YQEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 25 39" title="" data-src="/static/2022-08-26-14-25-39-d66605e9c8cbaaf782d68b7a3c261a0e-9c82e.png" data-srcset="/static/2022-08-26-14-25-39-d66605e9c8cbaaf782d68b7a3c261a0e-84a0c.png 200w,\n/static/2022-08-26-14-25-39-d66605e9c8cbaaf782d68b7a3c261a0e-afbfd.png 400w,\n/static/2022-08-26-14-25-39-d66605e9c8cbaaf782d68b7a3c261a0e-9c82e.png 495w" data-sizes="(max-width: 495px) 100vw, 495px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>选取 SQL 的原因:</p>\n<ul>\n<li>结构化数据</li>\n<li>严格的模式</li>\n<li>关系型数据</li>\n<li>需要复杂的联结操作</li>\n<li>事务</li>\n<li>清晰的扩展模式</li>\n<li>既有资源更丰富：开发者、社区、代码库、工具等</li>\n<li>通过索引进行查询非常快</li>\n</ul>\n<p>选取 NoSQL 的原因：</p>\n<ul>\n<li>半结构化数据</li>\n<li>动态或灵活的模式</li>\n<li>非关系型数据</li>\n<li>不需要复杂的联结操作</li>\n<li>存储 TB （甚至 PB）级别的数据</li>\n<li>高数据密集的工作负载</li>\n<li>IOPS 高吞吐量</li>\n</ul>\n<p>适合 NoSQL 的示例数据：</p>\n<ul>\n<li>埋点数据和日志数据</li>\n<li>排行榜或者得分数据</li>\n<li>临时数据，如购物车</li>\n<li>频繁访问的（“热”）表</li>\n<li>元数据/查找表</li>\n</ul>\n<h1 id="缓存"><a href="#%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-27-15-a497207c3365eb2fe3401c24cee9a38f-f1168.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 796px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.904522613065325%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACJUlEQVQoz1VSy27TQBT1B7HkD+AXQGLBng0bRBcsYVUkhISqCLFAkRCFFEiKaJtQkpQKo8RtgtzaTtK4dl6OceL4NX6NPX4xUSDAWdzFnTNzzpx7CWmmqzpQFoaiGgvD9oLY8RGuhg0N4GVZFsVJnCQnp6f1o+NGk2q12kEYJkmKQXR58ZLnq9Xad5I8o+npEhLu6IYB3MAPkAcRDFGa/QWKYh+G+IgYTRVpMqaoJk3TDMM0Gw2e5xnm3LIszXIRijAbi1i2U/kxfXPMF8jhzPRx04eIWJiOPFv0eJHr9fvCkO3yng+xVR3AmeFiUhwn1nyuiKOtg969XPXh27M9ktt+t2vaHhGlWRxF+O21K9tx5bnqecDzdN91TUEMTdOxnUNaft+Qdk/kjii3acb2IKHSR2LxiXSQ0wTOUBRZ1qbsh4vtq5fFa4PCFY1+4Qiyr6mSMNwssneeljfyrQrFf65/Ay4k5nS9t7M53M+ZF+c+L9hjRRO+jis3xL3bg/JNnSkEP/UsCrG1iepyo8Vo4XeFcWn/cKkc4/RQiINZ+V7513XgdiY4YuS4tigCTY/j2IWRZkPgIZwC5uARENmf36ZrZGl/xPZYcg7UJS9NEwAEtvu4xN7dqm3k282OLA6GeCWI9bW1rGxNHtVu3f94Pdd44Afx79kGqNKWXn3plCipTnHPX75epv3P8DOsiSuA1icuv9N+Rg7KeNtW4tn/S6KZOK/wF7CUSOaqh63aAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 27 15" title="" data-src="/static/2022-08-26-14-27-15-a497207c3365eb2fe3401c24cee9a38f-f1168.png" data-srcset="/static/2022-08-26-14-27-15-a497207c3365eb2fe3401c24cee9a38f-ad772.png 200w,\n/static/2022-08-26-14-27-15-a497207c3365eb2fe3401c24cee9a38f-4f4c3.png 400w,\n/static/2022-08-26-14-27-15-a497207c3365eb2fe3401c24cee9a38f-f1168.png 796w" data-sizes="(max-width: 796px) 100vw, 796px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>缓存可以提高页面加载速度，并可以减少服务器和数据库的负载。在这个模型中，分发器先查看请求之前是否被响应过，如果有则将之前的结果直接返回，来省掉真正的处理。</p>\n<p>数据库分片均匀分布的读取是最好的。但是热门数据会让读取分布不均匀，这样就会造成瓶颈，如果在数据库前加个缓存，就会抹平不均匀的负载和突发流量对数据库的影响。</p>\n<h2 id="客户端缓存"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端缓存</h2>\n<p>缓存可以位于客户端（操作系统或者浏览器），服务端或者不同的缓存层。</p>\n<h2 id="cdn-缓存"><a href="#cdn-%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CDN 缓存</h2>\n<p>CDN 也被视为一种缓存。</p>\n<h2 id="web-服务器缓存"><a href="#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Web 服务器缓存</h2>\n<p>反向代理和缓存（比如 Varnish）可以直接提供静态和动态内容。Web 服务器同样也可以缓存请求，返回相应结果而不必连接应用服务器。</p>\n<h2 id="数据库缓存"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据库缓存</h2>\n<p>数据库的默认配置中通常包含缓存级别，针对一般用例进行了优化。调整配置，在不同情况下使用不同的模式可以进一步提高性能。</p>\n<h2 id="应用缓存"><a href="#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>应用缓存</h2>\n<p>基于内存的缓存比如 Memcached 和 Redis 是应用程序和数据存储之间的一种键值存储。由于数据保存在 RAM 中，它比存储在磁盘上的典型数据库要快多了。RAM 比磁盘限制更多，所以例如 Least Recently Used (LRU) 的缓存无效算法可以将「热门数据」放在 RAM 中，而对一些比较「冷门」的数据不做处理。</p>\n<p>Redis 有下列附加功能：</p>\n<ul>\n<li>持久性选项</li>\n<li>内置数据结构比如有序集合和列表</li>\n</ul>\n<p>有多个缓存级别，分为两大类：数据库查询和对象：</p>\n<ul>\n<li>行级别</li>\n<li>查询级别</li>\n<li>完整的可序列化对象</li>\n<li>完全渲染的 HTML</li>\n</ul>\n<p>一般来说，你应该尽量避免基于文件的缓存，因为这使得复制和自动缩放很困难。</p>\n<h2 id="数据库查询级别的缓存"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据库查询级别的缓存</h2>\n<p>当你查询数据库的时候，将查询语句的哈希值与查询结果存储到缓存中。这种方法会遇到以下问题：</p>\n<ul>\n<li>很难用复杂的查询删除已缓存结果。</li>\n<li>如果一条数据比如表中某条数据的一项被改变，则需要删除所有可能包含已更改项的缓存结果。</li>\n</ul>\n<h2 id="对象级别的缓存"><a href="#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象级别的缓存</h2>\n<p>将您的数据视为对象，就像对待你的应用代码一样。让应用程序将数据从数据库中组合到类实例或数据结构中：</p>\n<ul>\n<li>如果对象的基础数据已经更改了，那么从缓存中删掉这个对象。</li>\n<li>允许异步处理：workers 通过使用最新的缓存对象来组装对象。</li>\n</ul>\n<p>建议缓存的内容：</p>\n<ul>\n<li>用户会话</li>\n<li>完全渲染的 Web 页面</li>\n<li>活动流</li>\n<li>用户图数据</li>\n</ul>\n<h2 id="何时更新缓存"><a href="#%E4%BD%95%E6%97%B6%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>何时更新缓存</h2>\n<p>由于你只能在缓存中存储有限的数据，所以你需要选择一个适用于你用例的缓存更新策略。</p>\n<h3 id="缓存模式"><a href="#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存模式</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-29-42-addd9d63e15912d596be8190abb9e78b-a2e9a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 687px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.174672489082965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABW0lEQVQY042R60+CUBjGz///va2yrZzMzdtULgoSyRRoRglICaEoyZZQkMaaF252pqvVl9Zv786ene3ZeZ73gN2fpF9AHQQBQRAURdE0jWGYaZogiqL1b6Iw/DYcCMMQ3nMcV6/Xi8UigiAoiuI4DkhJxh40yhhTjyN4ovdaU5KTJInjBBp833ccx3Vd3/dEUaxUKrkcks/nS6UyTAGqstqw7KNm66zdOWVYfPJUuO1LkjSfzz3PW61WcRynaQLf32zWotjj+S7PdwShu1i8gXJfwSz7hGGPGTbDdmvjaeFONgzjZQ/sud1uDxVm9nNfGisDW1Fmsmyp6gjwQ+1KNzhzup9JG+qhliYJNMCqy+XSdR2YwvdfqVavWpNatH7JjEhKazQGYAcjwWBRtJ8Y6t2PDR+AKwjeFxyvl8rX2SyZOcPOL5qq+gHSf3/VULNISqFpDSdkFL0RBP0T33mkP+wvTAgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 29 42" title="" data-src="/static/2022-08-26-14-29-42-addd9d63e15912d596be8190abb9e78b-a2e9a.png" data-srcset="/static/2022-08-26-14-29-42-addd9d63e15912d596be8190abb9e78b-b5b37.png 200w,\n/static/2022-08-26-14-29-42-addd9d63e15912d596be8190abb9e78b-68786.png 400w,\n/static/2022-08-26-14-29-42-addd9d63e15912d596be8190abb9e78b-a2e9a.png 687w" data-sizes="(max-width: 687px) 100vw, 687px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>应用从存储器读写。缓存不和存储器直接交互，应用执行以下操作：</p>\n<ul>\n<li>在缓存中查找记录，如果所需数据不在缓存中</li>\n<li>从数据库中加载所需内容</li>\n<li>将查找到的结果存储到缓存中</li>\n<li>返回所需内容</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47584986430875700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_user(self, user_id):\n    user = cache.get(&quot;user.{0}&quot;, user_id)\n    if user is None:\n        user = db.query(&quot;SELECT * FROM users WHERE user_id = {0}&quot;, user_id)\n        if user is not None:\n            key = &quot;user.{0}&quot;.format(user_id)\n            cache.set(key, json.dumps(user))\n    return user`, `47584986430875700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    user <span class="token operator">=</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user.{0}"</span><span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        user <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE user_id = {0}"</span><span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            key <span class="token operator">=</span> <span class="token string">"user.{0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>\n            cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> user</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Memcached 通常用这种方式使用。</p>\n<p>添加到缓存中的数据读取速度很快。缓存模式也称为延迟加载。只缓存所请求的数据，这避免了没有被请求的数据占满了缓存空间。</p>\n<h4 id="缺点-12"><a href="#%E7%BC%BA%E7%82%B9-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>请求的数据如果不在缓存中就需要经过三个步骤来获取数据，这会导致明显的延迟。</li>\n<li>如果数据库中的数据更新了会导致缓存中的数据过时。这个问题需要通过设置 TTL 强制更新缓存或者直写模式来缓解这种情况。</li>\n<li>当一个节点出现故障的时候，它将会被一个新的节点替代，这增加了延迟的时间。</li>\n</ul>\n<h3 id="直写模式"><a href="#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直写模式</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-31-34-22e84307a8e3c77040649a89854130ef-8c2fd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 381px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 182.41469816272968%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAIAAAAGkY33AAAACXBIWXMAAAsSAAALEgHS3X78AAADB0lEQVRIx4WWWVPiQBSF+f8/Yx6gtJCy3J5QkLFAcGUR3IIm7DtOAIWAzCdXmh4mmFtWqu3k3OXcc7vxzZc2m82Gw+H7+3uz2TRNs7S0SqXCTr1ebzQatm1/LkwgPlkBsyyr3uCbervTnmvW7/ff3t7Gk/FoNKpWq3y2AkvMYrHIOwXQ3eubPLvdLrnIv1/gdrv9+PgoXhRsPB4PR0MCsqmDU6nUw8PDCuxMncPDw1wup8es1Wv7+/vh4+PpdKrHf3l5eX19/afmfD6fzWaVe0nBcSYKOVuYuL66uoLX75r54vr6ei2COBKMvhmPx8/Ozr7TllCJRCK4E3x+fqYZMHd/f096KhGet7e30Wh0e3v76OhoMpmsapYVNYdCoV8LCwaDfr9/a2sLLg4ODgKBAK9iv2O6x++0dSNJyZ/On5+fExAuaMfczXybevvx8YGwdApx+rk04cI332DwWavV9CRdIuueVDNkDRg9IYlkMglPFxcXhULh8vLSMIxYLAbH7pElGsyXy+VOp8MTOo2iQSEyKhBBa3yNZgNtRiIRXOYLedTz9PR0c3PD61arpZftknav37NKFo4BkBX+EAwCTmfSIElbVISpojwIUwOUTqeF6s2EzT5VeyGZChcHQAudnZyc4ALmmGSK/6nPPKmZY8RxHNv+gyFVaMPjYDAgi7Xi18GcChw3LIAlU8l4ImFaJckc8Fr+LuBMJgO+XC6ZlsmfZZnVaoUO0W2PtJF0OBze3d1lHnZCO/6An9nY29tjRx0gLuD/jczX+qyfU6uRXOuTvIakTfKWHY/ItE1awCTTNsSTyWYQH3Jk2jeCxTftZTZpNfmj4i+FGwZHN/xBvgeYJv8gbw8wZTMeOlWKLXfCdM7sgS1g1ztkY2T0zhPBwNPXYM2m3mmLe/goFPKwxYRAOA1jyEUkHpEZLw5NmSR0CmGyYODh76ejV664u7s75YgJkzUTynXrAeZCQAYy3rlsNhKJyj73mTdYj6yLmci9Xs8DzDvuChjiMLCXBm2np6fyA0CB/wKMCgCPMPqd7gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 31 34" title="" data-src="/static/2022-08-26-14-31-34-22e84307a8e3c77040649a89854130ef-8c2fd.png" data-srcset="/static/2022-08-26-14-31-34-22e84307a8e3c77040649a89854130ef-65055.png 200w,\n/static/2022-08-26-14-31-34-22e84307a8e3c77040649a89854130ef-8c2fd.png 381w" data-sizes="(max-width: 381px) 100vw, 381px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>应用使用缓存作为主要的数据存储，将数据读写到缓存中，而缓存负责从数据库中读写数据。</p>\n<ul>\n<li>应用向缓存中添加/更新数据</li>\n<li>缓存同步地写入数据存储</li>\n<li>返回所需内容</li>\n</ul>\n<p>应用代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12241128725036333000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set_user(12345, {&quot;foo&quot;:&quot;bar&quot;})`, `12241128725036333000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">set_user<span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"foo"</span><span class="token punctuation">:</span><span class="token string">"bar"</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>缓存代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36360617798661067000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def set_user(user_id, values):\n    user = db.query(&quot;UPDATE Users WHERE id = {0}&quot;, user_id, values)\n    cache.set(user_id, user)`, `36360617798661067000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">set_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    user <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"UPDATE Users WHERE id = {0}"</span><span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n    cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> user<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于存写操作所以直写模式整体是一种很慢的操作，但是读取刚写入的数据很快。相比读取数据，用户通常比较能接受更新数据时速度较慢。缓存中的数据不会过时。</p>\n<h4 id="缺点-13"><a href="#%E7%BC%BA%E7%82%B9-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>由于故障或者缩放而创建的新的节点，新的节点不会缓存，直到数据库更新为止。缓存应用直写模式可以缓解这个问题。</li>\n<li>写入的大多数数据可能永远都不会被读取，用 TTL 可以最小化这种情况的出现。</li>\n</ul>\n<h3 id="回写模式"><a href="#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回写模式</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-33-01-754358f23e2983e6d3a374268eabc4df-4d589.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 713px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 96.07293127629733%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAABm0lEQVQ4y42UC2+CQBCE+f8/zaREm0gFKi/f4KMeCCoI/co2lqIBN/G8O5zZ2dlFraqqNE2/6kiSRDbH47Esy6ovtDRL1+v17Xbj14Cv1yu3YRiCZ9NNoZ1OJ9d15RBFYZZlbOI4Xq1W/eA8zy3LWiwWvu9vt9vdbmfb9ng8RkU/mA/ZgiCYz+eGYaCCmouiqF4IrXmgBIgOh4NSar/fSwldYIzBHrKhGRh7VERRtFwu4eoBA0Awv57NZpvNhrZxCxFHWKiClXacz2eEXC6XJ7LB0CQwSEAz+XEORm5YoaibpxzHIcHdSE2+4P4x7MMgj+d5FCyk8tQ0zeFwOHof0ReopRF/YCRNp1MysMIil2UdbFCLNQyejBBTwFC13X4MpgCAzN+95xiJBf/AZSM4gsFLBob5CQLfcdzJZBLXgfKuzFQhhTE2uv6m6/pgMMCX1sy1wfIMVSpW5LQ/bUyyTAsvsNpvBL4+B2MPmaFAZJZmrPSSGzb3lcq1x5x0kpx4Ts3d70Yb/PtnUDcTlmbPWvEczFTLi8GEdjfyG3a9SGVkzKPNAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 33 01" title="" data-src="/static/2022-08-26-14-33-01-754358f23e2983e6d3a374268eabc4df-4d589.png" data-srcset="/static/2022-08-26-14-33-01-754358f23e2983e6d3a374268eabc4df-b9753.png 200w,\n/static/2022-08-26-14-33-01-754358f23e2983e6d3a374268eabc4df-7c7b5.png 400w,\n/static/2022-08-26-14-33-01-754358f23e2983e6d3a374268eabc4df-4d589.png 713w" data-sizes="(max-width: 713px) 100vw, 713px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在回写模式中，应用执行以下操作：</p>\n<ul>\n<li>在缓存中增加或者更新条目</li>\n<li>异步写入数据，提高写入性能。</li>\n</ul>\n<h4 id="缺点-14"><a href="#%E7%BC%BA%E7%82%B9-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>缓存可能在其内容成功存储之前丢失数据。</li>\n<li>执行直写模式比缓存或者回写模式更复杂。</li>\n</ul>\n<h3 id="刷新"><a href="#%E5%88%B7%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>刷新</h3>\n<p>你可以将缓存配置成在到期之前自动刷新最近访问过的内容。</p>\n<p>如果缓存可以准确预测将来可能请求哪些数据，那么刷新可能会导致延迟与读取时间的降低。</p>\n<h4 id="缺点-15"><a href="#%E7%BC%BA%E7%82%B9-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ul>\n<li>不能准确预测到未来需要用到的数据可能会导致性能不如不使用刷新。</li>\n</ul>\n<h3 id="缺点-16"><a href="#%E7%BC%BA%E7%82%B9-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>需要保持缓存和真实数据源之间的一致性，比如数据库根据缓存无效。</li>\n<li>需要改变应用程序比如增加 Redis 或者 memcached。</li>\n<li>无效缓存是个难题，什么时候更新缓存是与之相关的复杂问题。</li>\n</ul>\n<h1 id="异步"><a href="#%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-35-21-6be55c68282d45b4b838d6f43841ea15-82c98.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 781px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.614596670934702%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5ElEQVQI1w2Oy3KCMAAA+f9/0QOXjtMq1BFBTYgRApVA24ECBqE8LMQWIWX2sntbSQgx9qOYeIzjMNXDdnKIOLb4Af5EXzW/1Rk4OItFAUCRRGeaa/plpfoQldJnHbrc210gbght34uSWeTbAJ2xr8Hxj/rsytKzqm7nc6ooOUuQHc5kcybvV+tAggFaBuocyk/u8yvdhPHHyco3eqmskx1oPT+7pjEjpKJe5jiF50XIZLbVBH5KLGm6vXd33nHedv3vtN4Tt8K2IG8C4SGMmxtLO8MQJzwgM12+VJo2ucDHSt/+A6hX0EIEoJ/cAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 35 21" title="" data-src="/static/2022-08-26-14-35-21-6be55c68282d45b4b838d6f43841ea15-82c98.png" data-srcset="/static/2022-08-26-14-35-21-6be55c68282d45b4b838d6f43841ea15-ee9e5.png 200w,\n/static/2022-08-26-14-35-21-6be55c68282d45b4b838d6f43841ea15-b8c14.png 400w,\n/static/2022-08-26-14-35-21-6be55c68282d45b4b838d6f43841ea15-82c98.png 781w" data-sizes="(max-width: 781px) 100vw, 781px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>异步工作流有助于减少那些原本顺序执行的请求时间。它们可以通过提前进行一些耗时的工作来帮助减少请求时间，比如定期汇总数据。</p>\n<h2 id="消息队列"><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息队列</h2>\n<p>消息队列接收，保留和传递消息。如果按顺序执行操作太慢的话，你可以使用有以下工作流的消息队列：</p>\n<ul>\n<li>应用程序将作业发布到队列，然后通知用户作业状态</li>\n<li>一个 worker 从队列中取出该作业，对其进行处理，然后显示该作业完成</li>\n</ul>\n<p>不去阻塞用户操作，作业在后台处理。在此期间，客户端可能会进行一些处理使得看上去像是任务已经完成了。例如，如果要发送一条推文，推文可能会马上出现在你的时间线上，但是可能需要一些时间才能将你的推文推送到你的所有关注者那里去。</p>\n<p>Redis 是一个令人满意的简单的消息代理，但是消息有可能会丢失。</p>\n<p>RabbitMQ 很受欢迎但是要求你适应「AMQP」协议并且管理你自己的节点。</p>\n<p>Amazon SQS 是被托管的，但可能具有高延迟，并且消息可能会被传送两次。</p>\n<h2 id="任务队列"><a href="#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>任务队列</h2>\n<p>任务队列接收任务及其相关数据，运行它们，然后传递其结果。它们可以支持调度，并可用于在后台运行计算密集型作业。</p>\n<p>Celery 支持调度，主要是用 Python 开发的。</p>\n<h2 id="背压"><a href="#%E8%83%8C%E5%8E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背压</h2>\n<p>如果队列开始明显增长，那么队列大小可能会超过内存大小，导致高速缓存未命中，磁盘读取，甚至性能更慢。背压可以通过限制队列大小来帮助我们，从而为队列中的作业保持高吞吐率和良好的响应时间。一旦队列填满，客户端将得到服务器忙或者 HTTP 503 状态码，以便稍后重试。客户端可以在稍后时间重试该请求，也许是指数退避。</p>\n<h2 id="缺点-17"><a href="#%E7%BC%BA%E7%82%B9-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h2>\n<ul>\n<li>简单的计算和实时工作流等用例可能更适用于同步操作，因为引入队列可能会增加延迟和复杂性。</li>\n</ul>\n<h1 id="通讯"><a href="#%E9%80%9A%E8%AE%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通讯</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-38-49-8daa6531ec9f505e6c3c6af824116e27-b03fa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.61538461538461%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAAD+0lEQVQ4yzVTWU8bVxSe/9D/ULUvfehDpKK2aprUpKCG5CEvhVKpi+imVm2EQF1UqYkJ0MbU4AABEkwjSinUAYMxYzObxzOe8awee+xZvIENMaaYxRjMJnodqVfnHh1dXX3fPd/5LnR0eFQqlSoHByfHJ8XNoiAI8XhcFMXw/4thGE3TYrEYOFxdXd3Z2dnd3QW5UqlAh9VD3dRLO6Wj46Nypby/v39xcXF+fp7L5fL5/Pp6fmNjo1qtXjxf29vbAAVFUQAEKCHrYLfN2X9vuLdn7P4I7FzAPRzDkWQAELIsq+u6oiiRSCSqKKZhpFKpdDoNwzA4B0BQr8veM9vXPW37bc5h8z6YRucXFv3znmWXe2n6n/nZucWn7iUYIVZwSlDimpkpFArRaLRYLNaYOx798u3Aj1//2vHDRFfnVNe4ZwpDiRUMx/AAL0gUzfCCGImq0XiCF+VYPFEulzc3N0F3W1tb0MeD7W0jnW0PO9uGOj593DFFueOqIcdUUY7GdRPsWEIHhWamVM1IZddM0wQqgry3twfduP9FU9+XTfavbji+qZ/87i48ThPMMoIFKMbrQ1CcXFr2c5IS0wwFoGiGqqo0TYMM+KEX77S80v3Ry/daX3V8/sJQ623caUgqI/CiJIFnC6LM8UJUVWVFUXXjWfFfoDZQCyhXE8wy1lw//kH9WHPDaMvlx7es3iGWklaIIEaGCIpFAzQeZFCCIllBJGmVDkUURZLkRCJR63losMnhaOqzNU44b07/ZeE5ezSaTqZMMJNkKp1MpkBkM9nyydn6lDM/0Ht8enp2dgomX1N75o+rTx7Wj9otf469C7vqMMQKozyM4Ct4jdzjQxe8flDIqTV+cCBj79koFIDhgNVqz37y8+W/77wz13UF62/URy9lkS5WNrgwa5gmuAFUNQwzk8kkczlpeCBp79kulYB/wZyBQ6GY7RJprSPuvib1vb7a/1LGbw3J6RDL0WEhLCogGE6mGJ6OxJOPhtbsPQeVQwBa3Nra29+H4N63Qg/exuwWdsiSm6xTlu64l0kf7CMCQQQIRTNkkCYIEg1QotejI74gRYmCIEsSEByC7VepEQs+eI0caYhPvqnjVjdM4YEAFggGqBCCE1SIVaJxgqQCLG/m1l0uF8dxsijpmgaxv1/Duq67f3pPtF/POt7gZ61ePIzihA/BvDDiR2vFMnALYFZUVTNFUQIOeepyRWQZGm9tGG5tHP2wceazm/gnVyITtiAvU8Eg8EYItB7mwTfQND27urbxrLC7V7M08BaGoOCfQfT3zf72Fvj2+3B7i9B5i3T2Ty/6Zl1zrnnPjMv9POZXAlTMzCQy+ZiRqh5VD8oHPMcBA/wHgfokDf2ovUIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 38 49" title="" data-src="/static/2022-08-26-14-38-49-8daa6531ec9f505e6c3c6af824116e27-b03fa.png" data-srcset="/static/2022-08-26-14-38-49-8daa6531ec9f505e6c3c6af824116e27-6fb5f.png 200w,\n/static/2022-08-26-14-38-49-8daa6531ec9f505e6c3c6af824116e27-d11a1.png 400w,\n/static/2022-08-26-14-38-49-8daa6531ec9f505e6c3c6af824116e27-b03fa.png 650w" data-sizes="(max-width: 650px) 100vw, 650px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="超文本传输协议（http）"><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE%EF%BC%88http%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>超文本传输协议（HTTP）</h2>\n<p>HTTP 是一种在客户端和服务器之间编码和传输数据的方法。它是一个请求/响应协议：客户端和服务端针对相关内容和完成状态信息的请求和响应。HTTP 是独立的，允许请求和响应流经许多执行负载均衡，缓存，加密和压缩的中间路由器和服务器。</p>\n<p>一个基本的 HTTP 请求由一个动词（方法）和一个资源（端点）组成。 以下是常见的 HTTP 动词：</p>\n<table>\n<thead>\n<tr>\n<th align="left">动词</th>\n<th align="left">描述</th>\n<th align="left">*\n幂等</th>\n<th align="left">安全性</th>\n<th align="left">可缓存</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">GET</td>\n<td align="left">读取资源</td>\n<td align="left">Yes</td>\n<td align="left">Yes</td>\n<td align="left">Yes</td>\n</tr>\n<tr>\n<td align="left">POST</td>\n<td align="left">创建资源或触发处理数据的进程</td>\n<td align="left">No</td>\n<td align="left">No</td>\n<td align="left">Yes，如果回应包含刷新信息</td>\n</tr>\n<tr>\n<td align="left">PUT</td>\n<td align="left">创建或替换资源</td>\n<td align="left">Yes</td>\n<td align="left">No</td>\n<td align="left">No</td>\n</tr>\n<tr>\n<td align="left">PATCH</td>\n<td align="left">部分更新资源</td>\n<td align="left">No</td>\n<td align="left">No</td>\n<td align="left">Yes，如果回应包含刷新信息</td>\n</tr>\n<tr>\n<td align="left">DELETE</td>\n<td align="left">删除资源</td>\n<td align="left">Yes</td>\n<td align="left">No</td>\n<td align="left">No</td>\n</tr>\n</tbody>\n</table>\n<p>多次执行不会产生不同的结果。</p>\n<p>HTTP 是依赖于较低级协议（如 TCP 和 UDP）的应用层协议。</p>\n<h2 id="传输控制协议（tcp）"><a href="#%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE%EF%BC%88tcp%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传输控制协议（TCP）</h2>\n<p>TCP 是通过 IP 网络的面向连接的协议。 使用握手建立和断开连接。 发送的所有数据包保证以原始顺序到达目的地，用以下措施保证数据包不被损坏：</p>\n<ul>\n<li>每个数据包的序列号和校验码。</li>\n<li>确认包和自动重传</li>\n</ul>\n<p>如果发送者没有收到正确的响应，它将重新发送数据包。如果多次超时，连接就会断开。TCP 实行流量控制和拥塞控制。这些确保措施会导致延迟，而且通常导致传输效率比 UDP 低。</p>\n<p>为了确保高吞吐量，Web 服务器可以保持大量的 TCP 连接，从而导致高内存使用。在 Web 服务器线程间拥有大量开放连接可能开销巨大，消耗资源过多，也就是说，一个 memcached 服务器。连接池可以帮助除了在适用的情况下切换到 UDP。</p>\n<p>TCP 对于需要高可靠性但时间紧迫的应用程序很有用。比如包括 Web 服务器，数据库信息，SMTP，FTP 和 SSH。</p>\n<p>以下情况使用 TCP 代替 UDP：</p>\n<ul>\n<li>你需要数据完好无损。</li>\n<li>你想对网络吞吐量自动进行最佳评估。</li>\n</ul>\n<h2 id="用户数据报协议（udp）"><a href="#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AE%EF%BC%88udp%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用户数据报协议（UDP）</h2>\n<p>UDP 是无连接的。数据报（类似于数据包）只在数据报级别有保证。数据报可能会无序的到达目的地，也有可能会遗失。UDP 不支持拥塞控制。虽然不如 TCP 那样有保证，但 UDP 通常效率更高。</p>\n<p>UDP 可以通过广播将数据报发送至子网内的所有设备。这对 DHCP 很有用，因为子网内的设备还没有分配 IP 地址，而 IP 对于 TCP 是必须的。</p>\n<p>UDP 可靠性更低但适合用在网络电话、视频聊天，流媒体和实时多人游戏上。</p>\n<p>以下情况使用 UDP 代替 TCP：</p>\n<ul>\n<li>你需要低延迟</li>\n<li>相对于数据丢失更糟的是数据延迟</li>\n<li>你想实现自己的错误校正方法</li>\n</ul>\n<h2 id="远程控制调用协议（rpc）"><a href="#%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AE%EF%BC%88rpc%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程控制调用协议（RPC）</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-26-14-42-55-16cc41b9dad820238ad81f76110f6e09-160dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 737px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.599728629579374%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABnklEQVQozz2RbY/SQBSF+///gyb6WddI3Lgas9mIrgHWFYHCtlAK1JZSWgrLdAqF9vHSGCc5mQ9z7j0vY/hBRbjKGZg2T082pmkRLJWgoiypzyaFP37FwlPEsWI+9+j1BgwGpsxZRGslbxo/KDHW65zjMSdNU8IwJIljDgfNavWMZc8Yj+160XgSodRzLbDf70mShCiK6rmyPJNlGfPFDkPrHK11TSzFUlVV9aM7m9EfDBkOTXHj0u32yPOcoihE8MD5fP6Pyw6oRCjH2G4VOlPkQkrTrbjIZCBnMnHp9Uc406kgwXU9Edr/W6BrXJxebqWUmDkRJwpj4qQcDwWjkcmH62ts2xKikjgFm00m/SXsJOl8oVku4zrFJbptjWg03tP81mQnBNcNpJoDxturW1odB8/bSclTHh6G/Oou+N0PyfSprsJ1N/TNNfc/bPkEnyDY4/s77HGA46xFTPHxpsXtXQ+j3XakH59leHFxxBzG3Hx64MXLN0Txtl74tfnIq9cNOj9ntDsuV+/u+Pyly9w7sYoQZwWt1oTv9xZ/AaMoBE+YgL0LAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 26 14 42 55" title="" data-src="/static/2022-08-26-14-42-55-16cc41b9dad820238ad81f76110f6e09-160dc.png" data-srcset="/static/2022-08-26-14-42-55-16cc41b9dad820238ad81f76110f6e09-fc7b9.png 200w,\n/static/2022-08-26-14-42-55-16cc41b9dad820238ad81f76110f6e09-cea17.png 400w,\n/static/2022-08-26-14-42-55-16cc41b9dad820238ad81f76110f6e09-160dc.png 737w" data-sizes="(max-width: 737px) 100vw, 737px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 RPC 中，客户端会去调用另一个地址空间（通常是一个远程服务器）里的方法。调用代码看起来就像是调用的是一个本地方法，客户端和服务器交互的具体过程被抽象。远程调用相对于本地调用一般较慢而且可靠性更差，因此区分两者是有帮助的。热门的 RPC 框架包括 Protobuf、Thrift 和 Avro。</p>\n<p>RPC 是一个“请求-响应”协议：</p>\n<ul>\n<li>客户端程序 ── 调用客户端存根程序。就像调用本地方法一样，参数会被压入栈中。</li>\n<li>客户端 stub 程序 ── 将请求过程的 id 和参数打包进请求信息中。</li>\n<li>客户端通信模块 ── 将信息从客户端发送至服务端。</li>\n<li>服务端通信模块 ── 将接受的包传给服务端存根程序。</li>\n<li>服务端 stub 程序 ── 将结果解包，依据过程 id 调用服务端方法并将参数传递过去。</li>\n</ul>\n<p>RPC 调用示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90896439916744230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`GET /someoperation?data=anId\n\nPOST /anotheroperation\n{\n  &quot;data&quot;:&quot;anId&quot;;\n  &quot;anotherdata&quot;: &quot;another value&quot;\n}`, `90896439916744230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">GET /someoperation?data=anId\n\nPOST /anotheroperation\n{\n  &quot;data&quot;:&quot;anId&quot;;\n  &quot;anotherdata&quot;: &quot;another value&quot;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RPC 专注于暴露方法。RPC 通常用于处理内部通讯的性能问题，这样你可以手动处理本地调用以更好的适应你的情况。</p>\n<p>当以下情况时选择本地库（也就是 SDK）：</p>\n<ul>\n<li>你知道你的目标平台。</li>\n<li>你想控制如何访问你的“逻辑”。</li>\n<li>你想对发生在你的库中的错误进行控制。</li>\n<li>性能和终端用户体验是你最关心的事。</li>\n</ul>\n<p>遵循 REST 的 HTTP API 往往更适用于公共 API。</p>\n<h3 id="缺点-18"><a href="#%E7%BC%BA%E7%82%B9-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>RPC 客户端与服务实现捆绑地很紧密。</li>\n<li>一个新的 API 必须在每一个操作或者用例中定义。</li>\n<li>RPC 很难调试。</li>\n<li>你可能没办法很方便的去修改现有的技术。举个例子，如果你希望在 Squid 这样的缓存服务器上确保 RPC 被正确缓存的话可能需要一些额外的努力了。</li>\n</ul>\n<h2 id="表述性状态转移（rest）"><a href="#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%EF%BC%88rest%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>表述性状态转移（REST）</h2>\n<p>REST 是一种强制的客户端/服务端架构设计模型，客户端基于服务端管理的一系列资源操作。服务端提供修改或获取资源的接口。所有的通信必须是无状态和可缓存的。</p>\n<p>RESTful 接口有四条规则：</p>\n<ul>\n<li>标志资源（HTTP 里的 URI） ── 无论什么操作都使用同一个 URI。</li>\n<li>表示的改变（HTTP 的动作） ── 使用动作, headers 和 body。</li>\n<li>可自我描述的错误信息（HTTP 中的 status code） ── 使用状态码，不要重新造轮子。</li>\n<li>HATEOAS（HTTP 中的 HTML 接口） ── 你的 web 服务器应该能够通过浏览器访问。</li>\n</ul>\n<p>REST 请求的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23237052094607356000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`GET /someresources/anId\n\nPUT /someresources/anId\n{&quot;anotherdata&quot;: &quot;another value&quot;}`, `23237052094607356000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">GET /someresources/anId\n\nPUT /someresources/anId\n{&quot;anotherdata&quot;: &quot;another value&quot;}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>REST 关注于暴露数据。它减少了客户端/服务端的耦合程度，经常用于公共 HTTP API 接口设计。REST 使用更通常与规范化的方法来通过 URI 暴露资源，通过 header 来表述并通过 GET、POST、PUT、DELETE 和 PATCH 这些动作来进行操作。因为无状态的特性，REST 易于横向扩展和隔离。</p>\n<h3 id="缺点-19"><a href="#%E7%BC%BA%E7%82%B9-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ul>\n<li>由于 REST 将重点放在暴露数据，所以当资源不是自然组织的或者结构复杂的时候它可能无法很好的适应。举个例子，返回过去一小时中与特定事件集匹配的更新记录这种操作就很难表示为路径。使用 REST，可能会使用 URI 路径，查询参数和可能的请求体来实现。</li>\n<li>REST 一般依赖几个动作（GET、POST、PUT、DELETE 和 PATCH），但有时候仅仅这些没法满足你的需要。举个例子，将过期的文档移动到归档文件夹里去，这样的操作可能没法简单的用上面这几个 verbs 表达。</li>\n<li>为了渲染单个页面，获取被嵌套在层级结构中的复杂资源需要客户端，服务器之间多次往返通信。例如，获取博客内容及其关联评论。对于使用不确定网络环境的移动应用来说，这些多次往返通信是非常麻烦的。</li>\n<li>随着时间的推移，更多的字段可能会被添加到 API 响应中，较旧的客户端将会接收到所有新的数据字段，即使是那些它们不需要的字段，结果它会增加负载大小并引起更大的延迟。</li>\n</ul>\n<h2 id="rpc-与-rest-比较"><a href="#rpc-%E4%B8%8E-rest-%E6%AF%94%E8%BE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RPC 与 REST 比较</h2>\n<table>\n<thead>\n<tr>\n<th>操作</th>\n<th>RPC</th>\n<th>REST</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>注册</td>\n<td><strong>POST</strong>\n /signup</td>\n<td><strong>POST</strong>\n /persons</td>\n</tr>\n<tr>\n<td>注销</td>\n<td><strong>POST</strong>\n /resign\n<br/>\n{\n<br/>\n“personid”: “1234”\n<br/>\n}</td>\n<td><strong>DELETE</strong>\n /persons/1234</td>\n</tr>\n<tr>\n<td>读取用户信息</td>\n<td><strong>GET</strong>\n /readPerson?personid=1234</td>\n<td><strong>GET</strong>\n /persons/1234</td>\n</tr>\n<tr>\n<td>读取用户物品列表</td>\n<td><strong>GET</strong>\n /readUsersItemsList?personid=1234</td>\n<td><strong>GET</strong>\n /persons/1234/items</td>\n</tr>\n<tr>\n<td>向用户物品列表添加一项</td>\n<td><strong>POST</strong>\n /addItemToUsersItemsList\n<br/>\n{\n<br/>\n“personid”: “1234”;\n<br/>\n“itemid”: “456”\n<br/>\n}</td>\n<td><strong>POST</strong>\n /persons/1234/items\n<br/>\n{\n<br/>\n“itemid”: “456”\n<br/>\n}</td>\n</tr>\n<tr>\n<td>更新一个物品</td>\n<td><strong>POST</strong>\n /modifyItem\n<br/>\n{\n<br/>\n“itemid”: “456”;\n<br/>\n“key”: “value”\n<br/>\n}</td>\n<td><strong>PUT</strong>\n /items/456\n<br/>\n{\n<br/>\n“key”: “value”\n<br/>\n}</td>\n</tr>\n<tr>\n<td>删除一个物品</td>\n<td><strong>POST</strong>\n /removeItem\n<br/>\n{\n<br/>\n“itemid”: “456”\n<br/>\n}</td>\n<td><strong>DELETE</strong>\n /items/456</td>\n</tr>\n</tbody>\n</table>\n<h1 id="安全"><a href="#%E5%AE%89%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安全</h1>\n<ul>\n<li>在运输和等待过程中加密</li>\n<li>对所有的用户输入和从用户那里发来的参数进行处理以防止 XSS 和 SQL 注入。</li>\n<li>使用参数化的查询来防止 SQL 注入。</li>\n<li>使用最小权限原则。</li>\n</ul>',
excerpt:"背景知识 系统设计 系统设计主题：从这里开始 认识以下一般性原则 可扩展性视频讲座 哈佛大学可扩展性讲座 垂直扩展（Vertical scaling） 水平扩展（Horizontal scaling） 缓存 负载均衡 数据库复制 数据库分区 可扩展性文章 Clones…",timeToRead:22,tableOfContents:'<ul>\n<li><a href="/system-design-practice-learn/#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86">背景知识</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%EF%BC%9A%E4%BB%8E%E8%BF%99%E9%87%8C%E5%BC%80%E5%A7%8B">系统设计主题：从这里开始</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E8%A7%86%E9%A2%91%E8%AE%B2%E5%BA%A7">可扩展性视频讲座</a></li>\n<li><a href="/system-design-practice-learn/#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E6%96%87%E7%AB%A0">可扩展性文章</a></li>\n<li><a href="/system-design-practice-learn/#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E6%AD%A5%E9%AA%A4">接下来的步骤</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%8B%93%E5%B1%95%E6%80%A7">性能与拓展性</a></li>\n<li><a href="/system-design-practice-learn/#%E5%BB%B6%E8%BF%9F%E4%B8%8E%E5%90%9E%E5%90%90%E9%87%8F">延迟与吞吐量</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%8F%AF%E7%94%A8%E6%80%A7%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7">可用性与一致性</a></p>\n<ul>\n<li>\n<p><a href="/system-design-practice-learn/#cap-%E7%90%86%E8%AE%BA">CAP 理论</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#cp---%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7">CP - 一致性和分区容错性</a></li>\n<li><a href="/system-design-practice-learn/#ap---%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7">AP - 可用性和分区容错性</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E4%B8%80%E8%87%B4%E6%A8%A1%E5%BC%8F">一致模式</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7">弱一致性</a></li>\n<li><a href="/system-design-practice-learn/#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">最终一致性</a></li>\n<li><a href="/system-design-practice-learn/#%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7">强一致性</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用性模式</a></p>\n<ul>\n<li>\n<p><a href="/system-design-practice-learn/#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2">故障切换</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%B7%A5%E4%BD%9C%E5%88%B0%E5%A4%87%E7%94%A8%E5%88%87%E6%8D%A2%EF%BC%88active-passive%EF%BC%89">工作到备用切换（Active-passive）</a></li>\n<li><a href="/system-design-practice-learn/#%E5%8F%8C%E5%B7%A5%E4%BD%9C%E5%88%87%E6%8D%A2%EF%BC%88active-active%EF%BC%89">双工作切换（Active-active）</a></li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%A4%8D%E5%88%B6">复制</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E4%B8%BB-%E2%94%80-%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E4%B8%BB-%E2%94%80-%E4%B8%BB%E5%A4%8D%E5%88%B6">主 ─ 从复制和主 ─ 主复制</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">域名系统</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#dns-%E7%BC%BA%E7%82%B9">DNS 缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#cdn">CDN</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#cdn-%E6%8E%A8%E9%80%81">CDN 推送</a></li>\n<li><a href="/system-design-practice-learn/#cdn-%E6%8B%89%E5%8F%96">CDN 拉取</a></li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-1">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">四层负载均衡</a></li>\n<li><a href="/system-design-practice-learn/#%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">七层负载均衡</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平扩展</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-2">缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-3">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%88web-%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89">反向代理（web 服务器）</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">负载均衡与反向代理</a></li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-4">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%BA%94%E7%94%A8%E5%B1%82">应用层</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li>\n<li><a href="/system-design-practice-learn/#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-5">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a></p>\n<ul>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%88rdbms%EF%BC%89">关系型数据库管理系统（RDBMS）</a></p>\n<ul>\n<li>\n<p><a href="/system-design-practice-learn/#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-6">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6">主主复制</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-7">缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-8">缺点</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E8%81%94%E5%90%88">联合</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-9">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%88%86%E7%89%87">分片</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-10">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-11">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#sql-%E8%B0%83%E4%BC%98">SQL 调优</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E6%94%B9%E8%BF%9B%E6%A8%A1%E5%BC%8F">改进模式</a></li>\n<li><a href="/system-design-practice-learn/#%E4%BD%BF%E7%94%A8%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%B4%A2%E5%BC%95">使用正确的索引</a></li>\n<li><a href="/system-design-practice-learn/#%E9%81%BF%E5%85%8D%E9%AB%98%E6%88%90%E6%9C%AC%E7%9A%84%E8%81%94%E7%BB%93%E6%93%8D%E4%BD%9C">避免高成本的联结操作</a></li>\n<li><a href="/system-design-practice-learn/#%E5%88%86%E5%89%B2%E6%95%B0%E6%8D%AE%E8%A1%A8">分割数据表</a></li>\n<li><a href="/system-design-practice-learn/#%E8%B0%83%E4%BC%98%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98">调优查询缓存</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#nosql">NoSQL</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">键-值存储</a></li>\n<li><a href="/system-design-practice-learn/#%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8">文档存储</a></li>\n<li><a href="/system-design-practice-learn/#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">列型存储</a></li>\n<li><a href="/system-design-practice-learn/#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#sql-%E8%BF%98%E6%98%AF-nosql">SQL 还是 NoSQL</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E7%BC%93%E5%AD%98">缓存</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li>\n<li><a href="/system-design-practice-learn/#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li>\n<li><a href="/system-design-practice-learn/#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li>\n<li><a href="/system-design-practice-learn/#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li>\n<li><a href="/system-design-practice-learn/#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li>\n<li><a href="/system-design-practice-learn/#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li>\n<li><a href="/system-design-practice-learn/#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E4%BD%95%E6%97%B6%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">何时更新缓存</a></p>\n<ul>\n<li>\n<p><a href="/system-design-practice-learn/#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-12">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-13">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-14">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%88%B7%E6%96%B0">刷新</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-15">缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-16">缺点</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E5%BC%82%E6%AD%A5">异步</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li>\n<li><a href="/system-design-practice-learn/#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li>\n<li><a href="/system-design-practice-learn/#%E8%83%8C%E5%8E%8B">背压</a></li>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-17">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E9%80%9A%E8%AE%AF">通讯</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE%EF%BC%88http%EF%BC%89">超文本传输协议（HTTP）</a></li>\n<li><a href="/system-design-practice-learn/#%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE%EF%BC%88tcp%EF%BC%89">传输控制协议（TCP）</a></li>\n<li><a href="/system-design-practice-learn/#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AE%EF%BC%88udp%EF%BC%89">用户数据报协议（UDP）</a></li>\n<li>\n<p><a href="/system-design-practice-learn/#%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AE%EF%BC%88rpc%EF%BC%89">远程控制调用协议（RPC）</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-18">缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/system-design-practice-learn/#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%EF%BC%88rest%EF%BC%89">表述性状态转移（REST）</a></p>\n<ul>\n<li><a href="/system-design-practice-learn/#%E7%BC%BA%E7%82%B9-19">缺点</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#rpc-%E4%B8%8E-rest-%E6%AF%94%E8%BE%83">RPC 与 REST 比较</a></li>\n</ul>\n</li>\n<li><a href="/system-design-practice-learn/#%E5%AE%89%E5%85%A8">安全</a></li>\n</ul>',wordCount:{words:1590},frontmatter:{date:"2022-08-26 15:07:36",path:"/system-design-practice-learn/",tags:"后端, 系统设计, 读书笔记",title:"系统设计入门学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="webgl-二维平移"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E5%B9%B3%E7%A7%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维平移</h1>\n<p>平移就是普通意义的“移动”物体。这里有个例子基于前一个例子。首先我们来定义一些变量存储矩形的平移，宽，高和颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23907877293250880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var translation = [0, 0];\nvar width = 100;\nvar height = 30;\nvar color = [Math.random(), Math.random(), Math.random(), 1];`, `23907877293250880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> translation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> color <span class="token operator">=</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后定义一个方法重绘所有东西，我们可以在更新变换之后调用这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61996935415518740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间对应到像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 使用我们的程序\n  gl.useProgram(program);\n\n  // 启用属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 设置矩形参数\n  setRectangle(gl, translation[0], translation[1], width, height);\n\n  // 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)\n  var size = 2; // 每次迭代运行提取两个单位数据\n  var type = gl.FLOAT; // 每个单位的数据类型是 32 位浮点型\n  var normalize = false; // 不需要归一化数据\n  var stride = 0; // 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）\n  var offset = 0; // 从缓冲起始位置开始读取\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 设置分辨率\n  gl.uniform2f(resolutionLocation, gl.canvas.width, gl.canvas.height);\n\n  // 设置颜色\n  gl.uniform4fv(colorLocation, color);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 6;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `61996935415518740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间对应到像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用我们的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩形参数</span>\n  <span class="token function">setRectangle</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代运行提取两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 每个单位的数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要归一化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始位置开始读取</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置分辨率</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2f</span><span class="token punctuation">(</span>resolutionLocation<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置颜色</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在下方的例子中，我添加了一对滑块，当它们值改变时会更新 <code class="language-text">translation[0]</code> 和 <code class="language-text">translation[1]</code> 并且调用 drawScene 方法。拖动滑块来平移矩形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/qj863d?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>到目前为止还不错！但是想象一下如果对一个更复杂的图形做类似操作怎么办。</p>\n<p>假设我们想绘制一个由六个三角形组成的 ‘F’ ，像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 207px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 133.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAADJ0lEQVQ4y52U+2/SUBTH93f6k7/5i1Fj1GXJEnUO9gDaruW5tpSWlnZjg8HYw6mLGuPYYOBgbEwZlJduxszFOWBAuR6Y8ckP1ptvmtubfs6559EzMLs+R2/x7qhXSMoP2VE8TPHbPjYquDe9l2I3untPXIIP+ITPvk5jC+Sw6z7uJQemNzgZhaVWMIjWrvE3jEksgFZFLehDCzMoMouW5tCKtx2gv4rmQ9vojsWQxkxvrR7kJ2L2ATDsQyFZC4nNwA35DpZ1AKx0wnBCf5KoAjMaNRs2LcYYZiu7uS+KooVntEU/ijiT7gFmg+85WWROpFvzg+acjT4TJ/anRhImYxrH8g62roidAFxBQYsyCkko6NUCCopYE9PfYQWFmVPfLeXeHXJwRDBgS6TzFcO9kfiUj0uK7LZAb3mYGM/Gha5iApsU2CeeLiz1PE+p0yPrEyW1hBBqXbRa9dbF+cXFeaNZb/ZRrdlutr/Ds2gRUoWnHZVKBeBOp4P+Yf2AI4YEhqfslbJOGErlbcyP7xDUAa2qKpy2223tlwWvqJ+5Lgz1dB0JExmSqYrlYlmP59c9+IMwmaGcJc/jF2vZ8tvU4W5P6f1KdlfNRLei9Vr9b6NdGGpIFWiqyBCHrqFnD6zvWSgvVWVAD6LjN4N3r/O31WI3HAjhD9gDsGHLwtf8RM5JHLjC6Ok8WmFPfGPbuDljg95g8uJlLrTO7zD92uNHy482TEJjDmAqzwj1OeM2ZtqlYDOPVqHnHTmuP3yZ7dFNs09bsGTtV4irN0ODj5Jm8j2NF52mnJWouu4/N+bz+T7X5mIiW5ONcRyuSuw5I8uRwkc1WzrI5Pcyhf29Sx3uNxqNPgnj4iJ9Jo3FurA9565WqjpKxcUl52dhcoeE/9b2jikUCt0m0doQ3k/Bo2+TwHCYPKCcHwQ/WrLl2FKxpMMzn5ANKQt7IkN72/XCMJyMKcx9qvRgtz7Y/mzauIvLnRDMA90wuWIfSxMQMIwY3fDUsm1s739hgzBuPWJhXMIMtb3TmbAhathTnwXPIEeBK6pFHTDBTk0+xq0vXeQLhyVMHh8d/zv8DejTYUu3o/ZjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 00 00 30" title="" data-src="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png" data-srcset="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-7ebab.png 200w,\n/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png 207w" data-sizes="(max-width: 207px) 100vw, 207px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接着当前的代码我们需要修改 setRectangle，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="316353127573187900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl, x, y) {\n  var width = 100;\n  var height = 150;\n  var thickness = 30;\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      x,\n      y,\n      x + thickness,\n      y,\n      x,\n      y + height,\n      x,\n      y + height,\n      x + thickness,\n      y,\n      x + thickness,\n      y + height,\n\n      // 上横\n      x + thickness,\n      y,\n      x + width,\n      y,\n      x + thickness,\n      y + thickness,\n      x + thickness,\n      y + thickness,\n      x + width,\n      y,\n      x + width,\n      y + thickness,\n\n      // 中横\n      x + thickness,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + thickness,\n      y + thickness * 3,\n      x + thickness,\n      y + thickness * 3,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 3\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `316353127573187900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> thickness <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      x<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能发现这样做可能并不好，如果我们想绘制一个含有成百上千个线条的几何图形，将会有很复杂的代码。最重要的是，每次绘制 JavaScript 都要更新所有点。</p>\n<p>这里有个简单的方式，上传几何体然后在着色器中进行平移，以下是新的着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72602756672924200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n\n   void main() {\n      // 加上平移量\n      vec2 position = a_position + u_translation;\n\n      // 从像素坐标转换到 0.0 到 1.0\n      vec2 zeroToOne = position / u_resolution;\n      // ...\n   }\n</script>`, `72602756672924200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 加上平移量</span>\n      vec2 position <span class="token operator">=</span> a_position <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n\n      <span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n      vec2 zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重构一下代码，首先我们只需要设置一次几何体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21291023487304008000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      0,\n      0,\n      30,\n      0,\n      0,\n      150,\n      0,\n      150,\n      30,\n      0,\n      30,\n      150,\n\n      // 上横\n      30,\n      0,\n      100,\n      0,\n      30,\n      30,\n      30,\n      30,\n      100,\n      0,\n      100,\n      30,\n\n      // 中横\n      30,\n      60,\n      67,\n      60,\n      30,\n      90,\n      30,\n      90,\n      67,\n      60,\n      67,\n      90\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `21291023487304008000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">90</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们只需要在绘制前更新 <code class="language-text">u_translation</code> 为期望的平移量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77510680483524050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar translationLocation = gl.getUniformLocation(program, \'u_translation\');\n// ...\n\n// 创建一个存放位置信息的缓冲\nvar positionBuffer = gl.createBuffer();\n// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)\ngl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n// 将几何数据存到缓冲\nsetGeometry(gl);\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `77510680483524050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> translationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_translation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 创建一个存放位置信息的缓冲</span>\n<span class="token keyword">var</span> positionBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将几何数据存到缓冲</span>\n<span class="token function">setGeometry</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 setGeometry 只调用了一次，它不在 drawScene 内部了。</p>\n<p>这里是那个例子，同样的，拖动滑块来更新平移量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/p59ez6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在当我们绘制时，WebGL 几乎做了所有事情，我们做的仅仅是设置平移然后让它绘制，即使我们的几何体有成千上万个点，主要的代码还是保持不变。</p>\n<p>你可以对比上方例子中使用 JavaScript 更新所有点的情况。</p>\n<h1 id="webgl-二维旋转"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E6%97%8B%E8%BD%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维旋转</h1>\n<p>首先我想向你介绍一个叫做 <code class="language-text">单位圆</code> 的东西，一个圆有一个半径，圆的半径是圆心到圆边缘的距离，单位圆是半径为 1.0 的圆。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 312px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.35897435897438%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACDklEQVQ4y21UiY7TMBDt/0v8Ax8BHwFCWrQI2GWlQtkecXzEbprLHts8xwltmh0pI2s8b643zqYoCqUU51xOIoSU17NIdrG0ZufT6bTBfYyRiOJKQghEfm33Phm11huEgVPf9845Inxd0zmuXCGdqOjEWiYdU+58SbfJwblhGKCRfIMPYax10Ea3799tfz3ViBx8ymytDSE6ivoShA65vlxmypzBiARdCv/xw0+p61TzVDblM2RwsdQpkPdLMOpR59B10URzDFW49kxzoBFvo9A3mcUI7ge/O5wPr3+/Pj7+qH6b2N2C5/klbZpo6v9gkcBCu6bzKOio2ctw3EXRRYuMaxYwaaaWZRfChTGysvWW2NazVxKWnH+LKqkJ8zVGTzxzCUaT347vPz8/fN89f/r25Y/Yh6V4n9pXxrU9wFXiGZgj69o29YmF41J0Q9e0TdO3xpiR/0lwjIFENWjTa63msqXL81ht2KLn7CINYey57ATmlevtBAhzmDU4z7yQS6ourZPnKx9vgvNV3UZdr5ZEmIAx3OJvwdmIlnlastV6YthlhW25pTSkCc2CY6kDSLpfz7zbIEIavIGY2R25oWxHtchp7x5GpgpPMpMB77qhUhGvCHwKNWCWWCn0mW8heJLQ+IVMS5IzL9YwpBbOtR3s/cCvmQ+HAypnjImljD8ejt+QUvLuqixL6P1+/w9984fRhyLjxQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 10 43 30" title="" data-src="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png" data-srcset="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-08db0.png 200w,\n/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png 312w" data-sizes="(max-width: 312px) 100vw, 312px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当你拖拽蓝色圆点的时候 X 和 Y 会改变，它们是那一点在圆上的坐标，在最上方时 Y 是 1 并且 X 是 0，在最右边的时候 X 是 1 并且 Y 是 0。</p>\n<p>如果你还记得三年级的数学知识，数字和 1 相乘结果不变。例如 <code class="language-text">123 * 1 = 123</code>，那么，单位圆半径为 1.0 的圆也是 1 的一种形式，它是旋转的 1。所以你可以把一些东西和单位圆相乘，除了发生一些魔法和旋转之外，某种程度上和乘以 1 相似。</p>\n<p>我们将从单位元上任取一点，并将该点的 X 和 Y 与之前例子中的几何体相乘，以下是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63997356211993180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n\n   void main() {\n      // 旋转位置\n      vec2 rotatedPosition = vec2(\n         a_position.x * u_rotation.y + a_position.y * u_rotation.x,\n         a_position.y * u_rotation.y - a_position.x * u_rotation.x\n      );\n\n      // 加上平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `63997356211993180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 旋转位置</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 加上平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更新 JavaScript，传递两个值进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97308434511265680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar rotationLocation = gl.getUniformLocation(program, \'u_rotation\');\n\n// ...\n\nvar rotation = [0, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `97308434511265680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rotation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，拖动圆形手柄来旋转或拖动滑块来平移。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/6g8g2i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-geometry-rotation](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-geometry-rotation?view=preview) -->\n<p>为什么会这样？来看看数学公式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67407758898091120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedX = a_position.x * u_rotation.y + a_position.y * u_rotation.x;\nrotatedY = a_position.y * u_rotation.y - a_position.x * u_rotation.x;`, `67407758898091120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedX <span class="token operator">=</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span>\nrotatedY <span class="token operator">=</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>假如你想旋转一个矩形，在开始旋转之前矩形右上角坐标是 3.0, 9.0，让我们在单位圆上以十二点方向为起点顺时针旋转 30 度后取一个点。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACL0lEQVQ4y4VU2W7bMBDUf+eh/an2oXlLgRhVEhhIi6IwkEOyDlu2DouHJB5ih6QP2W7QBSEtqZldcneowBgzjqNSylwZ1rVWztmP47rHB94bhuGABsQOIUbGNKViGEb3RWgtj0yPD7zXdZ10ppRsGpkkMk1VnuuXFwI/jvu7u/XDQ9H33REPJ/DBQIOjtdlu7UBct0kkJ3gxJj9/mt/cPBPCMFVKe3zgOJgInGK9NpyfzgyQENL74e9fs/BPXfm4EzImQoiiMF3n63EqDHZYV/W2Kpd1lK9iSnvAzjIjd1mKqjpj+h0haBRF4Tyc/5z/CEOcb7czZanhnMhxLKS8bJW2ndKDGVCHRCQtbX30NNXDcCBzPqKkF2ldndhmvYmreLFZvJfvvN/XA2TO92TNmMoyDS4O481rIMuy+6f7x+fHWTi7/X5LOHHRdVXJohDAB6g0pTKKOs4J2iwnhgNnZVbs1jWrv3z72jSNi4xji8WigWzstlFkkJXqL+VpRkqpkmoiWPvcbseioDYzJkLo5VJca9v1X/oo1uzTri+XGoL02rawNBWMfUieGkQC2ULFJ5FwLlar/5B9WoiEUu0vyV6eSglC0P0z3Gnbh/sIIUEkTpETMgoLp23NZmOOyQDy24NhERemac6CBv5KQcNYcj3X6DkG9ta2qmlQizHPVZJoQrQjao8HMZjcTzRW4hMcdD7PZZbJ11fy9kZsv6T9GQDgmf+4z9e/ISE4wB8V8i8ir4ttPxU+QgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 21 43" title="" data-src="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png" data-srcset="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-291bf.png 200w,\n/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.50 和 0.87</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5717583122278413000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3`, `5717583122278413000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个结果正好是我们需要的结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.03125%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQY0zWQW0sDMRCF9///CcEHxeKLIIgitA/1SX2oWErtfZfmnk3i5rIbt0mnLZ6nOZmZw3wpDoeDc45z3rZtzrnruhhjFwNjLLQngXXOa6W99xcLgq2UcuFsGD+ul/NSGxXjX13XUsjVbL/ZbCGLYKJqJSTHGEkpIVEprZTq+x66hW388G6LS3VZbpz+meDRYAejEM8Fa7zmVFEivHeMcWMMtLTWzrvC6Ob1drFbEsZJCIES/ny9mE+QMhJsVaKvN/R0tfj+XLtgEUK1kpQRSinAFtba7QoLLgEbYCkW0/e9EALi+xSnH9X4oSrXzAfX/Nrh/Wo0KF9uZhTz09kJlIE+wZHgU07n+vycM7CBS/8yvNU0CuRCOP3uEQduTf4BYRapAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 22 51" title="" data-src="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png" data-srcset="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-7728b.png 200w,\n/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-23f96.png 400w,\n/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>顺时针 60 度也一样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQ4y4VT226bQBDly/vQ53xOFUvtQ/tiRcqtidWHtIprJYDB2BBgL8Bee5a1gdROMhrh9cw5u7MzZwNrrTFGKWWPDHGtT8c9PvCrrusOaINfuBCGMU2p8Bk4Ut4GfOBXTdPI3pSSZSmjSMaxShK9XJIoFmEoi8KlvHk8iIE/ECEsUMtu5xz7GuMynBOttRC2KOxmY/3llNIe78hISymQQJrz8W4ACSH73d1f7JhlFgfD93fucwAJJJrGDtDDpvLQJPflTMzO88vLDIXvyYDluUBhU+ZJctu1nz5fn539bls2ksNQHGCnyShtuVre3f/89mN+PvvOGd2TOTdo73/H+kaisdVLVRRFuA3v/yz+FqsNjx8enhlrPVkzptZrDTA6NDV0hTBy++t2fjO/uLm4Wlw963CR3UVRnefA6wClUSqfnhpMBWOWUxMyTuOszuquLmhRNmX6ks6+fsky8vhYad25stFkkKVsj2XIKFNSTSLuu9uZLMOdTdA3wzXsWMNDw4xjOdeObcJQQ5Be2w4Wx4Kx97o9GKQC2UKqo0g4F2n6AdnXDC1R6jKjPJUShNg8f4Ubyzb7CIRUVV6REzI0gEVd2+3WDocB5MuDIYgHU5avNg38k4IYEOpnrjFzOGqra1WW6IVJEhVFmhDdE7XHgzi+ZxyCYpDCApNPErley9WKwCnF/AVSALz5no/nLAQH+K1G/gNkNoySs7PGXgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 23 18" title="" data-src="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png" data-srcset="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-291bf.png 200w,\n/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.87 和 0.50。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82022362235608530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9`, `82022362235608530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>你会发现在我们顺时针旋转到右边的过程中，X 变大 Y 变小。如果我们继续旋转超过 90 度后，X 变小 Y 变大，这种形式形成了旋转。</p>\n<p>单位圆上的点还有一个名字，叫做正弦和余弦。所以对于任意给定角，我们只需要求出正弦和余弦，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82902045002005400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function printSineAndCosineForAnAngle(angleInDegrees) {\n  var angleInRadians = (angleInDegrees * Math.PI) / 180;\n  var s = Math.sin(angleInRadians);\n  var c = Math.cos(angleInRadians);\n  console.log(\'s = \' + s + \' c = \' + c);\n}`, `82902045002005400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">printSineAndCosineForAnAngle</span><span class="token punctuation">(</span><span class="token parameter">angleInDegrees</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'s = \'</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">\' c = \'</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果把代码复制到 JavaScript 控制台，然后输入 <code class="language-text">printSineAndCosignForAngle(30)</code>，会打印出 <code class="language-text">s = 0.49 c = 0.87</code>(注意：我对结果四舍五入了)。</p>\n<p>如果你把这些组合起来，就可以对几何体旋转任意角度，使用时只需要设置旋转的角度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57700885354698690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nvar angleInRadians = (angleInDegrees * Math.PI) / 180;\nrotation[0] = Math.sin(angleInRadians);\nrotation[1] = Math.cos(angleInRadians);`, `57700885354698690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里有一个设置角度的版本，拖动滑块来旋转或平移。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4i0mhx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这并不是旋转常用的方式，请继续阅读</p>\n<h1 id="webgl-二维缩放"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%BC%A9%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维缩放</h1>\n<p>缩放和平移一样简单，让我们将位置乘以期望的缩放值，这是前例中的变化部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48523995705043706000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `48523995705043706000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   uniform vec2 u_scale<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// 缩放</span></span><span class="gatsby-highlight-code-line">      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span></span>\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n<span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后需要在 JavaScript 中绘制的地方设置缩放量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9633538997661395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar scaleLocation = gl.getUniformLocation(program, \'u_scale\');\n\n// ...\n\nvar scale = [1, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 设置缩放\n  gl.uniform2fv(scaleLocation, scale);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `9633538997661395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,21-22}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,21-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scaleLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_scale\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 设置缩放</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>scaleLocation<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们有了缩放，拖动滑块试试。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/byhsth?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>值得一提的是，缩放值为负数的时候会翻转几何体。</p>\n<p>接下来我们将复习神奇的矩阵，这三种操作将包含在一个矩阵中，并表现为一种常用形式。</p>\n<h1 id="webgl-二维矩阵"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%9F%A9%E9%98%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维矩阵</h1>\n<p>之前的三篇文章讲了如何对二维物体进行平移，旋转和缩放。每种变换都改变了着色器并且这些变换还受先后顺序影响。在前例中我们先缩放，再旋转，最后平移，如果执行顺序不同结果也不同。</p>\n<p>例如这是缩放 (2, 1)，旋转 30 度，然后平移 (100, 0) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.65289256198348%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz5WSXY/BQBSG+6/9BnclQYK4oiS4Ia4FiUtZWxHio2T6oS0b/aI6nZk91YZI7G72XEyamT7vec87w7F7EUKCIGD/LO4B3263t39QSv+GPc+7Xq8g4fv+5XLBGEcko7/wT/hwOEiSpKqqpmmwWpYF+wEObNu+a9BY6A0M2uq98L2gPw6jzqIsVo9V0RJ9z38YeQ8riuI4juu6sU/HchpKQ2BCqp8qLUsIIxayWCJWecLgdrvd7nY7XdejM8LGaFzxKtlldjQfDbVhDuW6Zvd0OSVTUPqEEUKGYTziMb6MolTMq/nMKrM/72Hn6BzbShsk+lof3L10Btg0zWQawlrTFo/4ulOvfdQKqNDTepZnQUfJlgRdKMvlwXrAhWEICcELARgMx09ltpqlP9MwbWfdYT6TbbmpN/klv9E2cBricOJOuvNuAkO8cM/wDTCsENvUndaUmqzLsS9K6OK0OLvnJHMSueN+fJ6Uea5HKEng10uKA/sGF+OjNIu10dUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 35 02" title="" data-src="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png" data-srcset="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-4bd12.png 200w,\n/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-7acd9.png 400w,\n/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是平移 (100, 0) ，旋转 30 度，然后缩放 (2, 1) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-7376a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.19875776397515%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQoz51RvavCMBDv/w9uWUQEQXHqIrg5uLhIh4IUoV1eW1/VlzQ1/eA1bdPkXY1IKV18BzmOJL+PuzOUUk3TSCnV52HAqev6/+A0TaMoIoRgjKEe/SeVHAfHcQxgMF+WJbgYwnqmgKLP0oEppUEQgDLnfCDXyhbyNbuGRcgr/gYCIzy9wGEYMsb6sqAgpFCt8qi3YIuJM5l78126cx4O+2Vw/1LGzxhYlc82bWIjjNb+OqMZzvHh52DezOVtaV7Mo3c0hBAaDLJVVekMnmQj9997dEczd7b6Wm3J1rk7YAaoWcXc3E2KxAANvSodXZNK5UW+8TeIICuxBBeEEyu1zvQ8GHlnG8TfI9XFyT9NL1P7Yat2ZElSt6XUHzOmO1uhS63KAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 44 24" title="" data-src="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-fee1c.png" data-srcset="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-a67b7.png 200w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-0b187.png 400w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-fee1c.png 800w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-7376a.png 805w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>结果截然不同，更糟的是，针对第二种情况中的转换顺序，需要写一个新的着色器。</p>\n<p>有些比我聪明的人可能已经想到了矩阵，对于二维我们使用 3x3 的矩阵，3x3 的矩阵就像是有 9 个格子的格网。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.66666666666669%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEEklEQVQ4y3VU6VP6SBDN//9xPUsFSm5E5IgQTkFEIJwSwg0JAQSEcAZZOd0XqZ/lWrv9YWhmXk+n+/Ubot1uO53Ox8fHYDAYCoW8Xi/8cDgcCASCX4ZNt9sdi8X8fj/8b1gqlSISiQR+3t/fx+PxZDIRRfHi4gJn2IEvjkbL5RKRx8fHnU5nNpuNZdx4MBjYbDbi5eWF47jPz8/9fn9YDQZDPB6Hv/syOJVKRaVS4bpv2Ha79fl8RC6XKxTYoShiS+C5TrdvNJqeI+HX7mt/OPpYLgShlUpn1Wp1tVLihRZgTZ5rd3qogmBZlo7HTDbbROyZbkx3Fse1WvccDrpd5FMslaKjFrNFpdbe3JiL+ZzTRTVq9Tuz8dZqJ10eOTPD5EqlYqvTrtcqTaFtMJoi4VA6mWSLZaHJN5vNGJ1Uq69zqWTwIVCu8Y1alWu2fD4/kc1mf9Ws0+mi0ejPmkul0tXV1XQy2cmQz0PNoIBgGAbQ19dXZBAEARfp9XrwhN5yPMfzfLfbjUQiGo2mXq/3et0DrNFoeDweAh5ouLy8BENYj46OXC6X1Wo9OTk5bB7s6enp/Pz84B9gmAUi9WWSJA2Hw9FoBAIVCgVomM/ngy/DEXhGZKvVmk6noghmxH6/73A4ZJ7xbb94BvoXz0ql8hfPGCS5YTzXkKTFbreX5rNu7w3BdDwqCM3RZL7drJCHYQsatbpcyPNNmefhW18cjWWeX3JMPh3X3Jh7b0M/Rd5aLH+dKVLRUDAU5IROJknbbA6twWg23+iur5yUt9XkSNJusZL2exd4ZuinB6PlLsMUquVSOvOi1RsCHk+ByVJef61aY/NsOBLVajWFfJZh8tVqjcll82zJ4/UdPptDHZvt7pvn50hkuVis15v9Xt4sl8vgebFY/KxZpgrBmUzm/X2JVo/HI/QcYxx6fFyv19gZDkVpsYDyQEG73ZlMpjJsNHobvFEURYCAs7MzpRKnCrT09PQUo2O328GN4odhTkDvwQcMIdghkBbql+eJ4zA9GCOc4VbkqTdkw/A9PDwgslgsQmG8bM1qtSrzLNf8b54xnr9m+39rhqoy6QS08/fHCsfT2cxoMoVDflxa4wVgZ5LEFgoqpQqzNZfk+DkkMpnKjwGEkYiFvH5/fzD0eii7nVRp9H7KcXp6EozQXL3ivCc1OjwQRsetkXT5oBM3tH5POe4pDEmuVMgPxTHX4OLxyHOU1hmMPo87m06nUxlQmqBpp8ujNxjSdNRqd4DheDQSo1OUx0vgKSiXip9/7D/fMNSMNwyq+Fitv/Usz3Yymczn2d12Cxmh5vlsBjLQ3s1mM/syOJAdKITCVquVJMmwyXRKkiTR6/UgYKDxAGAFyUiLbqMfgT+GJOgf1sPfAwyd/gd1K8thdGBdNgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 05 52" title="" data-src="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" data-srcset="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在计算的时候我们将位置坐标沿着矩阵列的方向依次相乘再将结果加起来。我们的位置信息只有两个值，x 和 y。但是要进行运算需要三个值，所以我们将第三个值赋值为 1。</p>\n<p>在这个例子中结果将是</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 785px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.019108280254777%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoElEQVQI102O3Q6DIAyFff8HnO4CNxMnw0KUBApIkXWa/ZwL0nycc9pGKWWMSSlJKYdhIKJa67qszHPOGkAIgQEZbltST+U8eucY8leDGGKMROUxjqLv931nH3eFEHgEmLvuygaGpRAi5kze+0vbaq2beogoy2nqb/dSSv2Ii7R+bz7DZy+/7txszDdM1vKxS/0T+6y1M8CR+sGYEgBw4wtjYuUq2fO33AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 07 18" title="" data-src="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png" data-srcset="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-8ea14.png 200w,\n/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-2d7f3.png 400w,\n/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png 785w" data-sizes="(max-width: 785px) 100vw, 785px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想“这样做有什么意义？”，好吧，假设我们要进行平移，平移的量为 tx 和 ty，然后定义一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 154px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 120.12987012987013%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADwklEQVQ4y21Ua1fiSBDl/3/bL3Nm9MwcRVYmgAJJeCMkgfASCAICgRACqCE8RR7Ke2+IO8vZY33o011dXX2r7u02rVarYrH48K/l8/lardZoNARBMDyFQqFUKsmy/MeD+Gw2+/b2Zmq1Wn6/X1VVbGPe6XTMZrPT6Xx6epKP9vLyQpLkxcUFdhVFwYjgYDCIjCZsI/fhcNjtdvv9HhO32x2JRAwPDJN0Ok0QxOFohgfoqtWqCdflc9nJ+BUHtZ46nrySFBW5Cw8H/cl0tl1/9Hoay8UcDvuwr2mD4eGwHw4Gqcw9zpuaTblcEqIh7rnb9nioYCDspLxWi5mmSZ5PFoU8RZHnl1fEbytFukKhO7FaDfi833/+rEtNwG4VhNxjqSw1JSRrd7okRQf8XrnZbDQkpSVj9AfDuFmWGmK90W4r2LqLsqIo4uYmOnxaM7oVDodPa04mk9fX16c1VyqVx8dHE7qKbtdFEd0rl0tw2Ww2mqbRj9LRAIeiabvdfgwoY6zX616vV78ZdFkslr+PhvSgxOVyeTyey8tLLOG8urqyWq3A8seD5dnZGW7VYQMVkCzm88VysV6vwQqwoIjFAr45amEYBine39+XyyWcCM7lckDxBc+QRDQa/R/PqOULntvtdoxlUMb0bT7U1EpVJOyOeIx76nRns4X63JUkOc4n7DaiKdUlWdmsV02p8dltaM188YumyHQqw0WjTrfzr28/CkKWZ2JC7iESCdCU1+0NXlvMJOn0+wJCXvB5PN/Oz5HJBL3ep1Oj0bjf7w/6Wq8/cDpdHMsONK2ltPt9bTQeJ1MpdBuaU3vacDgYjUZQmAiFSZKE6k9rvrm5CYVCpzUnEgkwclozGNUbhgtvb29jsRhayrAMnoTd4QBVzKdFOY5DgPFaWEQwTJyPEzYbaDKNx2NwQ1EUtjFCXgiFSMA2POTR0Gqfz4ctI8xQATqtw8bLPoXtcDjwXE9h8zwPnr+ADZ7xOWANDRjbyG3wDEUgISapVMrgGdmNwyAZ8tZvromi0qj5KLJQLCEWgDkutphPCcKczwuzxRIiQS1dpdVWXoZ9NZO55+IJSAPylJCm99yJhcOE7fdsucYDZlnu42PJRAJBv3++2mXSKZfbVX8sR0KckE+DbdLjx8H/5Dl5nUynk+1uj8PGN6SpKqg2YIPnj/clOIfe1+tNpaoD12EDFSK22+1uq9djPAxMNhtocY0J2MKvaHRkvdE9D4UH/QMEVXic8Xhcp5ll0Sqc1Cn9NAYSAE/wRD+dDM/H0dRut/sP93urCpWSFFcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 00" title="" data-src="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png" data-srcset="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png 154w" data-sizes="(max-width: 154px) 100vw, 154px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后计算结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.51597051597052%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmUlEQVQI1z2NyxKEIAwE+f9PBBVPguUWYPHYoCCOS605hWY6w5RSxtizlGVRUkosrTVjzLZ9cs5YOOcpRUAi0npNKYUQBBewGNBxHNd14co4jqVW5EBg1lqttcMgIADiSfTAGKMQHF8MFCYcva5P83m2/5RS3L7P84x0j/UTaJbT5KxjPYeqGJP3/g39YKYvdfgOroM7t0O5AZDA5b65ASLvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 41" title="" data-src="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png" data-srcset="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-a67b7.png 200w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-0b187.png 400w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png 800w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果你还记得线性代数的知识，我们可以删除和 0 相乘的部分，和 1 相乘相当于没变，所以简化后为</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-8f041.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.317073170731707%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA00lEQVQI10VPrQqEYBD0GSwGgyIIgsEiCCaT2WywGDxsguBD3AUfwmqyCR4+hhdETCaDfP6CfncDhtsw7MzOsLvMMAz7vjfNR1XVOI6/KErHcdy2LU1T0zQFQYiiCPI0Teu6vqvKtm1ZlsMwZAghGOR5znGcZVlt24LOZAYWRaEoiiiKmIIiCSzLUtd1lmVd12Wu64KEnZIkwZdlGehxHMC+7zVNcxwHPWzneaKp69owDIR93/+HkyTBqXfs9j2fr0cQLMtyeyilQPzoeR7P813X/QBcGqSEWIL+4QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 15 20" title="" data-src="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-fee1c.png" data-srcset="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-a67b7.png 200w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-0b187.png 400w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-fee1c.png 800w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-8f041.png 820w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>或者更简洁</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60070752983295340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x + tx;\nnewY = y + ty;`, `60070752983295340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x + tx;\nnewY = y + ty;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其他的就不用关心了。这个看起来和平移例子中的代码有些相似。</p>\n<p>同样的来实现旋转，在旋转章节提到过，旋转只需要和旋转角对应的正弦和余弦值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25912550333998110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);`, `25912550333998110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后我们创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 146px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.71232876712328%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADyUlEQVQ4y5VUaW/iSBD1//8SRVGUU1zhyDHhMGBjjDEwhGswCQ4QokwgRMByn+YwGLLP9g7K8mGlrQ+lcruqq+u9101kMhmGYcLhMMdx8IhFUeR5PhQKcZqxLBuLxZ6enr6nBQKBQqFA3N3d9fv94XAIP5lMarXa+fl5KpWazWZY6fV6CCKRiMFgaDabo9FoMBjA1+t1mqYJiqK22+3X15fuUX91dfXy8oJ4oxmCXC7ncDiWy+UubT6fY0fC5/Opn9tNr9PRi81mc6lUQqwo6/FohEAQstfX1512C2fB52g4aDSa0WiU8HpJfL+/ik6vf7FSJGlqMpnK5df1aimKOZPJPBhJ4vOzxXjhdN6RpP/j44Px++03Nx4/g2Ivivud5nOpvOusH7vbbSVTiflSBlp2m1XMPxUKxUq1WiwUs0KOC0f2Z55Op/9jZqDdarU6nQ48Rnp/f7+8vEwkEoC0pRmIADdGo7FW++ziMK0WfLVaVdEGYIeHh6enpycnJ/BHR0dgFanHx8cnmmHFZrOB+e9pBwcHSCPcbnej0cB+oBH9397erFZrMpkEw03NEABYHBtQtdttrMBXKhWoRafqXzzvqNrNLAiC3W7fmxlnUdFer9cbRZG1f5gQxZAeYnmJnDmCX5kMOoPe+WKB4uVi0e31VcB0qsa95o97l7z5kqZq56LWOcoHU4KIAMRYzQbKTwYCIaAVDbH3LrePZv8Ud9sUTc9kZSZNd8XxeLRa/0srFmxX5p+xaCKRLBZLyUSC4/lAkPsvbUOeq9Va5xnyxAg6BJvNFnJQ5el0OmVZXq3XsrzEP2B7cXEBSSEJCMkrGQFoNxoN2FeFRpYVZQMV4IYSHo8HdxB6BrfwiHGTLRYL7qBRM2gGUCP17OxMT8NcYFtFmyTJbDaLVjhbPp9HE5wF9XgScpphEZUulyudTiN+fHzU0/6ham9m7L3HM3YHEHs8Q7OqSICLssE4KjaD4chiMZeKRcQAAqbynM1CoXhSttvNWsHIGwCmdnbd38aifDojTKeTh1iM5SN2x00w4I3wkc9687NagRicpM9DkmVRfC3/lqQRx4XSmVw8Hidu7RY0Z4NcLvfI0PQPt9vmuL2/tdIUk0ym4j/jTIA22q79lL8gCOFQ5LmQ93p9TJCPPzwQNE3NpMlsvsBIi8W83e3jYpSKBXxCjIv5HHz9ygrgeTjo9wcD5E0laTyeqDzjVn0HbDwegxtd2zvA8DyDnu+AYX4wQoADivLjcQYfLBvCbB63B4ssG2Q0CwaDIA89wMufNBbqwJX8G7IX2tvsWOWCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 35 29" title="" data-src="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png" data-srcset="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png 146w" data-sizes="(max-width: 146px) 100vw, 146px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.224719101123593%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmElEQVQI102O0Q6DIAxF/f9fNIEY42DiKJgIrSLsRh62+9SecloGY4z3dF2Xc9s8zyhaa0SElnMm8lprEQHkzNbanHM6jnEcrX0PaDCrtTrnpmkqpeCdPEENWSl1nifgXQozA0KBvK7r0J4A4b4xr34ZuzokCsuydLkHo5SS1uonw9ljCCG2v8DBH7ft03f13PUW4Rh3ZvkCzsvmBlRUjnAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 36 02" title="" data-src="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png" data-srcset="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-a67b7.png 200w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-0b187.png 400w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png 800w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93902197445102000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x *  c + y * s;\nnewY = x * -s + y * c;`, `93902197445102000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x *  c + y * s;\nnewY = x * -s + y * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>正是我们在旋转例子中得到的结果。</p>\n<p>最后是缩放，我们将两个缩放因子叫做 sx 和 sy 。</p>\n<p>然后创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 153px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 123.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAADwUlEQVQ4y3VUZ3fiSBDk/3+3jU2wb5fgNUYgRBTJIh9BhF0Q2UQTTJRAAmPwFeKdn5+P6w96rZqe6a6p7lHsdrvnL9ZoNMbj8XA4hHNCms1mt9udzWafyClsuVwqsKbX64vFYiqVSqfTuVzOaDRqNJpMJpOWDYiHpi8uLoLBIHwgWZZlGMbpdCpwTDab/fj42MsGh6ZpiqLgHA6HE4IYrVbL8/wJxHe9XgcCgWNm5MS/JIkrUYLj8XgoyrYSluu1uN+/CwJfr9WxeTR44XkBAasVPxqNnoJBBaovlYqFbObBbDYYDOJ2HwqFtGql3WGPJ9LNeo2i7I8W0qj7iyBMbo+v3+/7PLTZSnp9fmxu/i7k+70Ow4S9tHu6EEIMc2/QpdPJXP43DCSDoYj+549ImGHZbIkrZ1KpSDwRQGbwYVn2K2ev12uz2b5ybrVauMLznKPRKIKWsr29vblcLrPZLG0kXrbtdsuVOJVK9fLyIkkSLwhrURwORz6fTwEBb25u7u7ubm9v8YXvdrtJkvwEkRPiPT09XV9ff4YplUpodCwbwvR6vWq1WqvVnlsti8WCm0NFNdna7XYsFsNZiEYwECzl83koeoYz0G+cEaNWq79x9vv9x83JRBwL74eDuBKgpNfrs1qtpwgwRDDkhM6DfnexPO7nF/PBQNZ5OOirVZekzc6Vq7FwyGqj7n78xKmz1yE2oP5Gq9vp9rQqpcl0b3e4wcLlcNybHmmvT4Gmt1PWQqFQ4ir5bBbSWknK6XK+SetYNB6LhJbrTbfbudVq/k5E84UCcuRYNpFMo9WPUmEGvnHGbcPZbjbj8euJM6Q6wxkNgH4UJXE6mcIEQcC4EASBloaKUH61WmHmtFpNu9PG/ul0tlgsoc5xMyIgGuhBT3zho0lwYScQl4ycmFkUeXV19Rl2eXkJjY63ja6YTCadTgf88QygZnTFYDDoyoYBwthBZ47jsAoErVapVM7rjN7+Ns+gdn6e0VKJeGw+n+/2hxW/nM0XNO21keRs8spjnt9308mkXKnJ8zwQxQ2SIP9kOgsGA7LON0edi8VyhGEspM3w60F3pyIsllA4Xi7+ISxW44Pp0UzkYqFwhEXXPpp++QNMNB5XgKrb5Tg2dr3B4YBq1e50EWYTVypWqjXgZa4UT6Z0Ov1ztZxKZ5vNBoa83niGRud7+79v2P/Os8Nux93Kj2wTAhIWQq/To6LTywskkUhAOSSEHoA6nXaxVMJTp9hsNnhoMv9aMpnEGKBaOCcEq2heKAQENQLBFz4k/AdMA9lelU0QtQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 38 57" title="" data-src="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png" data-srcset="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png 153w" data-sizes="(max-width: 153px) 100vw, 153px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.393120393120395%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAnUlEQVQI11WOyQ6DMBBD+f8fREig5NZsiCiQfZla0EqtD3N4sseepBD7vtdapZTbtrXWiOg4DqVUKcVaO8+z9wEw5/wSwnsfY1zXVWs1AZWcex9CCKDWOnyIgY8xnHPLsoQQAXvvKWd8TyndYT3RLWRQxRjDBPoK7uu6GOdPM9F4YEyRc26M+YRRdboTI+lHtZYQgtbmD7YK82Et7huV7eWxPSf+CQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 39 34" title="" data-src="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png" data-srcset="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-a67b7.png 200w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-0b187.png 400w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png 800w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15016395303346618000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x * sx;\nnewY = y * sy;`, `15016395303346618000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x * sx;\nnewY = y * sy;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和缩放例子相似。</p>\n<p>现在你可能还会想“那又怎样，有什么意义？”，好像花了更多精力做之前做过的事情。</p>\n<p>现在开始有趣的部分了，相乘后他们可以用一个矩阵代表三个变换，假定有一个方法 m3.multiply 可以将两个矩阵相乘并返回结果。</p>\n<p>为了方便讲解，我们先创建平移，旋转和缩放矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5005169995383140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  translation: function (tx, ty) {\n    return [1, 0, 0, 0, 1, 0, tx, ty, 1];\n  },\n\n  rotation: function (angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n    return [c, -s, 0, s, c, 0, 0, 0, 1];\n  },\n\n  scaling: function (sx, sy) {\n    return [sx, 0, 0, 0, sy, 0, 0, 0, 1];\n  }\n};`, `5005169995383140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">translation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scaling</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>sx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在该修改着色器了，原来的着色器像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22594622663279673000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n      // ...\n   }\n</script>`, `22594622663279673000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n   uniform vec2 u_scale<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 缩放</span>\n      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span>\n\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新着色器就简单多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23827806877408930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 将位置乘以矩阵\n      vec2 position = (u_matrix * vec3(a_position, 1)).xy;\n      // ...\n   }\n</script>`, `23827806877408930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置乘以矩阵</span>\n      vec2 position <span class="token operator">=</span> <span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是使用的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11829166147535841000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 矩阵相乘\n  var matrix = m3.multiply(translationMatrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // 设置矩阵\n  gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n  // 绘制图形\n  gl.drawArrays(gl.TRIANGLES, 0, 18);\n}`, `11829166147535841000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制图形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个例子用的新代码，滑块没变，还是对应平移，旋转和缩放，但是他们在着色器中做的事情是相似的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4b2hc3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可能你还会问，那又怎样？看起来没什么特别好的地方。但是，如果现在我们想改变转换顺序的话，就不需要重写一个着色器了，只需要改变一下数学运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76302097659187200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(scaleMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, translationMatrix);\n\n// ...`, `76302097659187200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-5}"\n              >\n                <span class="gatsby-code-button-language">js{3-5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 矩阵相乘</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>scaleMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fdzw2v?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>像这样的矩阵相乘对层级变换至关重要，比如身体的手臂部分运动，月球属于绕太阳转动的地球的一部分，或者树上的树枝。写一个简单的层级运动的例子，我们来画 5 个 ‘F’，并且每个 ‘F’ 都以前一个的矩阵为基础。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74214796013195820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 初始矩阵\n  var matrix = m3.identity();\n\n  for (var i = 0; i < 5; ++i) {\n    // 矩阵相乘\n    matrix = m3.multiply(matrix, translationMatrix);\n    matrix = m3.multiply(matrix, rotationMatrix);\n    matrix = m3.multiply(matrix, scaleMatrix);\n\n    // 设置矩阵\n    gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n    // 绘制图形\n    gl.drawArrays(gl.TRIANGLES, 0, 18);\n  }\n}`, `74214796013195820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 初始矩阵</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 矩阵相乘</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 设置矩阵</span>\n    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 绘制图形</span>\n    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个例子中用到了一个新方法 <code class="language-text">m3.identity</code>，这个方法创建一个单位矩阵。单位矩阵就像 1.0 一样，和它相乘的矩阵不会变化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26306035738459040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  identity: function () {\n    return [1, 0, 0, 0, 1, 0, 0, 0, 1];\n  }\n};`, `26306035738459040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">identity</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是 5 个 F。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/w7p3wi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再看一个例子，之前的每个例子中 ‘F’ 都是绕着它的左上角旋转 （当然，改变转换顺序的那个例子除外）。这是因为我们总是绕原点旋转，而 ‘F’ 的原点就是左上角，也就是 (0, 0) 。</p>\n<p>现在我们可以使用矩阵运算，并且自定义转换的顺序。所以让我们改变旋转的中心</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71153316993437410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个矩阵，可以将原点移动到 \'F\' 的中心\nvar moveOriginMatrix = m3.translation(-50, -75);\n// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(translationMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, scaleMatrix);\nmatrix = m3.multiply(matrix, moveOriginMatrix);`, `71153316993437410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个矩阵，可以将原点移动到 \'F\' 的中心</span>\n<span class="token keyword">var</span> moveOriginMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 矩阵相乘</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> moveOriginMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，注意到 F 现在绕中心旋转和缩放了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3mvm0w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>通过这种方式你可以绕任意点旋转和缩放，所以现在你可能知道为什么 PhotoShop 或 Flash 可以让你移动旋转中心。</p>\n<p>还可以做更有趣的事情，如果你回想第一篇文章 WebGL 基础概念，可能会记得在着色器中我们将像素坐标转换到裁剪空间，这是当时的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73832437285374000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n// 从像素坐标转换到 0.0 到 1.0\nvec2 zeroToOne = position / u_resolution;\n\n// 再把 0->1 转换 0->2\nvec2 zeroToTwo = zeroToOne * 2.0;\n\n// 把 0->2 转换到 -1->+1 (裁剪空间)\nvec2 clipSpace = zeroToTwo - 1.0;\n\ngl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);`, `73832437285374000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// ...</span>\n<span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n<span class="token keyword">vec2</span> zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n\n<span class="token comment">// 再把 0->1 转换 0->2</span>\n<span class="token keyword">vec2</span> zeroToTwo <span class="token operator">=</span> zeroToOne <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 把 0->2 转换到 -1->+1 (裁剪空间)</span>\n<span class="token keyword">vec2</span> clipSpace <span class="token operator">=</span> zeroToTwo <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>\n\ngl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>clipSpace <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>逐步观察，首先 <code class="language-text">从像素坐标转换到 0.0 到 1.0</code> 事实上是一个缩放变换，第二步也是缩放变换，接着是一个平移和一个 Y 为 -1 的缩放。我们可以将这些操作放入一个矩阵传给着色器，创建两个缩放矩阵，一个缩放 1.0/分辨率，另一个缩放 2.0，第三个平移 (-1.0, -1.0), 然后第四个将 Y 缩放 -1。 然后将他们乘在一起，由于运算很简单，所以我们就直接定义一个 projection 方法，根据分辨率直接生成矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77853503722885200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  projection: function (width, height) {\n    // 注意：这个矩阵翻转了 Y 轴，所以 0 在上方\n    return [2 / width, 0, 0, 0, -2 / height, 0, -1, 1, 1];\n  }\n};`, `77853503722885200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">projection</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 注意：这个矩阵翻转了 Y 轴，所以 0 在上方</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">/</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在可以简化着色器，这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32798269668649850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 使位置和矩阵相乘\n      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n   }\n</script>`, `32798269668649850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 使位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 JavaScript 中需要乘上投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5595856852527481000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var projectionMatrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);\n\n  // ...\n\n  // 矩阵相乘\n  var matrix = m3.multiply(projectionMatrix, translationMatrix);\n  matrix = m3.multiply(matrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // ...\n}`, `5595856852527481000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里还去除了设置分辨率的代码，通过使用矩阵，我们就把着色器中 6-7 步的操作在一步中完成。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/uyfqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在继续之前我们可以先简化一下操作，虽然先创建一些矩阵再将它们相乘很常见，但是按照我们的顺序依次操作矩阵也比较常见，比较高效的做法是创建这样的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73513662261059820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  // ...\n\n  translate: function (m, tx, ty) {\n    return m3.multiply(m, m3.translation(tx, ty));\n  },\n\n  rotate: function (m, angleInRadians) {\n    return m3.multiply(m, m3.rotation(angleInRadians));\n  },\n\n  scale: function (m, sx, sy) {\n    return m3.multiply(m, m3.scaling(sx, sy));\n  }\n\n  // ...\n};`, `73513662261059820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token function-variable function">translate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> ty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scale</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这能够让我们将 7 行的矩阵代码转换成 4 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74184947538446580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算矩阵\nvar matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight); // 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形\nmatrix = m3.translate(matrix, translation[0], translation[1]);\nmatrix = m3.rotate(matrix, angleInRadians);\nmatrix = m3.scale(matrix, scale[0], scale[1]);`, `74184947538446580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算矩阵</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lvd1iu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最后一件事，我们之前使用了多种矩阵顺序。第一例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69393334823567180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translation * rotation * scale; // 平移 * 旋转 * 缩放`, `69393334823567180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translation <span class="token operator">*</span> rotation <span class="token operator">*</span> scale<span class="token punctuation">;</span> <span class="token comment">// 平移 * 旋转 * 缩放</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45645863107265750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scale * rotation * translation; // 缩放 * 旋转 * 平移`, `45645863107265750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scale <span class="token operator">*</span> rotation <span class="token operator">*</span> translation<span class="token punctuation">;</span> <span class="token comment">// 缩放 * 旋转 * 平移</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后观察了它们的区别。</p>\n<p>这有两种方式解读矩阵运算，给定这样一个表达式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46538605814674950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`projectionMat * translationMat * rotationMat * scaleMat * position;`, `46538605814674950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">projectionMat <span class="token operator">*</span> translationMat <span class="token operator">*</span> rotationMat <span class="token operator">*</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一种可能是多数人觉得比较自然的方式，从右向左解释</p>\n<p>首先将位置乘以缩放矩阵获得缩放后的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80535557611267520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scaledPosition = scaleMat * position;`, `80535557611267520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scaledPosition <span class="token operator">=</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放后的位置和旋转矩阵相乘得到缩放旋转位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12454058554107793000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedScaledPosition = rotationMat * scaledPosition;`, `12454058554107793000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedScaledPosition <span class="token operator">=</span> rotationMat <span class="token operator">*</span> scaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放旋转位置和平移矩阵相乘得到缩放旋转平移位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61489978039191920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translatedRotatedScaledPosition = translationMat * rotatedScaledPosition;`, `61489978039191920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translatedRotatedScaledPosition <span class="token operator">=</span> translationMat <span class="token operator">*</span> rotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后和投影矩阵相乘得到裁剪空间中的坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4927926599227272000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`clipspacePosition = projectioMatrix * translatedRotatedScaledPosition;`, `4927926599227272000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">clipspacePosition <span class="token operator">=</span> projectioMatrix <span class="token operator">*</span> translatedRotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二种方式是从左往右解释，在这个例子中每一个矩阵改变的都是画布的坐标空间，画布的起始空间是裁剪空间的范围(-1 到 +1)，矩阵从左到右改变着画布所在的空间。</p>\n<ol>\n<li>没有矩阵（或者单位矩阵）</li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=0) -->\n<p>白色区域是画布，蓝色是画布以外，我们正在裁剪空间中。传递到这里的点需要在裁剪空间内。</p>\n<ol start="2">\n<li><code class="language-text">matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=1) -->\n<p>现在我们在像素空间，X 范围是 0 到 400，Y 范围是 0 到 300，0,0 点在左上角。传递到这里的点需要在像素空间内，你看到的闪烁是 Y 轴上下颠倒的原因。</p>\n<ol start="3">\n<li><code class="language-text">matrix = m3.translate(matrix, tx, ty);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=2) -->\n<p>原点被移动到了 tx, ty (150, 100)，所以空间移动了。</p>\n<ol start="4">\n<li><code class="language-text">matrix = m3.rotate(matrix, rotationInRadians);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=3) -->\n<p>空间绕 tx, ty 旋转</p>\n<ol start="5">\n<li><code class="language-text">matrix = m3.scale(matrix, sx, sy);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=4) -->\n<p>之前的旋转空间中心在 tx, ty，x 方向缩放 2，y 方向缩放 1.5</p>\n<p>在着色器中执行 <code class="language-text">gl_Position = matrix * position;</code>，position 被直接转换到这个空间。</p>\n<p>选一个你容易接受的方式去理解吧。</p>\n<h1 id="webgl-实现-drawimage-接口"><a href="#webgl-%E5%AE%9E%E7%8E%B0-drawimage-%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 实现 DrawImage 接口</h1>\n<p>此文上接 WebGL 三维正射投影，如果没读建议从那里开始，你也应了解纹理和纹理坐标，如果不清楚可以看看 WebGL 三维纹理。</p>\n<p>实现大多数二维游戏只需要一个方法去绘制一个图像，当然也有一些二维游戏用线等技术做一些有趣的东西，但是如果你有绘制二维图像的方法，基本上可以做大多数二维游戏。</p>\n<p>画布有一个非常灵活的二维接口叫做 drawImage，用于绘制图像。它有三个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53541277295653585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY);\nctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);\nctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `53541277295653585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>用你现在学到的所有东西如何使用 WebGL 实现这个接口？你想到的办法可能是创建一些顶点，像本站第一篇文章那样。将顶点传送到 GPU 是一个比较耗时的操作（尽管某些情况下比较快）。</p>\n<p>这就是 WebGL 发挥作用的地方，讲究富有创造性地编写着色器和使用它们去解决问题。</p>\n<h2 id="drawimage-版本一"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本一</h2>\n<p>让我们从第一个版本开始</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81296632265980380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, x, y);`, `81296632265980380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>它可以在 x, y 位置处绘制一个原始大小的图像，为了实现相似的功能，WebGL 需要上传 x, y, <code class="language-text">x + width</code>, y, x, <code class="language-text">y + height</code> 和 <code class="language-text">x + width</code>, <code class="language-text">y + height</code> 对应的顶点，当绘制不同的图像或不同的位置时就创建不同的顶点集合。</p>\n<p>一个更常用的方式是只使用一个单位矩形，我们上传一个长度为 1 个单位的正方形，然后使用矩阵运算缩放和平移单位矩形，以达到期望的大小和位置。</p>\n<p>这是代码。</p>\n<p>首先需要一个简单的顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36569687094123536000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = a_texcoord;\n}`, `36569687094123536000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n   v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和一个简单的片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53520297142019450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `53520297142019450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后轮到方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26633678692459205000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不同于图像，纹理没有对应的长和宽\n// 我们将向纹理传递长和宽\nfunction drawImage(tex, texWidth, texHeight, dstX, dstY) {\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 告诉 WebGL 使用的程序\n  gl.useProgram(program);\n\n  // 设置属性，从缓冲中提取数据\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n  gl.enableVertexAttribArray(positionLocation);\n  gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n  gl.enableVertexAttribArray(texcoordLocation);\n  gl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n  // 从像素空间转换到裁剪空间\n  var matrix = m4.orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1);\n\n  // 平移到 dstX, dstY\n  matrix = m4.translate(matrix, dstX, dstY, 0);\n\n  // 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度\n  matrix = m4.scale(matrix, texWidth, texHeight, 1);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `26633678692459205000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不同于图像，纹理没有对应的长和宽</span>\n<span class="token comment">// 我们将向纹理传递长和宽</span>\n<span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 使用的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置属性，从缓冲中提取数据</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们来加载一些图像用于纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71235931015618000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理信息 { width: w, height: h, texture: tex }\n// 纹理起初为 1x1 像素，当图像加载完成后更新大小\nfunction loadImageAndCreateTextureInfo(url) {\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 假设所有的图像维度都不是 2 的整数次幂\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\n  var textureInfo = {\n    width: 1, // 图像加载前不知道大小\n    height: 1,\n    texture: tex\n  };\n  var img = new Image();\n  img.addEventListener(\'load\', function () {\n    textureInfo.width = img.width;\n    textureInfo.height = img.height;\n\n    gl.bindTexture(gl.TEXTURE_2D, textureInfo.texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);\n  });\n\n  return textureInfo;\n}\n\nvar textureInfos = [\n  loadImageAndCreateTextureInfo(\'resources/star.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/leaves.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/keyboard.jpg\')\n];`, `71235931015618000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理信息 { width: w, height: h, texture: tex }</span>\n<span class="token comment">// 纹理起初为 1x1 像素，当图像加载完成后更新大小</span>\n<span class="token keyword">function</span> <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设所有的图像维度都不是 2 的整数次幂</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> textureInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    width<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 图像加载前不知道大小</span>\n    height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    texture<span class="token punctuation">:</span> tex\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    textureInfo<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width<span class="token punctuation">;</span>\n    textureInfo<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height<span class="token punctuation">;</span>\n\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> textureInfo<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> textureInfos <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/keyboard.jpg\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>绘制到随机位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38464606450850100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var drawInfos = [];\nvar numToDraw = 9;\nvar speed = 60;\nfor (var ii = 0; ii < numToDraw; ++ii) {\n  var drawInfo = {\n    x: Math.random() * gl.canvas.width,\n    y: Math.random() * gl.canvas.height,\n    dx: Math.random() > 0.5 ? -1 : 1,\n    dy: Math.random() > 0.5 ? -1 : 1,\n    textureInfo: textureInfos[(Math.random() * textureInfos.length) | 0]\n  };\n  drawInfos.push(drawInfo);\n}\n\nfunction update(deltaTime) {\n  drawInfos.forEach(function (drawInfo) {\n    drawInfo.x += drawInfo.dx * speed * deltaTime;\n    drawInfo.y += drawInfo.dy * speed * deltaTime;\n    if (drawInfo.x < 0) {\n      drawInfo.dx = 1;\n    }\n    if (drawInfo.x >= gl.canvas.width) {\n      drawInfo.dx = -1;\n    }\n    if (drawInfo.y < 0) {\n      drawInfo.dy = 1;\n    }\n    if (drawInfo.y >= gl.canvas.height) {\n      drawInfo.dy = -1;\n    }\n  });\n}\n\nfunction draw() {\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  drawInfos.forEach(function (drawInfo) {\n    drawImage(\n      drawInfo.textureInfo.texture,\n      drawInfo.textureInfo.width,\n      drawInfo.textureInfo.height,\n      drawInfo.x,\n      drawInfo.y\n    );\n  });\n}\n\nvar then = 0;\nfunction render(time) {\n  var now = time * 0.001;\n  var deltaTime = Math.min(0.1, now - then);\n  then = now;\n\n  update(deltaTime);\n  draw();\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `38464606450850100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> drawInfos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> numToDraw <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> speed <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> numToDraw<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> drawInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    x<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n    y<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n    dx<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    dy<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    textureInfo<span class="token punctuation">:</span> textureInfos<span class="token punctuation">[</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> textureInfos<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>drawInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">deltaTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    drawInfo<span class="token punctuation">.</span>x <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dx <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    drawInfo<span class="token punctuation">.</span>y <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dy <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">drawImage</span><span class="token punctuation">(</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>y\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> then <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> now <span class="token operator">=</span> time <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> deltaTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> now <span class="token operator">-</span> then<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  then <span class="token operator">=</span> now<span class="token punctuation">;</span>\n\n  <span class="token function">update</span><span class="token punctuation">(</span>deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以在这里看到运行结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6hmyzm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本二"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本二</h2>\n<p>处理 drawImage 方法的第二个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17816239519617038000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);`, `17816239519617038000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>没什么特别的地方，只是用 dstWidth 和 dstHeight 代替了 texWidth 和 texHeight。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39658469932322560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstWidth === undefined) {\n    dstWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `39658469932322560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-18}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-18}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将代码修改为使用不同的大小</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/idjd75?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本三"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本三</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72413462158651340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `72413462158651340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了实现选择部分纹理，就需要操控纹理坐标。纹理坐标的工作原理在这篇文章中讲到，在那篇文章中我们手工创建纹理坐标，是一个非常常见的方式，但是我们也可以在运行时创建，然后使用矩阵简单的修改纹理坐标。</p>\n<p>让我们给顶点着色器添加一个纹理坐标矩阵，然后将纹理坐标和矩阵相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70629818804246300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * vec4(a_texcoord, 0, 1)).xy;\n}`, `70629818804246300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,11}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_texcoord<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们要找到纹理矩阵的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63405977339412380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var matrixLocation = gl.getUniformLocation(program, \'u_matrix\');\nvar textureMatrixLocation = gl.getUniformLocation(program, \'u_textureMatrix\');`, `63405977339412380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> matrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_matrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> textureMatrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_textureMatrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>在 drawImage 方法中需要设置它，用于选择我们需要的部分。我们知道纹理坐标是一个单位矩形所以可以简单的修改，就像对位置的处理一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26503353095910363000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstX === undefined) {\n    dstX = srcX;\n    srcX = 0;\n  }\n\n  if (dstY === undefined) {\n    dstY = srcY;\n    srcY = 0;\n  }\n\n  if (srcWidth === undefined) {\n    srcWidth = texWidth;\n  }\n\n  if (srcHeight === undefined) {\n    srcHeight = texHeight;\n  }\n\n  if (dstWidth === undefined) {\n    dstWidth = srcWidth;\n    srcWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = srcHeight;\n    srcHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 因为纹理坐标的范围是 0 到 1\n  // 并且我们的纹理坐标是一个单位矩形\n  // 我们可以旋转平移矩形选择一部分纹理\n  var texMatrix = m4.translation(srcX / texWidth, srcY / texHeight, 0);\n  texMatrix = m4.scale(texMatrix, srcWidth / texWidth, srcHeight / texHeight, 1);\n\n  // 设置纹理矩阵\n  gl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `26503353095910363000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-18,21-22,26-27,50-57}"\n              >\n                <span class="gatsby-code-button-language">js{1-18,21-22,26-27,50-57}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstX <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstX <span class="token operator">=</span> srcX<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstY <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstY <span class="token operator">=</span> srcY<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> srcWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> srcHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 因为纹理坐标的范围是 0 到 1</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 并且我们的纹理坐标是一个单位矩形</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 我们可以旋转平移矩形选择一部分纹理</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>srcX <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcY <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcHeight <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 设置纹理矩阵</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也上传了这个版本的例子，这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/50p8z5?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>不同于画布的二维接口，WebGL 对 drawImage 的情况做了更多的处理。</p>\n<p>一个是我们可以给源或者目标宽高传递负值，负的 srcWidth 会选择 srcX 左边的像素，负的 dstWidth 会将图像绘制在 dstX 的左边，在画布的二维接口中报错是好一点的情况，坏一点时会出现 udefined。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ytbfsj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>另一个是我们使用矩阵就可以实现任何矩阵运算可以实现的效果。</p>\n<p>例如绕纹理中心旋转纹理坐标。</p>\n<p>修改纹理坐标的矩阵代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90577592863658210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间\nvar texMatrix = m4.scaling(1 / texWidth, 1 / texHeight, 1);\n\n// 选择一个旋转中心\n// 移动到中心旋转后在回来\nvar texMatrix = m4.translate(texMatrix, texWidth * 0.5, texHeight * 0.5, 0);\nvar texMatrix = m4.zRotate(texMatrix, srcRotation);\nvar texMatrix = m4.translate(texMatrix, texWidth * -0.5, texHeight * -0.5, 0);\n\n// 因为在像素空间，缩放和平移现在是按像素单位\nvar texMatrix = m4.translate(texMatrix, srcX, srcY, 0);\nvar texMatrix = m4.scale(texMatrix, srcWidth, srcHeight, 1);\n\n// 设置纹理矩阵\ngl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);`, `90577592863658210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 选择一个旋转中心</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 移动到中心旋转后在回来</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcRotation<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 因为在像素空间，缩放和平移现在是按像素单位</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置纹理矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fs0bbt?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可以看出一个问题，在旋转的过程中会看到超出边缘的纹理，由于设置的是 <code class="language-text">CLAMP_TO_EDGE</code> 所以得到重复的边缘。</p>\n<p>我们可以在着色器中丢弃超出 0 到 1 范围的纹理，discard 将会立即退出着色器，不写入像素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43936595649139680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     discard;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `43936595649139680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{8-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">discard</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在边缘消失了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vf56m7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>或者你想的话也可以对超出的部分使用纯色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25735447126117396000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     gl_FragColor = vec4(0, 0, 1, 1); // 蓝色\n     return;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `25735447126117396000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">     gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 蓝色</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">return</span><span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/pd6src?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>接下来讲实现画布二维接口中的矩阵栈。</p>\n<h2 id="一个小优化"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个小优化</h2>\n<p>我并不是要建议使用这个优化，而是想提出更多创意性的想法，因为使用 WebGL 就是利用它提供的特性去做创意。</p>\n<p>你可能会注意到我们使用的位置单位矩形和纹理坐标刚好匹配，所以我们就可以使用位置作为纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19585312967204470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\n// attribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * a_position).xy;\n}`, `19585312967204470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{11}"\n              >\n                <span class="gatsby-code-button-language">glsl{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token comment">// attribute vec2 a_texcoord;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在移除关于纹理坐标设置的代码，得到的结果和之前是相同的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/n0b4pe?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>// TODO <a href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html" target="_blank" rel="nofollow noreferrer noopener">https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html</a></p>',
excerpt:"WebGL…",frontmatter:{date:"2022-08-05 18:45:42",path:"/webgl-fundamental-2d/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——二维",draft:null}},prePost:{html:'<p>之前，CSS 世界中除受限诸多的表格布局之外是没有专门的布局属性的，随着 Web 应用越来越复杂，显示设备越来越多样，原有的 CSS 特性已经无法满足现代 Web 开发需求了。于是，CSS 定义了很多全新的布局方式，这些新的布局 CSS 使用简单，效果精美，是所有前端开发者必学必会的技能。</p>\n<h1 id="分栏布局"><a href="#%E5%88%86%E6%A0%8F%E5%B8%83%E5%B1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分栏布局</h1>\n<p>分栏布局也被称为多列布局、多栏布局，这种布局可以将内容布局到多个列框中，类似报纸上的排版。</p>\n<p>分栏布局比较特殊，有别于传统布局，它将子元素在内的所有内容拆分为列，这与打印网页的时候将网页内容分成多个页面的方式类似。分栏布局主要针对图文排版布局，应用在横向排版场景中，文档流是倒 N 方向。有个别布局只能使用分栏布局实现，分栏布局虽然在日常开发中用得不多，但是遇到合适的场景时是一种非常有用的布局方式。</p>\n<p>IE10+ 浏览器都可以使用分栏布局，API 稳定，在移动端的兼容性比弹性布局要好，可以放心使用。例如，有一段无序列表，HTML 代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96075345984633470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<ul>\n   <li>重庆市</li>\n   <li>哈尔滨市</li>\n   <li>长春市</li>\n   <li>兰州市</li>\n   <li>北京市</li>\n   <li>杭州市</li>\n   <li>长沙市</li>\n   <li>沈阳市</li>\n   <li>成都市</li>\n   <li>合肥市</li>\n   <li>天津市</li>\n   <li>西安市</li>\n</ul>`, `96075345984633470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>重庆市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>哈尔滨市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>长春市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>兰州市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>北京市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>杭州市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>长沙市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>沈阳市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>成都市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>合肥市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>天津市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>西安市<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到每一个列表项的内容很少，如果容器的宽度足够，则可以使用 columns 属性实现分栏布局，让排版更舒服，代码超级简单：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83890649356669760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ul {\n   columns: 2;\n}`, `83890649356669760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">ul</span> <span class="token punctuation">{</span>\n   <span class="token property">columns</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>效果如图 6-1 所示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-04-01-00-09-57-4cccb1966e86df0d70574a6cbeeef636-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.87417218543047%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAB9ElEQVQoz6WRW4+aQBzF+f7foe17k6bbNF2ji/Wy4q3tKgLLLkqFGWa4XwXlIto/NWnaGJ96HiYzwxzO/M4wpmWFrvXu7ZsnfrXg+a2un8/n0+l0/kuX5W63C8PQti1Zljeb9ZLnmTTLDvuM53nDIKZl+r5f1/84/6goijzPkzgmhmGCbIshhCRhNJvOFFWVBIHjxrwgVMf6OjlJEt/3XNeZjKZzbs6LIpMXRZkXGGHbdeFHBqXZPqvr+jq5+q1dHG+3GtKQadsMQihN0/VaabXuuemMmuYt5iiOPc+lBD+wnXaPXUkSU5ZlVZaB7wEJJiSMomvzRcdGVZbuNE1X1hvLcZrkfZYKK0AQl6JkGMbN5CjyPN+kePB1wA0moiwz0CEke56DdF3HOAjDW8kADNFRGGiatlFVuCaDMd4f9qr6ulgunl9eCL3JHMcJdB0E7rMk9h9HsqIwB9A+/blVgVlDyPW8W8lNO1VpmURq6AhCGJhxEgfLp++CKKxkmVAC5+CpwH8ZLxPYDMMIHhmj7eNwOP/243WtMOf/UGO2bNt23PyQN+VVR+iMWrDnUNMKwshxPd8PPD+g1IKpQShcAb7D2JjZbr/VZhHGgA+HOmzvge2PuOnd5/vhaDyZzkeTWbc3/PjpCyzff7gbT2btTnfJC78A77gIHRn20q0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 04 01 00 09 57" title="" data-src="/static/2022-04-01-00-09-57-4cccb1966e86df0d70574a6cbeeef636-a36d1.png" data-srcset="/static/2022-04-01-00-09-57-4cccb1966e86df0d70574a6cbeeef636-765e7.png 200w,\n/static/2022-04-01-00-09-57-4cccb1966e86df0d70574a6cbeeef636-c9f48.png 400w,\n/static/2022-04-01-00-09-57-4cccb1966e86df0d70574a6cbeeef636-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1x8rly?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>相比其他布局方法，分栏布局最大的优点是不会改变元素原本的 display 计算值。例如，在默认状态下，<code class="language-text">&lt;li&gt;</code> 元素会出现项目符号，如圆点或数字序号。此时，如果对 <code class="language-text">&lt;li&gt;</code> 元素使用弹性布局或网格布局，则项目符号就会消失，因为 display: flex 或 display: grid 会重置 <code class="language-text">&lt;li&gt;</code> 元素内置的 display: list-item 声明。</p>\n<p>我通过以上内容带大家初步了解了分栏布局的特性和使用方法，接下来，我们开始详细了解与分栏布局相关的 CSS 属性。与分栏布局相关的 CSS 属性共有以下 10 个：</p>\n<ul>\n<li>columns</li>\n<li>column-width</li>\n<li>column-count</li>\n<li>column-rule</li>\n<li>column-rule-color</li>\n<li>column-rule-style</li>\n<li>column-rule-width</li>\n<li>column-span</li>\n<li>column-fill</li>\n<li>column-gap</li>\n</ul>\n<p>虽然这 10 个 CSS 属性都有各自的作用，但是在实用程度上却有明显的差异。根据我的开发经验，超过 80% 的分栏布局只需要使用 columns 属性就足够，因此，大家的学习重心可以放在 columns 属性上，column-gap 属性有时候也会用到，所以也可以关注下，至于剩下的属性，大家了解一下基本作用即可。</p>\n<h2 id="重点关注-columns-属性"><a href="#%E9%87%8D%E7%82%B9%E5%85%B3%E6%B3%A8-columns-%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重点关注 columns 属性</h2>\n<p>columns 属性是 column-width 和 column-count 属性的缩写，举几个使用 columns 属性的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33059960285787150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/*栏目宽度*/\ncolumns: 18em;\n\n/*栏目数目*/\ncolumns: auto;\ncolumns: 2;\n\n/*同时定义宽度和数目，顺序任意*/\ncolumns: 2 auto;\ncolumns: auto 2;\ncolumns: auto 12em;\ncolumns: auto auto;`, `33059960285787150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/*栏目宽度*/</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> 18em<span class="token punctuation">;</span>\n\n<span class="token comment">/*栏目数目*/</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n\n<span class="token comment">/*同时定义宽度和数目，顺序任意*/</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> 2 auto<span class="token punctuation">;</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> auto 2<span class="token punctuation">;</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> auto 12em<span class="token punctuation">;</span>\n<span class="token property">columns</span><span class="token punctuation">:</span> auto auto<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="关于-column-width"><a href="#%E5%85%B3%E4%BA%8E-column-width" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于 column-width</h3>\n<p>column-width 表示每一栏/列的最佳宽度，注意，是“最佳宽度”，实际渲染宽度多半和指定的宽度是有出入的，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21248528024148140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.container {\n   width: 300px;\n   column-width: 200px;\n}`, `21248528024148140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.container</span> <span class="token punctuation">{</span>\n   <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>\n   <span class="token property">column-width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里容器宽度为 300px，设定每一栏的宽度是 200px，不足以分栏，此时容器里面的内容会无视 column-width: 200px 声明，并按照容器的 300px 宽度排版。又如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21923781347559410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.container {\n   width: 200px;\n   column-width: 300px;\n}`, `21923781347559410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.container</span> <span class="token punctuation">{</span>\n   <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>\n   <span class="token property">column-width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里容器宽度为 200px，设定的每一栏宽度是 300px，比容器宽度还要宽，此时容器里面的内容会无视 column-width: 300px 声明，并按照容器的 200px 宽度排版。</p>\n<p>那么，什么情况下 column-width 设置的宽度值和实际渲染的宽度值一致呢？这个问题的答案可能会出乎大家的意料：几乎不存在分栏布局的栏目宽度就是 column-width 设置的宽度这样的场景。</p>\n<p>因为 column-width 和传统的 width 属性不同，column-width 更像是一个期望尺寸，浏览器会根据这个期望尺寸确定分栏数目，一旦分栏数目确定了，column-width 属性的使命也就完成了，接下来根据分栏数目对容器进行的分栏布局就和 column-width 属性没有任何关系了。</p>\n<p>没错，column-width 属性在分栏布局中就是一个工具属性。而且 column-width 相比 width 属性在语法上还有很多限制，例如 column-width 不支持百分比值，即下面的语句是不合法的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59054605229528590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* 不合法 */\ncolumn-width: 30%;`, `59054605229528590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* 不合法 */</span>\n<span class="token property">column-width</span><span class="token punctuation">:</span> 30%<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="关于-column-count"><a href="#%E5%85%B3%E4%BA%8E-column-count" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于 column-count</h3>\n<p>column-count 表示理想的分栏数目，又出现了很微妙的词——“理想的”，也就是意味着最终的分栏数目可能不受 column-count 属性值的控制。</p>\n<p>没错，在分栏布局中，最终分栏的数量是由 column-count 与 column-width 属性共同决定的，不对，不能称为“共同决定”，应该叫作“互相制约”。也就是说，在分栏布局中，最终分栏的数量要么由 column-count 属性决定，要么由 column-width 属性决定，这两个 CSS 属性都可能有更高的决定权，至于哪个 CSS 属性的决定权更高，是要看具体场景的。</p>\n<p>决定权优先级的计算诀窍可以用一句话概括：统一转换 column-count 值，哪个值小就使用哪一个。例如，下面的 CSS 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57813581490704966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.container-1 {\n   width: 360px;\n   column-count: 2;\n   column-width: 100px;\n}\n\n.container-2 {\n   width: 360px;\n   column-count: 4;\n   column-width: 100px;\n}`, `57813581490704966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.container-1</span> <span class="token punctuation">{</span>\n   <span class="token property">width</span><span class="token punctuation">:</span> 360px<span class="token punctuation">;</span>\n   <span class="token property">column-count</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n   <span class="token property">column-width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token selector">.container-2</span> <span class="token punctuation">{</span>\n   <span class="token property">width</span><span class="token punctuation">:</span> 360px<span class="token punctuation">;</span>\n   <span class="token property">column-count</span><span class="token punctuation">:</span> 4<span class="token punctuation">;</span>\n   <span class="token property">column-width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 .container-1 是 2 栏显示，而 .container-2 是 3 栏显示。效果如图 6-2 所示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-11-12-13-b39ca39ea6d0e9f56d6a3f3f6e0d6ef7-19c9a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 343px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 81.63265306122447%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAACrElEQVQoz01S6W7TQBDug4KqlAdAgnIJ8RL84A8SlZDoQdVS1LulgKAHLeVQmjRx7PhKansdr2PHt9e7yzitU0bfjmZW82lnvtkpzvn7paXa9PSzp09mHz6YqdVURYZLSikvjXHGSj8JSn9jU3AOT3++mnv7bmVtbnH55es3+sAhnIcFCwoeMx5znlSIKAMfUpbSimxzjghzCRtS7lJ+FSQKHplx7hZc80LBwm3LERFuXdm6H0q2exXnelaRrbRQda3VuJA6HVFoy5LYajZVWSkKih1bU1VkGpoiy12pr/fEdmuALKeoyEZMBEmGouZFQ2iDCXK3q+i9oefZllmv14VOB1koDMM4TtI4iuPIyivyCIbhHFIYL+UcJ5kTZzgt3JTglAzCFODlbFQwmDagfEQ5ytkNudFoLK+ube7sbWzvrH5cx54Hl4SxovQcPB0HgJyya7CJ2vMLC3dqM4+fv7g/++juzD2hW64qoyxjAF6ijDmsgIwbTBmnbKJ2znpBagSxGaZWlDk5AxjQbUpQQlCcY8LthMAW+n4EKWzSmrRtE26CgMh0B7bR74VhAKq0LhsQa5omdgRGqYMQJIooBCMfKGZWkc2USpouK0pXli8FwcbDnOSiKImS1FHUvmEwxkBoVv0tkOD2ZSspoFQS2qos//117vsjeAo+qdqVdFW1TaMgOf/PgHerdj9lbYQVx9OGQbNvWQkxo0yyh93BUMV+xxr0/BjGBiEwKTHImZ5W5Hy8XkgTWraUjW+KSls6DrLrmjGSsfIl2UK27/usKKDVPMtG0LTvu9jFjjN03SgIbIQgdjEO/FEEnwwQhUBxsDu1vXewu//595+650GOj45Pvx2ebGzvLS5/WFvfql805xdXNrZ21zd3dj992T/4enb++/jH2fejE2D9AzTMbcodpPWEAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 11 12 13" title="" data-src="/static/2022-07-26-11-12-13-b39ca39ea6d0e9f56d6a3f3f6e0d6ef7-19c9a.png" data-srcset="/static/2022-07-26-11-12-13-b39ca39ea6d0e9f56d6a3f3f6e0d6ef7-11dc8.png 200w,\n/static/2022-07-26-11-12-13-b39ca39ea6d0e9f56d6a3f3f6e0d6ef7-19c9a.png 343w" data-sizes="(max-width: 343px) 100vw, 343px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>具体解析过程如下。</p>\n<ol>\n<li>.container-1 元素宽度为 360px，因此 column-width: 100px 换算成 column-count 的值是 3.6，而.container-1 元素已经设定了 column-count: 2，遵循“哪个值小哪个优先级高”的规则，最终 .container-1 元素的内容分成了 2 栏。</li>\n<li>.container-2 元素设置的是 column-count: 4，比 column-width: 100px 换算成的 column-count 值大，因此，最终 .container-2 元素的内容分成了 3 栏（3.6 栏向下取整）。</li>\n</ol>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5kznl4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>另外，从图 6-2 所示的 .container-2 的效果可以看出，分栏布局的每一栏的高度并不总是相等的，内容的分割也不总是均匀的，浏览器有一套自己的算法。</p>\n<h2 id="column-gap-和-gap-属性的关系"><a href="#column-gap-%E5%92%8C-gap-%E5%B1%9E%E6%80%A7%E7%9A%84%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>column-gap 和 gap 属性的关系</h2>\n<p>column-gap 属性表示每一栏之间的空白间隙的大小，可以是长度值，也可以是百分比值，语法示意如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55429846704144370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* 关键字属性值 */\ncolumn-gap: normal;\n\n/* 长度值 */\ncolumn-gap: 3px;\ncolumn-gap: 3em;\n\n/* 百分比值 */\ncolumn-gap: 3%;`, `55429846704144370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* 关键字属性值 */</span>\n<span class="token property">column-gap</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>\n\n<span class="token comment">/* 长度值 */</span>\n<span class="token property">column-gap</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>\n<span class="token property">column-gap</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span>\n\n<span class="token comment">/* 百分比值 */</span>\n<span class="token property">column-gap</span><span class="token punctuation">:</span> 3%<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>column-gap 属性本身没什么好说的，但是 column-gap 属性和 gap 属性之间的关系值得一提。实际上，在分栏布局中，如果不考虑 IE 浏览器，我们可以直接使用 gap 属性设置分栏间隙大小，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23741766398462970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.container {\n   columns: 2;\n   gap: 1rem;\n}`, `23741766398462970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.container</span> <span class="token punctuation">{</span>\n   <span class="token property">columns</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n   <span class="token property">gap</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>至于原因，用一句话解释就是：column-gap 是 gap 属性的子属性。</p>\n<p>在网格布局规范制定之后的一段时间，CSS 世界中的行与列之间的间隙使用了 gap 属性进行了统一，也就是分栏布局、弹性布局和网格布局的间隙都全部统一使用 gap 属性表示，而 gap 属性实际上是 column-gap 属性和 row-gap 属性的缩写。</p>\n<h2 id="了解-column-rule、column-span-和-column-fill-属性"><a href="#%E4%BA%86%E8%A7%A3-column-rule%E3%80%81column-span-%E5%92%8C-column-fill-%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>了解 column-rule、column-span 和 column-fill 属性</h2>\n<p>本节介绍的 3 个分栏布局属性都有各自独特的作用，平常不太用得到，多出现在对分栏布局效果要求更高的场景中。</p>\n<h3 id="了解-column-rule-属性"><a href="#%E4%BA%86%E8%A7%A3-column-rule-%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>了解 column-rule 属性</h3>\n<p>column-rule 属性是 column-rule-width、column-rule-style 和 column-rule-color 这 3 个 CSS 属性的缩写，正如 border 是 border-style、border-width 和 border-color 的缩写一样。</p>\n<p>column-rule 属性和 border 属性的语法和规则是一模一样的，只是 column-rule 是设置各个分栏的分隔线样式，border 是设置元素的边框样式。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15537864203637230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.container {\n   width: 320px;\n   border: solid deepskyblue;\n   padding: 10px;\n   column-count: 2;\n   column-rule: dashed deepskyblue;\n}`, `15537864203637230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.container</span> <span class="token punctuation">{</span>\n   <span class="token property">width</span><span class="token punctuation">:</span> 320px<span class="token punctuation">;</span>\n   <span class="token property">border</span><span class="token punctuation">:</span> solid deepskyblue<span class="token punctuation">;</span>\n   <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>\n   <span class="token property">column-count</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n   <span class="token property">column-rule</span><span class="token punctuation">:</span> dashed deepskyblue<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>效果如图 6-3 所示，2 栏文字内容的中间出现了 3px 宽的虚线分隔线。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-b4e45.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.16957605985037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABT0lEQVQY002QzZLaMBCEef9nySmHrco1h6Rq4wBbwDoLGBtkA/7H9mZly0hfBieHTKmrNTM9PSrNPheWdTvy8zayaEbmgh+F5rnUUjOs3h3zzvHcWJbSW7b3CYuJLXPRPGZXjeFTZpmtbgPtRXGNFV1VkiWKzWLOi+dxVYpHGAdRUXONDqRJTJ1eJq7SM9fTkfgY0pcpL50YetVAek6IVExWVpyShHOasQ9D8qqeDJs7/Mobtm8+X799Z+2/4j2WrjfowWCsm3Re65gtq578FBIFe/LLBRWF0/bjYUcY7HBDjxZ91luwRs4AoxH8Yyx/w8kLxfBLeSdoNJtas+1G3pqBbWvwJfdvmsOHZdeDr0GNcBSP03+IpLf/cMS946kUw0KKpQhrWaRazfm3Ie766Z4NllTfiaqOIK/Z5zfC+p2gaCbsJI87TSHzuXz0A38A2X/CspI62McAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 11 25 30" title="" data-src="/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-fee1c.png" data-srcset="/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-a67b7.png 200w,\n/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-0b187.png 400w,\n/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-fee1c.png 800w,\n/static/2022-07-26-11-25-30-890d4bca4aa72f86514d43bbd7e17f01-b4e45.png 802w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/quonzj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="了解-column-span-属性"><a href="#%E4%BA%86%E8%A7%A3-column-span-%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>了解 column-span 属性</h3>\n<p>column-span 属性有点类似表格布局中的 HTML 属性 colspan，表示某一个内容是否跨多栏显示。这个 CSS 属性是作用在分栏布局的子元素上的。语法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36378485597980246000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`column-span: none;\ncolumn-span: all;`, `36378485597980246000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">column-span</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>\n<span class="token property">column-span</span><span class="token punctuation">:</span> all<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>先讲一下这一语法中的几个关键点。</p>\n<ul>\n<li>none 表示不横跨多栏，默认值。</li>\n<li>all 表示横跨所有垂直列。</li>\n</ul>\n<p>我们一起来看一个例子，就知道这个属性是做什么的了，HTML 和 CSS 代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70079404133945380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<div class=&quot;container&quot;>\n   <p>第1段</p>\n   <p>第2段</p>\n   <p>第3段</p>\n   <p class=&quot;span-all&quot;>第4段</p>\n   <p>第5段</p>\n</div>\n<style>\n   .container {\n      width: 320px;\n      border: solid deepskyblue;\n      padding: 10px;\n      column-count: 3;\n   }\n\n   .container p {\n      background: deepskyblue;\n   }\n\n   .span-all {\n      column-span: all;\n      color: white;\n   }\n</style>`, `70079404133945380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html{21}"\n              >\n                <span class="gatsby-code-button-language">html{21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>第1段<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>第2段<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>第3段<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>span-all<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>第4段<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>第5段<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n   <span class="token selector">.container</span> <span class="token punctuation">{</span>\n      <span class="token property">width</span><span class="token punctuation">:</span> 320px<span class="token punctuation">;</span>\n      <span class="token property">border</span><span class="token punctuation">:</span> solid deepskyblue<span class="token punctuation">;</span>\n      <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>\n      <span class="token property">column-count</span><span class="token punctuation">:</span> 3<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token selector">.container p</span> <span class="token punctuation">{</span>\n      <span class="token property">background</span><span class="token punctuation">:</span> deepskyblue<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token selector">.span-all</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token property">column-span</span><span class="token punctuation">:</span> all<span class="token punctuation">;</span></span>      <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果如图 6-4 所示，对比图中左侧的默认效果，可以看到，设置了 column-span: all 的“第 4 段”文字所在的 <code class="language-text">&lt;p&gt;</code> 元素几乎贯穿了整个容器元素。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-11-31-15-7ce4d7dcee191864c66ac821e0ea0ada-96dff.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 494px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.198380566801625%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQY0z2Ou04CURCG9/ksjI2FlQ9gbYgajYWFhRZ0mhASqbSxMAYxNCAJ4SIXgQUiFxXWBYGFsxfO4ezZM+OChslffJn5k28USwCVOOaybgt1Dm0KqsmLtizPUaduXRt2Bz+tvl6bsRwReQdVx3slbsaEBgUl2DKDOt7rbDcz2Kh6Zz15WR/vNXngA98ZRjrkoufeGPiokUDdOul40QE9b0yPPvF2BMpObrLdwIjGg03jsOvdjQBXwyT2FxDW+EFH7Le9kIHxav+h1AuPMDTEax2ep6CkpiJpQpPCRODIBT86B30B2mIJVzoEuvL0C46b1lbe3FT9jXyZQcyAnAXKn+dft4I1+/I4wegUExZWiBsb8yeCPQYClidDoCIB5apq2w5jTAJwzmfEnFPKGBXUkdTxqEMdGxbUZ7/vreLD0gywlGXyhVyhTCyrr30nUulyVS2VK/lSJZUtJNPZeCJVqNSyxTe5fgzxF7a/dn887+SeAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 11 31 15" title="" data-src="/static/2022-07-26-11-31-15-7ce4d7dcee191864c66ac821e0ea0ada-96dff.png" data-srcset="/static/2022-07-26-11-31-15-7ce4d7dcee191864c66ac821e0ea0ada-1a6e9.png 200w,\n/static/2022-07-26-11-31-15-7ce4d7dcee191864c66ac821e0ea0ada-b9533.png 400w,\n/static/2022-07-26-11-31-15-7ce4d7dcee191864c66ac821e0ea0ada-96dff.png 494w" data-sizes="(max-width: 494px) 100vw, 494px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/n7x8y0?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>图 6-4 所示的“第 1 段”内容之所以偏下，是因为第一个 <code class="language-text">&lt;p&gt;</code> 元素默认的 margin-top 无法参与分栏计算。</p>\n<p>想要在分栏布局中插入广告，可以使用 column-span: all 声明。</p>\n<h3 id="了解-column-fill-属性"><a href="#%E4%BA%86%E8%A7%A3-column-fill-%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>了解 column-fill 属性</h3>\n<p>column-fill 的作用是当内容分栏的时候平衡每一栏填充的内容。语法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22690250076693475000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`column-fill: auto;\ncolumn-fill: balance;\ncolumn-fill: balance-all;`, `22690250076693475000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">column-fill</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>\n<span class="token property">column-fill</span><span class="token punctuation">:</span> balance<span class="token punctuation">;</span>\n<span class="token property">column-fill</span><span class="token punctuation">:</span> balance-all<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>先讲一下这一语法中的几个关键点。</p>\n<ul>\n<li>auto 的作用是按顺序填充每一列，内容只占用它需要的空间。</li>\n<li>balance 是默认值，作用是尽可能在列之间平衡内容。在分隔断开的上下文中，只有最后一个片段是平衡的。例如，有多个 <code class="language-text">&lt;p&gt;</code> 元素，正好最后一个 <code class="language-text">&lt;p&gt;</code> 换行了，那这个 <code class="language-text">&lt;p&gt;</code> 元素的内容前后等分，保持平衡。这会造成最后一栏内容较少的问题。</li>\n<li>balance-all 的作用是尽可能在列之间平衡内容。在分隔断开的上下文中，所有片段都是平衡的。该属性值目前没有任何浏览器支持，可以忽略。</li>\n</ul>\n<p>我们测试一下各个属性值的渲染表现，假设代码如下（这里给容器设置了 80px 的高度）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51884223112911030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<style>\n   .container {\n      width: 300px;\n      height: 80px;\n      border: solid deepskyblue;\n      padding: 10px;\n      column-count: 2;\n   }\n</style>\n<div class=&quot;container&quot; style=&quot;column-fil: auto&quot;>内容略</div>\n<div class=&quot;container&quot; style=&quot;column-fill: balance&quot;>内容略</div>\n<div class=&quot;container&quot; style=&quot;column-fill: balance-all&quot;>内容略</div>`, `51884223112911030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n   <span class="token selector">.container</span> <span class="token punctuation">{</span>\n      <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>\n      <span class="token property">height</span><span class="token punctuation">:</span> 80px<span class="token punctuation">;</span>\n      <span class="token property">border</span><span class="token punctuation">:</span> solid deepskyblue<span class="token punctuation">;</span>\n      <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>\n      <span class="token property">column-count</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">column-fil</span><span class="token punctuation">:</span> auto</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>内容略<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">column-fill</span><span class="token punctuation">:</span> balance</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>内容略<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">column-fill</span><span class="token punctuation">:</span> balance-all</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>内容略<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后的渲染效果如图 6-5 所示，可以看到容器元素应用 column-fill: auto 声明的时候，里面的文字内容会优先填充第一列，而不是尽可能让两列内容平衡。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-11-39-05-3383e1c216b61c71a6c2f8e4ccc35232-d5813.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 443px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 76.2979683972912%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB70lEQVQoz31SS2/aQBDmZ1fqIZdWqUJ7a5NjVUVVL33k0IjmECUhKaElPGqCIQUDxtg8jM3u2sZe78MdEyVUkfCnkWd3Zkcz3/jLJQ8QQsD36OuXnefP9nZf5HdfLhYLiEjA+sGD3yD3/wWSc0QM09T6Q3MyiYRYIGRY1txxrenMxn5WMbS2l8tW/ab1p6Z1WthdeBjZ04ngsWTUp7HMKpaJz4SNiOsHQRxTKQMuQ5EGwZYRezL4pvieUrl0dfjh/dG3z58+Hp6fnT5yFqkTW8e+L64ryvHx98KPApjSbFLGsOcFYRTFccTl1s4AniQkjMzRUO9r9mwKEXtmKY2qPtAsQ3e9IIszl4kXc4wRJtjz/ZBGCOHpfEY5T0eIshaWpoam2Wx32t2e2u0qattGiCVJwPiKC7DtnNciOTkp5POv9vffHhy8e/N6T22rEA1ZTIVgIlMkkCUhteczQ9dd14EIXrqDQd8cGxNrjFeRzBaJg4mu/bVGQ1gbQe7SsUf9nkdQQBBehVmcuZCEsiBmKyZWTPrpmQNh6EjX+nn6qwRUbMT/OL/kACFjxsAxLuj6BHsBMMZSxQiRKxavFPXOcVyMiXKr3nW1ntavN5TeYDQyxqfnl5Vq4+Lyulpr/L6plX5VSuVKuVK9VTtnxZ//ALa/T0Z8DMlkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 11 39 05" title="" data-src="/static/2022-07-26-11-39-05-3383e1c216b61c71a6c2f8e4ccc35232-d5813.png" data-srcset="/static/2022-07-26-11-39-05-3383e1c216b61c71a6c2f8e4ccc35232-bf07a.png 200w,\n/static/2022-07-26-11-39-05-3383e1c216b61c71a6c2f8e4ccc35232-250cd.png 400w,\n/static/2022-07-26-11-39-05-3383e1c216b61c71a6c2f8e4ccc35232-d5813.png 443w" data-sizes="(max-width: 443px) 100vw, 443px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/uickhu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>经过仔细地对比测试可以发现以下几点。</p>\n<ol>\n<li>所有浏览器都能识别 column-fill: auto，但是，需要容器有固定的高度才能准确渲染。如果容器没有设置具体的高度值，则仅在 Firefox 浏览器中有比较符合预期的渲染。因此，在实际开发的时候，column-fill: auto 声明的使用一定要配合容器元素的 height 属性。</li>\n<li>所有浏览器都不能识别 column-fill: balance-all，我在 W3C 官方的规范文档 CSS Multi-column layout Module level1 中也没有找到任何的示例，因此，column-fill: balance-all 声明大家可以忽略。</li>\n</ol>\n<h2 id="分栏布局实现两端对齐布局"><a href="#%E5%88%86%E6%A0%8F%E5%B8%83%E5%B1%80%E5%AE%9E%E7%8E%B0%E4%B8%A4%E7%AB%AF%E5%AF%B9%E9%BD%90%E5%B8%83%E5%B1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分栏布局实现两端对齐布局</h2>\n<p>分栏布局非常适合实现单行的两端对齐布局效果，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6990089637183728000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<div class=&quot;container&quot;>\n   <div class=&quot;list&quot;></div>\n   <div class=&quot;list&quot;></div>\n   <div class=&quot;list&quot;></div>\n</div>\n<style>\n   .container {\n      width: 300px;\n      border: solid deepskyblue;\n      column-count: 3;\n      column-gap: 5%;\n   }\n\n   .list {\n      height: 100px;\n      background-color: deeppink;\n   }\n</style>`, `6990089637183728000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n   <span class="token selector">.container</span> <span class="token punctuation">{</span>\n      <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>\n      <span class="token property">border</span><span class="token punctuation">:</span> solid deepskyblue<span class="token punctuation">;</span>\n      <span class="token property">column-count</span><span class="token punctuation">:</span> 3<span class="token punctuation">;</span>\n      <span class="token property">column-gap</span><span class="token punctuation">:</span> 5%<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token selector">.list</span> <span class="token punctuation">{</span>\n      <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>\n      <span class="token property">background-color</span><span class="token punctuation">:</span> deeppink<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不需要改变元素的 display 属性，也不需要定位，只需要设置好 column-count 属性的值，然后使用 column-gap 属性设置想要的间隙就好了，这个时候，列表元素就会自动两端对齐，效果如图 6-6 所示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-d55d3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.935483870967744%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABzklEQVQY0zWP3UtTYRzHz12YSjKn5st2ulP/gaCC8mXpEjVCKdpdeNVNRF127dRtR3cO5FUUvlB7aWu2QC8khFC72BO4sXPwFKVB0NLltoMFnj3Pt+cRgs/N83l+v9+Xr/TmyXZ2LJXxvSN30+TOW3JvleRL5OF7Mp4ivrRgLEUebxDTEgOnZHzpndsrrx59kD4NxFDrp00hOINomIGsIvsTF5+hbgrOELg/68eVFzAP4QgKGoOU+3PTHy8tSZmbSTSH7AsalVXaPke752muQHsWaYtCZY1y36TQ68v0c5G6VIFbtWUNbbObfVGJjCR4JldwhdE6i86nyBVwdUFkulRw3xhE/xLMItrDgo4wP4HzylZvRMqMJvlcVdaYW2Vtc6xrnuUK7NoCa1aYW2PcOxXmWWZmkXWoApdadWs8ZrMvIpGBKGomKS/sCKB+WuTvnHau9YtMzplJXH6O3UM0BASOAOWyfmqbd155sGH2vsx64/kbcWMwrt9K6fmSPrGm90f14YQxnDQ8MeP+uv7FMoYSxtDrvDee88Z2PZHoxLpUAY6AMnBwYv/48/fXib1fsg7sapEy/vxWquxVrK9H5f3flb2y9d065l/l/yv/AMQzN5NJPlVNAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 05 14 05 01" title="" data-src="/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-fee1c.png" data-srcset="/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-a67b7.png 200w,\n/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-0b187.png 400w,\n/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-fee1c.png 800w,\n/static/2022-09-05-14-05-01-f32f79fe69366421070b6d1dbd2dcbd4-d55d3.png 806w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lg1096?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>// TODO CSS 新世界全新的布局方式待完成</p>',
excerpt:"之前，CSS 世界中除受限诸多的表格布局之外是没有专门的布局属性的，随着 Web 应用越来越复杂，显示设备越来越多样，原有的 CSS 特性已经无法满足现代 Web 开发需求了。于是，CSS 定义了很多全新的布局方式，这些新的布局 CSS…",frontmatter:{date:"2022-09-05 14:17:23",path:"/css-new-world-new-layout/",tags:"前端, CSS, CSS新世界, 读书笔记",title:"CSS新世界全新的布局方式",draft:null}}},pathContext:{mainPostPath:"/system-design-practice-learn/",nextPostPath:"/webgl-fundamental-2d/",prePostPath:"/css-new-world-new-layout/"}}}});