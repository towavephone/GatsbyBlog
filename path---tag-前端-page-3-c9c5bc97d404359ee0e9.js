webpackJsonp([0x7a92285cedda],{1535:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"WebGL 二维平移 平移就是普通意义的“移动”物体。这里有个例子基于前一个例子。首先我们来定义一些变量存储矩形的平移，宽，高和颜色。 然后定义一个方法重绘所有东西，我们可以在更新变换之后调用这个方法。 在下方的例子中，我添加了一对滑块，当它们值改变时会更新   和   并且调用 drawScene 方法。拖动滑块来平移矩形。 到目前为止还不错！但是想象一下如果对一个更复杂的图形做类似操作怎么办。 假设我们想绘制一个由六个三角形组成的 ‘F…",html:'<h1 id="webgl-二维平移"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E5%B9%B3%E7%A7%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维平移</h1>\n<p>平移就是普通意义的“移动”物体。这里有个例子基于前一个例子。首先我们来定义一些变量存储矩形的平移，宽，高和颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51480214086802430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var translation = [0, 0];\nvar width = 100;\nvar height = 30;\nvar color = [Math.random(), Math.random(), Math.random(), 1];`, `51480214086802430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> translation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> color <span class="token operator">=</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后定义一个方法重绘所有东西，我们可以在更新变换之后调用这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93186765752696200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间对应到像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 使用我们的程序\n  gl.useProgram(program);\n\n  // 启用属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 设置矩形参数\n  setRectangle(gl, translation[0], translation[1], width, height);\n\n  // 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)\n  var size = 2; // 每次迭代运行提取两个单位数据\n  var type = gl.FLOAT; // 每个单位的数据类型是 32 位浮点型\n  var normalize = false; // 不需要归一化数据\n  var stride = 0; // 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）\n  var offset = 0; // 从缓冲起始位置开始读取\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 设置分辨率\n  gl.uniform2f(resolutionLocation, gl.canvas.width, gl.canvas.height);\n\n  // 设置颜色\n  gl.uniform4fv(colorLocation, color);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 6;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `93186765752696200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间对应到像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用我们的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩形参数</span>\n  <span class="token function">setRectangle</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉属性怎么从 positionBuffer 中读取数据 (ARRAY_BUFFER)</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代运行提取两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 每个单位的数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要归一化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动单位数量 * 每个单位占用内存（sizeof(type)）</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始位置开始读取</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置分辨率</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2f</span><span class="token punctuation">(</span>resolutionLocation<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置颜色</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在下方的例子中，我添加了一对滑块，当它们值改变时会更新 <code class="language-text">translation[0]</code> 和 <code class="language-text">translation[1]</code> 并且调用 drawScene 方法。拖动滑块来平移矩形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/qj863d?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>到目前为止还不错！但是想象一下如果对一个更复杂的图形做类似操作怎么办。</p>\n<p>假设我们想绘制一个由六个三角形组成的 ‘F’ ，像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 207px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 133.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAADJ0lEQVQ4y52U+2/SUBTH93f6k7/5i1Fj1GXJEnUO9gDaruW5tpSWlnZjg8HYw6mLGuPYYOBgbEwZlJduxszFOWBAuR6Y8ckP1ptvmtubfs6559EzMLs+R2/x7qhXSMoP2VE8TPHbPjYquDe9l2I3untPXIIP+ITPvk5jC+Sw6z7uJQemNzgZhaVWMIjWrvE3jEksgFZFLehDCzMoMouW5tCKtx2gv4rmQ9vojsWQxkxvrR7kJ2L2ATDsQyFZC4nNwA35DpZ1AKx0wnBCf5KoAjMaNRs2LcYYZiu7uS+KooVntEU/ijiT7gFmg+85WWROpFvzg+acjT4TJ/anRhImYxrH8g62roidAFxBQYsyCkko6NUCCopYE9PfYQWFmVPfLeXeHXJwRDBgS6TzFcO9kfiUj0uK7LZAb3mYGM/Gha5iApsU2CeeLiz1PE+p0yPrEyW1hBBqXbRa9dbF+cXFeaNZb/ZRrdlutr/Ds2gRUoWnHZVKBeBOp4P+Yf2AI4YEhqfslbJOGErlbcyP7xDUAa2qKpy2223tlwWvqJ+5Lgz1dB0JExmSqYrlYlmP59c9+IMwmaGcJc/jF2vZ8tvU4W5P6f1KdlfNRLei9Vr9b6NdGGpIFWiqyBCHrqFnD6zvWSgvVWVAD6LjN4N3r/O31WI3HAjhD9gDsGHLwtf8RM5JHLjC6Ok8WmFPfGPbuDljg95g8uJlLrTO7zD92uNHy482TEJjDmAqzwj1OeM2ZtqlYDOPVqHnHTmuP3yZ7dFNs09bsGTtV4irN0ODj5Jm8j2NF52mnJWouu4/N+bz+T7X5mIiW5ONcRyuSuw5I8uRwkc1WzrI5Pcyhf29Sx3uNxqNPgnj4iJ9Jo3FurA9565WqjpKxcUl52dhcoeE/9b2jikUCt0m0doQ3k/Bo2+TwHCYPKCcHwQ/WrLl2FKxpMMzn5ANKQt7IkN72/XCMJyMKcx9qvRgtz7Y/mzauIvLnRDMA90wuWIfSxMQMIwY3fDUsm1s739hgzBuPWJhXMIMtb3TmbAhathTnwXPIEeBK6pFHTDBTk0+xq0vXeQLhyVMHh8d/zv8DejTYUu3o/ZjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 00 00 30" title="" data-src="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png" data-srcset="/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-7ebab.png 200w,\n/static/2022-05-10-00-00-30-6c0328e883b37bc75b411e2a95c74a1f-63541.png 207w" data-sizes="(max-width: 207px) 100vw, 207px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接着当前的代码我们需要修改 setRectangle，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23276148189085940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl, x, y) {\n  var width = 100;\n  var height = 150;\n  var thickness = 30;\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      x,\n      y,\n      x + thickness,\n      y,\n      x,\n      y + height,\n      x,\n      y + height,\n      x + thickness,\n      y,\n      x + thickness,\n      y + height,\n\n      // 上横\n      x + thickness,\n      y,\n      x + width,\n      y,\n      x + thickness,\n      y + thickness,\n      x + thickness,\n      y + thickness,\n      x + width,\n      y,\n      x + width,\n      y + thickness,\n\n      // 中横\n      x + thickness,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + thickness,\n      y + thickness * 3,\n      x + thickness,\n      y + thickness * 3,\n      x + (width * 2) / 3,\n      y + thickness * 2,\n      x + (width * 2) / 3,\n      y + thickness * 3\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `23276148189085940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> height <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> thickness <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      x<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> height<span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y<span class="token punctuation">,</span>\n      x <span class="token operator">+</span> width<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> thickness<span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      x <span class="token operator">+</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span>\n      y <span class="token operator">+</span> thickness <span class="token operator">*</span> <span class="token number">3</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能发现这样做可能并不好，如果我们想绘制一个含有成百上千个线条的几何图形，将会有很复杂的代码。最重要的是，每次绘制 JavaScript 都要更新所有点。</p>\n<p>这里有个简单的方式，上传几何体然后在着色器中进行平移，以下是新的着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4264060075314879500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n\n   void main() {\n      // 加上平移量\n      vec2 position = a_position + u_translation;\n\n      // 从像素坐标转换到 0.0 到 1.0\n      vec2 zeroToOne = position / u_resolution;\n      // ...\n   }\n</script>`, `4264060075314879500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 加上平移量</span>\n      vec2 position <span class="token operator">=</span> a_position <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n\n      <span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n      vec2 zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重构一下代码，首先我们只需要设置一次几何体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48970011728260055000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在缓冲存储构成 \'F\' 的值\nfunction setGeometry(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      0,\n      0,\n      30,\n      0,\n      0,\n      150,\n      0,\n      150,\n      30,\n      0,\n      30,\n      150,\n\n      // 上横\n      30,\n      0,\n      100,\n      0,\n      30,\n      30,\n      30,\n      30,\n      100,\n      0,\n      100,\n      30,\n\n      // 中横\n      30,\n      60,\n      67,\n      60,\n      30,\n      90,\n      30,\n      90,\n      67,\n      60,\n      67,\n      90\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `48970011728260055000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在缓冲存储构成 \'F\' 的值</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 中横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">90</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们只需要在绘制前更新 <code class="language-text">u_translation</code> 为期望的平移量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61256720572078916000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar translationLocation = gl.getUniformLocation(program, \'u_translation\');\n// ...\n\n// 创建一个存放位置信息的缓冲\nvar positionBuffer = gl.createBuffer();\n// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)\ngl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n// 将几何数据存到缓冲\nsetGeometry(gl);\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 绘制矩形\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `61256720572078916000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> translationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_translation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 创建一个存放位置信息的缓冲</span>\n<span class="token keyword">var</span> positionBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定到 ARRAY_BUFFER (简单的理解为 ARRAY_BUFFER = positionBuffer)</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将几何数据存到缓冲</span>\n<span class="token function">setGeometry</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 setGeometry 只调用了一次，它不在 drawScene 内部了。</p>\n<p>这里是那个例子，同样的，拖动滑块来更新平移量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/p59ez6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在当我们绘制时，WebGL 几乎做了所有事情，我们做的仅仅是设置平移然后让它绘制，即使我们的几何体有成千上万个点，主要的代码还是保持不变。</p>\n<p>你可以对比上方例子中使用 JavaScript 更新所有点的情况。</p>\n<h1 id="webgl-二维旋转"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E6%97%8B%E8%BD%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维旋转</h1>\n<p>首先我想向你介绍一个叫做 <code class="language-text">单位圆</code> 的东西，一个圆有一个半径，圆的半径是圆心到圆边缘的距离，单位圆是半径为 1.0 的圆。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 312px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.35897435897438%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACDklEQVQ4y21UiY7TMBDt/0v8Ax8BHwFCWrQI2GWlQtkecXzEbprLHts8xwltmh0pI2s8b643zqYoCqUU51xOIoSU17NIdrG0ZufT6bTBfYyRiOJKQghEfm33Phm11huEgVPf9845Inxd0zmuXCGdqOjEWiYdU+58SbfJwblhGKCRfIMPYax10Ea3799tfz3ViBx8ymytDSE6ivoShA65vlxmypzBiARdCv/xw0+p61TzVDblM2RwsdQpkPdLMOpR59B10URzDFW49kxzoBFvo9A3mcUI7ge/O5wPr3+/Pj7+qH6b2N2C5/klbZpo6v9gkcBCu6bzKOio2ctw3EXRRYuMaxYwaaaWZRfChTGysvWW2NazVxKWnH+LKqkJ8zVGTzxzCUaT347vPz8/fN89f/r25Y/Yh6V4n9pXxrU9wFXiGZgj69o29YmF41J0Q9e0TdO3xpiR/0lwjIFENWjTa63msqXL81ht2KLn7CINYey57ATmlevtBAhzmDU4z7yQS6ourZPnKx9vgvNV3UZdr5ZEmIAx3OJvwdmIlnlastV6YthlhW25pTSkCc2CY6kDSLpfz7zbIEIavIGY2R25oWxHtchp7x5GpgpPMpMB77qhUhGvCHwKNWCWWCn0mW8heJLQ+IVMS5IzL9YwpBbOtR3s/cCvmQ+HAypnjImljD8ejt+QUvLuqixL6P1+/w9984fRhyLjxQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 10 43 30" title="" data-src="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png" data-srcset="/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-08db0.png 200w,\n/static/2022-05-10-10-43-30-99efae3911f838c0f78856fe9588c5f8-8130d.png 312w" data-sizes="(max-width: 312px) 100vw, 312px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当你拖拽蓝色圆点的时候 X 和 Y 会改变，它们是那一点在圆上的坐标，在最上方时 Y 是 1 并且 X 是 0，在最右边的时候 X 是 1 并且 Y 是 0。</p>\n<p>如果你还记得三年级的数学知识，数字和 1 相乘结果不变。例如 <code class="language-text">123 * 1 = 123</code>，那么，单位圆半径为 1.0 的圆也是 1 的一种形式，它是旋转的 1。所以你可以把一些东西和单位圆相乘，除了发生一些魔法和旋转之外，某种程度上和乘以 1 相似。</p>\n<p>我们将从单位元上任取一点，并将该点的 X 和 Y 与之前例子中的几何体相乘，以下是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16853070563837846000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n\n   void main() {\n      // 旋转位置\n      vec2 rotatedPosition = vec2(\n         a_position.x * u_rotation.y + a_position.y * u_rotation.x,\n         a_position.y * u_rotation.y - a_position.x * u_rotation.x\n      );\n\n      // 加上平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `16853070563837846000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 旋转位置</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 加上平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更新 JavaScript，传递两个值进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43825803677753170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar rotationLocation = gl.getUniformLocation(program, \'u_rotation\');\n\n// ...\n\nvar rotation = [0, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `43825803677753170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotationLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rotation\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> rotation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，拖动圆形手柄来旋转或拖动滑块来平移。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/6g8g2i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-geometry-rotation](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-geometry-rotation?view=preview) -->\n<p>为什么会这样？来看看数学公式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27969551167056196000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedX = a_position.x * u_rotation.y + a_position.y * u_rotation.x;\nrotatedY = a_position.y * u_rotation.y - a_position.x * u_rotation.x;`, `27969551167056196000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedX <span class="token operator">=</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span>\nrotatedY <span class="token operator">=</span> a_position<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> a_position<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>假如你想旋转一个矩形，在开始旋转之前矩形右上角坐标是 3.0, 9.0，让我们在单位圆上以十二点方向为起点顺时针旋转 30 度后取一个点。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACL0lEQVQ4y4VU2W7bMBDUf+eh/an2oXlLgRhVEhhIi6IwkEOyDlu2DouHJB5ih6QP2W7QBSEtqZldcneowBgzjqNSylwZ1rVWztmP47rHB94bhuGABsQOIUbGNKViGEb3RWgtj0yPD7zXdZ10ppRsGpkkMk1VnuuXFwI/jvu7u/XDQ9H33REPJ/DBQIOjtdlu7UBct0kkJ3gxJj9/mt/cPBPCMFVKe3zgOJgInGK9NpyfzgyQENL74e9fs/BPXfm4EzImQoiiMF3n63EqDHZYV/W2Kpd1lK9iSnvAzjIjd1mKqjpj+h0haBRF4Tyc/5z/CEOcb7czZanhnMhxLKS8bJW2ndKDGVCHRCQtbX30NNXDcCBzPqKkF2ldndhmvYmreLFZvJfvvN/XA2TO92TNmMoyDS4O481rIMuy+6f7x+fHWTi7/X5LOHHRdVXJohDAB6g0pTKKOs4J2iwnhgNnZVbs1jWrv3z72jSNi4xji8WigWzstlFkkJXqL+VpRkqpkmoiWPvcbseioDYzJkLo5VJca9v1X/oo1uzTri+XGoL02rawNBWMfUieGkQC2ULFJ5FwLlar/5B9WoiEUu0vyV6eSglC0P0z3Gnbh/sIIUEkTpETMgoLp23NZmOOyQDy24NhERemac6CBv5KQcNYcj3X6DkG9ta2qmlQizHPVZJoQrQjao8HMZjcTzRW4hMcdD7PZZbJ11fy9kZsv6T9GQDgmf+4z9e/ISE4wB8V8i8ir4ttPxU+QgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 21 43" title="" data-src="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png" data-srcset="/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-291bf.png 200w,\n/static/2022-05-10-11-21-43-3372c34a8170ba2ff4ef4225e5934ccb-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.50 和 0.87</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55412098373164190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3`, `55412098373164190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.87 + 9.0 * 0.50 = 7.1\n9.0 * 0.87 - 3.0 * 0.50 = 6.3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个结果正好是我们需要的结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.03125%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQY0zWQW0sDMRCF9///CcEHxeKLIIgitA/1SX2oWErtfZfmnk3i5rIbt0mnLZ6nOZmZw3wpDoeDc45z3rZtzrnruhhjFwNjLLQngXXOa6W99xcLgq2UcuFsGD+ul/NSGxXjX13XUsjVbL/ZbCGLYKJqJSTHGEkpIVEprZTq+x66hW388G6LS3VZbpz+meDRYAejEM8Fa7zmVFEivHeMcWMMtLTWzrvC6Ob1drFbEsZJCIES/ny9mE+QMhJsVaKvN/R0tfj+XLtgEUK1kpQRSinAFtba7QoLLgEbYCkW0/e9EALi+xSnH9X4oSrXzAfX/Nrh/Wo0KF9uZhTz09kJlIE+wZHgU07n+vycM7CBS/8yvNU0CuRCOP3uEQduTf4BYRapAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 22 51" title="" data-src="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png" data-srcset="/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-7728b.png 200w,\n/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-23f96.png 400w,\n/static/2022-05-10-11-22-51-065903dc9c53452e979e081d71a0a209-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>顺时针 60 度也一样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 201px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQ4y4VT226bQBDly/vQ53xOFUvtQ/tiRcqtidWHtIprJYDB2BBgL8Bee5a1gdROMhrh9cw5u7MzZwNrrTFGKWWPDHGtT8c9PvCrrusOaINfuBCGMU2p8Bk4Ut4GfOBXTdPI3pSSZSmjSMaxShK9XJIoFmEoi8KlvHk8iIE/ECEsUMtu5xz7GuMynBOttRC2KOxmY/3llNIe78hISymQQJrz8W4ACSH73d1f7JhlFgfD93fucwAJJJrGDtDDpvLQJPflTMzO88vLDIXvyYDluUBhU+ZJctu1nz5fn539bls2ksNQHGCnyShtuVre3f/89mN+PvvOGd2TOTdo73/H+kaisdVLVRRFuA3v/yz+FqsNjx8enhlrPVkzptZrDTA6NDV0hTBy++t2fjO/uLm4Wlw963CR3UVRnefA6wClUSqfnhpMBWOWUxMyTuOszuquLmhRNmX6ks6+fsky8vhYad25stFkkKVsj2XIKFNSTSLuu9uZLMOdTdA3wzXsWMNDw4xjOdeObcJQQ5Be2w4Wx4Kx97o9GKQC2UKqo0g4F2n6AdnXDC1R6jKjPJUShNg8f4Ubyzb7CIRUVV6REzI0gEVd2+3WDocB5MuDIYgHU5avNg38k4IYEOpnrjFzOGqra1WW6IVJEhVFmhDdE7XHgzi+ZxyCYpDCApNPErley9WKwCnF/AVSALz5no/nLAQH+K1G/gNkNoySs7PGXgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 10 11 23 18" title="" data-src="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png" data-srcset="/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-291bf.png 200w,\n/static/2022-05-10-11-23-18-4b53982464e678c12d9b946828a2d263-29b1b.png 201w" data-sizes="(max-width: 201px) 100vw, 201px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>圆上该点的位置是 0.87 和 0.50。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15456096874601722000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9`, `15456096874601722000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.0 * 0.50 + 9.0 * 0.87 = 9.3\n9.0 * 0.50 - 3.0 * 0.87 = 1.9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>你会发现在我们顺时针旋转到右边的过程中，X 变大 Y 变小。如果我们继续旋转超过 90 度后，X 变小 Y 变大，这种形式形成了旋转。</p>\n<p>单位圆上的点还有一个名字，叫做正弦和余弦。所以对于任意给定角，我们只需要求出正弦和余弦，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18138332430005266000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function printSineAndCosineForAnAngle(angleInDegrees) {\n  var angleInRadians = (angleInDegrees * Math.PI) / 180;\n  var s = Math.sin(angleInRadians);\n  var c = Math.cos(angleInRadians);\n  console.log(\'s = \' + s + \' c = \' + c);\n}`, `18138332430005266000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">printSineAndCosineForAnAngle</span><span class="token punctuation">(</span><span class="token parameter">angleInDegrees</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'s = \'</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">\' c = \'</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果把代码复制到 JavaScript 控制台，然后输入 <code class="language-text">printSineAndCosignForAngle(30)</code>，会打印出 <code class="language-text">s = 0.49 c = 0.87</code>(注意：我对结果四舍五入了)。</p>\n<p>如果你把这些组合起来，就可以对几何体旋转任意角度，使用时只需要设置旋转的角度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80960574404513800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nvar angleInRadians = (angleInDegrees * Math.PI) / 180;\nrotation[0] = Math.sin(angleInRadians);\nrotation[1] = Math.cos(angleInRadians);`, `80960574404513800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">var</span> angleInRadians <span class="token operator">=</span> <span class="token punctuation">(</span>angleInDegrees <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nrotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里有一个设置角度的版本，拖动滑块来旋转或平移。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4i0mhx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这并不是旋转常用的方式，请继续阅读</p>\n<h1 id="webgl-二维缩放"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%BC%A9%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维缩放</h1>\n<p>缩放和平移一样简单，让我们将位置乘以期望的缩放值，这是前例中的变化部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14171642090827485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n   }\n</script>`, `14171642090827485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   uniform vec2 u_scale<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// 缩放</span></span><span class="gatsby-highlight-code-line">      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span></span>\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n<span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后需要在 JavaScript 中绘制的地方设置缩放量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41874398548531855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nvar scaleLocation = gl.getUniformLocation(program, \'u_scale\');\n\n// ...\n\nvar scale = [1, 1];\n\n// ...\n\n// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 设置平移\n  gl.uniform2fv(translationLocation, translation);\n\n  // 设置旋转\n  gl.uniform2fv(rotationLocation, rotation);\n\n  // 设置缩放\n  gl.uniform2fv(scaleLocation, scale);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 18; // 6 个三角形组成 \'F\', 每个三角形 3 个点\n  gl.drawArrays(primitiveType, offset, count);\n}`, `41874398548531855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,21-22}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,21-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scaleLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_scale\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> scale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 设置平移</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>translationLocation<span class="token punctuation">,</span> translation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置旋转</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rotationLocation<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 设置缩放</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>scaleLocation<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span> <span class="token comment">// 6 个三角形组成 \'F\', 每个三角形 3 个点</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们有了缩放，拖动滑块试试。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/byhsth?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>值得一提的是，缩放值为负数的时候会翻转几何体。</p>\n<p>接下来我们将复习神奇的矩阵，这三种操作将包含在一个矩阵中，并表现为一种常用形式。</p>\n<h1 id="webgl-二维矩阵"><a href="#webgl-%E4%BA%8C%E7%BB%B4%E7%9F%A9%E9%98%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 二维矩阵</h1>\n<p>之前的三篇文章讲了如何对二维物体进行平移，旋转和缩放。每种变换都改变了着色器并且这些变换还受先后顺序影响。在前例中我们先缩放，再旋转，最后平移，如果执行顺序不同结果也不同。</p>\n<p>例如这是缩放 (2, 1)，旋转 30 度，然后平移 (100, 0) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.65289256198348%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz5WSXY/BQBSG+6/9BnclQYK4oiS4Ia4FiUtZWxHio2T6oS0b/aI6nZk91YZI7G72XEyamT7vec87w7F7EUKCIGD/LO4B3263t39QSv+GPc+7Xq8g4fv+5XLBGEcko7/wT/hwOEiSpKqqpmmwWpYF+wEObNu+a9BY6A0M2uq98L2gPw6jzqIsVo9V0RJ9z38YeQ8riuI4juu6sU/HchpKQ2BCqp8qLUsIIxayWCJWecLgdrvd7nY7XdejM8LGaFzxKtlldjQfDbVhDuW6Zvd0OSVTUPqEEUKGYTziMb6MolTMq/nMKrM/72Hn6BzbShsk+lof3L10Btg0zWQawlrTFo/4ulOvfdQKqNDTepZnQUfJlgRdKMvlwXrAhWEICcELARgMx09ltpqlP9MwbWfdYT6TbbmpN/klv9E2cBricOJOuvNuAkO8cM/wDTCsENvUndaUmqzLsS9K6OK0OLvnJHMSueN+fJ6Uea5HKEng10uKA/sGF+OjNIu10dUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 35 02" title="" data-src="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png" data-srcset="/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-4bd12.png 200w,\n/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-7acd9.png 400w,\n/static/2022-05-14-23-35-02-e33d2d385c378d21e05033488e5a7081-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是平移 (100, 0) ，旋转 30 度，然后缩放 (2, 1) 的结果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-7376a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.19875776397515%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABHUlEQVQoz51RvavCMBDv/w9uWUQEQXHqIrg5uLhIh4IUoV1eW1/VlzQ1/eA1bdPkXY1IKV18BzmOJL+PuzOUUk3TSCnV52HAqev6/+A0TaMoIoRgjKEe/SeVHAfHcQxgMF+WJbgYwnqmgKLP0oEppUEQgDLnfCDXyhbyNbuGRcgr/gYCIzy9wGEYMsb6sqAgpFCt8qi3YIuJM5l78126cx4O+2Vw/1LGzxhYlc82bWIjjNb+OqMZzvHh52DezOVtaV7Mo3c0hBAaDLJVVekMnmQj9997dEczd7b6Wm3J1rk7YAaoWcXc3E2KxAANvSodXZNK5UW+8TeIICuxBBeEEyu1zvQ8GHlnG8TfI9XFyT9NL1P7Yat2ZElSt6XUHzOmO1uhS63KAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 14 23 44 24" title="" data-src="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-fee1c.png" data-srcset="/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-a67b7.png 200w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-0b187.png 400w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-fee1c.png 800w,\n/static/2022-05-14-23-44-24-5c7e5eb2c4df7b4edbd16f508d6c9a3f-7376a.png 805w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>结果截然不同，更糟的是，针对第二种情况中的转换顺序，需要写一个新的着色器。</p>\n<p>有些比我聪明的人可能已经想到了矩阵，对于二维我们使用 3x3 的矩阵，3x3 的矩阵就像是有 9 个格子的格网。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.66666666666669%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEEklEQVQ4y3VU6VP6SBDN//9xPUsFSm5E5IgQTkFEIJwSwg0JAQSEcAZZOd0XqZ/lWrv9YWhmXk+n+/Ubot1uO53Ox8fHYDAYCoW8Xi/8cDgcCASCX4ZNt9sdi8X8fj/8b1gqlSISiQR+3t/fx+PxZDIRRfHi4gJn2IEvjkbL5RKRx8fHnU5nNpuNZdx4MBjYbDbi5eWF47jPz8/9fn9YDQZDPB6Hv/syOJVKRaVS4bpv2Ha79fl8RC6XKxTYoShiS+C5TrdvNJqeI+HX7mt/OPpYLgShlUpn1Wp1tVLihRZgTZ5rd3qogmBZlo7HTDbbROyZbkx3Fse1WvccDrpd5FMslaKjFrNFpdbe3JiL+ZzTRTVq9Tuz8dZqJ10eOTPD5EqlYqvTrtcqTaFtMJoi4VA6mWSLZaHJN5vNGJ1Uq69zqWTwIVCu8Y1alWu2fD4/kc1mf9Ws0+mi0ejPmkul0tXV1XQy2cmQz0PNoIBgGAbQ19dXZBAEARfp9XrwhN5yPMfzfLfbjUQiGo2mXq/3et0DrNFoeDweAh5ouLy8BENYj46OXC6X1Wo9OTk5bB7s6enp/Pz84B9gmAUi9WWSJA2Hw9FoBAIVCgVomM/ngy/DEXhGZKvVmk6noghmxH6/73A4ZJ7xbb94BvoXz0ql8hfPGCS5YTzXkKTFbreX5rNu7w3BdDwqCM3RZL7drJCHYQsatbpcyPNNmefhW18cjWWeX3JMPh3X3Jh7b0M/Rd5aLH+dKVLRUDAU5IROJknbbA6twWg23+iur5yUt9XkSNJusZL2exd4ZuinB6PlLsMUquVSOvOi1RsCHk+ByVJef61aY/NsOBLVajWFfJZh8tVqjcll82zJ4/UdPptDHZvt7pvn50hkuVis15v9Xt4sl8vgebFY/KxZpgrBmUzm/X2JVo/HI/QcYxx6fFyv19gZDkVpsYDyQEG73ZlMpjJsNHobvFEURYCAs7MzpRKnCrT09PQUo2O328GN4odhTkDvwQcMIdghkBbql+eJ4zA9GCOc4VbkqTdkw/A9PDwgslgsQmG8bM1qtSrzLNf8b54xnr9m+39rhqoy6QS08/fHCsfT2cxoMoVDflxa4wVgZ5LEFgoqpQqzNZfk+DkkMpnKjwGEkYiFvH5/fzD0eii7nVRp9H7KcXp6EozQXL3ivCc1OjwQRsetkXT5oBM3tH5POe4pDEmuVMgPxTHX4OLxyHOU1hmMPo87m06nUxlQmqBpp8ujNxjSdNRqd4DheDQSo1OUx0vgKSiXip9/7D/fMNSMNwyq+Fitv/Usz3Yymczn2d12Cxmh5vlsBjLQ3s1mM/syOJAdKITCVquVJMmwyXRKkiTR6/UgYKDxAGAFyUiLbqMfgT+GJOgf1sPfAwyd/gd1K8thdGBdNgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 05 52" title="" data-src="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png" data-srcset="/static/2022-05-15-16-05-52-35db6e7565a19efd3d9ade8e153af197-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在计算的时候我们将位置坐标沿着矩阵列的方向依次相乘再将结果加起来。我们的位置信息只有两个值，x 和 y。但是要进行运算需要三个值，所以我们将第三个值赋值为 1。</p>\n<p>在这个例子中结果将是</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 785px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.019108280254777%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAoElEQVQI102O3Q6DIAyFff8HnO4CNxMnw0KUBApIkXWa/ZwL0nycc9pGKWWMSSlJKYdhIKJa67qszHPOGkAIgQEZbltST+U8eucY8leDGGKMROUxjqLv931nH3eFEHgEmLvuygaGpRAi5kze+0vbaq2beogoy2nqb/dSSv2Ii7R+bz7DZy+/7txszDdM1vKxS/0T+6y1M8CR+sGYEgBw4wtjYuUq2fO33AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 07 18" title="" data-src="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png" data-srcset="/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-8ea14.png 200w,\n/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-2d7f3.png 400w,\n/static/2022-05-15-16-07-18-1ef631cfc1ebd4fdb9d9aca6ad923145-b1b7b.png 785w" data-sizes="(max-width: 785px) 100vw, 785px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想“这样做有什么意义？”，好吧，假设我们要进行平移，平移的量为 tx 和 ty，然后定义一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 154px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 120.12987012987013%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADwklEQVQ4y21Ua1fiSBDl/3/bL3Nm9MwcRVYmgAJJeCMkgfASCAICgRACqCE8RR7Ke2+IO8vZY33o011dXX2r7u02rVarYrH48K/l8/lardZoNARBMDyFQqFUKsmy/MeD+Gw2+/b2Zmq1Wn6/X1VVbGPe6XTMZrPT6Xx6epKP9vLyQpLkxcUFdhVFwYjgYDCIjCZsI/fhcNjtdvv9HhO32x2JRAwPDJN0Ok0QxOFohgfoqtWqCdflc9nJ+BUHtZ46nrySFBW5Cw8H/cl0tl1/9Hoay8UcDvuwr2mD4eGwHw4Gqcw9zpuaTblcEqIh7rnb9nioYCDspLxWi5mmSZ5PFoU8RZHnl1fEbytFukKhO7FaDfi833/+rEtNwG4VhNxjqSw1JSRrd7okRQf8XrnZbDQkpSVj9AfDuFmWGmK90W4r2LqLsqIo4uYmOnxaM7oVDodPa04mk9fX16c1VyqVx8dHE7qKbtdFEd0rl0tw2Ww2mqbRj9LRAIeiabvdfgwoY6zX616vV78ZdFkslr+PhvSgxOVyeTyey8tLLOG8urqyWq3A8seD5dnZGW7VYQMVkCzm88VysV6vwQqwoIjFAr45amEYBine39+XyyWcCM7lckDxBc+QRDQa/R/PqOULntvtdoxlUMb0bT7U1EpVJOyOeIx76nRns4X63JUkOc4n7DaiKdUlWdmsV02p8dltaM188YumyHQqw0WjTrfzr28/CkKWZ2JC7iESCdCU1+0NXlvMJOn0+wJCXvB5PN/Oz5HJBL3ep1Oj0bjf7w/6Wq8/cDpdHMsONK2ltPt9bTQeJ1MpdBuaU3vacDgYjUZQmAiFSZKE6k9rvrm5CYVCpzUnEgkwclozGNUbhgtvb29jsRhayrAMnoTd4QBVzKdFOY5DgPFaWEQwTJyPEzYbaDKNx2NwQ1EUtjFCXgiFSMA2POTR0Gqfz4ctI8xQATqtw8bLPoXtcDjwXE9h8zwPnr+ADZ7xOWANDRjbyG3wDEUgISapVMrgGdmNwyAZ8tZvromi0qj5KLJQLCEWgDkutphPCcKczwuzxRIiQS1dpdVWXoZ9NZO55+IJSAPylJCm99yJhcOE7fdsucYDZlnu42PJRAJBv3++2mXSKZfbVX8sR0KckE+DbdLjx8H/5Dl5nUynk+1uj8PGN6SpKqg2YIPnj/clOIfe1+tNpaoD12EDFSK22+1uq9djPAxMNhtocY0J2MKvaHRkvdE9D4UH/QMEVXic8Xhcp5ll0Sqc1Cn9NAYSAE/wRD+dDM/H0dRut/sP93urCpWSFFcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 00" title="" data-src="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png" data-srcset="/static/2022-05-15-16-13-00-306008f92c69d4e990069c0d5c097a19-64589.png 154w" data-sizes="(max-width: 154px) 100vw, 154px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后计算结果</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.51597051597052%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmUlEQVQI1z2NyxKEIAwE+f9PBBVPguUWYPHYoCCOS605hWY6w5RSxtizlGVRUkosrTVjzLZ9cs5YOOcpRUAi0npNKYUQBBewGNBxHNd14co4jqVW5EBg1lqttcMgIADiSfTAGKMQHF8MFCYcva5P83m2/5RS3L7P84x0j/UTaJbT5KxjPYeqGJP3/g39YKYvdfgOroM7t0O5AZDA5b65ASLvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 13 41" title="" data-src="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png" data-srcset="/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-a67b7.png 200w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-0b187.png 400w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-fee1c.png 800w,\n/static/2022-05-15-16-13-41-3acd2b74e677131b9b8113928bc56049-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果你还记得线性代数的知识，我们可以删除和 0 相乘的部分，和 1 相乘相当于没变，所以简化后为</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-8f041.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.317073170731707%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAA00lEQVQI10VPrQqEYBD0GSwGgyIIgsEiCCaT2WywGDxsguBD3AUfwmqyCR4+hhdETCaDfP6CfncDhtsw7MzOsLvMMAz7vjfNR1XVOI6/KErHcdy2LU1T0zQFQYiiCPI0Teu6vqvKtm1ZlsMwZAghGOR5znGcZVlt24LOZAYWRaEoiiiKmIIiCSzLUtd1lmVd12Wu64KEnZIkwZdlGehxHMC+7zVNcxwHPWzneaKp69owDIR93/+HkyTBqXfs9j2fr0cQLMtyeyilQPzoeR7P813X/QBcGqSEWIL+4QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 15 20" title="" data-src="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-fee1c.png" data-srcset="/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-a67b7.png 200w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-0b187.png 400w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-fee1c.png 800w,\n/static/2022-05-15-16-15-20-58f2d671655517d590e3dd6aa020a76f-8f041.png 820w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>或者更简洁</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68700035316284326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x + tx;\nnewY = y + ty;`, `68700035316284326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x + tx;\nnewY = y + ty;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其他的就不用关心了。这个看起来和平移例子中的代码有些相似。</p>\n<p>同样的来实现旋转，在旋转章节提到过，旋转只需要和旋转角对应的正弦和余弦值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50523773368363510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);`, `50523773368363510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">s = Math.sin(angleToRotateInRadians);\nc = Math.cos(angleToRotateInRadians);</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后我们创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 146px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.71232876712328%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADyUlEQVQ4y5VUaW/iSBD1//8SRVGUU1zhyDHhMGBjjDEwhGswCQ4QokwgRMByn+YwGLLP9g7K8mGlrQ+lcruqq+u9101kMhmGYcLhMMdx8IhFUeR5PhQKcZqxLBuLxZ6enr6nBQKBQqFA3N3d9fv94XAIP5lMarXa+fl5KpWazWZY6fV6CCKRiMFgaDabo9FoMBjA1+t1mqYJiqK22+3X15fuUX91dfXy8oJ4oxmCXC7ncDiWy+UubT6fY0fC5/Opn9tNr9PRi81mc6lUQqwo6/FohEAQstfX1512C2fB52g4aDSa0WiU8HpJfL+/ik6vf7FSJGlqMpnK5df1aimKOZPJPBhJ4vOzxXjhdN6RpP/j44Px++03Nx4/g2Ivivud5nOpvOusH7vbbSVTiflSBlp2m1XMPxUKxUq1WiwUs0KOC0f2Z55Op/9jZqDdarU6nQ48Rnp/f7+8vEwkEoC0pRmIADdGo7FW++ziMK0WfLVaVdEGYIeHh6enpycnJ/BHR0dgFanHx8cnmmHFZrOB+e9pBwcHSCPcbnej0cB+oBH9397erFZrMpkEw03NEABYHBtQtdttrMBXKhWoRafqXzzvqNrNLAiC3W7fmxlnUdFer9cbRZG1f5gQxZAeYnmJnDmCX5kMOoPe+WKB4uVi0e31VcB0qsa95o97l7z5kqZq56LWOcoHU4KIAMRYzQbKTwYCIaAVDbH3LrePZv8Ud9sUTc9kZSZNd8XxeLRa/0srFmxX5p+xaCKRLBZLyUSC4/lAkPsvbUOeq9Va5xnyxAg6BJvNFnJQ5el0OmVZXq3XsrzEP2B7cXEBSSEJCMkrGQFoNxoN2FeFRpYVZQMV4IYSHo8HdxB6BrfwiHGTLRYL7qBRM2gGUCP17OxMT8NcYFtFmyTJbDaLVjhbPp9HE5wF9XgScpphEZUulyudTiN+fHzU0/6ham9m7L3HM3YHEHs8Q7OqSICLssE4KjaD4chiMZeKRcQAAqbynM1CoXhSttvNWsHIGwCmdnbd38aifDojTKeTh1iM5SN2x00w4I3wkc9687NagRicpM9DkmVRfC3/lqQRx4XSmVw8Hidu7RY0Z4NcLvfI0PQPt9vmuL2/tdIUk0ym4j/jTIA22q79lL8gCOFQ5LmQ93p9TJCPPzwQNE3NpMlsvsBIi8W83e3jYpSKBXxCjIv5HHz9ygrgeTjo9wcD5E0laTyeqDzjVn0HbDwegxtd2zvA8DyDnu+AYX4wQoADivLjcQYfLBvCbB63B4ssG2Q0CwaDIA89wMufNBbqwJX8G7IX2tvsWOWCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 35 29" title="" data-src="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png" data-srcset="/static/2022-05-15-16-35-29-eb5167ed28ae5d7d8a97de358390ab6e-e3522.png 146w" data-sizes="(max-width: 146px) 100vw, 146px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.224719101123593%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAmElEQVQI102O0Q6DIAxF/f9fNIEY42DiKJgIrSLsRh62+9SecloGY4z3dF2Xc9s8zyhaa0SElnMm8lprEQHkzNbanHM6jnEcrX0PaDCrtTrnpmkqpeCdPEENWSl1nifgXQozA0KBvK7r0J4A4b4xr34ZuzokCsuydLkHo5SS1uonw9ljCCG2v8DBH7ft03f13PUW4Rh3ZvkCzsvmBlRUjnAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 36 02" title="" data-src="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png" data-srcset="/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-a67b7.png 200w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-0b187.png 400w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-fee1c.png 800w,\n/static/2022-05-15-16-36-02-e67478d152dd8f8de9256294f3446eac-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45516578921703690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x *  c + y * s;\nnewY = x * -s + y * c;`, `45516578921703690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x *  c + y * s;\nnewY = x * -s + y * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>正是我们在旋转例子中得到的结果。</p>\n<p>最后是缩放，我们将两个缩放因子叫做 sx 和 sy 。</p>\n<p>然后创建一个这样的矩阵</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 153px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 123.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAADwUlEQVQ4y3VUZ3fiSBDk/3+3jU2wb5fgNUYgRBTJIh9BhF0Q2UQTTJRAAmPwFeKdn5+P6w96rZqe6a6p7lHsdrvnL9ZoNMbj8XA4hHNCms1mt9udzWafyClsuVwqsKbX64vFYiqVSqfTuVzOaDRqNJpMJpOWDYiHpi8uLoLBIHwgWZZlGMbpdCpwTDab/fj42MsGh6ZpiqLgHA6HE4IYrVbL8/wJxHe9XgcCgWNm5MS/JIkrUYLj8XgoyrYSluu1uN+/CwJfr9WxeTR44XkBAasVPxqNnoJBBaovlYqFbObBbDYYDOJ2HwqFtGql3WGPJ9LNeo2i7I8W0qj7iyBMbo+v3+/7PLTZSnp9fmxu/i7k+70Ow4S9tHu6EEIMc2/QpdPJXP43DCSDoYj+549ImGHZbIkrZ1KpSDwRQGbwYVn2K2ev12uz2b5ybrVauMLznKPRKIKWsr29vblcLrPZLG0kXrbtdsuVOJVK9fLyIkkSLwhrURwORz6fTwEBb25u7u7ubm9v8YXvdrtJkvwEkRPiPT09XV9ff4YplUpodCwbwvR6vWq1WqvVnlsti8WCm0NFNdna7XYsFsNZiEYwECzl83koeoYz0G+cEaNWq79x9vv9x83JRBwL74eDuBKgpNfrs1qtpwgwRDDkhM6DfnexPO7nF/PBQNZ5OOirVZekzc6Vq7FwyGqj7n78xKmz1yE2oP5Gq9vp9rQqpcl0b3e4wcLlcNybHmmvT4Gmt1PWQqFQ4ir5bBbSWknK6XK+SetYNB6LhJbrTbfbudVq/k5E84UCcuRYNpFMo9WPUmEGvnHGbcPZbjbj8euJM6Q6wxkNgH4UJXE6mcIEQcC4EASBloaKUH61WmHmtFpNu9PG/ul0tlgsoc5xMyIgGuhBT3zho0lwYScQl4ycmFkUeXV19Rl2eXkJjY63ja6YTCadTgf88QygZnTFYDDoyoYBwthBZ47jsAoErVapVM7rjN7+Ns+gdn6e0VKJeGw+n+/2hxW/nM0XNO21keRs8spjnt9308mkXKnJ8zwQxQ2SIP9kOgsGA7LON0edi8VyhGEspM3w60F3pyIsllA4Xi7+ISxW44Pp0UzkYqFwhEXXPpp++QNMNB5XgKrb5Tg2dr3B4YBq1e50EWYTVypWqjXgZa4UT6Z0Ov1ztZxKZ5vNBoa83niGRud7+79v2P/Os8Nux93Kj2wTAhIWQq/To6LTywskkUhAOSSEHoA6nXaxVMJTp9hsNnhoMv9aMpnEGKBaOCcEq2heKAQENQLBFz4k/AdMA9lelU0QtQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 38 57" title="" data-src="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png" data-srcset="/static/2022-05-15-16-38-57-1af0e5052de3f01bec0ecbea0e2f3406-0e000.png 153w" data-sizes="(max-width: 153px) 100vw, 153px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用矩阵后得到</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.393120393120395%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAnUlEQVQI11WOyQ6DMBBD+f8fREig5NZsiCiQfZla0EqtD3N4sseepBD7vtdapZTbtrXWiOg4DqVUKcVaO8+z9wEw5/wSwnsfY1zXVWs1AZWcex9CCKDWOnyIgY8xnHPLsoQQAXvvKWd8TyndYT3RLWRQxRjDBPoK7uu6GOdPM9F4YEyRc26M+YRRdboTI+lHtZYQgtbmD7YK82Et7huV7eWxPSf+CQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 15 16 39 34" title="" data-src="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png" data-srcset="/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-a67b7.png 200w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-0b187.png 400w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-fee1c.png 800w,\n/static/2022-05-15-16-39-34-f888e505c953d12cd9230d0940f45016-85bfe.png 814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>即</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62685819622469130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x * sx;\nnewY = y * sy;`, `62685819622469130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x * sx;\nnewY = y * sy;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和缩放例子相似。</p>\n<p>现在你可能还会想“那又怎样，有什么意义？”，好像花了更多精力做之前做过的事情。</p>\n<p>现在开始有趣的部分了，相乘后他们可以用一个矩阵代表三个变换，假定有一个方法 m3.multiply 可以将两个矩阵相乘并返回结果。</p>\n<p>为了方便讲解，我们先创建平移，旋转和缩放矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51181362882251700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  translation: function (tx, ty) {\n    return [1, 0, 0, 0, 1, 0, tx, ty, 1];\n  },\n\n  rotation: function (angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n    return [c, -s, 0, s, c, 0, 0, 0, 1];\n  },\n\n  scaling: function (sx, sy) {\n    return [sx, 0, 0, 0, sy, 0, 0, 0, 1];\n  }\n};`, `51181362882251700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">translation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scaling</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>sx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在该修改着色器了，原来的着色器像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5033995588399964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform vec2 u_translation;\n   uniform vec2 u_rotation;\n   uniform vec2 u_scale;\n\n   void main() {\n      // 缩放\n      vec2 scaledPosition = a_position * u_scale;\n\n      // 旋转\n      vec2 rotatedPosition = vec2(\n         scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n         scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x);\n\n      // 平移\n      vec2 position = rotatedPosition + u_translation;\n      // ...\n   }\n</script>`, `5033995588399964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform vec2 u_translation<span class="token punctuation">;</span>\n   uniform vec2 u_rotation<span class="token punctuation">;</span>\n   uniform vec2 u_scale<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 缩放</span>\n      vec2 scaledPosition <span class="token operator">=</span> a_position <span class="token operator">*</span> u_scale<span class="token punctuation">;</span>\n\n      <span class="token comment">// 旋转</span>\n      vec2 rotatedPosition <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>\n         scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">+</span> scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n         scaledPosition<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>y <span class="token operator">-</span> scaledPosition<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rotation<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 平移</span>\n      vec2 position <span class="token operator">=</span> rotatedPosition <span class="token operator">+</span> u_translation<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新着色器就简单多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82219598661698810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform vec2 u_resolution;\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 将位置乘以矩阵\n      vec2 position = (u_matrix * vec3(a_position, 1)).xy;\n      // ...\n   }\n</script>`, `82219598661698810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform vec2 u_resolution<span class="token punctuation">;</span>\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置乘以矩阵</span>\n      vec2 position <span class="token operator">=</span> <span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是使用的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61030267467632160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 矩阵相乘\n  var matrix = m3.multiply(translationMatrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // 设置矩阵\n  gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n  // 绘制图形\n  gl.drawArrays(gl.TRIANGLES, 0, 18);\n}`, `61030267467632160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制图形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个例子用的新代码，滑块没变，还是对应平移，旋转和缩放，但是他们在着色器中做的事情是相似的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4b2hc3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可能你还会问，那又怎样？看起来没什么特别好的地方。但是，如果现在我们想改变转换顺序的话，就不需要重写一个着色器了，只需要改变一下数学运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64290636289019100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(scaleMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, translationMatrix);\n\n// ...`, `64290636289019100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-5}"\n              >\n                <span class="gatsby-code-button-language">js{3-5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 矩阵相乘</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>scaleMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fdzw2v?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>像这样的矩阵相乘对层级变换至关重要，比如身体的手臂部分运动，月球属于绕太阳转动的地球的一部分，或者树上的树枝。写一个简单的层级运动的例子，我们来画 5 个 ‘F’，并且每个 ‘F’ 都以前一个的矩阵为基础。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39188073794567390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // 清空画布\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  // 计算矩阵\n  var translationMatrix = m3.translation(translation[0], translation[1]);\n  var rotationMatrix = m3.rotation(angleInRadians);\n  var scaleMatrix = m3.scaling(scale[0], scale[1]);\n\n  // 初始矩阵\n  var matrix = m3.identity();\n\n  for (var i = 0; i < 5; ++i) {\n    // 矩阵相乘\n    matrix = m3.multiply(matrix, translationMatrix);\n    matrix = m3.multiply(matrix, rotationMatrix);\n    matrix = m3.multiply(matrix, scaleMatrix);\n\n    // 设置矩阵\n    gl.uniformMatrix3fv(matrixLocation, false, matrix);\n\n    // 绘制图形\n    gl.drawArrays(gl.TRIANGLES, 0, 18);\n  }\n}`, `39188073794567390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 清空画布</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> rotationMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 初始矩阵</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 矩阵相乘</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 设置矩阵</span>\n    gl<span class="token punctuation">.</span><span class="token function">uniformMatrix3fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 绘制图形</span>\n    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个例子中用到了一个新方法 <code class="language-text">m3.identity</code>，这个方法创建一个单位矩阵。单位矩阵就像 1.0 一样，和它相乘的矩阵不会变化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23191124590274482000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  identity: function () {\n    return [1, 0, 0, 0, 1, 0, 0, 0, 1];\n  }\n};`, `23191124590274482000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">identity</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是 5 个 F。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/w7p3wi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再看一个例子，之前的每个例子中 ‘F’ 都是绕着它的左上角旋转 （当然，改变转换顺序的那个例子除外）。这是因为我们总是绕原点旋转，而 ‘F’ 的原点就是左上角，也就是 (0, 0) 。</p>\n<p>现在我们可以使用矩阵运算，并且自定义转换的顺序。所以让我们改变旋转的中心</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76212652520676720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个矩阵，可以将原点移动到 \'F\' 的中心\nvar moveOriginMatrix = m3.translation(-50, -75);\n// ...\n\n// 矩阵相乘\nvar matrix = m3.multiply(translationMatrix, rotationMatrix);\nmatrix = m3.multiply(matrix, scaleMatrix);\nmatrix = m3.multiply(matrix, moveOriginMatrix);`, `76212652520676720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个矩阵，可以将原点移动到 \'F\' 的中心</span>\n<span class="token keyword">var</span> moveOriginMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 矩阵相乘</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> moveOriginMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果，注意到 F 现在绕中心旋转和缩放了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3mvm0w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>通过这种方式你可以绕任意点旋转和缩放，所以现在你可能知道为什么 PhotoShop 或 Flash 可以让你移动旋转中心。</p>\n<p>还可以做更有趣的事情，如果你回想第一篇文章 WebGL 基础概念，可能会记得在着色器中我们将像素坐标转换到裁剪空间，这是当时的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45024664462190250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n// 从像素坐标转换到 0.0 到 1.0\nvec2 zeroToOne = position / u_resolution;\n\n// 再把 0->1 转换 0->2\nvec2 zeroToTwo = zeroToOne * 2.0;\n\n// 把 0->2 转换到 -1->+1 (裁剪空间)\nvec2 clipSpace = zeroToTwo - 1.0;\n\ngl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);`, `45024664462190250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// ...</span>\n<span class="token comment">// 从像素坐标转换到 0.0 到 1.0</span>\n<span class="token keyword">vec2</span> zeroToOne <span class="token operator">=</span> position <span class="token operator">/</span> u_resolution<span class="token punctuation">;</span>\n\n<span class="token comment">// 再把 0->1 转换 0->2</span>\n<span class="token keyword">vec2</span> zeroToTwo <span class="token operator">=</span> zeroToOne <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 把 0->2 转换到 -1->+1 (裁剪空间)</span>\n<span class="token keyword">vec2</span> clipSpace <span class="token operator">=</span> zeroToTwo <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>\n\ngl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>clipSpace <span class="token operator">*</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>逐步观察，首先 <code class="language-text">从像素坐标转换到 0.0 到 1.0</code> 事实上是一个缩放变换，第二步也是缩放变换，接着是一个平移和一个 Y 为 -1 的缩放。我们可以将这些操作放入一个矩阵传给着色器，创建两个缩放矩阵，一个缩放 1.0/分辨率，另一个缩放 2.0，第三个平移 (-1.0, -1.0), 然后第四个将 Y 缩放 -1。 然后将他们乘在一起，由于运算很简单，所以我们就直接定义一个 projection 方法，根据分辨率直接生成矩阵。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51069495851329520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  projection: function (width, height) {\n    // 注意：这个矩阵翻转了 Y 轴，所以 0 在上方\n    return [2 / width, 0, 0, 0, -2 / height, 0, -1, 1, 1];\n  }\n};`, `51069495851329520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">projection</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 注意：这个矩阵翻转了 Y 轴，所以 0 在上方</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">/</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在可以简化着色器，这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52044672081944880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 使位置和矩阵相乘\n      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n   }\n</script>`, `52044672081944880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 使位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 JavaScript 中需要乘上投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50744122341709460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 计算矩阵\n  var projectionMatrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);\n\n  // ...\n\n  // 矩阵相乘\n  var matrix = m3.multiply(projectionMatrix, translationMatrix);\n  matrix = m3.multiply(matrix, rotationMatrix);\n  matrix = m3.multiply(matrix, scaleMatrix);\n\n  // ...\n}`, `50744122341709460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 计算矩阵</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 矩阵相乘</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> translationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotationMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里还去除了设置分辨率的代码，通过使用矩阵，我们就把着色器中 6-7 步的操作在一步中完成。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/uyfqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在继续之前我们可以先简化一下操作，虽然先创建一些矩阵再将它们相乘很常见，但是按照我们的顺序依次操作矩阵也比较常见，比较高效的做法是创建这样的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45123190793347640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  // ...\n\n  translate: function (m, tx, ty) {\n    return m3.multiply(m, m3.translation(tx, ty));\n  },\n\n  rotate: function (m, angleInRadians) {\n    return m3.multiply(m, m3.rotation(angleInRadians));\n  },\n\n  scale: function (m, sx, sy) {\n    return m3.multiply(m, m3.scaling(sx, sy));\n  }\n\n  // ...\n};`, `45123190793347640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token function-variable function">translate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> ty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scale</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> m3<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m3<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这能够让我们将 7 行的矩阵代码转换成 4 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79757334002779850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算矩阵\nvar matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight); // 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形\nmatrix = m3.translate(matrix, translation[0], translation[1]);\nmatrix = m3.rotate(matrix, angleInRadians);\nmatrix = m3.scale(matrix, scale[0], scale[1]);`, `79757334002779850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算矩阵</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回的是画布在浏览器中实际显示的大小，所以这里图片比例不会变化。相反如果直接用 canvas.width 和 canvas.height，画布将被拉伸导致图片变形</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lvd1iu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最后一件事，我们之前使用了多种矩阵顺序。第一例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11014040693095107000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translation * rotation * scale; // 平移 * 旋转 * 缩放`, `11014040693095107000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translation <span class="token operator">*</span> rotation <span class="token operator">*</span> scale<span class="token punctuation">;</span> <span class="token comment">// 平移 * 旋转 * 缩放</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二例中使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5618098473914391000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scale * rotation * translation; // 缩放 * 旋转 * 平移`, `5618098473914391000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scale <span class="token operator">*</span> rotation <span class="token operator">*</span> translation<span class="token punctuation">;</span> <span class="token comment">// 缩放 * 旋转 * 平移</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后观察了它们的区别。</p>\n<p>这有两种方式解读矩阵运算，给定这样一个表达式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4508148714392268300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`projectionMat * translationMat * rotationMat * scaleMat * position;`, `4508148714392268300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">projectionMat <span class="token operator">*</span> translationMat <span class="token operator">*</span> rotationMat <span class="token operator">*</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一种可能是多数人觉得比较自然的方式，从右向左解释</p>\n<p>首先将位置乘以缩放矩阵获得缩放后的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59566967054571340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scaledPosition = scaleMat * position;`, `59566967054571340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">scaledPosition <span class="token operator">=</span> scaleMat <span class="token operator">*</span> position<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放后的位置和旋转矩阵相乘得到缩放旋转位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66674293121950835000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`rotatedScaledPosition = rotationMat * scaledPosition;`, `66674293121950835000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">rotatedScaledPosition <span class="token operator">=</span> rotationMat <span class="token operator">*</span> scaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后将缩放旋转位置和平移矩阵相乘得到缩放旋转平移位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77131391559728100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translatedRotatedScaledPosition = translationMat * rotatedScaledPosition;`, `77131391559728100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">translatedRotatedScaledPosition <span class="token operator">=</span> translationMat <span class="token operator">*</span> rotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后和投影矩阵相乘得到裁剪空间中的坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90610847849881350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`clipspacePosition = projectioMatrix * translatedRotatedScaledPosition;`, `90610847849881350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">clipspacePosition <span class="token operator">=</span> projectioMatrix <span class="token operator">*</span> translatedRotatedScaledPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第二种方式是从左往右解释，在这个例子中每一个矩阵改变的都是画布的坐标空间，画布的起始空间是裁剪空间的范围(-1 到 +1)，矩阵从左到右改变着画布所在的空间。</p>\n<ol>\n<li>没有矩阵（或者单位矩阵）</li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=0) -->\n<p>白色区域是画布，蓝色是画布以外，我们正在裁剪空间中。传递到这里的点需要在裁剪空间内。</p>\n<ol start="2">\n<li><code class="language-text">matrix = m3.projection(gl.canvas.clientWidth, gl.canvas.clientHeight);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=1) -->\n<p>现在我们在像素空间，X 范围是 0 到 400，Y 范围是 0 到 300，0,0 点在左上角。传递到这里的点需要在像素空间内，你看到的闪烁是 Y 轴上下颠倒的原因。</p>\n<ol start="3">\n<li><code class="language-text">matrix = m3.translate(matrix, tx, ty);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=2) -->\n<p>原点被移动到了 tx, ty (150, 100)，所以空间移动了。</p>\n<ol start="4">\n<li><code class="language-text">matrix = m3.rotate(matrix, rotationInRadians);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=3) -->\n<p>空间绕 tx, ty 旋转</p>\n<ol start="5">\n<li><code class="language-text">matrix = m3.scale(matrix, sx, sy);</code></li>\n</ol>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/siwlob?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?stage=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-2d-matrix-space-change](embedded-codesandbox://webgl-fundamental-2d/webgl-2d-matrix-space-change?view=preview&initialpath=?stage=4) -->\n<p>之前的旋转空间中心在 tx, ty，x 方向缩放 2，y 方向缩放 1.5</p>\n<p>在着色器中执行 <code class="language-text">gl_Position = matrix * position;</code>，position 被直接转换到这个空间。</p>\n<p>选一个你容易接受的方式去理解吧。</p>\n<h1 id="webgl-实现-drawimage-接口"><a href="#webgl-%E5%AE%9E%E7%8E%B0-drawimage-%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 实现 DrawImage 接口</h1>\n<p>此文上接 WebGL 三维正射投影，如果没读建议从那里开始，你也应了解纹理和纹理坐标，如果不清楚可以看看 WebGL 三维纹理。</p>\n<p>实现大多数二维游戏只需要一个方法去绘制一个图像，当然也有一些二维游戏用线等技术做一些有趣的东西，但是如果你有绘制二维图像的方法，基本上可以做大多数二维游戏。</p>\n<p>画布有一个非常灵活的二维接口叫做 drawImage，用于绘制图像。它有三个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8046829343901396000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY);\nctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);\nctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `8046829343901396000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\nctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>用你现在学到的所有东西如何使用 WebGL 实现这个接口？你想到的办法可能是创建一些顶点，像本站第一篇文章那样。将顶点传送到 GPU 是一个比较耗时的操作（尽管某些情况下比较快）。</p>\n<p>这就是 WebGL 发挥作用的地方，讲究富有创造性地编写着色器和使用它们去解决问题。</p>\n<h2 id="drawimage-版本一"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本一</h2>\n<p>让我们从第一个版本开始</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20373426513923265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, x, y);`, `20373426513923265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>它可以在 x, y 位置处绘制一个原始大小的图像，为了实现相似的功能，WebGL 需要上传 x, y, <code class="language-text">x + width</code>, y, x, <code class="language-text">y + height</code> 和 <code class="language-text">x + width</code>, <code class="language-text">y + height</code> 对应的顶点，当绘制不同的图像或不同的位置时就创建不同的顶点集合。</p>\n<p>一个更常用的方式是只使用一个单位矩形，我们上传一个长度为 1 个单位的正方形，然后使用矩阵运算缩放和平移单位矩形，以达到期望的大小和位置。</p>\n<p>这是代码。</p>\n<p>首先需要一个简单的顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7192791277415034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = a_texcoord;\n}`, `7192791277415034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n   v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和一个简单的片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5368777606115293000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `5368777606115293000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后轮到方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20442148898070856000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不同于图像，纹理没有对应的长和宽\n// 我们将向纹理传递长和宽\nfunction drawImage(tex, texWidth, texHeight, dstX, dstY) {\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 告诉 WebGL 使用的程序\n  gl.useProgram(program);\n\n  // 设置属性，从缓冲中提取数据\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n  gl.enableVertexAttribArray(positionLocation);\n  gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n  gl.enableVertexAttribArray(texcoordLocation);\n  gl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n  // 从像素空间转换到裁剪空间\n  var matrix = m4.orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1);\n\n  // 平移到 dstX, dstY\n  matrix = m4.translate(matrix, dstX, dstY, 0);\n\n  // 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度\n  matrix = m4.scale(matrix, texWidth, texHeight, 1);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `20442148898070856000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不同于图像，纹理没有对应的长和宽</span>\n<span class="token comment">// 我们将向纹理传递长和宽</span>\n<span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 使用的程序</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置属性，从缓冲中提取数据</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 texWidth, texHeight 个单位长度</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们来加载一些图像用于纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4398526501988375600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理信息 { width: w, height: h, texture: tex }\n// 纹理起初为 1x1 像素，当图像加载完成后更新大小\nfunction loadImageAndCreateTextureInfo(url) {\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // 假设所有的图像维度都不是 2 的整数次幂\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\n  var textureInfo = {\n    width: 1, // 图像加载前不知道大小\n    height: 1,\n    texture: tex\n  };\n  var img = new Image();\n  img.addEventListener(\'load\', function () {\n    textureInfo.width = img.width;\n    textureInfo.height = img.height;\n\n    gl.bindTexture(gl.TEXTURE_2D, textureInfo.texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);\n  });\n\n  return textureInfo;\n}\n\nvar textureInfos = [\n  loadImageAndCreateTextureInfo(\'resources/star.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/leaves.jpg\'),\n  loadImageAndCreateTextureInfo(\'resources/keyboard.jpg\')\n];`, `4398526501988375600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理信息 { width: w, height: h, texture: tex }</span>\n<span class="token comment">// 纹理起初为 1x1 像素，当图像加载完成后更新大小</span>\n<span class="token keyword">function</span> <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设所有的图像维度都不是 2 的整数次幂</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> textureInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    width<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 图像加载前不知道大小</span>\n    height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    texture<span class="token punctuation">:</span> tex\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    textureInfo<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width<span class="token punctuation">;</span>\n    textureInfo<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height<span class="token punctuation">;</span>\n\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> textureInfo<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> textureInfos <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">loadImageAndCreateTextureInfo</span><span class="token punctuation">(</span><span class="token string">\'resources/keyboard.jpg\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>绘制到随机位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27733903407808480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var drawInfos = [];\nvar numToDraw = 9;\nvar speed = 60;\nfor (var ii = 0; ii < numToDraw; ++ii) {\n  var drawInfo = {\n    x: Math.random() * gl.canvas.width,\n    y: Math.random() * gl.canvas.height,\n    dx: Math.random() > 0.5 ? -1 : 1,\n    dy: Math.random() > 0.5 ? -1 : 1,\n    textureInfo: textureInfos[(Math.random() * textureInfos.length) | 0]\n  };\n  drawInfos.push(drawInfo);\n}\n\nfunction update(deltaTime) {\n  drawInfos.forEach(function (drawInfo) {\n    drawInfo.x += drawInfo.dx * speed * deltaTime;\n    drawInfo.y += drawInfo.dy * speed * deltaTime;\n    if (drawInfo.x < 0) {\n      drawInfo.dx = 1;\n    }\n    if (drawInfo.x >= gl.canvas.width) {\n      drawInfo.dx = -1;\n    }\n    if (drawInfo.y < 0) {\n      drawInfo.dy = 1;\n    }\n    if (drawInfo.y >= gl.canvas.height) {\n      drawInfo.dy = -1;\n    }\n  });\n}\n\nfunction draw() {\n  gl.clear(gl.COLOR_BUFFER_BIT);\n\n  drawInfos.forEach(function (drawInfo) {\n    drawImage(\n      drawInfo.textureInfo.texture,\n      drawInfo.textureInfo.width,\n      drawInfo.textureInfo.height,\n      drawInfo.x,\n      drawInfo.y\n    );\n  });\n}\n\nvar then = 0;\nfunction render(time) {\n  var now = time * 0.001;\n  var deltaTime = Math.min(0.1, now - then);\n  then = now;\n\n  update(deltaTime);\n  draw();\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `27733903407808480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> drawInfos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> numToDraw <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> speed <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> numToDraw<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> drawInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n    x<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n    y<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n    dx<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    dy<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    textureInfo<span class="token punctuation">:</span> textureInfos<span class="token punctuation">[</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> textureInfos<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>drawInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">deltaTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    drawInfo<span class="token punctuation">.</span>x <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dx <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    drawInfo<span class="token punctuation">.</span>y <span class="token operator">+=</span> drawInfo<span class="token punctuation">.</span>dy <span class="token operator">*</span> speed <span class="token operator">*</span> deltaTime<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>x <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>drawInfo<span class="token punctuation">.</span>y <span class="token operator">>=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      drawInfo<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  drawInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">drawInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">drawImage</span><span class="token punctuation">(</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>texture<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>textureInfo<span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>x<span class="token punctuation">,</span>\n      drawInfo<span class="token punctuation">.</span>y\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> then <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> now <span class="token operator">=</span> time <span class="token operator">*</span> <span class="token number">0.001</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> deltaTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> now <span class="token operator">-</span> then<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  then <span class="token operator">=</span> now<span class="token punctuation">;</span>\n\n  <span class="token function">update</span><span class="token punctuation">(</span>deltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以在这里看到运行结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6hmyzm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本二"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本二</h2>\n<p>处理 drawImage 方法的第二个版本</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17385028880879895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, dstX, dstY, dstWidth, dstHeight);`, `17385028880879895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>没什么特别的地方，只是用 dstWidth 和 dstHeight 代替了 texWidth 和 texHeight。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71935427963788310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstWidth === undefined) {\n    dstWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `71935427963788310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-18}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-18}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将代码修改为使用不同的大小</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/idjd75?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="drawimage-版本三"><a href="#drawimage-%E7%89%88%E6%9C%AC%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawImage 版本三</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8070025382412349000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ctx.drawImage(image, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight);`, `8070025382412349000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了实现选择部分纹理，就需要操控纹理坐标。纹理坐标的工作原理在这篇文章中讲到，在那篇文章中我们手工创建纹理坐标，是一个非常常见的方式，但是我们也可以在运行时创建，然后使用矩阵简单的修改纹理坐标。</p>\n<p>让我们给顶点着色器添加一个纹理坐标矩阵，然后将纹理坐标和矩阵相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88297372776166230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * vec4(a_texcoord, 0, 1)).xy;\n}`, `88297372776166230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,11}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_texcoord<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们要找到纹理矩阵的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11734121452038160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var matrixLocation = gl.getUniformLocation(program, \'u_matrix\');\nvar textureMatrixLocation = gl.getUniformLocation(program, \'u_textureMatrix\');`, `11734121452038160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> matrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_matrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> textureMatrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_textureMatrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>在 drawImage 方法中需要设置它，用于选择我们需要的部分。我们知道纹理坐标是一个单位矩形所以可以简单的修改，就像对位置的处理一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36740733920996303000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawImage(tex, texWidth, texHeight, srcX, srcY, srcWidth, srcHeight, dstX, dstY, dstWidth, dstHeight) {\n  if (dstX === undefined) {\n    dstX = srcX;\n    srcX = 0;\n  }\n\n  if (dstY === undefined) {\n    dstY = srcY;\n    srcY = 0;\n  }\n\n  if (srcWidth === undefined) {\n    srcWidth = texWidth;\n  }\n\n  if (srcHeight === undefined) {\n    srcHeight = texHeight;\n  }\n\n  if (dstWidth === undefined) {\n    dstWidth = srcWidth;\n    srcWidth = texWidth;\n  }\n\n  if (dstHeight === undefined) {\n    dstHeight = srcHeight;\n    srcHeight = texHeight;\n  }\n\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n\n  // ...\n\n  // 从像素空间转换到裁剪空间\n  var projectionMatrix = m3.projection(canvas.width, canvas.height, 1);\n\n  // 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度\n  var scaleMatrix = m4.scaling(dstWidth, dstHeight, 1);\n\n  // 平移到 dstX, dstY\n  var translationMatrix = m4.translation(dstX, dstY, 0);\n\n  // 将矩阵乘起来\n  var matrix = m4.multiply(translationMatrix, scaleMatrix);\n  matrix = m4.multiply(projectionMatrix, matrix);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 因为纹理坐标的范围是 0 到 1\n  // 并且我们的纹理坐标是一个单位矩形\n  // 我们可以旋转平移矩形选择一部分纹理\n  var texMatrix = m4.translation(srcX / texWidth, srcY / texHeight, 0);\n  texMatrix = m4.scale(texMatrix, srcWidth / texWidth, srcHeight / texHeight, 1);\n\n  // 设置纹理矩阵\n  gl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);\n\n  // 告诉着色器使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制矩形\n  gl.drawArrays(gl.TRIANGLES, 0, 6);\n}`, `36740733920996303000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-18,21-22,26-27,50-57}"\n              >\n                <span class="gatsby-code-button-language">js{1-18,21-22,26-27,50-57}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token parameter">tex<span class="token punctuation">,</span> texWidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> dstWidth<span class="token punctuation">,</span> dstHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstX <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstX <span class="token operator">=</span> srcX<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstY <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    dstY <span class="token operator">=</span> srcY<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>srcHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstWidth <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstWidth <span class="token operator">=</span> srcWidth<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcWidth <span class="token operator">=</span> texWidth<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dstHeight <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    dstHeight <span class="token operator">=</span> srcHeight<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    srcHeight <span class="token operator">=</span> texHeight<span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 从像素空间转换到裁剪空间</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m3<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放单位矩形的宽和高到 dstWidth, dstHeight 个单位长度</span>\n  <span class="token keyword">var</span> scaleMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>dstWidth<span class="token punctuation">,</span> dstHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 平移到 dstX, dstY</span>\n  <span class="token keyword">var</span> translationMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>dstX<span class="token punctuation">,</span> dstY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将矩阵乘起来</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>translationMatrix<span class="token punctuation">,</span> scaleMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 因为纹理坐标的范围是 0 到 1</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 并且我们的纹理坐标是一个单位矩形</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 我们可以旋转平移矩形选择一部分纹理</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>srcX <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcY <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> srcHeight <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 设置纹理矩阵</span></span><span class="gatsby-highlight-code-line">  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 告诉着色器使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制矩形</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也上传了这个版本的例子，这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/50p8z5?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>不同于画布的二维接口，WebGL 对 drawImage 的情况做了更多的处理。</p>\n<p>一个是我们可以给源或者目标宽高传递负值，负的 srcWidth 会选择 srcX 左边的像素，负的 dstWidth 会将图像绘制在 dstX 的左边，在画布的二维接口中报错是好一点的情况，坏一点时会出现 udefined。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ytbfsj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>另一个是我们使用矩阵就可以实现任何矩阵运算可以实现的效果。</p>\n<p>例如绕纹理中心旋转纹理坐标。</p>\n<p>修改纹理坐标的矩阵代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84792702253444860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间\nvar texMatrix = m4.scaling(1 / texWidth, 1 / texHeight, 1);\n\n// 选择一个旋转中心\n// 移动到中心旋转后在回来\nvar texMatrix = m4.translate(texMatrix, texWidth * 0.5, texHeight * 0.5, 0);\nvar texMatrix = m4.zRotate(texMatrix, srcRotation);\nvar texMatrix = m4.translate(texMatrix, texWidth * -0.5, texHeight * -0.5, 0);\n\n// 因为在像素空间，缩放和平移现在是按像素单位\nvar texMatrix = m4.translate(texMatrix, srcX, srcY, 0);\nvar texMatrix = m4.scale(texMatrix, srcWidth, srcHeight, 1);\n\n// 设置纹理矩阵\ngl.uniformMatrix4fv(textureMatrixLocation, false, texMatrix);`, `84792702253444860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 像二维投影矩阵那样将坐标从纹理空间转换到像素空间</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> texWidth<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> texHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 选择一个旋转中心</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 移动到中心旋转后在回来</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcRotation<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> texWidth <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> texHeight <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// 因为在像素空间，缩放和平移现在是按像素单位</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcX<span class="token punctuation">,</span> srcY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>texMatrix<span class="token punctuation">,</span> srcWidth<span class="token punctuation">,</span> srcHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置纹理矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>textureMatrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> texMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fs0bbt?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>可以看出一个问题，在旋转的过程中会看到超出边缘的纹理，由于设置的是 <code class="language-text">CLAMP_TO_EDGE</code> 所以得到重复的边缘。</p>\n<p>我们可以在着色器中丢弃超出 0 到 1 范围的纹理，discard 将会立即退出着色器，不写入像素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16851528476436760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     discard;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `16851528476436760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{8-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span></span><span class="gatsby-highlight-code-line">       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">discard</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在边缘消失了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vf56m7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>或者你想的话也可以对超出的部分使用纯色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75345913345997320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D texture;\n\nvoid main() {\n   if (v_texcoord.x < 0.0 ||\n       v_texcoord.y < 0.0 ||\n       v_texcoord.x > 1.0 ||\n       v_texcoord.y > 1.0) {\n     gl_FragColor = vec4(0, 0, 1, 1); // 蓝色\n     return;\n   }\n\n   gl_FragColor = texture2D(texture, v_texcoord);\n}`, `75345913345997320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>v_texcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>x <span class="token operator">></span> <span class="token number">1.0</span> <span class="token operator">||</span>\n       v_texcoord<span class="token punctuation">.</span>y <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">     gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 蓝色</span></span><span class="gatsby-highlight-code-line">     <span class="token keyword">return</span><span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/pd6src?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>接下来讲实现画布二维接口中的矩阵栈。</p>\n<h2 id="一个小优化"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个小优化</h2>\n<p>我并不是要建议使用这个优化，而是想提出更多创意性的想法，因为使用 WebGL 就是利用它提供的特性去做创意。</p>\n<p>你可能会注意到我们使用的位置单位矩形和纹理坐标刚好匹配，所以我们就可以使用位置作为纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63830470620381120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\n// attribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n   gl_Position = u_matrix * a_position;\n   v_texcoord = (u_textureMatrix * a_position).xy;\n}`, `63830470620381120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{11}"\n              >\n                <span class="gatsby-code-button-language">glsl{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token comment">// attribute vec2 a_texcoord;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   v_texcoord <span class="token operator">=</span> <span class="token punctuation">(</span>u_textureMatrix <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在移除关于纹理坐标设置的代码，得到的结果和之前是相同的。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/n0b4pe?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>// TODO <a href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html" target="_blank" rel="nofollow noreferrer noopener">https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL 理论基础——二维/index.md absPath of file >>> MarkdownRemark",timeToRead:21,frontmatter:{date:"2022-08-05 18:45:42",path:"/webgl-fundamental-2d/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——二维",draft:null}},{excerpt:"WebGL 三维纹理 在 WebGL 中如何使用纹理？你可能会从二维图像处理的文章中得到启发，如果我们讲的再深入一点可能更好理解。 首先需要调整着色器以便使用纹理，这里是顶点着色器的修改部分，我们需要传递纹理坐标，在这个例子中直接将它们传到片断着色器中。 在片断着色器中声明一个 sampler2D 类型的全局变量，可以让我们引用一个纹理，然后使用从顶点着色器传入的纹理坐标调用 texture2D 方法，在纹理上找到对应的颜色。 我们需要设置纹理坐标 F 如你所见，我们将图像映射到 F…",html:'<h1 id="webgl-三维纹理"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维纹理</h1>\n<p>在 WebGL 中如何使用纹理？你可能会从二维图像处理的文章中得到启发，如果我们讲的再深入一点可能更好理解。</p>\n<p>首先需要调整着色器以便使用纹理，这里是顶点着色器的修改部分，我们需要传递纹理坐标，在这个例子中直接将它们传到片断着色器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48527272125645870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 传递纹理坐标到片断着色器\n  v_texcoord = a_texcoord;\n}`, `48527272125645870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,6,12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,6,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 传递纹理坐标到片断着色器</span></span><span class="gatsby-highlight-code-line">  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中声明一个 sampler2D 类型的全局变量，可以让我们引用一个纹理，然后使用从顶点着色器传入的纹理坐标调用 texture2D 方法，在纹理上找到对应的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63112929549825730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\nvarying vec2 v_texcoord;\n\n// 纹理\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `63112929549825730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,6-7,10}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,6-7,10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 纹理</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要设置纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81138218296621470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点坐标中的属性\nvar positionLocation = gl.getAttribLocation(program, \'a_position\');\nvar texcoordLocation = gl.getAttribLocation(program, \'a_texcoord\');\n\n// ...\n\n// 为纹理坐标创建一个缓冲\nvar buffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, buffer);\ngl.enableVertexAttribArray(texcoordLocation);\n\n// 以浮点型格式传递纹理坐标\ngl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n// 设置纹理坐标\nsetTexcoords(gl);`, `81138218296621470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,10,12-13,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,10,12-13,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点坐标中的属性</span>\n<span class="token keyword">var</span> positionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texcoordLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_texcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 为纹理坐标创建一个缓冲</span></span><span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 以浮点型格式传递纹理坐标</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 设置纹理坐标</span></span><span class="gatsby-highlight-code-line"><span class="token function">setTexcoords</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="f"><a href="#f" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>F</h2>\n<p>如你所见，我们将图像映射到 F 中的每个矩形面上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46840264937758730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 为 F 设置纹理坐标缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面左竖\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0,\n\n      // 正面上横\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0\n\n      //  ...\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `46840264937758730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 为 F 设置纹理坐标缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 正面上横</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span>\n\n      <span class="token comment">//  ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事实上使用一个带有 F 的图像能够在结果中清楚的分辨出纹理的方向。</p>\n<p>我们还需要一个纹理，我们可以从头做一个但在这个例子中就直接加载一个图像，因为那可能是常用的做法。</p>\n<p>这是我们将要使用的图像</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADQElEQVQ4y53Se0wURxwH8O/svVzUAy14R9SkcmrLcXCXAzGBayGmxEeMQhFJjQWixpjYCmo0PojhIbZqaGurRCMhZ1R8lNaYaP/w0dqcxEj/qFUBQcWGcjlB5OEDFXfn5+yKxkTSGJNPJjs7v+9OfjMLmoD3Bl44RPlKUnVcw94ytKqVrRqKgK7o/gG1gm69g9uga6C/tRQecgwQ7j/FyTpvXc0np/1JZ/yeC/74gN9ZfyBWEA9/+l3n/J7f/Ikn/KkHq71tITwlLYjjHL8SavowL3bdEpTvlL78GTMvIvkqnK2YLFxD7EUk/oKMSrZoJYq9WFt8HqcIxxQgiyObMKcfSxJydyP7rDHhpmTvY7JiYCSa0nFY7iHqLxZXi/n5WJByFjmETBEO42wkMXO/tDp+9jmktEn2AZhpFOpt+GIaClJRkIwCLxZ7pM89coYnKtYdbW7QImEqE591M3KjP77MldYKxyPJolghXuz2GdDuNJAHihuqkAA1XvMsTpuSjqmlEm1F/+YfXGk9+ECxMGUqo1zULpatgeXj76yJbimMbimy3yiKbl49pqWIKeWMl70kdm5k1IIHDftcMwYxgkeAp4LW4skh8736mO7Lju46R3epozPHMRg3adeUj9EVkMSt8kZQE9DL2UNCR1+1M0OFkUeCfwbaAvod9AD0GHQJ9C2ez2I0GjUjrWgOGh4TelT0iaM8xNkR7a72xcwchEXsrPpAG3C9UiopjtpWZqv42laRZStPslfaIzPtH6HqLjtKIoXDIpzOWTohvXeXbW4vrKqFPRc952PP7Ah8eMXg6oSrA54gkoKYHkRKCGkKtHqdycTNRoLcWxGx8BYmDECcNqNkVLvHwtQ5KoxkmcsjSLaQbCaLiUxvgA/8U1CSsWdD+NLz8P4L2wBMFI6asWOcCKaDfFB8Wiuv0Wv4kalVoG9M3UXh6/cjM4DEO5hITK5ltk0stJeRKPiJ8WGhHTwEumrsmmPdmIO8EsyohusPjCuFLYBgF0gU/AcalvhvOwihZ6xtq1SyAsvWYekm5G1Bbgnye9BEuKsXBIcl4tt1OwjfESr1Ufhet+PV6vBE2CFwOFR95No0RuDa6Ph/LwDyagrEe1kcagAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 06 11 32 56" title="" data-src="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png" data-srcset="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-b25ce.png 200w,\n/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>加载图像的过程是异步的，我们请求图像资源后浏览器需要一段时间去下载。通常有两种处理方法，一种是等纹理下载完成后再开始绘制，另一种是在图像加载前使用生成的纹理，这种方式可以立即启动渲染，一旦图像下载完成就拷贝到纹理。我们将使用下方的方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71531201258045530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 用 1x1 个蓝色像素填充纹理\ngl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n\n// 异步加载图像\nvar image = new Image();\nimage.src = \'resources/f-texture.png\';\nimage.addEventListener(\'load\', function () {\n  // 现在图像加载完成，拷贝到纹理中\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n  gl.generateMipmap(gl.TEXTURE_2D);\n});`, `71531201258045530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 用 1x1 个蓝色像素填充纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载图像</span>\n<span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 现在图像加载完成，拷贝到纹理中</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7x6dzh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我只想使用一部分图像覆盖 ‘F’ 的正面怎么办，纹理是通过“纹理坐标”来引用的，纹理坐标 0.0 到 1.0 对应纹理从左到右，0.0 到 1.0 对应第一个像素所在行到最后一行。注意我没有使用上或者下，上下在纹理坐标空间中是没有意义的，因为绘制一些东西后再重定向后，是没有上下的概念的，主要是依据传递给 WebGL 的纹理数据，纹理数据的开头对应纹理坐标 0, 0，结尾对应纹理坐标 1, 1</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 169px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.75739644970415%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADOUlEQVQ4y62UbWhTVxjH/09iFW60NDFK1Oa2iTGtFtsK9i2iotJbWxBk+sUvsi9jF0RkU1ah6OwHkeqXbWiHH6ZuICjiBzesCOLwrb7MopujtqG2VXGuIooOanNzc5499yY2cQiOsQM/zsk9//PjOTfnXOi6DqdJHyzTwyH8x9btyQ3ywnBZuKw8fhbwdEyBb48X2pf/Asn5PveiyHHs9RYIm+ZGZqLRV9zrrdn0BPVjf6Ih+RR1Q39g6Xtx5p6iYVByY7eodqvj+AtNnknhyjn1M7ECxbdweAvjMr/GOZ7Az5zG1RzXCujlFC7xK/Qwy9wd+q7Tcdi46J0UNobWlqAF2kFKmj3E/CNx6gc8sw/hN7sb9+xuuiPcdTlEffZRemifIZ44L9nDntFdjuM8OF9hNGT4Pa3QqqnfbARzApwOYpuSKQaKpC8Wpgsl7rMZ+Fg1gS2BazC0231thcJQ1PC3Ahpq+00kZCfLZGdzdyqSxTRvu6LEa0V1I4rqHwsPFRqeKzQqS3KMJVmhjAuECcNviJCOJU26IqEbItzUka3w0y6FQc7gpnBb6BOuCRfYkmdMx0ezwuuFQmN5Vnj/tEn8OxMPptG+OSuMxRUZ6xStalHU3CaVrlT0/X5F3G8RDzAN/5QV8kChMO5vc7Z8f40J/ojBG0UYywoTUxXa5f1t9Sl8Jv0n0xR6FivJWOANjKHmnHBjXqgbIf88NGvhfq85X3QxRrrkC7hCf1eRivH0TIR9megkUzNRG5bkWH/gcYWyLi+sEyHQou0bIPO4hE6KsK0jK1zfCXWKkTmSgjqWycEuluT4wAi5whOFwubVjtDQ7vXClFPN6gVSD36BfeEE7JE+2PLbtsaEZ++Q4nFw8ja555DfFAiNJY6wVRvYQVv4GzlcXcLXwrfCV8J+4cA/cDIHwcPt5N6Ul53e/E1pKQ8VI7DK92vMs3l8EV5aVRidWIhH45V45PSpqvcykq7Ci2SctrkVyhVA6ds/JRwOhCNlgRp4iirg1+MIfJAKBEoXILggNmV2oLQiMk0vDWuT3zOpNCFUO+NgbSwwu3p+8EPMklxoYVSfUxmZIWsrhMUoz1X4f7W/Aa9CwjdT6tEOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 32" title="" data-src="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png" data-srcset="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png 169w" data-sizes="(max-width: 169px) 100vw, 169px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我将纹理载入到 Photoshop 中得到一些点的坐标。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEcUlEQVQ4y32Ue0zWZRTHz3uFl4uIJLx4m/CKyE0CucwEFVErs+nWMNcmLm1TSc1bJjITxUrTmpeykLAWmiXVXP2RzSA0tGxi6sJU1MJk0jBRCUV5f++n83txtTnrj89znvM85/n+zu/3nPOTswNtHBrmpHWglYZEJ11uAcX3f0RrTKTwS6ydA3FOmmNsnPbYOae+nFpgo3ppIHVz7exf4eJmkRXmWzCe78HnR/7BXPPqPkVCfZGTqvkuauY72L/YyY9LHQjH9Gk/6eZ7grde578qTcr5ezTdx/n7OC4c2qH2WA9y3RBuq+6JC0JFeTr7Ksfy1Y5saivSOVKewuHKRL7bmUC9ic7NtbryNI3J4guN3b55BLVHhS7VMLVkrw6fqfPhX8KUYcuYGvkMz6WOZL17JCtHJfJpnzhNeogm46EuIJ7FGfEUp41g6aDxzMzNJ03mUVpr5UvV+KRbBZ9UwSnqTLwuPJs0jdcd49kTMZiasHAqUqw0ReiryL+cC7JzytWb6uABlA2N52lnPtlfC1NVY7JPBYMMC8HqOG9YWJT8GDWSw28SjU+c3O4t7MwVCrOFWSOF2RnCvGS1iVamJwQzLiGM3IJAXA1W1bAS0mHRZxopKjccuZHM2qQxnJVYOqwO7vbSjFKErdk2pDlJYx5GulMRI7VnfjWBzFfcZBX3YeC+fmRsjCTr/X6m4BoslOntlLA5eTTXJBxvgNAdp4LThd2FLkIOzyH60hKimhYRdX6R3/ZtWobn4HQyq8dgu7wSZ8cqHJ2rzK/yswqeQW4e5d3kPO5IAIa+qu8RFVyiFbDLwR/1g2n7Poa2vcrqGFqfiqErMYatsR6krVYzvqA0KqdV8LqBpVO/d0s7FYnj8Yod4yEVzNciXqWiNYpWAF3KD8oG5XElVKhyhSBnWrHdwqw//Ww+FaxSwY90obKd8tgJmqHTn6ExSg+tEE5tsrK6JJJ1a6IoW6BMjWJthpuN7r4UuPthefssskfP7/IqpmCeKufpQl47m6OeoF164XVauDtU22um8Nak3sjg40jKFaUZSbuEZKhNv0lQzgHiJ1ehhYGMoUfHYTdwavtK4DXWhRVodw2gU7P0mrecqd0zvA9iv0qQCwIDISBArZIzagk5uTOIif2AERlzycxagM2q/ZIjBqPNs/Y/eSlsFt9ImnZGpIo6IEzrMDycJGlhrMbkSDdmfK7aR0NOMCG4gfygRiaEHFdO6t4dZJsGbNfg9fY2FoYtp1ymcFDSuaiZoje+29KXYkuLrsM28So+P1vUN9l6z27x7+uRZh2uKCdVcFKvYqZJIaUyjkpJ5lvNtEz6c0Su0mrp+RGZ8ZeU3x+Aua7Nd1nHK9yVi6yzlDJHZvOizNILnqFihSwPnUhj9MdmXfjjemj5T8Qnr2nfvqrOeuUNZdM9+ya3bJs46l5IXWwBLYEvc6T/CzSHlvhjDT3jewAq6NGAIZjW0D428Sqofy7UzTupwXzuiaR6aDgbRjuoHRShe3Ea5/GfuZ+/AUj1ih5wg07pAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 52" title="" data-src="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png" data-srcset="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-7728b.png 200w,\n/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-23f96.png 400w,\n/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以像这样将像素坐标转换到纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49958708876708410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`texcoordX = pixelCoordX / (width - 1);\ntexcoordY = pixelCoordY / (height - 1);`, `49958708876708410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">texcoordX <span class="token operator">=</span> pixelCoordX <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ntexcoordY <span class="token operator">=</span> pixelCoordY <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这是正面的纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66907490666253476000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,`, `66907490666253476000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对背面也使用相同的纹理坐标，得到这样的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x9ilbj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>并不是非常好看，但是希望这样能展示出纹理坐标的用法。如果你使用代码生成几何体（立方体，球体，等等），通常情况下计算期望的纹理坐标也是比较容易的。另一方面如果通过软件例如 Blender, Maya, 3D Studio Max 制作几何体，那么你的美术（或者你自己）就会用软件调整纹理坐标。</p>\n<p>如果纹理坐标再 0.0 到 1.0 之外会怎样？WebGL 默认会重复纹理，0.0 到 1.0 是一份纹理的“拷贝”，1.0 到 2.0 是另外一份拷贝，-4.0 到 -3.0 也是另外一份拷贝。让我们在一个平面上使用这些纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61935409419243405000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,`, `61935409419243405000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/2mkgm4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>你可以使用 <code class="language-text">CLAMP_TO_EDGE</code> 告诉 WebGL 再某个方向不需要重复，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63680765692086624000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);`, `63680765692086624000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>点击上方示例中的按钮，观察结果。</p>\n<p>你可能注意到在加载纹理时调用了 <code class="language-text">gl.generateMipmap</code>，那是干什么的？</p>\n<p>假设我们有这样一个 16×16 像素的纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y3WU+UtUURTHz31v3oxjOq6j45vnkmtqOvCyQlKwoHAX0dFsEUzBnyzGcd8CKfsLgoh+lUqK/EHzByvX3JdAQSNQfxAsIVApc3nv3e57b9IZpcOXw134cO69nO8FTCI7GwNgvV7OACKiSJ4OiY1p62I7ekbDE8l0x9Og7v5BGpLHtCxwjYAlCS8tYatV3tNqMUL/4HPRLa/Yxz0jERYyPWAYkveBJvmdW6QloBTMtYBFUS4+Po6LimSeohxwMIFfHsGHZB0QGfTpw68E3IbgFspsB5k8OJDzwgKOi8M6nagcT6l8DAsUJQD6ojUmk5pcM2OuBnONApMQBDlvb2OLRUToNLxPadZpT1/WBlw9TWoS8hgmQS6/t4c3N8W0NBmOtKgP9imCl19IZ+ZMlVrWhlRMlXQqhK/fcJF1yt0Y3fra1NE7Gx4/igLi2AoU9hCFNCKuBnF2VU6V1RCVBxwZnKtrjWnvCn/SfT/aeoMpANMjKrANjC3g3wj+DbL8GmB4YsVFkyuDQ0uTi9+fD62ay19EtHTH3Km/mFV8Lac4NVvVTYdybgE43+FIQdVgeqA/bztr7xyfTcRbIGxSeAOcROEfegCvqpPyqQJdFWOpuPomY2XJiH9S0m/Au4B3nIXwLxr6BpZP6H3/wsfP68+mRlL6rtun+azavNS8kqzi/PTCAicVpluL/vNgM3OLT+su92TFfsgv4W8kQRn4tiNDExiaXXR4KLpIFPfX1nBJ6YwJkvuyE4byFi5496OwqOByKtSuCal2lmtlpc/EzAzSFfO8Kbk3M2Ewd5gPJNMBPcewNtLPLk3iwEh7k/NubUk8L2plA83H+6rwBO9Ppru0ZlXj5RNURRiGrXaCVWMsL0upqcTVqjFOwCKFBKAGdMF84D1iKcZsU2DVknNzUlmZRDDiZwqdhgUKSYol37pFJRnvAtekWJLAGxu4okJSPxOaFhn5r5hP9HfASfKdBbJI0/s0gxF0esSFsZWOY0s5OTLp54cNBiLR2wvrzsxf4mR4IHciJRRr3AWyqOweGLyxh3bMK4x8Q38BmzUwlIDtkJwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 15 32" title="" data-src="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png" data-srcset="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-b25ce.png 200w,\n/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假设我们要将它绘制在屏幕的 2×2 个像素上，那么这 4 个像素应该使用什么颜色？这里有 256 个像素可以选择，如果在 Photoshop 中将 16×16 的图像缩放到 2×2，它会将每个角 8×8 的像素的平均值赋给这四个像素。不幸的是绘制 64 个像素再求平均在 GPU 中是非常慢的。假设你有一个 2048x2048 像素的纹理想要绘制成 2x2 个像素，就需要对 1024x1024 或 100 万个像素求平均 4 次，这需要很多运算同时速度要快。</p>\n<p>事实上 GPU 使用的是一个纹理贴图（mipmap），纹理贴图是一个逐渐缩小的图像集合，每一个是前一个的四分之一大小，16×16 纹理的纹理贴图看起来像这样。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 526px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.80988593155894%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACn0lEQVQoz32SXUiTURjHn80tv0bqzNaasq2cLsWP0C5UKGdqNpdZ6pwlpNB0pmgTl9bmhWkl9kEISmlDzVZ+ZOit4kXCLr0IQiIsIp2ubGS9e31nbu/Tu4lIEP5unv+Bc36cw//Ah4mJNYdAsLEK4NwEIKtU1aT2nI4kmPyTBc4F8N9IFZc65ju7bN9EQtfDZIXzPS+cuhyc/uNJQ9vXwRPZzorjuUt3L2q2imLi3oKDIDZwbg6Ruw8RAPWlBqxTG3x5i83BPH4JsqSNm58/flonzC+wO60Ym2NUGCa96hroGXVbjA2oyspdvFNYpMuOFItgZdnmRAZqZpZGFtC1Sh1tUDfQjJBWCEtpkJgwUFxDNbePONoG5rGis8Vd35GF11syiDFd2eBkosii5ifoYQf3HyeJ29BonUFT431UKU2YBSUI/C4agozMNFDz7xZ/LY++wf4qOTZlZOLhBK0TQCDa8TwqLOCkCaUsKKzsJTW1L1FdPUSX17/C+PJnWPmgBsct0Tg6JKfHh2VoNidRtv4+myv+CGVWCokFfqhLHZBrB2lFtFd2PirfzzuxIx+g4EoPqa6xYLHWTJdox/FMdx32zR7FsedyfD0s80yOxOJgv+y7BkB+E0CckyaRmnkgfcwBMRxM53hFqYERvlu2RYYAbFK/d588Z8V7vWexTJ+Op6AMIbzdAyEmhP1Nq8CRcOF/hOb9u161rfiErulppgguttQfw9vGZF/Lpw8Ve0DSitzIWntY8AGed78iLpr9lMdmXeJGsYCf6XOIAmW7wjWCINFqRU+Av7dZbDWmYvOtFJ+QYvt5ciI0CCK9PRYg2HcgRAF78mVqinQJBLjOfBOv5EZjIhqaktDNZBeAZ4kdhCnhF+wgvBa0LTy5p+8v8/lJy1AQEzkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 24 47" title="" data-src="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png" data-srcset="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-68c83.png 200w,\n/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-d339c.png 400w,\n/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png 526w" data-sizes="(max-width: 526px) 100vw, 526px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通常每个子图都是前一级的双线性插值，这就是 <code class="language-text">gl.generateMipmap</code> 做的事情，它根据原始图像创建所有的缩小级别，你也可以自己提供缩小级别的图像。</p>\n<p>现在如果你想将 16x16 像素的纹理绘制到屏幕的 2×2 个像素上，WebGL 会从创建的贴图中找到从之前级别贴图插值出的 2×2 贴图来使用。</p>\n<p>你可以为纹理选择不同的贴图筛选条件来控制 WebGL 的插值，一共有这 6 种模式</p>\n<ol>\n<li><code class="language-text">NEAREST</code> 从最大的贴图中选择 1 个像素</li>\n<li><code class="language-text">LINEAR</code> 从最大的贴图中选择 4 个像素然后混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_NEAREST</code> 选择最合适的贴图，然后从上面找到一个像素</li>\n<li><code class="language-text">LINEAR_MIPMAP_NEAREST</code> 选择最合适的贴图，然后取出 4 个像素进行混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上面选择 1 个像素然后混合</li>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上选择 4 个像素然后混合</li>\n</ol>\n<p>你可以通过这两个例子看到贴图的重要性，第一个显示的是使用 NEAREST 或 LINEAR，只从最大的贴图上选择像素，当物体运动时就会出现抖动。由于每个像素都从最大的图上选择，随着位置和大小的改变，可能会在不同的时间选择不同的像素，从而出现抖动。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vqm8in?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>观察发现左边和中间的抖动会多于右边。由于右边的使用多级贴图并且混合颜色，绘制的越小 WebGL 挑选的像素离原图关系越远。相反的中间的小图虽然使用了 LINEAR 混合 4 个像素的颜色，但这 4 个像素是从大图中选出来，不同的选择会有较大的差别，所以还是抖动明显。右下角的图保持颜色一致是从右中图中挑选的像素。</p>\n<p>第二个例子显示了一些深入屏幕中的多边形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/b83r9o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>6 个深入屏幕的横梁使用的是之前 6 种不同的筛选模式。</p>\n<ol>\n<li>左上使用的是 NEAREST，你会感受到明显的块状感；</li>\n<li>中上使用的是 LINEAR 也没有好到哪里去；</li>\n<li>右上使用的是 <code class="language-text">NEAREST_MIPMAP_NEAREST</code>，点击图像切换纹理，每个贴图都是不同的颜色，就可以清除的看出它使用的是哪个贴图；</li>\n<li>左下使用的是 <code class="language-text">LINEAR_MIPMAP_NEAREST</code>，意思是挑选最合适贴图种的 4 个像素进行混合，你会发现贴图切换的部分非常突兀；</li>\n<li>中下使用的是 <code class="language-text">NEAREST_MIPMAP_LINEAR</code>，也就是找到最合适的两个贴图各取一点进行混合，如果仔细看会发现仍然有块状感，尤其是水平方向；</li>\n<li>右下使用的是 <code class="language-text">LINEAR_MIPMAP_LINEAR</code>，也就是选出最合适的两个贴图各取 4 个点进行混合。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 536px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.50746268656717%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACFklEQVQoz4WSTWgTURDHZ5MYSbWpscSPJiD21IOiN0HwKl578vPgsQcpQgKpbWzTtGXbID15aA8ieBOhHlq9FC9eA2ov9SCil2iyKc2y2feR3eybvskaRCp0luHtvn3zm//MPCiC5EUQ7jQIVh4UzLYE6/iCMSZc35eiVtu3Uql9C0CKfI67iB1uWU6rDvDTe/7CbeBurWnlxOyn8urkxrubUAbEee1z2pcHEb02/mN7e4IBkCMWCv3djt/e2vSxPI/OvYfVX5gbxwk4BmQEKxlKzYJSZlIpYSuFqFTQpRXRbrF2ocCcfF4nnVPdygqiudThXxFX5YO7678BbhMH9bP++mUUSBnBinpdGtC53b6KECg9rjVzTu+VCiIpBQi4ZiTgj3VfXYuNYyb8oDJJGcGenUd0aiGUlPp6bTV4u9nUrULFTLPraJhIJLzG9Rsfz1H8NlyKhgoBrHgcgHpGwQQhGEEJrpMEKzrZ4inRWHuyfaH67e3wo4n3Z5PJrTPZ7Gb6ytXlCIHuZO73hH1Ip8EcG6MC/pZHUIIVwzYE1N8ZEPXLsBuH/1gm++bwJoHCAYQDofKpp6WIChb036dRUZ+6+OUknZ269T1iGDvG6eHPxujoWi9+ZGTjMLBvVD71lAZV0r5IwIi0Hg/tnKCz0zEbjjQpJedcuHSZ6VIvDAmmy2Ramath3kzM/jGZqg70FB6vH8k7ABn0sfdqxp2tAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 34 03" title="" data-src="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png" data-srcset="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-bb263.png 200w,\n/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-9a78f.png 400w,\n/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png 536w" data-sizes="(max-width: 536px) 100vw, 536px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想既然理论上 <code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最好的选择为什么还要有其他选择</p>\n<ol>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最慢的，读 8 个像素比读 1 个像素慢一些，在现代的 GPU 上如果一次使用一个贴图可能没什么问题，但是现在的游戏可能一次就需要 2 到 4 个贴图，4 贴图 * 8 像素每贴图 = 绘制每个像素需要读取 32 个像素，那就会慢很多了。</li>\n<li>如果想实现特定的效果，比如做一些复古的东西可能就需要使用 NEAREST。贴图也占用内存，事实上它占用额外 33% 的内存，那是非常多的内存，尤其是使用很大的纹理例如想要在游戏的标题屏幕上绘制的东西。如果你不会绘制比最大的贴图要小的东西，为什么要把内存浪费在贴图上，直接使用 NEAREST 或 LINEAR 就只使用第一个贴图。</li>\n</ol>\n<p>设置筛选器可以调用 <code class="language-text">gl.texParameter</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59419401596175930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `59419401596175930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR_MIPMAP_LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ul>\n<li><code class="language-text">TEXTURE_MIN_FILTER</code> 是当绘制的比最大贴图小的时候。</li>\n<li><code class="language-text">TEXTURE_MAG_FILTER</code> 是绘制的比最大的贴图大的时候。</li>\n<li>对于 <code class="language-text">TEXTURE_MAG_FILTER</code> 只有 NEAREST 和 LINEAR 两个可选设置。</li>\n</ul>\n<p>假设我们想使用这个纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAADaElEQVQozxVRaVcaZxh9Z4CZgRlmnMyArLLIolhlcaWIrFG2pmg8LohoNcegLUEhCG5piFZjBRPSaM7pMamk1Hh6mn7ol35p+9v6+u2e5973Pve5L5jPLLQRouiDqYNiDgCQ3cxHImEIdvaf7ZWfCgDoUClkUpIUIo3z08ZJdcSinot4cysLj772AwxFRJi4XN65P+yCb8IhX4ec5Rjm5vbTeGCsTYK/u77qULSTmPDXm98yi2moMXcaWFJCCgUgExpZnYq1Xh+HB3rMGoWckeIIMur1335qsXcLUWefjUKB3d77379/93VbxAAkJ+N6jQaDNlaeGtLLN9eWW9WN76L9xWn/esJ98WK79fal26ZzdpvUfBuGgIXUXPP6ZxGKihFA4xgpQDmGAl2WTmgxu7j8/VYWuiqlhFUm7Tdpa9WdP2qljdhAZT5UmA3evv2h+eY46LIE3E6LXsNT4k6TARjVMlpCnp+9DPbbWEqSLz7RtvMIAPXG68rWt9BXw9JWFdejUx6Vc//8cpp7MFya8RZmRo/zd/eDPufgq+eVexiqU8mXlmYVDGnU6//6fON22CgRmoiNKzkWysqlfO3kEAWAE+MqKdGlkYH7zq7dx5n97KIEw2CFKApZEInFmxd1lhDJadJu62JwISMhrq/eraZmIe3zeDzuMQLGS/sc1cdz5/n5vRnPk6Tnm5jHY7ee7G7t57MoglASEpYEizUZjJ9bzcE+OwFAPBqfmpqHnQHIcYyUI0Rzk9HfX6wtjdk2k6NXh9uXexu5+GA6NJjwDnQbtF9Fwh8uGpREiqOIRIhSQgGNCcD0w0mrTg0jZNezhZUUzEwTRHsbbVIqUrHwn2elymyoMO1/f1z6+OZkOTISG7Y5u4xGrYqjpcDvHZVRBHdPdn54MNZrpnHhRDBk0evgbYHx+M3HJs/yuEDEs5zL7kj4hurF1avt9MFStDgXBgIUFQIwOPTlWWmdF4sULJNKrXS0y+CdpUrl6NkBCpAOtcrpcIkxHOYqlJ4eVZ+zDNdrNYNgr1krl2WS8dXkBOQoAZBRJIsLeY6/uLxMzy/Aodfr3zuswf1SSvqqcZ5O3Q1JTATWJjw7D/2NR4ndaV+gR+fqtalVSvi9JrP1p/qPX/Q4oK6NZnm5EgKtwVirn3q8PoiDwcD/9JnJ+bKL33UAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 18 57" title="" data-src="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" data-srcset="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-102e5.png 200w,\n/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png 320w" data-sizes="(max-width: 320px) 100vw, 320px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ibn1oh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>为什么键盘的纹理没有出现？那是因为 WebGL 限制了纹理的维度必须是 2 的整数次幂，2 的幂有 <code class="language-text">1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048</code> 等等。<code class="language-text">F</code> 纹理是 256 × 256，256 是 2 的幂。键盘纹理是 320x240，都不是 2 的幂，所以显示纹理失败，在着色器中当 texture2D 被调用的时候由于纹理没有正确设置，就会使用颜色 <code class="language-text">(0, 0, 0, 1)</code> 也就是黑色。如果打开 JavaScript 控制台或者浏览器控制台，根据浏览器不同可能会显示不同的错误信息，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11543835971747529000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not \'texture complete\'.`, `11543835971747529000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not &#39;texture complete&#39;.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>解决这个问题只需要将包裹模式设置为 <code class="language-text">CLAMP_TO_EDGE</code> 并且通过设置过滤器为 <code class="language-text">LINEAR or NEAREST</code> 来关闭贴图映射。</p>\n<p>让我们来更新图像加载的代码解决这个问题，首先需要一个方法判断一个数是不是 2 的幂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75314834763519360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function isPowerOf2(value) {\n  return (value & (value - 1)) == 0;\n}`, `75314834763519360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我不准备深入讲解二进制运算，以及它的的原理。有了它后，就可以这样使用。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/g387je?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="6-个面"><a href="#6-%E4%B8%AA%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6 个面</h2>\n<p>一个常见的问题是 <code class="language-text">如何为立方体的每个面设置不同的图像？</code>，假设我们有 6 个这样的图片。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 396px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.1919191919192%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAEAElEQVQ4yxWRW0yTBwCF/2SOxagM5pQoq4CuoKiASpGGu2i5CBStglWGXIWyf4AKAwq0Ugad0mq1SFELTDaYiAoIiJepRLwEAph5QUFFnXFuS3zcEh+Wb+zhPJ7z5Zwj3Ou289hezHitivGqBO5q4xipFxnvsDB4UMPtGjW/95bx4bmdkZOlTDXtZ/LKj1w5+wONubuwqRQcVcdi1Ru42N2HMKZXMpi4iAn9Jh6IMkZS3BkI+oTB8h10ZocyVhDAr21h3GyR87SpmOEDCdxpKKF9exTtG32xBHmhXelK8jwH4uVyhFuaMM6XyjAX+VO1YwUm5UrawhdyIyOIF7Xx/NmZT59xI816OW+v1THRUkjH7khGNdFM/HSU232HqS+Oo3XzGso8XBCGxGC0qR4klXmSJa4gJ0aKNlxKz4zpb1sM7wYqmbxu4fFlM6+GTjFYl8aZzE3c3elPty6NoR4LHSXJNKx3x+K/DOFO6UYqIpeQlezN5q0eJKu8SVi3BL06lOFvQxipSpypupdHnbX8UpdKof9C2tKjGFP50BDogTklHnOEDIPLHMok8/8PjKRZ9jHNKg9EuROqtXPx83XimCGLXrUv9oBZjCY6ciHSGeua2RySzWXEpmPgayX1rg7YAlw4KHWkxPEjWjRpCP+8HOX9tWZedegZPVrE/RYzr4cHeHzjEk9OmnjbcYRpewW/2St5d/YwTxu/Z6znHNMvJpjobefRaRM3G0zc6+/h/t0bCMYaA9k5uewTRcpLSygoKmKbajv2Bgvvb7by7PRBnvx8hKk+Oy8Hz/HH8/uMDvbxorWRWzYr79+9Zur2df6aGmegqREhyFOCsyAgmZHcxRl1iA+m6ly6WowY4mZmSFnKXs1aNCpfCn0W0Kz0o8tawfgZC5NNBbxp2sn0CTUP6tO5pEtBSFntzWonR9YucsZ38WzyYlaxWyEnY3ssplOp5FTFUKJVkhYhJ0HqSrtGybNbfUwcT+ZDayRXLeHsS/VCFyXBmr8eoeWraJQL5pC0QcbVRh3D3SL9x9U0GTPp70rncus3bF7tScSihWwLkmKIl9JZlMW0LZZH1cHUZIURHPwloQFuKDZ4Izw0ZjBWoeZencjDNhun87cwad1B/7E8KgoisFWq0WZuIXyxK6KPhPLFs+gqzuB1r40hwx6M+4PJF/3ISfKiukCGcKE2j39H7LxpFLmYF4lJ5oLVx5G63Qq0M8TqdV9glrlR7Sehevmn6NwdqN+TjH7XVmrVCvap/SjZ4kqbKOV8gR/C8qXuhKxww56toCw+kANxq9ArZs5Iiua7wGXols3D6Ps5hS4OlPtLuFSTi+2QDrf5n5EZ6IU5I4zK9FBO7FpHdsgq/gPV0ZSNWhnZqgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 05" title="" data-src="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" data-srcset="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-2a85e.png 200w,\n/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png 396w" data-sizes="(max-width: 396px) 100vw, 396px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>脑中出现了 3 个答案</p>\n<ol>\n<li>\n<p>制作一个复杂的着色器，引用 6 个纹理，传入一些额外的顶点信息表明使用的纹理是什么。不要这样做！稍微一想就知道你要写一大堆不同的着色器应用于不同面数量的图形之类。</p>\n</li>\n<li>\n<p>绘制 6 个面代替立方体，这是常用的解决办法，不错但是只能用在简单的图形例如立方体。如果有一个包含 1000 个方形的图形就要绘制 1000 个面，会非常慢。</p>\n</li>\n<li>\n<p>我敢说，最好的方法就是将图像放在一个纹理中，然后利用纹理坐标映射不同的图像到每个面，这是很多高性能应用（读作游戏）使用的技术。例如我们将所有的图像放入这样一个纹理中</p>\n</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz2PYWJN+uCP33saOqysaV1QkzosyO9vh8PZk6rm5WRd7I7aXOczJNplZ4Lgs32drTxEfHw8DAwMjIyMDBJyam/l5jdemVv0JiSrTMnT2FJvdnO6+vEPyyvLcU93BNRXmmY12SZFWoepiC7J8hISFUDRfmOR3qdMiI87Q1FLG21b0dr/l0911J9bVPjo6eXW156wJDjO6Yu2kZcPMFNp8tbhZWEGaGWBga2fx0tLoiky1+lS5GbkK27JUz9Y53FyQs7nUpdpGuDJEoz/RIdVEPV+Zp0SCkR2sBaHZ0VCvyM+0JFxrSprehGj9eQG6a/1EN/oKzLAXnuKu2uag2mEh02Yi0emgOifDm4eLA+xsmOZ19RH78yzOlVvsSdaak+Jgpy5rLCkYYKgc6WqanxyyoKmo21GvVkO4xMWmqaGRg4MDxc+HkhS3l2quzNFdGyS2wYnbUZxPnotdW5i1IMQiO8pjSZD56eashZXBjZZyYZKCLMzMDMhgTbxicrFMfKZMjofSdHflJlOZcAOl5V35R1amzCtz2OyvfGBS4bal9fOD9FtVBdH9vDpCrNRHLjpc3sdd2kNf+EJ/4ruVVUc7cxdGm2/Js1rvrTjdXGpCqGOTLHeZkhgXBzuK5hNNvpuipCf7ixe7KpZn+yX4Wa2tDp2XbN3vKl7lorR6Yt1KP6OZlhKdtgbL2qt5eVESCQBl2rROD+pDJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 42" title="" data-src="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" data-srcset="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-7728b.png 200w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-23f96.png 400w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后为立方体的每个面设置不同的纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28471468519086000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,`, `28471468519086000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7he08e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这种将多个图像通过一个纹理提供的方法通常被叫做纹理图集，它是最好的方式，因为只需要加载一个贴图，着色器也会因为只用一个贴图而保持简单，不同于多个平面需要多次调用绘制，这样只需要调用一次绘制。</p>\n<h2 id="uvs-vs-纹理坐标"><a href="#uvs-vs-%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UVs vs. 纹理坐标</h2>\n<p>纹理坐标经常被简写为 <code class="language-text">texture coords</code>，<code class="language-text">texcoords</code> 或 UVs(发音为 Ew-Vees)，我不知道术语 UVs 是从哪来的，除了一点那就是顶点位置使用 <code class="language-text">x, y, z, w</code>，所以对于纹理坐标他们决定使用 <code class="language-text">s, t, u, v</code>，好让你清楚使用的两个类型的区别。有了这些你可能会想它应该读作 Es-Tees，因为纹理包裹的设置被叫做 <code class="language-text">TEXTURE_WRAP_S</code> 和 <code class="language-text">TEXTURE_WRAP_T</code>，但是出于某些原因我的图形相关的同事都叫它 Ew-Vees。</p>\n<p>所以现在你就知道了如果有人说 UVs 其实就是再说纹理坐标。</p>\n<h1 id="webgl-数据纹理"><a href="#webgl-%E6%95%B0%E6%8D%AE%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 数据纹理</h1>\n<p>上节中讲到了纹理的工作原理以及如何使用，我们用下载的图像创建纹理，在这篇文章中我们将直接用 JavaScript 创建数据。</p>\n<p>用 JavaScript 为纹理创建数据是比较直接的，默认情况下 WebGL1 只支持少量数据类型的纹理</p>\n<table>\n<thead>\n<tr>\n<th align="left">格式</th>\n<th align="left">数据类型</th>\n<th align="left">通道数</th>\n<th align="left">单像素字节数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">RGBA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">4</td>\n<td align="left">4</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">3</td>\n<td align="left">3</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_4_4_4_4</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_5_5_1</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_6_5</code></td>\n<td align="left">3</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE_ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">2</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n<tr>\n<td align="left">ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n</tbody>\n</table>\n<p>让我们创建一个 3×2 像素的 LUMINANCE（亮度/黑白）纹理，由于它是 LUMINANCE 纹理，所以每个像素只有一个值，在 R，G，B 通道是相同的。</p>\n<p>我们继续使用上篇文章中的例子，首先修改纹理坐标，每个面使用整个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53345143806243580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 填充立方体纹理坐标的缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1\n      // ...\n    ])\n  );\n}`, `53345143806243580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 填充立方体纹理坐标的缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后修改代码创建一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79667408093652030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// // 用 1x1 的蓝色像素填充纹理\n// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,\n//               new Uint8Array([0, 0, 255, 255]));\n\n// 用 3x2 的像素填充纹理\nconst level = 0;\nconst internalFormat = gl.LUMINANCE;\nconst width = 3;\nconst height = 2;\nconst border = 0;\nconst format = gl.LUMINANCE;\nconst type = gl.UNSIGNED_BYTE;\nconst data = new Uint8Array([128, 64, 128, 0, 192, 0]);\ngl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, data);\n\n// 设置筛选器，我们不需要使用贴图所以就不用筛选器了\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n// // 异步加载图像\n// ...`, `79667408093652030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 用 1x1 的蓝色像素填充纹理</span>\n<span class="token comment">// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,</span>\n<span class="token comment">//               new Uint8Array([0, 0, 255, 255]));</span>\n\n<span class="token comment">// 用 3x2 的像素填充纹理</span>\n<span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> internalFormat<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> border<span class="token punctuation">,</span> format<span class="token punctuation">,</span> type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置筛选器，我们不需要使用贴图所以就不用筛选器了</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 异步加载图像</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/h9ssxi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>发现不生效，查看 JavaScript 控制台看到这样的错误信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42538994406135760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request`, `42538994406135760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>结果是 WebGL 中有一种首次创建 OpenGL 后的模糊设定，计算机有时在数据为某些特定大小时速度会快一些，例如一次拷贝 2，4 或 8 个字节比一次拷贝 1 个字节要快，WebGL 默认使用 4 字节长度，所以它期望每一行数据是多个 4 字节数据（最后一行除外）。</p>\n<p>我们之前的数据每行只有 3 个字节，总共为 6 字节，但是 WebGL 试图在第一行获取 4 个字节，第二行获取 3 个字节，总共 7 个字节，所以会出现这样的报错。</p>\n<p>我们可以告诉 WebGL 一次处理 1 个字节</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85375496904053640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const alignment = 1;\ngl.pixelStorei(gl.UNPACK_ALIGNMENT, alignment);`, `85375496904053640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> alignment <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> alignment<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>有效参数为 1，2，4 和 8</p>\n<p>我觉得你可能无法计算出对齐数据和非对齐数据的速度区别，所以希望默认值是 1 而不是 4，这样这个问题就不会困扰新手，但是为了适配 OpenGL，所以要保留相同的默认设置，这样移植应用就不用改变行数，然后可以为新的应用在需要的地方设置属性为 1。</p>\n<p>有了这个设置后就能正常运行了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/25tn1o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="webgl-渲染到纹理"><a href="#webgl-%E6%B8%B2%E6%9F%93%E5%88%B0%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渲染到纹理</h1>\n<p>上篇讲到如何利用 JavaScript 向纹理提供数据，这篇文章我们会使用 WebGL 渲染内容到纹理上，这个话题在图像处理中简单讲到过，但这里将详细介绍。</p>\n<p>渲染到纹理非常简单，创建一个确定大小的纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65700275340846880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建渲染对象\nconst targetTextureWidth = 256;\nconst targetTextureHeight = 256;\nconst targetTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n{\n  // 定义 0 级的大小和格式\n  const level = 0;\n  const internalFormat = gl.RGBA;\n  const border = 0;\n  const format = gl.RGBA;\n  const type = gl.UNSIGNED_BYTE;\n  const data = null;\n  gl.texImage2D(\n    gl.TEXTURE_2D,\n    level,\n    internalFormat,\n    targetTextureWidth,\n    targetTextureHeight,\n    border,\n    format,\n    type,\n    data\n  );\n\n  // 设置筛选器，不需要使用贴图\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n}`, `65700275340846880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建渲染对象</span>\n<span class="token keyword">const</span> targetTextureWidth <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTextureHeight <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">{</span>\n  <span class="token comment">// 定义 0 级的大小和格式</span>\n  <span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n    level<span class="token punctuation">,</span>\n    internalFormat<span class="token punctuation">,</span>\n    targetTextureWidth<span class="token punctuation">,</span>\n    targetTextureHeight<span class="token punctuation">,</span>\n    border<span class="token punctuation">,</span>\n    format<span class="token punctuation">,</span>\n    type<span class="token punctuation">,</span>\n    data\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置筛选器，不需要使用贴图</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意 data 是 null，我们不需要提供数据，只需要让 WebGL 分配一个纹理。</p>\n<p>接下来创建一个帧缓冲（framebuffer），帧缓冲只是一个附件集，附件是纹理或者 renderbuffers，我们之前讲过纹理，Renderbuffers 和纹理很像但是支持纹理不支持的格式和可选项，同时不能像纹理那样直接将 renderbuffer 提供给着色器。</p>\n<p>让我们来创建一个帧缓冲并和纹理绑定</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86076902811820100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建并绑定帧缓冲\nconst fb = gl.createFramebuffer();\ngl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n// 附加纹理为第一个颜色附件\nconst attachmentPoint = gl.COLOR_ATTACHMENT0;\ngl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, targetTexture, level);`, `86076902811820100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建并绑定帧缓冲</span>\n<span class="token keyword">const</span> fb <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 附加纹理为第一个颜色附件</span>\n<span class="token keyword">const</span> attachmentPoint <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> attachmentPoint<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与纹理和缓冲相似，在创建完帧缓冲后我们需要将它绑定到 FRAMEBUFFER 绑定点，那样所有的方法都会作用到绑定的帧缓冲，无论是哪个帧缓冲。</p>\n<p>绑定帧缓冲后，每次调用 <code class="language-text">gl.clear</code>, <code class="language-text">gl.drawArrays</code> 或 <code class="language-text">gl.drawElements</code> WebGL 都会渲染到纹理上而不是画布上。</p>\n<p>将原来的渲染代码构造成一个方法，就可以调用两次，一次渲染到纹理，一次渲染到画布。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98608956252756790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawCube(aspect) {\n  // 告诉它使用的程序（着色器对）\n  gl.useProgram(program);\n\n  // 启用位置属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定到位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据\n  var size = 3; // 每次迭代需要三个单位数据\n  var type = gl.FLOAT; // 单位数据类型为 32 位浮点型\n  var normalize = false; // 不需要单位化\n  var stride = 0; // 每次迭代移动的距离\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 启用纹理坐标属性\n  gl.enableVertexAttribArray(texcoordLocation);\n\n  // 绑定纹理坐标缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n\n  // 告诉纹理坐标属性如何从 texcoordBuffer 读取数据\n  var size = 2; // 每次迭代两个单位数据\n  var type = gl.FLOAT; // 单位数据类型是 32 位浮点型\n  var normalize = false; // 不需要单位化数据\n  var stride = 0; // 每次迭代移动的数据\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(texcoordLocation, size, type, normalize, stride, offset);\n\n  // 计算投影矩阵\n\n  // var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  var projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  var cameraPosition = [0, 0, 2];\n  var up = [0, 1, 0];\n  var target = [0, 0, 0];\n\n  // 计算相机矩阵\n  var cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  // 根据相机矩阵计算视图矩阵\n  var viewMatrix = m4.inverse(cameraMatrix);\n\n  var viewProjectionMatrix = m4.multiply(projectionMatrix, viewMatrix);\n\n  var matrix = m4.xRotate(viewProjectionMatrix, modelXRotationRadians);\n  matrix = m4.yRotate(matrix, modelYRotationRadians);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制几何体\n  gl.drawArrays(gl.TRIANGLES, 0, 6 * 6);\n}`, `98608956252756790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawCube</span><span class="token punctuation">(</span><span class="token parameter">aspect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 告诉它使用的程序（着色器对）</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用位置属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定到位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要三个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型为 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的距离</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用纹理坐标属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定纹理坐标缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉纹理坐标属性如何从 texcoordBuffer 读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的数据</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n\n  <span class="token comment">// var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算相机矩阵</span>\n  <span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 根据相机矩阵计算视图矩阵</span>\n  <span class="token keyword">var</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> viewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> modelXRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> modelYRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们需要传入 aspect 计算投影矩阵，因为目标纹理的比例和画布不同。</p>\n<p>然后这样调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81199976275225230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene(time) {\n  // ...\n\n  {\n    // 通过绑定帧缓冲绘制到纹理\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n    // 使用 3×2 的纹理渲染立方体\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, targetTextureWidth, targetTextureHeight);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(0, 0, 1, 1); // clear to blue\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = targetTextureWidth / targetTextureHeight;\n    drawCube(aspect);\n  }\n\n  {\n    // 渲染到画布\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\n    // 立方体使用刚才渲染的纹理\n    gl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(1, 1, 1, 1); // clear to white\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n    drawCube(aspect);\n  }\n\n  requestAnimationFrame(drawScene);\n}`, `81199976275225230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 通过绑定帧缓冲绘制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 使用 3×2 的纹理渲染立方体</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to blue</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> targetTextureWidth <span class="token operator">/</span> targetTextureHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 渲染到画布</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 立方体使用刚才渲染的纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to white</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>drawScene<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/r4pvwu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>十分重要的是要记得调用 gl.viewport 设置要绘制的对象的大小，在这个例子中第一次渲染到纹理，所以设置视图大小覆盖纹理，第二次渲染到画布所以设置视图大小覆盖画布。</p>\n<p>同样的当我们计算投影矩阵的时候需要使用正确的比例，我花了无数个小时调试，寻找出现搞笑的渲染结果的原因，最后发现是少调用了一个 gl.viewport 或者都忘了，并使用正确的比例，由于在代码中很少直接调用 gl.bindFramebuffer 所以就容易忘掉这些。所以我把这个方法调用放在一个方法里，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9700658766584791000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bindFrambufferAndSetViewport(fb, width, height) {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n  gl.viewport(0, 0, width, height);\n}`, `9700658766584791000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bindFrambufferAndSetViewport</span><span class="token punctuation">(</span><span class="token parameter">fb<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用这个方法改变渲染对象，就不容易忘记了。</p>\n<p>还有一个需要注意的事情是我们的帧缓冲没有深度缓冲，只有纹理。这意味着没有深度检测，所以三维就不能正常体现，如果我们绘制三个立方体就会看到这样。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ybyek1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果仔细看中间的立方体，会看到 3 个垂直绘制的立方体，一个在后面，一个在中间另一个在前面，但是我们绘制的三个立方体是相同深度的，观察画布上水平方向的 3 个立方体就会发现他们是正确相交的。那是因为在帧缓冲中没有深度缓冲，但是画布有。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.25568942436412%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4UlEQVQoz2P4DwP//iExwZwfn95e29h0Y/eUR0cX/vn97cfvD2C5v//+Q5UygPhg1suf/6NPfJ1w8MHLb/9//fn5/uPHT99f3Dg2886VXd8/PV6wYW7hLOkHHzYDVYP1/4Vq/gvS/Tfr+n+G6XcZcpWl1rYErJ5g0WgTs5LbM5bHo083cEeFwGRhy4kM5WsYdt/N+fXnK8SBDH9AOv9te/GHYe1/FotglnwGhgYGqQleignmUhYMQCAW6iQ7OY1fncEghUnTn9kplWH6cd1nH09BbX78/a/isf8MvQuYHPkZvaWAGthbtNiiPEUi+IWTeC2zZZI2a9pWMuilMZhFMLk7sCRVM5y5tRaqefa1TwyFS5h74piStBkT1RmUdTWXz9dbFyAcyi0YK2C2yKxis3TdVgYVGyYGBpa4OIarl7L//gbq+8MAcvXv38v27RacOIlBmZep3IFh0S255Uu4W/UYMmUZFBk4u9z0Z0XFNzAULGLyjGaoqVb/8/ctJEogAQYy4eHb9x693QwTDvhc/L/t0vGmWRN67+/on1fRf3bbjmdXN+ztnrRLrX0j4/37O8E6/0CdDXLB378QU+Y9+PPw2z9IrP95fuvNmbXfr+78/fwWyH1/fjz/eBkcydB4BgDHYVtYhhduXQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 10 24" title="" data-src="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-fee1c.png" data-srcset="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-a67b7.png 200w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-0b187.png 400w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-fee1c.png 800w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-b1a91.png 1200w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>想要加深度缓冲就需要创建一个，然后附加到帧缓冲中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68359105225295000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个深度缓冲\nconst depthBuffer = gl.createRenderbuffer();\ngl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);\n\n// 设置深度缓冲的大小和 targetTexture 相同\ngl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, targetTextureWidth, targetTextureHeight);\ngl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer);`, `68359105225295000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个深度缓冲</span>\n<span class="token keyword">const</span> depthBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置深度缓冲的大小和 targetTexture 相同</span>\ngl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个以后的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6lvkt6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在帧缓冲附加了深度缓冲以后内部的立方体也能正确相交了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.18875502008032%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz2P4DwZ//oEAmPnvz///P398u7ip69KGput7pt/cPeXMmvpTy0o/3j0Lkv739z8MMECof/9BOq/ev1+1ZYfZni/n3v/6/P7Ww9tHr53c8fTRpQ/vnz2+sefi9Un33h9/8/Ua0C64ZpCNSx58celsY01OZMhyYVi8U235WlUXMY9sYb8gDqMm5+gdLc5Z8mbVDBHLGCpXcD58cR7iBJDNP/7+U9/+j6G5kinXgCVdn8HYRnPrUgFTNeVIRt0oBkEve60lobqVDJlLmRK6WESkGM6fXwrU9ffvb4a/IPf+ib/2n6F2DYsaD+McfQY1BnYXD46CLuF0Dp4UIetUwdJNnLWbGJzSGKVVWQLCGGZMKwBr/sPwG6T5X8+D/wxTX7DriTBHMjFU2YtPrdVcEiYcxy+YIuGwzNxvk6tuGYNaJKNHI5u7F0NBqSHY2f8Y/oA173v9n2HFN4aieIbIBIakFMUlZby9NrxZ4oqeLAz5hvwzA7njGQyzGFXcGH2LGOYfdP/z9ycowCDx8+n3/+Irf2LXbfHsSOzZsHrniztTTuyatH7OhPldMy4caD2+WK2BuXWn3K4bua9/nfj//x9KVEHjCxgH4Nj++/Hdp/MbPl3Z/v7K1v93j90/NHvP9vjP726hxTMAHENVlUPBr4gAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 11 01" title="" data-src="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png" data-srcset="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-a67b7.png 200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-0b187.png 400w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png 800w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-b1a91.png 1200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>需要特别注意的是 WebGL 只允许三种附件组合形式。根据 <a href="https://registry.khronos.org/webgl/specs/latest/1.0/#FBO_ATTACHMENTS" target="_blank" rel="nofollow noreferrer noopener">规范</a> 一定能正确运行的附件组合是：</p>\n<ul>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_ATTACHMENT</code> = <code class="language-text">DEPTH_COMPONENT16</code> renderbuffer</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_STENCIL_ATTACHMENT</code> = <code class="language-text">DEPTH_STENCIL</code> renderbuffer</li>\n</ul>\n<p>对于其他的组合就需要检查用户系统/gpu/驱动/浏览器的支持情况。要检查的话需要创建帧缓冲，附加附件，然后调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20488832678577420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);`, `20488832678577420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> status <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">checkFramebufferStatus</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果状态是 <code class="language-text">FRAMEBUFFER_COMPLETE</code> 那这种组合就能使用，反之不能使用。你就需要告诉用户他们不走运或者撤销一些方法。</p>\n<blockquote>\n<p><strong>其实 Canvas 本身就是一个纹理</strong></p>\n<p>只是一点小事，浏览器使用上方的技术实现的画布，在背后它们创建了一个颜色纹理，一个深度缓冲，一个帧缓冲，然后绑定到当前的帧缓冲，当你调用你的渲染方法时就会绘制到那个纹理上，然后再用那个纹理将画布渲染到网页中。</p>\n</blockquote>\n<h1 id="webgl-使用多个纹理"><a href="#webgl-%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 使用多个纹理</h1>\n<p>现在可能是一个合适的时机去回答“如何使用 2 个或多个纹理？”。</p>\n<p>非常简单，回到几节之前绘制一个图像的着色器，将它升级到使用两个纹理。</p>\n<p>首先改变代码加载两个图像，这其实不是 WebGL 的事情，是 HTML5 和 JavaScript 的事情，但是我也会涉及到。图像加载是异步的，可能需要适应一下。</p>\n<p>基本上有两种方式来处理图像的加载，一种是重构代码，让它在没有纹理的时候运行，当图像加载后，再更新程序。我们会在以后的文章中用到这个方法。</p>\n<p>这个例子中就等两个图像都加载完成后再开始绘制。</p>\n<p>首先修改加载单个图像的方法，非常简单，先创建一个新的 Image 对象，设置加载的 url，然后设置回调函数在图像加载完成后调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59050062452188580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImage(url, callback) {\n  var image = new Image();\n  image.src = url;\n  image.onload = callback;\n  return image;\n}`, `59050062452188580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> image<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在来创建一个方法加载一个 URL 序列，并且创建一个图像序列。首先设置 imagesToLoad 为加载图像的个数，然后为每个图像调用 loadImage，当 imagesToLoad 递减到 0 的时候说明所有图像加载完成，调用回调函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89858311195648600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImages(urls, callback) {\n  var images = [];\n  var imagesToLoad = urls.length;\n\n  // 每个图像加载完成后调用一次\n  var onImageLoad = function () {\n    --imagesToLoad;\n    // 如果所有图像都加载完成就调用回调函数\n    if (imagesToLoad == 0) {\n      callback(images);\n    }\n  };\n\n  for (var ii = 0; ii < imagesToLoad; ++ii) {\n    var image = loadImage(urls[ii], onImageLoad);\n    images.push(image);\n  }\n}`, `89858311195648600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token parameter">urls<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> imagesToLoad <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n\n  <span class="token comment">// 每个图像加载完成后调用一次</span>\n  <span class="token keyword">var</span> <span class="token function-variable function">onImageLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token operator">--</span>imagesToLoad<span class="token punctuation">;</span>\n    <span class="token comment">// 如果所有图像都加载完成就调用回调函数</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>imagesToLoad <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">callback</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> imagesToLoad<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">,</span> onImageLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    images<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后就可以像这样调用 loadImages</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24489486763831914000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function main() {\n  loadImages([\'resources/leaves.jpg\', \'resources/star.jpg\'], render);\n}`, `24489486763831914000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>接下来修改着色器使用两个纹理，在这个例子中我们将两个纹理相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81397193927414940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;fragment-shader-2d&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  // 纹理\n  uniform sampler2D u_image0;\n  uniform sampler2D u_image1;\n\n  // 从顶点着色器传入的 texCoords\n  varying vec2 v_texCoord;\n\n  void main() {\n     vec4 color0 = texture2D(u_image0, v_texCoord);\n     vec4 color1 = texture2D(u_image1, v_texCoord);\n     gl_FragColor = color0 * color1;\n  }\n</script>`, `81397193927414940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragment-shader-2d<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  <span class="token comment">// 纹理</span>\n  uniform sampler2D u_image0<span class="token punctuation">;</span>\n  uniform sampler2D u_image1<span class="token punctuation">;</span>\n\n  <span class="token comment">// 从顶点着色器传入的 texCoords</span>\n  varying vec2 v_texCoord<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vec4 color0 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image0<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     vec4 color1 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image1<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     gl_FragColor <span class="token operator">=</span> color0 <span class="token operator">*</span> color1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>需要创建两个 WebGL 纹理对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45646081911475634000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建两个纹理\nvar textures = [];\nfor (var ii = 0; ii < 2; ++ii) {\n  var texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n\n  // 设置参数以便使用任意尺的影像\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\n  // 上传图像到纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, images[ii]);\n\n  // 将纹理添加到纹理序列\n  textures.push(texture);\n}`, `45646081911475634000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建两个纹理</span>\n<span class="token keyword">var</span> textures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置参数以便使用任意尺的影像</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 上传图像到纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> images<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理添加到纹理序列</span>\n  textures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>WebGL 有一个叫做 <code class="language-text">texture units</code> 的对象，你可以把它看成是一个纹理引用的序列，你需要告诉着色器每个 sampler（取样器）使用哪一个 <code class="language-text">texture unit</code>（纹理单元）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40030492418094360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找取样器的位置\nvar u_image0Location = gl.getUniformLocation(program, \'u_image0\');\nvar u_image1Location = gl.getUniformLocation(program, \'u_image1\');\n\n// ...\n\n// 设置使用的纹理单元\ngl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `40030492418094360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找取样器的位置</span>\n<span class="token keyword">var</span> u_image0Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> u_image1Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 设置使用的纹理单元</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后将每个纹理单元绑定纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36875816158661580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置每个纹理单元对应一个纹理\ngl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `36875816158661580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置每个纹理单元对应一个纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用的两个图像像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 490px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.55102040816327%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAB80lEQVQY0wHoARf+AJpMW6F2ibVqdNJRTrI7NqJJU5lYYKBQVKNbMY9tTBwgJhUUExoZGRQWFicdH+VhM/9hJ/5gKv9gKf9jLAC1JyTKRSy9UjjKSjfPUkuqYXOyU2OoVleOXjp+YVAGCg0AAAACAgIAAABsbXV9fjrc/TrZ+T7a9D3a7z8AxykhvjEaxUIV01oo13Rgp3donVMrvGpvt5SYkoqNAQMDEhISPD08iIGHosGoAkwJHnoaIMIvHuozIv8+ALMjFcEqGeR0NOtrN9hePJ5bOnxBBqc+I8lmR4xzVgABBSgnJuTm5YF5fQ8uHwDjiAGNZwAeFgDYigP/nwCxFAi1NR7WQh/SPxzXQyK/PiSqQCesU0TBbGuVdW8FCQoAAABERUWVkY4ACBMEs/kFW3ABeLEAw/8Dsf0AskojklYcvCAPxiwU03A2xVwzkDsZck8Vs2o/l2hZBQwOAAAAHR0eu7u6XV9kDiiXAAtKGC7bGSz/HC/3ALFGGYhJD6UqB8AwFuWqT+iDPYs5CmVICZNFDJBWNwQNEQAAACMiI7u/unJfcokRgzkDN6cayNIj/ckk8QC7XkKvdD2xcjnJa0HVg0DAg2qSd2SCYj6WZjGOcVQqLjIhIB8vLS4lKigrFB7xMJD5LoX2LX//LYn/MImAGrQ0ZjSHtgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 29 11 32 39" title="" data-src="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png" data-srcset="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-ee8ca.png 200w,\n/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-15948.png 400w,\n/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png 490w" data-sizes="(max-width: 490px) 100vw, 490px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这就是使用 WebGL 将它们相乘的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/plcqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有些需要回顾的部分。</p>\n<p>理解纹理单元的简单方式是：所有的纹理方法可以在 <code class="language-text">激活的纹理单元</code> 上使用，<code class="language-text">激活的纹理单元</code> 就是一个全局变量指向你想使用的所有纹理单元，每个纹理单元有两个目标对象，<code class="language-text">TEXTURE_2D</code> 目标和 <code class="language-text">TEXTURE_CUBE_MAP</code> 目标。每个纹理方法针对激活纹理单元上的一个目标，如果用 JavaScript 表示 WebGL 方法可能像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67381987751451810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var getContext = function() {\n  var textureUnits = [\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    // ...\n   ];\n  var activeTextureUnit = 0;\n\n  var activeTexture = function(unit) {\n    // 将纹理单元枚举转换成索引\n    var index = unit - gl.TEXTURE0;\n    // 设置激活纹理单元\n    activeTextureUnit = index;\n  };\n\n  var bindTexture = function(target, texture) {\n    // 设置激活纹理单元的目标对象纹理\n    textureUnits[activeTextureUnit][target] = texture;\n  };\n\n  var texImage2D = function(target, ... args ...) {\n    // 绑定对应纹理单元调用相应的方法\n    var texture = textureUnits[activeTextureUnit][target];\n    texture.image2D(...args...);\n  };\n\n  // 返回 WebGL API\n  return {\n    activeTexture: activeTexture,\n    bindTexture: bindTexture,\n    texImage2D: texImage2D,\n  }\n};`, `67381987751451810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getContext</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> textureUnits <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// ...</span>\n   <span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> activeTextureUnit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">activeTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将纹理单元枚举转换成索引</span>\n    <span class="token keyword">var</span> index <span class="token operator">=</span> unit <span class="token operator">-</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 设置激活纹理单元</span>\n    activeTextureUnit <span class="token operator">=</span> index<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">bindTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> texture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 设置激活纹理单元的目标对象纹理</span>\n    textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">texImage2D</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> <span class="token operator">...</span> args <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 绑定对应纹理单元调用相应的方法</span>\n    <span class="token keyword">var</span> texture <span class="token operator">=</span> textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    texture<span class="token punctuation">.</span><span class="token function">image2D</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 返回 WebGL API</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    activeTexture<span class="token punctuation">:</span> activeTexture<span class="token punctuation">,</span>\n    bindTexture<span class="token punctuation">:</span> bindTexture<span class="token punctuation">,</span>\n    texImage2D<span class="token punctuation">:</span> texImage2D<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>着色器获得纹理单元</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11675076927136696000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `11675076927136696000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>需要注意的是，设置全局变量的时候使用索引代替纹理单元，但是调用 <code class="language-text">gl.activeTexture</code> 的时候你需要传递特殊的常量 <code class="language-text">gl.TEXTURE0</code>, <code class="language-text">gl.TEXTURE1</code> 之类。幸运的是这些常量是连续的，所以这些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48136604396541370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `48136604396541370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以写成这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5656792825151169000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE0 + 1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `5656792825151169000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4368762750205346300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var ii = 0; ii < 2; ++ii) {\n  gl.activeTexture(gl.TEXTURE0 + ii);\n  gl.bindTexture(gl.TEXTURE_2D, textures[ii]);\n}`, `4368762750205346300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>希望这样能够帮助你理解 WebGL 单次绘制中如何使用多个纹理。</p>\n<h1 id="webgl-纹理映射的透视纠正"><a href="#webgl-%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84%E7%9A%84%E9%80%8F%E8%A7%86%E7%BA%A0%E6%AD%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 纹理映射的透视纠正</h1>\n<p>这篇文章讲纹理映射的透视纠正，要理解它你可能需要先看看透视投影和纹理，你也需要知道可变量以及它的用处，但是我还会简短的介绍一下。</p>\n<p>在工作原理中我们讲过了可变量的工作原理，顶点着色器可以声明可变量并给它赋值，一旦顶点着色器被引用 3 次就会画一个三角形。绘制这个三角形的每个像素都会调用片断着色器获得像素颜色，在三个顶点之间的点会得到差之后的可变量。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/zi15x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [fragment-shader-anim](embedded-codesandbox://webgl-fundamental-base-concept/fragment-shader-anim?view=preview) -->\n<h2 id="矩形"><a href="#%E7%9F%A9%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矩形</h2>\n<p>回到我们的第一篇文章，在裁剪空间中绘制一个三角形，没有数学运算，只是传入裁剪空间坐标到一个简单的顶点着色器，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60352356670507870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 属性从缓冲中获取数据\nattribute vec4 a_position;\n\n// 所有的着色器都有一个 main 函数\nvoid main() {\n\n   // gl_Position 是着色器需要设置的一个特殊的变量\n   gl_Position = a_position;\n}`, `60352356670507870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 属性从缓冲中获取数据</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n\n<span class="token comment">// 所有的着色器都有一个 main 函数</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n   <span class="token comment">// gl_Position 是着色器需要设置的一个特殊的变量</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个简单的片断着色器提供固定的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46986163937369810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片断着色器没有默认的精度，\n// 中等精度是个不错的默认值\nprecision mediump float;\n\nvoid main() {\n   // gl_FragColor 是片断着色器需要设置的一个特殊变量\n   gl_FragColor = vec4(1, 0, 0.5, 1); // 返回红紫色\n}`, `46986163937369810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片断着色器没有默认的精度，</span>\n<span class="token comment">// 中等精度是个不错的默认值</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// gl_FragColor 是片断着色器需要设置的一个特殊变量</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回红紫色</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们在裁剪空间绘制两个矩形，为每个顶点传递 X, Y, Z 和 W。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83841681688257250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  -0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  -0.8,\n  0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1\n];`, `83841681688257250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/oqzsfs?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再添加一个浮点型可变量，并把它从顶点着色器直接传递到片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41050993662112870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute float a_brightness;\n\nvarying float v_brightness;\n\nvoid main() {\n   gl_Position = a_position;\n\n   // 直接传递亮度到片断着色器\n   v_brightness = a_brightness;\n}`, `41050993662112870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,4,9-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,4,9-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">float</span> a_brightness<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">   <span class="token comment">// 直接传递亮度到片断着色器</span></span><span class="gatsby-highlight-code-line">   v_brightness <span class="token operator">=</span> a_brightness<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中使用可变量设置颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32736965941270070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 顶点着色器的值插值后传入这里\nvarying float v_brightness;\n\nvoid main() {\n   gl_FragColor = vec4(v_brightness, 0, 0, 1);  // 红色\n}`, `32736965941270070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{3-4,7}"\n              >\n                <span class="gatsby-code-button-language">glsl{3-4,7}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 顶点着色器的值插值后传入这里</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>v_brightness<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 红色</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要给可变量提供数据，创建一个缓冲放入一些数据，每个顶点一个值，我们将设置左边亮度为 0，右边亮度为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32841303218828990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建缓冲并放入 12 个亮度值\nvar brightnessBuffer = gl.createBuffer();\n\n// 绑定到 ARRAY_BUFFER\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\nvar brightness = [\n  // 第一个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第一个矩形的第二个三角形\n  0,\n  1,\n  1,\n\n  // 第二个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第二个矩形的第二个三角形\n  0,\n  1,\n  1\n];\n\ngl.bufferData(gl.ARRAY_BUFFER, new Float32Array(brightness), gl.STATIC_DRAW);`, `32841303218828990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建缓冲并放入 12 个亮度值</span>\n<span class="token keyword">var</span> brightnessBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定到 ARRAY_BUFFER</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> brightness <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还需要在初始化阶段找到 <code class="language-text">a_brightness</code> 的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2536020619517143000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点数据的输入位置\nvar positionAttributeLocation = gl.getAttribLocation(program, \'a_position\');\nvar brightnessAttributeLocation = gl.getAttribLocation(program, \'a_brightness\');`, `2536020619517143000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点数据的输入位置</span>\n<span class="token keyword">var</span> positionAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> brightnessAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_brightness\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在渲染阶段设置属性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83470489812172360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 启用属性\ngl.enableVertexAttribArray(brightnessAttributeLocation);\n\n// 绑定位置缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\n// 告诉属性如何从缓冲中读取数据\nvar size = 1; // 每次迭代读取一个单位数据\nvar type = gl.FLOAT; // 数据类型是 32 位浮点型\nvar normalize = false; // 不用单位化\nvar stride = 0; // 每次迭代需要移动的距离\nvar offset = 0; // 从缓冲的起始处开始\ngl.vertexAttribPointer(brightnessAttributeLocation, size, type, normalize, stride, offset);`, `83470489812172360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 启用属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定位置缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉属性如何从缓冲中读取数据</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代读取一个单位数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 数据类型是 32 位浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不用单位化</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要移动的距离</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在渲染后得到会得到两个矩形，左边 brightness 是 0 右边是 1，中间的部分是插值（或可变量）。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cfvjcf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在透视投影的文章中我们知道 WebGL 会将放入 <code class="language-text">gl_Position</code> 的值除以 <code class="language-text">gl_Position.w</code>。</p>\n<p>在上方的顶点中我们提供的 W 值为 1，但是我们知道 WebGL 会除以 W，所以做如下修改应该结果不变。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48970957698504030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var mult = 20;\nvar positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  -0.8,\n  0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  -0.8,\n  -0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  0.8 * mult,\n  -0.8 * mult,\n  0,\n  mult\n];`, `48970957698504030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如上所示我们将第二个矩形右边的点的 X 和 Y 都乘以 mult，同时设置 W 为 mult。由于 WebGL 会除以 W 所以我们应该得到相同的结果对么？</p>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/51qz0x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意两个矩形和上一个例子位置相同，事实是 <code class="language-text">X * MULT / MULT(W)</code> 还是 X，Y 也一样，但颜色却不同，为什么？</p>\n<p>事实是 WebGL 使用 W 实现纹理映射或者可变量插值的透视投影。</p>\n<p>如果将片断着色器改成这样就更容易看出效果</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10788028739790367000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl_FragColor = vec4(fract(v_brightness * 10), 0, 0, 1); // 红色`, `10788028739790367000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span>v_brightness <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红色</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将 <code class="language-text">v_brightness</code> 乘以 10 就会是值的范围为 0 到 10，fract 会保留小数部分所以结果还是 0 到 1 之间，但是总共是 10 次 0 到 1 了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yiilg8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在应该更容易看出透视效果。</p>\n<p>线性插值应该是这样的公式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31352456671510920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = (1 - t) * a + t * b;`, `31352456671510920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> a <span class="token operator">+</span> t <span class="token operator">*</span> b<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>t 的范围是 0 到 1，表示 a 到 b 之间的位置，0 表示在 a 点，1 表示在 b 点。</p>\n<p>可变量经过 WebGL 的插值时使用这个公式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>aW 表示 a 点的 W 值，也就是 <code class="language-text">gl_Position.w</code> 的值，而不一定等于缓冲中的值， 同理 bW 是设置在 b 点的 <code class="language-text">gl_Position.w</code>。</p>\n<h2 id="正方体"><a href="#%E6%AD%A3%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正方体</h2>\n<p>为什么这个很重要？这有一个简单的纹理，使用纹理文章的例子，并调整了 UV，每个面使用整张纹理，是一个 4×4 像素的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7rjd5e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在将例子中的顶点着色器做一些修改，手工除以 W，只增加了一行代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74761169757158230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 手工除以 W\n  gl_Position /= gl_Position.w;\n\n  // 将纹理坐标传到片断着色器\n  v_texcoord = a_texcoord;\n}`, `74761169757158230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 手工除以 W</span>\n  gl_Position <span class="token operator">/</span><span class="token operator">=</span> gl_Position<span class="token punctuation">.</span>w<span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理坐标传到片断着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除以 W 意味值 <code class="language-text">gl_Position.w</code> 始终为 1，X, Y 和 Z 不会有什么影响，因为 WebGL 也会默认做除法，这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/mneucd?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我们还是得到了一个立方体，但是纹理变得扭曲了，这是因为没有传入 W WebGL 就不能正确的实现纹理的透视纠正，或者更准确地说，WebGL 就不能正确的对可变量的插值实现透视。</p>\n<p>如果你还记得的话 W 就是透视矩阵中的 Z，当 W 始终为 1 时 WebGL 做的就是一个简单的线性插值，事实上如果你拿着上述的等式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>设置所有的 W 为 1 就会得到</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">result=(1 - t) * a + t * b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">a</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">b</span></span></span></span></p>\n<p>就和上方提到的线性插值一样了。</p>\n<p>现在就清楚为什么 WebGL 要使用 4x4 的矩阵和包含 X, Y, Z 和 W 四个值的向量了吧。X 和 Y 除以 W 得到裁剪空间坐标，Z 除以 W 也得到裁剪空间的 Z 坐标，W 同时还为纹理映射的透视纠正提供了帮助。</p>\n<blockquote>\n<p><strong>二十世纪中叶的游戏机</strong></p>\n<p>一点小事，Playstation 1 和其他同一时代的游戏机都没有做纹理映射的透视纠正，根据以上的信息你就能看出为什么路面是这样的了。</p>\n</blockquote>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAECElEQVQ4y0WUSW8jdRTE23Ziu+Ml7d2O7fbSdmzH2bwmjuNxPFkmq5NRxmEmZGOYRYwEDswiEAcQQkLihOAwFyQkrtw4cIYPwYkP8+O1DZpDqdWt7vpX1avXSq3oYtGYJuVTRlg0ggxqBudpjeNGho9aPt6s5znJRjlIBki6FSJTCiGngvYf/AKPwCdQjrZ0+ls17lRzJDSFZtbH60qe14UIrxo5dotTfH+9ye3pPg/bDbIhO0u5CLN6iLJdYUm1kVOtdBzm1YKyszrPdnuB1YUUlUKUaszBpe5lkNF4mtMoRxVenRZ576RHS96tlvzs92psrlfZNsKcVEp05wt8ttVjzYiidMXe4PgulVKMTFwlE7KSDljQ/QpG2Eo+YuFhw009aSOkKqQllohLIeAQqy4LvikrEbeVgNeGf0oU3uTj9Gaj9KIqA7+dOSFKBy0YgqwgHVDYm1c5WvQQEMK410JQrAWdllGOQSEOyvOY20JSs6IclBK0CzEOmwXOagWykmM2NCYzkZIDqqJuvzxFfNpCQmAqDYuaoAwn5rHS1J1UEg4Mvw2lnw3xMCm5COl8MTwiMIkywXekOTmgk3eM7ZoTFsKgqJsNTVKK2kfqImLfL8NROksp1kpieTnFnUp6VB1DcjRJDIEulqPTCnPxSfIJjZDbRjlmZz3v5HzFw2nVRS5g486sk/s1D4qujfsX88rJErapzBxIWO5nhKgyY2MjM8lKysFGNStNiLBZcrEza6ehT7CSsfOo4+dBS+NUoCT9kol8nA/a6Oh20nK/ELHxxZqXn3Z9vGx52MxOsr/g5ajsFCIHW6Jmu6iykXPQNSbZK6uCKe6VVJRm3M6w7uaPszB/P53h90GYnw8DvGy76QqROdmm4eG6HeJ4XmzWPezPOdktOTleULlohRjUNQ6qbo4XXSh/nmn88yLOb2dBvt2a5nXHw/yMFZ9rvEo5UX57mKSZltyydrYLY5Vdw8njwxWGl9t82m8wzLjZLDpRfvlkk73iBLnwODeTKCr7qks9wjLR4YHOs7th2ukJ9kXVodg7mrPzvL/Mh/0mO2WN82acvzQvn0u2SqNVJz76MVhGJAkpri4F1WRPB6sRfriZo5uZELsq5zU3l00v1ytevrre4HE3wUCsnt5N87aS4+uEKCwbM1JWcwPGW/B/cZeTTn4d1hnuJNiQLHfF6pUQPVvXeL7m4ZubHrf9IsPjDDedJCeSZc8cSjmfYsYzJjTVxUy7ovDHJ4u86etspG30Jfz3ZXAftKa5Wp3msuHixT2D7z4+YO8iS+8kzpNBncMFB0pCs71TJwhJbi+Psnx5P8OabpPMnAyWVM4qLiH1jnDR8PJoWeX2IM/VVpgHbR/na7K+0oJ/AeLI7QPA18vhAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 44" title="" data-src="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png" data-srcset="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-1777c.png 200w,\n/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-1db89.png 400w,\n/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAEW0lEQVQ4y02T+0/TVxjGv/GnXTKzLTFbpqJGGZVLlYEB5U7LpbRcLNIhYikIvdEbQkEolAoFWgpykYsoUMS5LQY102nUHxxbjJoZY6ZkWzTbD8v2DyzZkv1gPjstuuwkT875vuc8z/u87zlfSdvmQF5vxjsd4Ien9/CHFlDnNqLdW0limpV3dpjoqKzGrsilSr4HeXIqNUfrMLS4OOxyMT5zhkSFBynGxoaddqSBARMObzcdISfhz0e5NNbFlVAdl4LHcTmcvL/XTW2VgRaDHof+CCqVGrPFgm8ogN3QiLNBT+1hF/s+rOKD7U1I88MBFiaHGDjuYGwgxNm5C8xNBAjPjHLlwhjnTozQ3tRKrbkFrU5PeUUFZqsVj3+I/s4e+jwn0Na0sWOznvdENdJksJ9lXy+jTisn3Q58ThsjXe1MBQZYmF1kZXyJa+MznJouoqy6kCxlGQZDA75gkGavF09oEJ3Zj7TdwRsyF9Jlm5Fws5HTRz7lrLaUqTYTg/ZjDLnM+B0GQt42hn3duI8bsbbpMTir0Dc04RseodsfYHhshBpzPxu2NSNttSDlxMUSnprl8e3b3FpY4ML4BGd8HQQ9btGGVvqsevqbG/BbLfRabKICI51WE27Rd7u3l+7gIGWGHjYluzF1LiLtfvMtVnp7+fOP33nx7Clr167x65Mn/LT2jAd37vDt6irXv7rK+cV5wrMTzAX6mDxhI9juYrjfx6nTIxy2DOIdvUpgtAfp3Y0bubi0xF8vX3JvcIhzb7zNpQQ5j8R6tbWNB11d3LVYeTwxyUOBx8th3A4bavGMDNpyjPV6Onq8uD0e1JX5SGIwOzPDP8B3fX6+n55j7foNrqtKWG3v4KI8mRviEm7qDdzt7OJpKIRNrFvcbnw+H9U6HeryLApKs0krVKwLzs3O8rcQvON08XB8kuf37/PlxzK+zszmZlExz1cus7awyKrNzo9T09hMZtKzhEhJKQeUhWSXaUjKLSI2s2BdcElcRmT8LIi/fLPKb89f8Oj8MrcmT/PF/CLz4WVOBkcwWJziAowkF2rYmpzOjvRc9io1QkjJ5kwF8UI0Ktjl6+OzlSv0Tkxj9/mptjpR1DWRpqtFpihhc2omH32yny0pGWwV8870HORKtXh/dupa2jlab8GQkklcvgqpov4YsVlKtqXlRAkx+7KIEQIxKQfYLrBLxOMy84nPKSQhr5gkhRqZcHKw3kRlg5nEgjKy1Ie4uWkLlcn7kfI0pcTnqcQPXhLNGrG9SziIy1CwW4jEC5GE/BIBVfTcbrEfQZWxmTTNIVKLikitrqVfnDElpCDtych5RRKE3PU5giTRm9cCkSTRMwKRORLTmZwUVNegrtWSUapDXnYQmTAkpeTkR4kJEZcRJ3mqKOl1kihexdZdFhOXXUBGhY7GVieJpmJijyrRNNZH96QEkS1SbgT/J//3nb/eDll24XpCgci+TLQjo1xHklqNvFRDuroymuhfJf3i+UrsKnIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 59" title="" data-src="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png" data-srcset="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-1777c.png 200w,\n/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-1db89.png 400w,\n/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="webgl-平面的和透视的投影映射"><a href="#webgl-%E5%B9%B3%E9%9D%A2%E7%9A%84%E5%92%8C%E9%80%8F%E8%A7%86%E7%9A%84%E6%8A%95%E5%BD%B1%E6%98%A0%E5%B0%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 平面的和透视的投影映射</h1>\n<p>投影映射是投影一张图像的过程，就像一个电影放映机对准一个屏幕，然后将电影投影到屏幕上。电影放映机投影的是一个透视的平面。屏幕离放映机越远，则图像就会越大。如果你将屏幕旋转使其不与电影放映机垂直，那么结果将会是一个梯形或者是任意的四边形。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQ4y2M42HiTcVLiEnYGBgZGBmqAdSVH5BflbCsAMjmMlSy5gTQLRQauKNirvLJwfxGIHWIRB3IpFxCDDOYEYmaSDVxddEBxWf6uYhC7yKeBFUmKBWo4CHOgG954cztDwZ55jEUHFjEU7pvPUrB3AWvBvgWMDGtLDisuzt1eCjJAX96UF+o6EGaDhisz1HBOqOFsgjIScMML9sxnRPey0qrC/YUg9v9z/5mghoBodqjBXFDDQK5kZWZlAbs4d8ds7sJ9C1RA+oAurAC6sBXoQi2GlYX7lICGgsOwOXwyrggBiYOCg4uDj4cHxM/eMl0YaOC9gr3zkwv3zv/bcGPbf6Ch0cBYhnuZTU/eBNnLIMyDFEFgV3ILC4DppKXdPEAD/5QdWw40aP47oOv+AQ0MQnFhQ9gEVhwuhIUjO9yFW2dgdyEoDFfCwvDBf0akiGBFC0MwBoYhiObO2DCFp3A/ljCExPIOcCyjeZkDajgs/GCxzC6qLMeEiOV5jDjTYY5HJSuaN5ETOQsjE0JvaH8lQ8ycZiZgbANduACYDudD0uHygj3Kq4ogOSXBIYcN2SVE529GJGXrSxF5WVfOmBfqMhBtCMRGQGwKxBZArAvE6kBsDMSWUHEdaJpFgEs9bxg7omeyoxUKrNAkwwM1HJawuaF8fiifA92xAE2frjDrTavnAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 13 45 50" title="" data-src="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png" data-srcset="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png 200w" data-sizes="(max-width: 200px) 100vw, 200px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当然，投影映射并不只能投影到平面。还有圆柱型的投影映射、球形的投影映射，等等。</p>\n<p>我们先来介绍下平面的投影映射。在这种情况下，你需要将电影放映机想象成和屏幕一样大，这样即使屏幕离电影放映机很远，电影的图像也不会变得很大，它会保持原来的尺寸。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 176px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.22727272727273%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACXklEQVQ4y62UzWsTURTF35uZzEwyySRp2mprk4UudFFEikV071qoO5GWggWRmsykNlXcKKKCGxXcKZlQ+5lIBQVR20zTktqC4MZN3emitf4DCn4wnjtJYyAdY8GBH/fO4+XMufe9GzZx8SV/MrLsY7t8bm8s1XLDtkJAN4qWjxXSpc7J5OtzWI9FtVadMR5E7omkyBTVofzdiGnnrqSKVtSwc2UIfoXgaTZjFBOzhm3Ql0rX1nkzZ5bzyY0QU8yi9Q1iK2Dz6rs5xyjmBlg+XYpPpeaT9NV9LYkA51yl3AtVD/oR5cGJOypEN8fWZh3Ttn6OlichaPWzvLmYmDYWUrTpwJ6DqsAFmXIvtNYIRXGocI8Et9KlcQcOv2feTJPD/krJpk0OmeM4/3woI8uPFTj6gkiCP0jQJIckCFzBpesfmvYw63ys9XBHwUKlh1RySyzYpvMmpywH1BBi4OzDG34quUEQ5dYcjp26KUS12F8dnhjsc6tIzWcVCO5c8n/tITnEKZMg7473yAIXJeSehDvbaaqE808fuA4bTjn/p4ehdr0jiB4GqEdeKFpAo/s4kLtF12YjszpDzn6NrkxV7mF9ybt5cJFlozIp6+Dz5bcFCLsOF8nhMPZoeyNdGhz66ybDX6U2KXBI72JqIRuGw/uY5QQE32dWqWTrDHuWWROtC891EvSJMk2Br05se0LoXalDPtJ3svYPBaE42A80r4oOg6OgBxwDx8Eh0A16q+u9kuzravjl3KUyGx9+4eYhVd9eFukkqwfhr7oW69xKgiRJ4Y422sOSrx5xuCPYb+P6MUJdLQ/8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 15 05 08" title="" data-src="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png" data-srcset="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png 176w" data-sizes="(max-width: 176px) 100vw, 176px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先，让我们创建一个场景，该场景会绘制一个平面和一个球体。我们将用一个简单的 8x8 棋盘纹理对它们进行贴图。</p>\n<p>这些着色器和纹理文章中的那些着色器是类似的，只是各个矩阵是分开的，这样我们就不需要在 JavaScript 中把它们乘在一起了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72912624103996326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点着色器\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  gl_Position = u_projection * u_view * u_world * a_position;\n\n  // 把纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n}`, `72912624103996326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 顶点着色器</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 把纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，我还添加了一个 <code class="language-text">u_colorMult</code> uniform 来乘以纹理颜色。这样我们就可以通过制作一个单色纹理（monochrome texture）来改变它的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98164212700133790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片段着色器\nprecision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `98164212700133790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片段着色器</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是设置程序、球体 buffers 和平面 buffers 的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49115005246665500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\n// 编译着色器、链接程序、查找 locations\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\n\nconst sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽\n  20, // 高\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);`, `49115005246665500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token comment">// 编译着色器、链接程序、查找 locations</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和创建一个 8x8 棋盘纹理的代码，使用了我们在数据纹理文章中介绍过的技术。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70971033850057120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 8x8 棋盘纹理\nconst checkerboardTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, checkerboardTexture);\ngl.texImage2D(\n  gl.TEXTURE_2D,\n  0, // mip level\n  gl.LUMINANCE, // internal format\n  8, // width\n  8, // height\n  0, // border\n  gl.LUMINANCE, // format\n  gl.UNSIGNED_BYTE, // type\n  new Uint8Array([\n    // data\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff\n  ])\n);\ngl.generateMipmap(gl.TEXTURE_2D);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `70971033850057120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 8x8 棋盘纹理</span>\n<span class="token keyword">const</span> checkerboardTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> checkerboardTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip level</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// internal format</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// width</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// height</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// border</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// format</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// type</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token comment">// data</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了绘制，我们将会创建一个函数，该函数需要一个投影矩阵和一个相机矩阵作为参数，以便从相机矩阵中计算出视图矩阵，然后绘制球体和立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51286080863711600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 每个物体的 uniforms\nconst planeUniforms = {\n  u_colorMult: [0.5, 0.5, 1, 1], // 浅蓝色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(0, 0, 0)\n};\n\nconst sphereUniforms = {\n  u_colorMult: [1, 0.5, 0.5, 1], // 粉红色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(2, 3, 4)\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中计算出视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  gl.useProgram(textureProgramInfo.program);\n\n  // 设置球体和平面共享的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix\n  });\n\n  // ------ 绘制球体 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, sphereBufferInfo);\n\n  // 设置球体特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, sphereUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, sphereBufferInfo);\n\n  // ------ 绘制平面 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, planeBufferInfo);\n\n  // 设置平面特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, planeUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, planeBufferInfo);\n}`, `51286080863711600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 每个物体的 uniforms</span>\n<span class="token keyword">const</span> planeUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 浅蓝色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 粉红色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中计算出视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体和平面共享的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制球体 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> sphereUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制平面 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置平面特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> planeUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以在一个 render 函数中使用这份代码，就像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68930531734328480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5\n};\n\nconst fieldOfViewRadians = degToRad(60);\n\nfunction render() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间转换为像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  gl.enable(gl.CULL_FACE);\n  gl.enable(gl.DEPTH_TEST);\n\n  // 清除 canvas 和深度缓冲区\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n  // 计算投影矩阵\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  // 使用 look at 计算相机的矩阵\n  const cameraPosition = [settings.cameraX, settings.cameraY, 7];\n  const target = [0, 0, 0];\n  const up = [0, 1, 0];\n  const cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  drawScene(projectionMatrix, cameraMatrix);\n}\n\nrender();`, `68930531734328480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间转换为像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清除 canvas 和深度缓冲区</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 look at 计算相机的矩阵</span>\n  <span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>cameraX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>cameraY<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">drawScene</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，现在我们有了一个简单的场景，场景内有一个平面和一个球体。我添加了一对滑块来让你改变相机的位置，以便你理解该场景。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7gmu66?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在，让我们使用平面投影的方式将一个纹理投影到该球体和平面上。</p>\n<p>首先要做的是，加载一个纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12133273039031112000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImageTexture(url) {\n  // 创建一个纹理\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  // 用一个 1x1 蓝色像素填充该纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n  // 异步加载一张图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 现在图片加载完了，把它拷贝到纹理中\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // 假设该纹理的宽高是 2 的整次幂\n    gl.generateMipmap(gl.TEXTURE_2D);\n    render();\n  });\n  return texture;\n}\n\nconst imageTexture = loadImageTexture(\'resources/f-texture.png\');`, `12133273039031112000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建一个纹理</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 用一个 1x1 蓝色像素填充该纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载一张图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 现在图片加载完了，把它拷贝到纹理中</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 假设该纹理的宽高是 2 的整次幂</span>\n    gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> imageTexture <span class="token operator">=</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>回想一下可视化相机的文章。我们创建了一个 -1 到 +1 的立方体，然后把它绘制出来表示相机的视椎体。我们的矩阵使得视椎体内的空间表示的是世界空间中一些锥体形状的区域，这些区域从世界空间中被转换到了 -1 到 +1 的裁剪空间。我们可以在这里做类似的事。</p>\n<p>让我们来试试吧。首先，在我们的片段着色器中，我们会在 0.0 到 1.0 之间的纹理坐标上绘制投影的纹理。而在这个范围外的纹理坐标，我们将会使用棋盘纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85839073051283690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\nuniform sampler2D u_projectedTexture;\n\nvoid main() {\n  // gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n  // 除以 w 得到正确的值，详见透视投影的文章\n  vec3 projectedTexcoord = v_projectedTexcoord.xyz / v_projectedTexcoord.w;\n\n  bool inRange =\n      projectedTexcoord.x >= 0.0 &&\n      projectedTexcoord.x <= 1.0 &&\n      projectedTexcoord.y >= 0.0 &&\n      projectedTexcoord.y <= 1.0;\n\n  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);\n}`, `85839073051283690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,9,12-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,9,12-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_projectedTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以 w 得到正确的值，详见透视投影的文章</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> projectedTexcoord <span class="token operator">=</span> v_projectedTexcoord<span class="token punctuation">.</span>xyz <span class="token operator">/</span> v_projectedTexcoord<span class="token punctuation">.</span>w<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">bool</span> inRange <span class="token operator">=</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;=</span> <span class="token number">1.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> <span class="token number">1.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了计算投影的纹理坐标，我们会创建一个矩阵，该矩阵表示 3D 空间中一个确切方向的方位和位置，就像可视化相机文章中的相机那样。然后我们会通过那个 3D 空间投影球体顶点和平面顶点的世界坐标。使用我们刚刚写的代码，那些位于 0 到 1 的投影纹理坐标就会显示该投影纹理。</p>\n<p>让我们添加代码到顶点着色器，通过该空间投影球体和平面的世界坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54267818299158320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nvoid main() {\n  vec4 worldPosition = u_world * a_position;\n\n  // gl_Position = u_projection * u_view * u_world * a_position;\n  gl_Position = u_projection * u_view * worldPosition;\n\n  // 将纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n\n  v_projectedTexcoord = u_textureMatrix * worldPosition;\n}`, `54267818299158320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{7,10,13,15-16,21}"\n              >\n                <span class="gatsby-code-button-language">glsl{7,10,13,15-16,21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> worldPosition <span class="token operator">=</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_Position = u_projection * u_view * u_world * a_position;</span></span><span class="gatsby-highlight-code-line">  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span>\n  <span class="token comment">// 将纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  v_projectedTexcoord <span class="token operator">=</span> u_textureMatrix <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，剩下要做的就是计算定义了该方位空间的矩阵。我们要做的就是计算出一个世界矩阵，就像我们对其他物体做的那样，然后取它的逆矩阵。这样我们就得到了一个矩阵，该矩阵可以让我们将其他物体的世界坐标转换为相对于该空间的坐标。这和相机文章中的视图矩阵做的事情是完全一样的。</p>\n<p>我们会使用创建的 lookAt 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15992350221550256000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // 设置对球体和平面都一样的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_textureMatrix: textureMatrix,\n    u_projectedTexture: imageTexture\n  });\n\n  // ...\n}`, `15992350221550256000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-9,31-32}"\n              >\n                <span class="gatsby-code-button-language">js{4-9,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置对球体和平面都一样的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    u_textureMatrix<span class="token punctuation">:</span> textureMatrix<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    u_projectedTexture<span class="token punctuation">:</span> imageTexture</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，你不一定要用 lookAt。你可以任选一种方法来创建一个世界矩阵，例如使用一个场景图或矩阵栈。</p>\n<p>在我们运行之前，让我们添加一些缩放比例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78344293256765370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7,\n  projWidth: 2,\n  projHeight: 2\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // ...\n}`, `78344293256765370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-11,23}"\n              >\n                <span class="gatsby-code-button-language">js{10-11,23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  projWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  projHeight<span class="token punctuation">:</span> <span class="token number">2</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projWidth<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样我们就得到了一个投影的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/k0k2q1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>但我觉得这样很难看到该纹理所处的空间。让我们添加一个线框立方体来帮助可视化。</p>\n<p>首先，我们需要一个单独的着色器集合。这些着色器只能绘制纯色，没有纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2595498131542184400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;color-vertex-shader&quot; type=&quot;x-shader/x-vertex&quot;>\n  attribute vec4 a_position;\n\n  uniform mat4 u_projection;\n  uniform mat4 u_view;\n  uniform mat4 u_world;\n\n  void main() {\n    // 将 position 乘以矩阵\n    gl_Position = u_projection * u_view * u_world * a_position;\n  }\n</script>\n\n<script id=&quot;color-fragment-shader&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  uniform vec4 u_color;\n  void main() {\n    gl_FragColor = u_color;\n  }\n</script>`, `2595498131542184400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-vertex-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  attribute vec4 a_position<span class="token punctuation">;</span>\n\n  uniform mat4 u_projection<span class="token punctuation">;</span>\n  uniform mat4 u_view<span class="token punctuation">;</span>\n  uniform mat4 u_world<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将 position 乘以矩阵</span>\n    gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-fragment-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  uniform vec4 u_color<span class="token punctuation">;</span>\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们还需要编译和链接这些着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96388200837961710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\nconst colorProgramInfo = webglUtils.createProgramInfo(gl, [\'color-vertex-shader\', \'color-fragment-shader\']);`, `96388200837961710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> colorProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'color-vertex-shader\'</span><span class="token punctuation">,</span> <span class="token string">\'color-fragment-shader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要一些数据来绘制线框立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38427560617453740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽度\n  20, // 高度\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);\n\nconst cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [0, 0, -1, 1, 0, -1, 0, 1, -1, 1, 1, -1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `38427560617453740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-19}"\n              >\n                <span class="gatsby-code-button-language">js{16-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，为了匹配纹理坐标，该立方体在 X 轴和 Y 轴上的范围是 0 到 1。而在 Z 轴上，它的范围是 -1 到 1。这样我们缩放它的时候就能使其在两个方向上都拉伸了。</p>\n<p>要使用该立方体的话，我们只需要使用之前的 textureWorldMatrix 就可以了，因为我们要做的是绘制表示那个空间的立方体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49059259205552630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawScene(projectionMatrix, cameraMatrix) {\n  //...\n  // ------ 绘制立方体 ------\n\n  gl.useProgram(colorProgramInfo.program);\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, colorProgramInfo, cubeLinesBufferInfo);\n\n  // 在 Z 轴上缩放该立方体，\n  // 以便表示该纹理是被投影到无限远的。\n  const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n  // 设置我们计算出来的 unifroms\n  webglUtils.setUniforms(colorProgramInfo, {\n    u_color: [0, 0, 0, 1],\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_world: mat\n  });\n\n  // 调用 gl.drawArrays 或者 gl.drawElements\n  webglUtils.drawBufferInfo(gl, cubeLinesBufferInfo, gl.LINES);\n}`, `49059259205552630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//...</span>\n  <span class="token comment">// ------ 绘制立方体 ------</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> colorProgramInfo<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 在 Z 轴上缩放该立方体，</span>\n  <span class="token comment">// 以便表示该纹理是被投影到无限远的。</span>\n  <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置我们计算出来的 unifroms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n    u_world<span class="token punctuation">:</span> mat\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或者 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，现在我们可以更加容易地看到投影位于哪里了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7n5fyf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有一点需要注意的是，我们并没有真正地投影该纹理。我们在做的是相反的事情。即对被渲染物体的每一个像素，我们判断纹理的哪一部分是被投影到该像素上的，然后再查找该部分纹理上的颜色。</p>\n<p>既然我们在上面提到了电影放映机，那么我们如何模拟一台电影放映机呢？我们只需要简单地使用一个投影矩阵来乘以它（即上面的纹理矩阵）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36422667119654605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 2.5,\n  posY: 4.8,\n  posZ: 4.3,\n  targetX: 2.5,\n  targetY: 0,\n  targetZ: 3.5,\n  projWidth: 1,\n  projHeight: 1,\n  perspective: true,\n  fieldOfView: 45\n};\n\n// ...\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  const textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  // textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  const textureProjectionMatrix = settings.perspective\n    ? m4.perspective(\n        degToRad(settings.fieldOfView),\n        settings.projWidth / settings.projHeight,\n        0.1, // near\n        200\n      ) // far\n    : m4.orthographic(\n        -settings.projWidth / 2, // left\n        settings.projWidth / 2, // right\n        -settings.projHeight / 2, // bottom\n        settings.projHeight / 2, // top\n        0.1, // near\n        200\n      ); // far\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  // const textureMatrix = m4.inverse(textureWorldMatrix);\n  const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n}`, `36422667119654605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-13,27,29-43,48-49}"\n              >\n                <span class="gatsby-code-button-language">js{12-13,27,29-43,48-49}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.8</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.3</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  projWidth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  projHeight<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  perspective<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  fieldOfView<span class="token punctuation">:</span> <span class="token number">45</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective</span><span class="gatsby-highlight-code-line">    <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token comment">// far</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// const textureMatrix = m4.inverse(textureWorldMatrix);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，我添加了一个选项，可以选择是使用透视投影矩阵还是使用正交投影矩阵。</p>\n<p>在绘制线框的时候我们也需要使用那个投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50601489924654370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ------ 绘制立方体 ------\n\n// ...\n\n// // 在 Z 轴上缩放该立方体，\n// // 以便表示该纹理是被投影到无限远的。\n// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n// 调整立方体使其匹配该投影\nconst mat = m4.multiply(textureWorldMatrix, m4.inverse(textureProjectionMatrix));`, `50601489924654370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ------ 绘制立方体 ------</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 在 Z 轴上缩放该立方体，</span>\n<span class="token comment">// // 以便表示该纹理是被投影到无限远的。</span>\n<span class="token comment">// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);</span>\n\n<span class="token comment">// 调整立方体使其匹配该投影</span>\n<span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，我们就得到了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1co2ct?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>它已经正常工作了，但我们的投影和我们的线框立方体都只是使用了 0 到 1 的空间，所以它只使用到了投影视椎体的 1/4。</p>\n<p>要修复这个问题，首先让我们的立方体在所有方向上都是 -1 到 +1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94013276282322140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [\n    //   0,  0, -1,\n    //   1,  0, -1,\n    //   0,  1, -1,\n    //   1,  1, -1,\n    //   0,  0,  1,\n    //   1,  0,  1,\n    //   0,  1,  1,\n    //   1,  1,  1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    1,\n    1,\n    1\n  ],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `94013276282322140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-34}"\n              >\n                <span class="gatsby-code-button-language">js{3-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span></span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当将其用于纹理矩阵时，我们需要使视椎体内的空间范围是 0 到 1。这可以通过使空间偏移 0.5 然后将其缩放 0.5 倍来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23317847752849486000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textureWorldMatrix = m4.lookAt(\n  [settings.posX, settings.posY, settings.posZ], // position\n  [settings.targetX, settings.targetY, settings.targetZ], // target\n  [0, 1, 0] // up\n);\n\nconst textureProjectionMatrix = settings.perspective\n  ? m4.perspective(\n      degToRad(settings.fieldOfView),\n      settings.projWidth / settings.projHeight,\n      0.1, // near\n      200\n    ) // far\n  : m4.orthographic(\n      -settings.projWidth / 2, // left\n      settings.projWidth / 2, // right\n      -settings.projHeight / 2, // bottom\n      settings.projHeight / 2, // top\n      0.1, // near\n      200\n    ); // far\n\n// // 使用这个世界矩阵的逆矩阵来创建\n// // 一个矩阵，该矩阵会变换其他世界坐标\n// // 为相对于这个空间的坐标。\n// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n\nlet textureMatrix = m4.identity();\ntextureMatrix = m4.translate(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.scale(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.multiply(textureMatrix, textureProjectionMatrix);\n// 使用这个世界矩阵的逆矩阵来创建\n// 一个矩阵，该矩阵会变换其他世界坐标\n// 为相对于这个空间的坐标。\ntextureMatrix = m4.multiply(textureMatrix, m4.inverse(textureWorldMatrix));`, `23317847752849486000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{23-26,28-35}"\n              >\n                <span class="gatsby-code-button-language">js{23-26,28-35}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective\n  <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>\n      <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span> <span class="token comment">// far</span>\n  <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span>\n      settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// // 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">let</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，它看起来可以正常工作了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1b2dir?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>那么，平面投影一个纹理有什么作用呢？</p>\n<ol>\n<li>\n<p>因为你想要这么做，大多数 3D 建模软件都提供了一种将一个纹理进行平面投影的方法。</p>\n</li>\n<li>\n<p>另一个作用是贴花（decal）。贴花是一种在物体表面上放置溅射的油漆或爆炸痕迹的方式。要实现贴花，通常不会使用上面着色器的那种做法。相反，你需要写一些函数来遍历需要应用贴花的模型的几何。对于每一个三角形，你需要检查该三角形是否位于该贴花的范围内，这与 JavaScript 的着色器例子中的 inRange 检查一样。对于在贴花范围内的每个三角形，你把该三角形和投影的纹理坐标添加到某个新的几何中。然后你把该贴花添加到你的绘制列表中。</p>\n<p>为贴花生成几何是对的，否则你就需要为 2 个贴花、3 个贴、4 个贴花等等提供不同的着色器，然后你的着色器很快就会变得很复杂，并达到 GPUs 着色器的纹理限制。</p>\n</li>\n<li>\n<p>还有另一个作用是模拟真实世界的投影映射。你对一个物体进行了 3D 建模，你将会把视频投影到该模型上，你使用了类似上面那样的代码来实现投影，除了你的纹理是视频外。然后你可以编辑并完善该视频，使其匹配该模型，而不用在实际现场中使用一个真正的投影仪。</p>\n</li>\n<li>\n<p>这种投影的另一个用处就是用阴影映射来计算阴影。</p>\n</li>\n</ol>\n<h2 id="在条件语句内的纹理引用"><a href="#%E5%9C%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E5%86%85%E7%9A%84%E7%BA%B9%E7%90%86%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在条件语句内的纹理引用</h2>\n<p>在上面的片段着色器中，在所有的情况下我们都对两个纹理进行了读取</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2280823334082371300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);`, `2280823334082371300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么我们不像下面这样做呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92177961730565830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (inRange) {\n   gl_FragColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n} else {\n   gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `92177961730565830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>摘自 <a href="https://www.khronos.org/files/opengles_shading_language.pdf" target="_blank" rel="nofollow noreferrer noopener">GLSL ES 1.0 spec Appendix A, Section 6</a></p>\n<p>Texture Accesses</p>\n<p>Accessing mip-mapped textures within the body of a non-uniform conditional block gives an undefined value. A non-uniform conditional block is a block whose execution cannot be determined at compile time.</p>\n<p>换句话说，如果我们要使用 mip-mapped 的纹理，那我们就必须确保总是能够访问到它们。我们可以在条件语句内使用访问纹理的结果。例如我们可以写成这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29753309932778560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\nif (inRange) {\n   gl_FragColor = projectedTexColor;\n} else {\n   gl_FragColor = texColor;\n}`, `29753309932778560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> projectedTexColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> texColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79539517738331320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\ngl_FragColor = inRange ? projectedTexColor : texColor;`, `79539517738331320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> inRange <span class="token operator">?</span> projectedTexColor <span class="token punctuation">:</span> texColor<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是我们不能在条件语句内访问 mip-mapped 的纹理本身。这样做在你的 GPU 上可能是可行的，但并不是在所有的 GPUs 上都能行。注意，规范没有说明能否在条件语句内访问 non-mipmapped 的纹理，所以，如果你确定你的纹理是 non-mipmapped 的，那就没什么问题。</p>\n<p>无论如何，重要的是你要知道有这么个东西</p>\n<p>至于我为什么使用 mix 而不使用基于 inRange 的三元运算符，则只是一个个人喜好。mix 更加灵活，所以我通常这样写。</p>\n<h1 id="webgl-渐变纹理"><a href="#webgl-%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渐变纹理</h1>\n<p>WebGL 中的一个重要认识是纹理不仅仅是直接应用于三角形的东西，正如我们在纹理文章中所介绍的那样。纹理是随机访问数据的数组，通常是二维数据数组。因此，使用随机访问数据数组的任何解决方案都是我们可以使用纹理的地方。</p>\n<p>在关于定向光的文章中，我们介绍了如何使用点积来计算 2 个向量之间的角度。在那里 ​ 我们计算了光的方向与模型表面法线的点积，这提供了 2 个向量之间角度的余弦值。余弦是从 -1 到 +1 的值，我们将其用作颜色的直接乘数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25132343219845990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float light = dot(normal, u_reverseLightDirection);\n\ngl_FragColor = u_color;\ngl_FragColor.rgb *= light;`, `25132343219845990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\ngl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这会使颜色变暗，使其远离光线。</p>\n<p>如果我们不直接使用该点积，而是使用它从一维纹理中查找值，该怎么办？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55965934650580480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  // float light = dot(normal, u_reverseLightDirection);\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 创建一个纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 从一维纹理中查找一个值\n  vec4 rampColor = texture2D(u_ramp, uv);\n\n  gl_FragColor = u_color;\n  // gl_FragColor.rgb *= light;\n  gl_FragColor *= rampColor;\n}`, `55965934650580480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8,16-26,29-30}"\n              >\n                <span class="gatsby-code-button-language">glsl{8,16-26,29-30}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// float light = dot(normal, u_reverseLightDirection);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 创建一个纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从一维纹理中查找一个值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor.rgb *= light;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要制作纹理，让我们从 2x1 纹理开始，我们将使用 LUMINANCE 为我们提供单色纹理的格式，每个纹理像素仅使用 1 个字节。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35024046648538820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var tex = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, tex);\ngl.texImage2D(\n  gl.TEXTURE_2D, // 目标\n  0, // mip 级别\n  gl.LUMINANCE, // 内部格式\n  2, // 宽度\n  1, // 高度\n  0, // 边界\n  gl.LUMINANCE, // 格式\n  gl.UNSIGNED_BYTE, // 类型\n  new Uint8Array([90, 255])\n);\n\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `35024046648538820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面 2 个像素的颜色是深灰色（90）和白色（255）。我们还设置了纹理参数，因此不会有过滤。</p>\n<p>修改新纹理的样本，我们需要查找 <code class="language-text">u_ramp</code> 变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12223179269720586000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var worldViewProjectionLocation = gl.getUniformLocation(program, \'u_worldViewProjection\');\nvar worldInverseTransposeLocation = gl.getUniformLocation(program, \'u_worldInverseTranspose\');\nvar colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');`, `12223179269720586000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> worldViewProjectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldViewProjection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseTransposeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldInverseTranspose\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> reverseLightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_reverseLightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38965160933725190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);`, `38965160933725190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将 3D 的 F 数据换成了低多边形头部的数据。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kcp967?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果您旋转模型，您会看到它看起来类似于卡通着色</p>\n<p>在上面的示例中，我们设置了纹理过滤，NEAREST 这意味着我们只需从纹理中选择最近的纹理元作为我们的颜色。只有 2 个纹理元，所以如果表面背对光，我们得到第一种颜色（深灰色），如果表面朝向光，我们得到第二种颜色（白色），那种颜色乘以以前的 <code class="language-text">gl_FragColor</code> 颜色 light。</p>\n<p>考虑一下，如果我们切换到 LINEAR 过滤，我们应该得到与使用纹理之前相同的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51544603823139880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `51544603823139880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);</span>\n<span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/l4glzu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这看起来很相似，但如果我们真的将它们并排比较…</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 449px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.3652561247216%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAADBUlEQVQozzWSWUhUYRiGv3NmsiKjaBPKbCNHs8lyKzNnierCii5aKDLaLiL0JkxpIb1pY4o0GbIizcqxKTemUrIy7aIgQtRWg8ql6ejoWf4zc5Y5e0ei7/bjeV94eIFDkQgKnxVvJqn5icK+g8OlQfJPlBNphkH/T0NSM+pIH8q3fdie82Jv54+3qqAwDANBlsiTikHLwPQcnM+GPltye173YJ8Q4WmGZhDDo8gFrhYfXwtf7VjnCniwcNrVZbe77oucCDf4BtBXW9WNuO7G2A0x3VlwZ/bxpiKNV0iGEhDXz/6awbtgJNPyJQvrsFsfJEPZnKUnU0OhEHj4OtAzLZobdCcIuZbudKiIO1RbIHOSCYuI/8h+jwm7gFgHvWnw2o4/TIJTcUuO2weHB+Eh1w5aDqY4QXJgPWnWppVwbXZp4LIR1cdp0jQyxAYTRnZAjx17ZQe/bdL5xXBiVkaxQwjzEOC6QMsF1Qm6C9pXWj9mwatFl1rLDckwYdMlER5NDO2G9yvw39l4Y3LM5SVQG59dtlnmovA88hY0B2hOMFzY0xTrMzN+wbWA11Am4DBiQ2jMTu2H4TW44cafpkwuioerce7TWyfgPrZ/sroJ1Fww3JY6m/XCIqiY73vt1yWNpKl/tjdSBUCkWiQX/ihp6q65UDgj/+IRRZBhmP0zU80DfQMmO/FAClZvwz0J7e9fyqJM0TSFKAMpO9EpGFtlGVqP31k+pTgBCmOLKks0SQWR4bdJJRPCZTf+PQtaltmurycIIhwOmzOgEK0j5Qb1GIKrLJ8ysZZka/lSODYz0PVEkRTgycg7pjdWdkN0Hf4tA67Pu/umToqIlNmKkLkzkiTpMdoxdBQ+2yY1p8DJafuuHOZZbpwch4jAGZx+X26bb+ya/tVxrtNjyIYQFVmWNZvNfl7k9ajWzw1k/jwQ25q+5dYeYpTQVE0QBPD7/RWVFV1tHcWeM5575fV3fV6vt6amJhgMmu+BgYGqqqpKb2XgcUtDU8OxssLGhsZ6X311dbWvzvcXek/OY1qTglsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 29 57" title="" data-src="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png" data-srcset="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-17e1d.png 200w,\n/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-f4f9f.png 400w,\n/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png 449w" data-sizes="(max-width: 449px) 100vw, 449px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以看到它们并不相同。这是怎么回事？</p>\n<p>LINEAR 过滤像素之间的混合。如果我们使用线性过滤放大 2 像素纹理，我们会看到问题</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 353px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 141.07648725212462%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADz0lEQVQ4y9WU/09bVRTAz3t9lNKWbVW+StjMTCZqBhpggFtbYMyYmGjMYL/qzyJC8AcT/wLdYrb94H9gRCPQ0v02ddCaEDu3BXBz2BYKhX6BAhPoe+9+eb3X+/qAH8z8aT8YTz4575x37sm5556bC/fu33u08DunVJB4/Ph+NPqHcBljhDycm3uwMI8ZLXIWW47PPZwXGJwVuZFMLc9GfwMd6To/EML5HmPo0EWMMxFjhzFcoiSsyAgmQFUVBUNoPIgmgjgwpU8ESCCkC3s8WAgGQ3vT4zg8oc0EcHhcnZ5E4Ql9xmIH74K2ukrtdg7AJUloKgwAJpl6zyV7cm8APyfRdjDaAbWDZQhI25y6CHoqZTg9XHbyskquuA3FLTQrc3PJtXf8WNWGD/jFMtqrGL0K7lEsw+i1kZ4FNQb6asqwV3Kwc6mCg8MAh9BMErp8z+X0bJwH3i1RPxh+wD6wDAHxzWv/3+RnO7BV419GtWuOqgV4m0RawWgF3Aq0DYwSpLU0qlxO630bey9iX59A8/URrwnv6tvvvfTW9kedfNiHh/x4yFsY9GmDPv1jgVcdjGspoBijeIIklizUxcX9pdiTVCyfTaRzsdx6LLu5tLKzHNtPLhaSCbSWwCZxlNKIbvaMnB5DdtKySqq4VcWZqnfMdrp+uOz5aqhu5ItT/d80Nd9pUWId8q5PQT0WNq376JK4OZTx0glTyZ6rs9/tdAb6T9wcrh29dnLguzNnf2mWVzpA80LRfwA9GlX5MZFmHrhUQWRHtr482uWaHPDcGK4bvXrqytjLzZEWW7ITVJ9kdFsA8T9lzkQqz9bZo53Oyf4TNz6pHb16cmDszNlIs5zsANV7MGRrzup/mixumOO4SOM2l2ib2CqyDY5ol3ty4LmbI/WfXnvxylhTS+R1JdklqX7Z6LGQSPdRz6KmxCWFg42CnKuW77bbJ953Xx96fuTLFy5/+9KrkdfklTbQ3oTihQPo+XntT9DX06jhtFHVQGsbaU2jWt2w9kr9r5caAx+c/vqzps+vN3/4/bkLEW9NvK/qr3dq0HsW1dq7j7QlMAhB6QzJZAU4ndHX1lEuo25k9reyT7bSWzuZrf2NnPDR5jraTOPNDMkLhIEIgqIQZj6QrKTX0umNfJ4YBkJY03QBRpgSur21vbaaOlomNKUUTKdYPIAxrVDQVJUQbAoSopsGwaqmFdQCMx/tQ1gR+DPIP5PFRoqlLYiPqCOqWn9K9YkZemqy1Uw+v3n79o/BqVA4EpkJh2/dCv30853p6ZnZ2dmpqdBycuVopZC/AT4yAzC0BuxdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 30 56" title="" data-src="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png" data-srcset="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-da624.png 200w,\n/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png 353w" data-sizes="(max-width: 353px) 100vw, 353px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>每边有半个像素，没有插值。想象一下，如果纹理设置 <code class="language-text">TEXTURE_WRAP_S</code> 为 REPEAT，然后我们期望红色像素的最左半部分线性地向绿色混合，就好像绿色向左重复一样。但是左边的颜色更红，因为我们使用的是 <code class="language-text">CLAMP_TO_EDGE</code></p>\n<p>要真正获得渐变，我们只想从该中心范围中选择值。我们可以通过着色器中的一些数学运算来做到这一点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27125831389726020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  // vec4 rampColor = texture2D(u_ramp, uv);\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `27125831389726020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{9,25-29,31-32}"\n              >\n                <span class="gatsby-code-button-language">glsl{9,25-29,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放到渐变的大小</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec4 rampColor = texture2D(u_ramp, uv);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面我们基本上是在缩放我们的 uv 坐标，所以它从 0 到 1 比纹理的宽度小 1。然后添加半个像素并转换回标准化纹理坐标。</p>\n<p>我们需要查找位置 <code class="language-text">u_rampSize</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48006328635778190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');`, `48006328635778190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22055422273192770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);`, `22055422273192770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在我们运行它之前，让我们添加一个标志，以便我们可以比较有无渐变纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56497629581243335000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\nuniform bool u_useRampTexture;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  if (!u_useRampTexture) {\n    rampColor = vec4(u, u, u, 1);\n  }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `56497629581243335000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10,34-36}"\n              >\n                <span class="gatsby-code-button-language">glsl{10,34-36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> u_useRampTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span>\n  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span>\n\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u_useRampTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    rampColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也会查找 uniform 的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50079318539215140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar useRampTextureLocation = gl.getUniformLocation(program, \'u_useRampTexture\');`, `50079318539215140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> useRampTextureLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_useRampTexture\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38992351801083000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  useRampTexture: true\n};\n\n// ...\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);\n\ngl.uniform1i(useRampTextureLocation, data.useRampTexture);`, `38992351801083000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14}"\n              >\n                <span class="gatsby-code-button-language">js{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useRampTexture<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>useRampTextureLocation<span class="token punctuation">,</span> data<span class="token punctuation">.</span>useRampTexture<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且我们可以看到旧的光照方式和新的渐变纹理方式匹配</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/hhj00m?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>单击 useRampTexture 复选框，我们看不到任何变化，因为这两种技术现在匹配。</p>\n<blockquote>\n<p>注意：我通常不建议 <code class="language-text">u_useRampTexture</code> 在着色器中使用条件。相反，我建议制作 2 个着色器程序，一个使用普通光照，一个使用渐变纹理。不幸的是，由于代码没有使用类似于 out helper 库的东西，因此支持 2 个着色器程序将进行相当大的更改。每个程序都需要自己的一组位置。做出如此大的改变会分散本文的重点，因此在这种情况下，我决定使用条件。一般来说，虽然我尽量避免使用条件来选择着色器中的特征，而是为不同的特征创建不同的着色器。</p>\n</blockquote>\n<blockquote>\n<p>注意：这个数学只有在我们使用 LINEAR 过滤时才重要。如果我们使用 NEAREST 过滤，我们需要原始数学。</p>\n</blockquote>\n<p>现在我们知道渐变数学是正确的，让我们制作一堆不同的渐变纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13992211271907996000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 256 数组，其中元素 0 到 127\n// 从 64 到 191 和元素 128 到 255\n// 都是 255\nconst smoothSolid = new Array(256).fill(255);\nfor (let i = 0; i < 128; ++i) {\n  smoothSolid[i] = 64 + i;\n}\n\nconst ramps = [\n  { name: \'dark-white\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255] },\n  {\n    name: \'dark-white-skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 255, 255]\n  },\n  { name: \'normal\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: true, data: [0, 255] },\n  { name: \'3-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 160, 255] },\n  { name: \'4-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 140, 200, 255] },\n  {\n    name: \'4-step skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 80, 140, 200, 255]\n  },\n  { name: \'black-white-black\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255, 80] },\n  {\n    name: \'stripes\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255\n    ]\n  },\n  {\n    name: \'stripe\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      0,\n      0,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255\n    ]\n  },\n  { name: \'smooth-solid\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: smoothSolid },\n  { name: \'rgb\', color: [1, 1, 1, 1], format: gl.RGB, filter: true, data: [255, 0, 0, 0, 255, 0, 0, 0, 255] }\n];\n\nvar elementsForFormat = {};\nelementsForFormat[gl.LUMINANCE] = 1;\nelementsForFormat[gl.RGB] = 3;\n\nramps.forEach((ramp) => {\n  const { name, format, filter, data } = ramp;\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n  gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);\n  const width = data.length / elementsForFormat[format];\n  gl.texImage2D(\n    gl.TEXTURE_2D, // 目标\n    0, // mip 级别\n    format, // 内部格式\n    width,\n    1, // 高度\n    0, // 边界\n    format, // 格式\n    gl.UNSIGNED_BYTE, // 类型\n    new Uint8Array(data)\n  );\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  ramp.texture = tex;\n  ramp.size = [width, 1];\n});`, `13992211271907996000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 256 数组，其中元素 0 到 127</span>\n<span class="token comment">// 从 64 到 191 和元素 128 到 255</span>\n<span class="token comment">// 都是 255</span>\n<span class="token keyword">const</span> smoothSolid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  smoothSolid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> ramps <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'dark-white\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'dark-white-skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'normal\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'3-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'4-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'4-step skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'black-white-black\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripes\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripe\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'smooth-solid\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> smoothSolid <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'rgb\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> elementsForFormat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\nramps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ramp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> format<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> ramp<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> width <span class="token operator">=</span> data<span class="token punctuation">.</span>length <span class="token operator">/</span> elementsForFormat<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n    width<span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n    gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n    <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>texture <span class="token operator">=</span> tex<span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token punctuation">[</span>width<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们制作着色器，这样我们就可以同时处理 NEAREST 和 LINEAR。就像我上面提到的，我通常不在着色器中使用布尔 if 语句，但如果区别很简单并且我可以在没有条件的情况下做到这一点，那么我会考虑使用一个着色器。为此，我们可以添加一个 <code class="language-text">u_linearAdjust</code>，我们将其设置为 0.0 或 1.0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93753280568099520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n// uniform bool u_useRampTexture;\n// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量，规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  // vec2 texelRange = uv * (u_rampSize - 1.0);\n  vec2 texelRange = uv * (u_rampSize - u_linearAdjust);\n\n  // // 偏移半个纹理元并转换为纹理坐标\n  // vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n  // 如果是线性的，则偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5 * u_linearAdjust) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  // if (!u_useRampTexture) {\n  //   rampColor = vec4(u, u, u, 1);\n  // }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `93753280568099520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10-11,28-29,31-34,38-40}"\n              >\n                <span class="gatsby-code-button-language">glsl{10-11,28-29,31-34,38-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// uniform bool u_useRampTexture;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量，规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 texelRange = uv * (u_rampSize - 1.0);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> u_linearAdjust<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// // 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 rampUV = (texelRange + 0.5) / u_rampSize;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 如果是线性的，则偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_linearAdjust<span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// if (!u_useRampTexture) {</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">//   rampColor = vec4(u, u, u, 1);</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// }</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在初始化时查找位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2281841753730162700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar linearAdjustLocation = gl.getUniformLocation(program, \'u_linearAdjust\');`, `2281841753730162700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> linearAdjustLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_linearAdjust\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并在渲染时选择其中一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94552387491370760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  ramp: 0\n};\n\n// ...\n\nconst { texture, color, size, filter } = ramps[data.ramp];\n\n// 设置要使用的颜色\n// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);\ngl.uniform4fv(colorLocation, color);\n\n// 设置光照方向\ngl.uniform3fv(reverseLightDirectionLocation, m4.normalize([-1.75, 0.7, 1]));\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\n// gl.bindTexture(gl.TEXTURE_2D, tex);\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\n// gl.uniform2fv(rampSizeLocation, [2, 1]);\ngl.uniform2fv(rampSizeLocation, size);\n\n// 如果是线性调整\ngl.uniform1f(linearAdjustLocation, filter ? 1 : 0);`, `94552387491370760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,18-19,23-24,26-27}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,18-19,23-24,26-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  ramp<span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> texture<span class="token punctuation">,</span> color<span class="token punctuation">,</span> size<span class="token punctuation">,</span> filter <span class="token punctuation">}</span> <span class="token operator">=</span> ramps<span class="token punctuation">[</span>data<span class="token punctuation">.</span>ramp<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置要使用的颜色</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置光照方向</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>reverseLightDirectionLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.75</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.bindTexture(gl.TEXTURE_2D, tex);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform2fv(rampSizeLocation, [2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 如果是线性调整</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>linearAdjustLocation<span class="token punctuation">,</span> filter <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zgif20?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>尝试不同的渐变纹理，你会看到很多奇怪的效果。这是制作通用调整着色器的一种方法。您可以通过设置 2 种颜色和像这样的阈值来制作进行 2 种颜色卡通着色的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15604293118518075000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 color1;\nuniform vec4 color2;\nuniform float threshold;\n\n// ...\n\nfloat cosAngle = dot(normal, u_reverseLightDirection);\n\n// 从 -1 <-> 1 转换为 0 <-> 1\nfloat u = cosAngle * 0.5 + 0.5;\n\ngl_FragColor = mix(color1, color2, step(cosAngle, threshold));`, `15604293118518075000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color1<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color2<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> threshold<span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n<span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>color1<span class="token punctuation">,</span> color2<span class="token punctuation">,</span> <span class="token function">step</span><span class="token punctuation">(</span>cosAngle<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它会起作用。但是，如果您想要 3 步或 4 步版本，则需要编写另一个着色器。使用渐变纹理，您可以提供不同的纹理。此外，请注意上面，即使您想要一个 2 步色调着色器，您仍然可以通过在纹理中放置更多或更少的数据来调整步进发生的位置。例如纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58521740154253640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, light]`, `58521740154253640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为您提供 2 步纹理，其中它在面向或远离光线的中间分裂。但质地像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45921861746138350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, dark, dark, light, light]`, `45921861746138350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, dark, dark, light, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>无需更改着色器即可将拆分移动到背对光和朝向光之间的 60% 标记。</p>\n<p>这个使用渐变纹理进行卡通着色或奇怪效果的具体示例可能对您有用也可能不那么有用，但更重要的结论只是使用一些值在纹理中查找数据的基本概念。使用这样的纹理不仅仅是为了转换光照计算。您可以使用渐变纹理进行后期处理，以实现与 Photoshop 中的渐变贴图相同的效果</p>\n<p>您还可以将渐变纹理用于基于 GPU 的动画。您将关键值存储在纹理中，并使用时间作为在纹理上移动的值。这种技术有很多用途。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL 理论基础——纹理/index.md absPath of file >>> MarkdownRemark",timeToRead:41,frontmatter:{date:"2022-07-27 14:35:19",path:"/webgl-fundamental-textures/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——纹理",draft:null}},{excerpt:"WebGL 三维几何加工 有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是 。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ…",html:'<h1 id="webgl-三维几何加工"><a href="#webgl-%E4%B8%89%E7%BB%B4%E5%87%A0%E4%BD%95%E5%8A%A0%E5%B7%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维几何加工</h1>\n<p>有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是<code class="language-text">使用一个三维建模工具例如 Blender, Maya, 3D Studio Max, Cinema 4D, 等等</code>。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ 格式相对简单些)。</p>\n<p>但是，这让我想到，如果他们想做一个模型库该怎么办？</p>\n<p>这有几种方法，一种方法是将圆柱体按照正弦函数放置在合适位置上，但这样表面并不平滑。一个标准的圆柱需要一些间距相等的圆环，但当曲线变得锐利的时候所需圆环的数量就会很多。</p>\n<p>在模型库中你需要制作一个二维轮廓或者是一个符合边缘的曲线，然后将他们加工成三维图形。这里加工的意思就是将生成的二维点按照某些轴旋转。这样就可以很轻松的做出一些圆的物体，例如碗，棒球棒，瓶子，灯泡之类的物体。</p>\n<p>那么该怎么做呢？首先我们要通过某种方式生成一个曲线，计算曲线上的点。然后使用矩阵运算将这些点按照某个轴旋转，构建出三角形网格。</p>\n<h2 id="贝塞尔曲线"><a href="#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>贝塞尔曲线</h2>\n<p>计算机中常用的曲线就是贝塞尔曲线，你可能在一些编辑器例如 Adobe Illustrator 或 Inkscape 或 Affinity Designer 中编辑过贝塞尔曲线。</p>\n<p>贝塞尔曲线或三次贝塞尔曲线由 4 个点组成，2 个端点，2 个“控制点”。</p>\n<p>这就是四个点</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0) -->\n<p>从 0 到 1 之间选一个数（叫做 t），其中 0 是起点，1 是终点。然后在每个线段中计算出与 t 相关的点，<code class="language-text">P1 P2</code>, <code class="language-text">P2 P3</code>, <code class="language-text">P3 P4</code>。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=1) -->\n<p>换句话说如果 <code class="language-text">t = .25</code> 那么就计算出 P1 到 P2 距离为 25% 的点，从 P2 到 P3 距离为 25% 的点，从 P3 到 P4 距离为 25% 的点。</p>\n<p>你可以拖动滑块调整 t 的值，也可以拖动 <code class="language-text">P1, P2, P3</code> 和 P4 调整位置。</p>\n<p>对这些结果点做同样的操作，计算 t 对应的 <code class="language-text">Q1 Q2</code> 和 <code class="language-text">Q2 Q3</code> 之间的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=2) -->\n<p>最后在 <code class="language-text">R1 R2</code> 中计算出与 t 相关的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=3) -->\n<p>红点的位置就构成了一个曲线。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4) -->\n<p>这就是三次贝塞尔曲线。</p>\n<p>注意到在上述差值过程中通过 4 个点差出 3 个点，3 个点差出 2 个点，最后从 2 个点差出 1 个点，这并不是常用的做法，有人将这些数学运算简化成了一个公式，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88306259341378960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3`, `88306259341378960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 P1, P2, P3, P4 就像上例中的四个点，P 就是那个红点。</p>\n<p>在二维美术应用例如 Adobe Illustrator 中，当你制作一个较长的曲线时通常是由一些小的四点片段组成的。默认情况下应用将控制点沿着起/终点方向锁死，确保在公共点部分方向相反。</p>\n<p>看这个例子，移动 P3 或 P5 会同时移动另一个。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xbsn5w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意这个曲线是两段，<code class="language-text">P1,P2,P3,P4</code> 和 <code class="language-text">P4,P5,P6,P7</code>。只有在 P3，P5 与 P4 的连线方向相反时曲线在这一点才会连续。大多数应用可以让你断开连接，并获得一个锐利的拐点。取消选中复选框然后拖拽 P3 或 P5 就会清晰看到独立的曲线。</p>\n<p>接下来我们需要获得生成曲线上的点，通过给上方的公式提供 t 就可以生成一个点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10941510358934315000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointOnBezierCurve(points, offset, t) {\n  const invT = 1 - t;\n  return v2.add(\n    v2.mult(points[offset + 0], invT * invT * invT),\n    v2.mult(points[offset + 1], 3 * t * invT * invT),\n    v2.mult(points[offset + 2], 3 * invT * t * t),\n    v2.mult(points[offset + 3], t * t * t)\n  );\n}`, `10941510358934315000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> invT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> v2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> invT <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> t <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> invT <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后可以计算一系列点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1858916426791634700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurve(points, offset, numPoints) {\n  const points = [];\n  for (let i = 0; i < numPoints; ++i) {\n    const t = i / (numPoints - 1);\n    points.push(getPointOnBezierCurve(points, offset, t));\n  }\n  return points;\n}`, `1858916426791634700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> numPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numPoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token punctuation">(</span>numPoints <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> points<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">v2.mult</code> 和 <code class="language-text">v2.add</code> 是我加入的二维点运算辅助方法。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showPoints=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showPoints=true) -->\n<p>在图示中你可以选择点的个数，如果曲线比较锐利就可以多差值一些点，如果曲线比较平缓就可以少插值一些点。一个解决办法是检查曲线的锐利程度，如果过于锐利就拆分成两个曲线。</p>\n<p>拆分的部分比较简单，如果我们再看看不同级别的拆分，对于任意值的 <code class="language-text">t, P1, Q1, R1</code>, 红点构成一个曲线，终点是红点。<code class="language-text">红点, R2, Q3, P4</code> 构成一个曲线。换句话说我们可以将曲线从任意位置分成两段，并且和原曲线相同。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4%26show2Curves=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4%26show2Curves=true) -->\n<p>第二个部分是如何决定曲线是否需要拆分，从网上查找后我发现了<a href="https://seant23.wordpress.com/2010/11/12/offset-bezier-curves/" target="_blank" rel="nofollow noreferrer noopener">这个方法</a>，对于给定的曲线可以求出平滑程度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5659398797197190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function flatness(points, offset) {\n  const p1 = points[offset + 0];\n  const p2 = points[offset + 1];\n  const p3 = points[offset + 2];\n  const p4 = points[offset + 3];\n\n  let ux = 3 * p2[0] - 2 * p1[0] - p4[0];\n  ux *= ux;\n  let uy = 3 * p2[1] - 2 * p1[1] - p4[1];\n  uy *= uy;\n  let vx = 3 * p3[0] - 2 * p4[0] - p1[0];\n  vx *= vx;\n  let vy = 3 * p3[1] - 2 * p4[1] - p1[1];\n  vy *= vy;\n\n  if (ux < vx) {\n    ux = vx;\n  }\n\n  if (uy < vy) {\n    uy = vy;\n  }\n\n  return ux + uy;\n}`, `5659398797197190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">flatness</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> ux <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  ux <span class="token operator">*=</span> ux<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> uy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  uy <span class="token operator">*=</span> uy<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vx <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vx <span class="token operator">*=</span> vx<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vy <span class="token operator">*=</span> vy<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ux <span class="token operator">&lt;</span> vx<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ux <span class="token operator">=</span> vx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>uy <span class="token operator">&lt;</span> vy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    uy <span class="token operator">=</span> vy<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> ux <span class="token operator">+</span> uy<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用它获取曲线上的点，首先检查曲线是否太锐利，如果是就拆分，不是就将点加入列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5077993692756610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints) {\n  const outPoints = newPoints || [];\n  if (flatness(points, offset) < tolerance) {\n    // 将它加入点队列中\n    outPoints.push(points[offset + 0]);\n    outPoints.push(points[offset + 3]);\n  } else {\n    // 拆分\n    const t = 0.5;\n    const p1 = points[offset + 0];\n    const p2 = points[offset + 1];\n    const p3 = points[offset + 2];\n    const p4 = points[offset + 3];\n\n    const q1 = v2.lerp(p1, p2, t);\n    const q2 = v2.lerp(p2, p3, t);\n    const q3 = v2.lerp(p3, p4, t);\n\n    const r1 = v2.lerp(q1, q2, t);\n    const r2 = v2.lerp(q2, q3, t);\n\n    const red = v2.lerp(r1, r2, t);\n\n    // 求前半段的点\n    getPointsOnBezierCurveWithSplitting([p1, q1, r1, red], 0, tolerance, outPoints);\n    // 求后半段的点\n    getPointsOnBezierCurveWithSplitting([red, r2, q3, p4], 0, tolerance, outPoints);\n  }\n  return outPoints;\n}`, `5077993692756610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">flatness</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">)</span> <span class="token operator">&lt;</span> tolerance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将它加入点队列中</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> q1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q3 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> p4<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> r1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> r2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> red <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 求前半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> q1<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> red<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 求后半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>red<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> p4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true) -->\n<p>这个算法在获取曲线点的过程中确保了点的数量比较充足，但是不能很好的排除不必要的点。</p>\n<p>由于这个原因我们将使用我在网上找到的 <a href="https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm" target="_blank" rel="nofollow noreferrer noopener">Ramer Douglas Peucker 算法</a>。</p>\n<p>在这个算法中我们提供一系列点，找到离最后两点构成的直线距离最远的点，然后将这个距离和一个定值进行比较，如果小于那个值就保留最后两个点然后丢弃其他的点，大于则将曲线沿那个最远点分成两份，分别对每一份再做一次这个运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69839923781777500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function simplifyPoints(points, start, end, epsilon, newPoints) {\n  const outPoints = newPoints || [];\n\n  // 找到离最后两点距离最远的点\n  const s = points[start];\n  const e = points[end - 1];\n  let maxDistSq = 0;\n  let maxNdx = 1;\n  for (let i = start + 1; i < end - 1; ++i) {\n    const distSq = v2.distanceToSegmentSq(points[i], s, e);\n    if (distSq > maxDistSq) {\n      maxDistSq = distSq;\n      maxNdx = i;\n    }\n  }\n\n  // 如果距离太远\n  if (Math.sqrt(maxDistSq) > epsilon) {\n    // 拆分\n    simplifyPoints(points, start, maxNdx + 1, epsilon, outPoints);\n    simplifyPoints(points, maxNdx, end, epsilon, outPoints);\n  } else {\n    // 添加最后两个点\n    outPoints.push(s, e);\n  }\n\n  return outPoints;\n}`, `69839923781777500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 找到离最后两点距离最远的点</span>\n  <span class="token keyword">const</span> s <span class="token operator">=</span> points<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> e <span class="token operator">=</span> points<span class="token punctuation">[</span>end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxDistSq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxNdx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceToSegmentSq</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">></span> maxDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      maxDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n      maxNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 如果距离太远</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>maxDistSq<span class="token punctuation">)</span> <span class="token operator">></span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> maxNdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> maxNdx<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 添加最后两个点</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">v2.distanceToSegmentSq</code> 是计算点到线段距离平方的一个方法，使用距离平方的原因是比使用实际距离要快一些，因为我们值管线最远距离所以和实际距离的效果相同。</p>\n<p>这是结果，调整距离查看添加或删除的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showDistance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showDistance=true) -->\n<h2 id="保龄球"><a href="#%E4%BF%9D%E9%BE%84%E7%90%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保龄球</h2>\n<p>回到保龄球瓶，我们可以将上方的代码整理一下，需要添加和移除点，锁定和解锁控制点， 撤销等等。但是这有一个简单的方式，我们可以使用一个上方提到的编辑器，我使用这个在线编辑器。</p>\n<p>这是保龄球的半边轮廓的 svg。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAAZUlEQVQ4y2NgwA9YgJiVgUqACYh1gJiPWgbyALEylM1IDQO5gFiFgcoAZCAHNQyCeVEZ6nUGahmqBsTM1DKQH4iVqBEpyN7lHZQRAsshytR0HRPUQGZqJhlVIOampis5qZlkyAYA9fACRaHh3QoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 00 19" title="" data-src="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png" data-srcset="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-5da91.png 200w,\n/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-08121.png 400w,\n/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由 4 个曲线制成，路径的数据像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25612290209915380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<path\n  fill=&quot;none&quot;\n  stroke-width=&quot;5&quot;\n  d=&quot;\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  &quot;\n/>`, `25612290209915380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="svg"\n              >\n                <span class="gatsby-code-button-language">svg</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="svg"><pre style="counter-reset: linenumber NaN" class="language-svg line-numbers"><code class="language-svg"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span>\n  <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span>\n  <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>\n  <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  <span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths" target="_blank" rel="nofollow noreferrer noopener">解译</a>这些数据得到这些点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58057784699105210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|`, `58057784699105210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在有了曲线数据，需要计算出曲线上的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91638786412301320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 获取所有片段的点\nfunction getPointsOnBezierCurves(points, tolerance) {\n  const newPoints = [];\n  const numSegments = (points.length - 1) / 3;\n  for (let i = 0; i < numSegments; ++i) {\n    const offset = i * 3;\n    getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints);\n  }\n  return newPoints;\n}`, `91638786412301320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 获取所有片段的点</span>\n<span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> tolerance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> newPoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numSegments <span class="token operator">=</span> <span class="token punctuation">(</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSegments<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> newPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 simplifyPoints 处理结果。</p>\n<p>现在要旋转它们了，需要决定分多少个部分，对于每个部分都用矩阵运算绕 Y 轴转动一定角度获得，一旦获得所有点就用索引连接它们。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79551203363460510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      const v = (ndx + vOffset) / quadsDown;\n      texcoords.push(u, v);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column2Offset + quad, column1Offset + quad + 1);\n      indices.push(column1Offset + quad + 1, column2Offset + quad, column2Offset + quad + 1);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `79551203363460510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>ndx <span class="token operator">+</span> vOffset<span class="token punctuation">)</span> <span class="token operator">/</span> quadsDown<span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码创建了位置点和纹理坐标，然后创建索引生成三角网。capStart 和 capEnd 确定是都生成闭合点，假设我们在做一个罐头，这些选项指明是否需要闭合顶面和底面。</p>\n<p>使用我们的简化代码就可以用哪些数据生成这样的 WebGL 缓冲</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18531527363956314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const tolerance = 0.15;\nconst distance = 0.4;\nconst divisions = 16;\nconst startAngle = 0;\nconst endAngle = Math.PI * 2;\nconst capStart = true;\nconst capEnd = true;\n\nconst tempPoints = getPointsOnBezierCurves(curvePoints, tolerance);\nconst points = simplifyPoints(tempPoints, 0, tempPoints.length, distance);\nconst arrays = lathePoints(points, startAngle, endAngle, divisions, capStart, capEnd);\nconst extents = getExtents(arrays.position);\nif (!bufferInfo) {\n  bufferInfo = webglUtils.createBufferInfoFromArrays(gl, arrays);\n}`, `18531527363956314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> tolerance <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> distance <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> divisions <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> startAngle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> endAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> tempPoints <span class="token operator">=</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span>curvePoints<span class="token punctuation">,</span> tolerance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>tempPoints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tempPoints<span class="token punctuation">.</span>length<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arrays <span class="token operator">=</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> divisions<span class="token punctuation">,</span> capStart<span class="token punctuation">,</span> capEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>arrays<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bufferInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lfvcxq?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>拖动滑块观察对结果的影响。</p>\n<p>这还有一个问题，开启三角形你会看到纹理不是均匀分布的，这是因为我们将纹理坐标的 v 值赋为曲线点的索引，如果曲线上的点距离相等那就没问题，但是它们距离并不相等。</p>\n<p>我们可以遍历曲线上的点并计算出每一点对应曲线长度，最后将这个长度除以曲线总长度赋值给 v。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12513415861167276000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成 v 值\n  let vcoords = [];\n\n  // 先计算出每一点对应的长度\n  let length = 0;\n  for (let i = 0; i < points.length - 1; ++i) {\n    vcoords.push(length);\n    length += v2.distance(points[i], points[i + 1]);\n  }\n  vcoords.push(length); // 最后一个点\n\n  // 除以总长\n  vcoords = vcoords.map((v) => v / length);\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      texcoords.push(u, vcoords[ndx]);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column1Offset + quad + 1, column2Offset + quad);\n      indices.push(column1Offset + quad + 1, column2Offset + quad + 1, column2Offset + quad);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `12513415861167276000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{19-31,46}"\n              >\n                <span class="gatsby-code-button-language">js{19-31,46}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 生成 v 值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> vcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 先计算出每一点对应的长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    length <span class="token operator">+=</span> v2<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后一个点</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以总长</span></span><span class="gatsby-highlight-code-line">  vcoords <span class="token operator">=</span> vcoords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v <span class="token operator">/</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> vcoords<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/92oji1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这些纹理坐标还是不完美，因为我们还没决定怎么处理闭合部分的纹理。这也是使用建模软件的一个原因。我们可以总结出很多计算闭合处 uv 值的方法，但并不是很有意义。如果你谷歌一下 UV map a barrel，你会发现完美的 UV 坐标是不需要太多数学运算的，只需要生成合适的点数据，这时你就需要一个合适工具创建点数据。</p>\n<p>还有一个事情要做，就是添加法向量。</p>\n<p>我们可以计算每一个曲线点的法向量，事实上如果你会看这节中的例子，你会发现 R1 和 R2 构成的线段切曲线于红点处。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 610px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.08196721311475%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1klEQVQoz41Si26bMBTl3/cD+5BqSipF1TZpK1GrhlBSIEAjLWhZOhLyAptHMH7OEEoT1kk7lqzra59zH76K+G/QGucepbU453Jfr9cAgOrMRIYzMzIZo5xVVxBC0zTP+V3y4XCYGAah1UIlGm+1H/GcYsI5liq+7+d5/g65zQ2VpTRKjiIaMSkqyCKOLA9LJ7nM/IIsY1OGVoGY/y42bJfu8tT0waqIgmykgzBNqieEv0+WqoySTQaebnfwI0JbxCAkJaMlFfiI4H6Z/XJjt0tmnOU0Rxjt822ehiIh4oMQ6Smf141yBPb3m7sEJ7WHt5G5FduzvUshkI9kqUwTAvGG2oowjmFCCHmLzGs/PAIQBW3b+TchiouPaOw8x1nWSZvjGJCipExWwAkjYiFYWR9emY0oY2UUXZBLKVYUc9//dHX1NJl8/fxFvbt9NB51XR8MBr1er9/vq6qKEJI5u5Z1rIMrssNFUZCk6sHPxWJsGN/VoWGajvesjUaapsmpuq5h2/YpeBAEYRg2kR3b2gRVtavl8tkwpg8P5nA4n07Huu44zmw28zzPdV1pd+pXTkObpdW38JcX0e8LTRM3N8Kymrn5N5RzMdkMLudEglLpZH+hQ/4DDD9XhIqloaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 22 57" title="" data-src="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png" data-srcset="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-1dff0.png 200w,\n/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-8ee4c.png 400w,\n/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png 610w" data-sizes="(max-width: 610px) 100vw, 610px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>法向量和切线垂直所以从切线很容易求出法向量。</p>\n<h2 id="烛台"><a href="#%E7%83%9B%E5%8F%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>烛台</h2>\n<p>但是，假设我们想要做一个烛台，有这样一个框架。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABC0lEQVQ4y2NgIA8wkqqBCUrnAHEFkngQEPeSYygzlC4E4vVI4g1AvBDKZiHHwG4gno0kngbEW9F8QZKXPYH4MRAnALEPEF8D4lI0S0kO+CQgfgfEf4C4iYFKYDEQnwViNnJjGdlLjUD8H4o3kRN+2MAMID4AxNyUGgRLGqC0uJzcyMDmbVBkrKWGgbCw2gjEdyn1Lswwe6RIyaLElTBNiUgGTqDEQFhaE4YmbJCBlpQYCPOyNxB/hhqYR410aADEl4D4FTQ/kw2EgNgNiMuA+BEQfwPiFiAOAGIpUg0rBuJzQPwcatALIH4CZb8B4stA3A/E7MQaCIoIQWhhwAzFLNCwYwVifiAWwxaWAANRLzimc03lAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 23 38" title="" data-src="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png" data-srcset="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这有很多平滑区域也有很多锐利角，如何决定使用法向量的方向呢？当需要锐利边缘时就要使用多余的顶点，因为一个顶点有一个位置和一个法向量，如果需要多个法向量就需要不同的顶点，这也是制作立方体需要至少 24 个顶点的原因，虽然立方体只有 8 个顶点，但每个面在那个顶点处都需要不同的法向量。</p>\n<p>创建立方体的时候很容易确定法向量，但是形状复杂的时候就没那么容易了。</p>\n<p>所有的建模软件都有不同的方式创建法向量，一个常用的做法就是将该点邻接的三角面的法向量求平均。另外，还允许用户选择一个最大角度，如果邻接的多边形的法向量的夹角大于最大角度，就会创建一个新顶点。</p>\n<p>我们来实现这个。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68973746821654180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function generateNormals(arrays, maxAngle) {\n  const positions = arrays.position;\n  const texcoords = arrays.texcoord;\n\n  // 首先计算出每个面的法向量\n  let getNextIndex = makeIndiceIterator(arrays);\n  const numFaceVerts = getNextIndex.numElements;\n  const numVerts = arrays.position.length;\n  const numFaces = numFaceVerts / 3;\n  const faceNormals = [];\n\n  // 计算每个面的法向量\n  // 计算过程中为每个面新建顶点\n  for (let i = 0; i < numFaces; ++i) {\n    const n1 = getNextIndex() * 3;\n    const n2 = getNextIndex() * 3;\n    const n3 = getNextIndex() * 3;\n\n    const v1 = positions.slice(n1, n1 + 3);\n    const v2 = positions.slice(n2, n2 + 3);\n    const v3 = positions.slice(n3, n3 + 3);\n\n    faceNormals.push(m4.normalize(m4.cross(m4.subtractVectors(v1, v2), m4.subtractVectors(v3, v2))));\n  }\n\n  let tempVerts = {};\n  let tempVertNdx = 0;\n\n  // 假设顶点位置精确匹配\n\n  function getVertIndex(x, y, z) {\n    const vertId = x + \',\' + y + \',\' + z;\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    return newNdx;\n  }\n\n  // 我们需要算出共享的顶点\n  // 这并不像我们看着面那么简单 (三角形)\n  // 因为假如我们有一个标准的圆柱\n  //\n  //\n  //      3-4\n  //     /   \\\n  //    2     5   从上往下看，从 S 走到 E, E 和 S\n  //    1     6   是不同的点，因为它们不共享UV坐标。\n  //     \\   /\n  //      S/E\n  //\n  // 顶点在起始和结束位置并不是共享的\n  // 由于它们有不同的 UV 坐标，但如果不\n  // 把它们看作共享顶点就会得到错误结果\n\n  const vertIndices = [];\n  for (let i = 0; i < numVerts; ++i) {\n    const offset = i * 3;\n    const vert = positions.slice(offset, offset + 3);\n    vertIndices.push(getVertIndex(vert));\n  }\n\n  // 遍历所有顶点记录所在的面\n  const vertFaces = [];\n  getNextIndex.reset();\n  for (let i = 0; i < numFaces; ++i) {\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      let faces = vertFaces[sharedNdx];\n      if (!faces) {\n        faces = [];\n        vertFaces[sharedNdx] = faces;\n      }\n      faces.push(i);\n    }\n  }\n\n  // 遍历面上的顶点计算每个顶点的法向量\n  // 只计算两面角度不大于 maxAngle 面\n  // 将结果写入 newPositions, newTexcoords 和 newNormals\n  // 丢弃相同的顶点\n  tempVerts = {};\n  tempVertNdx = 0;\n  const newPositions = [];\n  const newTexcoords = [];\n  const newNormals = [];\n\n  function getNewVertIndex(x, y, z, nx, ny, nz, u, v) {\n    const vertId = x + \',\' + y + \',\' + z + \',\' + nx + \',\' + ny + \',\' + nz + \',\' + u + \',\' + v;\n\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    newPositions.push(x, y, z);\n    newNormals.push(nx, ny, nz);\n    newTexcoords.push(u, v);\n    return newNdx;\n  }\n\n  const newVertIndices = [];\n  getNextIndex.reset();\n  const maxAngleCos = Math.cos(maxAngle);\n  // 对每个面\n  for (let i = 0; i < numFaces; ++i) {\n    // 获取该面的法向量\n    const thisFaceNormal = faceNormals[i];\n    // 对于面上的每一点\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      const faces = vertFaces[sharedNdx];\n      const norm = [0, 0, 0];\n      faces.forEach((faceNdx) => {\n        // 面的法向量是否相同\n        const otherFaceNormal = faceNormals[faceNdx];\n        const dot = m4.dot(thisFaceNormal, otherFaceNormal);\n        if (dot > maxAngleCos) {\n          m4.addVectors(norm, otherFaceNormal, norm);\n        }\n      });\n      m4.normalize(norm, norm);\n      const poffset = ndx * 3;\n      const toffset = ndx * 2;\n      newVertIndices.push(\n        getNewVertIndex(\n          positions[poffset + 0],\n          positions[poffset + 1],\n          positions[poffset + 2],\n          norm[0],\n          norm[1],\n          norm[2],\n          texcoords[toffset + 0],\n          texcoords[toffset + 1]\n        )\n      );\n    }\n  }\n\n  return {\n    position: newPositions,\n    texcoord: newTexcoords,\n    normal: newNormals,\n    indices: newVertIndices\n  };\n}\n\nfunction makeIndexedIndicesFn(arrays) {\n  const indices = arrays.indices;\n  let ndx = 0;\n  const fn = function () {\n    return indices[ndx++];\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = indices.length;\n  return fn;\n}\n\nfunction makeUnindexedIndicesFn(arrays) {\n  let ndx = 0;\n  const fn = function () {\n    return ndx++;\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = arrays.positions.length / 3;\n  return fn;\n}\n\nfunction makeIndiceIterator(arrays) {\n  return arrays.indices ? makeIndexedIndicesFn(arrays) : makeUnindexedIndicesFn(arrays);\n}`, `68973746821654180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">generateNormals</span><span class="token punctuation">(</span><span class="token parameter">arrays<span class="token punctuation">,</span> maxAngle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> arrays<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>\n\n  <span class="token comment">// 首先计算出每个面的法向量</span>\n  <span class="token keyword">let</span> getNextIndex <span class="token operator">=</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaceVerts <span class="token operator">=</span> getNextIndex<span class="token punctuation">.</span>numElements<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numVerts <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaces <span class="token operator">=</span> numFaceVerts <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> faceNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算每个面的法向量</span>\n  <span class="token comment">// 计算过程中为每个面新建顶点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> n1 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n3 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> v1 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n1 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v2 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> n2 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v3 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n3<span class="token punctuation">,</span> n3 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    faceNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设顶点位置精确匹配</span>\n\n  <span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 我们需要算出共享的顶点</span>\n  <span class="token comment">// 这并不像我们看着面那么简单 (三角形)</span>\n  <span class="token comment">// 因为假如我们有一个标准的圆柱</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//      3-4</span>\n  <span class="token comment">//     /   \\</span>\n  <span class="token comment">//    2     5   从上往下看，从 S 走到 E, E 和 S</span>\n  <span class="token comment">//    1     6   是不同的点，因为它们不共享UV坐标。</span>\n  <span class="token comment">//     \\   /</span>\n  <span class="token comment">//      S/E</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 顶点在起始和结束位置并不是共享的</span>\n  <span class="token comment">// 由于它们有不同的 UV 坐标，但如果不</span>\n  <span class="token comment">// 把它们看作共享顶点就会得到错误结果</span>\n\n  <span class="token keyword">const</span> vertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numVerts<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> vert <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    vertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getVertIndex</span><span class="token punctuation">(</span>vert<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历所有顶点记录所在的面</span>\n  <span class="token keyword">const</span> vertFaces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>faces<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        faces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span> <span class="token operator">=</span> faces<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      faces<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历面上的顶点计算每个顶点的法向量</span>\n  <span class="token comment">// 只计算两面角度不大于 maxAngle 面</span>\n  <span class="token comment">// 将结果写入 newPositions, newTexcoords 和 newNormals</span>\n  <span class="token comment">// 丢弃相同的顶点</span>\n  tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nx <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> ny <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nz <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> u <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> v<span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    newPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> newVertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> maxAngleCos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>maxAngle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 对每个面</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取该面的法向量</span>\n    <span class="token keyword">const</span> thisFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 对于面上的每一点</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> norm <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      faces<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">faceNdx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// 面的法向量是否相同</span>\n        <span class="token keyword">const</span> otherFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>faceNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> dot <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>thisFaceNormal<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>dot <span class="token operator">></span> maxAngleCos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> poffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> toffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      newVertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>\n        <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> newPositions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> newTexcoords<span class="token punctuation">,</span>\n    normal<span class="token punctuation">:</span> newNormals<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> newVertIndices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> arrays<span class="token punctuation">.</span>indices<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> indices<span class="token punctuation">[</span>ndx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> ndx<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> arrays<span class="token punctuation">.</span>positions<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> arrays<span class="token punctuation">.</span>indices <span class="token operator">?</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码首先通过原始顶点计算每个面（三角形）的法向量，然后创建一个顶点索引集寻找相同的顶点，那是因为我们旋转后的起始和终止点应该是同一个点，但 UV 坐标不同所以要单独处理，计算顶点法向量时要将它们看作相同点。</p>\n<p>这些做完之后，对于每个顶点，生成了一个包含它的面的集合。</p>\n<p>最后将所有除了差值大于 maxAngle 的面的法向量求平均，获得一个新的顶点集合。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/phpk6p?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意到在期望的位置得到了锐利的边缘，调大 maxAngle 的值就会将相邻的面加入计算，得到平滑的边缘。试试调整 divisions 为 5 或者 6 然后调整 maxAngle 的值让该平滑的地方平滑，该锐利的地方锐利，你也可以设置 mode 为 lit 查看光照效果，这是我们需要法向量的原因。</p>\n<p>由此得到的结论是：如果想做三维模型就用三维建模库</p>\n<p>你可能需要一个 UV 编辑器，帮助完成封闭问题也是三维编辑器提供的功能。代替使用有限的组合处理闭合处问题，可以使用其他编辑器提供的特性处理闭合处并轻松的获取 UV 值，三维编辑器还支持拉伸面和沿路径拉伸，你看了之后就会发现它们是基于上方的加工方式。</p>\n<h2 id="参考"><a href="#%E5%8F%82%E8%80%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考</h2>\n<p><a href="https://pomax.github.io/bezierinfo/" target="_blank" rel="nofollow noreferrer noopener">贝塞尔曲线</a></p>\n<h2 id="这里的模运算符是做什么的"><a href="#%E8%BF%99%E9%87%8C%E7%9A%84%E6%A8%A1%E8%BF%90%E7%AE%97%E7%AC%A6%E6%98%AF%E5%81%9A%E4%BB%80%E4%B9%88%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>这里的模运算符是做什么的?</h2>\n<p>如果你仔细看了 lathePoints 方法就会看到计算角度时使用了模运算符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76534149253570020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (let division = 0; division <= numDivisions; ++division) {\n  const u = division / numDivisions;\n  const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n}`, `76534149253570020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么这么做?</p>\n<p>当我们将点旋转成一个圆形时我们希望起点和终点是匹配的。<code class="language-text">Math.sin(0)</code> 和 <code class="language-text">Math.sin(Math.PI * 2)</code> 应该相等，但是浮点运算并不精确，所以通常它们并不是 100% 的相等。</p>\n<p>这在计算法向量的时候十分重要，我们想知道到一个顶点共享的所有面，我们比较顶点，如果相同就认为是同一点，那么如果不被认为是同一点就会计算出错误的法向量。</p>\n<p>这是这种情况发生时的样子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 420px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 140.47619047619048%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADIUlEQVQ4y2P4jwP8+v3ny7cfv379/o8bMCBz/v37ByQv3/yS23PeNneTXlqLfV5hcVfd1Wtn4bLYNUOkfn37H5L8iMVvF1PSYoaMPNZULwF/+cRE3T/fv2LqR7H573+QXN2cj0Itxzj7V7D2F/NNCJRuUW2fFwaXxan5D9jgnv0fuRsOcDYtY6su4q0PFq5X7d6ZBdL87y8+zX//gjTn9r0W8dsnFLCU36tE3CdE3l8vr8UR7i8Cmqd1v1fSOSxvt0zavFzZJkJHV3FOVx5Y9i/+0AaR71/9zbQ6Zckyx5G/1o7ZL9fU8/3zhyBZ/Joh+oEm/H3+Y0XbPQ2f8mVNvf+efvsHCuZ/BOIZpBkcrE9+fc+5d0J2e3nmtfKHP+/8/weGBDX/AXu7f+ETHofF6n71Qhb6nTPzsXoYq7NBml/f/jo1+YKZduXUuNqXNx5hTV5YNIPjE6Tu1pP/8gU1l+4ewhrDeDSDbLr54r9ke/25BwdI1QzSffX5f9HO2pP3d5OmGZJI9z3+xTS3aP2dBWCRP0Rp/vcfGivJZ24ybi0JOx7y68/H//+JjCqwtYfv/xCct49naZ3QbI3N12bishx7PG8/+Z0rZT9ncS1vksbynd1g8d+ENYP1/n/y7K96yimm6CqVGP1rNw4Tm0jg6SFyyh2G3DKfHtd/v78R62eIkmXXn9kc2StxqMb8sNvsC7X//v4mENpABwNjGBJgW4+9Dm8+IONWFlyct/7AMqBjgGXQ33+//6IGGxZn//zz58//bysfPJDvK592te3H/3c//nzAcBxMM4T34cfvY2/eLHh5q+bl0bAXq9w+TfX+U+/+MSH4hU/Fy4i5L3KPvJ765utVZP8zQOjX33+nXLnhdfOYw50d5ndXmj2YY/dyqvndcvO76ZYPYmzvurvfMQm9pZJ2Serm2yPwBMsAyWov3/72W3RZbctOhcOrFC7MU789zeDZRJlTOdInY5Uvhaud91Y/ZG2wTd9vnv7dJ+cRmuFF1/OnPxduf5y95KT3wm32S1ebrJir0VVu0FdkNaPYd355wZLWOVsWPHn0CNnZAAmynWVSCotdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 38 12" title="" data-src="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png" data-srcset="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-5f5a6.png 200w,\n/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-fe3d6.png 400w,\n/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png 420w" data-sizes="(max-width: 420px) 100vw, 420px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可以看到它们在共享处没有被当作相同点，因为它们不是 100% 的相等。</p>\n<p>起初我想通过提供一个误差范围，检查顶点的距离是否在范围内，如果小于误差范围就认为是同一点，就像这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86995694344975120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const epsilon = 0.0001;\nconst tempVerts = [];\nfunction getVertIndex(position) {\n  if (tempVerts.length) {\n    // 找到最近的点\n    let closestNdx = 0;\n    let closestDistSq = v2.distanceSq(position, tempVerts[0]);\n    for (let i = 1; i < tempVerts.length; ++i) {\n      let distSq = v2.distanceSq(position, tempVerts[i]);\n      if (distSq < closestDistSq) {\n        closestDistSq = distSq;\n        closestNdx = i;\n      }\n    }\n    // 是否在误差范围内\n    if (closestDistSq < epsilon) {\n      // 是就返回那个点\n      return closestNdx;\n    }\n  }\n  // 不是就将它添加到序列中并返回索引\n  tempVerts.push(position);\n  return tempVerts.length - 1;\n}`, `86995694344975120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> epsilon <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 找到最近的点</span>\n    <span class="token keyword">let</span> closestNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> closestDistSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">&lt;</span> closestDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closestDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n        closestNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 是否在误差范围内</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>closestDistSq <span class="token operator">&lt;</span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是就返回那个点</span>\n      <span class="token keyword">return</span> closestNdx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 不是就将它添加到序列中并返回索引</span>\n  tempVerts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> tempVerts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它成功解决了接缝问题，但是它消耗的时间太长，导致 UI 交互不稳定。这是因为它是一个复杂度为 O^2 的解决方法，如果你滑动滑块在最多的情况下就会创建大约 20000 个点，再加上 O^2 的复杂度就是 3 亿次迭代。</p>\n<p>我在网上寻找简单的方法但没找到，我想过将所有点都放到<a href="https://en.wikipedia.org/wiki/Octree" target="_blank" rel="nofollow noreferrer noopener">八叉树</a>中，让寻找匹配点速度快一些，但那似乎远离了本章的范围。</p>\n<p>然后我就想到既然只是终点问题我就可以进行模运算，让结果相等，原始代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44798122850594350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u);`, `44798122850594350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>新代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47475960486011400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);`, `47475960486011400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于模运算 endAngle 为 <code class="language-text">Math.PI * 2</code> 时 angle 就为 0，和起始点相同，接缝消失了，问题解决了！</p>\n<p>但是，即使这样当设置 distance 为 0.001 并且 divisions 为 60 时，在我的机子上还要几乎 1 秒钟的运算。这可能还有很多可以优化的地方，但创建复杂的网格是一个耗时的工作，这就是我的三维游戏可以以 60fps 运行，但是三维建模工具通常都是很低的帧率。</p>\n<h2 id="使用矩阵运算是不是大材小用了"><a href="#%E4%BD%BF%E7%94%A8%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E6%98%AF%E4%B8%8D%E6%98%AF%E5%A4%A7%E6%9D%90%E5%B0%8F%E7%94%A8%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用矩阵运算是不是大材小用了?</h2>\n<p>当我们旋转点的时候使用这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14576923395073882000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.yRotation(angle);\n// ...\npoints.forEach((p, ndx) => {\n  const tp = m4.transformPoint(mat, [...p, 0]);\n  // ...\n});`, `14576923395073882000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 4x4 矩阵转换一个任意三维点需要 16 次乘法，12 次加法，和 3 次除法。我们可以只使用单位圆形式的旋转运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16401046709057665000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const s = Math.sin(angle);\nconst c = Math.cos(angle);\n//...\npoints.forEach((p, ndx) => {\n  const x = p[0];\n  const y = p[1];\n  const z = p[2];\n  const tp = [x * c - z * s, y, x * s + z * c];\n  //...\n});`, `16401046709057665000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">//...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> x <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> y <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> z <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> c <span class="token operator">-</span> z <span class="token operator">*</span> s<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x <span class="token operator">*</span> s <span class="token operator">+</span> z <span class="token operator">*</span> c<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">//...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就只有 4 次乘法和 2 次加法，没有方法调用，应该至少要快 6 倍。</p>\n<p>这个优化值得么？当然，对于这个特殊的例子，我不认为这个有什么意义，我认为你可能需要让用户决定绕那个轴旋转，使用矩阵就可以让用户传入一个轴，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41849891025190035000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.axisRotation(userSuppliedAxis, angle);`, `41849891025190035000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">axisRotation</span><span class="token punctuation">(</span>userSuppliedAxis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>哪种方式更好其实取决于你自己和你的需求，我认为我会优先选择灵活的方式，然后运行太慢时再去考虑优化。</p>\n<h1 id="webgl-加载-obj-文件"><a href="#webgl-%E5%8A%A0%E8%BD%BD-obj-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载 .obj 文件</h1>\n<p>Wavefront 的 .obj 文件是网上最常用的 3D 文件格式。它们并不是难以解析的格式，所以让我们试试。这能够提供一个解析 3D 文件的有用例子。</p>\n<blockquote>\n<p>该 .obj 解析器不会面面俱到或者完美，也不保证能够处理所有 .obj 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n<p>我找到的有关 .obj 文件的<a href="http://paulbourke.net/dataformats/obj/" target="_blank" rel="nofollow noreferrer noopener">文档</a>。不过<a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000507.shtml" target="_blank" rel="nofollow noreferrer noopener">这里</a>链接了很多其它相关文档。</p>\n</blockquote>\n<h2 id="立方体"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体</h2>\n<p>让我们看一个简单的例子。下面是从 blender 默认场景中导出的 cube.obj：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62215748788808360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender v2.80 (sub 75) OBJ File: \'\'\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6`, `62215748788808360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="obj"\n              >\n                <span class="gatsby-code-button-language">obj</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="obj"><pre style="counter-reset: linenumber NaN" class="language-obj line-numbers"><code class="language-obj"># Blender v2.80 (sub 75) OBJ File: &#39;&#39;\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即使不看文档我们也能发现 v 开始的行表示顶点，vt 开始的行表示纹理坐标，vn 开始的行表示法线。接下来就是理解剩下的代表什么。</p>\n<p>看起来 .obj 文件是文本文件，所以我们要做的第一件事就是加载文本文件。幸运的是，如果使用 async/await 这将是一件很简单的事。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68693595791099150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // ...\n\n  const response = await fetch(\'resources/models/cube/cube.obj\');\n  const text = await response.text();\n}`, `68693595791099150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们可以一行一行地解析，每行都是下面的形式:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39527686044209060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`keyword data data data ...`, `39527686044209060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">keyword data data data ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>每行的开头是 keyword，data 由空格隔开。以 <code class="language-text">#</code> 开头的行是注释。</p>\n<p>接着，用代码来解析每一行，跳过空白行和注释，然后根据 keyword 调用对应的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17756431708628795000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  const keywords = {};\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword, \' at line\', lineNo + 1);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n}`, `17756431708628795000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> <span class="token string">\' at line\'</span><span class="token punctuation">,</span> lineNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我们去除了每行开头和结尾的空格。我不知道这是否有必要，但是我觉得没有坏处。我们用 <code class="language-text">/\\s+/</code> 将每行以空格分割。同样地我不知道这是否有必要，data 之间会有多于一个空格吗？是否可以是制表符？不知道，但是这样看起来更安全。</p>\n<p>另外，我们将每行的第一部分作为 keyword，然后找到对应的函数调用，并将 keyword 后面的 data 传给该函数。所以接下来我们只要完成这些函数。</p>\n<p>之前，我们猜测了 v，vt 和 vn 的含义。文档表明 f 代表“面”或多边形，每部分数据代表了顶点、纹理坐标以及法线。</p>\n<p>如果一个索引是正数，表示从序列 1 开始的偏移。如果索引是负数，表示从序列结尾开始的偏移。索引的顺序是：顶点/纹理坐标/法线，只有顶点是必要的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91142330830750190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引`, `91142330830750190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>f 可以有多于 3 个顶点，比如 4 个顶点代表四边形。WebGL 只能绘制三角形，所以需要将数据转换成三角形。标准并没有规定说一个面可以有多于 4 个顶点，也没有说面必须是凹的或凸的。但暂时让我们假设面是凹的。</p>\n<p>通常在 WebGL 中，我们不单独说明顶点、纹理坐标和法线，<code class="language-text">WebGL 顶点</code> 代表了包含了代表该顶点的顶点坐标、纹理坐标、法线的数据集合。例如，要绘制一个立方体，WebGL 需要 36 个顶点，每个面是两个三角形，每个三角形是 3 个顶点，6 个面每个面 2 个三角形，每个三角形 3 个顶点 = 36 个顶点。尽管一个立方体只有 8 个不重复的顶点和 6 条不重复的法线。所以，我们需要读取面的顶点索引来生成包含了顶点位置、纹理坐标、法线的 <code class="language-text">WebGL 顶点</code>。</p>\n<p>所以，根据上面的描述，我们可以像下面这样解析：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54147290176625295000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  function addVertex(vert) {\n    const ptn = vert.split(\'/\');\n    ptn.forEach((objIndexStr, i) => {\n      if (!objIndexStr) {\n        return;\n      }\n      const objIndex = parseInt(objIndexStr);\n      const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n      webglVertexData[i].push(...objVertexData[i][index]);\n    });\n  }\n\n  const keywords = {\n    v(parts) {\n      objPositions.push(parts.map(parseFloat));\n    },\n    vn(parts) {\n      objNormals.push(parts.map(parseFloat));\n    },\n    vt(parts) {\n      objTexcoords.push(parts.map(parseFloat));\n    },\n    f(parts) {\n      const numTriangles = parts.length - 2;\n      for (let tri = 0; tri < numTriangles; ++tri) {\n        addVertex(parts[0]);\n        addVertex(parts[tri + 1]);\n        addVertex(parts[tri + 2]);\n      }\n    }\n  };\n}`, `54147290176625295000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码创建了 3 个数组来保存从 object 文件中解析出来的顶点位置、纹理坐标和法线。同时创建了 3 个数组来保存 WebGL 的顶点。为了方便引用，数组的顺序和 f 中索引的顺序是一样的。</p>\n<p>例如下面的 f 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92773493195496340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1/2/3/ 4/5/6 7/8/9`, `92773493195496340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1/2/3/ 4/5/6 7/8/9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>像 4/5/6 表示对这个面的一个顶点使用“顶点 4”，“纹理坐标 5”，“法线 6”。我们将顶点、纹理坐标、法线数据放进 objVertexData 数组，这样就能简单的表示为：对 webglData 的第 i 项，使用 objData 第 i 个数组中的第 n 个元素。 这样会简化我们的代码。</p>\n<p>在函数的结尾返回我们构建的数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="190907918210836400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nreturn {\n  position: webglVertexData[0],\n  texcoord: webglVertexData[1],\n  normal: webglVertexData[2]\n};`, `190907918210836400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  texcoord<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  normal<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来要做的就是将数据绘制出来。首先我们使用三维方向光源中着色器的变体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40308280421982070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n\\`;`, `40308280421982070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用来自码少趣多中的代码加载模型</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35428309075531895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // 获取 WebGL 渲染上下文\n  /** @type {HTMLCanvasElement} */\n  const canvas = document.querySelector(\'#canvas\');\n  const gl = canvas.getContext(\'webgl\');\n  if (!gl) {\n    return;\n  }\n\n  // ... shaders ...\n\n  // 编译、链接着色器，查找属性和全局变量位置\n  const meshProgramInfo = webglUtils.createProgramInfo(gl, [vs, fs]);\n\n  const data = await loadOBJ(\'resources/models/cube/cube.obj\');\n\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n}`, `35428309075531895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取 WebGL 渲染上下文</span>\n  <span class="token comment">/** @type {HTMLCanvasElement} */</span>\n  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">\'webgl\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ... shaders ...</span>\n\n  <span class="token comment">// 编译、链接着色器，查找属性和全局变量位置</span>\n  <span class="token keyword">const</span> meshProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span>vs<span class="token punctuation">,</span> fs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadOBJ</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后绘制数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19295782205952050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cameraTarget = [0, 0, 0];\nconst cameraPosition = [0, 0, 4];\nconst zNear = 0.1;\nconst zFar = 50;\n\nfunction degToRad(deg) {\n  return (deg * Math.PI) / 180;\n}\n\nfunction render(time) {\n  time *= 0.001; // 转成秒\n\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n  gl.enable(gl.DEPTH_TEST);\n  gl.enable(gl.CULL_FACE);\n\n  const fieldOfViewRadians = degToRad(60);\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projection = m4.perspective(fieldOfViewRadians, aspect, zNear, zFar);\n\n  const up = [0, 1, 0];\n  // 通过 lookAt 计算 camera 矩阵\n  const camera = m4.lookAt(cameraPosition, cameraTarget, up);\n\n  // 通过 camera 矩阵创建 view 矩阵\n  const view = m4.inverse(camera);\n\n  const sharedUniforms = {\n    u_lightDirection: m4.normalize([-1, 3, 5]),\n    u_view: view,\n    u_projection: projection\n  };\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n  webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, {\n    u_world: m4.yRotation(time),\n    u_diffuse: [1, 0.7, 0.5, 1]\n  });\n\n  // 调用 gl.drawArrays or gl.drawElements\n  webglUtils.drawBufferInfo(gl, bufferInfo);\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `19295782205952050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token parameter">deg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>deg <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  time <span class="token operator">*=</span> <span class="token number">0.001</span><span class="token punctuation">;</span> <span class="token comment">// 转成秒</span>\n\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projection <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> zNear<span class="token punctuation">,</span> zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 通过 lookAt 计算 camera 矩阵</span>\n  <span class="token keyword">const</span> camera <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> cameraTarget<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 通过 camera 矩阵创建 view 矩阵</span>\n  <span class="token keyword">const</span> view <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sharedUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n    u_lightDirection<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> view<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projection\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能看到模型被加载和绘制。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5o1eof?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="椅子"><a href="#%E6%A4%85%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<p>关于未处理 keyword 的信息，它们是什么作用呢？</p>\n<p>usemtl 是这之中最重要的。它指明了后面出现的所有几何体都使用指定的材质。例如，你有一个车辆的模型，你可能会希望车窗是透明的，保险杠是金属反光的。窗是透明的，保险杠是反光的，所以它们需要和车体不一样的绘制方法。usemtl 标签标记了这部分信息。</p>\n<p>因为我们需要单独绘制这些部分，所以我们需要修改代码，每次遇到 usemtl 我们就创建一个新的 webgl 数据集。</p>\n<p>首先，添加代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56638964734412920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  const geometries = [];\n  let geometry;\n  let material = \'default\';\n\n  function newGeometry() {\n    // 如果有存在的几何体并且不是空的，销毁\n    if (geometry && geometry.data.position.length) {\n      geometry = undefined;\n    }\n  }\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n}`, `56638964734412920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{17-44}"\n              >\n                <span class="gatsby-code-button-language">js{17-44}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> geometries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> geometry<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果有存在的几何体并且不是空的，销毁</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry <span class="token operator">&amp;&amp;</span> geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        material<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          position<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          texcoord<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          normal</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着当我们在处理 keywords 的时候，在合适的地方调用它们，包括添加 o keyword 的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74401076065259210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nconst keywords = {\n  v(parts) {\n    objPositions.push(parts.map(parseFloat));\n  },\n  vn(parts) {\n    objNormals.push(parts.map(parseFloat));\n  },\n  vt(parts) {\n    objTexcoords.push(parts.map(parseFloat));\n  },\n  f(parts) {\n    setGeometry();\n    const numTriangles = parts.length - 2;\n    for (let tri = 0; tri < numTriangles; ++tri) {\n      addVertex(parts[0]);\n      addVertex(parts[tri + 1]);\n      addVertex(parts[tri + 2]);\n    }\n  },\n  usemtl(parts, unparsedArgs) {\n    material = unparsedArgs;\n    newGeometry();\n  }\n};\n\n// ...`, `74401076065259210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,22-25}"\n              >\n                <span class="gatsby-code-button-language">js{14,22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">usemtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>usemtl 不是必要的，如果在文件中没有 usemtl，我们想要有默认的几何体。所以在 f 函数中我们调用了 setGeometry 来创建。</p>\n<p>最后我们返回 geometries 对象数组，每个对象包含 name 和 data。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96792575553141160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// return {\n//   position: webglVertexData[0],\n//   texcoord: webglVertexData[1],\n//   normal: webglVertexData[2]\n// };\nreturn geometries;`, `96792575553141160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token comment">// return {</span>\n<span class="token comment">//   position: webglVertexData[0],</span>\n<span class="token comment">//   texcoord: webglVertexData[1],</span>\n<span class="token comment">//   normal: webglVertexData[2]</span>\n<span class="token comment">// };</span>\n<span class="token keyword">return</span> geometries<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，我们需要处理纹理坐标或法线缺失的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94232705040697930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 移除空数组\nfor (const geometry of geometries) {\n  geometry.data = Object.fromEntries(Object.entries(geometry.data).filter(([, array]) => array.length > 0));\n}\n\nreturn {\n  materialLibs,\n  geometries\n};`, `94232705040697930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-4}"\n              >\n                <span class="gatsby-code-button-language">js{1-4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 移除空数组</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> geometry <span class="token keyword">of</span> geometries<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  geometry<span class="token punctuation">.</span>data <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>geometry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token punctuation">,</span> array<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> array<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span>\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  materialLibs<span class="token punctuation">,</span>\n  geometries\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们继续 keywords，根据官方规范，mtllib 指定了包含材质信息的独立的一个或多个文件。不幸的是，在实际应用中，文件名中可以包含空格，但 .obj 格式中并没有提供逃逸字符来使用空格或引号。理想情况应该使用能解决这些问题的、良好定义的格式，比如 json、xml 或 yaml 等，但 .obj 格式诞生的比它们都早。</p>\n<p>稍后我们在处理加载文件。先让我们把它加到加载器里以便之后可以使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90212606829333230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  const materialLibs = [];\n\n  // ...\n\n  const keywords = {\n    // ...\n    mtllib(parts, unparsedArgs) {\n      materialLibs.push(unparsedArgs);\n    }\n    // ...\n  };\n\n  // return geometries;\n  return {\n    materialLibs,\n    geometries\n  };\n}`, `90212606829333230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,9-11,15-19}"\n              >\n                <span class="gatsby-code-button-language">js{3,9-11,15-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> materialLibs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">mtllib</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      materialLibs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// return geometries;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    materialLibs<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    geometries</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>o 指定表明了接下来的条目属于命名为 “object” 的对象。但我们并不清楚如何使用它。文件中能只包含 o 而没有 usemtl 吗？先假设可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74038208736562090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let material = \'default\';\n  let object = \'default\';\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  const keywords = {\n    // ...\n    o(parts, unparsedArgs) {\n      object = unparsedArgs;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `74038208736562090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,15,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{4,15,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        object<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">o</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      object <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>s 指定了一个 smoothing group。我觉得这是我们可以忽略的。它们通常在建模程序中用来自动生成顶点法线。顶点法线的计算，需要先计算每个面的法线，而每个面的法线可以很容易使用叉乘得到，这部分已经在三维相机中提到了。对于任意顶点，我们可以对该顶点所在的面取均值。但是有时我们想要一条边时，我们需要能够告诉程序忽略一些面。Smoothing groups 让我们指定计算顶点法线时哪些面需要被包含。关于如何计算几何体的顶点法线，可以看 <code class="language-text">WebGL 三维几何加工</code> 作为例子。</p>\n<p>在我们的例子中，我们先忽略它。假设大部分 .obj 文件内部都包含法线，所以一般不需要 smoothing groups。一般在模型库中才会有它，以便你想要编辑或重新生成法线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65350766260112920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const noop = () => {};\n\nconst keywords = {\n  // ...\n  s: noop\n  // ...\n};`, `65350766260112920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1,5}"\n              >\n                <span class="gatsby-code-button-language">js{1,5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  s<span class="token punctuation">:</span> noop</span>  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前为止我们还剩一个 keyword：g 代表组 (group)。通常它只是一些元数据。Objects 可以存在于多个 group 中。因为它会出现在我们接下来的文件中，所以我们先添加支持代码，尽管现在并不使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83457362051179540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let groups = [\'default\'];\n  // ...\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n\n  const keywords = {\n    // ...\n    g(parts) {\n      groups = parts;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `83457362051179540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,13,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{3,13,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'default\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>  <span class="token comment">// ...</span>\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">        groups<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">g</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      groups <span class="token operator">=</span> parts<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们创建了多个几何体的集合，我们需要改变我们的初始化代码来为每一个几何体创建 WebGLBuffers。同时我们也会创建一个随机的颜色，这样就能方便地分辨不同的部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49320395925592056000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/cube/cube.obj\');\nconst response = await fetch(\'resources/models/chair/chair.obj\');\nconst text = await response.text();\n// const data = parseOBJ(text);\nconst obj = parseOBJ(text);\n\nconst parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `49320395925592056000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,4-5,7,21-26}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,4-5,7,21-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/cube/cube.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// const data = parseOBJ(text);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    bufferInfo</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们从加载一个立方体换成了椅子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACsUlEQVQozy2S224TVxSG/S6ovUCCyomKgDgBYjsnJxkGxyGOj8GO7bE98YzHnoPHHh9iCCJULaVS1RsQFyBxi7jmqpX6BBWPwFt8XeNw8WvvLf37W/9ae0fW1xMoispxNk/lpIpWb3LW7mB2ulhGD7vbv5LZk7OFeWagt3TxaQt//rjAwaMM25s7xFbWiBw9zlJ5corePMOSS67tMfRGBP6Y+WhC7vJ3ErMXuLKf+kNGno/veLg9m57RlXs6p5XaAqwqj4jUqnWMMxOn7zLyA2bBjPlkzkUwwf/lFVsfPrH07Fcezy54NgqYBmOmso4FPnQHuJZNV+5rtQbFfIlI2F4ICwR2LrCnk3PmU1mHQ9yXr0j98YZop8fWQEDegLEknPojpsPRAjryrqCm3qFRrREJZzWwB0ykxZmkmn1PENgOwflT1l685prhcHf+EicE2H182yZwvQU8kJSDfti+SbuhCVDiej13MZuwYmgaCswzTWzHJXn5muvOmJgAy5Uq+smJJLLwRL6A/L54rT5Wx6BVbxDRtRa9jimmPgMZtGfJyxoGrtGRmeRRzi958Pw39v98R+nLv1TF57SaC48jRR3ToCcv32m2qUvBSLV8siAbrTbddhtL1G1qWC2NciZN6q/3JD7/Teqfr+z/943j+QWtfBa9VsNsNjFEer1OQ2DlfEG+zUGGUi7PaalMQ9ppPgkV7otouSyt8Zzs24+ogwkrqT2Wl5aIr94lndqmeJjhtFikUihQODoio8q32U5uoO7ucaiq5A7SFCVV8fBKOVUReJWSFDW0NncEduPHH7gVvcn2+n0yeymyaZWM8hBlZ4fNeJzIcjTK6p3bxNdW2RLTbmKdveSVlGSch1sbxH6Okt7dIR5bYfNejFT8Pspmkv2NhIAfSOJVYrdvsfzTTf4HbwfozfGzl/sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-a67b7.png 200w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-0b187.png 400w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png 800w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要渲染，我们只需要循环绘制每个部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30985728718229578000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 对整个空间矩阵进行一次计算\n  const u_world = m4.yRotation(time);\n\n  for (const { bufferInfo, material } of parts) {\n    // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // 调用 gl.uniform\n    webglUtils.setUniforms(meshProgramInfo, {\n      // u_world: m4.yRotation(time),\n      // u_diffuse: [1, 0.7, 0.5, 1],\n      u_world,\n      u_diffuse: material.u_diffuse\n    });\n    // 调用 gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  // ...\n}`, `30985728718229578000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9-10,12,17-20}"\n              >\n                <span class="gatsby-code-button-language">js{9-10,12,17-20}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 对整个空间矩阵进行一次计算</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_world: m4.yRotation(time),</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [1, 0.7, 0.5, 1],</span></span><span class="gatsby-highlight-code-line">      u_world<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> material<span class="token punctuation">.</span>u_diffuse</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3qq063?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我们试着把物体放中间是不是更好？</p>\n<p>为了把物体放中间我们需要计算物体的范围，即顶点的最小和最大位置。首先我们需要一个函数，计算给定多个位置中的最小和最大位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65638806147781940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getExtents(positions) {\n  const min = positions.slice(0, 3);\n  const max = positions.slice(0, 3);\n  for (let i = 3; i < positions.length; i += 3) {\n    for (let j = 0; j < 3; ++j) {\n      const v = positions[i + j];\n      min[j] = Math.min(v, min[j]);\n      max[j] = Math.max(v, max[j]);\n    }\n  }\n  return { min, max };\n}`, `65638806147781940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getExtents</span><span class="token punctuation">(</span><span class="token parameter">positions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> min <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> max <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> positions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> positions<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      min<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> min<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      max<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> max<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们遍历几何体的每个部分，并且得到对应的范围</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22692082649441915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getGeometriesExtents(geometries) {\n  return geometries.reduce(\n    ({ min, max }, { data }) => {\n      const minMax = getExtents(data.position);\n      return {\n        min: min.map((min, ndx) => Math.min(minMax.min[ndx], min)),\n        max: max.map((max, ndx) => Math.max(minMax.max[ndx], max))\n      };\n    },\n    {\n      min: Array(3).fill(Number.POSITIVE_INFINITY),\n      max: Array(3).fill(Number.NEGATIVE_INFINITY)\n    }\n  );\n}`, `22692082649441915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span><span class="token parameter">geometries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> geometries<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> minMax <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        min<span class="token punctuation">:</span> min<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>min<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        max<span class="token punctuation">:</span> max<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">max<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>max<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      min<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">POSITIVE_INFINITY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      max<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">NEGATIVE_INFINITY</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要计算物体的平移距离，以便能将它的中心放在原点，同时计算原点和 camera 的距离，保证能完全看到物体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14101236186885569000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const cameraTarget = [0, 0, 0];\n// const cameraPosition = [0, 0, 4];\n// const zNear = 0.1;\n// const zFar = 50;\nconst extents = getGeometriesExtents(obj.geometries);\nconst range = m4.subtractVectors(extents.max, extents.min);\n// 移动物体的距离，使得其中心在原点\nconst objOffset = m4.scaleVector(m4.addVectors(extents.min, m4.scaleVector(range, 0.5)), -1);\nconst cameraTarget = [0, 0, 0];\n// 计算移动 camera 的距离，以便我们能完全看到物体\nconst radius = m4.length(range) * 1.2;\nconst cameraPosition = m4.addVectors(cameraTarget, [0, 0, radius]);\n// 设置合适于物体大小的 zNear 和 zFar 值\nconst zNear = radius / 100;\nconst zFar = radius * 3;`, `14101236186885569000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const cameraTarget = [0, 0, 0];</span>\n<span class="token comment">// const cameraPosition = [0, 0, 4];</span>\n<span class="token comment">// const zNear = 0.1;</span>\n<span class="token comment">// const zFar = 50;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>geometries<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> range <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>max<span class="token punctuation">,</span> extents<span class="token punctuation">.</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 移动物体的距离，使得其中心在原点</span>\n<span class="token keyword">const</span> objOffset <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>min<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算移动 camera 的距离，以便我们能完全看到物体</span>\n<span class="token keyword">const</span> radius <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>cameraTarget<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 设置合适于物体大小的 zNear 和 zFar 值</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> radius <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> radius <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面，我们也设置了适合显示物体的 zNear 和 zFar 值。</p>\n<p>只需要使用 objOffset 来将物体平移到原点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9176761721333527000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将整个空间矩阵重新计算一次\nconst u_world = m4.yRotation(time);\nlet u_world = m4.yRotation(time);\nu_world = m4.translate(u_world, ...objOffset);`, `9176761721333527000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将整个空间矩阵重新计算一次</span>\n<span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\nu_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>u_world<span class="token punctuation">,</span> <span class="token operator">...</span>objOffset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zbrpfw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="书"><a href="#%E4%B9%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>书</h2>\n<p>有些非标准的 .obj 文件包含了顶点的颜色值，它们将额外的值放在了每个顶点位置的后面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42305296431964210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 标准\nv <x> <y> <z>\n// 非标准\nv <x> <y> <z> <red> <green> <blue>`, `42305296431964210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt;\n// 非标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt; &lt;red&gt; &lt;green&gt; &lt;blue&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由 <a href="https://sketchfab.com/homkahom0" target="_blank" rel="nofollow noreferrer noopener">Oleaf</a> 创建的 <a href="https://sketchfab.com/3d-models/book-vertex-chameleon-study-51b0b3bdcd844a9e951a9ede6f192da8" target="_blank" rel="nofollow noreferrer noopener">Book - Vertex chameleon study by CC-BY-NC</a> 使用了顶点颜色。</p>\n<p>让我们看看能不能添加代码来支持显示顶点颜色。</p>\n<p>我们需要在有顶点位置、法线和纹理坐标的地方添加一些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23990563765889660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n  const objColors = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals, objColors];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [], // 法线\n    [] // 颜色\n  ];\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      const color = [];\n      webglVertexData = [position, texcoord, normal, color];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal,\n          color\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n}`, `23990563765889660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6,9,16,26-27,36}"\n              >\n                <span class="gatsby-code-button-language">js{6,9,16,26-27,36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objColors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">,</span> objColors<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 法线</span>\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 颜色</span></span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">,</span> color<span class="token punctuation">]</span><span class="token punctuation">;</span></span>      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n        groups<span class="token punctuation">,</span>\n        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">          color</span>        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这使得我们的代码有一点不通用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90019844684734580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const keywords = {\n  v(parts) {\n    // objPositions.push(parts.map(parseFloat));\n    // 如果超过 3 个值，就是顶点颜色\n    if (parts.length > 3) {\n      objPositions.push(parts.slice(0, 3).map(parseFloat));\n      objColors.push(parts.slice(3).map(parseFloat));\n    } else {\n      objPositions.push(parts.map(parseFloat));\n    }\n  }\n  // ...\n};`, `90019844684734580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-10}"\n              >\n                <span class="gatsby-code-button-language">js{3-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// objPositions.push(parts.map(parseFloat));</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果超过 3 个值，就是顶点颜色</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      objColors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当我们读取到 f 面的时候，调用 addVertex，我们需要获取顶点的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11598866580617374000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  ptn.forEach((objIndexStr, i) => {\n    if (!objIndexStr) {\n      return;\n    }\n    const objIndex = parseInt(objIndexStr);\n    const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n    webglVertexData[i].push(...objVertexData[i][index]);\n    // 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中\n    if (i === 0 && objColors.length > 1) {\n      geometry.data.color.push(...objColors[index]);\n    }\n  });\n}`, `11598866580617374000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-13}"\n              >\n                <span class="gatsby-code-button-language">js{10-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> objColors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objColors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要更改我们的着色器来使用顶点颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95676913664833240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n      vec4 diffuse = u_diffuse * v_color;\n      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n   }\n\\`;`, `95676913664833240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,11,16,24,32-34}"\n              >\n                <span class="gatsby-code-button-language">js{4,11,16,24,32-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec4 a_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      gl_Position = u_projection * u_view * u_world * a_position;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_color = a_color;</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision mediump float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform vec4 u_diffuse;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>就如上面提到的，我不确定这个非标准版本的 .obj 文件能否在每个顶点颜色中包含 alpha 值。我们的 helper library 根据我们传入的数据自动创建缓冲区。它假设每个元素有多少个组成部分。对于名字中包含 position 或 normal 的，默认每个元素包含 3 个组成部分。对于名字中包含 texcoord 的，默认每个元素 2 个组成部分。其它的每个元素默认 4 个组成部分。这样的话，如果我们的颜色仅包含 r、g、b，每个元素三个组成部分，我们需要传参给它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70525254091179800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.position.length === data.color.length) {\n    // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n    data.color = { numComponents: 3, data: data.color };\n  }\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `70525254091179800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-16}"\n              >\n                <span class="gatsby-code-button-language">js{13-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也希望能够处理更常见的没有顶点颜色的情况。在 WebGL 基础概念和 WebGL 属性中我们提到了属性通常从缓冲中获取值。但我们也可以将属性设置成常量。没有的值使用默认常量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95679845966715910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.disableVertexAttribArray(someAttributeLocation); // 使用常量\nconst value = [1, 2, 3, 4];\ngl.vertexAttrib4fv(someAttributeLocation, value); // 使用给定的值`, `95679845966715910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">disableVertexAttribArray</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用常量</span>\n<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttrib4fv</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用给定的值</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果将属性的值设为 <code class="language-text">{value:[1, 2, 3, 4]}</code>，我们的 helper library 为我们处理了这种情况。当检查到没有顶点颜色时，默认将顶点颜色属性设置成白色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49542710243372910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.color) {\n    if (data.position.length === data.color.length) {\n      // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n      data.color = { numComponents: 3, data: data.color };\n    }\n  } else {\n    // 没有顶点颜色，使用白色\n    data.color = { value: [1, 1, 1, 1] };\n  }\n\n  // ...\n});`, `49542710243372910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13,18-21}"\n              >\n                <span class="gatsby-code-button-language">js{13,18-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>color<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span>\n      data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有顶点颜色，使用白色</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也不能使用随机颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84442647620712270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // ...\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      // u_diffuse: [Math.random(), Math.random(), Math.random(), 1],\n      u_diffuse: [1, 1, 1, 1]\n    },\n    bufferInfo\n  };\n});`, `84442647620712270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{8-9}"\n              >\n                <span class="gatsby-code-button-language">js{8-9}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [Math.random(), Math.random(), Math.random(), 1],</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能带顶点颜色的 .obj 文件了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/761hg3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>至于解析和使用材质，看下一篇。</p>\n<h2 id="一些注意点"><a href="#%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一些注意点</h2>\n<ul>\n<li>\n<p>这个加载器是不完整的</p>\n<p>你可以阅读更多关于 .obj 格式。有大量的功能上面的代码是不支持的。同时，代码也没有经过大量 .obj 文件的测试，所以可能有很多未知的 bug。也就是说，我假设了大多数在线的 .obj 文件只使用了上面提到的功能，所以这部分代码说不定是一个有用的例子。</p>\n</li>\n<li>\n<p>这个加载器没有进行错误检查</p>\n<p>例如：vt 可以有 3 个值而不仅仅是 2 个。3 个值是给 3D 纹理使用的，不普遍所以我没有处理。如果你确实想要用它解析 3D 纹理座标，你需要修改着色器来处理 3D 纹理，修改生成 WebGLBuffers (调用 createBufferInfoFromArrays)的代码，告诉它每个 UV 座标有 3 个组成部分。</p>\n</li>\n<li>\n<p>假设数据是一致的</p>\n<p>我不知道是否会出现同一个文件中一些 f 有 3 个条目而另一些只有 2 个条目会。如果有可能，上面的代码没有处理这种情况。</p>\n<p>这段代码同样假设了所有顶点座标都有 x、y、z。如果出现有些顶点座标有 x、y、z，有些顶点座标只有 x、y，而有些则有 x、y、z、r、g、b，我们需要重构代码。</p>\n</li>\n<li>\n<p>可以将所有数据放进一个缓冲里</p>\n<p>上面的代码将顶点位置、纹理座标、法线放进了不同的缓冲。你也可以将它们交错的放进一个缓冲中：pos, uv, nrm, pos, uv, nrm, … 这样的话就需要改变设置属性的方式。</p>\n<p>更进一步，你甚至可以将所有部分的所有数据放进同一个缓冲里，而不是每个部分、每个类型的数据一个缓冲。</p>\n<p>我不考虑这些因为我觉得它们没有那么重要，同时它们也会使得代码变得复杂。</p>\n</li>\n<li>\n<p>可以重建顶点的索引</p>\n<p>上面的代码将顶点展开放进了三个数组中。我们可以重建顶点的索引。尤其当我们将所有顶点数据放进一个共享的缓冲中，或至少每个类型有一个单独的共享缓冲时，对于每个 f 面，可以将索引转换到一个正数（负数变换到正确的正数），那么对于每个顶点，数据集就变成了一个或多个 id。所以，只要记下 id 到索引的映射关系就能查找到对应的索引。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8261510539688288000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const idToIndexMap = {};\nconst webglIndices = [];\n\nfunction addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  // 首先将所有索引转换成正数\n  const indices = ptn.forEach((objIndexStr, i) => {\n     if (!objIndexStr) {\n        return;\n     }\n     const objIndex = parseInt(objIndexStr);\n     return objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n  });\n  // 现在检查已存在的顶点位置、纹理座标、法线组合\n  const id = indices.join(\',\');\n  let vertIndex = idToIndexMap[id];\n  if (!vertIndex) {\n     vertIndex = webglVertexData[0].length / 3;\n     idToIndexMap[id] = vertexIndex;\n     indices.forEach((index, i) => {\n        if (index !== undefined) {\n        webglVertexData[i].push(...objVertexData[i][index]);\n        }\n     })\n  }\n  webglIndices.push(vertexIndex);\n}`, `8261510539688288000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> idToIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webglIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 首先将所有索引转换成正数</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span>\n     <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token keyword">return</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 现在检查已存在的顶点位置、纹理座标、法线组合</span>\n  <span class="token keyword">const</span> id <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vertIndex <span class="token operator">=</span> idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vertIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vertIndex <span class="token operator">=</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n     idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> vertexIndex<span class="token punctuation">;</span>\n     indices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  webglIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vertexIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者，如果你觉得重要你可以重排索引。</p>\n</li>\n<li>\n<p>这段代码没有处理只有顶点座标，或只有顶点座标和纹理座标的情况</p>\n<p>这段代码假设法线存在。就像我们在三维几何加工里做的，如果法线不存在，我们可以生成它，考虑到如果我们需要 smoothing group。或者我们也可以不使用也不计算法线的不同着色器。</p>\n</li>\n<li>\n<p>你不应该使用 .obj 文件</p>\n<p>老实说，我认为你不应该使用 .obj 文件。我写这篇文章是作为一个例子。如果你可以从一个文件中获取顶点数据，你可以为任意格式的文件写导入器。</p>\n<p>.obj 文件的问题包括：</p>\n<ul>\n<li>\n<p>不支持光线或视角</p>\n<p>如果你加载大量部件（比如景观中的树、灌木、石头），你不需要视角或光线，这可能没问题。但文件如果提供选项让你能够原样导入作者创建的整个场景会更好。</p>\n</li>\n<li>\n<p>没有层级，没有场景图</p>\n<p>如果你想要导入一辆车，你会希望车轮能够转向，并能够绕着中心点旋转。这对 .obj 文件来说是不可能的，因为 .obj 不包含场景图。更好的文件格式包含这些数据，如果你想要能够旋转的部件、滑动窗户、开门、移动角色的腿等，这会很有用。</p>\n</li>\n<li>\n<p>不支持动画或蒙皮</p>\n<p>相比于其它的，我们更想要蒙皮，但 .obj 并没有蒙皮或者动画相关内容。如果你不需要这些，可能没什么问题。但我更偏向一种能包含更多内容的格式。</p>\n</li>\n<li>\n<p>.obj 不支持更多现代的材质</p>\n<p>材质一般来说针对于特定的引擎，但至少对于一些基于物理的材质渲染各引擎是共通的，据我所知 .obj 文件并不支持。</p>\n</li>\n<li>\n<p>.obj 需要解析</p>\n<p>除非你在写一个通用的查看器让用户上传 .obj 文件，通常最佳的做法是使用一个不太需要解析的文件格式。.gltf 是一种为 WebGL 设计的文件格式。它使用 JSON，你可以轻松地加载。对于二进制数据，它使用能直接加载进 GPU 的格式，一般不需要将数字解析成数组。</p>\n<p>如果你想使用 .obj 文件，最佳实践是先将它转换成其它文件格式，然后在你的页面中使用。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id="webgl-加载带-mtl-的-obj"><a href="#webgl-%E5%8A%A0%E8%BD%BD%E5%B8%A6-mtl-%E7%9A%84-obj" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载带 Mtl 的 Obj</h1>\n<p>在上一节我们解析了 .obj 文件，在本节让我们解析它的补充文件：.mtl 材质文件。</p>\n<h2 id="椅子-1"><a href="#%E6%A4%85%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<blockquote>\n<p>该 .mtl 解析器不会面面俱到或者完美，也不保证能够处理所有 .mtl 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n</blockquote>\n<p>我们加载了我在 <a href="https://sketchfab.com/" target="_blank" rel="nofollow noreferrer noopener">Sketchfab</a> 上找到的，由 haytonm 创建的<a href="https://sketchfab.com/3d-models/chair-aa2acddb218646a59ece132bf95aa558" target="_blank" rel="nofollow noreferrer noopener">椅子</a>。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACsUlEQVQozy2S224TVxSG/S6ovUCCyomKgDgBYjsnJxkGxyGOj8GO7bE98YzHnoPHHh9iCCJULaVS1RsQFyBxi7jmqpX6BBWPwFt8XeNw8WvvLf37W/9ae0fW1xMoispxNk/lpIpWb3LW7mB2ulhGD7vbv5LZk7OFeWagt3TxaQt//rjAwaMM25s7xFbWiBw9zlJ5corePMOSS67tMfRGBP6Y+WhC7vJ3ErMXuLKf+kNGno/veLg9m57RlXs6p5XaAqwqj4jUqnWMMxOn7zLyA2bBjPlkzkUwwf/lFVsfPrH07Fcezy54NgqYBmOmso4FPnQHuJZNV+5rtQbFfIlI2F4ICwR2LrCnk3PmU1mHQ9yXr0j98YZop8fWQEDegLEknPojpsPRAjryrqCm3qFRrREJZzWwB0ykxZmkmn1PENgOwflT1l685prhcHf+EicE2H182yZwvQU8kJSDfti+SbuhCVDiej13MZuwYmgaCswzTWzHJXn5muvOmJgAy5Uq+smJJLLwRL6A/L54rT5Wx6BVbxDRtRa9jimmPgMZtGfJyxoGrtGRmeRRzi958Pw39v98R+nLv1TF57SaC48jRR3ToCcv32m2qUvBSLV8siAbrTbddhtL1G1qWC2NciZN6q/3JD7/Teqfr+z/943j+QWtfBa9VsNsNjFEer1OQ2DlfEG+zUGGUi7PaalMQ9ppPgkV7otouSyt8Zzs24+ogwkrqT2Wl5aIr94lndqmeJjhtFikUihQODoio8q32U5uoO7ucaiq5A7SFCVV8fBKOVUReJWSFDW0NncEduPHH7gVvcn2+n0yeymyaZWM8hBlZ4fNeJzIcjTK6p3bxNdW2RLTbmKdveSVlGSch1sbxH6Okt7dIR5bYfNejFT8Pspmkv2NhIAfSOJVYrdvsfzTTf4HbwfozfGzl/sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-a67b7.png 200w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-0b187.png 400w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png 800w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它有一个相应的 .mtl 文件，看起来是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63028393299143740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'None\'\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质`, `63028393299143740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;None&#39;\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看对 <a href="http://paulbourke.net/dataformats/mtl/" target="_blank" rel="nofollow noreferrer noopener">.mtl 文件格式</a>的描述，我们可以看到以关键词 newmtl 和给定名字开头的新材质，下面是该材质的所有设置。每行都以关键词开始，这和 .obj 文件类似，所以我们可以用类似的方法来开始解析。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72462762246343025000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    }\n  };\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n\n  return materials;\n}`, `72462762246343025000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们只需要为每个关键词添加对应的方法。文档指出：</p>\n<ul>\n<li>Ns 是关于点光源的文章中提到的镜面光泽设置</li>\n<li>Ka 是材质的环境光</li>\n<li>Kd 是散射光，这是在关于点光源的文章中的颜色</li>\n<li>Ks 是镜面光</li>\n<li>Ke 是放射光</li>\n<li>Ni 是光学密度。我们这里不使用</li>\n<li>d 代表“溶解”，代表透明度</li>\n<li>illum 指定了材质的光照模型。文档中列出了 11 种类型。我们先忽略它</li>\n</ul>\n<p>我在犹豫是否要保持这些名字的原样。我想一个数学人喜欢简短的名字。但是大多数代码风格指南都喜欢描述性的名字，所以我决定这么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59643929921388470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  //  ...\n\n  return materials;\n}`, `59643929921388470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-33}"\n              >\n                <span class="gatsby-code-button-language">js{10-33}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">//  ...</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也在犹豫要不要推测每个 .mtl 文件的路径，或者手动指定。我们可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36613529874936558000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToMTLFile);`, `36613529874936558000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToMTLFile<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>或者这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94973923158646260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToOBJFile, obj);`, `94973923158646260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我选择后者，但是我也不确定是好是坏。根据文档一个 .obj 文件可以包含多个 .mtl 文件的引用。我从没见过这样的例子，但我想文档的作者是这么做的。</p>\n<p>并且我也没有见过 .mtl 文件与 .obj 文件命名不同的。换句话说，如果 .obj 文件是 bananas.obj，那么 .mtl 文件几乎总是 bananas.mtl。</p>\n<p>也就是说，规范指出 .mtl 文件是在 .obj 文件中指定的，所以我决定试着计算 .mtl 文件的路径。</p>\n<p>从上节的代码开始, 我们将 .obj 文件的 URL 提取出来，然后构建 .obj 相关的 .mtl 文件的 URL。最后我们将它们全部加载，连接起来（因为它们都是文本文件），然后传给解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80897018509098830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/chair/chair.obj\');\nconst objHref = \'resources/models/chair/chair.obj\';\nconst response = await fetch(objHref);\nconst text = await response.text();\nconst obj = parseOBJ(text);\nconst baseHref = new URL(objHref, window.location.href);\nconst matTexts = await Promise.all(\n  obj.materialLibs.map(async (filename) => {\n    const matHref = new URL(filename, baseHref).href;\n    const response = await fetch(matHref);\n    return await response.text();\n  })\n);\nconst materials = parseMTL(matTexts.join(\'\\n\'));`, `80897018509098830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-3,6-14}"\n              >\n                <span class="gatsby-code-button-language">js{1-3,6-14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/chair/chair.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> objHref <span class="token operator">=</span> <span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>objHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> baseHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>objHref<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> matTexts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  obj<span class="token punctuation">.</span>materialLibs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> matHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>matHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span>matTexts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们来使用材质。首先，当我们在设置每个部分的时候，我们需要使用从 .obj 文件中提取出来的材质名称，然后从刚才加载的材质中查找。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31976694298205400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const parts = obj.geometries.map(({data}) => {\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    //  material: {\n    //    u_diffuse: [1, 1, 1, 1],\n    //  },\n    material: materials[material],\n    bufferInfo\n  };\n});`, `31976694298205400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,9-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,9-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const parts = obj.geometries.map(({data}) => {</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//  material: {</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//    u_diffuse: [1, 1, 1, 1],</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//  },</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们在渲染时，我们需要传不止一组全局变量值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1117414246983949800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  for (const { bufferInfo, material } of parts) {\n    // calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // calls gl.uniform\n    webglUtils.setUniforms(\n      meshProgramInfo,\n      {\n        u_world\n        // u_diffuse: material.u_diffuse,\n        //  });\n      },\n      material\n    );\n    // calls gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  requestAnimationFrame(render);\n}`, `1117414246983949800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-16}"\n              >\n                <span class="gatsby-code-button-language">js{12-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// calls gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>\n      meshProgramInfo<span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        u_world\n<span class="gatsby-highlight-code-line">        <span class="token comment">// u_diffuse: material.u_diffuse,</span></span><span class="gatsby-highlight-code-line">        <span class="token comment">//  });</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      material</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token comment">// calls gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要修改着色器。因为材质有镜面设置，我们添加像关于点光源的文章中一样的镜面计算，除了一点不同，我们计算镜面光是根据方向光源，而不是点光源。</p>\n<p>ambient 和 emissive 可能需要解释一下。ambient 是材质在无方向光源下的反射颜色。如果我们想看到它，我们可以乘上 <code class="language-text">u_ambientLight</code> 并设置黑色以外的颜色。这像把东西冲洗干净。</p>\n<p>emissive 是材质自身发光的颜色，与所有光照无关，所以我们只要加上它就好。如果你想有块地方发光，你可能会用到 emissive。</p>\n<p>这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11654143696171416000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   void main() {\n      // gl_Position = u_projection * u_view * a_position;\n      vec4 worldPostion = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   // uniform vec4 u_diffuse;\n   uniform vec3 diffuse;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec4 diffuse = u_diffuse * v_color;\n      vec3 effectiveDiffuse = diffuse * v_color.rgb;\n      float effectiveOpacity = opacity * v_color.a;\n      \n      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n      gl_FragColor = vec4(\n            emissive +\n            ambient * u_ambientLight +\n            effectiveDiffuse * fakeLight +\n            specular * pow(specularLight, shininess),\n            effectiveOpacity);\n   }\n\\`;`, `11654143696171416000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}"\n              >\n                <span class="gatsby-code-button-language">js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_viewWorldPosition;</span></span><span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_Position = u_projection * u_view * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 worldPostion = u_world * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span></span><span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="gatsby-highlight-code-line"><span class="token string">   // uniform vec4 u_diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 ambient;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 emissive;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 specular;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float shininess;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float opacity;</span></span><span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_ambientLight;</span></span><span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span></span><span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * v_color.a;</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(</span></span><span class="gatsby-highlight-code-line"><span class="token string">            emissive +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            ambient * u_ambientLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveDiffuse * fakeLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveOpacity);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们得到了和上面图片看起来差不多的效果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/e8w4o8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="风车"><a href="#%E9%A3%8E%E8%BD%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>风车</h2>\n<p>让我们来加载 .mtl 文件中引用纹理的 .obj 文件。</p>\n<p>我发现了由 <a href="https://www.blendswap.com/user/ahedov" target="_blank" rel="nofollow noreferrer noopener">ahedov</a> 创建的<a href="https://blendswap.com/blend/9755" target="_blank" rel="nofollow noreferrer noopener">风车</a> 3D 模型。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 440px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/klEQVQ4y41Uy5LSQBTll9y48FE15chYw8tBCA6BGQKBEEKSSSAh9AuSTneD47jQhZaWCy1/1PZRlpKA3EUvuuvcc+4993YhPRhciCSJEYhSxrKvhf1AyjhHy4Vx2ZhoVzKLvDkaTCnnHESLkVJzh5pMdDzzD5FCHowBx4TelFLKMspzwUyw5E6gzXpGljfIt5A7kcwYQc+2pH6ZaB+YURqn2EuhgwPTHnfUZtnovmRiYw/7rn7NuNjPzBiNMfCNyDOWvhG4w3ajrLUVHIVO75KEs7/bniNb1oaCiWeqM7vvW72LcrHZqAeOlWC4Y1hezYynyGZwFANzbqu1Zw8r52cQQpFxq5ClXceJbQ1goFcrp4Za01sXvmOjcJ51K4c5oalpaNNBs/L0xOkp4bQPotDUur/8+w9YGvFmi1eeZrWb2NXfvkYEo0GrTiDYIc+RLWu+sUfEv8aW/u3D9vN7QTD2+p0VjA6BJZIQAgBo1Ktap6Yqja+fNl8+bghCcO5xvl+2nBvZzzAMKufFsyePS8VHvSvl3R16xReEoD9TdbjmpFo6fXD/3ot6aeaPMfZvb2Mh8hdgFyyluVP9ebXY7SoAeIKjlJF1HOetc7ZhKUVLr99Tmy1lbJmzMFjiNRfb7DLvsSrBCVkAhNE6WSU/By49Tvbv+WTyJ8hV+k98B4aURrgdGswMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 30 11 25 00" title="" data-src="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png" data-srcset="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-add0a.png 200w,\n/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-7a35e.png 400w,\n/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png 440w" data-sizes="(max-width: 440px) 100vw, 440px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它的 .mtl 文件看起来是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63880818789218890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'windmill_001.blend\'\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg`, `63880818789218890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;windmill_001.blend&#39;\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看到 <code class="language-text">map_Kd</code>，<code class="language-text">map_Bump</code> 和 <code class="language-text">map_Ns</code> 都指定了图片文件。让我们把它们加入到我们的 <code class="language-text">.mtl</code> 解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25134894407606900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMapArgs(unparsedArgs) {\n  // 处理可选项\n  return unparsedArgs;\n}\n\nfunction parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    map_Kd(parts, unparsedArgs) {\n      material.diffuseMap = parseMapArgs(unparsedArgs);\n    },\n    map_Ns(parts, unparsedArgs) {\n      material.specularMap = parseMapArgs(unparsedArgs);\n    },\n    map_Bump(parts, unparsedArgs) {\n      material.normalMap = parseMapArgs(unparsedArgs);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  // ...\n}`, `25134894407606900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{30-38}"\n              >\n                <span class="gatsby-code-button-language">js{30-38}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span><span class="token parameter">unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理可选项</span>\n  <span class="token keyword">return</span> unparsedArgs<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">map_Kd</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuseMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Ns</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specularMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Bump</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>normalMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我写了 parseMapArgs，因为根据这份<a href="http://paulbourke.net/dataformats/mtl" target="_blank" rel="nofollow noreferrer noopener">规范</a>，还有很多额外的可选项我们没有在这个文件中看到。我们需要重构代码才能使用它们。但现在我们只处理带空格的文件名，不处理可选项。</p>\n<p>为了加载所有的纹理，我们会使用来自关于纹理的文章的代码，稍作修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20318531018468280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function create1PixelTexture(gl, pixel) {\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array(pixel));\n  return texture;\n}\n\nfunction createTexture(gl, url) {\n  const texture = create1PixelTexture(gl, [128, 192, 255, 255]);\n  // 异步加载图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 图片加载完成后复制到纹理\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n\n    // 检查图片在每个维度都为 2 的幂\n    if (isPowerOf2(image.width) && isPowerOf2(image.height)) {\n      // Yes, it\'s a power of 2. Generate mips.\n      gl.generateMipmap(gl.TEXTURE_2D);\n    } else {\n      // No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    }\n  });\n  return texture;\n}`, `20318531018468280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> pixel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 图片加载完成后复制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 检查图片在每个维度都为 2 的幂</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Yes, it\'s a power of 2. Generate mips.</span>\n      gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个材质可能引用同一张图片，所以我们将所有的纹理根据名字保存在对象中，这样就不用加载两次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65025972559656520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {};\n\n// 为材质加载纹理\nfor (const material of Object.values(materials)) {\n  Object.entries(material)\n    .filter(([key]) => key.endsWith(\'Map\'))\n    .forEach(([key, filename]) => {\n      let texture = textures[filename];\n      if (!texture) {\n        const textureHref = new URL(filename, baseHref).href;\n        texture = createTexture(gl, textureHref);\n        textures[filename] = texture;\n      }\n      material[key] = texture;\n    });\n}`, `65025972559656520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 为材质加载纹理</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> material <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'Map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> filename<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> texture <span class="token operator">=</span> textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> textureHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n        texture <span class="token operator">=</span> <span class="token function">createTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureHref<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      material<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码遍历了每个材质的每个属性。如果属性以 “Map” 结尾，就创建相对 URL，创建纹理，然后分配材质，我们将异步加载图片到纹理中。</p>\n<p>我们也会放一个单独的白像素纹理，给那些没有引用纹理的材质。这样我们就可以使用同一个着色器了。否则，我们需要不同的着色器，一个处理带纹理的材质，一个处理不带纹理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6617386661314551000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const textures = {};\nconst textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255])\n};`, `6617386661314551000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const textures = {};</span>\n<span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给材质的其它参数设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1752463411772864300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  shininess: 400,\n  opacity: 1\n};\n\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    // material: materials[material],\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo\n  };\n});`, `1752463411772864300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-21}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  opacity<span class="token punctuation">:</span> <span class="token number">1</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// material: materials[material],</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要使用纹理，我们要修改着色器。我们一个一个来处理。我们先来使用漫反射贴图。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22285469988700090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   # version 300 es\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;\n      // float effectiveOpacity = v_color.a * opacity;\n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         specular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `22285469988700090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,22,33,37,55-59}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,22,33,37,55-59}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec2 a_texcoord;</span></span><span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_texcoord = a_texcoord;</span></span><span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   # version 300 es</span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D diffuseMap;</span></span><span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      // float effectiveOpacity = v_color.a * opacity;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span></span><span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         specular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0227gc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>回头看 .mtl 文件，我们看到 <code class="language-text">map_Ks</code> 基本是黑白的纹理，它指定了特定表面的光泽度，或者也可以说是多少镜面反射的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 510px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100.19607843137254%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAABMElEQVQ4y51UOY6EQAzkvna5xJUgkZFAgkiQCPn/n6YaN5bVo4HZrQCZxuXy1VhN08Rx/CPwe+LdplfpaSVJYv0bTLZtG0/E7rrOvvCJ5TiO+mqQsywbhuEbVeWvUr+YLGVovqeA7CCuya7rUp7OBabB9jwPDjLQPM9osyJzhe4JXY8g07nMblmWfd+1MjyCIPB93zvBfsSUfPo0TdO2bbphnJVRqqFJ4WCv63och1KWBUPcKJjJzIfRtu04jmqwpEBdQfJMJkO2wAQpg/mn1dIppGlKsWlCwQk++aSpyTQq8pONoVoelFHzzQI/lENzpm7xbsmFeb5VYRjySHkrMLavriSTZQgc3txKhTzPoyii3SQ1vBIZhw/kqqrwJyqKgoZUlmXf9+gigtZ1fdNw4AX2BRFN5YBDrgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 17 41 33" title="" data-src="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png" data-srcset="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-931d4.png 200w,\n/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-3a665.png 400w,\n/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png 510w" data-sizes="(max-width: 510px) 100vw, 510px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了使用它，只需要更新着色器，因为我们已经加载了全部的纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11134954280421460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         // specular * pow(specularLight, shininess),\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `11134954280421460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,28-29,39-40}"\n              >\n                <span class="gatsby-code-button-language">js{14,28-29,39-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D specularMap;</span></span><span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span></span><span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="gatsby-highlight-code-line"><span class="token string">         // specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span></span><span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给没有高光贴图的材质设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38538557523260370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};`, `38538557523260370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6}"\n              >\n                <span class="gatsby-code-button-language">js{6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span>  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据 <code class="language-text">.mtl</code> 文件中的材质设置，很难看到什么效果。让我们来修改下镜面设置，这样就好了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32605876509938050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// hack the materials so we can see the specular map\nObject.values(materials).forEach((m) => {\n  m.shininess = 25;\n  m.specular = [3, 2, 1];\n});`, `32605876509938050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// hack the materials so we can see the specular map</span>\nObject<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  m<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>\n  m<span class="token punctuation">.</span>specular <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，只有窗和叶片被设置成反射高光了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i4ui4n?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我很奇怪叶片被设置成了反光。如果你检查 .mtl 文件，你会发现光泽度 Ns 被设置成了 0.0，也就是几乎不反光。但同时，所有材质的 illum 被设置成了 1。根据文档，照度模型为 1 意味着：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75565907900777760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }`, `75565907900777760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>更通俗的说：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20821496929459294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和`, `20821496929459294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>你可以看到并没有用到镜面反射，但文件里却有镜面贴图！镜面高光需要照度模型为 2 或以上。这是一些关于 <code class="language-text">.obj/.mtl</code> 文件的经验，你总是需要对材质做一些手动调整。如何解决这些问题取决于你。你可以编辑 .mtl 文件，或者添加代码。而我们现在会添加一些代码。</p>\n<p>最后一个 .mtl 文件使用贴图的是凹凸贴图：map_Bump。这又是一个可以看出 <code class="language-text">.obj/.mtl</code> 文件古老的地方。引用的只是法线贴图，并不是凹凸贴图。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 508px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.60629921259843%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACa0lEQVQ4y31UyXbkIAz0ZxsMSQzY35pJejIvvXjpC1MlyUsOM4d6YDBSqUrQ+DzXrszVA122Ub4XjA+MUw1AB3gbg+G8t6HpMg4SxcYz0qwBMqEJA9YVs/03yboCAT0WfZ6M4bRvSHbO0ySBgyU5j6GsOhcyFjDkp2WyLFLGIglCOTNad3TEvrdako3hAAajgTrkTS/qdxeWYZNkuAO3Gob5SFBWZWgVNm2+4+A3yr4CDyv7IXOPvSisl9qWa3X5grUPBPhd4zAdJZuWYTPFv001pqU6sOrKTdwNpmHMXL8BfySYz+/AL+x/yZ4wF4kY8FGbCA2ZyQ0IllBSz9GAH+KAPTAlu47B0qW6/hP7F0usbntheIcp5YlgKA2BYlprxDdBs3yvpbB8l7+E4UuGhmm1ddN90HkAoaalFumGIMgyoqFHMBuvNcCkODDzogYl6Jw+UCaNWXbjhKUEnrVk6TNstnDPZxzqceDtitLvYgoP0KTIVknbt90YaX6ym62drG3oYGDJPdlab6Esj4Z2wki17KC1NzaqmTa3z9Y2gLRNSFcwoBbz3ovBBHei3ze0m3bxfdIbRW0DOoAEnEhAU6wUaWCwi6cbwW8vjt8QUG/IxnC7GUKGxsocGlLYSEFR0g+UY+5NcHV/3a+ctFx+7gRIpmFGoUuHB4WUDm3doOvdOMuN4eGtrSR4YZudWg2Qxm6TvTT9pK4lTRI4Jn2+XuTePn9IEnd2z4MhI7dkVuyBMGZba7Q2f6WjwlAPnpme0UiJfAj6g6Hrp/1hdb0yjfLuGZN/BJOATl6To+PJVDRlqcZWDVGGofw/4F/hE52zqm4A9QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 18 04 45" title="" data-src="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" data-srcset="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-7e12f.png 200w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-6877e.png 400w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png 508w" data-sizes="(max-width: 508px) 100vw, 508px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>.mtl 文件中并没有选项指定将凹凸贴图用作法线贴图。我们可以启发性的假设文件名中有个 <code class="language-text">nor</code> 呢？或者我们可以假设 2020 及以后，所有 <code class="language-text">map_Bump</code> 引用的文件都是法线贴图，因为我不确定在过去的几年中看到过 <code class="language-text">.obj</code> 文件中引用的确实是凹凸贴图。 我们先沿着这个假设做。</p>\n<p>我们会用到来自关于法线贴图的文章的代码来生成切线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17077073811410549000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // 如果数据满足，生成切线\n  if (data.texcoord && data.normal) {\n    data.tangent = generateTangents(data.position, data.texcoord);\n  } else {\n    // 没有切线\n    data.tangent = { value: [1, 0, 0] };\n  }\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = twgl.createBufferInfoFromArrays(gl, data);\n  const vao = twgl.createVAOFromBufferInfo(gl, meshProgramInfo, bufferInfo);\n  return {\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo,\n    vao\n  };\n});`, `17077073811410549000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-10}"\n              >\n                <span class="gatsby-code-button-language">js{4-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 如果数据满足，生成切线</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>texcoord <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>normal<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token function">generateTangents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">,</span> data<span class="token punctuation">.</span>texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有切线</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> vao <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createVAOFromBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span>\n      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo<span class="token punctuation">,</span>\n    vao\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，为没有法线贴图的材质添加默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26113692167454850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255]),\n  defaultNormal: create1PixelTexture(gl, [127, 127, 255, 0])\n};\n\n// ...\n\nconst defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  normalMap: textures.defaultNormal,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};\n\n// ...`, `26113692167454850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,11}"\n              >\n                <span class="gatsby-code-button-language">js{3,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  defaultNormal<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  normalMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultNormal<span class="token punctuation">,</span></span>  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要将关于法线贴图的文章中对着色器的修改合并：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48603458650252330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec3 a_tangent;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      \n      // v_normal = mat3(u_world) * a_normal;\n      mat3 normalMat = mat3(u_world);\n      v_normal = normalize(normalMat * a_normal);\n      v_tangent = normalize(normalMat * a_tangent);\n      \n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform sampler2D normalMap;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      vec3 tangent = normalize(v_tangent);\n      vec3 bitangent = normalize(cross(normal, tangent));\n      \n      mat3 tbn = mat3(tangent, bitangent, normal);\n      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;\n      normal = normalize(tbn * normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1\n      );\n   }\n\\`;`, `48603458650252330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,24-27,38,57-62}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,24-27,38,57-62}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec3 a_tangent;</span></span><span class="token string">   attribute vec2 a_texcoord;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // v_normal = mat3(u_world) * a_normal;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 normalMat = mat3(u_world);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_normal = normalize(normalMat * a_normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_tangent = normalize(normalMat * a_tangent);</span></span><span class="token string">      </span>\n<span class="token string">      v_texcoord = a_texcoord;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform sampler2D specularMap;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform sampler2D normalMap;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 tangent = normalize(v_tangent);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 bitangent = normalize(cross(normal, tangent));</span></span><span class="gatsby-highlight-code-line"><span class="token string">      </span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 tbn = mat3(tangent, bitangent, normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = normalize(tbn * normal);</span></span><span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span>\n<span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就得到了法线贴图。注意：我移近了摄像头，这样能看的更清楚。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/j09plh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我确信我们还可以支持更多的 <code class="language-text">.mtl</code> 文件的的特性。比如 refl 关键词指定了反射贴图，也就是环境贴图。同样还有很多 <code class="language-text">map_</code> 加各种选项参数的关键词。比如：</p>\n<ul>\n<li><code class="language-text">-clamp on | off</code> 指定纹理是否重复</li>\n<li><code class="language-text">-mm base gain</code> 指定纹理值的偏移和倍数</li>\n<li><code class="language-text">-o u v w</code> 指定纹理坐标的偏移。可以像关于 drawImage 的文章中那样放进纹理矩阵中来使用</li>\n<li><code class="language-text">-s u v w</code> 指定纹理坐标的缩放。像上面一样，这些需要放进纹理矩阵中</li>\n</ul>\n<p>我不知道有多少 .mtl 文件使用了这些设置，或用了多少。例如，要支持 -o 和 -s，我们就要假设所有的贴图都有区别，并支持全部的纹理。这就需要我们为每个纹理传不同的纹理矩阵，而这又需要我们从顶点着色器为每个纹理传不同的纹理坐标到片段着色器，或者在片段着色器中进行纹理矩阵乘法（而不是传统方法那样在顶点着色器中做）。</p>\n<p>更重要的是，如果支持所有特性，会让着色器变得又大又复杂。上面的代码是一种超级着色器的样子，一个试图处理所有情况的着色器。通过传默认值来让它正常工作。例如，我们将 diffuseMap 默认设置成白色纹理，这样如果我们加载了没有纹理的模型，也可以显示出来。漫反射的颜色会被乘上白色，也就是 1.0，所以我们就能得到漫反射颜色。类似的，我们将顶点颜色默认设置为白色。</p>\n<p>这是一种常用的方式。如果它效果不错，满足了你的要求，就没有理由去改动它。更常见的做法是生成一个可以开/关这些特性的着色器。如果没有顶点颜色，就通过操作字符串，生成一个着色器，着色器里没有 <code class="language-text">a_color</code> 属性和其它相关代码。类似的，如果一个材质没有漫反射贴图，就生成一个没有 <code class="language-text">uniform sampler2D diffuseMap</code> 的着色器，并移除相关代码。如果不包含任何贴图，就不需要纹理坐标，我们就可以把它们全部移除。</p>\n<p>如果将这些组合都加上，可能会有 1000 多种着色器。我们上面有的特性就有：</p>\n<ul>\n<li>漫反射贴图</li>\n<li>有/无镜面贴图</li>\n<li>有/无法线贴图</li>\n<li>有/无顶点颜色</li>\n<li>有/无环境贴图</li>\n<li>有/无（我们不支持，但 .mtl 文件中有）</li>\n<li>反射贴图，有/无（我们不支持，但 .mtl 文件中有）</li>\n</ul>\n<p>仅这些就有 64 种组合。如果再加上 1 到 4 种光线（点光源、方向光源等），那么就会有 8192 种可能的着色器组合。</p>\n<p>管理这些就会有很多工作。这就是为什么很多人选择像 three.js 这样的 3D 引擎而不是自己开发的原因。但至少这篇文章介绍了一些展示任意 3D 内容的相关的知识。</p>\n<h2 id="尽可能避免在着色器中使用条件语句"><a href="#%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%81%BF%E5%85%8D%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>尽可能避免在着色器中使用条件语句</h2>\n<p>通常的建议是避免在着色器中使用条件语句。比如我们可能写这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58149153834293084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform bool hasDiffuseMap;\nuniform vec4 diffuse;\nuniform sampler2D diffuseMap\n\n// ...\nvec4 effectiveDiffuse = diffuse;\nif (hasDiffuseMap) {\n   effectiveDiffuse \\*= texture2D(diffuseMap, texcoord);\n}\n// ...`, `58149153834293084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> hasDiffuseMap<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> diffuseMap\n\n<span class="token comment">// ...</span>\n<span class="token keyword">vec4</span> effectiveDiffuse <span class="token operator">=</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiffuseMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   effectiveDiffuse \\<span class="token operator">*</span><span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>diffuseMap<span class="token punctuation">,</span> texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的条件语句一般是不鼓励的，因为依赖于 GPU 或者驱动，它们没有很好的性能。</p>\n<p>当没有纹理时我们用一个 1x1 像素的白点纹理，这样就不用考虑条件语句了。</p>\n<p>或者，使用不同的着色器。一个带有该特性，一个没有，根据情况选择使用正确的着色器。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL 理论基础——几何/index.md absPath of file >>> MarkdownRemark",timeToRead:42,frontmatter:{date:"2022-06-21 18:20:05",path:"/webgl-fundamental-geometry/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——几何",draft:null}},{excerpt:"WebGL 三维方向光源 实施光照的方式有很多种，最简单的可能就是方向光源了。 方向光是指光照均匀地来自某一个方向，晴朗天气下的太阳经常被当作方向光源，它距离太远所以光线被看作是平行的照到地面上。 计算方向光非常简单，将方向光的方向和面的朝向点乘就可以得到两个方向的余弦值。 这有个例子 随意拖动其中的点，如果两点方向刚好相反，点乘结果则为 -1，如果方向相同结果为 1。 这有什么用呢？如果将三维物体的朝向和光的方向点乘，结果为 1 则物体朝向和光照方向相同，为 -…",html:'<h1 id="webgl-三维方向光源"><a href="#webgl-%E4%B8%89%E7%BB%B4%E6%96%B9%E5%90%91%E5%85%89%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维方向光源</h1>\n<p>实施光照的方式有很多种，最简单的可能就是方向光源了。</p>\n<p>方向光是指光照均匀地来自某一个方向，晴朗天气下的太阳经常被当作方向光源，它距离太远所以光线被看作是平行的照到地面上。</p>\n<p>计算方向光非常简单，将方向光的方向和面的朝向点乘就可以得到两个方向的余弦值。</p>\n<p>这有个例子</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jstbeo?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>随意拖动其中的点，如果两点方向刚好相反，点乘结果则为 -1，如果方向相同结果为 1。</p>\n<p>这有什么用呢？如果将三维物体的朝向和光的方向点乘，结果为 1 则物体朝向和光照方向相同，为 -1 则物体朝向和光照方向相反。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/j5lmj8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我们可以将颜色值和点乘结果相乘，有光了！</p>\n<p>还有一个问题，我们如何知道三维物体的朝向？</p>\n<h2 id="法向量"><a href="#%E6%B3%95%E5%90%91%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>法向量</h2>\n<p>我不知道为什么叫法向量，但是在三维图形学中法向量就是描述面的朝向的单位向量。</p>\n<p>这是正方体和球体的一些法向量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xyb9lu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这些插在物体上的线就是对应顶点的法向量。</p>\n<p>注意到正方体在每个顶角有 3 个法向量。这是因为需要 3 个法向量去描述相邻的每个面的朝向。</p>\n<p>这里的法向量是基于他们的方向着色的，正 x 方向为红色，上方向为绿色，正 z 方向为蓝色。</p>\n<p>让我们来给上节中的 F 添加法向量。由于 F 非常规则并且朝向都是 <code class="language-text">x, y, z</code> 轴，所以非常简单。正面的的部分法向量为 <code class="language-text">0, 0, 1</code>，背面的部分法向量为 <code class="language-text">0, 0, -1</code>，左面为 <code class="language-text">-1, 0, 0</code>，右面为 <code class="language-text">1, 0, 0</code>，上面为 <code class="language-text">0, 1, 0</code>，然后底面为 <code class="language-text">0, -1, 0</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62618431365379370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function setNormals(gl) {\n  var normals = new Float32Array([\n    // 正面左竖\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 正面上横\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 正面中横\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 背面左竖\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 背面上横\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 背面中横\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 顶部\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n\n    // 上横右面\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 上横下面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 上横和中横之间\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 中横上面\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n\n    // 中横右面\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 中横底面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 底部右侧\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 底面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 左面\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0\n  ]);\n  gl.bufferData(gl.ARRAY_BUFFER, normals, gl.STATIC_DRAW);\n}`, `62618431365379370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setNormals</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token comment">// 正面左竖</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 正面上横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 正面中横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面左竖</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面上横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面中横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 顶部</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横右面</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横下面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横和中横之间</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横上面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横右面</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横底面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 底部右侧</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 底面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 左面</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normals<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在代码中使用它们，先移除顶点颜色以便观察光照效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38591382319408000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找顶点着色器中的属性\nvar positionLocation = gl.getAttribLocation(program, \'a_position\');\n// var colorLocation = gl.getAttribLocation(program, &quot;a_color&quot;);\nvar normalLocation = gl.getAttribLocation(program, \'a_normal\');\n\n// ...\n\n// // 创建一个缓冲存储颜色\n// var colorBuffer = gl.createBuffer();\n// // 绑定到 ARRAY_BUFFER\n// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n// // 将几何数据放入缓冲\n// setColors(gl);\n\n// 创建缓冲存储法向量\nvar normalBuffer = gl.createBuffer();\n// 绑定到 ARRAY_BUFFER (可以看作 ARRAY_BUFFER = normalBuffer)\ngl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);\n// 将法向量存入缓冲\nsetNormals(gl);`, `38591382319408000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找顶点着色器中的属性</span>\n<span class="token keyword">var</span> positionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// var colorLocation = gl.getAttribLocation(program, "a_color");</span>\n<span class="token keyword">var</span> normalLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_normal\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 创建一个缓冲存储颜色</span>\n<span class="token comment">// var colorBuffer = gl.createBuffer();</span>\n<span class="token comment">// // 绑定到 ARRAY_BUFFER</span>\n<span class="token comment">// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);</span>\n<span class="token comment">// // 将几何数据放入缓冲</span>\n<span class="token comment">// setColors(gl);</span>\n\n<span class="token comment">// 创建缓冲存储法向量</span>\n<span class="token keyword">var</span> normalBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定到 ARRAY_BUFFER (可以看作 ARRAY_BUFFER = normalBuffer)</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normalBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将法向量存入缓冲</span>\n<span class="token function">setNormals</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在渲染的时候</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95889424706513520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// // 启用颜色属性\n// gl.enableVertexAttribArray(colorLocation);\n\n// // 绑定颜色缓冲\n// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n\n// // 告诉颜色属性怎么从 colorBuffer(ARRAY_BUFFER) 中读取颜色值\n// var size = 3;                 // 每次迭代使用 3 个单位的数据\n// var type = gl.UNSIGNED_BYTE;  // 单位数据类型是无符号 8 位整数\n// var normalize = true;         // 标准化数据 (从 0-255 转换到 0.0-1.0)\n// var stride = 0;               // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据\n// var offset = 0;               // 从绑定缓冲的起始处开始\n// gl.vertexAttribPointer(\n//     colorLocation, size, type, normalize, stride, offset)\n\n// 启用法向量属性\ngl.enableVertexAttribArray(normalLocation);\n\n// 绑定法向量缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);\n\n// 告诉法向量属性怎么从 normalBuffer (ARRAY_BUFFER) 中读取值\nvar size = 3; // 每次迭代使用 3 个单位的数据\nvar type = gl.FLOAT; // 单位数据类型是 32 位浮点型\nvar normalize = false; // 单位化 (从 0-255 转换到 0-1)\nvar stride = 0; // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据\nvar offset = 0; // 从绑定缓冲的起始处开始\ngl.vertexAttribPointer(normalLocation, size, type, normalize, stride, offset);`, `95889424706513520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// // 启用颜色属性</span>\n<span class="token comment">// gl.enableVertexAttribArray(colorLocation);</span>\n\n<span class="token comment">// // 绑定颜色缓冲</span>\n<span class="token comment">// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);</span>\n\n<span class="token comment">// // 告诉颜色属性怎么从 colorBuffer(ARRAY_BUFFER) 中读取颜色值</span>\n<span class="token comment">// var size = 3;                 // 每次迭代使用 3 个单位的数据</span>\n<span class="token comment">// var type = gl.UNSIGNED_BYTE;  // 单位数据类型是无符号 8 位整数</span>\n<span class="token comment">// var normalize = true;         // 标准化数据 (从 0-255 转换到 0.0-1.0)</span>\n<span class="token comment">// var stride = 0;               // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token comment">// var offset = 0;               // 从绑定缓冲的起始处开始</span>\n<span class="token comment">// gl.vertexAttribPointer(</span>\n<span class="token comment">//     colorLocation, size, type, normalize, stride, offset)</span>\n\n<span class="token comment">// 启用法向量属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>normalLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定法向量缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normalBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉法向量属性怎么从 normalBuffer (ARRAY_BUFFER) 中读取值</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代使用 3 个单位的数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 单位化 (从 0-255 转换到 0-1)</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从绑定缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>normalLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在让着色器使用它</p>\n<p>首先在顶点着色器中只将法向量传递给片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4190796325870605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\n// attribute vec4 a_color;\nattribute vec3 a_normal;\n\nuniform mat4 u_matrix;\n\n// varying vec4 v_color;\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // // 将颜色传到片断着色器\n  // v_color = a_color;\n\n  // 将法向量传到片断着色器\n  v_normal = a_normal;\n}`, `4190796325870605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token comment">// attribute vec4 a_color;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token comment">// varying vec4 v_color;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// // 将颜色传到片断着色器</span>\n  <span class="token comment">// v_color = a_color;</span>\n\n  <span class="token comment">// 将法向量传到片断着色器</span>\n  v_normal <span class="token operator">=</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在片断着色器中将法向量和光照方向点乘</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66069166034343870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\n// varying vec4 v_color;\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\n\nvoid main() {\n   // 由于 v_normal 是插值出来的，有可能不是单位向量，\n   // 可以用 normalize 将其单位化。\n   vec3 normal = normalize(v_normal);\n\n   float light = dot(normal, u_reverseLightDirection);\n\n   gl_FragColor = u_color;\n\n   // 将颜色部分（不包括 alpha）和光照相乘\n   gl_FragColor.rgb *= light;\n}`, `66069166034343870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token comment">// varying vec4 v_color;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 由于 v_normal 是插值出来的，有可能不是单位向量，</span>\n   <span class="token comment">// 可以用 normalize 将其单位化。</span>\n   <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n   <span class="token comment">// 将颜色部分（不包括 alpha）和光照相乘</span>\n   gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后找到 <code class="language-text">u_color</code> 和 <code class="language-text">u_reverseLightDirection</code> 的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89676192859461700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找全局变量\nvar matrixLocation = gl.getUniformLocation(program, \'u_matrix\');\nvar colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');`, `89676192859461700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找全局变量</span>\n<span class="token keyword">var</span> matrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_matrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> reverseLightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_reverseLightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为它们赋值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8706651497904816000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(matrixLocation, false, worldViewProjectionMatrix);\n\n// 设置使用的颜色\ngl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]); // green\n\n// 设置光线方向\ngl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));`, `8706651497904816000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置使用的颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// green</span>\n\n<span class="token comment">// 设置光线方向</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>reverseLightDirectionLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们之前用到的 normalize 会将原向量转换为单位向量。例子中的 x = 0.5 说明光线是从右往左照，y = 0.7 说明光线从上方往下照，z = 1 说明光线从在场景前方。对应的值表示光源大多指向场景，在靠右方和上方一点的位置。</p>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vp33w2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果你旋转了 F 就会发现，F 虽然旋转了但是光照没变，我们希望随着 F 的旋转正面总是被照亮的。</p>\n<p>为了解决这个问题就需要在物体重定向时重定向法向量，和位置一样我们也可以将向量和矩阵相乘，这个矩阵显然是 world 矩阵，现在我们只传了一个矩阵 <code class="language-text">u_matrix</code>，所以先来改成传递两个矩阵，一个叫做 <code class="language-text">u_world</code> 的世界矩阵，另一个叫做 <code class="language-text">u_worldViewProjection</code> 也就是我们现在的 <code class="language-text">u_matrix</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64859205372388475000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_world;\n\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_world) * a_normal;\n}`, `64859205372388475000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_world<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们将 <code class="language-text">a_normal</code> 与 <code class="language-text">mat3(u_world)</code> 相乘，那是因为法向量是方向所以不用关心位移，矩阵的左上 3x3 部分才是控制姿态的。</p>\n<p>找到全局变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48980107427770655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找全局变量\nvar worldViewProjectionLocation = gl.getUniformLocation(program, \'u_worldViewProjection\');\nvar worldLocation = gl.getUniformLocation(program, \'u_world\');`, `48980107427770655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找全局变量</span>\n<span class="token keyword">var</span> worldViewProjectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldViewProjection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后更新它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55967823302440500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\ngl.uniformMatrix4fv(worldLocation, false, worldMatrix);`, `55967823302440500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/it9qvy?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>旋转后就会发现面对 F 的面总是被照亮的。</p>\n<p>这里有一个问题我不知道如何表述所以就用图解展示，我们用 normal 和 u_world 相乘去重定向法向量，如果世界矩阵被缩放了怎么办？事实是会得到错误的法向量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zzocr1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我从没想弄清为什么，但解决办法就是对世界矩阵求逆并转置，用这个矩阵就会得到正确的结果。</p>\n<p>在图解里中间的紫色球体是未缩放的，左边的红色球体用的世界矩阵并缩放了，你可以看出有些不太对劲。右边蓝色的球体用的是世界矩阵求逆并转置后的矩阵。</p>\n<p>点击图解循环观察不同的表示形式，你会发现在缩放严重时左边的（世界矩阵）法向量和表面没有保持垂直关系，而右边的（世界矩阵求逆并转置）一直保持垂直。最后一种模式是将它们渲染成红色，你会发现两个球体的光照结果相差非常大，基于可视化的结果可以得出使用世界矩阵求逆转置是对的。</p>\n<p>修改代码让示例使用这种矩阵，首先更新着色器，理论上我们可以直接更新 <code class="language-text">u_world</code> 的值，但是最好将它重命名以表示它真正的含义，防止混淆。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48344378986064050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n}`, `48344378986064050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后找到它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88306105300216070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// var worldLocation = gl.getUniformLocation(program, \'u_world\');\nvar worldInverseTransposeLocation = gl.getUniformLocation(program, \'u_worldInverseTranspose\');`, `88306105300216070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// var worldLocation = gl.getUniformLocation(program, \'u_world\');</span>\n<span class="token keyword">var</span> worldInverseTransposeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldInverseTranspose\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>更新它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34847072372895773000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var worldViewProjectionMatrix = m4.multiply(viewProjectionMatrix, worldMatrix);\nvar worldInverseMatrix = m4.inverse(worldMatrix);\nvar worldInverseTransposeMatrix = m4.transpose(worldInverseMatrix);\n\n// 设置矩阵\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\n// gl.uniformMatrix4fv(worldLocation, false, worldMatrix);\ngl.uniformMatrix4fv(worldInverseTransposeLocation, false, worldInverseTransposeMatrix);`, `34847072372895773000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> worldViewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseTransposeMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span>worldInverseMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// gl.uniformMatrix4fv(worldLocation, false, worldMatrix);</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldInverseTransposeLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldInverseTransposeMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是转置的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97284705004295160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  transpose: function(m) {\n    return [m[0], m[4], m[8], m[12], m[1], m[5], m[9], m[13], m[2], m[6], m[10], m[14], m[3], m[7], m[11], m[15]];\n  }\n\n  // ...\n};`, `97284705004295160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">transpose</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于我们并没有进行缩放，所以没有明显的变化，但防患于未然。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vy56uh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="mat3u_worldinversetranspose--a_normal-的可选方案"><a href="#mat3u_worldinversetranspose--a_normal-%E7%9A%84%E5%8F%AF%E9%80%89%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">mat3(u_worldInverseTranspose) * a_normal</code> 的可选方案</h2>\n<p>之前的着色器中出现了这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21999550468622320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_normal = mat3(u_worldInverseTranspose) * a_normal;`, `21999550468622320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">v_normal <span class="token operator">=</span> <span class="token function">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们也可以这样做</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13872760383751692000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_normal = (u_worldInverseTranspose * vec4(a_normal, 0)).xyz;`, `13872760383751692000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">v_normal <span class="token operator">=</span> <span class="token punctuation">(</span>u_worldInverseTranspose <span class="token operator">*</span> <span class="token function">vec4</span><span class="token punctuation">(</span>a_normal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 w 在相乘前被赋值为 0，所以在相乘后负责平移的部分与 0 相乘被移除了。我认为这可能是更常用的方式，mat3 的做法只是对我来说更简洁但我经常用前一种方法。</p>\n<p>当然另一种解决方案是将 <code class="language-text">u_worldInverseTranspose</code> 直接构造成 mat3。这有两个不能这么做的理由，第一个是我们可能需要一个完整的 <code class="language-text">u_worldInverseTranspose</code> 对象传递一个 mat4 给还要给其他地方使用，另一个是我们在 JavaScript 中的所有矩阵方法都是针对 4x4 的矩阵，如果没有其他特别的需求，没有必要构造一个 3x3 的矩阵，或者是把 4x4 转换成 3x3。</p>\n<h1 id="webgl-三维点光源"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%82%B9%E5%85%89%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维点光源</h1>\n<p>上篇中说到方向光统一来自一个方向，在渲染前设置好方向。</p>\n<p>如果代替方向而是从三维空间中选一个点当作光源，然后在着色器中根据光源和表面位置计算光照方向的话，就是点光源了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i3grsj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果旋转上方的表面会发现，每个点都有一个不同的面到光源的矢量，将这个矢量和法向量点乘后，表面上的每个点都会有一个不同的光照值。</p>\n<p>让我们实现它吧。</p>\n<p>首先需要一个光源位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39319415247648195000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec3 u_lightWorldPosition;`, `39319415247648195000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后需要计算表面的世界坐标，我们可以将位置和世界矩阵相乘得到</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53569439444628750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform mat4 u_world;\n\n// ...\n\n// 计算表面的世界坐标\nvec3 surfaceWorldPosition = (u_world * a_position).xyz;`, `53569439444628750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 计算表面的世界坐标</span>\n<span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后可以计算出一个从表面到光源的矢量，用来模拟之前的方向光，只是这次我们为表面上的每个点都计算了一个方向。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47236844428216800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;`, `47236844428216800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl">v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这是全部的内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38921933967605600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform vec3 u_lightWorldPosition;\n\nuniform mat4 u_world;\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvarying vec3 v_surfaceToLight;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n\n  // 计算表面的世界坐标\n  vec3 surfaceWorldPosition = (u_world * a_position).xyz;\n\n  // 计算表面到光源的方向\n  // 传递给片断着色器\n  v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;\n}`, `38921933967605600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,6,12,21-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,6,12,21-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span></span><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面的世界坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面到光源的方向</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 传递给片断着色器</span></span><span class="gatsby-highlight-code-line">  v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中需要将表面到光源的方向进行单位化，注意，虽然我们可以在顶点着色器中传递单位向量，但是 varying 会进行插值再传给片断着色器，所以片断着色器中的向量基本上不是单位向量了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42678481352275124000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\n\n// uniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\n\nvoid main() {\n  // 由于 v_normal 是可变量，所以经过插值后不再是单位向量\n  // 单位化后会成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n\n  -float light = dot(normal, u_reverseLightDirection);\n  +float light = dot(normal, surfaceToLightDirection);\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n}`, `42678481352275124000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,7}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,7}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// uniform vec3 u_reverseLightDirection;</span></span><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 由于 v_normal 是可变量，所以经过插值后不再是单位向量</span>\n  <span class="token comment">// 单位化后会成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token operator">-</span><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">+</span><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后需要找到 <code class="language-text">u_world</code> 和 <code class="language-text">u_lightWorldPosition</code> 的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46641036061796810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// var reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');\nvar lightWorldPositionLocation = gl.getUniformLocation(program, \'u_lightWorldPosition\');\nvar worldLocation = gl.getUniformLocation(program, \'u_world\');`, `46641036061796810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// var reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');</span>\n<span class="token keyword">var</span> lightWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>设置它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23595664611206525000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(worldLocation, false, worldMatrix);\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\n\n// ...\n\n// // 设置光照方向\n// gl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));\n// 设置光源位置\ngl.uniform3fv(lightWorldPositionLocation, [20, 30, 50]);`, `23595664611206525000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 设置光照方向</span>\n<span class="token comment">// gl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));</span>\n<span class="token comment">// 设置光源位置</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightWorldPositionLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xwmmsc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在我们可以加一个叫做镜面高光的东西。</p>\n<p>观察现实世界中的物体，如果物体表面恰好将光线反射到你眼前，就会显得非常明亮，像镜子一样。</p>\n<p>我们可以通过计算光线是否反射到眼前来模拟这种情况，点乘又一次起到了至关重要的作用。</p>\n<p>如何测试呢？如果入射角和反射角恰好与眼睛和和光源的夹角相同，那么光线就会反射到眼前。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/352uf4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我们知道了物体表面到光源的方向（刚刚已经计算过了），加上物体表面到视区/眼睛/相机的方向，再除以 2 得到 halfVector 向量，将这个向量和法向量比较，如果方向一致，那么光线就会被反射到眼前。那么如何确定方向是否一致呢？用之前的点乘就可以了。1 表示相符，0 表示垂直，-1 表示相反。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yrs3bw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>所以首先我们需要传入相机位置，计算表面到相机的方向矢量，然后传递到片断着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44299993832277160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform vec3 u_lightWorldPosition;\nuniform vec3 u_viewWorldPosition;\n\nuniform mat4 u_world;\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递到片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n\n  // 计算表面的世界坐标\n  vec3 surfaceWorldPosition = (u_world * a_position).xyz;\n\n  // 计算表面到光源的方向\n  // 然后传递到片断着色器\n  v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;\n\n  // 计算表面到相机的方向\n  // 然后传递到片断着色器\n  v_surfaceToView = u_viewWorldPosition - surfaceWorldPosition;\n}`, `44299993832277160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,14,30-32}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,14,30-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_viewWorldPosition<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递到片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算表面的世界坐标</span>\n  <span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算表面到光源的方向</span>\n  <span class="token comment">// 然后传递到片断着色器</span>\n  v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面到相机的方向</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 然后传递到片断着色器</span></span><span class="gatsby-highlight-code-line">  v_surfaceToView <span class="token operator">=</span> u_viewWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在片断着色器中计算表面到光源和相机之间的 halfVector，将它和法向量相乘，查看光线是否直接反射到眼前。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56011565685468860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 从顶点着色器中传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nuniform vec4 u_color;\n\nvoid main() {\n  // 由于 v_normal 是可变量，所以经过插值后不再是单位向量，\n  // 单位化后会成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n  vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n  vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);\n\n  float light = dot(normal, surfaceToLightDirection);\n  float specular = dot(normal, halfVector);\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n\n  // 直接加上高光\n  gl_FragColor.rgb += specular;\n}`, `56011565685468860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,13-15,18,25-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,13-15,18,25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 由于 v_normal 是可变量，所以经过插值后不再是单位向量，</span>\n  <span class="token comment">// 单位化后会成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceToViewDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToView<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> halfVector <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceToLightDirection <span class="token operator">+</span> surfaceToViewDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 直接加上高光</span></span><span class="gatsby-highlight-code-line">  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后找到 <code class="language-text">u_viewWorldPosition</code> 并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58304315295134155000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightWorldPositionLocation = gl.getUniformLocation(program, \'u_lightWorldPosition\');\nvar viewWorldPositionLocation = gl.getUniformLocation(program, \'u_viewWorldPosition\');\n\n// ...\n\n// 计算相机矩阵\nvar camera = [100, 150, 200];\nvar target = [0, 35, 0];\nvar up = [0, 1, 0];\nvar cameraMatrix = makeLookAt(camera, target, up);\n\n// 设置相机位置\ngl.uniform3fv(viewWorldPositionLocation, camera);`, `58304315295134155000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,12-13}"\n              >\n                <span class="gatsby-code-button-language">js{2,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> viewWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_viewWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 计算相机矩阵</span>\n<span class="token keyword">var</span> camera <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> <span class="token function">makeLookAt</span><span class="token punctuation">(</span>camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 设置相机位置</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>viewWorldPositionLocation<span class="token punctuation">,</span> camera<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/z123sf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>但，亮瞎了!</p>\n<p>我们可以将点乘结果进行求幂运算来解决太亮的问题，它会把高光从线性变换变成指数变换。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nd3lyv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>红线越接近顶部，我们加的光照就越多，通过求幂可以将高光的部分向右移动。</p>\n<p>就把它叫做 shininess 并加到着色器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5369948938087132000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 u_color;\nuniform float u_shininess;\n\n// ...\n\n// float specular = dot(normal, halfVector);\nfloat specular = 0.0;\nif (light > 0.0) {\n   specular = pow(dot(normal, halfVector), u_shininess);\n}`, `5369948938087132000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,6-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,6-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// float specular = dot(normal, halfVector);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>light <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">   specular <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>点乘结果有可能为负值，将负值求幂有可能会得到 undefined 的结果，所以我们只将点乘结果为正的部分进行计算，其他部分设置为 0.0。</p>\n<p>当然还要找到亮度的位置并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86043078964292440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var shininessLocation = gl.getUniformLocation(program, \'u_shininess\');\n\n// ...\n\n// 设置亮度\ngl.uniform1f(shininessLocation, shininess);`, `86043078964292440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1}"\n              >\n                <span class="gatsby-code-button-language">js{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> shininessLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_shininess\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 设置亮度</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>shininessLocation<span class="token punctuation">,</span> shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lrej2i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最后想说的是光的颜色。</p>\n<p>在此之前我们都是将 light 和 F 的颜色直接相乘，如果想要有色光也可以为光照提供颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81804263274380250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 u_color;\nuniform float u_shininess;\nuniform vec3 u_lightColor;\nuniform vec3 u_specularColor;\n\n// ...\n\n// 只将颜色部分（不包含 alpha） 和光照相乘\ngl_FragColor.rgb *= light * u_lightColor;\n\n// 直接和高光相加\ngl_FragColor.rgb += specular * u_specularColor;`, `81804263274380250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{3-4,9,12}"\n              >\n                <span class="gatsby-code-button-language">glsl{3-4,9,12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightColor<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_specularColor<span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 只将颜色部分（不包含 alpha） 和光照相乘</span>\n<span class="gatsby-highlight-code-line">gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light <span class="token operator">*</span> u_lightColor<span class="token punctuation">;</span></span>\n<span class="token comment">// 直接和高光相加</span>\n<span class="gatsby-highlight-code-line">gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular <span class="token operator">*</span> u_specularColor<span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17221723529910094000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightColorLocation = gl.getUniformLocation(program, \'u_lightColor\');\nvar specularColorLocation = gl.getUniformLocation(program, \'u_specularColor\');`, `17221723529910094000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightColorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightColor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> specularColorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_specularColor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97816659401803280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置光照颜色\ngl.uniform3fv(lightColorLocation, m4.normalize([1, 0.6, 0.6])); // 红光\n// 设置高光颜色\ngl.uniform3fv(specularColorLocation, m4.normalize([1, 0.6, 0.6])); // 红光`, `97816659401803280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置光照颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightColorLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红光</span>\n<span class="token comment">// 设置高光颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>specularColorLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红光</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fwn7lv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="webgl-三维聚光灯"><a href="#webgl-%E4%B8%89%E7%BB%B4%E8%81%9A%E5%85%89%E7%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维聚光灯</h1>\n<p>在上篇文章中我们讲到点光源，计算光源到物体表面每一点的方向，然后做与方向光相同的运算，也就是对光线方向和表面法向量（表面面对的方向）做点乘运算。如果两个方向完全相同就会得到 1，应该被完全照亮。如果两个方向垂直会得到 0，相反会得到 -1。我们直接将这个值和表面的颜色相乘，实现光照效果。</p>\n<p>聚光灯只是做了少量修改，事实上如果你比较有创新能力的话，可能会根据之前学的东西知道聚光灯的实现方法。</p>\n<p>你可以把点光源想象成一个点，光线从那个点照向所有方向。实现聚光灯只需要以那个点为起点选择一个方向，作为聚光灯的方向，然后将其他光线方向与所选方向点乘，然后随意选择一个限定范围，然后判断光线是否在限定范围内，如果不在就不照亮。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4nwjt1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在上方的图示中我们可以看到光线照向所有的方向，并且将每个方向的点乘结果显示在上面。然后指定一个方向表示聚光灯的方向，选择一个限定（上方以度为单位）。通过限定我们计算一个点乘限定，只需对限定值取余弦就可以得到。如果与选定聚光灯方向的点乘大于这个点乘限定，就照亮，否则不照亮。</p>\n<p>换一种方式解释，假设限定是 20 度，我们可以将它转换为弧度，然后取余弦值得到 -1 到 1 之间的数，暂且把它称作点乘空间。或者可以用这个表格表示限定值的转换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96019862444123570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`          限制值\n   角度   |   弧度   | 点乘空间\n --------+---------+----------\n    0    |   0.0   |    1.0\n    22   |    .38  |     .93\n    45   |    .79  |     .71\n    67   |   1.17  |     .39\n    90   |   1.57  |    0.0\n   180   |   3.14  |   -1.0`, `96019862444123570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">          限制值\n   角度   |   弧度   | 点乘空间\n --------+---------+----------\n    0    |   0.0   |    1.0\n    22   |    .38  |     .93\n    45   |    .79  |     .71\n    67   |   1.17  |     .39\n    90   |   1.57  |    0.0\n   180   |   3.14  |   -1.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以只需判断</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67866496482213630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dotFromDirection = dot(surfaceToLight, -lightDirection);\nif (dotFromDirection >= limitInDotSpace) {\n  // 使用光照\n}`, `67866496482213630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLight<span class="token punctuation">,</span> <span class="token operator">-</span>lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>dotFromDirection <span class="token operator">>=</span> limitInDotSpace<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 使用光照</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们来实现它。</p>\n<p>首先修改上文的片断着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96424969983087940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nuniform vec4 u_color;\nuniform float u_shininess;\nuniform vec3 u_lightDirection;\nuniform float u_limit; // 在点乘空间中\n\nvoid main() {\n  // 因为 v_normal 是可变量，被插值过\n  // 所以不是单位向量，单位可以让它成为再次成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n  vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n  vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);\n\n  // float light = dot(normal, surfaceToLightDirection);\n  float light = 0.0;\n  float specular = 0.0;\n\n  float dotFromDirection = dot(surfaceToLightDirection,\n                               -u_lightDirection);\n  if (dotFromDirection >= u_limit) {\n    light = dot(normal, surfaceToLightDirection);\n    if (light > 0.0) {\n      specular = pow(dot(normal, halfVector), u_shininess);\n    }\n  }\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n\n  // 直接加上高光\n  gl_FragColor.rgb += specular;\n}`, `96424969983087940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10-11,22-23,26-33}"\n              >\n                <span class="gatsby-code-button-language">glsl{10-11,22-23,26-33}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightDirection<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_limit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是可变量，被插值过</span>\n  <span class="token comment">// 所以不是单位向量，单位可以让它成为再次成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec3</span> surfaceToViewDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToView<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec3</span> halfVector <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceToLightDirection <span class="token operator">+</span> surfaceToViewDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// float light = dot(normal, surfaceToLightDirection);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span>  <span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                               <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dotFromDirection <span class="token operator">>=</span> u_limit<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>light <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      specular <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n\n  <span class="token comment">// 直接加上高光</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然我们需要找到刚才添加的全局变量的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87987978381260800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightDirection = [0, 0, 0];\nvar limit = degToRad(20);\n\n// ...\n\nvar lightDirectionLocation = gl.getUniformLocation(program, \'u_lightDirection\');\nvar limitLocation = gl.getUniformLocation(program, \'u_limit\');`, `87987978381260800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightDirection <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> limit <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> lightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> limitLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_limit\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后设置它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96543895516182350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform3fv(lightDirectionLocation, lightDirection);\ngl.uniform1f(limitLocation, Math.cos(limit));`, `96543895516182350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightDirectionLocation<span class="token punctuation">,</span> lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>limitLocation<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i7cotm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>一些需要注意的细节：一个是我们在上方对 <code class="language-text">u_lightDirection</code> 取负，这其实是一个等价的选择，我们希望两个方向匹配的时候能指向相同的方向，也就是需要将 <code class="language-text">surfaceToLightDirection</code> 和聚光灯的反方向相比，我们可以用很多种方式实现这个。可以在设置全局变量时传入反方向，那可能是我的首选，但是我觉得那样应该叫做 <code class="language-text">u_reverseLightDirection</code> 或 <code class="language-text">u_negativeLightDirection</code> 而不是 <code class="language-text">u_lightDirection</code>。</p>\n<p>另一件事，也许这个只是个人习惯，如果可能的话我尽量不在着色器中使用条件语句，原因是我认为着色器并不是真的使用条件语句，如果你在着色器中使用，编译器会在代码中扩展很多 0 和 1 的乘法运算来实现，所以这里并不是真的条件语句，它会将你的代码扩展成多种组合。我不确定现在是否还是这样，但是我们可以使用一些技巧来避免这种情况，你自己可以选择用或不用。</p>\n<p>有一个 GLSL 函数叫做 step，它获取两个值，如果第二个值大于或等于第一个值就返回 1.0，否则返回 0。用 JavaScript 大概可以这样表示。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46223254480180320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function step(a, b) {\n  if (b >= a) {\n    return 1;\n  } else {\n    return 0;\n  }\n}`, `46223254480180320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">>=</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们使用 step 避免这种情况</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13116686088299745000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// 如果光线在聚光灯范围内 inLight 就为 1，否则为 0\nfloat inLight = step(u_limit, dotFromDirection);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `13116686088299745000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 如果光线在聚光灯范围内 inLight 就为 1，否则为 0</span>\n<span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span>u_limit<span class="token punctuation">,</span> dotFromDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看起来没有什么区别，这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yd0rcc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>还有一件事，现在的聚光灯效果非常粗糙和僵硬。只有在聚光灯范围内或外，在外面就直接变黑，没有任何过渡。</p>\n<p>要修正它我们可以使用两个限定值代替原来的一个，一个内部限定一个外部限定。如果在内部限定内就使用 1.0，在外部限定外面就使用 0.0，在内部和外部限定之间就使用 1.0 到 0.0 之间的插值。</p>\n<p>这是我们实现这个的一种方式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65419113772366954000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// uniform float u_limit; // 在点乘空间中\nuniform float u_innerLimit; // 在点乘空间中\nuniform float u_outerLimit; // 在点乘空间中\n\n// ...\n\nfloat dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// float inLight = step(u_limit, dotFromDirection);\nfloat limitRange = u_innerLimit - u_outerLimit;\nfloat inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `65419113772366954000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{1-3,8-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{1-3,8-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="gatsby-highlight-code-line"><span class="token comment">// uniform float u_limit; // 在点乘空间中</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_innerLimit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_outerLimit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// float inLight = step(u_limit, dotFromDirection);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> limitRange <span class="token operator">=</span> u_innerLimit <span class="token operator">-</span> u_outerLimit<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dotFromDirection <span class="token operator">-</span> u_outerLimit<span class="token punctuation">)</span> <span class="token operator">/</span> limitRange<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就行了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/8rzoi2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在我们得到了聚光灯的效果。</p>\n<p>需要注意的是如果 <code class="language-text">u_innerLimit</code> 和 <code class="language-text">u_outerLimit</code> 相等那么 limitRange 就会是 0.0，除以 0 就会导致 undefined。这在着色器中没有什么解决办法，所以只需要在 JavaScript 中确保 <code class="language-text">u_innerLimit</code> 和 <code class="language-text">u_outerLimit</code> 永远不要相等。（注意：示例代码中并没有做这个。）</p>\n<p>GLSL 也有一个函数可以稍微做一些简化，叫做 smoothstep，和 step 相似返回一个 0 到 1 之间的值，但是它获取最大和最小边界值，返回该值在边界范围映射到 0 到 1 之间的插值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9312900101785115000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// float limitRange = u_innerLimit - u_outerLimit;\n// float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);\nfloat inLight = smoothstep(u_outerLimit, u_innerLimit, dotFromDirection);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `9312900101785115000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// float limitRange = u_innerLimit - u_outerLimit;</span>\n<span class="token comment">// float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);</span>\n<span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span>u_outerLimit<span class="token punctuation">,</span> u_innerLimit<span class="token punctuation">,</span> dotFromDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样也可以</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5udeoe?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>不同之处是 smoothstep 使用 Hermite 插值而不是线型插值，也就是说 lowerBound 和 upperBound 之间的值插值后像下方右图所示，线型插值是左图。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-15-14-01-31-1095413faf7395ae3e2f26a6dc02fd83-7027d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 300px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABG0lEQVQoz32RO07DQBCGvzgviAm2IQkI8ZYQPSUFFRJCiCOko4XTcBYKzsAFaGmQaOACxPy7O1ZsE3uk2ZnV/P5mxssNHJ/ABMj6sEXNoxAn13D0CKe9cM+i/9pMPsXBclijxTqQKKTSdeWjFukGRuZLH7xA5PK5Z9gRLNVk2y75gP43xC6/qvT0NsbWxMHUPVlYMa92Tt1an3aRZqj6cIVujO1fCDsOmhv0uQYsA6QdLWyjy1XA+XKyCrQJaDr/Py+aJqyJk3ebYGDAmdV/l7pB7UErQD/Rg8VXwX7Cy7p7UjxKMfa9RWniN9/Tj7tZrNNoAsaHQZO2aSxdd8eB3G2zU/ZeiFMV9u7gXPm+fLesjUKcdRWfpLmFsz9PaTMX9FpEMQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 15 14 01 31" title="" data-src="/static/2022-06-15-14-01-31-1095413faf7395ae3e2f26a6dc02fd83-7027d.png" data-srcset="/static/2022-06-15-14-01-31-1095413faf7395ae3e2f26a6dc02fd83-55fa9.png 200w,\n/static/2022-06-15-14-01-31-1095413faf7395ae3e2f26a6dc02fd83-7027d.png 300w" data-sizes="(max-width: 300px) 100vw, 300px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果你觉得没什么关系的话，使用什么取决于你自己。</p>\n<p>还有一件事就是注意当 lowerBound 大于或等于 upperBound 时 smoothstep 方法会产生 undefined。它们值相等和之前的情况一样，多出的问题是 lowerBound 大于 upperBound 时，但是对于正常的聚光灯这种情况永远不会出现。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL 理论基础——光照/index.md absPath of file >>> MarkdownRemark",timeToRead:14,frontmatter:{date:"2022-06-07 14:38:03",path:"/webgl-fundamental-light/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——光照",draft:null}},{excerpt:"WebGL 三维正射投影 上一篇文章概述了二维矩阵的工作原理，我们讲到了如何平移，旋转，缩放甚至从像素空间投影到裁剪空间，并且将这些操作通过一个矩阵实现，做三维只需要再迈出一小步。 二维例子中的二维点 (x, y) 与 3x3 的矩阵相乘，在三维中我们需要三维点 (x, y, z) 与 4x4 的矩阵相乘。 让我们将上个例子改成三维的，这里会继续使用 F，但是这次是三维的 ‘F’ 。 首先需要修改顶点着色器以支持三维处理，这是原顶点着色器 这是新着色器 它甚至变简单了！在二维中我们提供 x…",html:'<h1 id="webgl-三维正射投影"><a href="#webgl-%E4%B8%89%E7%BB%B4%E6%AD%A3%E5%B0%84%E6%8A%95%E5%BD%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维正射投影</h1>\n<p>上一篇文章概述了二维矩阵的工作原理，我们讲到了如何平移，旋转，缩放甚至从像素空间投影到裁剪空间，并且将这些操作通过一个矩阵实现，做三维只需要再迈出一小步。</p>\n<p>二维例子中的二维点 (x, y) 与 3x3 的矩阵相乘，在三维中我们需要三维点 (x, y, z) 与 4x4 的矩阵相乘。</p>\n<p>让我们将上个例子改成三维的，这里会继续使用 F，但是这次是三维的 ‘F’ 。</p>\n<p>首先需要修改顶点着色器以支持三维处理，这是原顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62286246856434336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec2 a_position;\n\n   uniform mat3 u_matrix;\n\n   void main() {\n      // 将位置和矩阵相乘\n      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n   }\n</script>`, `62286246856434336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec2 a_position<span class="token punctuation">;</span>\n\n   uniform mat3 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_matrix <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是新着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45089229634667130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-3d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec4 a_position;\n\n   uniform mat4 u_matrix;\n\n   void main() {\n      // 将位置和矩阵相乘\n      gl_Position = u_matrix * a_position;\n   }\n</script>`, `45089229634667130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,4,8}"\n              >\n                <span class="gatsby-code-button-language">js{2,4,8}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-3d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n<span class="gatsby-highlight-code-line">   attribute vec4 a_position<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">   uniform mat4 u_matrix<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置和矩阵相乘</span>\n<span class="gatsby-highlight-code-line">      gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它甚至变简单了！在二维中我们提供 x 和 y 并设置 z 为 1，在三维中我们将提供 x，y 和 z，然后将 w 设置为 1，而在属性中 w 的默认值就是 1，我们可以利用这点不用再次设置。</p>\n<p>然后提供三维数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87316090408918250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// 告诉属性怎么从 positionBuffer (ARRAY_BUFFER) 中读取位置\nvar size = 3; // 每次迭代使用 3 个单位的数据\nvar type = gl.FLOAT; // 单位数据类型是 32 位的浮点型\nvar normalize = false; // 不需要归一化数据\nvar stride = 0; // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据\nvar offset = 0; // 从绑定缓冲的起始处开始\ngl.vertexAttribPointer(positionAttributeLocation, size, type, normalize, stride, offset);\n\n// ...\n\n// 填充当前 ARRAY_BUFFER 缓冲\n// 使用组成 \'F\' 的数据填充缓冲.\nfunction setGeometry(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 左竖\n      0,\n      0,\n      0,\n      30,\n      0,\n      0,\n      0,\n      150,\n      0,\n      0,\n      150,\n      0,\n      30,\n      0,\n      0,\n      30,\n      150,\n      0,\n\n      // 上横\n      30,\n      0,\n      0,\n      100,\n      0,\n      0,\n      30,\n      30,\n      0,\n      30,\n      30,\n      0,\n      100,\n      0,\n      0,\n      100,\n      30,\n      0,\n\n      // 下横\n      30,\n      60,\n      0,\n      67,\n      60,\n      0,\n      30,\n      90,\n      0,\n      30,\n      90,\n      0,\n      67,\n      60,\n      0,\n      67,\n      90,\n      0\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `87316090408918250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token comment">// 告诉属性怎么从 positionBuffer (ARRAY_BUFFER) 中读取位置</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代使用 3 个单位的数据</span></span><span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位的浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要归一化数据</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从绑定缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionAttributeLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 填充当前 ARRAY_BUFFER 缓冲</span>\n<span class="token comment">// 使用组成 \'F\' 的数据填充缓冲.</span>\n<span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">150</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 上横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">100</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 下横</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">30</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">60</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">67</span><span class="token punctuation">,</span>\n      <span class="token number">90</span><span class="token punctuation">,</span>\n      <span class="token number">0</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来把二维矩阵方法改成三维的</p>\n<p>这是二维（之前的）版本的 <code class="language-text">m3.translation</code>, <code class="language-text">m3.rotation</code>, 和 <code class="language-text">m3.scaling</code> 方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31655965563954004000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m3 = {\n  translation: function translation(tx, ty) {\n    return [1, 0, 0, 0, 1, 0, tx, ty, 1];\n  },\n\n  rotation: function rotation(angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n    return [c, -s, 0, s, c, 0, 0, 0, 1];\n  },\n\n  scaling: function scaling(sx, sy) {\n    return [sx, 0, 0, 0, sy, 0, 0, 0, 1];\n  }\n};`, `31655965563954004000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m3 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">translation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">translation</span><span class="token punctuation">(</span><span class="token parameter">tx<span class="token punctuation">,</span> ty</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">rotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">rotation</span><span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scaling</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">scaling</span><span class="token punctuation">(</span><span class="token parameter">sx<span class="token punctuation">,</span> sy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>sx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是升级到三维的版本。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67285534855687730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  translation: function(tx, ty, tz) {\n    return [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, tx, ty, tz, 1];\n  },\n\n  xRotation: function(angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n\n    return [1, 0, 0, 0, 0, c, s, 0, 0, -s, c, 0, 0, 0, 0, 1];\n  },\n\n  yRotation: function(angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n\n    return [c, 0, -s, 0, 0, 1, 0, 0, s, 0, c, 0, 0, 0, 0, 1];\n  },\n\n  zRotation: function(angleInRadians) {\n    var c = Math.cos(angleInRadians);\n    var s = Math.sin(angleInRadians);\n\n    return [c, s, 0, 0, -s, c, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];\n  },\n\n  scaling: function(sx, sy, sz) {\n    return [sx, 0, 0, 0, 0, sy, 0, 0, 0, 0, sz, 0, 0, 0, 0, 1];\n  }\n};`, `67285534855687730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">translation</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> tz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> tz<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">xRotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">yRotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">zRotation</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token function-variable function">scaling</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sx<span class="token punctuation">,</span> sy<span class="token punctuation">,</span> sz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>sx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们现在有三个旋转方法，在二维中只需要一个是因为我们只需要绕 Z 轴旋转，现在在三维中还可以绕 X 轴和 Y 轴旋转。它们看起来还是很简单，如果使用它们后你会发现和之前一样</p>\n<p>绕 Z 轴旋转</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37143933726838150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x * c + y * s;\nnewY = x * -s + y * c;`, `37143933726838150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x * c + y * s;\nnewY = x * -s + y * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>绕 Y 轴旋转</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43077573064838840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newX = x * c + z * s;\nnewZ = x * -s + z * c;`, `43077573064838840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newX = x * c + z * s;\nnewZ = x * -s + z * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>绕 X 轴旋转</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28935721353307020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`newY = y * c + z * s;\nnewZ = y * -s + z * c;`, `28935721353307020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">newY = y * c + z * s;\nnewZ = y * -s + z * c;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>它们提供这些旋转方式。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/bhlktz?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [axis-diagram](embedded-codesandbox://webgl-fundamental-3d/axis-diagram?view=preview) -->\n<p>同样的我们将实现一些简单的方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17982868013847763000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`translate: function(m, tx, ty, tz) {\n   return m4.multiply(m, m4.translation(tx, ty, tz));\n},\n\nxRotate: function(m, angleInRadians) {\n   return m4.multiply(m, m4.xRotation(angleInRadians));\n},\n\nyRotate: function(m, angleInRadians) {\n   return m4.multiply(m, m4.yRotation(angleInRadians));\n},\n\nzRotate: function(m, angleInRadians) {\n   return m4.multiply(m, m4.zRotation(angleInRadians));\n},\n\nscale: function(m, sx, sy, sz) {\n   return m4.multiply(m, m4.scaling(sx, sy, sz));\n},`, `17982868013847763000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function-variable function">translate</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> tz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> ty<span class="token punctuation">,</span> tz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token function-variable function">xRotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">xRotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token function-variable function">yRotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token function-variable function">zRotate</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> angleInRadians</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">zRotation</span><span class="token punctuation">(</span>angleInRadians<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token function-variable function">scale</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> sy<span class="token punctuation">,</span> sz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">scaling</span><span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还需要更新投影方法，这是原代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67155931726716215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`projection: function (width, height) {\n   // 注意：这个矩阵翻转了 Y 轴，所以 0 在上方\n   return [\n      2 / width, 0, 0,\n      0, -2 / height, 0,\n      -1, 1, 1\n   ];\n},`, `67155931726716215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function-variable function">projection</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 注意：这个矩阵翻转了 Y 轴，所以 0 在上方</span>\n   <span class="token keyword">return</span> <span class="token punctuation">[</span>\n      <span class="token number">2</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">/</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n   <span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它将像素坐标转换到裁剪空间，在初次尝试三维时我们将这样做</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89261369830429540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`projection: function(width, height, depth) {\n   // 注意：这个矩阵翻转了 Y 轴，所以 0 在上方\n   return [\n      2 / width, 0, 0, 0,\n      0, -2 / height, 0, 0,\n      0, 0, 2 / depth, 0,\n      -1, 1, 0, 1,\n   ];\n},`, `89261369830429540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function-variable function">projection</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 注意：这个矩阵翻转了 Y 轴，所以 0 在上方</span>\n   <span class="token keyword">return</span> <span class="token punctuation">[</span>\n      <span class="token number">2</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">/</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">/</span> depth<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>就像 X 和 Y 需要从像素空间转换到裁剪空间一样，Z 也需要。在这个例子中我也将 Z 单位化了，我会传递一些和 width 相似的值给 depth，所以我们的空间将会是 0 到 width 像素宽，0 到 height 像素高，但是对于 depth 将会是 -depth / 2 到 +depth / 2 。</p>\n<p>最后需要更新计算矩阵的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22769546306564690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算矩阵\nvar matrix = m4.projection(gl.canvas.clientWidth, gl.canvas.clientHeight, 400);\nmatrix = m4.translate(matrix, translation[0], translation[1], translation[2]);\nmatrix = m4.xRotate(matrix, rotation[0]);\nmatrix = m4.yRotate(matrix, rotation[1]);\nmatrix = m4.zRotate(matrix, rotation[2]);\nmatrix = m4.scale(matrix, scale[0], scale[1], scale[2]);\n\n// 设置矩阵\ngl.uniformMatrix4fv(matrixLocation, false, matrix);`, `22769546306564690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算矩阵</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/81z8xd?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step1](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step1?view=preview) -->\n<p>我们遇到的第一个问题是 F 在三维中过于扁平，所以很难看出三维效果。解决这个问题的方法是将它拉伸成三维几何体。现在的 F 是由三个矩形组成，每个矩形两个三角形。让它变三维需要 16 个矩形。三个矩形在正面，三个背面，一个左侧，四个右侧，两个上侧，三个底面。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-16-13-50-21-a3fe4f5e55b69fb5a06493f3dfb24830-8917b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 225px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAADdUlEQVQ4y12Te0xTVxzHL6L7SzNdFhfnK4ozi1gUQ3qhraXF1iuspaIwGAooKVuB1jBKi2DLQ2DAHQtUW4agtCnVVNGJraU+KCkqzAcPH5TVV0yMJvyjiYkxyu09P+GSy9jOP+d7fvn+Pud7cs7BsHkjaosYqz7qZrRGbQ5j62lpuq8ZYWvbGFFRs5itS8aC4VxLJ+NTAWBbSdO/sPTMMqy1dZTRFcbzC9j6sdaRhlqyz3tuNVF6SNs0Ibzse/59/4BmRduJZaxH/uR1eJzNORcAK1SbMadzktG/k/3hbN3051ibzfoMutPrIUAY4bZIB+17SkHXdBok53onN/sGGlb19Kxn/bEufxiWrNBg9+7CLMB0e+HM/BWGfXG845Hb3h6AHpmBeiDU0wPiXymH8GDo7+16+hFPS3mTDVBb1QlyR88H3OW3c1tObmQgALOw9o4AA8tPKfnG3PnPiN10D3p36qbGEvTosrQIOcoU9KAyFt2U70ZeohANxZfS47wS6ga/BFVaTgLuueqbO/KZs5MMzFhs3WyxPn5pr/PBdXHR1IOEMvCJipF91wGkqiGRvrEOrhcm04GDeOhmRhLySlXomiqL7vNIQN5eX/+fhLU1bqnFGnzfdfgC+OM1Uw9FBnBMN5zn56MAzwij8XpoTKuhE+r+gob0RvDnKND9bO6nW644GBzD70xTFs0l/KNpIPvEqSB0qTthUKihRvgGOJurRGrPLpTqykSk9hfo3qGlDXGXgMj1TnJlvUO7xX6okFuguagYFLLTT5cvq4tkYNq85uWWjnGw5plhNFZNDW83QEdhDiKDUlR+NSMkceqQ6FUKJTMZ6BxBEFK5ttSZPgHXIRII+p0Swa2QhOfu5kT+sJQBlpfavqyscpn3q/Mmqn8qoE2HMynyhQSMnuzQjyl9II1xgbzAAbKqFlAIrlA8vFUz/zPwt2k2sFrIbQnDBBly5kISy7P2EWW5D4s80o+GC/mhvYnDsAP3XIza8jNnZ5T3tyR+/5tE8ZW3/G3HiRk/IXQvVKZ/WsDeQwynevZhr8FIdoNFCbxTw/uUZ2BP0hCIYy62zU/CiVZ9GxlRsHJGH9j7jmmOjjyC4VvJsOhN5YwnhnN02rhJySzWRvCXiPCuQ0Scb0KEOypZEB7dEJ6WND73ewihi0nV1QzYd+uysP+Pz4/VkctcukeqAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 16 13 50 21" title="" data-src="/static/2022-05-16-13-50-21-a3fe4f5e55b69fb5a06493f3dfb24830-8917b.png" data-srcset="/static/2022-05-16-13-50-21-a3fe4f5e55b69fb5a06493f3dfb24830-a6db4.png 200w,\n/static/2022-05-16-13-50-21-a3fe4f5e55b69fb5a06493f3dfb24830-8917b.png 225w" data-sizes="(max-width: 225px) 100vw, 225px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>需要列出的还有很多，16 个矩形每个有两个三角形，每个三角形有 3 个顶点，所以一共有 96 个顶点。如果你想看这些可以去示例的源码里找。</p>\n<p>我们需要绘制更多顶点所以</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6258460296866564000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制几何体\nvar primitiveType = gl.TRIANGLES;\nvar offset = 0;\nvar count = 16 * 6;\ngl.drawArrays(primitiveType, offset, count);`, `6258460296866564000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制几何体</span>\n<span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span></span>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是对应结果</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/06sn49?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step2](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step2?view=preview) -->\n<p>拖动滑块很难看出它是三维的，让我们给矩形上不同的颜色。需要在顶点着色器中添加一个属性和一个可变量，将颜色值传到片断着色器中。</p>\n<p>这是新的顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38737476442380170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-3d&quot; type=&quot;x-shader/x-vertex&quot;>\n   attribute vec4 a_position;\n   attribute vec4 a_color;\n\n   uniform mat4 u_matrix;\n\n   varying vec4 v_color;\n\n   void main() {\n      // 将位置和矩阵相乘\n      gl_Position = u_matrix * a_position;\n\n      // 将颜色传递给片断着色器\n      v_color = a_color;\n   }\n</script>`, `38737476442380170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,13-14}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,13-14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-3d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   attribute vec4 a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">   attribute vec4 a_color<span class="token punctuation">;</span></span>\n   uniform mat4 u_matrix<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">   varying vec4 v_color<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">      <span class="token comment">// 将颜色传递给片断着色器</span></span><span class="gatsby-highlight-code-line">      v_color <span class="token operator">=</span> a_color<span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在片断着色器中使用颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26810490185231073000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;fragment-shader-3d&quot; type=&quot;x-shader/x-fragment&quot;>\n   precision mediump float;\n\n   // 从顶点着色器中传入\n   varying vec4 v_color;\n\n   void main() {\n      gl_FragColor = v_color;\n   }\n</script>`, `26810490185231073000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-5,8}"\n              >\n                <span class="gatsby-code-button-language">js{4-5,8}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"fragment-shader-3d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-fragment"</span><span class="token operator">></span>\n   precision mediump float<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">   <span class="token comment">// 从顶点着色器中传入</span></span><span class="gatsby-highlight-code-line">   varying vec4 v_color<span class="token punctuation">;</span></span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      gl_FragColor <span class="token operator">=</span> v_color<span class="token punctuation">;</span></span>   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要找到属性的位置，然后在另一个缓冲中存入对应的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56291260412126820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nvar colorLocation = gl.getAttribLocation(program, \'a_color\');\n\n// ...\n// 给颜色创建一个缓冲\nvar colorBuffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n// 将颜色值传入缓冲\nsetColors(gl);\n\n// ...\n// 向缓冲传入 \'F\' 的颜色值\nfunction setColors(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Uint8Array([\n      // 正面左竖\n      200,\n      70,\n      120,\n      200,\n      70,\n      120,\n      200,\n      70,\n      120,\n      200,\n      70,\n      120,\n      200,\n      70,\n      120,\n      200,\n      70,\n      120,\n\n      // 正面上横\n      200,\n      70,\n      120,\n      200,\n      70,\n      120\n    ]),\n    // ...\n    // ...\n    gl.STATIC_DRAW\n  );\n}`, `56291260412126820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n<span class="token comment">// 给颜色创建一个缓冲</span>\n<span class="token keyword">var</span> colorBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将颜色值传入缓冲</span>\n<span class="token function">setColors</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n<span class="token comment">// 向缓冲传入 \'F\' 的颜色值</span>\n<span class="token keyword">function</span> <span class="token function">setColors</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面左竖</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 正面上横</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span><span class="token punctuation">,</span>\n      <span class="token number">200</span><span class="token punctuation">,</span>\n      <span class="token number">70</span><span class="token punctuation">,</span>\n      <span class="token number">120</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token comment">// ...</span>\n    <span class="token comment">// ...</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在渲染时告诉颜色属性如何从缓冲中获取颜色值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3850194628596393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 启用颜色属性\ngl.enableVertexAttribArray(colorLocation);\n\n// 绑定颜色缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n\n// 告诉颜色属性怎么从 colorBuffer (ARRAY_BUFFER) 中读取颜色值\nvar size = 3; // 每次迭代使用 3 个单位的数据\nvar type = gl.UNSIGNED_BYTE; // 单位数据类型是无符号 8 位整数\nvar normalize = true; // 标准化数据 (从 0-255 转换到 0.0-1.0)\nvar stride = 0; // 0 = 移动距离 * 单位距离长度sizeof(type)，每次迭代跳多少距离到下一个数据\nvar offset = 0; // 从绑定缓冲的起始处开始\ngl.vertexAttribPointer(colorLocation, size, type, normalize, stride, offset);`, `3850194628596393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 启用颜色属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定颜色缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉颜色属性怎么从 colorBuffer (ARRAY_BUFFER) 中读取颜色值</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代使用 3 个单位的数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是无符号 8 位整数</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标准化数据 (从 0-255 转换到 0.0-1.0)</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动距离 * 单位距离长度sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从绑定缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们得到这个。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/ebud7i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step3](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step3?view=preview) -->\n<p>它好像把 ‘F’ 的所有部分都按照提供的顺序显示出来了，正面，背面，侧面等等。有时候这并不是想要的结果，在背面的物体反而被绘制出来了。</p>\n<p><img src="/static/polygon-drawing-order-6f0c8bfb4a988b0b830d2a0fe618b6ad.gif"></p>\n<p>红色部分是 ‘F’ 的正面，但是因为它在数据的前部所以最先被绘制出来，然后它后面的面绘制后挡住了它。例如紫色部分实际上是 ‘F’ 的背面，由于它在数据中是第二个所以第二个被画出来。</p>\n<p>WebGL 中的三角形有正反面的概念，正面三角形的顶点顺序是逆时针方向，反面三角形是顺时针方向。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-18-11-30-35-dcc0f83da6fad24ec82c14beeb61dca7-6144b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 232px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.65517241379311%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAAC5UlEQVQ4y2Ng42ZhqLkYzgACm/7XgGlZIxE3IMXJAAX8UlwwJoN99QwGJMDKKSxu0/v/PxOIoxmYzMAQ1G0JlsnZ7sMMorO3ervFzHH8D2Sqg/hyJqKMVedCwWq0glLBtG54DlitlImjo13F1D+efRtkQHyzrBZGsAKPKiNGqI1cNZfCb838n/0/dbU72NnFhwPBmvlkFMEKhNX04M4LXXp2X+7V///dOldlgfjhKy6C1TKs+F8KZhTs9Zsx+Uf6/0nf0v6XnwzeChK7838Wk322DoN751Kw2pTDn1nAjuhdX5d69Ov/tGPf/ocsOXMEJPb/P9BjUdPtwQqiZzl4d79O/N/7NulP3/vk/813o787FegpgV0ywQbsA/fuNWCLTdMbzGI23/uffOD9/6T97/7FbL7/3zy71RDudB5RLt7aS+GPQC4DGvqn503Sb5BLs7Z4F4PkG29FMZtl1sGChQnooovpJ378T9z7+nfSvje/00/++u8zdWcbzDxOYHhtnP4/63/P26TvQAN/A/FPkOGVZ0JOwLwSu+UuOCZDlpzuyTzzF+i6d99BBgLxz9QjX/6Hr7x8jQEai1HAmP3f+Tz+L8irU35l/J/8M/3/1N8Z//s/pvxPXOpiBrNZzSvG3KV16f+YLffB3s0Auiz95M//Gad+/wcZqhmQHMPgWWPM7lykLxM+2dY0bY17YNZmr5KiAwEzGm5Ebk5e7vrLp8G0A+LKjYzc4rK8QKalRV6HiXvXGn9gcinyn7lvWsji09vDV168r+4Tt4GBAJBj52WVg7IZCahlAyZ6QTCLmY1ZnoWDxYqNm9WBS4jdgIOfzZydh9WBnY/NHJRxQGp4JbgYmFhYGUzTGoBpUomblYvHko2Hz4qVm9eOnU/QAJsNIkDsAHQHCDsDsTsQq8IkGZkYQW6EuJKRURbI8oeq8wGKeDMyM4thM1QAqEAHiK1A3oWLMjEhVDDCaVEg1gWybIC0OEwaAF6MGEfnVjJKAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 18 11 30 35" title="" data-src="/static/2022-05-18-11-30-35-dcc0f83da6fad24ec82c14beeb61dca7-6144b.png" data-srcset="/static/2022-05-18-11-30-35-dcc0f83da6fad24ec82c14beeb61dca7-b0d34.png 200w,\n/static/2022-05-18-11-30-35-dcc0f83da6fad24ec82c14beeb61dca7-6144b.png 232w" data-sizes="(max-width: 232px) 100vw, 232px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>WebGL 可以只绘制正面或反面三角形，可以这样开启</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81802971084179060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.enable(gl.CULL_FACE);`, `81802971084179060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将它放在 drawScene 方法里，开启这个特性后 WebGL 默认“剔除”背面三角形，“剔除”在这里是“不用绘制”的花哨叫法。</p>\n<p>对于 WebGL 而言，一个三角形是顺时针还是逆时针是根据裁剪空间中的顶点顺序判断的，换句话说，WebGL 是根据你在顶点着色器中运算后提供的结果来判定的，这就意味着如果你把一个顺时针的三角形沿 X 轴缩放 -1，它将会变成逆时针，或者将顺时针的三角形旋转 180 度后变成逆时针。由于我们没有开启 CULL_FACE，所以可以同时看到顺时针（正面）和逆时针（反面）三角形。现在开启了，任何时候正面三角形无论是缩放还是旋转的原因导致翻转了，WebGL 就不会绘制它。这件事很有用，因为通常情况下你只需要看到你正面对的面。</p>\n<p>开启 CULL_FACE 后得到</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/lmtm5y?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step4](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step4?view=preview) -->\n<p>结果证明，大多数三角形朝向都是错的，旋转的时候你会看到背面的三角形，幸好它很容易解决，我们只需要看看哪些是三角形是反的，然后交换它们的两个顶点。例如一个反的三角形</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19819934060807710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  1,   2,   3,\n 40,  50,  60,\n700, 800, 900,`, `19819934060807710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">  1,   2,   3,\n 40,  50,  60,\n700, 800, 900,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>只需要交换后两个顶点的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42859911416849105000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  1,   2,   3,\n700, 800, 900,\n 40,  50,  60,`, `42859911416849105000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">  1,   2,   3,\n700, 800, 900,\n 40,  50,  60,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>通过修正朝向错误后得到</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/pfgtxt?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step5](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step5?view=preview) -->\n<p>这很接近实际效果了但是还有一个问题，即使所有三角形的朝向是正确的，然后背面的被剔除了，有些应该在背面的部分还是出现在了前面。</p>\n<p>深度缓冲有时也叫 Z-Buffer，是一个存储像素深度的矩形，一个深度像素对应一个着色像素，在绘制图像时组合使用。当 WebGL 绘制每个着色像素时也会写入深度像素，它的值基于顶点着色器返回的 Z 值，就像我们将 X 和 Y 转换到裁剪空间一样，Z 也在裁剪空间或者 (-1 到 +1)。这个值会被转换到深度空间( 0 到 +1)，WebGL 绘制一个着色像素之前会检查对应的深度像素，如果对应的深度像素中的深度值小于当前像素的深度值，WebGL 就不会绘制新的颜色。反之它会绘制片断着色器提供的新颜色并更新深度像素中的深度值。这也意味着在其他像素后面的像素不会被绘制。</p>\n<p>我们可以像这样开启这个特性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94796695928854940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.enable(gl.DEPTH_TEST);`, `94796695928854940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在开始绘制前还需要清除深度缓冲为 1.0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58611524715520600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene() {\n  // ...\n\n  // 清空画布和深度缓冲\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n  // ...\n}`, `58611524715520600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 清空画布和深度缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在得到</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/ts2ymi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-step6](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-step6?view=preview) -->\n<p>这才是三维！</p>\n<p>还有一件小事，在大多数三维数学库中没有负责像素空间与裁剪空间转换的 projection 方法。代替的是叫做 ortho 或 orthographic 的方法，它看起来像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52000258581616810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  orthographic: function(left, right, bottom, top, near, far) {\n    return [\n      2 / (right - left),\n      0,\n      0,\n      0,\n      0,\n      2 / (top - bottom),\n      0,\n      0,\n      0,\n      0,\n      2 / (near - far),\n      0,\n\n      (left + right) / (left - right),\n      (bottom + top) / (bottom - top),\n      (near + far) / (near - far),\n      1\n    ];\n  }\n};`, `52000258581616810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">orthographic</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> top<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>\n      <span class="token number">2</span> <span class="token operator">/</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">2</span> <span class="token operator">/</span> <span class="token punctuation">(</span>top <span class="token operator">-</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">2</span> <span class="token operator">/</span> <span class="token punctuation">(</span>near <span class="token operator">-</span> far<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> right<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span>bottom <span class="token operator">+</span> top<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>bottom <span class="token operator">-</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span>near <span class="token operator">+</span> far<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>near <span class="token operator">-</span> far<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token number">1</span>\n    <span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和我们简单的 projection 方法不同的是正射投影有更多的参数可以传递，左，右，上，下，近和远，给我们更灵活的选择。为了用这个方法实现之前的投影，需要这样调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56923823054112940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var left = 0;\nvar right = gl.canvas.clientWidth;\nvar bottom = gl.canvas.clientHeight;\nvar top = 0;\nvar near = 400;\nvar far = -400;\nm4.orthographic(left, right, bottom, top, near, far);`, `56923823054112940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> right <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">;</span>\n<span class="token keyword">var</span> bottom <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n<span class="token keyword">var</span> top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> near <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> far <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">400</span><span class="token punctuation">;</span>\nm4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> top<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webgl-三维透视投影"><a href="#webgl-%E4%B8%89%E7%BB%B4%E9%80%8F%E8%A7%86%E6%8A%95%E5%BD%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维透视投影</h1>\n<p>上一篇文章讲述了如何实现三维，那个三维用的不是透视投影，而是的所谓的“正射”投影，但那不是我们日常观看三维的方式。</p>\n<p>我们应使用透视投影代替它，但什么是透视投影？它的基础特性就是离得越远显得越小。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-222ff.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.38095238095239%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACjElEQVQoz5WPW0gUURzGT/RgdkMDU0vaHoIMsjAxC6yIQJIMr7nrKkllarigokEhle39Ioa2O7MzbjOmaRfR7K1eJAoXS11XYzWvac32UD3UU9Qw83Xc6C2IHn58f875853fIdefB7+b/DMy5afRPy1HGA7RnPkffphHZnHjxdQKcU2EZX2XGxV999Aa+gTb+BJckxJsgXeROZL/YnxJdb0Jw/xqNkzso8tykmE/UppOqe3TX9VrLwNqzZNB1TGxojoCK+rqsnVsUbWMztNciMx/QXFOfoBp5K1Eah4PyqSIYF3pZtU0MoOL/b1IrN6DlsmPqOy/j+bhKTgC7+EKSjSXYR+j1qMLlHnK3G9ezynO4DLM/pBEMpr1MskjIKeJqhVv4aizEiSboHrgEXbVH0IO04QCwQHDs6e46p+AcXwRlqkwLNNfYAl9/oNin/sGYzAskWjtenkNNSQFRI0v346NZbEghQSxFzQgurUgpZuw4UwUNCVxyDIcQUObGW08A8ZUA8ZaB8bWQLNe4Z2NaDfXSoR+VyZaWqglKsknWJtLEJMXhSRqnXk8GrqcONTp0+G8fA5MixUiz4Fra0VHYxk68zXoyt2GuwU7lZ5CDYTcHRIpLkqQM07EIDNri1qiS4ThZCKq0rai6/xh3L6khWAz0hIfOJ+Ih339EEQRLMfDK3aDbbHAV3EMojZZ6S5PRYd+n0Qe6FLkytQE1KfHq4NnD4Cvyob9igFedzs4QYT3jgC3243e3h4MDPTD4/GA46gly9JHBLCMB3xdkdKt2w1fcbJEuJK9sqn4IEwGvcq2WsFSG5/QCY6nFl4WLMtAEAQMDQ2Bj5x5I4Xe1VJ6v7rHdgiK72Yt+LI06Rcu/wbO8qWs0QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 19 11 22 58" title="" data-src="/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-fee1c.png" data-srcset="/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-a67b7.png 200w,\n/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-0b187.png 400w,\n/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-fee1c.png 800w,\n/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-b1a91.png 1200w,\n/static/2022-05-19-11-22-58-4ea6413cc5e31caaf16339481cd770a0-222ff.png 1344w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上方的示例中，远处的物体会变小，想要实现例子中近大远小的效果，简单的做法就是将裁减空间中的 X 和 Y 值除以 Z 值。</p>\n<p>你可以这么想：如果一个线段是 (10, 15) 到 (20,15)，它长度为十个单位，在当前的代码中它就是 10 个像素长，但是如果我们将它除以 Z，且 Z 值 为 1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18630742846254588000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`10 / 1 = 10\n20 / 1 = 20\nabs(10-20) = 10`, `18630742846254588000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">10 / 1 = 10\n20 / 1 = 20\nabs(10-20) = 10</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>它将是 10 个像素长，如果 Z 值为 2</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36330440667244225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`10 / 2 = 5\n20 / 2 = 10\nabs(5 - 10) = 5`, `36330440667244225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">10 / 2 = 5\n20 / 2 = 10\nabs(5 - 10) = 5</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>就是 5 像素了，当 Z 值为 3 时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44962540218471055000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`10 / 3 = 3.333\n20 / 3 = 6.666\nabs(3.333 - 6.666) = 3.333`, `44962540218471055000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">10 / 3 = 3.333\n20 / 3 = 6.666\nabs(3.333 - 6.666) = 3.333</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你可以看出随着 Z 变大距离就变远了，画的也会小一点。如果我们除以裁剪空间中的 Z，值可能会变大，因为 Z 是一个较小的值(-1 到 +1)。但是我们可以提供一个 fudgeFactor 因子和 Z 相乘，这样就可以调整缩放的程度。</p>\n<p>让我们来试试，首先修改顶点着色器，除以 Z 再乘以我们的 “fudgeFactor” 因子。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83508148727775410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-3d&quot; type=&quot;x-shader/x-vertex&quot;>\n  // ...\n  uniform float u_fudgeFactor;\n  // ...\n  void main() {\n    // 将位置和矩阵相乘\n    vec4 position = u_matrix * a_position;\n\n    // 调整除数\n    float zToDivideBy = 1.0 + position.z * u_fudgeFactor;\n\n    // x 和 y 除以调整后的除数\n    gl_Position = vec4(position.xy / zToDivideBy, position.zw);\n  }\n</script>`, `83508148727775410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,9-10,12-13}"\n              >\n                <span class="gatsby-code-button-language">js{3,9-10,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-3d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  uniform float u_fudgeFactor<span class="token punctuation">;</span></span>  <span class="token comment">// ...</span>\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将位置和矩阵相乘</span>\n    vec4 position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token comment">// 调整除数</span></span><span class="gatsby-highlight-code-line">    float zToDivideBy <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">+</span> position<span class="token punctuation">.</span>z <span class="token operator">*</span> u_fudgeFactor<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// x 和 y 除以调整后的除数</span></span><span class="gatsby-highlight-code-line">    gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>xy <span class="token operator">/</span> zToDivideBy<span class="token punctuation">,</span> position<span class="token punctuation">.</span>zw<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，由于裁减空间中的 Z 值是 -1 到 +1 的，所以 +1 是为了让 zToDivideBy 变成 0 到 <code class="language-text">+2 * fudgeFactor</code></p>\n<p>还需要更新代码以设置 fudgeFactor。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62402960630090460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nvar fudgeLocation = gl.getUniformLocation(program, \'u_fudgeFactor\');\n\n// ...\nvar fudgeFactor = 1;\n// ...\nfunction drawScene() {\n  // ...\n  // 设置 fudgeFactor\n  gl.uniform1f(fudgeLocation, fudgeFactor);\n\n  // 绘制几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 16 * 6;\n  gl.drawArrays(primitiveType, offset, count);\n  // ...\n}`, `62402960630090460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">var</span> fudgeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_fudgeFactor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n<span class="token keyword">var</span> fudgeFactor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token comment">// 设置 fudgeFactor</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>fudgeLocation<span class="token punctuation">,</span> fudgeFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/pokxmd?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-perspective](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-perspective?view=preview) -->\n<p>如果效果不明显，可以将 “fudgeFactor” 滑块从 1.0 拖到 0.0 来对比没添加这些代码之前的样子。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-23-11-12-31-c942b8801b3460af9800e28beacf184d-24151.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 313px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.0223642172524%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+ElEQVQoz2P4////v/////77B6LA7K9/gDwwBwb+AQX+/oNz4OIMEAoo8PDf302fv9TffzX/Uu+ndwdAysDqIAb9+//n2bM1T54s/g+1Aqb52e/flZfvpK/ZX92+aF5k954Ox+t3KyGaITq/33t/ZXHD0TMWR45YvXq5DW4uSPO5naeX+teecq24aF1yw6f5afecXz8fw1346dK9s+GtR20KTsyOOHra9cmTrTC3gjX/e/PxamjrMY/ic81BN6/t3vj8/8WLX8HGg1RdKZh22DznlEfd6eScL2/OwK0Faf73F8R6feTKcfvS0/WxLUvmpWTvSPW69PbVL4iKX+8+XUqdfLoo7PoK+2MXNszf+PbZXYjR/xgggQkk73avOmhdetKz5pR5xczccx8+QxwOMvrn66/XK1r3tEXlN2/0Nr3cU/AQ4i5waIPd9/P9pwvhbYe9imcvC7/5ZD8itMFG/3z1+XzKlGPWJQ3uG5atOgfy9N9/0Kj69wek7u3hSyesS+cujZn2NP3L9/eIeALb//v1p/NFvdOWBU14GP7g43lEPMNV3Gtbdcg6p3u7++XP+0DG//uDLPv75Zfj7V1tW+3Pvd+Kohnq+DcfrmVNv7Z+3a//v/7/+//v/z/kdAbS//TTowsnfv//haoZqgRqCXbw7z8sFYMoAJqia9bsRhwAAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 23 11 12 31" title="" data-src="/static/2022-05-23-11-12-31-c942b8801b3460af9800e28beacf184d-24151.png" data-srcset="/static/2022-05-23-11-12-31-c942b8801b3460af9800e28beacf184d-8a062.png 200w,\n/static/2022-05-23-11-12-31-c942b8801b3460af9800e28beacf184d-24151.png 313w" data-sizes="(max-width: 313px) 100vw, 313px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>事实上 WebGL 会将我们提供给 <code class="language-text">gl_Position</code> 的 x, y, z, w 值自动除以 w 。</p>\n<p>我们可以通过修改着色器来证明，用 zToDivideBy 代替 <code class="language-text">gl_Position.w</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15893285383854260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   // ...\n   uniform float u_fudgeFactor;\n   // ...\n   void main() {\n      // 将位置和矩阵相乘\n      vec4 position = u_matrix * a_position;\n\n      // 调整除数\n      float zToDivideBy = 1.0 + position.z * u_fudgeFactor;\n\n      // 将 x y z 除以 zToDivideBy\n      gl_Position = vec4(position.xyz, zToDivideBy);\n\n      // 传递颜色到给片断着色器\n      v_color = a_color;\n   }\n</script>`, `15893285383854260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13}"\n              >\n                <span class="gatsby-code-button-language">js{13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   <span class="token comment">// ...</span>\n   uniform float u_fudgeFactor<span class="token punctuation">;</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将位置和矩阵相乘</span>\n      vec4 position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n      <span class="token comment">// 调整除数</span>\n      float zToDivideBy <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">+</span> position<span class="token punctuation">.</span>z <span class="token operator">*</span> u_fudgeFactor<span class="token punctuation">;</span>\n\n      <span class="token comment">// 将 x y z 除以 zToDivideBy</span>\n<span class="gatsby-highlight-code-line">      gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> zToDivideBy<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n      <span class="token comment">// 传递颜色到给片断着色器</span>\n      v_color <span class="token operator">=</span> a_color<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看他们多像。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/1jhg42?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-perspective-w](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-perspective-w?view=preview) -->\n<p>为什么 WebGL 会自动除以 W ？因为使用矩阵的魔力，可以用把值从 z 传值到 w 。</p>\n<p>一个这样的矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75585808911699070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, 1,\n0, 0, 0, 0,`, `75585808911699070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, 1,\n0, 0, 0, 0,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将会把 z 的值复制给 w，你可以把每列看作</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87055292331959300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x_out = x_in * 1 +\n        y_in * 0 +\n        z_in * 0 +\n        w_in * 0 ;\n\ny_out = x_in * 0 +\n        y_in * 1 +\n        z_in * 0 +\n        w_in * 0 ;\n\nz_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 0 ;\n\nw_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 0 ;`, `87055292331959300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">x_out = x_in * 1 +\n        y_in * 0 +\n        z_in * 0 +\n        w_in * 0 ;\n\ny_out = x_in * 0 +\n        y_in * 1 +\n        z_in * 0 +\n        w_in * 0 ;\n\nz_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 0 ;\n\nw_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 0 ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>简化后得到</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96869229142845280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x_out = x_in;\ny_out = y_in;\nz_out = z_in;\nw_out = z_in;`, `96869229142845280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">x_out = x_in;\ny_out = y_in;\nz_out = z_in;\nw_out = z_in;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 w 原来就是 1.0 就会加 1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40014441842452370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, 1,\n0, 0, 0, 1,`, `40014441842452370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, 1,\n0, 0, 0, 1,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>他会将 W 的运算变为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60537861614381150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`w_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 1 ;`, `60537861614381150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">w_out = x_in * 0 +\n        y_in * 0 +\n        z_in * 1 +\n        w_in * 1 ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因为 w_in = 1.0 是已知的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88872770171626730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`w_out = z_in + 1;`, `88872770171626730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">w_out = z_in + 1;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后可以将 fudgeFactor 像这样放入矩阵中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63559739532632470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, fudgeFactor,\n0, 0, 0, 1,`, `63559739532632470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1, 0, 0, 0,\n0, 1, 0, 0,\n0, 0, 1, fudgeFactor,\n0, 0, 0, 1,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>相当于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78551303831367760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`w_out = x_in * 0 +\n        y_in * 0 +\n        z_in * fudgeFactor +\n        w_in * 1 ;`, `78551303831367760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">w_out = x_in * 0 +\n        y_in * 0 +\n        z_in * fudgeFactor +\n        w_in * 1 ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>简化后为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78006736927794170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`w_out = z_in * fudgeFactor + 1;`, `78006736927794170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">w_out = z_in * fudgeFactor + 1;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们来修改代码，使用这个矩阵。</p>\n<p>首先将顶点着色器还原，又变成简单的样子</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47614568119963540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;vertex-shader-2d&quot; type=&quot;x-shader/x-vertex&quot;>\n   uniform mat4 u_matrix;\n\n   void main() {\n      // 位置和矩阵相乘\n      gl_Position = u_matrix * a_position;\n      // ...\n   }\n</script>`, `47614568119963540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">"vertex-shader-2d"</span> type<span class="token operator">=</span><span class="token string">"x-shader/x-vertex"</span><span class="token operator">></span>\n   uniform mat4 u_matrix<span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 位置和矩阵相乘</span>\n      gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来定义一个方法实现 Z → W 的矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53158474817519650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function makeZToWMatrix(fudgeFactor) {\n  return [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, fudgeFactor, 0, 0, 0, 1];\n}`, `53158474817519650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">makeZToWMatrix</span><span class="token punctuation">(</span><span class="token parameter">fudgeFactor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fudgeFactor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后使用它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21294667198168750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n// 计算矩阵\nvar matrix = makeZToWMatrix(fudgeFactor);\nmatrix = m4.multiply(matrix, m4.projection(gl.canvas.clientWidth, gl.canvas.clientHeight, 400));\nmatrix = m4.translate(matrix, translation[0], translation[1], translation[2]);\nmatrix = m4.xRotate(matrix, rotation[0]);\nmatrix = m4.yRotate(matrix, rotation[1]);\nmatrix = m4.zRotate(matrix, rotation[2]);\nmatrix = m4.scale(matrix, scale[0], scale[1], scale[2]);\n\n// ...`, `21294667198168750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-4}"\n              >\n                <span class="gatsby-code-button-language">js{3-4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token comment">// 计算矩阵</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> matrix <span class="token operator">=</span> <span class="token function">makeZToWMatrix</span><span class="token punctuation">(</span>fudgeFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">projection</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和之前的很像。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/b0ky3t?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-perspective-w-matrix](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-perspective-w-matrix?view=preview) -->\n<p>这只是展示了除以 Z 值获可以实现透视投影，以及在 WebGL 中简单实现。</p>\n<p>但还有一些问题需要解决，比如将 Z 值设置为 -100 左右的时候会遇到下面的情形</p>\n<p><img src="/static/z-clipping-948d177dcce9ad96f72b6ddd71253aeb.gif"></p>\n<p>为什么会这样？为什么 F 提前消失了？WebGL 裁剪空间中的 X 和 Y 会被 +1 和 -1 裁剪，Z 也一样。我们看到的是 Z &#x3C; -1 的情况。</p>\n<p>我可以从数学方法深入探讨并寻找解决办法，但是你可以联想二维中的的解决方法。我们需要获取 Z 值，然后加上一些量，缩放一些量，就可以将任意范围映射到 -1 到 +1 的范围内。</p>\n<p>最有意思的是这件事可以在一个矩阵中完成，更方便的是，我们可以定义一个 fieldOfView 代替 fudgeFactor，计算出更合适的值。</p>\n<p>这是创建矩阵的方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25964843589728813000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  perspective: function(fieldOfViewInRadians, aspect, near, far) {\n    var f = Math.tan(Math.PI * 0.5 - 0.5 * fieldOfViewInRadians);\n    var rangeInv = 1.0 / (near - far);\n\n    return [f / aspect, 0, 0, 0, 0, f, 0, 0, 0, 0, (near + far) * rangeInv, -1, 0, 0, near * far * rangeInv * 2, 0];\n  }\n};\n\n// ...`, `25964843589728813000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">perspective</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fieldOfViewInRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> f <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> fieldOfViewInRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> rangeInv <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>near <span class="token operator">-</span> far<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>f <span class="token operator">/</span> aspect<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>near <span class="token operator">+</span> far<span class="token punctuation">)</span> <span class="token operator">*</span> rangeInv<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> near <span class="token operator">*</span> far <span class="token operator">*</span> rangeInv <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个矩阵会为我们完成所有转换。它可以调整单位以适应裁剪空间，它可以自定义视场角，选择 Z-裁剪面。假设有一个眼睛或者摄像机在原点(0, 0, 0)，根据 zNear 和 fieldOfView 可以将 zNear 对应到 Z = -1，在 zNear 平面上一半的 fieldOfView 长度对应画布中心到 Y = -1 或 Y = 1 的距离，X 的值通过乘以 aspect 获取，最后通过设置 zFar 对应 Z = 1，控制缩放的程度。</p>\n<p>这是矩阵的图解。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5sl3lw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [frustum-diagram](embedded-codesandbox://webgl-fundamental-3d/frustum-diagram?view=preview) -->\n<p>正方体所在的有四个侧面的椎体叫做“视锥”，矩阵将视锥中的空间转换到裁剪空间中，zNear 决定了被正面切割的位置，zFar 决定被背面切割的位置。将 zNear 设置为 23 就会看到正方体正面被切割，将 zFar 设置为 24 就会看到正方体背面被切割。</p>\n<p>还有一个问题，矩阵假定观察位置为 0, 0, 0 并且看向 Z 轴负方向，Y 轴为上方向。这和我们目前为止做法不同，为了解决这个问题我们需要将物体放到视图范围内。</p>\n<p>我们在 (45, 150, 0) 绘制的 F，可以将它移动到 (-150, 0, -360)</p>\n<p>使用 m4.projection 方法代替之前的投影方法，可以调用 m4.perspective</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94040955072626640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\nvar zNear = 1;\nvar zFar = 2000;\nvar matrix = m4.perspective(fieldOfViewRadians, aspect, zNear, zFar);\nmatrix = m4.translate(matrix, translation[0], translation[1], translation[2]);\nmatrix = m4.xRotate(matrix, rotation[0]);\nmatrix = m4.yRotate(matrix, rotation[1]);\nmatrix = m4.zRotate(matrix, rotation[2]);\nmatrix = m4.scale(matrix, scale[0], scale[1], scale[2]);`, `94040955072626640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n<span class="token keyword">var</span> zNear <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> zFar <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> zNear<span class="token punctuation">,</span> zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> translation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">zRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> rotation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果在这里。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/y9yucf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-perspective-matrix](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-perspective-matrix?view=preview) -->\n<p>我们讲了矩阵乘法，视角和自定义 Z 范围。还有很多没讲完，但这篇文章已经很长了，所以接下来继续讲相机。</p>\n<blockquote>\n<p><strong>为什么将 F 移动到那么远的距离（Z = -360）?</strong></p>\n<p>在其他的例子中 F 都在 (45, 150, 0)，但在最后一个例子中它被移动到了 (-150, 0, -360)。为什么它被移动到那么远的地方？</p>\n<p>原因是在最后一个例子中用 m4.projection 方法将像素移动到裁减空间，我们的显示范围是 <code class="language-text">400 x 300</code> 像素，<code class="language-text">像素</code> 在三维中无法解释。所以新投影创建了一个视锥，它在 zNear 的距离时是 2 个单位高和 <code class="language-text">2 * aspect</code> 个单位宽。由于 <code class="language-text">F</code> 的大小是 150 个单位，在近平面的时候只能看到 2 个单位的高度，所以我们将它移到足够远的地方才能看到完整的它。</p>\n<p>同样的将 <code class="language-text">X</code> 从 45 移动到 -150。过去视图表示的范围是 0 到 400 个单位，现在它表示的 -1 到 +1 个单位。</p>\n</blockquote>\n<h1 id="webgl-三维相机"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%9B%B8%E6%9C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维相机</h1>\n<p>在上篇文章中我们将 F 移动到了视锥中，原因是 <code class="language-text">m4.perspective</code> 默认将相机放在了原点 <code class="language-text">(0, 0, 0)</code> 并且视锥的范围是 <code class="language-text">-zNear</code> 到 <code class="language-text">-zFar</code>。</p>\n<p>将物体移动到视场中可能并不是正确的方法，在实际生活中通常是移动相机去拍摄建筑物。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/rsob1c?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [camera-move-camera](embedded-codesandbox://webgl-fundamental-3d/camera-move-camera?view=preview&initialpath=?mode=0) -->\n<p>将物体移动到相机前面并不是常见做法。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/rsob1c?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [camera-move-camera](embedded-codesandbox://webgl-fundamental-3d/camera-move-camera?view=preview&initialpath=?mode=1) -->\n<p>但在上节中由于投影的原因物体需要在 -Z 轴上，我们通过将相机移动到原点，物体移动到相机前来保持原始的相对位置。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/rsob1c?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [camera-move-camera](embedded-codesandbox://webgl-fundamental-3d/camera-move-camera?view=preview&initialpath=?mode=2) -->\n<p>高效的将物体移动到相机前是非常重要的。最简单的方式是使用一个“逆向”矩阵，计算逆矩阵的数学原理比较复杂但概念很简单，逆就是你想通过一个值去抵消一个值。例如，123 的逆就是 -123，一个缩放为 5 的缩放矩阵的逆是缩放为 1/5 或 0.2 的缩放矩阵，一个绕 X 轴旋转 30° 的旋转矩阵的逆是绕 X 旋转 -30°。</p>\n<p>目前为止我们使用过平移，旋转和缩放去控制 ‘F’ 的位置和姿态，将这些矩阵相乘后得到一个矩阵，可以将物体从原始位置移动到期望的位置，大小和姿态。我们可以对相机进行同样的操作，一旦有了相机从原点移动旋转到目标位置的矩阵后，就可以计算出它的逆矩阵，利用这个逆矩阵可以不动相机，将物体从相反的方向移动到相机前。</p>\n<p>让我们来做一个三维场景，像上图一样有一圈 ‘F’ 。</p>\n<p>首先，由于 5 个物体使用的是同一个投影矩阵，所以我们将投影矩阵的计算放在循环外</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7451518814078662000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算投影矩阵\nvar aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\nvar zNear = 1;\nvar zFar = 2000;\nvar projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, zNear, zFar);`, `7451518814078662000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算投影矩阵</span>\n<span class="token keyword">var</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n<span class="token keyword">var</span> zNear <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> zFar <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> zNear<span class="token punctuation">,</span> zFar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着计算相机矩阵，这个矩阵代表的是相机在世界坐标中的位置和姿态。下方的代码计算的是看向原点，在半径为 <code class="language-text">radius * 1.5</code> 的圆上移动的相机。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/rsob1c?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [camera-move-camera](embedded-codesandbox://webgl-fundamental-3d/camera-move-camera?view=preview&initialpath=?mode=3) -->\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9967351522434110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var numFs = 5;\nvar radius = 200;\n\n// 计算相机的矩阵\nvar cameraMatrix = m4.yRotation(cameraAngleRadians);\ncameraMatrix = m4.translate(cameraMatrix, 0, 0, radius * 1.5);`, `9967351522434110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> numFs <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> radius <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 计算相机的矩阵</span>\n<span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>cameraAngleRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\ncameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后通过相机矩阵计算“视图矩阵”，视图矩阵是将所有物体以相反于相机的方向运动，尽管相机还是在原点但是相对关系是期望的。我们可以使用 inverse 方法计算逆矩阵（完全对立的转换矩阵），在这个例子中提供的是绕原点转动的矩阵，它的逆矩阵是移动相机以外的所有物体，好像相机在原点一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33693205308601426000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 通过相机矩阵计算视图矩阵\nvar viewMatrix = m4.inverse(cameraMatrix);`, `33693205308601426000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 通过相机矩阵计算视图矩阵</span>\n<span class="token keyword">var</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>现在将视图矩阵和投影矩阵结合在一起</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10427330374042931000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算组合矩阵\nvar viewProjectionMatrix = m4.multiply(projectionMatrix, viewMatrix);`, `10427330374042931000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 计算组合矩阵</span>\n<span class="token keyword">var</span> viewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>最后绘制一圈 F，将每个 F 乘以视图投影矩阵，然后旋转和向外平移 radius 个单位。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83585966520592250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var ii = 0; ii < numFs; ++ii) {\n  var angle = (ii * Math.PI * 2) / numFs;\n  var x = Math.cos(angle) * radius;\n  var y = Math.sin(angle) * radius;\n\n  // 从视图投影矩阵开始\n  // 计算 F 的矩阵\n  var matrix = m4.translate(viewProjectionMatrix, x, 0, y);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 获得几何体\n  var primitiveType = gl.TRIANGLES;\n  var offset = 0;\n  var count = 16 * 6;\n  gl.drawArrays(primitiveType, offset, count);\n}`, `83585966520592250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> numFs<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span>ii <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> numFs<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> radius<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">*</span> radius<span class="token punctuation">;</span>\n\n  <span class="token comment">// 从视图投影矩阵开始</span>\n  <span class="token comment">// 计算 F 的矩阵</span>\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 获得几何体</span>\n  <span class="token keyword">var</span> primitiveType <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个绕 F 旋转的相机。拖动 cameraAngle 滑块移动相机。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/2cxg3w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-camera](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-camera?view=preview) -->\n<p>这样做没什么问题，但是有时利用旋转和平移去移动相机，让它到达期望的位置并看向期望的方向并不容易。例如你想让它总是看向一个特定的 F，而相机又在绕一圈 F 旋转，这时计算会变的相当复杂。</p>\n<p>幸好这有一个简单的方法，我们可以同时定义相机位置和朝向，然后矩阵就可以将相机放在那，基于矩阵这个工作就会变得非常简单。</p>\n<p>首先我们需要知道相机的期望位置，将它叫做 cameraPosition，然后需要知道看向或对准的目标位置，将它叫做 target。如果将 target 减去 cameraPosition 就会得到相机的朝向，将它叫做 zAxis。由于我们知道相机看向的是 -Z 方向，所以可以用另一种方式相减 <code class="language-text">cameraPosition - target</code>，将结果单位化后直接赋给矩阵的 z 区域。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80107153175695260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+\n| Zx | Zy | Zz |    |\n+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+`, `80107153175695260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+\n| Zx | Zy | Zz |    |\n+----+----+----+----+\n|    |    |    |    |\n+----+----+----+----+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>矩阵的这个区域代表的是 Z 轴。在这个例子中相机的 Z-axis 进行了单位化，单位化也就是一个做一个类似 1.0 的矢量，如果你回到二维旋转的文章，那里讲到的单位圆在二维旋转中用法，在三维中需要一个单位球，单位向量表示单位球上的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/d8lusx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [cross-product-diagram](embedded-codesandbox://webgl-fundamental-3d/cross-product-diagram?view=preview&initialpath=?mode=0) -->\n<p>这些信息还不够，只给了一个单位圆上点，如何来确定物体的姿态呢？这就需要填充矩阵的其他区域，尤其是 X 轴和 Y 轴。通常情况下我们知道它们互相垂直，如果再知道哪里是上方，在该例中是 <code class="language-text">(0, 1, 0)</code>，就可以使用“叉乘”去计算矩阵的 X 轴和 Y 轴。</p>\n<p>我不知道叉乘的数学意义是什么，但我知道将两个单位向量叉乘后可以得到一个和它们都垂直的向量。换句话说，如果你有一个向量指向东南方，一个向量指向上方，叉乘后会得到一个指向西南方或东北方的矢量，因为这两个矢量都和东南方和上方垂直，相乘的顺序不同得到结果相反。</p>\n<p>在任何情况下我们可以通过叉乘 zAxis 和 up 得到相机的 xAxis。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/d8lusx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [cross-product-diagram](embedded-codesandbox://webgl-fundamental-3d/cross-product-diagram?view=preview&initialpath=?mode=1) -->\n<p>现在我们有了 xAxis，可以叉乘 zAxis 和 xAxis 得到相机的 yAxis。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/d8lusx?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?mode=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [cross-product-diagram](embedded-codesandbox://webgl-fundamental-3d/cross-product-diagram?view=preview&initialpath=?mode=2) -->\n<p>现在将三个轴插入矩阵中，会给我们提供一个从 cameraPosition 指向 target 的转换，只需要再加上 position</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7019734783781107000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`+----+----+----+----+\n| Xx | Xy | Xz |  0 |  <- x axis\n+----+----+----+----+\n| Yx | Yy | Yz |  0 |  <- y axis\n+----+----+----+----+\n| Zx | Zy | Zz |  0 |  <- z axis\n+----+----+----+----+\n| Tx | Ty | Tz |  1 |  <- 相机位置\n+----+----+----+----+`, `7019734783781107000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">+----+----+----+----+\n| Xx | Xy | Xz |  0 |  &lt;- x axis\n+----+----+----+----+\n| Yx | Yy | Yz |  0 |  &lt;- y axis\n+----+----+----+----+\n| Zx | Zy | Zz |  0 |  &lt;- z axis\n+----+----+----+----+\n| Tx | Ty | Tz |  1 |  &lt;- 相机位置\n+----+----+----+----+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是计算叉乘的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56688354332538585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function cross(a, b) {\n  return [a[1] * b[2] - a[2] * b[1], a[2] * b[0] - a[0] * b[2], a[0] * b[1] - a[1] * b[0]];\n}`, `56688354332538585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">cross</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是向量相减的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77280889020516910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function subtractVectors(a, b) {\n  return [a[0] - b[0], a[1] - b[1], a[2] - b[2]];\n}`, `77280889020516910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">subtractVectors</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是单位化向量的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47583988348322870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function normalize(v) {\n  var length = Math.sqrt(v[0] * v[0] + v[1] * v[1] + v[2] * v[2]);\n  // 确定不会除以 0\n  if (length > 0.00001) {\n    return [v[0] / length, v[1] / length, v[2] / length];\n  } else {\n    return [0, 0, 0];\n  }\n}`, `47583988348322870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 确定不会除以 0</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">></span> <span class="token number">0.00001</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> length<span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> length<span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> length<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是计算“朝向”矩阵的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23274440515632165000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  lookAt: function(cameraPosition, target, up) {\n    var zAxis = normalize(subtractVectors(cameraPosition, target));\n    var xAxis = normalize(cross(up, zAxis));\n    var yAxis = normalize(cross(zAxis, xAxis));\n\n    return [\n      xAxis[0],\n      xAxis[1],\n      xAxis[2],\n      0,\n      yAxis[0],\n      yAxis[1],\n      yAxis[2],\n      0,\n      zAxis[0],\n      zAxis[1],\n      zAxis[2],\n      0,\n      cameraPosition[0],\n      cameraPosition[1],\n      cameraPosition[2],\n      1\n    ];\n  }\n};`, `23274440515632165000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">lookAt</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> zAxis <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> xAxis <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>up<span class="token punctuation">,</span> zAxis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> yAxis <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>zAxis<span class="token punctuation">,</span> xAxis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>\n      xAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      xAxis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      xAxis<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      yAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      yAxis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      yAxis<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      zAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      zAxis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      zAxis<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      cameraPosition<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      cameraPosition<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      cameraPosition<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token number">1</span>\n    <span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是在移动过程中朝向某个确切的 ‘F’ 的用法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10884567485481744000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// 计算第一个 F 的位置\nvar fPosition = [radius, 0, 0];\n\n// 计算相机在圆上的位置矩阵\nvar cameraMatrix = m4.yRotation(cameraAngleRadians);\ncameraMatrix = m4.translate(cameraMatrix, 0, 0, radius * 1.5);\n\n// 获得矩阵中相机的位置\nvar cameraPosition = [cameraMatrix[12], cameraMatrix[13], cameraMatrix[14]];\n\nvar up = [0, 1, 0];\n\n// 计算相机的朝向矩阵\nvar cameraMatrix = m4.lookAt(cameraPosition, fPosition, up);\n\n// 通过相机矩阵获得视图矩阵\nvar viewMatrix = m4.inverse(cameraMatrix);\n\n// ...`, `10884567485481744000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token comment">// 计算第一个 F 的位置</span>\n<span class="token keyword">var</span> fPosition <span class="token operator">=</span> <span class="token punctuation">[</span>radius<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 计算相机在圆上的位置矩阵</span>\n<span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>cameraAngleRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\ncameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 获得矩阵中相机的位置</span>\n<span class="token keyword">var</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span>cameraMatrix<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cameraMatrix<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cameraMatrix<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 计算相机的朝向矩阵</span>\n<span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> fPosition<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 通过相机矩阵获得视图矩阵</span>\n<span class="token keyword">var</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/9uxqkz?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-camera-look-at](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-camera-look-at?view=preview) -->\n<p>拖动滑块观察相机是如何追踪单个 ‘F’ 的。</p>\n<p>你也可以对其他东西使用 lookAt 方法而不只是相机。通常是让角色视线跟着某人，将炮塔指向目标，让物体沿着路径移动。你可以算出物体当前在路径上的位置和不久后的位置，然后将这两个值放入 lookAt 方法，可以让物体沿着路径移动并且朝着路径的方向。</p>\n<h2 id="lookat-标准"><a href="#lookat-%E6%A0%87%E5%87%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lookAt 标准</h2>\n<p>大多数三维数学库都有 lookAt 方法，通常它是用于计算 <code class="language-text">视图矩阵</code> 而不是 <code class="language-text">相机矩阵</code>。换句话说这个矩阵将所有物体移动到相机前而不是将相机移动到物体前。</p>\n<p>我发现它并不好用，前面指出一个 lookAt 方法有很多用处，当你需要视图矩阵的时候只需要调用 inverse 方法，但当你想要让角色跟随另一个角色或者炮台跟随目标的时候，在我看来 lookAt 方法返回世界坐标中的朝向和位置转换会好一些。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/51gr6f?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [webgl-3d-camera-look-at-heads](embedded-codesandbox://webgl-fundamental-3d/webgl-3d-camera-look-at-heads?view=preview) -->',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL 理论基础——三维/index.md absPath of file >>> MarkdownRemark",timeToRead:16,frontmatter:{date:"2022-05-16 11:31:23",path:"/webgl-fundamental-3d/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——三维",draft:null}}],length:164,tag:"前端",pagesSum:33,page:3}}}});