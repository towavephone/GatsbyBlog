webpackJsonp([46883582140183],{1565:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"基础 简介 entry（入口） 入口起点（entry point）即是 webpack 通过该起点找到本次项目所直接或间接依赖的资源（模块、库等），并对其进行处理，最后输出到 bundle 中。入口文件由用户自定义，可以是一个或者多个，每一个 entry 最后对应一个 bundle。 output（出口） 通过配置 output 属性可以告诉 webpack 将 bundle 命名并输出到对应的位置。 loader webpack 核心，webpack 本身只能识别 js 文件，对于非 js…",html:'<h1 id="基础"><a href="#%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基础</h1>\n<h2 id="简介"><a href="#%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h2>\n<h3 id="entry（入口）"><a href="#entry%EF%BC%88%E5%85%A5%E5%8F%A3%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>entry（入口）</h3>\n<p>入口起点（entry point）即是 webpack 通过该起点找到本次项目所直接或间接依赖的资源（模块、库等），并对其进行处理，最后输出到 bundle 中。入口文件由用户自定义，可以是一个或者多个，每一个 entry 最后对应一个 bundle。</p>\n<h3 id="output（出口）"><a href="#output%EF%BC%88%E5%87%BA%E5%8F%A3%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>output（出口）</h3>\n<p>通过配置 output 属性可以告诉 webpack 将 bundle 命名并输出到对应的位置。</p>\n<h3 id="loader"><a href="#loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loader</h3>\n<p>webpack 核心，webpack 本身只能识别 js 文件，对于非 js 文件，即需要 loader 转换为 js 文件。换句话说，Loader 就是资源转换器。由于在 webpack 里，所有的资源都是模块，不同资源都最终转化成 js 去处理。针对不同形式的资源采用不同的 Loader 去编译，这就是 Loader 的意义。</p>\n<h3 id="插件（plugin）"><a href="#%E6%8F%92%E4%BB%B6%EF%BC%88plugin%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件（plugin）</h3>\n<p>webpack 核心，loader 处理非 js 文件，那么插件可以有更广泛的用途。整个 webpack 其实就是各类的插件形成的，插件的范围包括，从打包优化和压缩，一直到重新定义环境中的变量。插件接口功能极其强大，可以用来处理各种各样的任务。</p>\n<h3 id="chunk"><a href="#chunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chunk</h3>\n<p>被 entry 所依赖的额外的代码块，同样可以包含一个或者多个文件。chunk 也就是一个个的 js 文件，在异步加载中用处很大。chunk 实际上就是 webpack 打包后的产物，如果你不想最后生成一个包含所有的 bundle，那么可以生成一个个 chunk，并通过按需加载引入。同时它还能通过插件提取公共依赖生成公共 chunk，避免多个 bundle 中有多个相同的依赖代码。</p>\n<h2 id="实践--优化"><a href="#%E5%AE%9E%E8%B7%B5--%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实践 &#x26; 优化</h2>\n<h3 id="url-loader--image-webpack-loader"><a href="#url-loader--image-webpack-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>url-loader &#x26; image-webpack-loader</h3>\n<p>url-loader 可以在文件大小（单位 byte）低于指定的限制，将文件转换为 DataURL，这在实际开发中非常有效，能够减少请求数，在 vue-cli 和 create-react-app 中也都能看到对这个 loader 的使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14187772533529252000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// &quot;url&quot; loader works just like &quot;file&quot; loader but it also embeds\n// assets smaller than specified size as data URLs to avoid requests.\n{\n  test: [/\\.bmp\\$/, /\\.gif\\$/, /\\.jpe?g\\$/, /\\.png\\$/],\n  loader: require.resolve(\'url-loader\'),\n  options: {\n    limit: 10000,\n    name: \'static/media/[name].[hash:8].[ext]\',\n  },\n},`, `14187772533529252000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// "url" loader works just like "file" loader but it also embeds</span>\n<span class="token comment">// assets smaller than specified size as data URLs to avoid requests.</span>\n<span class="token punctuation">{</span>\n  test<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\.bmp$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.gif$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.jpe?g$/</span><span class="token punctuation">,</span> <span class="token regex">/\\.png$/</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  loader<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'url-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    limit<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'static/media/[name].[hash:8].[ext]\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>image-webpack-loader 这是一个可以通过设置质量参数来压缩图片的插件，但个人觉得在实际开发中并不会经常使用，图片一般是 UI 提供，一般来说，他们是不会同意改变图片的质量。</p>\n<h3 id="资源私有化"><a href="#%E8%B5%84%E6%BA%90%E7%A7%81%E6%9C%89%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源私有化</h3>\n<p>以这种方式加载资源，你可以以更直观的方式将模块和资源组合在一起。无需依赖于含有全部资源的 /assets 目录，而是将资源与代码组合在一起。例如，类似这样的结构会非常有用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1811669154877115600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- |- /assets\n+ |– /components\n+ |  |– /my-component\n+ |  |  |– index.jsx\n+ |  |  |– index.css\n+ |  |  |– icon.svg\n+ |  |  |– img.png`, `1811669154877115600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">- |- /assets\n+ |– /components\n+ |  |– /my-component\n+ |  |  |– index.jsx\n+ |  |  |– index.css\n+ |  |  |– icon.svg\n+ |  |  |– img.png</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，这种选择见仁见智</p>\n<h3 id="tree-shaking"><a href="#tree-shaking" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tree-Shaking</h3>\n<p>前端中的 tree-shaking 就是将一些无关的代码删掉不打包。在 Webpack 项目中，我们通常会引用很多文件，但实际上我们只引用了其中的某些模块，但却需要引入整个文件进行打包，会导致我们的打包结果变得很大，通过 tree-shaking 将没有使用的模块摇掉，这样来达到删除无用代码的目的。</p>\n<p>Tree-Shaking 的原理可以参考<a href="https://juejin.cn/post/6844903544756109319" target="_blank" rel="nofollow noreferrer noopener">这篇文章</a></p>\n<p>归纳起来就是</p>\n<blockquote>\n<ol>\n<li>ES6 的模块引入是静态分析的，故而可以在编译时正确判断到底加载了什么代码。</li>\n<li>分析程序流，判断哪些变量未被使用、引用，进而删除此代码</li>\n</ol>\n</blockquote>\n<p><a href="https://segmentfault.com/a/1190000012794598" target="_blank" rel="nofollow noreferrer noopener">Tree-Shaking 不起作用，代码没有被删？</a></p>\n<p>归纳起来就是</p>\n<blockquote>\n<p>因为 Babel 的转译，使得引用包的代码有了副作用，而副作用会导致 Tree-Shaking 失效。</p>\n</blockquote>\n<p>Webpack 4 默认启用了 Tree Shaking。对副作用进行了消除，以下是在 4.19.1 的实验</p>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47659438457524380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { cube } from \'./math.js\';\n\nconsole.log(cube(5));`, `47659438457524380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> cube <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./math.js\'</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">cube</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>math.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28315929765277483000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不打包 square\nexport class square {\n  constructor() {\n    console.log(\'square\');\n  }\n}\n\nexport class cube {\n  constructor(x) {\n    return x * x * x;\n  }\n}`, `28315929765277483000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不打包 square</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">square</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">cube</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52127407306999276000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// babel 编译后，同不打包\n\'use strict\';\n\nObject.defineProperty(exports, \'__esModule\', {\n  value: true\n});\nexports.cube = cube;\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\'Cannot call a class as a function\');\n  }\n}\n\nvar square = (exports.square = function square() {\n  _classCallCheck(this, square);\n\n  console.log(\'square\');\n});\n\nfunction cube(x) {\n  console.log(\'cube\');\n  return x * x * x;\n}`, `52127407306999276000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// babel 编译后，同不打包</span>\n<span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n\nObject<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">\'__esModule\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  value<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>cube <span class="token operator">=</span> cube<span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'Cannot call a class as a function\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> square <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function-variable function">square</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> square<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'cube\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10853614153203251000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不打包\nexport function square(x) {\n  console.log(\'square\');\n  return x.a;\n}\n\nexport function cube(x) {\n  return x * x * x;\n}`, `10853614153203251000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不打包</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x<span class="token punctuation">.</span>a<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86647960225961400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// wow 被打包\nexport function square() {\n  console.log(\'square\');\n  return x.a;\n}\n\nsquare({ a: 1 });\n\nexport function cube() {\n  return x * x * x;\n}`, `86647960225961400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// wow 被打包</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'square\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> x<span class="token punctuation">.</span>a<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">square</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="sourcemap"><a href="#sourcemap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sourcemap</h3>\n<p>简单说，Source map 就是一个信息文件，里面储存着位置信息。也就是说，转换后的代码的每一个位置，所对应的转换前的位置。</p>\n<p>有了它，出错的时候，除错工具将直接显示原始代码，而不是转换后的代码，这无疑给开发者带来了很大方便。</p>\n<p>webpack 中的 devtool 配置项可以设置 sourcemap，可以参考官方文档，然而 devtool 的许多选项都讲的不是很清楚，这里推荐该<a href="https://juejin.cn/post/6844903450644316174" target="_blank" rel="nofollow noreferrer noopener">文章</a>，讲的比较详细</p>\n<p>要注意，避免在生产中使用 <code class="language-text">inline-*</code> 和 <code class="language-text">eval-*</code>，因为它们可以增加 bundle 大小，并降低整体性能。</p>\n<h3 id="模块热替换"><a href="#%E6%A8%A1%E5%9D%97%E7%83%AD%E6%9B%BF%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块热替换</h3>\n<p>热替换这一块目前大多数都是用的 webpack-dev-middleware 插件配合服务器使用的，而官方提供的 watch 模式反而比较少用，当然 webpack-dev-middleware 的底层监听 watch mode</p>\n<p>至于为什么不直接使用 watch 模式，则是 webpack-dev-middleware 快速编译，走内存；只依赖 webpack 的 watch mode 来监听文件变更，自动打包、每次变更都将新文件打包到本地，就会很慢。</p>\n<h3 id="defineplugin"><a href="#defineplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DefinePlugin</h3>\n<p>webpack.DefinePlugin 定义环境变量 process.env，这在实际开发中比较常用，参考 create-react-app 中的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99091187068560950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Makes some environment variables available to the JS code, for example:\n// if (process.env.NODE_ENV === \'development\') { ... }. See \\`./env.js\\`.\nnew webpack.DefinePlugin(env.stringified)`, `99091187068560950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Makes some environment variables available to the JS code, for example:</span>\n<span class="token comment">// if (process.env.NODE_ENV === \'development\') { ... }. See `./env.js`.</span>\n<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>stringified<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>不过，要注意不能在 config 中使用，因为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93208100560702370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.env.NODE_ENV === \'production\' ? \'[name].[hash].bundle.js\' : \'[name].bundle.js\';`, `93208100560702370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">?</span> <span class="token string">\'[name].[hash].bundle.js\'</span> <span class="token punctuation">:</span> <span class="token string">\'[name].bundle.js\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>NODE_ENV is set in the compiled code, not in the webpack.config.js file. You should not use enviroment variables in your configuration. Pass options via —env.option abc and export a function from the webpack.config.js.</p>\n</blockquote>\n<p>大致意思就是 NODE_ENV 是设置在 compiled 里面，而不是 config 文件里。</p>\n<h3 id="extracttextwebpackplugin"><a href="#extracttextwebpackplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ExtractTextWebpackPlugin</h3>\n<p>ExtractTextWebpackPlugin 将 css 抽取成单独文件，可以通过这种方式配合后端对 css 文件进行缓存。</p>\n<h3 id="splitchunksplugin"><a href="#splitchunksplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SplitChunksPlugin</h3>\n<p>webpack4 的代码分割插件。</p>\n<p>webpack4 中支持了零配置的特性，同时对块打包也做了优化，CommonsChunkPlugin 已经被移除了，现在是使用 optimization.splitChunks 代替。SplitChunksPlugin 的配置有几个需要比较关注一下</p>\n<ul>\n<li>async: 默认值， 将按需引用的模块打包</li>\n<li>initial: 分开优化打包异步和非异步模块</li>\n<li>all: all 会把异步和非异步同时进行优化打包。也就是说 moduleA 在 indexA 中异步引入，indexB 中同步引入，initial 下 moduleA 会出现在两个打包块中，而 all 只会出现一个。</li>\n</ul>\n<p>使用 cacheGroups 可以自定义配置打包块。</p>\n<h3 id="动态引入"><a href="#%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态引入</h3>\n<p>利用动态引入的文件打包成另一个包并懒加载它，其与 SplitChunksPlugin 的 cacheGroups 区别：</p>\n<ul>\n<li>Bundle splitting：实际上就是创建多个更小的文件，并行加载，以获得更好的缓存效果；主要的作用就是使浏览器并行下载，提高下载速度。并且运用浏览器缓存，只有代码被修改，文件名中的哈希值改变了才会去再次加载</li>\n<li>Code splitting：只加载用户最需要的部分，其余的代码都遵从懒加载的策略；主要的作用就是加快页面加载速度，不加载不必要加载的东西。</li>\n</ul>\n<p>参考代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93226289693158740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import _ from \'lodash\';\n\nfunction component() {\n  var element = document.createElement(\'div\');\n  var button = document.createElement(\'button\');\n  var br = document.createElement(\'br\');\n\n  button.innerHTML = \'Click me and look at the console!\';\n  element.innerHTML = _.join([\'Hello\', \'webpack\'], \' \');\n  element.appendChild(br);\n  element.appendChild(button);\n\n  // Note that because a network request is involved, some indication\n  // of loading would need to be shown in a production-level site/app.\n  button.onclick = (e) =>\n    import(/* webpackChunkName: &quot;print&quot; */ \'./print\').then((module) => {\n      var print = module.default;\n\n      print();\n    });\n\n  return element;\n}\n\ndocument.body.appendChild(component());`, `93226289693158740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> br <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'br\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">\'Click me and look at the console!\'</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token string">\'webpack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Note that because a network request is involved, some indication</span>\n  <span class="token comment">// of loading would need to be shown in a production-level site/app.</span>\n  button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "print" */</span> <span class="token string">\'./print\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> print <span class="token operator">=</span> module<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n\n      <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> element<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\ndocument<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意当调用 ES6 模块的 import() 方法（引入模块）时，必须指向模块的 .default 值，因为它才是 promise 被处理后返回的实际的 module 对象。</p>\n</blockquote>\n<h3 id="缓存-runtimechunk"><a href="#%E7%BC%93%E5%AD%98-runtimechunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存 runtimeChunk</h3>\n<p>因为 webpack 会把运行时代码放到最后的一个 bundle 中，所以即使我们修改了其他文件的代码，最后的一个 bundle 的 hash 也会改变，runtimeChunk 是把运行时代码单独提取出来的配置。这样就有利于我们和后端配合缓存文件。</p>\n<ul>\n<li>single: 所有入口共享一个生成的 runtimeChunk</li>\n<li>true/mutiple: 每个入口生成一个单独的 runtimeChunk</li>\n</ul>\n<h3 id="模块标识符"><a href="#%E6%A8%A1%E5%9D%97%E6%A0%87%E8%AF%86%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块标识符</h3>\n<p>有时候我们只是添加了个文件 print.js， 并在 index 引入</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68485834631612660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import Print from \'./print\';`, `68485834631612660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> Print <span class="token keyword">from</span> <span class="token string">\'./print\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打包的时候，期望只有 runtime 和 main 两个 bundle 的 hash 发生改变，但是通常所有 bundle 都发生了变化，因为每个 module.id 会基于默认的解析顺序(resolve order)进行增量。也就是说，当解析顺序发生变化，ID 也会随之改变。</p>\n<p>可以使用两个插件来解决这个问题。第一个插件是 NamedModulesPlugin，将使用模块的路径，而不是数字标识符。虽然此插件有助于在开发过程中输出结果的可读性，然而执行时间会长一些。第二个选择是使用 HashedModuleIdsPlugin。</p>\n<h3 id="provideplugin"><a href="#provideplugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ProvidePlugin</h3>\n<p>通过 ProvidePlugin 处理全局变量，以及其他更细粒度的<a href="https://www.webpackjs.com/guides/shimming/" target="_blank" rel="nofollow noreferrer noopener">处理</a></p>\n<h3 id="polyfills-的处理"><a href="#polyfills-%E7%9A%84%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>polyfills 的处理</h3>\n<p>首先了解一下 polyfills， 虽然在 webpack 中能够使用 es6\\es7 等的 API，但并不代表编译器支持这些 API，所以通常我们会用 polyfills 来自定义一个 API。</p>\n<p>那么在 webpack 中，一般是使用 babel-polyfill VS babel-runtime VS babel-preset-env 等来支持这些 API，而这三种怎么选择也是一个问题。</p>\n<p>在真正进入主题之前，我们先看一个 preset-env 的配置项，同时也是 package.json 中的一个配置项 browserslist</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86042833962604680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;browserslist&quot;: [&quot;last 1 version&quot;, &quot;> 1%&quot;, &quot;maintained node versions&quot;, &quot;not dead&quot;]\n}`, `86042833962604680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"last 1 version"</span><span class="token punctuation">,</span> <span class="token string">"> 1%"</span><span class="token punctuation">,</span> <span class="token string">"maintained node versions"</span><span class="token punctuation">,</span> <span class="token string">"not dead"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>根据这个配置，preset-env 或者 postcss 等会根据你的参数支持不同的 polyfills，具体的参数配置参考该<a href="https://juejin.cn/post/6844903669524086797" target="_blank" rel="nofollow noreferrer noopener">文章</a></p>\n<ul>\n<li>babel-polyfill 只需要引入一次，但会重写一些原生的已支持的方法，而且体积很大。</li>\n<li>transform-runtime 是利用 plugin 自动识别并替换代码中的新特性，你不需要再引入，只需要装好 babel-runtime 和 配好 plugin 就可以了。好处是按需替换，检测到你需要哪个，就引入哪个 polyfill，值得注意的是，instance 上新添加的一些方法，babel-plugin-transform-runtime 是没有做处理的，比如 数组的 includes, filter, fill 等</li>\n<li>babel-preset-env 根据当前的运行环境，自动确定你需要的 plugins 和 polyfills。通过各个 es 标准 feature 在不同浏览器以及 node 版本的支持情况，再去维护一个 feature 跟 plugins 之间的映射关系，最终确定需要的 plugins。</li>\n</ul>\n<h3 id="后编译"><a href="#%E5%90%8E%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后编译</h3>\n<p>日常我们引用的 Npm 包都是编译好的，这样带来的方便的同时也暴露了一些问题。</p>\n<p>代码冗余：一般来说，这些 NPM 包也是基于 ES2015+ 开发的，每个包都需要经过 babel 编译发布后才能被主应用使用，而这个编译过程往往会附加很多“编译代码”；每个包都会有一些相同的编译代码，这就造成大量代码的冗余，并且这部分冗余代码是不能通过 Tree Shaking 等技术去除掉的。</p>\n<p>非必要的依赖：考虑到组件库的场景，通常我们为了方便一股脑引入了所有组件；但实际情况下对于一个应用而言可能只是用到了部分组件，此时如果全部引入，也会造成代码冗余。</p>\n<p>所以我们自己的公司组件可以采用后编译的形式，即发布的是未经编译的 npm 包，在项目构建时才编译，我们公司采用的也是这种做法，因为我们的包都在一个目录下，所以不用考虑递归编译的问题。</p>\n<h3 id="设置环境变量"><a href="#%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置环境变量</h3>\n<p>这个比较简单，直接看代码或者官方文档即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91681262951218250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpack --env.NODE_ENV=local --env.production --progress`, `91681262951218250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">webpack --env.NODE_ENV<span class="token operator">=</span>local --env.production --progress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="其他插件"><a href="#%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他插件</h3>\n<ul>\n<li>CompressionWebpackPlugin 将文件压缩 文件大小减小很多 需要后端协助配置</li>\n<li>mini-css-extract-plugin 将 CSS 分离出来</li>\n<li>wbepack.IgnorePlugin 忽略匹配的模块</li>\n<li>uglifyjs-webpack-plugin 代码丑化，webpack4 的 mode（product）自动配置</li>\n<li>optimize-css-assets-webpack-plugincss 压缩</li>\n<li>webpack-md5-hash 使你的 chunk 根据内容生成 md5，用这个 md5 取代 webpack chunkhash。</li>\n<li>dllPlugin 提高构建速度</li>\n</ul>\n<h1 id="插件机制"><a href="#%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件机制</h1>\n<h2 id="tapable"><a href="#tapable" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable</h2>\n<p>Webpack 的插件机制依赖于一个核心的库 Tapable。</p>\n<h3 id="tapable-是什么"><a href="#tapable-%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 是什么</h3>\n<p>tapable 是一个类似于 nodejs 的 EventEmitter 的库, 主要是控制钩子函数的发布与订阅。当然，tapable 提供的 hook 机制比较全面，分为同步和异步两个大类(异步中又区分异步并行和异步串行)，而根据事件执行的终止条件的不同，由衍生出 Bail/Waterfall/Loop 类型。</p>\n<h3 id="tapable-的使用"><a href="#tapable-%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 的使用</h3>\n<h4 id="基本使用"><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本使用</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14853977759116765000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { SyncHook } = require(\'tapable\');\n\n// 创建一个同步 Hook，指定参数\nconst hook = new SyncHook([\'arg1\', \'arg2\']);\n\n// 注册\nhook.tap(\'a\', function(arg1, arg2) {\n  console.log(\'a\');\n});\n\nhook.tap(\'b\', function(arg1, arg2) {\n  console.log(\'b\');\n});\n\nhook.call(1, 2);`, `14853977759116765000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'tapable\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 创建一个同步 Hook，指定参数</span>\n<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'arg1\'</span><span class="token punctuation">,</span> <span class="token string">\'arg2\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册</span>\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="钩子类型"><a href="#%E9%92%A9%E5%AD%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>钩子类型</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-5fd75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.3901098901099%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACIUlEQVQ4y2NgoAwwAjE7Pz+HmDgjExOyBBs3N7+CIhMrG26tjCDNKjKyflZWbKysyIL8vLzB9vbiAoJwEXTABBat8PS42FBnKCcHEWFiAgm6aGtda2lItLGCK8O0GUTqysrGWVnycHBAvAFRKMLHl2RrrSQmygATIeB54gSRgKSmdnL/lII5i9xzClnY2SGCnHz8QVX1hXMXR7X18ImJq1pYJU2YHtfemzZpholfECIUhOXkvXKLwqobTIPCmFmgYcbGxWUXmxhWXe+WkcslICijpQNU45aW6Z1bpG5tizMIsYULE06lLGxsEmoaisZm/OLiCA1MTCLyCkom5sKy8kAuj5AwUI24sioIqagBPQJVp2hqXr52S8uO/ZEdfaycnBBBEXnF3AXLWnfuz5i9iFtI2DwssmrTzsJla0qWr6vZtNM1Kx+qmZmFRUJFTdHAmE8U2WZGYVk5BT1DIWkZIJdbUEhMURmIxJWUxRWV+UTFGKgAhOUU/Esr41q7LEIjmVhYIILsPDzG3j6uiUn67h5snFyQUGBiBgIWlPCTUFWP7+zPnTnfJT2bGZYNOPn5baNigopKLUPDgQZB0zIzMwOWYGcEGkwwwhiB9mJJ244umhU1XuKS/BBFjOCMoWcoU13vpaEtDQ5UZizWQlzv7a/b0RMoIwfNfZBcZW6l1Dsx1MBEHuxg3A5jZWMREOJEz63MjAJCXBBXoNnHwsICDD4A+2delzfOjGkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 08 07" title="" data-src="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-fee1c.png" data-srcset="/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-a67b7.png 200w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-0b187.png 400w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-fee1c.png 800w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-b1a91.png 1200w,\n/static/2021-09-02-11-08-07-97daa6010e75947671c8dd6a6f2953d9-5fd75.png 1456w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a5264.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.09934395501406%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACe0lEQVQ4y41US08aURidGWYYBaHRARGGOqC2zkB5jI80PnkKihGhgpI0rTUpBVvS1iY+i5LGLrpp0k033bar9keeXmZQRCVh8eXe3Pnm3O8753yXoigKvQUNiqZ7yaXQb7VCEN0wcFzXRKd9GKOieOecvnsJhQVFxq/qG9DNHxU/cqcX2Dq/hBSevk6sRJZwtr6m7Y0sowVzBXob8AHDYGbYph2wPA+b5IHdM9ZRsdXIwWsdQB/Zm0hVHFk9bhGRWAwPRRfsNuGqWgrKcgyLe2XYRiVIwTCm1rMIrazCH0vqFZnMyB4conB4iiGXG6vVGoqnDVR+/MTa8114HQ4CHIWBZXXAqXQGOfLDkEuEmsniw++/OPjzD8nyWw2QMRjgmlTg9gfAm83axY7xRxA8XvSZB7RqO1q+GQOCDbPZPOYKJW2v0WDk8SSeRCCRAsVykNRpKEtRKJE4XIQaE8nhObYNOF/YwfbJOQaJ0vLiMqKvXiP6Yg9TmQ0ties3IU7OSid1vKzuo0ZaLda/YPfbd4TiKS2HZw1tQHl+EXP5AsxDAiZmn2KhWMICucRHuL3dgSAIyH48RO64ju2LS/gS9wCKkzLURBIWm/1eDzbVDibTCBGu7/vOMkR1hm4Dzmw8w9ZxA87Hsi4CUYshVqJJaC2bTEiV97H5/hOCahhjig9SIAhvSMXgyAiMzG0fWliE1ZGeRjAWXUbx6AybR5+x0/iKQCzRHs1rDn1OVGoRYg+mK9BVtQaaQrr6DnkiYpNDf4vDG3Pe6+PQAiae1H04AUlWYGlZq6sP7w6/vq6s+rBdmtE5bkXX16aX8I4LhBqHDkgU1eeW7nh1mvEfJj2Z83rrNUoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 08 24" title="" data-src="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-fee1c.png" data-srcset="/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a67b7.png 200w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-0b187.png 400w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-fee1c.png 800w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-b1a91.png 1200w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-95179.png 1600w,\n/static/2021-09-02-11-08-24-67e3a49b25714423879b47b26d5e39b9-a5264.png 2134w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h5 id="basichook"><a href="#basichook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BasicHook</h5>\n<p>执行每一个，不关心函数的返回值，有 SyncHook、AsyncParallelHook、AsyncSeriesHook。</p>\n<h5 id="bailhook"><a href="#bailhook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BailHook</h5>\n<p>顺序执行 Hook，遇到第一个结果 result!==undefined 则返回，不再继续执行。有：SyncBailHook、AsyncSeriseBailHook, AsyncParallelBailHook。</p>\n<p>什么样的场景下会使用到 BailHook 呢？设想如下一个例子：假设我们有一个模块 M，如果它满足 A 或者 B 或者 C 三者任何一个条件，就将其打包为一个单独的。这里的 A、B、C 不存在先后顺序，那么就可以使用 AsyncParallelBailHook 来解决:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30109977115209597000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x.hooks.拆分模块的Hook.tap(\'A\', () => {\n  if (A 判断条件满足) {\n    return true\n  }\n})\nx.hooks.拆分模块的Hook.tap(\'B\', () => {\n  if (B 判断条件满足) {\n    return true\n  }\n})\nx.hooks.拆分模块的Hook.tap(\'C\', () => {\n  if (C 判断条件满足) {\n    return true\n  }\n})`, `30109977115209597000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">x<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">A</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">B</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>拆分模块的Hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">C</span> 判断条件满足<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 A 中返回为 true，那么就无须再去判断 B 和 C。但是当 A、B、C 的校验，需要严格遵循先后顺序时，就需要使用有顺序的 SyncBailHook(A、B、C 是同步函数时使用) 或者 AsyncSeriseBailHook(A、B、C 是异步函数时使用)。</p>\n<h5 id="waterfallhook"><a href="#waterfallhook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WaterfallHook</h5>\n<p>类似于 reduce，如果前一个 Hook 函数的结果 result !== undefined，则 result 会作为后一个 Hook 函数的第一个参数。既然是顺序执行，那么就只有 Sync 和 AsyncSeries 类中提供这个 Hook：SyncWaterfallHook，AsyncSeriesWaterfallHook</p>\n<p>当一个数据，需要经过 A，B，C 三个阶段的处理得到最终结果，并且 A 中如果满足条件 a 就处理，否则不处理，B 和 C 同样，那么可以使用如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89268717226553600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x.hooks.tap(\'A\', (data) => {\n  if (满足 A 需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})\nx.hooks.tap(\'B\', (data) => {\n  if (满足B需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})\nx.hooks.tap(\'C\', (data) => {\n  if (满足 C 需要处理的条件) {\n    // 处理数据 data\n    return data\n  } else {\n    return\n  }\n})`, `89268717226553600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">x<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足 <span class="token constant">A</span> 需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足<span class="token constant">B</span>需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nx<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>满足 <span class="token constant">C</span> 需要处理的条件<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理数据 data</span>\n    <span class="token keyword">return</span> data\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="loophook"><a href="#loophook" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LoopHook</h5>\n<p>不停的循环执行 Hook，直到所有函数结果 result === undefined。同样的，由于对串行性有依赖，所以只有 SyncLoopHook 和 AsyncSeriseLoopHook</p>\n<h3 id="tapable-的源码分析"><a href="#tapable-%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tapable 的源码分析</h3>\n<p>Tapable 基本逻辑是，先通过类实例的 tap 方法注册对应 Hook 的处理函数， 这里直接分析 sync 同步钩子的主要流程，其他的异步钩子和拦截器等就不赘述了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74070360235475260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const hook = new SyncHook([\'arg1\', \'arg2\']);`, `74070360235475260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'arg1\'</span><span class="token punctuation">,</span> <span class="token string">\'arg2\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>从该句代码，作为源码分析的入口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14821174169183670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SyncHook extends Hook {\n  // 错误处理，防止调用者调用异步钩子\n  tapAsync() {\n    throw new Error(\'tapAsync is not supported on a SyncHook\');\n  }\n  // 错误处理，防止调用者调用 promise 钩子\n  tapPromise() {\n    throw new Error(\'tapPromise is not supported on a SyncHook\');\n  }\n  // 核心实现\n  compile(options) {\n    factory.setup(this, options);\n    return factory.create(options);\n  }\n}`, `14821174169183670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 错误处理，防止调用者调用异步钩子</span>\n  <span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'tapAsync is not supported on a SyncHook\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 错误处理，防止调用者调用 promise 钩子</span>\n  <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'tapPromise is not supported on a SyncHook\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 核心实现</span>\n  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从类 SyncHook 看到，他是继承于一个基类 Hook，他的核心实现 compile 等会再讲，我们先看看基类 Hook</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50269932784123570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 变量的初始化\nconstructor(args) {\n if (!Array.isArray(args)) args = [];\n this._args = args;\n this.taps = [];\n this.interceptors = [];\n this.call = this._call;\n this.promise = this._promise;\n this.callAsync = this._callAsync;\n this._x = undefined;\n}`, `50269932784123570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 变量的初始化</span>\n<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_promise<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync<span class="token punctuation">;</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>初始化完成后，通常会注册一个事件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32092738699374900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 注册\nhook.tap(\'a\', function(arg1, arg2) {\n  console.log(\'a\');\n});\n\nhook.tap(\'b\', function(arg1, arg2) {\n  console.log(\'b\');\n});`, `32092738699374900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 注册</span>\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nhook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很明显这两个语句都会调用基类中的 tap 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94732464576394840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tap(options, fn) {\n    // 参数处理\n if (typeof options === &quot;string&quot;) options = { name: options };\n if (typeof options !== &quot;object&quot; || options === null)\n  throw new Error(\n   &quot;Invalid arguments to tap(options: Object, fn: function)&quot;\n  );\n options = Object.assign({ type: &quot;sync&quot;, fn: fn }, options);\n if (typeof options.name !== &quot;string&quot; || options.name === &quot;&quot;)\n  throw new Error(&quot;Missing name for tap&quot;);\n // 执行拦截器的 register 函数， 比较简单不分析\n options = this._runRegisterInterceptors(options);\n // 处理注册事件\n this._insert(options);\n}`, `94732464576394840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 参数处理</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">"object"</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>\n   <span class="token string">"Invalid arguments to tap(options: Object, fn: function)"</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">"sync"</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">"string"</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Missing name for tap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 执行拦截器的 register 函数， 比较简单不分析</span>\n options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 处理注册事件</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从上面的源码分析， 可以看到 _insert 方法是注册阶段的关键函数， 直接进入该方法内部</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34256591595919626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_insert(item) {\n    // 重置所有的 调用 方法\n this._resetCompilation();\n // 将注册事件排序后放进taps数组\n let before;\n if (typeof item.before === &quot;string&quot;) before = new Set([item.before]);\n else if (Array.isArray(item.before)) {\n  before = new Set(item.before);\n }\n let stage = 0;\n if (typeof item.stage === &quot;number&quot;) stage = item.stage;\n let i = this.taps.length;\n while (i > 0) {\n  i--;\n  const x = this.taps[i];\n  this.taps[i + 1] = x;\n  const xStage = x.stage || 0;\n  if (before) {\n   if (before.has(x.name)) {\n    before.delete(x.name);\n    continue;\n   }\n   if (before.size > 0) {\n    continue;\n   }\n  }\n  if (xStage > stage) {\n   continue;\n  }\n  i++;\n  break;\n }\n this.taps[i] = item;\n}`, `34256591595919626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 重置所有的 调用 方法</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token comment">// 将注册事件排序后放进taps数组</span>\n <span class="token keyword">let</span> before<span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n <span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">"number"</span><span class="token punctuation">)</span> stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>\n <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  i<span class="token operator">--</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    before<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">continue</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">continue</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">></span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">continue</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  i<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token keyword">break</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>_insert 主要是排序 tap 并放入到 taps 数组里面，排序的算法并不是特别复杂，这里就不赘述了，到了这里注册阶段就已经结束了，继续看触发阶段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5284817926610753000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hook.call(1, 2); // 触发函数`, `5284817926610753000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发函数</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在基类 hook 中有一个初始化过程</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29574542918443168000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.call = this._call;\n\nObject.defineProperties(Hook.prototype, {\n  _call: {\n    value: createCompileDelegate(\'call\', \'sync\'),\n    configurable: true,\n    writable: true\n  },\n  _promise: {\n    value: createCompileDelegate(\'promise\', \'promise\'),\n    configurable: true,\n    writable: true\n  },\n  _callAsync: {\n    value: createCompileDelegate(\'callAsync\', \'async\'),\n    configurable: true,\n    writable: true\n  }\n});`, `29574542918443168000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>\n\nObject<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Hook</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  _call<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'call\'</span><span class="token punctuation">,</span> <span class="token string">\'sync\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  _promise<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'promise\'</span><span class="token punctuation">,</span> <span class="token string">\'promise\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  _callAsync<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">\'callAsync\'</span><span class="token punctuation">,</span> <span class="token string">\'async\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    writable<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看出 _call 是由 createCompileDelegate 生成的，往下看</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82083099259589560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createCompileDelegate(name, type) {\n  return function lazyCompileHook(...args) {\n    this[name] = this._createCall(type);\n    return this[name](...args);\n  };\n}`, `82083099259589560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>createCompileDelegate 返回一个名为 lazyCompileHook 的函数，顾名思义即懒编译，直到调用 call 的时候，才会编译出正在的 call 函数。</p>\n<p>createCompileDelegate 也是调用的 _createCall， 而 _createCall 调用了 Compier 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43021438547377680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_createCall(type) {\n return this.compile({\n  taps: this.taps,\n  interceptors: this.interceptors,\n  args: this._args,\n  type: type\n });\n}\ncompile(options) {\n throw new Error(&quot;Abstract: should be overriden&quot;);\n}`, `43021438547377680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>\n  interceptors<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>\n  args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>\n  type<span class="token punctuation">:</span> type\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Abstract: should be overriden"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 compiler 必须由子类重写，返回到 syncHook 的 compile 函数，即我们一开始说的核心方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10357171052299540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SyncHookCodeFactory extends HookCodeFactory {\n  content({ onError, onResult, onDone, rethrowIfPossible }) {\n    return this.callTapsSeries({\n      onError: (i, err) => onError(err),\n      onDone,\n      rethrowIfPossible\n    });\n  }\n}\n\nconst factory = new SyncHookCodeFactory();\n\nclass SyncHook extends Hook {\n  compile(options) {\n    factory.setup(this, options);\n    return factory.create(options);\n  }\n}`, `10357171052299540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>\n  <span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onResult<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      onDone<span class="token punctuation">,</span>\n      rethrowIfPossible\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>\n  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键就在于 SyncHookCodeFactory 和工厂类 HookCodeFactory，先看 setup 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17144685795956472000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setup(instance, options) {\n  // 这里的 instance 是 syncHook 实例, 其实就是把 tap 进来的钩子数组给到钩子的 _x 属性里.\n  instance._x = options.taps.map(t => t.fn);\n}`, `17144685795956472000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 这里的 instance 是 syncHook 实例, 其实就是把 tap 进来的钩子数组给到钩子的 _x 属性里.</span>\n  instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=></span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后是最关键的 create 函数， 可以看到最后返回的 fn，其实是一个 new Function 动态生成的函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16970266277090218000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`create(options) {\n  // 初始化参数，保存 options 到本对象 this.options，保存 new Hook([&quot;options&quot;]) 传入的参数到 this._args\n  this.init(options);\n  let fn;\n  // 动态构建钩子，这里是抽象层，分同步、异步、promise\n  switch (this.options.type) {\n    // 先看同步\n    case &quot;sync&quot;:\n      // 动态返回一个钩子函数\n      fn = new Function(\n        // 生成函数的参数 no before no after 返回参数字符串 xxx,xxx 在\n        // 注意这里 this.args 返回的是一个字符串,\n        // 在这个例子中是 options\n        this.args(),\n        \'&quot;use strict&quot;;\\n\' +\n          this.header() +\n          this.content({\n            onError: err => \\`throw \\${err};\\n\\`,\n            onResult: result => \\`return \\${result};\\n\\`,\n            onDone: () => &quot;&quot;,\n            rethrowIfPossible: true\n          })\n      );\n      break;\n    case &quot;async&quot;:\n      fn = new Function(\n        this.args({\n          after: &quot;_callback&quot;\n        }),\n        \'&quot;use strict&quot;;\\n\' +\n          this.header() +\n          // 这个 content 调用的是子类类的 content 函数,\n          // 参数由子类传,实际返回的是 this.callTapsSeries() 返回的类容\n          this.content({\n            onError: err => \\`_callback(\\${err});\\n\\`,\n            onResult: result => \\`_callback(null, \\${result});\\n\\`,\n            onDone: () => &quot;_callback();\\n&quot;\n          })\n      );\n      break;\n    case &quot;promise&quot;:\n      let code = &quot;&quot;;\n      code += \'&quot;use strict&quot;;\\n\';\n      code += &quot;return new Promise((_resolve, _reject) => {\\n&quot;;\n      code += &quot;var _sync = true;\\n&quot;;\n      code += this.header();\n      code += this.content({\n        onError: err => {\n          let code = &quot;&quot;;\n          code += &quot;if(_sync)\\n&quot;;\n          code += \\`_resolve(Promise.resolve().then(() => { throw \\${err}; }));\\n\\`;\n          code += &quot;else\\n&quot;;\n          code += \\`_reject(\\${err});\\n\\`;\n          return code;\n        },\n        onResult: result => \\`_resolve(\\${result});\\n\\`,\n        onDone: () => &quot;_resolve();\\n&quot;\n      });\n      code += &quot;_sync = false;\\n&quot;;\n      code += &quot;});\\n&quot;;\n      fn = new Function(this.args(), code);\n      break;\n  }\n  // 把刚才 init 赋的值初始化为 undefined\n  // this.options = undefined;\n  // this._args = undefined;\n  this.deinit();\n\n  return fn;\n}`, `16970266277090218000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 初始化参数，保存 options 到本对象 this.options，保存 new Hook(["options"]) 传入的参数到 this._args</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> fn<span class="token punctuation">;</span>\n  <span class="token comment">// 动态构建钩子，这里是抽象层，分同步、异步、promise</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 先看同步</span>\n    <span class="token keyword">case</span> <span class="token string">"sync"</span><span class="token punctuation">:</span>\n      <span class="token comment">// 动态返回一个钩子函数</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>\n        <span class="token comment">// 生成函数的参数 no before no after 返回参数字符串 xxx,xxx 在</span>\n        <span class="token comment">// 注意这里 this.args 返回的是一个字符串,</span>\n        <span class="token comment">// 在这个例子中是 options</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'"use strict";\\n\'</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">""</span><span class="token punctuation">,</span>\n            rethrowIfPossible<span class="token punctuation">:</span> <span class="token boolean">true</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"async"</span><span class="token punctuation">:</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          after<span class="token punctuation">:</span> <span class="token string">"_callback"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'"use strict";\\n\'</span> <span class="token operator">+</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>\n          <span class="token comment">// 这个 content 调用的是子类类的 content 函数,</span>\n          <span class="token comment">// 参数由子类传,实际返回的是 this.callTapsSeries() 返回的类容</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"_callback();\\n"</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"promise"</span><span class="token punctuation">:</span>\n      <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">\'"use strict";\\n\'</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"return new Promise((_resolve, _reject) => {\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"var _sync = true;\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token function-variable function">onError</span><span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token string">"if(_sync)\\n"</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(Promise.resolve().then(() => { throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; }));\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token string">"else\\n"</span><span class="token punctuation">;</span>\n          code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_reject(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span> code<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">onResult</span><span class="token punctuation">:</span> <span class="token parameter">result</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n        <span class="token function-variable function">onDone</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"_resolve();\\n"</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"_sync = false;\\n"</span><span class="token punctuation">;</span>\n      code <span class="token operator">+=</span> <span class="token string">"});\\n"</span><span class="token punctuation">;</span>\n      fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 把刚才 init 赋的值初始化为 undefined</span>\n  <span class="token comment">// this.options = undefined;</span>\n  <span class="token comment">// this._args = undefined;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后生成的代码大致如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85966048953643160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;use strict&quot;;\nfunction (options) {\n  var _context;\n  var _x = this._x;\n  var _taps = this.taps;\n  var _interterceptors = this.interceptors;\n  // 我们只有一个拦截器所以下面的只会生成一个\n  _interceptors[0].call(options);\n\n  var _tap0 = _taps[0];\n  _interceptors[0].tap(_tap0);\n  var _fn0 = _x[0];\n  _fn0(options);\n  var _tap1 = _taps[1];\n  _interceptors[1].tap(_tap1);\n  var _fn1 = _x[1];\n  _fn1(options);\n  var _tap2 = _taps[2];\n  _interceptors[2].tap(_tap2);\n  var _fn2 = _x[2];\n  _fn2(options);\n  var _tap3 = _taps[3];\n  _interceptors[3].tap(_tap3);\n  var _fn3 = _x[3];\n  _fn3(options);\n}`, `85966048953643160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"use strict"</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _taps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _interterceptors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">;</span>\n  <span class="token comment">// 我们只有一个拦截器所以下面的只会生成一个</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> _tap0 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap0<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn0</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap1 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn1</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap2 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn2</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _tap3 <span class="token operator">=</span> _taps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  _interceptors<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_tap3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> _fn3 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token function">_fn3</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上就是 Tapabled 的机制，然而本篇的主要对象其实是基于 tapable 实现的 compile 和 compilation 对象。不过由于他们都是基于 tapable，所以介绍的篇幅相对短一点。</p>\n<h2 id="compile"><a href="#compile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile</h2>\n<h3 id="compile-是什么"><a href="#compile-%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile 是什么</h3>\n<p>compiler 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当在 webpack 环境中应用一个插件时，插件将收到此 compiler 对象的引用。可以使用 compiler 来访问 webpack 的主环境。</p>\n<p>也就是说，compile 是 webpack 的整体环境。</p>\n<h3 id="compile-的内部实现"><a href="#compile-%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile 的内部实现</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19619017806411220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Compiler extends Tapable {\n  constructor(context) {\n    super();\n    this.hooks = {\n      /** @type {SyncBailHook<Compilation>} */\n      shouldEmit: new SyncBailHook([\'compilation\']),\n      /** @type {AsyncSeriesHook<Stats>} */\n      done: new AsyncSeriesHook([\'stats\']),\n      /** @type {AsyncSeriesHook<>} */\n      additionalPass: new AsyncSeriesHook([])\n      /** @type {AsyncSeriesHook<Compiler>} */\n    };\n  }\n}`, `19619017806411220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">/** @type {SyncBailHook&lt;Compilation>} */</span>\n      shouldEmit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'compilation\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;Stats>} */</span>\n      done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'stats\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;>} */</span>\n      additionalPass<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler>} */</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 Compier 继承了 Tapable, 并且在实例上绑定了一个 hook 对象，使得 Compier 的实例 compier 可以像这样使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77852803965561030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.hooks.compile.tapAsync(\'afterCompile\', (compilation, callback) => {\n  console.log(\'This is an example plugin!\');\n  console.log(\'Here’s the \\`compilation\\` object which represents a single build of assets:\', compilation);\n\n  // 使用 webpack 提供的 plugin API 操作构建结果\n  compilation.addModule(/* ... */);\n\n  callback();\n});`, `77852803965561030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'afterCompile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This is an example plugin!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here’s the `compilation` object which represents a single build of assets:\'</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 webpack 提供的 plugin API 操作构建结果</span>\n  compilation<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compilation"><a href="#compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation</h2>\n<h3 id="什么是-compilation"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 compilation</h3>\n<p>compilation 对象代表了一次资源版本构建。当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 compilation，从而生成一组新的编译资源。一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。compilation 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p>\n<h3 id="compilation-的实现"><a href="#compilation-%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation 的实现</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76936545407860600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Compilation extends Tapable {\n  /**\n   * Creates an instance of Compilation.\n   * @param {Compiler} compiler the compiler which created the compilation\n   */\n  constructor(compiler) {\n    super();\n    this.hooks = {\n      /** @type {SyncHook<Module>} */\n      buildModule: new SyncHook([\'module\']),\n      /** @type {SyncHook<Module>} */\n      rebuildModule: new SyncHook([\'module\']),\n      /** @type {SyncHook<Module, Error>} */\n      failedModule: new SyncHook([\'module\', \'error\']),\n      /** @type {SyncHook<Module>} */\n      succeedModule: new SyncHook([\'module\']),\n\n      /** @type {SyncHook<Dependency, string>} */\n      addEntry: new SyncHook([\'entry\', \'name\'])\n      /** @type {SyncHook<Dependency, string, Error>} */\n    };\n  }\n}`, `76936545407860600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>\n  <span class="token comment">/**\n   * Creates an instance of Compilation.\n   * @param {Compiler} compiler the compiler which created the compilation\n   */</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      buildModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      rebuildModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module, Error>} */</span>\n      failedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">,</span> <span class="token string">\'error\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token comment">/** @type {SyncHook&lt;Module>} */</span>\n      succeedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'module\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n      <span class="token comment">/** @type {SyncHook&lt;Dependency, string>} */</span>\n      addEntry<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'entry\'</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">/** @type {SyncHook&lt;Dependency, string, Error>} */</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体参考上面提到的 compiler 实现。</p>\n<h2 id="编写一个插件"><a href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写一个插件</h2>\n<p>了解到 tapable\\compiler\\compilation 之后， 再来看插件的实现就不再一头雾水了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8183504310883905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyExampleWebpackPlugin {\n  // 定义 \\`apply\\` 方法\n  apply(compiler) {\n    // 指定要追加的事件钩子函数\n    compiler.hooks.compile.tapAsync(\'afterCompile\', (compilation, callback) => {\n      console.log(\'This is an example plugin!\');\n      console.log(\'Here’s the \\`compilation\\` object which represents a single build of assets:\', compilation);\n\n      // 使用 webpack 提供的 plugin API 操作构建结果\n      compilation.addModule(/* ... */);\n\n      callback();\n    });\n  }\n}`, `8183504310883905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyExampleWebpackPlugin</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 定义 `apply` 方法</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 指定要追加的事件钩子函数</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'afterCompile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This is an example plugin!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here’s the `compilation` object which represents a single build of assets:\'</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 使用 webpack 提供的 plugin API 操作构建结果</span>\n      compilation<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到其实就是在 apply 中传入一个 Compiler 实例，然后基于该实例注册事件，compilation 同理，最后 webpack 会在各流程执行 call 方法。</p>\n<h2 id="compiler-和-compilation-一些比较重要的事件钩子"><a href="#compiler-%E5%92%8C-compilation-%E4%B8%80%E4%BA%9B%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E4%BA%8B%E4%BB%B6%E9%92%A9%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compiler 和 compilation 一些比较重要的事件钩子</h2>\n<h3 id="compier"><a href="#compier" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compier</h3>\n<table>\n<thead>\n<tr>\n<th align="left">事件钩子</th>\n<th align="left">触发时机</th>\n<th align="left">参数</th>\n<th align="left">类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">entry-option</td>\n<td align="left">初始化 option</td>\n<td align="left">-</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">run</td>\n<td align="left">开始编译</td>\n<td align="left">compiler</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">compile</td>\n<td align="left">真正开始的编译，在创建 compilation 对象之前</td>\n<td align="left">compilation</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">compilation</td>\n<td align="left">生成好了 compilation 对象，可以操作这个对象啦</td>\n<td align="left">compilation</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">make</td>\n<td align="left">从 entry 开始递归分析依赖，准备对每个模块进行 build</td>\n<td align="left">compilation</td>\n<td align="left">AsyncParallelHook</td>\n</tr>\n<tr>\n<td align="left">after-compile</td>\n<td align="left">编译 build 过程结束</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">emit</td>\n<td align="left">在将内存中 assets 内容写到磁盘文件夹之前</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">after-emit</td>\n<td align="left">在将内存中 assets 内容写到磁盘文件夹之后</td>\n<td align="left">compilation</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">done</td>\n<td align="left">完成所有的编译过程</td>\n<td align="left">stats</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">failed</td>\n<td align="left">编译失败的时候</td>\n<td align="left">error</td>\n<td align="left">SyncHook</td>\n</tr>\n</tbody>\n</table>\n<h3 id="compilation-1"><a href="#compilation-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation</h3>\n<table>\n<thead>\n<tr>\n<th align="left">事件钩子</th>\n<th align="left">触发时机</th>\n<th align="left">参数</th>\n<th align="left">类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">normal-module-loader</td>\n<td align="left">普通模块 loader，真正（一个接一个地）加载模块图(graph)中所有模块的函数。</td>\n<td align="left">loaderContext module</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">seal</td>\n<td align="left">编译(compilation)停止接收新模块时触发。</td>\n<td align="left">-</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">optimize</td>\n<td align="left">优化阶段开始时触发。</td>\n<td align="left">-</td>\n<td align="left">SyncHook</td>\n</tr>\n<tr>\n<td align="left">optimize-modules</td>\n<td align="left">模块的优化</td>\n<td align="left">modules</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">optimize-chunks</td>\n<td align="left">优化 chunk</td>\n<td align="left">chunks</td>\n<td align="left">SyncBailHook</td>\n</tr>\n<tr>\n<td align="left">additional-assets</td>\n<td align="left">为编译(compilation)创建附加资源(asset)。</td>\n<td align="left">-</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">optimize-chunk-assets</td>\n<td align="left">优化所有 chunk 资源(asset)。</td>\n<td align="left">chunks</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n<tr>\n<td align="left">optimize-assets</td>\n<td align="left">优化存储在 compilation.assets 中的所有资源(asset)</td>\n<td align="left">assets</td>\n<td align="left">AsyncSeriesHook</td>\n</tr>\n</tbody>\n</table>\n<h1 id="流程"><a href="#%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程</h1>\n<h2 id="调试"><a href="#%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调试</h2>\n<ol>\n<li>\n<p>使用以下命令运行项目，./scripts/build.js 是你想要开始调试的地方</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17855767666120581000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --inspect-brk ./scripts/build.js --inline --progress`, `17855767666120581000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">node --inspect-brk ./scripts/build.js --inline --progress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>打开 chrome://inspect/#devices 即可调试</p>\n</li>\n</ol>\n<h2 id="流程图"><a href="#%E6%B5%81%E7%A8%8B%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程图</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fa1ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 110.37567084078712%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABlElEQVQ4y42U246CQBBE+f+fI74Q9GEFgyIXEbwBArJHenccBxa3EggzdE1XdTdYvYaHBrXU3/bvsNhK0zRJksvlcjqdgiCIoqgoCu5xHDdNo5jn81ktf8hcVVWVZdl1XV3X1+uV5/v9Xg5gU5HzPCfAJCtwMBH9FCC3bTshGw4veOBgyO0AISDh8Y43Mpoxg2dMhmF4PB5ZIl7IKO//hkVa8UzOw+EArRogrznr6xfr9drzPN/3KbDpGal6PUThfr9fLBa2bbuu6zgOZFpQ5MWLTEnJf7vd6BZHqAoDerZcLlerFS3EFOrYIexFRjNHbjab7Xa72+1U/s+eJTMJKSxWkaCXdFxtvebWfJN1C9OZBTjJssyIxmE8AMO0k3bgC3di21L2JAKdOpnjqAUcpoA7S5kIvgJTtmwZA/tBtgyjzKYslXhmRoo//h6fZEKJYGjQjDDE44eeCx+R7E8yn2SCCGWe0wEolwkVgnyec7IlDg6TPP6B/KtVMp7zjZ0mw0EwXZ0RafzqzFbJMH4kUxFkEv8NGZsHmVmE/M0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 11 37 01" title="" data-src="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fee1c.png" data-srcset="/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-a67b7.png 200w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-0b187.png 400w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fee1c.png 800w,\n/static/2021-09-02-11-37-01-4b67a83026d69459b48355b62550d276-fa1ac.png 1118w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="入口"><a href="#%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口</h2>\n<p>入口处在 bulid.js，可以看到其中的代码是先实例化 webpack，然后调用 compiler 的 run 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38056026017344590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function build(previousFileSizes) {\n  let compiler = webpack(config);\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats) => {\n      // ...\n    });\n  });\n}`, `38056026017344590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">previousFileSizes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="entry-option（compiler）"><a href="#entry-option%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>entry-option（compiler）</h2>\n<h3 id="webpackjs"><a href="#webpackjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack.js</h3>\n<p>webpack 在 node_moduls 下面的 <code class="language-text">\\webpack\\lib\\webpack.js</code>（在此前面有入口参数合并），找到该文件可以看到相关的代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82439799730425090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const webpack = (options, callback) => {\n  let compiler;\n  // 处理多个入口\n  if (Array.isArray(options)) {\n    compiler = new MultiCompiler(options.map((options) => webpack(options)));\n  } else if (typeof options === \'object\') {\n    // webpack 的默认参数\n    options = new WebpackOptionsDefaulter().process(options);\n    console.log(options); // 见下图\n    // 实例化 compiler\n    compiler = new Compiler(options.context);\n    compiler.options = options;\n    // 对 webpack 的运行环境处理\n    new NodeEnvironmentPlugin().apply(compiler);\n    // 根据上篇的 tabpable 可知，这里是为了注册插件\n    if (options.plugins && Array.isArray(options.plugins)) {\n      for (const plugin of options.plugins) {\n        plugin.apply(compiler);\n      }\n    }\n    // 触发两个事件点 environment/afterEnviroment\n    compiler.hooks.environment.call();\n    compiler.hooks.afterEnvironment.call();\n    // 设置 compiler 的属性并调用默认配置的插件，同时触发事件点 entry-option\n    compiler.options = new WebpackOptionsApply().process(options, compiler);\n  } else {\n    throw new Error(\'Invalid argument: options\');\n  }\n  if (callback) {\n    compiler.run(callback);\n  }\n  return compiler;\n};`, `82439799730425090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> compiler<span class="token punctuation">;</span>\n  <span class="token comment">// 处理多个入口</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiCompiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">\'object\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// webpack 的默认参数</span>\n    options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsDefaulter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 见下图</span>\n    <span class="token comment">// 实例化 compiler</span>\n    compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>\n    <span class="token comment">// 对 webpack 的运行环境处理</span>\n    <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 根据上篇的 tabpable 可知，这里是为了注册插件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 触发两个事件点 environment/afterEnviroment</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterEnvironment</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 设置 compiler 的属性并调用默认配置的插件，同时触发事件点 entry-option</span>\n    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Invalid argument: options\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> compiler<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a368f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 17.228739002932553%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAh0lEQVQI112OwQ6DIBBE+f8fNApaq9FELagsrl1ZoNRbO3mHmTlMRsAKsLxOAEQkRO8vz3yx9xzSn0KMv6VwGsw4gdHHvsO2IsD7OOg8w0UxcOSbbPLaMrNzKeXE8ZbYVDsX1VwWRpamrkyjtKy0LO2jtn1n+yd0bca1jWuUHfpvMw5ElC9+AAo2qugJ1ddtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 13 36 05" title="" data-src="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-fee1c.png" data-srcset="/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a67b7.png 200w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-0b187.png 400w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-fee1c.png 800w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-b1a91.png 1200w,\n/static/2021-09-02-13-36-05-25c9b47ad4d9a98b1697769e0be81428-a368f.png 1364w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看出 options 保存的就是本次 webpack 的一些配置参数，而其中的 plugins 属性则是 webpack 中最重要的插件。</p>\n<h3 id="new-webpackoptionsapplyprocess"><a href="#new-webpackoptionsapplyprocess" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>new WebpackOptionsApply().process</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60145855947899050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function process(options, compiler) {\n  let ExternalsPlugin;\n  compiler.outputPath = options.output.path;\n  compiler.recordsInputPath = options.recordsInputPath || options.recordsPath;\n  compiler.recordsOutputPath = options.recordsOutputPath || options.recordsPath;\n  compiler.name = options.name;\n  compiler.dependencies = options.dependencies;\n  if (typeof options.target === \'string\') {\n    let JsonpTemplatePlugin;\n    let FetchCompileWasmTemplatePlugin;\n    let ReadFileCompileWasmTemplatePlugin;\n    let NodeSourcePlugin;\n    let NodeTargetPlugin;\n    let NodeTemplatePlugin;\n\n    switch (options.target) {\n      case \'web\':\n        JsonpTemplatePlugin = require(\'./web/JsonpTemplatePlugin\');\n        FetchCompileWasmTemplatePlugin = require(\'./web/FetchCompileWasmTemplatePlugin\');\n        NodeSourcePlugin = require(\'./node/NodeSourcePlugin\');\n        new JsonpTemplatePlugin().apply(compiler);\n        new FetchCompileWasmTemplatePlugin({\n          mangleImports: options.optimization.mangleWasmImports\n        }).apply(compiler);\n        new FunctionModulePlugin().apply(compiler);\n        new NodeSourcePlugin(options.node).apply(compiler);\n        new LoaderTargetPlugin(options.target).apply(compiler);\n        break;\n      case \'webworker\':\n        // ...\n        break;\n    }\n    // ...\n  }\n  new JavascriptModulesPlugin().apply(compiler);\n  new JsonModulesPlugin().apply(compiler);\n  new WebAssemblyModulesPlugin({\n    mangleImports: options.optimization.mangleWasmImports\n  }).apply(compiler);\n\n  new EntryOptionPlugin().apply(compiler);\n  // 触发事件点 entry-options 并传入参数 context 和 entry\n  compiler.hooks.entryOption.call(options.context, options.entry);\n  new CompatibilityPlugin().apply(compiler);\n  // ...\n  new ImportPlugin(options.module).apply(compiler);\n  new SystemPlugin(options.module).apply(compiler);\n}`, `60145855947899050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ExternalsPlugin<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>outputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>recordsInputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>recordsInputPath <span class="token operator">||</span> options<span class="token punctuation">.</span>recordsPath<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>recordsOutputPath <span class="token operator">=</span> options<span class="token punctuation">.</span>recordsOutputPath <span class="token operator">||</span> options<span class="token punctuation">.</span>recordsPath<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>name <span class="token operator">=</span> options<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n  compiler<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> options<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> JsonpTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> FetchCompileWasmTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> ReadFileCompileWasmTemplatePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeSourcePlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeTargetPlugin<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> NodeTemplatePlugin<span class="token punctuation">;</span>\n\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> <span class="token string">\'web\'</span><span class="token punctuation">:</span>\n        JsonpTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./web/JsonpTemplatePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        FetchCompileWasmTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./web/FetchCompileWasmTemplatePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        NodeSourcePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./node/NodeSourcePlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">JsonpTemplatePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">FetchCompileWasmTemplatePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          mangleImports<span class="token punctuation">:</span> options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>mangleWasmImports\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">FunctionModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">NodeSourcePlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">new</span> <span class="token class-name">LoaderTargetPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> <span class="token string">\'webworker\'</span><span class="token punctuation">:</span>\n        <span class="token comment">// ...</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">new</span> <span class="token class-name">JavascriptModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">JsonModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">WebAssemblyModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    mangleImports<span class="token punctuation">:</span> options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>mangleWasmImports\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">new</span> <span class="token class-name">EntryOptionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 entry-options 并传入参数 context 和 entry</span>\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">entryOption</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">,</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">CompatibilityPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">new</span> <span class="token class-name">ImportPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">new</span> <span class="token class-name">SystemPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="run（compiler）"><a href="#run%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run（compiler）</h2>\n<p>调用 run 时，会先在内部触发 beforeRun 事件点，然后再在读取 <a href="https://webpack.docschina.org/configuration/other-options/#recordspath" target="_blank" rel="nofollow noreferrer noopener">records</a> 之前触发 run 事件点，这两个事件都是异步的形式，注意 run 方法是实际上整个 webpack 打包流程的入口。可以看到，最后调用的是 compile 方法，同时传入的是 onCompiled 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61933783795730360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function run(callback) {\n  if (this.running) return callback(new ConcurrentCompilationError());\n  const finalCallback = (err, stats) => {\n    // ......\n  };\n  this.running = true;\n\n  const onCompiled = (err, compilation) => {\n    // ....\n  };\n\n  this.hooks.beforeRun.callAsync(this, (err) => {\n    if (err) return finalCallback(err);\n\n    this.hooks.run.callAsync(this, (err) => {\n      if (err) return finalCallback(err);\n\n      this.readRecords((err) => {\n        if (err) return finalCallback(err);\n\n        this.compile(onCompiled);\n      });\n    });\n  });\n}`, `61933783795730360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentCompilationError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">finalCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">onCompiled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ....</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readRecords</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compile（compiler）"><a href="#compile%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compile（compiler）</h2>\n<p>compile 方法主要上触发 beforeCompile、compile、make 等事件点，并实例化 compilation，这里我们可以看到传给 compile 的 newCompilationParams 参数，这个参数在后面相对流程中也是比较重要，可以在这里先看一下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38488613678626390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compile(callback) {\n  const params = this.newCompilationParams();\n  // 触发事件点 beforeCompile，并传入参数 CompilationParams\n  this.hooks.beforeCompile.callAsync(params, (err) => {\n    if (err) return callback(err);\n    // 触发事件点 compile，并传入参数 CompilationParams\n    this.hooks.compile.call(params);\n    // 实例化 compilation\n    const compilation = this.newCompilation(params);\n    // 触发事件点 make\n    this.hooks.make.callAsync(compilation, (err) => {\n      // ....\n    });\n  });\n}`, `38488613678626390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 beforeCompile，并传入参数 CompilationParams</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 触发事件点 compile，并传入参数 CompilationParams</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 实例化 compilation</span>\n    <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 触发事件点 make</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ....</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>newCompilationParams 返回的参数分别是两个工厂函数和一个 Set 集合</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52468833520847634000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function newCompilationParams() {\n  const params = {\n    normalModuleFactory: this.createNormalModuleFactory(),\n    contextModuleFactory: this.createContextModuleFactory(),\n    compilationDependencies: new Set()\n  };\n  return params;\n}`, `52468833520847634000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>\n    normalModuleFactory<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    contextModuleFactory<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContextModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    compilationDependencies<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> params<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="compilation（compiler）"><a href="#compilation%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>compilation（compiler）</h2>\n<p>从上面的 compile 方法看， compilation 是通过 newCompilation 方法调用生成的，然后触发事件点 thisCompilation 和 compilation，可以看出 compilation 在这两个事件点中最早当成参数传入，如果你在编写插件的时候需要尽快使用该对象，则应该在该两个事件中进行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40889832126623736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createCompilation() {\n  return new Compilation(this);\n}\nfunction newCompilation(params) {\n  const compilation = this.createCompilation();\n  compilation.fileTimestamps = this.fileTimestamps;\n  compilation.contextTimestamps = this.contextTimestamps;\n  compilation.name = this.name;\n  compilation.records = this.records;\n  compilation.compilationDependencies = params.compilationDependencies;\n  // 触发事件点 thisCompilation 和 compilation， 同时传入参数 compilation 和 params\n  this.hooks.thisCompilation.call(compilation, params);\n  this.hooks.compilation.call(compilation, params);\n  return compilation;\n}`, `40889832126623736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">newCompilation</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>fileTimestamps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileTimestamps<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>contextTimestamps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contextTimestamps<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>records <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>records<span class="token punctuation">;</span>\n  compilation<span class="token punctuation">.</span>compilationDependencies <span class="token operator">=</span> params<span class="token punctuation">.</span>compilationDependencies<span class="token punctuation">;</span>\n  <span class="token comment">// 触发事件点 thisCompilation 和 compilation， 同时传入参数 compilation 和 params</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">thisCompilation</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compilation</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> compilation<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是打印出来的 compilation 属性</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-e3184.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.12551079976649%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/ElEQVQoz4VR0ZKDIAzk/3/xXvpQbZGKSEAFg3QBe+1Mb+Z2djIhJmFZhR0tGRdj3JkTuO8nYzxjTT6R0pErBD2INGE4hlCILejGd6DGXFmQ8/uYEqKwo9NyJufLzajnV+fxAlakgnYtN3UxoijspR9/LnN3pb6zfYfE3nq69f5+Wwe5qGHT425nXpf8BUHS6Ks0D2WUmqTUg3TT5IxZzARu1gZHwbvgPdfHH8wfw5CtDB4KYd+73+KbfubCxM0UGOb0MDlH82wBR+SJ1mWBc818LkBaxn7/BRfPkyBF+q7hcq201nNx/g/CG4/hLWzQwm0WEXs5Vev/5lbxBOytDfSYx3HfAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 13 59 52" title="" data-src="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-fee1c.png" data-srcset="/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-a67b7.png 200w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-0b187.png 400w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-fee1c.png 800w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-b1a91.png 1200w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-95179.png 1600w,\n/static/2021-09-02-13-59-52-58f7d2541d648fff9d5585dbbd43bdc5-e3184.png 1713w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于这里为什么要有 thisCompilation 这个事件点和子编译器（childCompiler），可以参考该<a href="https://lxzjj.github.io/2017/11/08/%E7%8E%A9%E8%BD%ACwebpack%EF%BC%88%E4%BA%8C%EF%BC%89/" target="_blank" rel="nofollow noreferrer noopener">文章</a></p>\n<p>总结起来就是:</p>\n<p>子编译器拥有完整的模块解析和 chunk 生成阶段,但是少了某些事件点，如”make”, “compile”, “emit”, “after-emit”, “invalid”, “done”, “this-compilation”。 也就是说我们可以利用子编译器来独立（于父编译器）跑完一个核心构建流程，额外生成一些需要的模块或者 chunk。</p>\n<h2 id="make（compiler）"><a href="#make%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>make（compiler）</h2>\n<p>从上面的 compile 方法知道， 实例化 Compilation 后就会触发 make 事件点了。触发了 make 时， 因为 webpack 在前面实例化 SingleEntryPlugin 或者 MultleEntryPlugin，SingleEntryPlugin 则在其 apply 方法中注册了一个 make 事件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54640444211438854000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function apply(compiler) {\n  compiler.hooks.compilation.tap(\'SingleEntryPlugin\', (compilation, { normalModuleFactory }) => {\n    compilation.dependencyFactories.set(\n      SingleEntryDependency,\n      normalModuleFactory // 工厂函数，存在 compilation 的 dependencyFactories 集合\n    );\n  });\n\n  compiler.hooks.make.tapAsync(\'SingleEntryPlugin\', (compilation, callback) => {\n    const { entry, name, context } = this;\n\n    const dep = SingleEntryPlugin.createDependency(entry, name);\n    // 进入到 addEntry\n    compilation.addEntry(context, dep, name, callback);\n  });\n}`, `54640444211438854000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'SingleEntryPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    compilation<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>\n      SingleEntryDependency<span class="token punctuation">,</span>\n      normalModuleFactory <span class="token comment">// 工厂函数，存在 compilation 的 dependencyFactories 集合</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'SingleEntryPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> dep <span class="token operator">=</span> SingleEntryPlugin<span class="token punctuation">.</span><span class="token function">createDependency</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 进入到 addEntry</span>\n    compilation<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事实上 addEntry 调用的是 <code class="language-text">Comilation._addModuleChain</code>，acquire 函数比较简单，主要是处理 module 时如果任务太多，就将 moduleFactory.create 存入队列等待</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45688102361047030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function _addModuleChain(context, dependency, onModule, callback) {\n  // ......\n  // 取出对应的Factory\n  const Dep = /** @type {DepConstructor} */ (dependency.constructor);\n  const moduleFactory = this.dependencyFactories.get(Dep);\n  // ......\n  this.semaphore.acquire(() => {\n    moduleFactory.create(\n      {\n        contextInfo: {\n          issuer: \'\',\n          compiler: this.compiler.name\n        },\n        context: context,\n        dependencies: [dependency]\n      },\n      (err, module) => {\n        // ......\n      }\n    );\n  });\n}`, `45688102361047030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_addModuleChain</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> dependency<span class="token punctuation">,</span> onModule<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 取出对应的Factory</span>\n  <span class="token keyword">const</span> Dep <span class="token operator">=</span> <span class="token comment">/** @type {DepConstructor} */</span> <span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> moduleFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Dep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    moduleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        contextInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          issuer<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n          compiler<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>name\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>\n        dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>dependency<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// ......</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>moduleFactory.create 则是收集一系列信息然后创建一个 module 传入回调</p>\n<h2 id="buildmodule（compilation）"><a href="#buildmodule%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>buildModule（compilation）</h2>\n<p>回调函数主要上执行 buildModule 方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43432528095928254000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.buildModule(module, false, null, null, (err) => {\n  // ......\n  afterBuild();\n});`, `43432528095928254000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token function">afterBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18748869544594272000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function buildModule(module, optional, origin, dependencies, thisCallback) {\n  // 处理回调函数\n  let callbackList = this._buildingModules.get(module);\n  if (callbackList) {\n    callbackList.push(thisCallback);\n    return;\n  }\n  this._buildingModules.set(module, (callbackList = [thisCallback]));\n\n  const callback = (err) => {\n    this._buildingModules.delete(module);\n    for (const cb of callbackList) {\n      cb(err);\n    }\n  };\n  // 触发 buildModule 事件点\n  this.hooks.buildModule.call(module);\n  module.build(\n    this.options,\n    this,\n    this.resolverFactory.get(\'normal\', module.resolveOptions),\n    this.inputFileSystem,\n    (error) => {\n      // ......\n    }\n  );\n}`, `18748869544594272000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> optional<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> thisCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理回调函数</span>\n  <span class="token keyword">let</span> callbackList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    callbackList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>thisCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">(</span>callbackList <span class="token operator">=</span> <span class="token punctuation">[</span>thisCallback<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_buildingModules<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cb <span class="token keyword">of</span> callbackList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 触发 buildModule 事件点</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>resolverFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'normal\'</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>resolveOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// ......</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>build 方法中调用的是 doBuild，doBuild 又通过 runLoaders 获取 loader 相关的信息并转换成 webpack 需要的 js 文件，最后通过 doBuild 的回调函数调用 parse 方法，创建依赖 Dependency 并放入依赖数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51435449845028610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`return this.doBuild(options, compilation, resolver, fs, (err) => {\n  // 在 createLoaderContext 函数中触发事件 normal-module-loader\n  const loaderContext = this.createLoaderContext(resolver, options, compilation, fs);\n  // .....\n  const handleParseResult = (result) => {\n    this._lastSuccessfulBuildMeta = this.buildMeta;\n    this._initBuildHash(compilation);\n    return callback();\n  };\n\n  try {\n    // 调用 parser.parse\n    const result = this.parser.parse(\n      this._ast || this._source.source(),\n      {\n        current: this,\n        module: this,\n        compilation: compilation,\n        options: options\n      },\n      (err, result) => {\n        if (err) {\n          handleParseError(err);\n        } else {\n          handleParseResult(result);\n        }\n      }\n    );\n    if (result !== undefined) {\n      // parse is sync\n      handleParseResult(result);\n    }\n  } catch (e) {\n    handleParseError(e);\n  }\n});`, `51435449845028610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在 createLoaderContext 函数中触发事件 normal-module-loader</span>\n  <span class="token keyword">const</span> loaderContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLoaderContext</span><span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> fs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// .....</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">handleParseResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_lastSuccessfulBuildMeta <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildMeta<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initBuildHash</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 调用 parser.parse</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        current<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>\n        module<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>\n        compilation<span class="token punctuation">:</span> compilation<span class="token punctuation">,</span>\n        options<span class="token punctuation">:</span> options\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">handleParseError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// parse is sync</span>\n      <span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">handleParseError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 ast 转换过程中也很容易得到了需要依赖的哪些其他模块。</p>\n<h2 id="succeedmodule（compilation）"><a href="#succeedmodule%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>succeedModule（compilation）</h2>\n<p>最后执行了 module.build 的回调函数，触发了事件点 succeedModule，并回到 Compilation.buildModule 函数的回调函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14972259994244364000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.build(\n  this.options,\n  this,\n  this.resolverFactory.get(\'normal\', module.resolveOptions),\n  this.inputFileSystem,\n  (error) => {\n    // ......\n    触发了事件点succeedModule;\n    this.hooks.succeedModule.call(module);\n    return callback();\n  }\n);\n\nthis.buildModule(module, false, null, null, (err) => {\n  // ......\n  // 执行afterBuild\n  afterBuild();\n});`, `14972259994244364000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>resolverFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'normal\'</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>resolveOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n    触发了事件点succeedModule<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">succeedModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 执行afterBuild</span>\n  <span class="token function">afterBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于当前模块，或许存在着多个依赖模块。当前模块会开辟一个依赖模块的数组，在遍历 AST 时，将 require() 中的模块通过 addDependency() 添加到数组中。当前模块构建完成后，webpack 调用 processModuleDependencies 开始递归处理依赖的 module，接着就会重复之前的构建步骤。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11155584791694960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Compilation.prototype.addModuleDependencies = function(module, dependencies, bail, cacheGroup, recursive, callback) {\n  // 根据依赖数组(dependencies)创建依赖模块对象\n  var factories = [];\n  for (var i = 0; i < dependencies.length; i++) {\n    var factory = _this.dependencyFactories.get(dependencies[i][0].constructor);\n    factories[i] = [factory, dependencies[i]];\n  }\n  // ...\n  // 与当前模块构建步骤相同\n};`, `11155584791694960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Compilation</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addModuleDependencies</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> bail<span class="token punctuation">,</span> cacheGroup<span class="token punctuation">,</span> recursive<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据依赖数组(dependencies)创建依赖模块对象</span>\n  <span class="token keyword">var</span> factories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> factory <span class="token operator">=</span> _this<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    factories<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>factory<span class="token punctuation">,</span> dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// ...</span>\n  <span class="token comment">// 与当前模块构建步骤相同</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，所有的模块都会被放入到 Compilation 的 modules 里面， 如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.590511860174782%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQY05WPSw7DIAwFuf8dESC+hiagBAEBKa0Fmy66aGZhzcMGGQIAIQTrLDhUsNZ6793kO8IEBYc9+HVOOOdKKsaYUgpdcIFCKZVS8smKq4tjWuvVFUIQYww+mXMeY9Rae+/XdbXWUFb9GVcluMm2vVqr7+cQ/GqAUMqzy/eElKOUo55nxp3v/0gp7fseY/wAnxVWKsneRuQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 09 58" title="" data-src="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-fee1c.png" data-srcset="/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-a67b7.png 200w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-0b187.png 400w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-fee1c.png 800w,\n/static/2021-09-02-14-09-58-6a4b9e1046337e17b52c08d4c9f425c5-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-19100.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.19230769230769%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA70lEQVQoz31Si27DIAzk/39z0ramaSDYYLs8sqOJ2j3anS7SQbDPNjg/hbBEzVLNriKllNZarRVfr3V7DZx0dCEOUVKyGDXSFSm+ASeeCmQnIseezKz13rdtcEc7ANH/APtwZmYXpjWcznldU1jNFLBBGS6qYH0GxIuIC6cwv0+aGERBYL3VNnq+OfQXQLzjheL5UiRX1VZKP0ZVdv3PwEYwzSScMGoYbqPxn7jv/PoF51pdnOPyMWeKRRXZ9qE9iBVaMLsHN9Uish1lez6/fXIIQpTWkINXaO9lWSCMSKdJcYsp4RWgwOI9GlTmzPwFWZAPgovjOkEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 10 14" title="" data-src="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-fee1c.png" data-srcset="/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-a67b7.png 200w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-0b187.png 400w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-fee1c.png 800w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-b1a91.png 1200w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-95179.png 1600w,\n/static/2021-09-02-14-10-14-118fc84aa9c24820182f01e91d8089e1-19100.png 1872w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总结一下：</p>\n<p>module 是 webpack 构建的核心实体，也是所有 module 的 父类，它有几种不同子类：NormalModule、MultiModule、ContextModule、DelegatedModule 等，一个依赖对象（Dependency，还未被解析成模块实例的依赖对象。比如我们运行 webpack 时传入的入口模块，或者一个模块依赖的其他模块，都会先生成一个 Dependency 对象。）经过对应的工厂对象（Factory）创建之后，就能够生成对应的模块实例（Module）。</p>\n<h2 id="seal（compilation）"><a href="#seal%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>seal（compilation）</h2>\n<p>构建 module 后， 就会调用 Compilation.seal， 该函数主要是触发了事件点 seal， 构建 chunk， 在所有 chunks 生成之后，webpack 会对 chunks 和 modules 进行一些优化相关的操作，比如分配 id、排序等，并且触发一系列相关的事件点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83623350747184740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function seal(callback) {\n  // 触发事件点 seal\n  this.hooks.seal.call();\n  // 优化\n  // ......\n  this.hooks.afterOptimizeDependencies.call(this.modules);\n\n  this.hooks.beforeChunks.call();\n  // 生成 chunk\n  for (const preparedEntrypoint of this._preparedEntrypoints) {\n    const module = preparedEntrypoint.module;\n    const name = preparedEntrypoint.name;\n    // 整理每个 Module 和 chunk，每个 chunk 对应一个输出文件。\n    const chunk = this.addChunk(name);\n    const entrypoint = new Entrypoint(name);\n    entrypoint.setRuntimeChunk(chunk);\n    entrypoint.addOrigin(null, name, preparedEntrypoint.request);\n    this.namedChunkGroups.set(name, entrypoint);\n    this.entrypoints.set(name, entrypoint);\n    this.chunkGroups.push(entrypoint);\n\n    GraphHelpers.connectChunkGroupAndChunk(entrypoint, chunk);\n    GraphHelpers.connectChunkAndModule(chunk, module);\n\n    chunk.entryModule = module;\n    chunk.name = name;\n\n    this.assignDepth(module);\n  }\n  this.processDependenciesBlocksForChunkGroups(this.chunkGroups.slice());\n  this.sortModules(this.modules);\n  this.hooks.afterChunks.call(this.chunks);\n\n  this.hooks.optimize.call();\n\n  // ......\n  this.hooks.afterOptimizeModules.call(this.modules);\n\n  // ......\n  this.hooks.afterOptimizeChunks.call(this.chunks, this.chunkGroups);\n\n  this.hooks.optimizeTree.callAsync(this.chunks, this.modules, (err) => {\n    // ......\n    this.hooks.beforeChunkAssets.call();\n    this.createChunkAssets(); // 生成对应的 Assets\n    this.hooks.additionalAssets.callAsync(/* ... */);\n  });\n}`, `83623350747184740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 触发事件点 seal</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 优化</span>\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeDependencies</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 生成 chunk</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> preparedEntrypoint <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_preparedEntrypoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> module <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>module<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> name <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n    <span class="token comment">// 整理每个 Module 和 chunk，每个 chunk 对应一个输出文件。</span>\n    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> entrypoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entrypoint</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    entrypoint<span class="token punctuation">.</span><span class="token function">setRuntimeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    entrypoint<span class="token punctuation">.</span><span class="token function">addOrigin</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> preparedEntrypoint<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>namedChunkGroups<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>entrypoints<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkGroupAndChunk</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkAndModule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    chunk<span class="token punctuation">.</span>entryModule <span class="token operator">=</span> module<span class="token punctuation">;</span>\n    chunk<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assignDepth</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependenciesBlocksForChunkGroups</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sortModules</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeModules</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ......</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeTree<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ......</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成对应的 Assets</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalAssets<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个 chunk 的生成就是找到需要包含的 modules。这里大致描述一下 chunk 的生成算法：</p>\n<ol>\n<li>webpack 先将 entry 中对应的 module 都生成一个新的 chunk</li>\n<li>遍历 module 的依赖列表，将依赖的 module 也加入到 chunk 中</li>\n<li>如果一个依赖 module 是动态引入的模块，那么就会根据这个 module 创建一个新的 chunk，继续遍历依赖</li>\n<li>重复上面的过程，直至得到所有的 chunks</li>\n</ol>\n<p>chunk 属性图</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-446cc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.86324786324786%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAy0lEQVQoz51S227DMAj1/39lVa0vjS8Y48QmhJR4irRqVafu4IcjzO0gXJwiZqy1LsvSmVW3X9DxvqluPyJcuEaYsPXGzOu68jPMI9ylNWEW433w1jaRfd9duMUUsHf7Ex1V9ayto4+erfWZH8nZw9r74B/D+YufvgJAtnIfJ+d7RixmtrB2og+YR9+O5CjRUo+gl/ijMwERkmzyH80QIYRQSgFI0x2yiUD03seYEtD+fmyEYtGmc55nKodws0o0H2gvJ7d12FHZFTwAfPFMteYZV7QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 13 52" title="" data-src="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-fee1c.png" data-srcset="/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-a67b7.png 200w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-0b187.png 400w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-fee1c.png 800w,\n/static/2021-09-02-14-13-52-d82d1292b382e4d317d0ef1e4d81b4f5-446cc.png 1170w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="beforechunkassets--additionalchunkassets（compilation）"><a href="#beforechunkassets--additionalchunkassets%EF%BC%88compilation%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>beforeChunkAssets &#x26;&#x26; additionalChunkAssets（Compilation）</h2>\n<p>在触发这两个事件点的中间时，会调用 Compilation.createCHunkAssets 来创建 assets</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78547192541906470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function createChunkAssets() {\n  // ......\n  // 遍历 chunk\n  for (let i = 0; i < this.chunks.length; i++) {\n    const chunk = this.chunks[i];\n    chunk.files = [];\n    let source;\n    let file;\n    let filenameTemplate;\n    try {\n      // 调用何种 Template\n      const template = chunk.hasRuntime() ? this.mainTemplate : this.chunkTemplate;\n      const manifest = template.getRenderManifest({\n        chunk,\n        hash: this.hash,\n        fullHash: this.fullHash,\n        outputOptions,\n        moduleTemplates: this.moduleTemplates,\n        dependencyTemplates: this.dependencyTemplates\n      }); // [{ render(), filenameTemplate, pathOptions, identifier, hash }]\n      for (const fileManifest of manifest) {\n        // .....\n      }\n      // .....\n      // 写入 assets 对象\n      this.assets[file] = source;\n      chunk.files.push(file);\n      this.hooks.chunkAsset.call(chunk, file);\n      alreadyWrittenFiles.set(file, {\n        hash: usedHash,\n        source,\n        chunk\n      });\n    } catch (err) {\n      // ......\n    }\n  }\n}`, `78547192541906470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ......</span>\n  <span class="token comment">// 遍历 chunk</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    chunk<span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> source<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> file<span class="token punctuation">;</span>\n    <span class="token keyword">let</span> filenameTemplate<span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 调用何种 Template</span>\n      <span class="token keyword">const</span> template <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">hasRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainTemplate <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkTemplate<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> manifest <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">getRenderManifest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        chunk<span class="token punctuation">,</span>\n        hash<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hash<span class="token punctuation">,</span>\n        fullHash<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fullHash<span class="token punctuation">,</span>\n        outputOptions<span class="token punctuation">,</span>\n        moduleTemplates<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleTemplates<span class="token punctuation">,</span>\n        dependencyTemplates<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyTemplates\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{ render(), filenameTemplate, pathOptions, identifier, hash }]</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fileManifest <span class="token keyword">of</span> manifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// .....</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// .....</span>\n      <span class="token comment">// 写入 assets 对象</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">;</span>\n      chunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">chunkAsset</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      alreadyWrittenFiles<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        hash<span class="token punctuation">:</span> usedHash<span class="token punctuation">,</span>\n        source<span class="token punctuation">,</span>\n        chunk\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ......</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>createChunkAssets 会生成文件名和对应的文件内容，并放入 Compilation.assets 对象， 这里有四个 Template 的子类，分别是 MainTemplate.js、ChunkTemplate.js、ModuleTemplate.js、HotUpdateChunkTemplate.js</p>\n<ul>\n<li>MainTemplate.js: 对应了在 entry 配置的入口 chunk 的渲染模板</li>\n<li>ChunkTemplate: 动态引入的非入口 chunk 的渲染模板</li>\n<li>ModuleTemplate.js: chunk 中的 module 的渲染模板</li>\n<li>HotUpdateChunkTemplate.js: 对热替换模块的一个处理。</li>\n</ul>\n<p>模块在封装的时候和它在构建时一样，都是调用各模块类中的方法。封装通过调用 module.source() 来进行各操作，比如说 require() 的替换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31231991782290657000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`MainTemplate.prototype.requireFn = \'__webpack_require__\';\nMainTemplate.prototype.render = function(hash, chunk, moduleTemplate, dependencyTemplates) {\n  var buf = [];\n  // 每一个 module 都有一个 moduleId，在最后会替换。\n  buf.push(\'function \' + this.requireFn + \'(moduleId) {\');\n  buf.push(this.indent(this.applyPluginsWaterfall(\'require\', \'\', chunk, hash)));\n  buf.push(\'}\');\n  buf.push(\'\');\n  // ... // 其余封装操作\n};`, `31231991782290657000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">MainTemplate</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>requireFn <span class="token operator">=</span> <span class="token string">\'__webpack_require__\'</span><span class="token punctuation">;</span>\n<span class="token class-name">MainTemplate</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">hash<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> moduleTemplate<span class="token punctuation">,</span> dependencyTemplates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 每一个 module 都有一个 moduleId，在最后会替换。</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'function \'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requireFn <span class="token operator">+</span> <span class="token string">\'(moduleId) {\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">indent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyPluginsWaterfall</span><span class="token punctuation">(</span><span class="token string">\'require\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'}\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ... // 其余封装操作</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后看看 Compilation.assets 对象</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-f37c3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.54578754578754%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABKklEQVQoz4WR62rDMAyF8/7P118bbG3usS3JkZ34kjSdkm7Q3agQ4oD5pMNxAZ3BDrA3oA0ze0SntUdgrdloD8BKORHGyNM8+ZxzOkpEgSVSRbYh0ysk8mrwTTP1nWtqLi++bV1dua71e3eR+fZQBVQIF6SOjNYAQErFcczeR2tFJObsnMx0zDWlbzBWiCUJDFoj4hc8pYOUjpZk0Sec809YbN9hALQHvEzzTgp/MOI2ef83LJetwEoD7raDpWXysiIgCCy2A6KIyGOe519wRXgBI7Fb0sOg+14CvS7LGuM+U9pFznsvy7ZtD4GVAiOUYKpaztZty87dntV2VCFRS+uzMe9v8PpyPp0c0f58vT5dUbAiZ8bZuhCjfPzEvIRwN/kfs66rkyBC+ACrej0wpgRdPgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 02 14 19 35" title="" data-src="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-fee1c.png" data-srcset="/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-a67b7.png 200w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-0b187.png 400w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-fee1c.png 800w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-b1a91.png 1200w,\n/static/2021-09-02-14-19-35-d3f7efd0da5a5becf814a74bbea3ac0e-f37c3.png 1365w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="done（compiler）"><a href="#done%EF%BC%88compiler%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>done（Compiler）</h2>\n<p>最后一步 webpack 调用 Compiler 中的 emitAssets()，按照 output 中的配置项将文件输出到了对应的 path 中，从而 webpack 整个打包过程结束。要注意的是，若想对结果进行处理，则需要在 emit 触发后对自定义插件进行扩展。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack深入学习/index.md absPath of file >>> MarkdownRemark",timeToRead:26,frontmatter:{date:"2021-09-01 18:12:15",path:"/webpack-deep-learn/",tags:"前端, webpack, 前端构建工具, 读书笔记",title:"Webpack 深入学习",draft:null}},{excerpt:"webpack 构建后代码 打包单一模块 webpack.config.js chunk1.js 打包后，main.js（webpack 生成的一些注释已经去掉） 这其实就是一个立即执行函数，简化一下就是： 看一下自运行的匿名函数里面干了什么： 整个函数里就声明了一个变量 installedModules 和函数  ，并在函数上添加了一个 m,c,p 属性，m 属性保存的是传入的模块数组，c 属性保存的是 installedModules 变量，P…",html:'<h1 id="webpack-构建后代码"><a href="#webpack-%E6%9E%84%E5%BB%BA%E5%90%8E%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 构建后代码</h1>\n<h2 id="打包单一模块"><a href="#%E6%89%93%E5%8C%85%E5%8D%95%E4%B8%80%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包单一模块</h2>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7981926249360338000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./chunk1.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `7981926249360338000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./chunk1.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67466347649894785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `67466347649894785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后，main.js（webpack 生成的一些注释已经去掉）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25240571967386804000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `25240571967386804000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这其实就是一个立即执行函数，简化一下就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38409336873674875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(module) {})([function() {}, function() {}]);`, `38409336873674875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>看一下自运行的匿名函数里面干了什么：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48686056321129520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function(modules) { // webpackBootstrap\n  // modules 就是一个数组，元素就是一个个函数体，就是我们声明的模块\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n      ...\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = &quot;&quot;;\n  // Load entry module and return exports\n  return __webpack_require__(0);\n}`, `48686056321129520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// modules 就是一个数组，元素就是一个个函数体，就是我们声明的模块</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>整个函数里就声明了一个变量 installedModules 和函数 <code class="language-text">__webpack_require__</code>，并在函数上添加了一个 m,c,p 属性，m 属性保存的是传入的模块数组，c 属性保存的是 installedModules 变量，P 是一个空字符串。最后执行<code class="language-text">__webpack_require__</code>函数，参数为零，并将其执行结果返回。下面看一下 <code class="language-text">__webpack_require__</code> 干了什么</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21969293378330380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function __webpack_require__(moduleId) {\n  // moduleId 就是调用是传入的 0\n  // installedModules[0] 是 undefined，继续往下\n  if (installedModules[moduleId]) return installedModules[moduleId].exports;\n  // module 就是 {exports: {},id: 0,loaded: false}\n  var module = (installedModules[moduleId] = {\n    exports: {},\n    id: moduleId,\n    loaded: false\n  });\n  // 下面接着分析这个\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // 表明模块已经载入\n  module.loaded = true;\n  // 返回 module.exports(注意 modules[moduleId].call 的时候 module.exports 会被修改)\n  return module.exports;\n}`, `21969293378330380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moduleId 就是调用是传入的 0</span>\n  <span class="token comment">// installedModules[0] 是 undefined，继续往下</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token comment">// module 就是 {exports: {},id: 0,loaded: false}</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 下面接着分析这个</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 表明模块已经载入</span>\n  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// 返回 module.exports(注意 modules[moduleId].call 的时候 module.exports 会被修改)</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着看一下 <code class="language-text">modules[moduleId].call(module.exports, module, module.exports, __webpack_require__)</code>，其实就是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29451911791301554000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`modules[moduleId].call({}, module, module.exports, __webpack_require__);`, `29451911791301554000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对 call 不了解当然也可以认为是这样（但是并不是等价，call 能确保当模块中使用 this 的时候，this 是指向 module.exports 的）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37933403990378810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function a(module, exports) {\n  var chunk1 = 1;\n  exports.chunk1 = chunk1;\n}\na(module, exports, __webpack_require__);`, `37933403990378810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">a</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>传入的 module 就是 <code class="language-text">{exports: {},id: 0,loaded: false}</code>，exports 就是<code class="language-text">{}</code>，<code class="language-text">__webpack_require__</code>就是声明的<code class="language-text">__webpack_require__</code>函数(传入这个函数有什么用呢，第二节将会介绍)；运行后 module.exports 就是<code class="language-text">{chunk1:1}</code>。所以当我们使用 chunk1 这个模块的时候（比如<code class="language-text">var chunk1=require(&quot;chunk1&quot;)</code>,得到的就是一个对象<code class="language-text">{chunk1:1}</code>）。如果模块里没有<code class="language-text">exports.chunk1=chunk1</code>或者<code class="language-text">module.exports=chunk1</code>得到的就是一个空对象<code class="language-text">{}</code></p>\n<h2 id="使用模块"><a href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用模块</h2>\n<p>上面我们已经分析了 webpack 是怎么打包一个模块的（入口文件就是一个模块），现在我们来看一下使用一个模块，然后使用模块的文件作为入口文件</p>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79217425225835180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `79217425225835180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19755176727069280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `19755176727069280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88775008899248720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    console.log(chunk1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `88775008899248720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不一样的地方就是自执行函数的参数由</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63841211446522620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `63841211446522620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>变为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12468872755317383000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    console.log(chunk1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `12468872755317383000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其实就是多了一个 main 模块，不过这个模块没有导出项，而且这个模块依赖于 chunk1 模块。所以当运行<code class="language-text">__webpack_require__(0)</code>的时候，main 模块缓存到<code class="language-text">installedModules[0]</code>上，<code class="language-text">modules[0].call</code>(也就是调用 main 模块)的时候，chunk1 被缓存到<code class="language-text">installedModules[1]</code>上，并且导出对象<code class="language-text">{chunk1：1}</code>给模块 main 使用</p>\n<h2 id="重复使用模块"><a href="#%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重复使用模块</h2>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40224758292424750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `40224758292424750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26668012248995488000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nvar chunk2 = require(\'./chunk2\');\nconsole.log(chunk1);\nconsole.log(chunk2);`, `26668012248995488000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79291816552570930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk2 = require(\'./chunk2\');\nvar chunk1 = 1;\nexports.chunk1 = chunk1;`, `79291816552570930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>chunk2.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67679833338683300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk2 = 1;\nexports.chunk2 = chunk2;`, `67679833338683300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49730064164944100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // The module cache\n  var installedModules = {};\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n  // Load entry module and return exports\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    var chunk2 = __webpack_require__(2);\n    console.log(chunk1);\n    console.log(chunk2);\n  },\n  function(module, exports, __webpack_require__) {\n    __webpack_require__(2);\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  },\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n]);`, `49730064164944100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// Load entry module and return exports</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不难发现，当需要重复使用模块的时候，缓存变量 installedModules 就起作用了</p>\n<h2 id="多个打包入口"><a href="#%E5%A4%9A%E4%B8%AA%E6%89%93%E5%8C%85%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多个打包入口</h2>\n<p>不管是单一模块还是重复模块，和以上两种一样</p>\n<h2 id="入口参数为数组"><a href="#%E5%85%A5%E5%8F%A3%E5%8F%82%E6%95%B0%E4%B8%BA%E6%95%B0%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口参数为数组</h2>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47738317662216500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `47738317662216500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76707389378347350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `76707389378347350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98783751842906050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');`, `98783751842906050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94070569078498260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: [\'./main.js\', \'./main1.js\'],\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  }\n};`, `94070569078498260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'./main.js\'</span><span class="token punctuation">,</span> <span class="token string">\'./main1.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7483778835814525000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  /* 0：运行模块 main，main1 */\n  function(module, exports, __webpack_require__) {\n    __webpack_require__(1);\n    module.exports = __webpack_require__(3);\n  },\n  /* 1：main 模块 */\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(2);\n    console.log(chunk1);\n  },\n  /* 2：chunk1 模块 */\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  },\n  /* 3：main1 模块 */\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(2);\n  }\n];`, `7483778835814525000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token comment">/* 0：运行模块 main，main1 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 1：main 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 2：chunk1 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">/* 3：main1 模块 */</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里只截取自执行匿名函数的参数，因为其他代码与之前一样。可以看到 1 就是 main 模块，2 就是 chunk1 模块，3 就是 main1 模块，0 的作用就是运行模块 main、main1，然后将 main1 模块导出（main1 中没有导出项，所以到导出 <code class="language-text">{}</code>），总结一下：入口参数是字符串不管是多入口还是单入口，最后都会将入口模块的导出项导出，没有导出项就导出 <code class="language-text">{}</code>，而入口参数是数组，就会将最后一个模块导出（webpack 官网有说明）</p>\n<h2 id="使用-commonschunkplugin-插件"><a href="#%E4%BD%BF%E7%94%A8-commonschunkplugin-%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 CommonsChunkPlugin 插件</h2>\n<p>chunk1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30282523415822873000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = 1;\nexports.chunk1 = chunk1;`, `30282523415822873000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54829780230562220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `54829780230562220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67730622974876440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var chunk1 = require(\'./chunk1\');\nconsole.log(chunk1);`, `67730622974876440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60530226661249410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var CommonsChunkPlugin = require(\'webpack/lib/optimize/CommonsChunkPlugin\');\nmodule.exports = {\n  entry: {\n    main: \'./main.js\',\n    main1: \'./main1.js\'\n  },\n  output: {\n    path: __dirname + \'/dist\',\n    filename: \'[name].js\'\n  },\n  plugins: [\n    new CommonsChunkPlugin({\n      name: \'common\'\n    })\n  ]\n};`, `60530226661249410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> CommonsChunkPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack/lib/optimize/CommonsChunkPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    main<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n    main1<span class="token punctuation">:</span> <span class="token string">\'./main1.js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'common\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main、main1 都 require 了 chunk1，所以 chunk1 会被打包到 common。</p>\n<p>common.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78074434640248680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // webpackBootstrap\n  // install a JSONP callback for chunk loading\n  var parentJsonpFunction = window[\'webpackJsonp\'];\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n    // add &quot;moreModules&quot; to the modules object,\n    // then flag all &quot;chunkIds&quot; as loaded and fire callback\n    var moduleId,\n      chunkId,\n      i = 0,\n      callbacks = [];\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n      installedChunks[chunkId] = 0;\n    }\n    for (moduleId in moreModules) {\n      modules[moduleId] = moreModules[moduleId];\n    }\n    if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n    while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n    if (moreModules[0]) {\n      installedModules[0] = 0;\n      return __webpack_require__(0);\n    }\n  };\n  // The module cache\n  var installedModules = {};\n  // object to store loaded and loading chunks\n  // &quot;0&quot; means &quot;already loaded&quot;\n  // Array means &quot;loading&quot;, array contains callbacks\n  var installedChunks = {\n    2: 0\n  };\n  // The require function\n  function __webpack_require__(moduleId) {\n    // Check if module is in cache\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n    // Create a new module (and put it into the cache)\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n    // Execute the module function\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // Flag the module as loaded\n    module.loaded = true;\n    // Return the exports of the module\n    return module.exports;\n  }\n  // This file contains only the entry chunk.\n  // The chunk loading function for additional chunks\n  __webpack_require__.e = function requireEnsure(chunkId, callback) {\n    // &quot;0&quot; is the signal for &quot;already loaded&quot;\n    if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n    // an array means &quot;currently loading&quot;.\n    if (installedChunks[chunkId] !== undefined) {\n      installedChunks[chunkId].push(callback);\n    } else {\n      // start chunk loading\n      installedChunks[chunkId] = [callback];\n      var head = document.getElementsByTagName(\'head\')[0];\n      var script = document.createElement(\'script\');\n      script.type = \'text/javascript\';\n      script.charset = \'utf-8\';\n      script.async = true;\n      script.src =\n        __webpack_require__.p + \'\' + chunkId + \'.\' + ({ \'0\': \'main\', \'1\': \'main1\' }[chunkId] || chunkId) + \'.js\';\n      head.appendChild(script);\n    }\n  };\n  // expose the modules object (__webpack_modules__)\n  __webpack_require__.m = modules;\n  // expose the module cache\n  __webpack_require__.c = installedModules;\n  // __webpack_public_path__\n  __webpack_require__.p = \'\';\n})([\n  ,\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n]);`, `78074434640248680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token comment">// install a JSONP callback for chunk loading</span>\n  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// add "moreModules" to the modules object,</span>\n    <span class="token comment">// then flag all "chunkIds" as loaded and fire callback</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The module cache</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// object to store loaded and loading chunks</span>\n  <span class="token comment">// "0" means "already loaded"</span>\n  <span class="token comment">// Array means "loading", array contains callbacks</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// The require function</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Check if module is in cache</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token comment">// Create a new module (and put it into the cache)</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Execute the module function</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Flag the module as loaded</span>\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// Return the exports of the module</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// This file contains only the entry chunk.</span>\n  <span class="token comment">// The chunk loading function for additional chunks</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// "0" is the signal for "already loaded"</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// an array means "currently loading".</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// start chunk loading</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span>\n        __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.\'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token string">\'main1\'</span> <span class="token punctuation">}</span><span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">||</span> chunkId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// expose the modules object (__webpack_modules__)</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// expose the module cache</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// __webpack_public_path__</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31336787751870743000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      console.log(chunk1);\n    }\n  ]\n);`, `31336787751870743000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23602099879097516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      console.log(chunk1);\n    }\n  ]\n);`, `23602099879097516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与之前相比，多了 webpackJsonp 函数，立即执行的匿名函数没有立即调用<code class="language-text">__webpack_require__(0)</code>，看一下 webpackJsonp</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18796625548295086000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var parentJsonpFunction = window[\'webpackJsonp\'];\nwindow[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n  // moreModules 为独立 chunk 代码，chunkIds 标记独立 chunk 唯一性避免按需加载时重复加载\n  // 以 main.js 中代码为例，chunkIds 为 [0]，moreModules 为\n  // [function(module, exports, __webpack_require__) {\n  //     var chunk1=__webpack_require__(1);\n  //    console.log(chunk1);\n  // }]\n  var moduleId,\n    chunkId,\n    i = 0,\n    callbacks = [];\n  for (; i < chunkIds.length; i++) {\n    chunkId = chunkIds[i]; // chunkId = 0\n    if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]); // 0 push 入 callbacks(使用 requireEnsure 不再是 0)\n    // 赋值为 0 表明 chunk 已经 loaded\n    installedChunks[chunkId] = 0;\n  }\n  for (moduleId in moreModules) {\n    // modules[0] 会被覆盖\n    modules[moduleId] = moreModules[moduleId];\n  }\n  // 按当前情况 parentJsonpFunction 一直未 undefined\n  if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n  // 按当前情况 callbacks = []\n  while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n  if (moreModules[0]) {\n    installedModules[0] = 0;\n    return __webpack_require__(0);\n  }\n};\n// 缓存模块，通过闭包引用(window[&quot;webpackJsonp&quot;] 可以访问到)\nvar installedModules = {};\n// 2 为公共 chunk 唯一 ID，0 表示已经 loaded\nvar installedChunks = {\n  2: 0\n};\n// The require function\nfunction __webpack_require__(moduleId) {\n  // Check if module is in cache\n  if (installedModules[moduleId]) return installedModules[moduleId].exports;\n  // Create a new module (and put it into the cache)\n  var module = (installedModules[moduleId] = {\n    exports: {},\n    id: moduleId,\n    loaded: false\n  });\n  // Execute the module function\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // Flag the module as loaded\n  module.loaded = true;\n  // Return the exports of the module\n  return module.exports;\n}\n// 按需加载\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n  // an array means &quot;currently loading&quot;.\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback];\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n    script.src =\n      __webpack_require__.p + \'\' + chunkId + \'.\' + ({ \'0\': \'main\', \'1\': \'main1\' }[chunkId] || chunkId) + \'.js\';\n    head.appendChild(script);\n  }\n};`, `18796625548295086000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\nwindow<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 为独立 chunk 代码，chunkIds 标记独立 chunk 唯一性避免按需加载时重复加载</span>\n  <span class="token comment">// 以 main.js 中代码为例，chunkIds 为 [0]，moreModules 为</span>\n  <span class="token comment">// [function(module, exports, __webpack_require__) {</span>\n  <span class="token comment">//     var chunk1=__webpack_require__(1);</span>\n  <span class="token comment">//    console.log(chunk1);</span>\n  <span class="token comment">// }]</span>\n  <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n    chunkId<span class="token punctuation">,</span>\n    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// chunkId = 0</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 push 入 callbacks(使用 requireEnsure 不再是 0)</span>\n    <span class="token comment">// 赋值为 0 表明 chunk 已经 loaded</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// modules[0] 会被覆盖</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 按当前情况 parentJsonpFunction 一直未 undefined</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 按当前情况 callbacks = []</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 缓存模块，通过闭包引用(window["webpackJsonp"] 可以访问到)</span>\n<span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 2 为公共 chunk 唯一 ID，0 表示已经 loaded</span>\n<span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// The require function</span>\n<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Check if module is in cache</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token comment">// Create a new module (and put it into the cache)</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Execute the module function</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Flag the module as loaded</span>\n  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Return the exports of the module</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 按需加载</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// an array means "currently loading".</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span>\n      __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.\'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token string">\'main1\'</span> <span class="token punctuation">}</span><span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">||</span> chunkId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>好像看不出什么。。。，修改一下</p>\n<p>webpack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42593712117482955000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var CommonsChunkPlugin = require(\'webpack/lib/optimize/CommonsChunkPlugin\');\nmodule.exports = {\n  entry: {\n    main: \'./main.js\',\n    main1: \'./main1.js\',\n    chunk1: [\'./chunk1\']\n  },\n  output: {\n    path: __dirname + \'/dist2\',\n    filename: \'[name].js\'\n  },\n  plugins: [\n    new CommonsChunkPlugin({\n      name: [\'chunk1\'],\n      filename: \'common.js\',\n      minChunks: 3\n    })\n  ]\n};`, `42593712117482955000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> CommonsChunkPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack/lib/optimize/CommonsChunkPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    main<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n    main1<span class="token punctuation">:</span> <span class="token string">\'./main1.js\'</span><span class="token punctuation">,</span>\n    chunk1<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'./chunk1\'</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    path<span class="token punctuation">:</span> __dirname <span class="token operator">+</span> <span class="token string">\'/dist2\'</span><span class="token punctuation">,</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">CommonsChunkPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'chunk1\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      filename<span class="token punctuation">:</span> <span class="token string">\'common.js\'</span><span class="token punctuation">,</span>\n      minChunks<span class="token punctuation">:</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main、main1 都分别 require chunk1、chunk2，然后将 chunk1 打包到公共模块（minChunks:3，chunk2 不会被打包到公共模块），自运行匿名函数最后多了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68794828404749020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`return __webpack_require__(0);`, `68794828404749020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>则 <code class="language-text">installedModules[0]</code> 为已经 loaded，看 common.js，<code class="language-text">installedModules[1]</code> 也会 loaded。</p>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62145741496825300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    ,\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `62145741496825300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main1.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53251071487971254000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [2],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    ,\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `53251071487971254000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>common.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98340080232481420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    module.exports = __webpack_require__(1);\n  },\n  function(module, exports) {\n    var chunk1 = 1;\n    exports.chunk1 = chunk1;\n  }\n];`, `98340080232481420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main.js 的代码为例，调用 webpackJsonp，传入的参数 chunkIds 为 <code class="language-text">[1]</code>, moreModules 为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39708960804519666000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  function(module, exports, __webpack_require__) {\n    var chunk1 = __webpack_require__(1);\n    var chunk2 = __webpack_require__(2);\n    exports.a = 1;\n    console.log(chunk1);\n  },\n  ,\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n];`, `39708960804519666000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89478355671634000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 1\n  // false, 赋值为 0 后还是 false\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0;\n}\n// 三个模块\nfor (moduleId in moreModules) {\n  // moduleId: 0,1,2\n  // moreModules[1] 为空模块，自执行函数的参数(公共模块)会被覆盖，但是参数中的相应模块已经 loaded 并且缓存\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  // installedModules[0] 会重新 load，但是 load 的是 moreModules[0]，因为 modules[0] 已经被覆盖，moreModules[0] 依赖于\n  // modules[1]、modules[2]，modules[1] 已经 loaded\n  installedModules[0] = 0;\n  return __webpack_require__(0);\n}`, `89478355671634000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>\n  <span class="token comment">// false, 赋值为 0 后还是 false</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 三个模块</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moduleId: 0,1,2</span>\n  <span class="token comment">// moreModules[1] 为空模块，自执行函数的参数(公共模块)会被覆盖，但是参数中的相应模块已经 loaded 并且缓存</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// installedModules[0] 会重新 load，但是 load 的是 moreModules[0]，因为 modules[0] 已经被覆盖，moreModules[0] 依赖于</span>\n  <span class="token comment">// modules[1]、modules[2]，modules[1] 已经 loaded</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再看下面的情况：common.js 自执行函数参数（公共模块）（没有 return <code class="language-text">__webpack_require__(0)</code>）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19460694246350664000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  ,\n  function(module, exports, __webpack_require__) {\n    var chunk1 = 1;\n    var chunk2 = __webpack_require__(2);\n    exports.chunk1 = chunk1;\n  },\n  function(module, exports) {\n    var chunk2 = 1;\n    exports.chunk2 = chunk2;\n  }\n];`, `19460694246350664000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35173369348986008000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0],\n  [\n    /* 0 */\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n      // main\n    }\n  ]\n);`, `35173369348986008000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">/* 0 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// main</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main 调用分析</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6119070705619722000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 0\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0; // 表明唯一索引为 0 的 chunk 已经 loaded\n}\nfor (moduleId in moreModules) {\n  // moreModules 只有一个元素，所以 modules[1]、modules[2] 不会被覆盖\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  installedModules[0] = 0;\n  // moreModules[0] 即 modules[0] 依赖 modules[1]、即 modules[2]（没有被覆盖很关键）\n  return __webpack_require__(0);\n}`, `6119070705619722000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 表明唯一索引为 0 的 chunk 已经 loaded</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 只有一个元素，所以 modules[1]、modules[2] 不会被覆盖</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token comment">// moreModules[0] 即 modules[0] 依赖 modules[1]、即 modules[2]（没有被覆盖很关键）</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有这种打包情况：common.js 不包含公共模块，即自执行函数参数为 <code class="language-text">[]</code>。</p>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81190262768805860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [0, 1],\n  [\n    function(module, exports, __webpack_require__) {\n      var chunk1 = __webpack_require__(1);\n      var chunk2 = __webpack_require__(2);\n      exports.a = 1;\n      console.log(chunk1);\n    },\n    function(module, exports) {\n      var chunk1 = 1;\n      exports.chunk1 = chunk1;\n    },\n    function(module, exports) {\n      var chunk2 = 1;\n      exports.chunk2 = chunk2;\n    }\n  ]\n);`, `81190262768805860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk1 <span class="token operator">=</span> chunk1<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> chunk2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      exports<span class="token punctuation">.</span>chunk2 <span class="token operator">=</span> chunk2<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以 main 调用分析</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24822920434125373000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleId,\n  chunkId,\n  i = 0,\n  callbacks = [];\nfor (; i < chunkIds.length; i++) {\n  chunkId = chunkIds[i]; // 0,1\n  if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]);\n  installedChunks[chunkId] = 0;\n}\nfor (moduleId in moreModules) {\n  // moreModules 全部转移到 modules\n  modules[moduleId] = moreModules[moduleId];\n}\nif (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\nwhile (callbacks.length) callbacks.shift().call(null, __webpack_require__);\nif (moreModules[0]) {\n  // modules[0] 是 chunk 文件运行代码\n  installedModules[0] = 0;\n  return __webpack_require__(0);\n}`, `24822920434125373000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n  chunkId<span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 0,1</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 全部转移到 modules</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>moreModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// modules[0] 是 chunk 文件运行代码</span>\n  installedModules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="按需加载"><a href="#%E6%8C%89%E9%9C%80%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>按需加载</h2>\n<p>webpack.config.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29186530861880630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  entry: \'./main.js\',\n  output: {\n    filename: \'bundle.js\'\n  }\n};`, `29186530861880630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./main.js\'</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    filename<span class="token punctuation">:</span> <span class="token string">\'bundle.js\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>main.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68699971365469370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`require.ensure([\'./a\'], function(require) {\n  var content = require(\'./a\');\n  document.open();\n  document.write(\'<h1>\' + content + \'</h1>\');\n  document.close();\n});`, `68699971365469370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'./a\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>a.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47577447574894620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = \'Hello World\';`, `47577447574894620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打包后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34405868734866485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1.bundle.js\na.js\nbundle.js\nindex.html\nmain.js\nwebpack.config.js`, `34405868734866485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1.bundle.js\na.js\nbundle.js\nindex.html\nmain.js\nwebpack.config.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22670768278697316000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  var parentJsonpFunction = window[\'webpackJsonp\']; // 全局变量可访问，可通过 webpack 配置的 output 下的 jsonpFunction 进行自定义配置，默认 webpackJsonp\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n    var moduleId,\n      chunkId,\n      i = 0,\n      callbacks = []; // 存放从 __webpack_require__.e 传过来的 callback 数组，实际上就是其回调函数，见下文的代码注释“回调函数”处\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) callbacks.push.apply(callbacks, installedChunks[chunkId]); // 存放数组函数回调\n      installedChunks[chunkId] = 0; // 标记此 chunk 加载完成\n    }\n    for (moduleId in moreModules) {\n      // 这步很重要，将 chunk 传过来的 moreModules 去替换掉现有的 modules\n      // 以供下面的“回调函数”调用 __webpack_require__ 时，去调用 chunk 里面的代码\n      modules[moduleId] = moreModules[moduleId];\n    }\n    if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n    // 依次执行数组函数回调\n    while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n  };\n\n  var installedModules = {};\n\n  // 已加载的 chunkId，0 代表已加载\n  var installedChunks = {\n    0: 0\n  };\n\n  function __webpack_require__(moduleId) {\n    // 缓存\n    if (installedModules[moduleId]) return installedModules[moduleId].exports;\n\n    var module = (installedModules[moduleId] = {\n      exports: {},\n      id: moduleId,\n      loaded: false\n    });\n\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n    module.loaded = true;\n\n    return module.exports;\n  }\n\n  __webpack_require__.e = function requireEnsure(chunkId, callback) {\n    // 已加载完成直接调用\n    if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__);\n\n    if (installedChunks[chunkId] !== undefined) {\n      installedChunks[chunkId].push(callback);\n    } else {\n      // chunk 没有加载，直接塞入“回调函数”\n      installedChunks[chunkId] = [callback];\n      var head = document.getElementsByTagName(\'head\')[0];\n      var script = document.createElement(\'script\');\n      script.type = \'text/javascript\';\n      script.charset = \'utf-8\';\n      script.async = true;\n      // 加载对应的 chunk\n      script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n      head.appendChild(script);\n    }\n  };\n\n  // 存放 modules\n  __webpack_require__.m = modules;\n  // 存放已安装的 modules\n  __webpack_require__.c = installedModules;\n  // 存放 publicPath\n  __webpack_require__.p = \'\';\n  // 第一步执行的地方\n  return __webpack_require__(0);\n})([\n  function(module, exports, __webpack_require__) {\n    // 加载 chunk\n    __webpack_require__.e(1, function(require) {\n      // 回调函数\n      var content = __webpack_require__(1); // 下标是 1\n      document.open();\n      document.write(\'<h1>\' + content + \'</h1>\');\n      document.close();\n    });\n  }\n]);`, `22670768278697316000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 全局变量可访问，可通过 webpack 配置的 output 下的 jsonpFunction 进行自定义配置，默认 webpackJsonp</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放从 __webpack_require__.e 传过来的 callback 数组，实际上就是其回调函数，见下文的代码注释“回调函数”处</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存放数组函数回调</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 标记此 chunk 加载完成</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 这步很重要，将 chunk 传过来的 moreModules 去替换掉现有的 modules</span>\n      <span class="token comment">// 以供下面的“回调函数”调用 __webpack_require__ 时，去调用 chunk 里面的代码</span>\n      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 依次执行数组函数回调</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 已加载的 chunkId，0 代表已加载</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 缓存</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n      id<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      loaded<span class="token punctuation">:</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 已加载完成直接调用</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// chunk 没有加载，直接塞入“回调函数”</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token comment">// 加载对应的 chunk</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n      head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 存放 modules</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>\n  <span class="token comment">// 存放已安装的 modules</span>\n  __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>\n  <span class="token comment">// 存放 publicPath</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token comment">// 第一步执行的地方</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 加载 chunk</span>\n    __webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 回调函数</span>\n      <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 下标是 1</span>\n      document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>1.bundle.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26746185180164583000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`webpackJsonp(\n  [1],\n  [\n    ,\n    // 这里的下标是 1，对应着上面的“下标是 1”\n    // 注意这里由 __webpack_require__.e 加载后会自动执行 webpackJsonp，然后回调函数就被执行\n    function(module, exports) {\n      module.exports = \'Hello World\';\n    }\n  ]\n);`, `26746185180164583000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">[</span>\n    <span class="token punctuation">,</span>\n    <span class="token comment">// 这里的下标是 1，对应着上面的“下标是 1”</span>\n    <span class="token comment">// 注意这里由 __webpack_require__.e 加载后会自动执行 webpackJsonp，然后回调函数就被执行</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和使用 CommonsChunkPlugin 打包的差异在于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11486439207823174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__); // an array means &quot;currently loading&quot;.\n\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback];\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n    head.appendChild(script);\n  }\n};`, `11486439207823174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// This file contains only the entry chunk.</span>\n<span class="token comment">// The chunk loading function for additional chunks</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// an array means "currently loading".</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>模块 main 的 id 为 0，模块 a 的 id 为 1。<code class="language-text">return __webpack_require__(0)</code>，则加载 main 模块， <code class="language-text">modules[0].call(module.exports, module, module.exports, __webpack_require__)</code>则调用函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97970534582702670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function(module, exports, __webpack_require__) {\n  __webpack_require__.e/* nsure */(1, function(require) {\n    var content = __webpack_require__(1);\n    document.open();\n    document.write(\'<h1>\' + content + \'</h1>\');\n    document.close();\n  }\n}`, `97970534582702670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  __webpack_require__<span class="token punctuation">.</span>e<span class="token comment">/* nsure */</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'&lt;h1>\'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">\'&lt;/h1>\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31823867993367736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// This file contains only the entry chunk.\n// The chunk loading function for additional chunks\n__webpack_require__.e = function requireEnsure(chunkId, callback) {\n  // installedChunks[1] 为 undefined\n  // &quot;0&quot; is the signal for &quot;already loaded&quot;\n  if (installedChunks[chunkId] === 0) return callback.call(null, __webpack_require__); // an array means &quot;currently loading&quot;.\n\n  if (installedChunks[chunkId] !== undefined) {\n    installedChunks[chunkId].push(callback);\n  } else {\n    // start chunk loading\n    installedChunks[chunkId] = [callback]; // installedChunks[1] 为数组，表明 currently loading\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n    head.appendChild(script);\n    // 加载完后直接调用\n    webpackJsonp(\n      [1],\n      [\n        ,\n        /* 1 */\n        function(module, exports) {\n          module.exports = \'Hello World\';\n        }\n      ]\n    );\n  }\n};\n// installedChunks[1] 在 webpackJsonp 得到调用`, `31823867993367736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// This file contains only the entry chunk.</span>\n<span class="token comment">// The chunk loading function for additional chunks</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// installedChunks[1] 为 undefined</span>\n  <span class="token comment">// "0" is the signal for "already loaded"</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// an array means "currently loading".</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// start chunk loading</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// installedChunks[1] 为数组，表明 currently loading</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 加载完后直接调用</span>\n    <span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n      <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token punctuation">[</span>\n        <span class="token punctuation">,</span>\n        <span class="token comment">/* 1 */</span>\n        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">\'Hello World\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// installedChunks[1] 在 webpackJsonp 得到调用</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">installedChunks[1]</code> 为数组，元素为 main 模块的执行代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91620407515076050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules) {\n  // moreModules 为模块 a 的代码\n  // add &quot;moreModules&quot; to the modules object,\n  // then flag all &quot;chunkIds&quot; as loaded and fire callback\n  var moduleId,\n    chunkId,\n    i = 0,\n    callbacks = [];\n  for (; i < chunkIds.length; i++) {\n    chunkId = chunkIds[i];\n    if (installedChunks[chunkId])\n      // installedChunks[0]==0，installedChunks[1] 为数组\n      callbacks.push.apply(callbacks, installedChunks[chunkId]); // callbacks 为模块 main 执行代码，不为数组\n    installedChunks[chunkId] = 0; // installedChunks[1] 不为数组，表明已经加载\n  }\n  for (moduleId in moreModules) {\n    modules[moduleId] = moreModules[moduleId];\n  }\n  if (parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules);\n  while (callbacks.length) callbacks.shift().call(null, __webpack_require__);\n};`, `91620407515076050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// moreModules 为模块 a 的代码</span>\n  <span class="token comment">// add "moreModules" to the modules object,</span>\n  <span class="token comment">// then flag all "chunkIds" as loaded and fire callback</span>\n  <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n    chunkId<span class="token punctuation">,</span>\n    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">// installedChunks[0]==0，installedChunks[1] 为数组</span>\n      callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// callbacks 为模块 main 执行代码，不为数组</span>\n    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// installedChunks[1] 不为数组，表明已经加载</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="实现一个简单的-webpack"><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-webpack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现一个简单的 webpack</h1>\n<h2 id="目标"><a href="#%E7%9B%AE%E6%A0%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目标</h2>\n<p>现在的 webpack 是一个庞然大物，我们不可能实现其所有功能。那么，应该将目光聚焦在哪儿呢？从 webpack 的 <a href="https://github.com/webpack/webpack/tree/2e1460036c5349951da86c582006c7787c56c543" target="_blank" rel="nofollow noreferrer noopener">第一个 commit</a> 可以看出，其当初最主要的目的是在浏览器端复用符合 CommonJS 规范的代码模块。这个目标不是很难，我们努力一把还是可以实现的。</p>\n<p>注意：在此我们不考虑插件、loaders、多文件打包等等复杂的问题，仅仅考虑最基本的问题：如何将多个符合 CommonJS 规范的模块打包成一个 JS 文件，以供浏览器执行。</p>\n<h2 id="bundlejs"><a href="#bundlejs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>bundle.js</h2>\n<p>显然，浏览器没法直接执行 CommonJS 规范的模块，怎么办呢？</p>\n<p>将其转换成一个自执行表达式</p>\n<h2 id="例子"><a href="#%E4%BE%8B%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h2>\n<p>我们实际要处理的例子是 <a href="https://github.com/towavephone/fake-webpack/tree/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple" target="_blank" rel="nofollow noreferrer noopener">这个</a>：example 依赖于 a、b 和 c，而且 c 位于 node_modules 文件夹中，我们要将所有模块构建成一个 JS 文件，就是这里的 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple/output.js" target="_blank" rel="nofollow noreferrer noopener">output.js</a></p>\n<h2 id="思路"><a href="#%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h2>\n<p>仔细观察 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf10f1a2ff3bfd7c418e7490a735b9823/examples/simple/output.js" target="_blank" rel="nofollow noreferrer noopener">output.js</a>，我们能够发现：</p>\n<ol>\n<li>\n<p>不管有多少个模块，头部那一块都是一样的，所以可以写成一个模板，也就是 templateSingle.js。</p>\n</li>\n<li>\n<p>需要分析出各个模块间的依赖关系。也就是说，需要知道 example 依赖于 a、b 和 c。</p>\n</li>\n<li>\n<p>c 模块位于 node_modules 文件夹当中，但是我们调用的时候却可以直接 <code class="language-text">require(&#39;c&#39;)</code>，这里肯定是存在某种自动查找的功能。</p>\n</li>\n<li>\n<p>在生成的 output.js 中，每个模块的唯一标识是模块的 ID，所以在拼接 output.js 的时候，需要将每个模块的名字替换成模块的 ID。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12607472494066952000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 转换前\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');\n\n// 转换后\nlet a = require(/* a */ 1);\nlet b = require(/* b */ 2);\nlet c = require(/* c */ 3);`, `12607472494066952000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 转换前</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 转换后</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* a */</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* b */</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* c */</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>ok，下面我们来逐一看看这些问题</p>\n<h3 id="分析模块依赖关系"><a href="#%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分析模块依赖关系</h3>\n<p>CommonJS 不同于 AMD，是不会在一开始声明所有依赖的。CommonJS 最显著的特征就是用到的时候再 require，所以我们得在整个文件的范围内查找到底有多少个 require。怎么办呢？最先蹦入脑海的思路是正则。然而，用正则来匹配 require，有以下两个缺点：</p>\n<ol>\n<li>如果 require 是写在注释中，也会匹配到。</li>\n<li>如果后期要支持 require 的参数是表达式的情况，如 <code class="language-text">require(&#39;a&#39;+&#39;b&#39;)</code>，正则很难处理。</li>\n</ol>\n<p>因此，正则行不通。</p>\n<p>一种正确的思路是：使用 JS 代码解析工具（如 esprima 或者 acorn），将 JS 代码转换成抽象语法树（AST），再对 AST 进行遍历。这部分的核心代码是 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/parse.js" target="_blank" rel="nofollow noreferrer noopener">parse.js</a>。</p>\n<p>在处理好了 require 的匹配之后，还有一个问题需要解决。那就是匹配到 require 之后需要干什么呢？举个例子：</p>\n<p>举个例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39442897556627510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');`, `39442897556627510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里有三个 require，按照 CommonJS 的规范，在检测到第一个 require 的时候，根据 require 即执行的原则，程序应该立马去读取解析模块 a。如果模块 a 中又 require 了其他模块，那么继续解析。也就是说，总体上遵循深度优先遍历算法。这部分的控制逻辑写在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/buildDeps.js" target="_blank" rel="nofollow noreferrer noopener">buildDeps.js</a> 中。</p>\n<h3 id="找到模块"><a href="#%E6%89%BE%E5%88%B0%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>找到模块</h3>\n<p>在完成依赖分析的同时，我们需要解决另外一个问题，那就是如何找到模块？也就是模块的寻址问题，举个例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85336305710074130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nlet a = require(\'a\');\nlet b = require(\'b\');\nlet c = require(\'c\');`, `85336305710074130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在模块 example.js 中，调用模块 a、b、c 的方式都是一样的。但是，实际上他们所在的绝对路径层级并不一致：a 和 b 跟 example 同级，而 c 位于与 example 同级的 node_modules 中。所以，程序需要有一个查找模块的算法，这部分的逻辑在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/resolve.js" target="_blank" rel="nofollow noreferrer noopener">resolve.js</a> 中。</p>\n<p>目前实现的查找逻辑是：</p>\n<ol>\n<li>如果给出的是绝对路径/相对路径，只查找一次。找到？返回绝对路径。找不到？返回 false。</li>\n<li>如果给出的是模块的名字，先在入口 js（example.js）文件所在目录下寻找同名 JS 文件（可省略扩展名）。找到？返回绝对路径。找不到？走第 3 步。</li>\n<li>在入口 js（example.js）同级的 node_modules 文件夹（如果存在的话）查找。找到？返回绝对路径。找不到？返回 false。</li>\n</ol>\n<p>当然，此处实现的算法还比较简陋，之后有时间可以再考虑实现逐层往上的查找，就像 nodejs 默认的模块查找算法那样。</p>\n<h3 id="拼接-outputjs"><a href="#%E6%8B%BC%E6%8E%A5-outputjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拼接 output.js</h3>\n<p>这是最后一步了。</p>\n<p>在解决了模块依赖和模块查找的问题之后，我们将会得到一个依赖关系对象 depTree，此对象完整地描述了以下信息：都有哪些模块，各个模块的内容是什么，他们之间的依赖关系又是如何等等。具体的结构如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70597395237591695000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n    &quot;modules&quot;: {\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;: {\n            &quot;id&quot;: 0,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;,\n            &quot;name&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;,\n            &quot;requires&quot;: [\n                {\n                    &quot;name&quot;: &quot;a&quot;,\n                    &quot;nameRange&quot;: [\n                        16,\n                        19\n                    ],\n                    &quot;id&quot;: 1\n                },\n                {\n                    &quot;name&quot;: &quot;b&quot;,\n                    &quot;nameRange&quot;: [\n                        38,\n                        41\n                    ],\n                    &quot;id&quot;: 2\n                },\n                {\n                    &quot;name&quot;: &quot;c&quot;,\n                    &quot;nameRange&quot;: [\n                        60,\n                        63\n                    ],\n                    &quot;id&quot;: 3\n                }\n            ],\n            &quot;source&quot;: &quot;let a = require(\'a\');\\nlet b = require(\'b\');\\nlet c = require(\'c\');\\na();\\nb();\\nc();\\n&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/a.js&quot;: {\n            &quot;id&quot;: 1,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/a.js&quot;,\n            &quot;name&quot;: &quot;a&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;// module a\\n\\nmodule.exports = function () {\\n    console.log(\'a\')\\n};&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/b.js&quot;: {\n            &quot;id&quot;: 2,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/b.js&quot;,\n            &quot;name&quot;: &quot;b&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;// module b\\n\\nmodule.exports = function () {\\n    console.log(\'b\')\\n};&quot;\n        },\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js&quot;: {\n            &quot;id&quot;: 3,\n            &quot;filename&quot;: &quot;/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js&quot;,\n            &quot;name&quot;: &quot;c&quot;,\n            &quot;requires&quot;: [],\n            &quot;source&quot;: &quot;module.exports = function () {\\n    console.log(\'c\')\\n}&quot;\n        }\n    },\n    &quot;mapModuleNameToId&quot;: {\n        &quot;/Users/towavephone/www/fake-webpack/examples/simple/example.js&quot;: 0,\n        &quot;a&quot;: 1,\n        &quot;b&quot;: 2,\n        &quot;c&quot;: 3\n    }\n}`, `70597395237591695000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n    <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">16</span><span class="token punctuation">,</span>\n                        <span class="token number">19</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">38</span><span class="token punctuation">,</span>\n                        <span class="token number">41</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token punctuation">{</span>\n                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span>\n                    <span class="token string">"nameRange"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                        <span class="token number">60</span><span class="token punctuation">,</span>\n                        <span class="token number">63</span>\n                    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"let a = require(\'a\');\\nlet b = require(\'b\');\\nlet c = require(\'c\');\\na();\\nb();\\nc();\\n"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/a.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"// module a\\n\\nmodule.exports = function () {\\n    console.log(\'a\')\\n};"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/b.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/b.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"// module b\\n\\nmodule.exports = function () {\\n    console.log(\'b\')\\n};"</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>\n            <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/node_modules/c.js"</span><span class="token punctuation">,</span>\n            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span>\n            <span class="token string">"requires"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"module.exports = function () {\\n    console.log(\'c\')\\n}"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string">"mapModuleNameToId"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">"/Users/towavephone/www/fake-webpack/examples/simple/example.js"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n        <span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n        <span class="token string">"c"</span><span class="token punctuation">:</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据这个 depTree 对象，我们便能完成这最后的一步：<code class="language-text">output.js 文件的拼接</code>。其控制逻辑无非是一层循环，写在 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/writeChunk.js" target="_blank" rel="nofollow noreferrer noopener">writeChunk.js</a> 中。但是这里有一个需要注意的地方，那就是本文思路章节提到的第 4 点：要把模块名转换成模块 ID，这是 <a href="https://github.com/towavephone/fake-webpack/blob/1bfcd0edf1/lib/writeSource.js" target="_blank" rel="nofollow noreferrer noopener">writeSource.js</a> 所要完成的功能。</p>\n<p>至此，我们就实现了一个非常简单的 webpack 了。</p>\n<h2 id="遗留问题"><a href="#%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>遗留问题</h2>\n<ol>\n<li>尚未支持 <code class="language-text">require(&#39;a&#39; + &#39;b&#39;)</code> 这种情况。</li>\n<li>如何实现自动 watch 的功能？</li>\n<li>其 loader 或者插件机制又是怎样的？</li>\n</ol>\n<h1 id="code-splitting"><a href="#code-splitting" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>code-splitting</h1>\n<p>我们今天来看看如何实现 webpack 的代码切割（code-splitting）功能，最后实现的代码版本请参考<a href="https://github.com/towavephone/fake-webpack/tree/d6589263f90752ef8222749208694df654b631e3" target="_blank" rel="nofollow noreferrer noopener">这里</a>。</p>\n<h2 id="目标-1"><a href="#%E7%9B%AE%E6%A0%87-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目标</h2>\n<p>一般说来，code-splitting 有两种含义：</p>\n<ol>\n<li>将第三方类库单独打包成 vendor.js ，以提高缓存命中率（这一点我们不作考虑）</li>\n<li>将项目本身的代码分成多个 js 文件，分别进行加载（我们只研究这一点）</li>\n</ol>\n<p>换句话说，我们的目标是：将原先集中到一个 output.js 中的代码，切割成若干个 js 文件，然后分别进行加载。也就是说：原先只加载 output.js，现在把代码分割到 3 个文件中，先加载 output.js，然后 output.js 又会自动加载 1.output.js 和 2.output.js。</p>\n<h2 id="切割点的选择"><a href="#%E5%88%87%E5%89%B2%E7%82%B9%E7%9A%84%E9%80%89%E6%8B%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切割点的选择</h2>\n<p>既然要将一份代码切割成若干份代码，总得有个切割点的标志吧，从哪儿开始切呢？</p>\n<p>webpack 使用 require.ensure 作为切割点。</p>\n<p>然而，我用 nodeJS 也挺长时间了，怎么不知道还有 require.ensure 这种用法？而事实上 nodeJS 也是不支持的，这个问题我在 CommonJS 的标准中找到了答案：虽然 CommonJS 通俗地讲是一个同步模块加载规范，但是其中是包含异步加载相关内容的。只不过这条内容只停留在 PROPOSAL（建议）阶段，并未最终进入标准，所以 nodeJS 没有实现它也就不奇怪了。只不过 webpack 恰好利用了这个作为代码的切割点。</p>\n<p>ok，现在我们已经明白了为什么要选择 require.ensure 作为切割点了。接下来的问题是：如何根据切割点对代码进行切割？ 下面举个例子。</p>\n<h2 id="例子-1"><a href="#%E4%BE%8B%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29383868630199130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nvar a = require(\'a\');\nvar b = require(\'b\');\na();\nrequire.ensure([\'c\'], function(require) {\n  require(\'b\')();\n  var d = require(\'d\');\n  var c = require(\'c\');\n  c();\n  d();\n});\n\nrequire.ensure([\'e\'], function(require) {\n  require(\'f\')();\n});`, `29383868630199130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nrequire<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrequire<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'e\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'f\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设这个 example.js 就是项目的主入口文件，模块 a ~ f 是简简单单的模块（既没有进一步的依赖，也不包含 require.ensure）。那么，这里一共有 2 个切割点，这份代码将被切割为 3 部分。也就说，到时候会产生 3 个文件：output.js，1.output.js，2.output.js</p>\n<h2 id="识别与处理切割点"><a href="#%E8%AF%86%E5%88%AB%E4%B8%8E%E5%A4%84%E7%90%86%E5%88%87%E5%89%B2%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>识别与处理切割点</h2>\n<p>程序如何识别 require.ensure 呢？答案自然是继续使用强大的 esprima。关键代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78759374507041800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// parse.js\nif (\n  expression.callee &&\n  expression.callee.type === \'MemberExpression\' &&\n  expression.callee.object.type === \'Identifier\' &&\n  expression.callee.object.name === \'require\' &&\n  expression.callee.property.type === \'Identifier\' &&\n  expression.callee.property.name === \'ensure\' &&\n  expression.arguments &&\n  expression.arguments.length >= 1\n) {\n  // 处理 require.ensure 的依赖参数部分\n  let param = parseStringArray(expression.arguments[0]);\n  let newModule = {\n    requires: [],\n    namesRange: expression.arguments[0].range\n  };\n  param.forEach((module) => {\n    newModule.requires.push({\n      name: module\n    });\n  });\n\n  module.asyncs = module.asyncs || [];\n  module.asyncs.push(newModule);\n\n  module = newModule;\n\n  // 处理 require.ensure 的函数体部分\n  if (expression.arguments.length > 1) {\n    walkExpression(module, expression.arguments[1]);\n  }\n}`, `78759374507041800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// parse.js</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>\n  expression<span class="token punctuation">.</span>callee <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'MemberExpression\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'Identifier\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'require\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'Identifier\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'ensure\'</span> <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>arguments <span class="token operator">&amp;&amp;</span>\n  expression<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">1</span>\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理 require.ensure 的依赖参数部分</span>\n  <span class="token keyword">let</span> param <span class="token operator">=</span> <span class="token function">parseStringArray</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> newModule <span class="token operator">=</span> <span class="token punctuation">{</span>\n    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    namesRange<span class="token punctuation">:</span> expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>range\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  param<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    newModule<span class="token punctuation">.</span>requires<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> module\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  module<span class="token punctuation">.</span>asyncs <span class="token operator">=</span> module<span class="token punctuation">.</span>asyncs <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  module<span class="token punctuation">.</span>asyncs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  module <span class="token operator">=</span> newModule<span class="token punctuation">;</span>\n\n  <span class="token comment">// 处理 require.ensure 的函数体部分</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>expression<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">walkExpression</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察上面的代码可以看出，识别出 require.ensure 之后，会将其存储到 asyncs 数组中，且继续遍历其中所包含的其他依赖。举个例子，example.js 模块最终解析出来的数据结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 699px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.60944206008584%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAACqElEQVQ4y5WU6XLbIBSF8/6v0l99jazO1saWHS3YFgi0sgkEl6LUSVO3M1UZjQfP6OPcc+5FF9baoWZdRSelgrXBmGDG4H1YsC5839WbdZWsOUK+Zb6tQ9sAoyFAmKb5LGvCOM5PPPoMhoYFNwk9rh6etlk6SOEBZr6pwxFBtoXtGh5u4HkVivQcju9ZMS8phBm1i2oR7tpASSBloDjk6Sw7L/hDuY7Kjkt1c3u32SUDH2ZlVr3ZhvnXufm4mYXT88uz4O3rTu73oWkcpY5RTym0zentv673Iy68c+n1LVo9NUnap4VCR70v5R5PjJ1KFUMY+jDqIHjgfZDik2djLKl7YZMky/KS1QMXoxB2IiQGCVrB+imsn2MEkLyE3QY232de6xOsSipNGLiljB+OrI+wD/b60nz94qWcQ063kO0AZUBKyF7h8Taku6DkCRYjdJ2idCjLuo3tipPy9OhRHtOCA5p7lrxAheFQxH2oyrAvIH99Vx4DF7Yo8M3t42abMSYMJn/rzlmfTzC0rWRswLjpuOJymj2D/y3h8LlP8/4XLOUUla+uVi9JympuMP73bH+U3TRi4EYqp0YvlZ9ItRiehx8KhC8v73YpYrVYpAzGaMy48tFt9FzRPtYc22YJWaBsjTxWhPHd6367RYR0wzC+lb0ItmKPWSvT7HDETfSsNQjlFnk+la09IW1MO8uO7aCEdP8XWNerfhi7Xgs1Se2najEcx1PICSFy//C9OMRBURaTRbCMcLwYg2lamSMc70bb6Z9pv48VfIzVOWwxi4ZX1w+P99+OiHQxAelcWS74ejqHv23qXd7mqMtRkxV1lvXFXtPKOmsmK0eprX7bm9GO8GngL7z3SbHNcVGLWHVHe9qpXlmtJ6OMiptOdFzziMW/Mt70T/AP2yShptabAZkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 22 45" title="" data-src="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png" data-srcset="/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-83eb3.png 200w,\n/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-7600b.png 400w,\n/static/2021-08-03-01-22-45-509b26f4cb39687260c796013ca69ec4-76b75.png 699w" data-sizes="(max-width: 699px) 100vw, 699px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="module-与-chunk"><a href="#module-%E4%B8%8E-chunk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module 与 chunk</h2>\n<p>我在刚刚使用 webpack 的时候，是分不清这两个概念的。现在我可以说：“在上面的例子中，有 3 个 chunk，分别对应 output.js、1.output.js 、2.output.js；有 7 个 module，分别是 example 和 a ~ f。</p>\n<p>所以，module 和 chunk 之间的关系是：1 个 chunk 可以包含若干个 module。</p>\n<p>观察上面的例子，得出以下结论：</p>\n<ul>\n<li>chunk0（也就是主 chunk，也就是 output.js）应该包含 example 本身和 a、b 三个模块。</li>\n<li>chunk1（1.output.js）是从 chunk0 中切割出来的，所以 chunk0 是 chunk1 的 parent。</li>\n<li>本来 chunk1 应该是包含模块 c、b 和 d 的，但是由于 b 已经被其 parent-chunk（也就是 chunk1）包含，所以，必须将 b 从 chunk1 中移除，这样方能避免代码的冗余。</li>\n<li>chunk2（2.output.js）是从 chunk0 中切割出来的，所以 chunk0 也是 chunk2 的 parent。</li>\n<li>chunk2 包含 e 和 f 两个模块。</li>\n</ul>\n<p>好了，下面进入重头戏。</p>\n<h2 id="构建-chunks"><a href="#%E6%9E%84%E5%BB%BA-chunks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建 chunks</h2>\n<p>在对各个模块进行解析之后，我们能大概得到以下这样结构的 depTree。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 778px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 119.79434447300773%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAADdklEQVQ4y4VUiZKjOAzN/3/V1ux2TzohByEknTvclw3GBoMx2COSdO1ubW+NUBlZ8KxnWfJEyq7I80oIubfE1pR13aO0j/w+8PvrqT8fensz3M5DxQalhgGGUfRDJn3fJ3FyvF7PMyPY7eMkScIw8rzQdcPbFTS932LXydIkjuMgCMqSQDylFSwzeS4T3K6b1SaKgzBxvPDqhGcnuTvYd5F/R66DPCdz3Mz3EWjgZrCYW1TFZISKNtva+/na+zwWYZQHIYtjEXpCiqZrQHnHwW5l23YNKBdNI5p+GCYj94b3rKbNYBjWenvMcNUCryLXw2tv/ycvcFeUmPAso7QUlLa8kbrAGnY09Lokmpaa5JpRXbPRT4lCqZbdA9w2bU4g4Of+cro4GaKVGNTpID7eVRar6Z/qYCtrqfYbZS7U9Ifab/X1pFv+iixLVlbdbnc5nnyEGauExkh1nea1jsMxeFmMmkY6jUcKT9rPhJEgCiLUtL3sdc1lI/oX7W9l3M7wtee2qdMkQ4gUBWWs6zo4wzFhTzCM/9V/JkzXleyH6/m8tWyMkOjE3+DfZltVjLcthbiPyHCGD/DI7RnrX6y/PA8wZKVichiup/N2a+cYSyl1jp/g30WWXXU559eLRMmQpzzxWeiI2IfakkNXixoUKuxRcPw5fXpGMLQKIvktvGclivPYy/yUoJwRwkjbthWvQFvR8IbXDWc1g+mjPPsRLETn3O+3mxsEYQAtFUXQPZ7ve/AEPkzDMIyTKAj9MArBmaYpoWXXy1dXxVFkWVtMci44axjllDUVa1nVVoQTMEhNwIZPdVvDWPKyrMsXOAyC5XKJc9yIFjIJlAY1yEGOtur7R0k8ncPXEbwSJjsJTFzXo4wmOEUFSosswUmEopKRrMhwiVlF0zwFG0YGnISAqCO4KIi5NkEWc2O9Wm9Mc71cr0AXy6Vh2JYNX/f2zlyZm41lGIvD4RiFMTTACIYX/DdfLD9W6/lsvlitPuaL6Ww+/fiYzmZrazufG9ZmY8zmxsJ4f/9p2zvfCyilE7jT4HKCyk6Px+THHznKivsVHz7zIMCeg48Hcj7gOC4py0cpMMYA45xDIU0azt/+elub1sU0o59vXV3p405/WnpvadvU1lKbhg7c7ysMKpmWFJasG7g+9JhOSlVJVIEVzlSOVY4UJd+CfwGkw0bGIJhTbAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 24 12" title="" data-src="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png" data-srcset="/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-4346f.png 200w,\n/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-9c269.png 400w,\n/static/2021-08-03-01-24-12-dfde79ab8edc2556cd8e4dcc435f6085-3df96.png 778w" data-sizes="(max-width: 778px) 100vw, 778px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>下面我们要做的就是：如何从 8 个 module 中构建出 3 个 chunk 出来。 这里的代码较长，我就不贴出来了，想看的到这里的 <a href="https://github.com/towavephone/fake-webpack/commit/d6589263f90752ef8222749208694df654b631e3#diff-92c5d90abece48343aa1cdb71978f37b" target="_blank" rel="nofollow noreferrer noopener">buildDep.js</a>。</p>\n<p>其中要重点注意是：前文说到，为了避免代码的冗余，需要将模块 b 从 chunk1 中移除，具体发挥作用的就是函数 removeParentsModules，本质上无非就是改变一下标志位。最终生成的 chunks 的结构如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 673px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.25705794947994%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACwElEQVQ4y5VU227cNhDd//+EvBR5CPLQ9wJ5qGMkqAs7vuz6lrX3rl3dqOtKK5EUxZkeyuumbYAEFQiClHiGM+ec0UhKmRVF3TTKmN5a/j/PqNNq8vFkfnFhRGQzQVlis4RTwWXhvh9qDna0nLFsuT3wdk2bBYuQ68qBWWsTBUksvOW6KQ/c94T7u45F7MDVntcLh9ltGEG9FY2/0PiCEe5QA6xwibF2Nl+sPC8s47TOiYiz1IGzhB4n5K0xeL3kJOY85XRIrTm4m22e4ZjpuqIq18naz4IjGHNz4CjgOOQiczOSdw8da3bgLDVEABvTSS07ox0Msfv+J4Rxp3Ucp0XRSEV/vwYYlGhNdUWrGd1d8/SBRYTiXSJYTO9B5IiU4n1Rter89M/Z1V268cXKq/PK/PpOvX/b1zXPn3izdLBg6xbIyHSsJPIaCMtT5Bd83Tx/Oht/Phmf/p7eP9nJtd2XLosX8QEwhv9thBEBXORKdotFNF+Lx83uWexrBYWro85x5EgGcxjYgm1UhLhKjQiSxqFczZ8vx9HjlERiPvwmf3mjz8/6Mufdhr7e0fMjKoTIbgvOoQ7KlnKEfGzoW99zfsDpyLepsMHOhoFzS5E7b4S+M1yCFMR/2O50FOYisW3LuuPeHL9A2J9Zfai5BNvt9fXtzo+U0R24gVSoDYGwwOy4NU5251yNat0brR3bNDisqWuRidXgMGchJAyGRETeksaXR7Xg7ZsLur2i+zH73iBVkWtjojCq9pUxMJsdbs6cGdEAD2O6uxlcsXXpwC0vDUfk7ImNJgqitKzabw4DeW2DZnL9CGNUJc2nvHhyvEKw15q18bc99q5jG6chBk5AElSI0Q/eQDjb8wsd9NoYsm0nZ39ML788nJ/PJjf51pNpAku/NtAP2VZKhWG0C8JIJI2UBj+Df7bH94O/3fwXPQh1Xipk5JYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 25 11" title="" data-src="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png" data-srcset="/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-6eafe.png 200w,\n/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-632fc.png 400w,\n/static/2021-08-03-01-25-11-6afcbc3be20463b65a0b0e3e5b52dcc2-7a334.png 673w" data-sizes="(max-width: 673px) 100vw, 673px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="拼接-outputjs-1"><a href="#%E6%8B%BC%E6%8E%A5-outputjs-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拼接 output.js</h2>\n<p>经历重重难关，我们终于来到了最后一步：如何根据构建出来的 chunks 拼接出若干个 output.js 呢？</p>\n<p>此处的拼接与上一篇最后提到的拼接大同小异，主要不同点有以下 2 个：</p>\n<ol>\n<li>模板的不同。原先是一个 output.js 的时候，用的模板是 templateSingle 。现在是多个 chunks 了，所以要使用模板 templateAsync。其中不同点主要是 templateAsync 会发起 jsonp 的请求，以加载后续的 x.output.js，此处就不加多阐述了。仔细 debug 生成的 output.js 应该就能看懂这一点。</li>\n<li>模块名字替换为模块 id 的算法有所改进。原先我直接使用正则进行匹配替换，但是如果存在重复的模块名的话，比如此例子中 example.js 出现了 2 次模块 b，那么简单的匹配就会出现错乱。因为 repalces 是从后往前匹配，而正则本身是从前往后匹配的。webpack 原作者提供了一种非常巧妙的方式，具体的代码可以参考<a href="https://github.com/towavephone/fake-webpack/commit/d6589263f90752ef8222749208694df654b631e3#diff-62f46802ba4c21e21b2dfedcce5fa86dR60" target="_blank" rel="nofollow noreferrer noopener">这里</a>。</li>\n</ol>\n<h2 id="后话"><a href="#%E5%90%8E%E8%AF%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后话</h2>\n<p>其实关于 webpack 的代码切割还有很多值得研究的地方。比如本文我们实现的例子仅仅是将 1 个文件切割成 3 个，并未就其加载时机进行控制。比如说，如何支持在单页面应用切换 router 的时候再加载特定的 x.output.js？</p>\n<h1 id="loader"><a href="#loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loader</h1>\n<h2 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h2>\n<p>我们来探索 loader 机制，最终实现的代码版本参考<a href="https://github.com/towavephone/fake-webpack/tree/96eae479379ca83dc7121f4afaef0b3453668081" target="_blank" rel="nofollow noreferrer noopener">这里</a>（参考的 webpack 版本是<a href="https://github.com/webpack/webpack/tree/356ab65ea0c097fdb2d3d70f9ba8593f325dc92e" target="_blank" rel="nofollow noreferrer noopener">这个</a>）</p>\n<h2 id="问题"><a href="#%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题</h2>\n<p>以加载 less 为例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17198840489398036000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// example.js\nrequire(\'./style.less\');`, `17198840489398036000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// example.js</span>\n<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./style.less\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40584850541022100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// style.less\n@color: #000fff;\n.content {\n  width: 50px;\n  height: 50px;\n  background-color: @color;\n}`, `40584850541022100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="less"\n              >\n                <span class="gatsby-code-button-language">less</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="less"><pre style="counter-reset: linenumber NaN" class="language-less line-numbers"><code class="language-less"><span class="token comment">// style.less</span>\n<span class="token variable">@color<span class="token punctuation">:</span></span> #000fff<span class="token punctuation">;</span>\n<span class="token selector">.content</span> <span class="token punctuation">{</span>\n  <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>\n  <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>\n  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@color</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照官方文档，想要加载 less 文件，我们需要配置三个 loader：<code class="language-text">style-loader!css-loader!less-loader</code>。</p>\n<p>该从什么地方着手研究呢？仔细观察最终生成的 output.js，如下图所示。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-64da1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 93.85593220338984%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAAChklEQVQ4y4VTyXLbMAz1/39ODz10pumhxx4yibPUiRfZsi3LtixSJLgTKOisbTMTDIaWKQF4eHgY5ZytMb2QHowzVrsAPlkf9KlLztIgaRgoeOLnnAmxONv5HOWcjA/gvHfOAIAPTin39Yud3CetaFvTpqZTR4c9eU/vDXGUYowpp5TwKSUbVwBN6yUuHjkYDy02a/w9JtFjs8HNCvlVs6bTcZRSBq2FFCmmp0QxI2cK1TzfXOHtFW1WtFrQ/IHEieqq+HJegDBsrgnWK2OtBiWVUCC1GZQWAPrim10uIlHgtDkHTp2zj8kmjIj8b5RLsBs0FOzMHn92xpBjDDGEnKP3gT2UM5afaDlBLFYqM09iGKJlxhyzbVywIYKxmT6xESfwnNJxTu+s44YLpBCCUnk+pe6I1Qynk3JWM9L6r2DGWlCBTYySCe8O+ecFgiIDdHNJd9c0e8DFFC9/Ub2k14m8BCdwQWmnlSmw6/Vx8jAwFKV9vYo8Z5627KltSroXebwFs3X7Y1UtN03b9qo+SKGMDoVVj5/1zPIwSm+328OxO+zb437PFAZn4bnDsyRftYnnm/fB3lrR91qDNGGwvtd2MOUU2g0ArN+PK/NQeazKBgGOv+6UPQ5GquK9soxfLqv+5jrstmVJGIuSJEVRu/el51DGFBA/6o9vp5N8P0aWZFNjNcXJLY4v6X5MKfFWZa31qRfJBW8dq8eGxIJiyeRdg0zyuqLdpsibn3kfmPnHu1K59MxismEAA0oBQ5WgwYkBeqnlj+9yNudLs2tVvTHbRm93g+T1jU8gS2XD2lYa8xtspGde2fma/WnViudiz4Tx8pxOXdvuGbz5xwAsFOOJlOb/sz9fV0iqzvh1TgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 31 30" title="" data-src="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-fee1c.png" data-srcset="/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-a67b7.png 200w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-0b187.png 400w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-fee1c.png 800w,\n/static/2021-08-03-01-31-30-662987309788d9773b0ceeeaa3e91968-64da1.png 944w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由此我们进行以下思考：</p>\n<ol>\n<li>\n<p>既然最终 css 代码会被插入到 head 标签中，那么一定是模块 2 在起作用。但是，项目中并不包含这部分代码，经过排查，发现源自于 node-modules/style-loader/addStyle.js ，也就是说，是由 style-loader 引入的。（后面我们再考察是如何引入的）</p>\n</li>\n<li>\n<p>观察模块 3，那应该是 less 代码经过 less-loader 的转换之后，再包装一层 module.exports，成为一个 JS module。</p>\n</li>\n<li>\n<p>style-loader 和 less-loader 的作用已经明了，但是，css-loader 发挥什么作用呢？虽然我一直按照官方文档配置三个 loader，但我从未真正理解为什么需要 css-loader。后来我在 css-loader 的文档中找到了答案。</p>\n<blockquote>\n<p>@import and url() are interpreted like import and will be resolved by the css-loader</p>\n</blockquote>\n<p>既然如此，为了降低实现的难度，我们暂时不予考虑 import 和 url 的情况，也就无需实现 css-loader 了。</p>\n</li>\n<li>\n<p>观察模块 1，<code class="language-text">require(2)(require(3))</code>，很显然：”模块 3 的导出作为模块 2 的输入参数，执行模块 2“，也就是说：“将模块 3 中的 css 代码插入到 head 标签中“。理解这个逻辑不难，难点在于：webpack 如何知道应该拼接成 <code class="language-text">require(2)(require(3))</code>，而不是别的什么。也就说，如何控制拼接出 <code class="language-text">require(2)(require(3))</code>？</p>\n</li>\n</ol>\n<h2 id="思路-1"><a href="#%E6%80%9D%E8%B7%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h2>\n<p>思路进行到这儿，似乎走不下去了。看来只分析 output.js 还不足以理清，那么，让我们更进一步，观察 depTree，如下图所示。（图片较大，请点击放大查看）</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-f840e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.04460966542751%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABgklEQVQozzVRybLjIAz0/3/fHOaSl8UxmH0zi7CBEckbVVslXEjdLRal1PP1pHLf9jehK5XMRFevc8zooyPazK2Nb2A98NRr7UvvXQgZUmwlXTtp6WiH68GNnGaz0YNug5FB34PTsT7Gvg3Jv7OWUgqSxxRzyQBQc0ZAKeBdoRvQdyVrxaxV1bIqCVafMVwXcvclxnR7/LzFRjjRThtvJ4Izh3dWW++c4p6sXuxughlGAqNZqbPWBdmlUi64fOZSSzkLnDCL562XMk3m1MnaUTkK3taxvYZRI/gpGz/vwnEcZ7/qVX9xQk1H/vsnr4/CCEgORjbvRjzGEQaU7+4W9Mkld9H56NF2mXaRHHfZAHL1FjgFsYPitST8A5CgJJSGrtFzvN1vu6Ib34iku2a72oUVCdLnlcYXF6K3Dy7MreO++pJTem0vbjj2YBaGs08/lZRrzhQXWkgrfXQ4LkIMOSDtr2zvw8/9jlR4VZh5D+sPJNMcx82JVthgoUJFO7iQ//EPDfk6vX/25U4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 08 03 01 33 55" title="" data-src="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-fee1c.png" data-srcset="/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-a67b7.png 200w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-0b187.png 400w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-fee1c.png 800w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-b1a91.png 1200w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-95179.png 1600w,\n/static/2021-08-03-01-33-55-0f638153c7c7c3ccfc0a3902917f0fee-f840e.png 1883w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>问题在于：为什么凭空多出来 2 个模块？到底是哪里起了作用呢？我在 style-loader 的源码中找到了答案。</p>\n<h2 id="style-loader-的再-require"><a href="#style-loader-%E7%9A%84%E5%86%8D-require" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>style-loader 的再 require</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15779458328249207000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// style-loader/index.js\nconst path = require(\'path\');\nmodule.exports = function(content) {\n  // content 的值为：/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js!/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n  let loaderSign = this.request.indexOf(\'!\');\n  let rawCss = this.request.substr(loaderSign);\n  // rawCss 的值为：/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n  return (\n    \'require(\' + JSON.stringify(path.join(__dirname, \'addStyle\')) + \')\' + \'(require(\' + JSON.stringify(rawCss) + \'))\'\n  );\n};`, `15779458328249207000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// style-loader/index.js</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// content 的值为：/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js!/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less</span>\n  <span class="token keyword">let</span> loaderSign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> rawCss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>loaderSign<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// rawCss 的值为：/Users/youngwind/www/fake-webpack/node_modules/less-loader-fake/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token string">\'require(\'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'addStyle\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\')\'</span> <span class="token operator">+</span> <span class="token string">\'(require(\'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>rawCss<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'))\'</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察源码，我们发现：style-loader 返回的字符串里面又包含了 2 个 require，分别 require 了 addStyle 和 less-loader!style.less，由此，我们终于找到了突破口。loader 本质上是一个函数，输入参数是一个字符串，输出参数也是一个字符串。当然，输出的参数会被当成是 JS 代码，从而被 esprima 解析成 AST，触发进一步的依赖解析。这就是多引入 2 个模块的原因。</p>\n<h2 id="loaders-的拆解与运行"><a href="#loaders-%E7%9A%84%E6%8B%86%E8%A7%A3%E4%B8%8E%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loaders 的拆解与运行</h2>\n<p>loaders 就像首尾相接的管道那样，从右到左地被依次运行。对应的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58551540737711450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// buildDep.js\n/**\n * 运算文件类型对应的 loaders，比如: less 文件对应 style-loader 和 less-loader\n * 这些 loaders 本质上是一些处理字符串的函数，输入是一个字符串，输出是另一个字符串，从右到左串行执行\n * @param {string} request 相当于 filenamesWithLoader，比如 /Users/youngwind/www/fake-webpack/node_modules/fake-style-loader/index.js!/Users/youngwind/www/fake-webpack/node_modules/fake-less-loader/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n * @param {array} loaders 此类型文件对应的 loaders\n * @param {string} content 文件内容\n * @param {object} options 选项\n * @returns {Promise}\n */\nfunction execLoaders(request, loaders, content, options) {\n  return new Promise((resolve, reject) => {\n    // 当所有 loader 都执行完了，输出最终的字符串\n    if (!loaders.length) {\n      resolve(content);\n      return;\n    }\n\n    let loaderFunctions = [];\n    loaders.forEach((loaderName) => {\n      let loader = require(loaderName);\n      // 每个 loader 本质上是一个函数\n      loaderFunctions.push(loader);\n    });\n\n    nextLoader(content);\n\n    /***\n     * 调用下一个 loader\n     * @param {string} content 上一个 loader 的输出字符串\n     */\n    function nextLoader(content) {\n      if (!loaderFunctions.length) {\n        resolve(content);\n        return;\n      }\n      // 请注意: loader 有同步和异步两种类型。对于异步 loader，如 less-loader\n      // 需要执行 async() 和 callback()，以修改标志位和回传字符串\n      let async = false;\n      let context = {\n        request,\n        async: () => {\n          async = true;\n        },\n        callback: (content) => {\n          nextLoader(content);\n        }\n      };\n\n      // 就是在这儿逐个调用 loader\n      let ret = loaderFunctions.pop().call(context, content);\n      if (!async) {\n        // 递归调用下一个 loader\n        nextLoader(ret);\n      }\n    }\n  });\n}`, `58551540737711450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// buildDep.js</span>\n<span class="token comment">/**\n * 运算文件类型对应的 loaders，比如: less 文件对应 style-loader 和 less-loader\n * 这些 loaders 本质上是一些处理字符串的函数，输入是一个字符串，输出是另一个字符串，从右到左串行执行\n * @param {string} request 相当于 filenamesWithLoader，比如 /Users/youngwind/www/fake-webpack/node_modules/fake-style-loader/index.js!/Users/youngwind/www/fake-webpack/node_modules/fake-less-loader/index.js!/Users/youngwind/www/fake-webpack/examples/loader/style.less\n * @param {array} loaders 此类型文件对应的 loaders\n * @param {string} content 文件内容\n * @param {object} options 选项\n * @returns {Promise}\n */</span>\n<span class="token keyword">function</span> <span class="token function">execLoaders</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> loaders<span class="token punctuation">,</span> content<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 当所有 loader 都执行完了，输出最终的字符串</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaders<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">let</span> loaderFunctions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    loaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">loaderName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 每个 loader 本质上是一个函数</span>\n      loaderFunctions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token function">nextLoader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">/***\n     * 调用下一个 loader\n     * @param {string} content 上一个 loader 的输出字符串\n     */</span>\n    <span class="token keyword">function</span> <span class="token function">nextLoader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaderFunctions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 请注意: loader 有同步和异步两种类型。对于异步 loader，如 less-loader</span>\n      <span class="token comment">// 需要执行 async() 和 callback()，以修改标志位和回传字符串</span>\n      <span class="token keyword">let</span> async <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>\n        request<span class="token punctuation">,</span>\n        <span class="token function-variable function">async</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">callback</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token function">nextLoader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 就是在这儿逐个调用 loader</span>\n      <span class="token keyword">let</span> ret <span class="token operator">=</span> loaderFunctions<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 递归调用下一个 loader</span>\n        <span class="token function">nextLoader</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意：loader 也是分为同步和异步两种的，比如 style-loader 是同步的（看源码就知道，直接 return）；而 less-loader 却是异步的，为什么呢？</p>\n<h2 id="异步的-less-loader"><a href="#%E5%BC%82%E6%AD%A5%E7%9A%84-less-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步的 less-loader</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10924961520174524000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// less-loader\nconst less = require(\'less\');\n\nmodule.exports = function(source) {\n  // 声明此 loader 是异步的\n  this.async();\n  let resultCb = this.callback;\n  less.render(source, (e, output) => {\n    if (e) {\n      throw \\`less解析出现错误: \\${e}, \\${e.stack}\\`;\n    }\n    resultCb(\'module.exports = \' + JSON.stringify(output.css));\n  });\n};`, `10924961520174524000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// less-loader</span>\n<span class="token keyword">const</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'less\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 声明此 loader 是异步的</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> resultCb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callback<span class="token punctuation">;</span>\n  less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">less解析出现错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>stack<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">resultCb</span><span class="token punctuation">(</span><span class="token string">\'module.exports = \'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由代码我们可以看出：less-loader 本质上只是调用了 less 本身的 render 方法，由于 less.render 是异步的，less-loader 肯定也得异步，所以需要通过回调函数来获取其解析之后的 css 代码。</p>\n<h2 id="node-modules-的逐级查找"><a href="#node-modules-%E7%9A%84%E9%80%90%E7%BA%A7%E6%9F%A5%E6%89%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node-modules 的逐级查找</h2>\n<p>还差最后一点，我们就能完成 loader 机制了。试想以下情景：webpack 检测到当前为 less 文件，需要找到 style-loader 和 less-loader 运行。但是，webpack 怎么知道这两个 loader 藏在哪个目录下面呢？他们可能藏在 example.js 所在目录的任意上层文件夹的 node-modules 中。说到底，我们还是得实现之前提到过的 node-modules 的逐级查找功能。核心代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70856452646566240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// resolve.js\n/**\n * 根据 loaders / 模块名,生成待查找的路径集合\n * @param {string} context 入口文件所在目录\n * @param {array} identifiers 可能是 loader 的集合,也可能是模块名\n * @returns {Array}\n */\nfunction generateDirs(context, identifiers) {\n  let dirs = [];\n  for (let identifier of identifiers) {\n    if (path.isAbsolute(identifier)) {\n      // 绝对路径\n      if (!path.extname(identifier)) {\n        identifier += \'.js\';\n      }\n      dirs.push(identifier);\n    } else if (identifier.startsWith(\'./\') || identifier.startsWith(\'../\')) {\n      // 相对路径\n      dirs.push(path.resolve(context, identifier));\n    } else {\n      // 模块名，需要逐级生成目录\n      let ext = path.extname(identifier);\n      if (!ext) {\n        ext = \'.js\';\n      }\n      let paths = context.split(path.sep);\n      let tempPaths = paths.slice();\n      for (let folder of tempPaths) {\n        let newContext = paths.join(path.sep);\n        dirs.push(path.resolve(newContext, \'./node_modules\', \\`./\\${identifier}-loader-fake\\`, \\`index\\${ext}\\`));\n        paths.pop();\n      }\n    }\n  }\n  return dirs;\n}`, `70856452646566240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// resolve.js</span>\n<span class="token comment">/**\n * 根据 loaders / 模块名,生成待查找的路径集合\n * @param {string} context 入口文件所在目录\n * @param {array} identifiers 可能是 loader 的集合,也可能是模块名\n * @returns {Array}\n */</span>\n<span class="token keyword">function</span> <span class="token function">generateDirs</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> identifiers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> identifier <span class="token keyword">of</span> identifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 绝对路径</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        identifier <span class="token operator">+=</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>identifier<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'./\'</span><span class="token punctuation">)</span> <span class="token operator">||</span> identifier<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'../\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 相对路径</span>\n      dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> identifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 模块名，需要逐级生成目录</span>\n      <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ext<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        ext <span class="token operator">=</span> <span class="token string">\'.js\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">let</span> paths <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> tempPaths <span class="token operator">=</span> paths<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> folder <span class="token keyword">of</span> tempPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> newContext <span class="token operator">=</span> paths<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>newContext<span class="token punctuation">,</span> <span class="token string">\'./node_modules\'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>identifier<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-loader-fake</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ext<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        paths<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> dirs<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>举个例子，对于 style-loader 来说，生成的查找路径集合如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95972438070485700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n  \'/Users/youngwind/www/fake-webpack/examples/loader/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/fake-webpack/examples/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/www/node_modules/style-loader-fake/index.js\',\n  \'/Users/youngwind/node_modules/style-loader-fake/index.js\',\n  \'/Users/node_modules/style-loader-fake/index.js\'\n];`, `95972438070485700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/examples/loader/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/examples/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/fake-webpack/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/www/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/youngwind/node_modules/style-loader-fake/index.js\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'/Users/node_modules/style-loader-fake/index.js\'</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序按照这个顺序依次查找，直到找到为止或者最终找不到抛出错误。</p>\n<h2 id="后话-1"><a href="#%E5%90%8E%E8%AF%9D-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后话</h2>\n<p>至此，我们就完成了一个非常简单的 loader 机制，可以通过 style-loader 和 less-loader 处理加载 less 文件。当然，还有很多可以完善的地方，比如：</p>\n<ul>\n<li>css-loader，以处理 import 和 url 的情况</li>\n<li>给 loader 传递选项参数，以控制是否压缩代码等等特性</li>\n</ul>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/深入理解 Webpack 源码/index.md absPath of file >>> MarkdownRemark",timeToRead:29,frontmatter:{date:"2021-07-29 10:56:23",path:"/deep-learn-webpack-source-code/",tags:"前端, webpack, 前端构建工具",title:"深入理解 Webpack 源码",draft:null}},{excerpt:"处理流程 首先从源码解析(Parsing)开始，解析包含了两个步骤 词法解析(Lexical Analysis) 词法解析器(Tokenizer)在这个阶段将字符串形式的代码转换为 Tokens(令牌)。Tokens 可以视作是一些语法片段组成的数组。例如   词法解析后的结果如下: 从上图可以看，每个 Token 中包含了语法片段、位置信息、以及一些类型信息，这些信息有助于后续的语法分析。 语法解析(Syntactic Analysis) 这个阶段语法解析器(Parser)会把 Tokens…",html:'<h1 id="处理流程"><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理流程</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-7376a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 104.84472049689441%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACHUlEQVQ4y51T227TQBTs//8Ar4CQoLRNUh6R4LEiohJICW3aNFWTEjvEt7W998tZztqJmluRymgtndiZPTO7c4689+ADAMJ6EY7w0VozWnNKlRQvJksNUUqnUc4VOBtgjHHO4SesXQMsYE9YIOfM96/Ti+FiUYLgbDqdTiYTIYIK3gBrSikKPEA2FphyFTfahr3bVk0BxthQrHrCxlqTw2vnjFb7rrQgVZXn3AsDhz0r6xMio6QWetW2MWlCTws1uSPF5bK8KemdUWNvR95ONz3D99uiP8riEjhni8Wf+XxOCEFu0/2Hzl4lyfFseabZiZfvvfr8RLbOK+OYMLb5M7ZdH2zz2wxt9U5Wp4x+Muzc8TOvvm7INj7O2CwuuPZ4SUop3QBVhIOzQ1O9YeQDZ10veiBOt8gZhW+j7OLXMiospXWapqi5qqo4niu8HTMQxWtZd0B0vez5HTKqlY1s43aOs5U94MXbPDkmpCNpx8sTr75sXRX61OrpqlrPAIEMegDio1c9kF3AznLb84q8F6A1JDgCrvTQLuKh3iUrdSAkIeb4Hp4fjFq48e/66qHIWciGkCu0O97fjh4fHplQlDEZxm47ngV1lzdJ/3oREyOFKBqUZdnORpLl0TyyDtoJ2+38D88bgXlGdingalYNJnlao07sHYS3M9gqR2B4DpMrAYP74uc4QTKmqq7RHcOc4BZIw11YcCsPk/8bfwE/AsLn+yJ9rwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 11 37" title="" data-src="/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-fee1c.png" data-srcset="/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-a67b7.png 200w,\n/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-0b187.png 400w,\n/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-fee1c.png 800w,\n/static/2021-07-26-23-11-37-8891d7c76e944eec6cc870d27117bf75-7376a.png 805w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先从源码解析(Parsing)开始，解析包含了两个步骤</p>\n<h2 id="词法解析lexical-analysis"><a href="#%E8%AF%8D%E6%B3%95%E8%A7%A3%E6%9E%90lexical-analysis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>词法解析(Lexical Analysis)</h2>\n<p>词法解析器(Tokenizer)在这个阶段将字符串形式的代码转换为 Tokens(令牌)。Tokens 可以视作是一些语法片段组成的数组。例如 <code class="language-text">for (const item of items) {}</code> 词法解析后的结果如下:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-14-34-a8cfc672865b05236409e8accf14a682-aec66.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 700px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.857142857142854%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABM0lEQVQoz5WS627DIAyF8/4vsnbSnmKP0Wo/NnVNsq4hXHwBAzNppUmttKzWFzgKOthgusIwDu9fNswoSXK9Rqn/iK6K8Pfk7OCCs4DERMzIhEQxJUDkGFUr+l9yTimVct26KxzL4ch+QDCGSJfLEnkR+SKvotxl1iXEMB+QoT4YnX6SU0TDGjFqbQ+ZiycGTkkkJj2mzqLFN0RWzbm3cLRp9HHy5CEEgIAK6m1RjGXVPNj4YXgKHCAAESzOBtFK2YPD0aXDHE0gTav9Upv2BpYOrZaNvZWTl9ljAAxIofnbmP48dss8Ojt6B+R8OCPOiKZBBtCUAvWemn9b1Z9f+9P2PL3YaRNMA2ZlG+aNwHOlG55qHi5PuNOX5PHTw97jG9E+0i7RTsfITQjvq9ywW5I38w9a9fVL4ISnOwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 14 34" title="" data-src="/static/2021-07-26-23-14-34-a8cfc672865b05236409e8accf14a682-aec66.png" data-srcset="/static/2021-07-26-23-14-34-a8cfc672865b05236409e8accf14a682-61805.png 200w,\n/static/2021-07-26-23-14-34-a8cfc672865b05236409e8accf14a682-6a738.png 400w,\n/static/2021-07-26-23-14-34-a8cfc672865b05236409e8accf14a682-aec66.png 700w" data-sizes="(max-width: 700px) 100vw, 700px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上图可以看，每个 Token 中包含了语法片段、位置信息、以及一些类型信息，这些信息有助于后续的语法分析。</p>\n<h2 id="语法解析syntactic-analysis"><a href="#%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90syntactic-analysis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法解析(Syntactic Analysis)</h2>\n<p>这个阶段语法解析器(Parser)会把 Tokens 转换为抽象语法树(Abstract Syntax Tree，AST)</p>\n<p>AST 就是一棵对象树，用来表示代码的语法结构，例如 <code class="language-text">console.log(&#39;hello world&#39;)</code> 会解析成为</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-16-37-8f1fad370e9e8dd7d3067a0fc5b7e020-28759.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 500px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 118.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACO0lEQVQ4y52U227TQBCG+/4PgMoNKi1Rmia2m0QqEm1pAXHPFRKoCGhIHLu212t7z4dh4jaF0qSJGP22LO1+M7Oj9b/DmJgRzjmzRmkLQjttLDjv3Yaw1u6AA8Wrhvzk5XVOy+usShtVK0zi4Mnw3u/gg1+qyTj5LunE8rzWOm5qbvRiR6v1cLvqeJllSdKYUlrCNRU6Z1Ij7w2AfSR3B99nFkon8Uky7aZxP8leX80vfqSX0+xyTt6x5sLLt6BQF6BOwXxawn/6ssBPVPq8iZ+R/PDLbPx5Mvo6HV3FQ0ICx/sgByADkIeg39/D94ewmNs3fZbu0V+7BYmuktG3ZFjQoeMRyONWw0UK/fERjJXVmZeBk0NNO44PGAvqZuBkCCpaSN6m6K+CsbI+d3VP5Aey2Nd1j5TjvBhnZKSaiFehakK/Fr6tLAam6tWzXVEeToqQVpFix05ElkX4hqdhhzALPB84HmgR3vUsN7YN1qtzPLMkr/jNnqTdGxoWNFhiG2F+qsoDQ166qgMP5rQFDPJMkU4cd+O0P8+HORkZHnmxDdxOGwuWNMzi/SI7yorjqghFFbIqXKZ4cmB4h7wIZPbCVN2iCrMyuCmDtAzcNrDlA4v3qd3q5V3Pf3W+HjbijRNHoML2Dq8ULvVAf/gXRmfwLgU326QpuPyBGVij0Ya8Q/PxHraK2/95sdmoRtbJQiw31qJDLV1knZZtG620oMgjs3XhFsY+cVCcTkU9xyxYdb1trYAd/Fcg/BvRAUnCo9C4XAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 16 37" title="" data-src="/static/2021-07-26-23-16-37-8f1fad370e9e8dd7d3067a0fc5b7e020-28759.png" data-srcset="/static/2021-07-26-23-16-37-8f1fad370e9e8dd7d3067a0fc5b7e020-6ac48.png 200w,\n/static/2021-07-26-23-16-37-8f1fad370e9e8dd7d3067a0fc5b7e020-4b8bf.png 400w,\n/static/2021-07-26-23-16-37-8f1fad370e9e8dd7d3067a0fc5b7e020-28759.png 500w" data-sizes="(max-width: 500px) 100vw, 500px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Program、CallExpression、Identifier 这些都是节点的类型，每个节点都是一个有意义的语法单元。这些节点类型定义了一些属性来描述节点的信息。</p>\n<p>JavaScript 的语法越来越复杂，而且 Babel 除了支持最新的 JavaScript 规范语法，还支持 JSX、Flow、现在还有 Typescript。想象一下 AST 的节点类型有多少，其实我们不需要去记住这么多类型、也记不住。插件开发者会利用 ASTExplorer 来审查解析后的 AST 树，非常强大。</p>\n<p>AST 是 Babel 转译的核心数据结构，后续的操作都依赖于 AST。</p>\n<h2 id="转换transform"><a href="#%E8%BD%AC%E6%8D%A2transform" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>转换(Transform)</h2>\n<p>转换阶段会对 AST 进行遍历，在这个过程中对节点进行增删查改。Babel 所有插件都是在这个阶段工作，比如语法转换、代码压缩。</p>\n<p>Javascript In Javascript Out，最后阶段还是要把 AST 转换回字符串形式的 Javascript，同时这个阶段还会生成 Source Map。</p>\n<h1 id="babel-的架构"><a href="#babel-%E7%9A%84%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Babel 的架构</h1>\n<p>Babel 和 Webpack 为了适应复杂的定制需求和频繁的功能变化，都使用了<a href="https://juejin.im/post/5d7ffad551882545ff173083#heading-10" target="_blank" rel="nofollow noreferrer noopener">微内核</a>的架构风格。也就是说它们的核心非常小，大部分功能都是通过插件扩展实现的。</p>\n<p>所以简单地了解一下 Babel 的架构和一些基本概念，对后续文章内容的理解，以及 Babel 的使用还是有帮助的。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-0ac43.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.67441860465116%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz1VR226DMAzl/39qkyZN2sNepnXdWsq1lJAWkpAQcs8MVFN3FKHYPsc+OIl7gLX2MZRSaq0fq48E732ilNIrrDEQQ/keWtu2LRtHEC06YzaBAawcyCXrfelHKcuyvB8G4Pw1h4LSRgipje0wLssSZOAIRkI98T7EGHvu0lbtij5FigjP+ci58NBESyrs21d3uoiqPu92nwghSgjo72IfgjFB6SgkmAvOx2U05AWO6J2Tbpe3Z0xahIqiwBhTSud5XsSG7qMTRJKyP53QoRoyKgc1Kwl26Vkenvvrz+v3y77+GMjQNE1VVYwxv7hyieZ5tNNoplZ0xa1upys3k4LOyljW6PRJ0PrMuiu/QU6sgEsIYVlYWH/aD8RV9VyUsbkENpr1UYJiYTg6gqei1AjFsGxnw/YuibMGcvqKZXoc08N8SnV/E1JO0wSr1tYpIfo84x2CMZvb7buKN4TgY1wswAl3bDxAXEvuP4DwCyhvPd/4pdf+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 23 10" title="" data-src="/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-fee1c.png" data-srcset="/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-a67b7.png 200w,\n/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-0b187.png 400w,\n/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-fee1c.png 800w,\n/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-b1a91.png 1200w,\n/static/2021-07-26-23-23-10-d3f8ec90bb7fc694179e4ff64347d49b-0ac43.png 1290w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Babel 是一个 <a href="https://github.com/lerna/lerna" target="_blank" rel="nofollow noreferrer noopener">MonoRepo</a> 项目，不过组织非常清晰，下面就源码上我们能看到的模块进行一下分类，配合上面的架构图让你对 Babel 有个大概的认识:</p>\n<h2 id="核心"><a href="#%E6%A0%B8%E5%BF%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心</h2>\n<p>@babel/core 这也是上面说的微内核架构中的内核。对于 Babel 来说，这个内核主要干这些事情</p>\n<ul>\n<li>加载和处理配置(config)</li>\n<li>加载插件</li>\n<li>调用 Parser 进行语法解析，生成 AST</li>\n<li>调用 Traverser 遍历 AST，并使用访问者模式应用插件对 AST 进行转换</li>\n<li>生成代码，包括 SourceMap 转换和源代码生成</li>\n</ul>\n<h2 id="核心周边支撑"><a href="#%E6%A0%B8%E5%BF%83%E5%91%A8%E8%BE%B9%E6%94%AF%E6%92%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心周边支撑</h2>\n<h3 id="parserbabelparser"><a href="#parserbabelparser" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parser(@babel/parser)</h3>\n<p>将源代码解析为 AST 就靠它了。 它已经内置支持很多语法，例如 JSX、Typescript、Flow 以及最新的 ECMAScript 规范。目前为了执行效率，parser 是不支持扩展的，由官方进行维护。如果你要支持自定义语法，可以 fork 它，不过这种场景非常少。</p>\n<h3 id="traverserbabeltraverse"><a href="#traverserbabeltraverse" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Traverser(@babel/traverse)</h3>\n<p>实现了访问者模式，对 AST 进行遍历，转换插件会通过它获取感兴趣的 AST 节点，对节点继续操作，下文会详细介绍访问器模式。</p>\n<h3 id="generatorbabelgenerator"><a href="#generatorbabelgenerator" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generator(@babel/generator)</h3>\n<p>将 AST 转换为源代码，支持 SourceMap</p>\n<h2 id="插件"><a href="#%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件</h2>\n<p>打开 Babel 的源代码，会发现有好几种类型的插件</p>\n<h3 id="语法插件babelplugin-syntax-"><a href="#%E8%AF%AD%E6%B3%95%E6%8F%92%E4%BB%B6babelplugin-syntax-" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法插件(@babel/plugin-syntax-*)</h3>\n<p>上面说了 @babel/parser 已经支持了很多 JavaScript 语法特性，Parser 也不支持扩展。因此 plugin-syntax-* 实际上只是用于开启或者配置 Parser 的某个功能特性。</p>\n<p>一般用户不需要关心这个，Transform 插件里面已经包含了相关的 plugin-syntax-* 插件了，用户也可以通过 parserOpts 配置项来直接配置 Parser</p>\n<h3 id="转换插件"><a href="#%E8%BD%AC%E6%8D%A2%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>转换插件</h3>\n<p>用于对 AST 进行转换，实现转换为 ES5 代码、压缩、功能增强等目的。Babel 仓库将转换插件划分为两种（只是命名上的区别）</p>\n<ul>\n<li>@babel/plugin-transform-*：普通的转换插件</li>\n<li>@babel/plugin-proposal-*：还在提议阶段（非正式）的语言特性, 目前有<a href="https://babeljs.io/docs/en/next/plugins#experimental" target="_blank" rel="nofollow noreferrer noopener">这些</a></li>\n</ul>\n<h3 id="预定义集合babelpresets-"><a href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E9%9B%86%E5%90%88babelpresets-" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>预定义集合(@babel/presets-*)</h3>\n<p>插件集合或者分组，主要方便用户对插件进行管理和使用。比如 preset-env 含括所有的标准的最新特性，再比如 preset-react 含括所有 react 相关的插件</p>\n<h2 id="插件开发辅助"><a href="#%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%BE%85%E5%8A%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件开发辅助</h2>\n<ul>\n<li>@babel/template：某些场景直接操作 AST 太麻烦，就比如我们直接操作 DOM 一样，所以 Babel 实现了这么一个简单的模板引擎，可以将字符串代码转换为 AST，比如在生成一些辅助代码（helper）时会用到这个库</li>\n<li>@babel/types：AST 节点构造器和断言，插件开发时使用很频繁</li>\n<li>@babel/helper-*：一些辅助器，用于辅助插件开发，例如简化 AST 操作</li>\n<li>@babel/helper：辅助代码，单纯的语法转换可能无法让代码运行起来，比如低版本浏览器无法识别 class 关键字，这时候需要添加辅助代码，对 class 进行模拟</li>\n</ul>\n<h2 id="工具"><a href="#%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具</h2>\n<ul>\n<li>@babel/node：Node.js CLI，通过它直接运行需要 Babel 处理的 JavaScript 文件</li>\n<li>@babel/register：Patch NodeJs 的 require 方法，支持导入需要 Babel 处理的 JavaScript 模块</li>\n<li>@babel/cli：CLI 工具</li>\n</ul>\n<h1 id="访问者模式"><a href="#%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问者模式</h1>\n<p>转换器会遍历 AST 树，找出自己感兴趣的节点类型，再进行转换操作。这个过程和我们操作 DOM 树差不多，只不过目的不太一样。AST 遍历和转换一般会使用访问者模式。</p>\n<p>想象一下，Babel 有那么多插件，如果每个插件自己去遍历 AST，对不同的节点进行不同的操作，维护自己的状态。这样子不仅低效，它们的逻辑分散在各处，会让整个系统变得难以理解和调试，最后插件之间关系就纠缠不清，乱成一锅粥。</p>\n<p>所以转换器操作 AST 一般都是使用访问器模式，由这个访问者(Visitor)来</p>\n<ol>\n<li>进行统一的遍历操作</li>\n<li>提供节点的操作方法</li>\n<li>响应式维护节点之间的关系，而插件(设计模式中称为具体访问者)只需要定义自己感兴趣的节点类型，当访问者访问到对应节点时，就调用插件的访问(visit)方法。</li>\n</ol>\n<h2 id="节点的遍历"><a href="#%E8%8A%82%E7%82%B9%E7%9A%84%E9%81%8D%E5%8E%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点的遍历</h2>\n<p>假设我们的代码如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69774360214917500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function hello(v) {\n  console.log(\'hello\' + v + \'!\');\n}`, `69774360214917500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span> <span class="token operator">+</span> v <span class="token operator">+</span> <span class="token string">\'!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>解析后的 AST 结构如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65989991136563790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`File\n  Program (program)\n    FunctionDeclaration (body)\n      Identifier (id)  #hello\n      Identifier (params[0]) #v\n      BlockStatement (body)\n        ExpressionStatement ([0])\n          CallExpression (expression)\n            MemberExpression (callee)  #console.log\n              Identifier (object)  #console\n              Identifier (property)  #log\n            BinaryExpression (arguments[0])\n              BinaryExpression (left)\n                StringLiteral (left)  #\'hello\'\n                Identifier (right)  #v\n              StringLiteral (right)  #\'!\'`, `65989991136563790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">File\n  Program (program)\n    FunctionDeclaration (body)\n      Identifier (id)  #hello\n      Identifier (params[0]) #v\n      BlockStatement (body)\n        ExpressionStatement ([0])\n          CallExpression (expression)\n            MemberExpression (callee)  #console.log\n              Identifier (object)  #console\n              Identifier (property)  #log\n            BinaryExpression (arguments[0])\n              BinaryExpression (left)\n                StringLiteral (left)  #&#39;hello&#39;\n                Identifier (right)  #v\n              StringLiteral (right)  #&#39;!&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>访问者会以深度优先的顺序，或者说递归地对 AST 进行遍历，其调用顺序如下图所示:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-fac45.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 106.81536555142503%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAACDUlEQVQ4y5WU23KbMBCG/f7P1Jn2Kk59SuIz5iwhMAZzEDKSQBIVYZqLNjHOP0IzDPOx+++uNOnepf6q+44m+ql5TSpSlCUlRHIuhfgGnNYpjGEAAoSCPI5lXXdCqAd+0cO4wSEOURZABJM4rnCJs6ukde9GyhFYdb3VlKbwDFwQGhYwbVBmleCNoFQ2zVCVz+FBrWxLUWwiNN27z4a/cNCV4U6KcXgITkW98r2ZgWZHsDRRTDLVNo/CBS+OyLBc6+SfbGhdk7AlRHA+nrYWE6xghRPbruMGPojC6Ho+K8a+Ktvkn/dWtQlNUIlMxwQ+CAJ4iSJWFJ2QOgW95LDa9hN4yD9nuZu6NrCBBxCExTWtCe6U0PXr+6+UYEzvk696WMt6Ha23cLOwdvPDaWkc4TkvyltbE/21L8QdWFeZNDedyjqCP16NX9vTz7W1jRDl1Tt8N7I2n5OM4dyFcLv3d3v3aEdJUgo9/00j9Aj/7/lD2p8PdufpNJ0v0uU8nj3z5CIoa4hOiOgW3oWVqBqSSxz6u2A6RcvFZbWsoKurrodRj+09eFDCUis5+NF+Yz1vjKe1M7NiA9+ykciDygb3Z4bnq2D/dFr9Nl9mzpuXA17hcRj3sCr5zUv40SsOXubETYlbWd/UKFy1lZe7O2/zYi437qt/dQSnivGHPPcD31JMS0yx3m+c6Pvh45D8AaYkvLb/3YC4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 41 21" title="" data-src="/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-fee1c.png" data-srcset="/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-a67b7.png 200w,\n/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-0b187.png 400w,\n/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-fee1c.png 800w,\n/static/2021-07-26-23-41-21-c9296a8b8c81f791ff436adc89fb6dfd-fac45.png 807w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中绿线表示进入该节点，红线表示离开该节点。下面写一个超简单的具体访问者来还原上面的遍历过程:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97366893145442620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const babel = require(\'@babel/core\');\nconst traverse = require(\'@babel/traverse\').default;\n\nconst ast = babel.parseSync(code);\n\nlet depth = 0;\ntraverse(ast, {\n  enter(path) {\n    console.log(\\`enter \\${path.type}(\\${path.key})\\`);\n    depth++;\n  },\n  exit(path) {\n    depth--;\n    console.log(\\`  exit \\${path.type}(\\${path.key})\\`);\n  }\n});`, `97366893145442620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@babel/core\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@babel/traverse\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> ast <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">parseSync</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">enter </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    depth<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    depth<span class="token operator">--</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  exit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53925898321582210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`enter Program(program)\n  enter FunctionDeclaration(0)\n    enter Identifier(id)\n    exit Identifier(id)\n    enter Identifier(0)\n    exit Identifier(0)\n    enter BlockStatement(body)\n      enter ExpressionStatement(0)\n        enter CallExpression(expression)\n          enter MemberExpression(callee)\n            enter Identifier(object)\n            exit Identifier(object)\n            enter Identifier(property)\n            exit Identifier(property)\n          exit MemberExpression(callee)\n          enter BinaryExpression(0)\n            enter BinaryExpression(left)\n              enter StringLiteral(left)\n              exit StringLiteral(left)\n              enter Identifier(right)\n              exit Identifier(right)\n            exit BinaryExpression(left)\n            enter StringLiteral(right)\n            exit StringLiteral(right)\n          exit BinaryExpression(0)\n        exit CallExpression(expression)\n      exit ExpressionStatement(0)\n    exit BlockStatement(body)\n  exit FunctionDeclaration(0)\nexit Program(program)`, `53925898321582210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">enter Program(program)\n  enter FunctionDeclaration(0)\n    enter Identifier(id)\n    exit Identifier(id)\n    enter Identifier(0)\n    exit Identifier(0)\n    enter BlockStatement(body)\n      enter ExpressionStatement(0)\n        enter CallExpression(expression)\n          enter MemberExpression(callee)\n            enter Identifier(object)\n            exit Identifier(object)\n            enter Identifier(property)\n            exit Identifier(property)\n          exit MemberExpression(callee)\n          enter BinaryExpression(0)\n            enter BinaryExpression(left)\n              enter StringLiteral(left)\n              exit StringLiteral(left)\n              enter Identifier(right)\n              exit Identifier(right)\n            exit BinaryExpression(left)\n            enter StringLiteral(right)\n            exit StringLiteral(right)\n          exit BinaryExpression(0)\n        exit CallExpression(expression)\n      exit ExpressionStatement(0)\n    exit BlockStatement(body)\n  exit FunctionDeclaration(0)\nexit Program(program)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当访问者进入一个节点时就会调用 enter（进入）方法，反之离开该节点时会调用 exit（离开）方法。一般情况下，插件不会直接使用 enter 方法，只会关注少数几个节点类型，所以具体访问者也可以这样声明访问方法:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92425210712436920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`traverse(ast, {\n  // 访问标识符\n  Identifier(path) {\n    console.log(\\`enter Identifier\\`);\n  },\n  // 访问调用表达式\n  CallExpression(path) {\n    console.log(\\`enter CallExpression\\`);\n  },\n  // 上面是 enter 的简写，如果要处理 exit，也可以这样\n  // 二元操作符\n  BinaryExpression: {\n    enter(path) {},\n    exit(path) {}\n  },\n  // 更高级的, 使用同一个方法访问多种类型的节点\n  \'ExportNamedDeclaration|Flow\'(path) {}\n});`, `92425210712436920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 访问标识符</span>\n  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">enter Identifier</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 访问调用表达式</span>\n  <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">enter CallExpression</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 上面是 enter 的简写，如果要处理 exit，也可以这样</span>\n  <span class="token comment">// 二元操作符</span>\n  BinaryExpression<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 更高级的, 使用同一个方法访问多种类型的节点</span>\n  <span class="token string">\'ExportNamedDeclaration|Flow\'</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么 Babel 插件是怎么被应用的呢？</p>\n<p>Babel 会按照插件定义的顺序来应用访问方法，比如你注册了多个插件，babel-core 最后传递给访问器的数据结构大概长这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23864057954867634000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  Identifier: {\n    enter: [\'plugin-xx\', \'plugin-yy\']; // 数组形式\n  }\n}`, `23864057954867634000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  Identifier<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    enter<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'plugin-xx\'</span><span class="token punctuation">,</span> <span class="token string">\'plugin-yy\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 数组形式</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当进入一个节点时，这些插件会按照注册的顺序被执行。大部分插件是不需要开发者关心定义的顺序的，有少数的情况需要稍微注意以下，例如 plugin-proposal-decorators:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97261045573072620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;plugins&quot;: [\n    &quot;@babel/plugin-proposal-decorators&quot;,     // 必须在 plugin-proposal-class-properties 之前\n    &quot;@babel/plugin-proposal-class-properties&quot;\n  ]\n}`, `97261045573072620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token string">"@babel/plugin-proposal-decorators"</span><span class="token punctuation">,</span>     <span class="token comment">// 必须在 plugin-proposal-class-properties 之前</span>\n    <span class="token string">"@babel/plugin-proposal-class-properties"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所有插件定义的顺序，按照惯例，应该是新的或者说实验性的插件在前面，老的插件定义在后面。因为可能需要新的插件将 AST 转换后，老的插件才能识别语法（向后兼容）。下面是官方配置例子, 为了确保先后兼容，stage-* 阶段的插件先执行:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3432200184985023500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;presets&quot;: [&quot;es2015&quot;, &quot;react&quot;, &quot;stage-2&quot;]\n}`, `3432200184985023500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"es2015"</span><span class="token punctuation">,</span> <span class="token string">"react"</span><span class="token punctuation">,</span> <span class="token string">"stage-2"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意 Preset 的执行顺序相反</p>\n</blockquote>\n<h2 id="节点的上下文"><a href="#%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点的上下文</h2>\n<p>访问者在访问一个节点时, 会无差别地调用 enter 方法，我们怎么知道这个节点在什么位置以及和其他节点的关联关系呢？</p>\n<p>通过上面的代码，读者应该可以猜出几分，每个 visit 方法都接收一个 Path 对象, 你可以将它当做一个上下文对象，类似于 JQuery 的 <code class="language-text">JQuery(const $el = $(&#39;.el&#39;))</code> 对象，这里面包含了很多信息：</p>\n<ul>\n<li>当前节点信息</li>\n<li>节点的关联信息。父节点、子节点、兄弟节点等等</li>\n<li>作用域信息</li>\n<li>上下文信息</li>\n<li>节点操作方法。节点增删查改</li>\n<li>断言方法。isXXX，assertXXX</li>\n</ul>\n<p>下面是它的主要结构:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29171488650419188000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export class NodePath<T = Node> {\n  constructor(hub: Hub, parent: Node);\n  parent: Node;\n  hub: Hub;\n  contexts: TraversalContext[];\n  data: object;\n  shouldSkip: boolean;\n  shouldStop: boolean;\n  removed: boolean;\n  state: any;\n  opts: object;\n  skipKeys: object;\n  parentPath: NodePath;\n  context: TraversalContext;\n  container: object | object[];\n  listKey: string; // 如果节点在一个数组中，这个就是节点数组的键\n  inList: boolean;\n  parentKey: string;\n  key: string | number; // 节点所在的键或索引\n  node: T; // 🔴 当前节点\n  scope: Scope; // 🔴当前节点所在的作用域\n  type: T extends undefined | null ? string | null : string; // 🔴节点类型\n  typeAnnotation: object;\n  // ... 还有很多方法，实现增删查改\n}`, `29171488650419188000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NodePath</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> Node<span class="token operator">></span> <span class="token punctuation">{</span>\n  <span class="token keyword">constructor</span><span class="token punctuation">(</span>hub<span class="token punctuation">:</span> Hub<span class="token punctuation">,</span> parent<span class="token punctuation">:</span> Node<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  parent<span class="token punctuation">:</span> Node<span class="token punctuation">;</span>\n  hub<span class="token punctuation">:</span> Hub<span class="token punctuation">;</span>\n  contexts<span class="token punctuation">:</span> TraversalContext<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  data<span class="token punctuation">:</span> object<span class="token punctuation">;</span>\n  shouldSkip<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n  shouldStop<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n  removed<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n  state<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n  opts<span class="token punctuation">:</span> object<span class="token punctuation">;</span>\n  skipKeys<span class="token punctuation">:</span> object<span class="token punctuation">;</span>\n  parentPath<span class="token punctuation">:</span> NodePath<span class="token punctuation">;</span>\n  context<span class="token punctuation">:</span> TraversalContext<span class="token punctuation">;</span>\n  container<span class="token punctuation">:</span> object <span class="token operator">|</span> object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  listKey<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 如果节点在一个数组中，这个就是节点数组的键</span>\n  inList<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n  parentKey<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token comment">// 节点所在的键或索引</span>\n  node<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">;</span> <span class="token comment">// 🔴 当前节点</span>\n  scope<span class="token punctuation">:</span> Scope<span class="token punctuation">;</span> <span class="token comment">// 🔴当前节点所在的作用域</span>\n  <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">undefined</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 🔴节点类型</span>\n  typeAnnotation<span class="token punctuation">:</span> object<span class="token punctuation">;</span>\n  <span class="token comment">// ... 还有很多方法，实现增删查改</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以通过这个手册来学习怎么通过 Path 来转换 AST，后面也会有代码示例，这里就不展开细节了</p>\n<h2 id="副作用的处理"><a href="#%E5%89%AF%E4%BD%9C%E7%94%A8%E7%9A%84%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>副作用的处理</h2>\n<p>实际上访问者的工作比我们想象的要复杂的多，上面示范的是静态 AST 的遍历过程。而 AST 转换本身是有副作用的，比如插件将旧的节点替换了，那么访问者就没有必要再向下访问旧节点了，而是继续访问新的节点，代码如下。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36585568643537125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`traverse(ast, {\n  ExpressionStatement(path) {\n    // 将 console.log(\'hello\' + v + \'!\') 替换为 return \'hello\' + v\n    const rtn = t.returnStatement(t.binaryExpression(\'+\', t.stringLiteral(\'hello\'), t.identifier(\'v\')))\n    path.replaceWith(rtn)\n  },\n}`, `36585568643537125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">ExpressionStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将 console.log(\'hello\' + v + \'!\') 替换为 return \'hello\' + v</span>\n    <span class="token keyword">const</span> rtn <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span><span class="token string">\'+\'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">\'v\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>rtn<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码, 将 <code class="language-text">console.log(&#39;hello&#39; + v + &#39;!&#39;)</code> 语句替换为<code class="language-text">return &#39;hello&#39; + v</code>, 下图是遍历的过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-b9e7f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 83.15972222222223%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQ4y5VT227bMAz1///V9lagHdoOG7qrmzWJPdmJZFuiRFGURjtD0aRY1hgybQg65LlAVSmFiDAiM5cLn4oLN6bZ93s7GArhMnAuWXu9alePdd03zdR3woSJ3gqWj43TxqiHX+rhUe2tzxRzzv8Hy3s4t5127z99e3f//UuzZfRigexnqcervGhaPf91tvv5VNfrlerbBMAL+Uwpp3mVxEWqtJN6ApaejtxrYj55SOA5KNu1bdOs16NSybkc49HkwGHEETwEHwBBenmCKU6H0cBe9U/r2+vm7qa9/wC6l+3q5RwhFWIAAOdcCD4l+iuSZ52UY+vam/r26uv1x83n0enqhKeY76Kb/DQ6OzmHSCwiF+/mUDCsOvdjazY7jxir1zpFvxzXDvrB7i3EROUfsVWng0tBhKB+oxmCGQlCkYQWnw+8zoCXyTFi13q980bjaBLFchzvOfDsTWFkHGDQVhsYMIYLwInneMSuwcEEIRJdApZgJWovidnEC/Lt4OfYzl+MP8ZU5c3XffUpAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 26 23 54 26" title="" data-src="/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-fee1c.png" data-srcset="/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-a67b7.png 200w,\n/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-0b187.png 400w,\n/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-fee1c.png 800w,\n/static/2021-07-26-23-54-26-58b20ef39e9cdae5fd5c3d63ddf62cbb-b9e7f.png 1152w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以对 AST 进行任意的操作，比如删除父节点的兄弟节点、删除第一个子节点、新增兄弟节点，当这些操作污染了 AST 树后，访问者需要记录这些状态，响应式(Reactive)更新 Path 对象的关联关系，保证正确的遍历顺序，从而获得正确的转译结果。</p>\n<h2 id="作用域的处理"><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作用域的处理</h2>\n<p>访问者可以确保正确地遍历和修改节点，但是对于转换器来说，另一个比较棘手的是对作用域的处理，这个责任落在了插件开发者的头上。插件开发者必须非常谨慎地处理作用域，不能破坏现有代码的执行逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58512264311185950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const a = 1,\n  b = 2;\nfunction add(foo, bar) {\n  console.log(a, b);\n  return foo + bar;\n}`, `58512264311185950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">foo<span class="token punctuation">,</span> bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> foo <span class="token operator">+</span> bar<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>比如你要将 add 函数的第一个参数 foo 标识符修改为 a，你就需要递归遍历子树，查出 foo 标识符的所有引用，然后替换它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5784157694188275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`traverse(ast, {\n  // 将第一个参数名转换为 a\n  FunctionDeclaration(path) {\n    const firstParams = path.get(\'params.0\');\n    if (firstParams == null) {\n      return;\n    }\n\n    const name = firstParams.node.name;\n    // 递归遍历，这是插件常用的模式。这样可以避免影响到外部作用域\n    path.traverse({\n      Identifier(path) {\n        if (path.node.name === name) {\n          path.replaceWith(t.identifier(\'a\'));\n        }\n      }\n    });\n  }\n});\n\nconsole.log(generate(ast).code);\n// function add(a, bar) {\n//   console.log(a, b);\n//   return a + bar;\n// }`, `5784157694188275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将第一个参数名转换为 a</span>\n  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> firstParams <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'params.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstParams <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> name <span class="token operator">=</span> firstParams<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n    <span class="token comment">// 递归遍历，这是插件常用的模式。这样可以避免影响到外部作用域</span>\n    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// function add(a, bar) {</span>\n<span class="token comment">//   console.log(a, b);</span>\n<span class="token comment">//   return a + bar;</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>替换成 a 之后, <code class="language-text">console.log(a, b)</code> 的行为就被破坏了。所以这里不能用 a，得换个标识符，譬如 c</p>\n<p>这就是转换器需要考虑的作用域问题，AST 转换的前提是保证程序的正确性。我们在添加和修改引用时，需要确保与现有的所有引用不冲突。Babel 本身不能检测这类异常，只能依靠插件开发者谨慎处理。</p>\n<p>Javascript 采用的是词法作用域，也就是根据源代码的词法结构来确定作用域：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-0ac43.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.96899224806202%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAACZUlEQVQoz2P4+PHjmZMnr5w5e/Xs+UunT10+c+bS6dMQdPHUqYunTgJFkAXh6OvnzwyHjx7VlZcPN7GKsnbzMzAKMNALNNANNNAPNNAJMzGLsrT30tb21tb20NR019AAIRjj6tmzUM2BBkb+xmae2joemuqemhqeWpqemuo+OnoB+iYQpR5wpKkJYcA0KygEGRmGmBr56un5Ghr76hv66BsAGd56eu4a6h5amihIWwvCAGk+dPSovqJisK5egI62v46uj7YBGOn7aev46Rl5aeq4q6p7qGkgkLomhAHWfOSovpJisINxkJNZoJNxoLNpgJNZgJNxgKNxgJO5n6OJt62+l40uEtIDkdY6Vy+cYzh85KiekmJYpE1Eon1wtFVYrGVIrE1QtLV/uLl/hIV/hLlfuBk6ijDzDTG9evk8yM968rKhGQHhLXnBtRlBtZnBNWlhdRmh9Vkh9ZkhQJGaNHRUmx5YnnT1xjWg5mN6cjLh+WGpM2vTp5anTytPmVaZPLUyaVJZwqQSTJQ4qTRxcll8d8H1O9dBmnXlZKMKQro3lU3YWDhhU3HfxqKe9YU9Gwq61xcAyZ71KKhrbUH3uvy2JZl3719DaO5YXwIU7d0I1FbYu7EIiPo2FfVuKgKzoSK9EHM3FrUuyYZrlokqDOvcXNG9obBnU0nPRiAqhqCu9UVgVAhDRd1AtLG4bXnu3fvXGY4cO2aorBidE5Dem5nWnpzWkUIYdaamNCXcuH2VYd+BAzICApZqMkaKEoYKCGSkIGkIQhJoyEgRLCgvceHUSYYXL14sXbxk2UIgWkwSev3qFQAnxYC5X0UFqQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 27 00 00 26" title="" data-src="/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-fee1c.png" data-srcset="/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-a67b7.png 200w,\n/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-0b187.png 400w,\n/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-fee1c.png 800w,\n/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-b1a91.png 1200w,\n/static/2021-07-27-00-00-26-dc19ec472d50e448613993257bb90065-0ac43.png 1290w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在词法区块(block)中，由于新建变量、函数、类、函数参数等创建的标识符，都属于这个区块作用域。这些标识符也称为绑定(Binding)，而对这些绑定的使用称为引用(Reference)</p>\n<p>在 Babel 中，使用 Scope 对象来表示作用域。我们可以通过 Path 对象的 scope 字段来获取当前节点的 Scope 对象。它的结构如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71318101695108910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  path: NodePath;\n  block: Node;         // 所属的词法区块节点, 例如函数节点、条件语句节点\n  parentBlock: Node;   // 所属的父级词法区块节点\n  parent: Scope;       // 指向父作用域\n  bindings: { [name: string]: Binding; }; // 该作用域下面的所有绑定(即该作用域创建的标识符)\n}`, `71318101695108910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  path<span class="token punctuation">:</span> NodePath<span class="token punctuation">;</span>\n  block<span class="token punctuation">:</span> Node<span class="token punctuation">;</span>         <span class="token comment">// 所属的词法区块节点, 例如函数节点、条件语句节点</span>\n  parentBlock<span class="token punctuation">:</span> Node<span class="token punctuation">;</span>   <span class="token comment">// 所属的父级词法区块节点</span>\n  parent<span class="token punctuation">:</span> Scope<span class="token punctuation">;</span>       <span class="token comment">// 指向父作用域</span>\n  bindings<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token punctuation">:</span> string<span class="token punctuation">]</span><span class="token punctuation">:</span> Binding<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 该作用域下面的所有绑定(即该作用域创建的标识符)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Scope 对象和 Path 对象差不多，它包含了作用域之间的关联关系(通过 parent 指向父作用域)，收集了作用域下面的所有绑定(bindings)，另外还提供了丰富的方法来操作作用域。</p>\n<p>我们可以通过 bindings 属性获取当前作用域下的所有绑定(即标识符)，每个绑定由 Binding 类来表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20210523801594892000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export class Binding {\n  identifier: t.Identifier;\n  scope: Scope;\n  path: NodePath;\n  kind: \'var\' | \'let\' | \'const\' | \'module\';\n  referenced: boolean;\n  references: number; // 被引用的数量\n  referencePaths: NodePath[]; // ⚛️获取所有应用该标识符的节点路径\n  constant: boolean; // 是否是常量\n  constantViolations: NodePath[];\n}`, `20210523801594892000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Binding</span> <span class="token punctuation">{</span>\n  identifier<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Identifier<span class="token punctuation">;</span>\n  scope<span class="token punctuation">:</span> Scope<span class="token punctuation">;</span>\n  path<span class="token punctuation">:</span> NodePath<span class="token punctuation">;</span>\n  kind<span class="token punctuation">:</span> <span class="token string">\'var\'</span> <span class="token operator">|</span> <span class="token string">\'let\'</span> <span class="token operator">|</span> <span class="token string">\'const\'</span> <span class="token operator">|</span> <span class="token string">\'module\'</span><span class="token punctuation">;</span>\n  referenced<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>\n  references<span class="token punctuation">:</span> number<span class="token punctuation">;</span> <span class="token comment">// 被引用的数量</span>\n  referencePaths<span class="token punctuation">:</span> NodePath<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ⚛️获取所有应用该标识符的节点路径</span>\n  constant<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span> <span class="token comment">// 是否是常量</span>\n  constantViolations<span class="token punctuation">:</span> NodePath<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 Binding 对象我们可以确定标识符被引用的情况。</p>\n<p>Ok，有了 Scope 和 Binding，现在有能力实现安全的变量重命名转换了。为了更好地展示作用域交互，在上面代码的基础上，我们再增加一下难度：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17129155640242555000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const a = 1;\nconst b = 2;\nfunction add(foo, bar) {\n  console.log(a, b);\n  return () => {\n    const a = \'1\'; // 新增了一个变量声明\n    return a + (foo + bar);\n  };\n}`, `17129155640242555000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">foo<span class="token punctuation">,</span> bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">\'1\'</span><span class="token punctuation">;</span> <span class="token comment">// 新增了一个变量声明</span>\n    <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token punctuation">(</span>foo <span class="token operator">+</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在你要重命名函数参数 foo, 不仅要考虑外部的作用域, 也要考虑下级作用域的绑定情况，确保这两者都不冲突。</p>\n<p>上面的代码作用域和标识符引用情况如下图所示:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-63a9f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.839449541284395%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABtklEQVQoz2P4////v3///vxFAf/+/f0HEv4HInEgoEYGoNKeisqSsKiy6LjCiOiiyOjiqFggIy8kLC8kNDcYirIDg0uiYr7cuvP/xat/T579e/Hy39+/DH///M0M8PcyUA621g0w1wqz0AuyNPEx1fO2NHI31nIxUHfSU3PWV3fQUfE2139+6dT3x7c/37v6+9H9/3//gTTnRUf4BujHxVtFRplFR1nExNqERVkHhpn7BRnBkU+AQVik5fXbu56+PHHvyaFPT279//sfpDk3MtQ71DK2NC68ICKsMCy8MDSoIDQI6NbC8ODc4BCgB4CMvJDwovCj949ceH3x0tPjn5/chGrOjwrzSXRLnNmWOK05fnp9zJT62BktMVMbE2a1xU5rippUGzu1AUjGTWvc8PzS9g/3Dr849+XJDajmzOAAF089n2gHrwhbrwg7rwgbr0h7z3AI29Yz3MYjzMYt1CogzvnMrf03X5y98fjo58cQm//+7a2uzo0Izo8KyYsMRkIhSIyQnPCg0oToD7ev/Xv55OfTB39ePgcFGDC6QDH75+8/cOzC0V8kBhyBYxeYMEBpAEgDACKETvWUtAWgAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 27 00 04 31" title="" data-src="/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-fee1c.png" data-srcset="/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-a67b7.png 200w,\n/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-0b187.png 400w,\n/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-fee1c.png 800w,\n/static/2021-07-27-00-04-31-ed77f0c7523a13dedb8d36c8b27724ad-63a9f.png 872w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>试着将函数的第一个参数重新命名为更短的标识符:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96083241282740930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 用于获取唯一的标识符\nconst getUid = () => {\n  let uid = 0;\n  return () => \\`_\\${uid++ || \'\'}\\`;\n};\n\nconst ast = babel.parseSync(code);\ntraverse(ast, {\n  FunctionDeclaration(path) {\n    // 获取第一个参数\n    const firstParam = path.get(\'params.0\');\n    if (firstParam == null) {\n      return;\n    }\n\n    const currentName = firstParam.node.name;\n    const currentBinding = path.scope.getBinding(currentName);\n    const gid = getUid();\n    let sname;\n\n    // 循环找出没有被占用的变量名\n    while (true) {\n      sname = gid();\n\n      // 1️、首先看一下父作用域是否已定义了该变量\n      if (path.scope.parentHasBinding(sname)) {\n        continue;\n      }\n\n      // 2、查当前作用域是否定义了变量\n      if (path.scope.hasOwnBinding(sname)) {\n        // 已占用\n        continue;\n      }\n\n      // 再检查第一个参数的当前的引用情况,\n      // 如果它所在的作用域定义了同名的变量，我们也得放弃\n      if (currentBinding.references > 0) {\n        let findIt = false;\n        for (const refNode of currentBinding.referencePaths) {\n          if (refNode.scope !== path.scope && refNode.scope.hasBinding(sname)) {\n            findIt = true;\n            break;\n          }\n        }\n        if (findIt) {\n          continue;\n        }\n      }\n      break;\n    }\n\n    // 开始替换掉\n    const i = t.identifier(sname);\n    currentBinding.referencePaths.forEach((p) => p.replaceWith(i));\n    firstParam.replaceWith(i);\n  }\n});\n\nconsole.log(generate(ast).code);\n// const a = 1,\n//       b = 2;\n\n// function add(_, bar) {\n//   console.log(a, b);\n//   return () => {\n//     const a = \'1\'; // 新增了一个变量声明\n\n//     return a + (_ + bar);\n//   };\n// }`, `96083241282740930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 用于获取唯一的标识符</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getUid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uid<span class="token operator">++</span> <span class="token operator">||</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> ast <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">parseSync</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取第一个参数</span>\n    <span class="token keyword">const</span> firstParam <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'params.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstParam <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> currentName <span class="token operator">=</span> firstParam<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> currentBinding <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>currentName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> gid <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> sname<span class="token punctuation">;</span>\n\n    <span class="token comment">// 循环找出没有被占用的变量名</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      sname <span class="token operator">=</span> <span class="token function">gid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 1️、首先看一下父作用域是否已定义了该变量</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">parentHasBinding</span><span class="token punctuation">(</span>sname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">continue</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 2、查当前作用域是否定义了变量</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasOwnBinding</span><span class="token punctuation">(</span>sname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 已占用</span>\n        <span class="token keyword">continue</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 再检查第一个参数的当前的引用情况,</span>\n      <span class="token comment">// 如果它所在的作用域定义了同名的变量，我们也得放弃</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBinding<span class="token punctuation">.</span>references <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> findIt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> refNode <span class="token keyword">of</span> currentBinding<span class="token punctuation">.</span>referencePaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>refNode<span class="token punctuation">.</span>scope <span class="token operator">!==</span> path<span class="token punctuation">.</span>scope <span class="token operator">&amp;&amp;</span> refNode<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span>sname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            findIt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token keyword">break</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>findIt<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">continue</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 开始替换掉</span>\n    <span class="token keyword">const</span> i <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>sname<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    currentBinding<span class="token punctuation">.</span>referencePaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    firstParam<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const a = 1,</span>\n<span class="token comment">//       b = 2;</span>\n\n<span class="token comment">// function add(_, bar) {</span>\n<span class="token comment">//   console.log(a, b);</span>\n<span class="token comment">//   return () => {</span>\n<span class="token comment">//     const a = \'1\'; // 新增了一个变量声明</span>\n\n<span class="token comment">//     return a + (_ + bar);</span>\n<span class="token comment">//   };</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的例子虽然没有什么实用性，而且还有 Bug(没考虑 label)，但是正好可以揭示了作用域处理的复杂性。</p>\n<p>Babel 的 Scope 对象其实提供了一个 generateUid 方法来生成唯一的、不冲突的标识符。我们利用这个方法再简化一下我们的代码:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20165854546721018000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`traverse(ast, {\n  FunctionDeclaration(path) {\n    const firstParam = path.get(\'params.0\');\n    if (firstParam == null) {\n      return;\n    }\n    let i = path.scope.generateUidIdentifier(\'_\'); // 也可以使用 generateUid\n    const currentBinding = path.scope.getBinding(firstParam.node.name);\n    currentBinding.referencePaths.forEach((p) => p.replaceWith(i));\n    firstParam.replaceWith(i);\n  }\n});`, `20165854546721018000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> firstParam <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'params.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstParam <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">let</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">\'_\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 也可以使用 generateUid</span>\n    <span class="token keyword">const</span> currentBinding <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>firstParam<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    currentBinding<span class="token punctuation">.</span>referencePaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    firstParam<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4061655497494199000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`traverse(ast, {\n  FunctionDeclaration(path) {\n    const firstParam = path.get(\'params.0\');\n    if (firstParam == null) {\n      return;\n    }\n    let i = path.scope.generateUid(\'_\'); // 也可以使用generateUid\n    path.scope.rename(firstParam.node.name, i);\n  }\n});`, `4061655497494199000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> firstParam <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'params.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstParam <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">let</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUid</span><span class="token punctuation">(</span><span class="token string">\'_\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 也可以使用generateUid</span>\n    path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>firstParam<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>generateUid 的实现代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12547895668592224000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`generateUid(name: string = &quot;temp&quot;) {\n  name = t\n    .toIdentifier(name)\n    .replace(/^_+/, &quot;&quot;)\n    .replace(/[0-9]+\\$/g, &quot;&quot;);\n\n  let uid;\n  let i = 0;\n  do {\n    uid = this._generateUid(name, i);\n    i++;\n  } while (\n    this.hasLabel(uid) ||\n    this.hasBinding(uid) ||\n    this.hasGlobal(uid) ||\n    this.hasReference(uid)\n  );\n\n  const program = this.getProgramParent();\n  program.references[uid] = true;\n  program.uids[uid] = true;\n\n  return uid;\n}`, `12547895668592224000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">generateUid</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">"temp"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  name <span class="token operator">=</span> t\n    <span class="token punctuation">.</span><span class="token function">toIdentifier</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^_+/</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[0-9]+$/g</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> uid<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">do</span> <span class="token punctuation">{</span>\n    uid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_generateUid</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    i<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasLabel</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">||</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">||</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasGlobal</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">||</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasReference</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProgramParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  program<span class="token punctuation">.</span>references<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  program<span class="token punctuation">.</span>uids<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> uid<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>作用域操作最典型的场景是代码压缩，代码压缩会对变量名、函数名等进行压缩，然而实际上很少的插件场景需要跟作用域进行复杂的交互，所以关于作用域这一块就先讲到这里。</p>\n<h1 id="写一个插件"><a href="#%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写一个插件</h1>\n<p>现在打算模仿 babel-plugin-import，写一个极简版插件，来实现模块的按需导入。在这个插件中，我们会将类似这样的导入语句</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31428066087609730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { A, B, C as D } from \'foo\';`, `31428066087609730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token keyword">as</span> <span class="token constant">D</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'foo\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>转换为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40866658407165100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import A from \'foo/A\';\nimport \'foo/A/style.css\';\nimport B from \'foo/B\';\nimport \'foo/B/style.css\';\nimport D from \'foo/C\';\nimport \'foo/C/style.css\';`, `40866658407165100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token constant">A</span> <span class="token keyword">from</span> <span class="token string">\'foo/A\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'foo/A/style.css\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token constant">B</span> <span class="token keyword">from</span> <span class="token string">\'foo/B\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'foo/B/style.css\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token constant">D</span> <span class="token keyword">from</span> <span class="token string">\'foo/C\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'foo/C/style.css\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先通过 AST Explorer 看一下导入语句的 AST 节点结构:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABKElEQVQoz5WR204DIRCG+/7v4BPYCw83pj6EvfbKpLZxd7vAchoGmEFoozZqT38mZID5mAMzK/2kg9NoJvDSEOLLcrlYPK9W6836fVJKjGIcRymlEM0RTXJ/Mit/BBCM6o3qOqEGqay17ogazN8cF2bOxBSdFivjnQgJci7/iYh+Z65wSqk6DrCX20EpAwkzpVyD6VK46mOyr71/E9hNYHztBurtpXDAtB03gxLCJ4j5irJ3GyLUAQMkblUfpD0PM2V0QjmnQ065aTdcPg/XEOLDn7hm2kQx+nXE3qLErAvbL3P7J4/BsTmps/2N2N5uhkcp7wkeSqh2V/CpcNjB+XjPLJKZg56DaxiHy+A6mLYmYPJcalxo0T+Gp8quMOUYQSX0mfjEwD4BUxwyCyzwLfsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 27 00 15 44" title="" data-src="/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-fee1c.png" data-srcset="/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-a67b7.png 200w,\n/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-0b187.png 400w,\n/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-fee1c.png 800w,\n/static/2021-07-27-00-15-44-ccd96685cd83921902711036fdaf4e6d-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通过上面展示的结果，我们需要处理 ImportDeclaration 节点类型，将它的 specifiers 拿出来遍历处理一下。另外如果用户使用了默认导入语句，我们将抛出错误，提醒用户不能使用默认导入</p>\n<p>基本实现如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55732482363372690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 要识别的模块\nconst MODULE = \'foo\';\ntraverse(ast, {\n  // 访问导入语句\n  ImportDeclaration(path) {\n    if (path.node.source.value !== MODULE) {\n      return;\n    }\n\n    // 如果是空导入则直接删除掉\n    const specs = path.node.specifiers;\n    if (specs.length === 0) {\n      path.remove();\n      return;\n    }\n\n    // 判断是否包含了默认导入和命名空间导入\n    if (specs.some((i) => t.isImportDefaultSpecifier(i) || t.isImportNamespaceSpecifier(i))) {\n      // 抛出错误，Babel 会展示出错的代码帧\n      throw path.buildCodeFrameError(\'不能使用默认导入或命名空间导入\');\n    }\n\n    // 转换命名导入\n    const imports = [];\n    for (const spec of specs) {\n      const named = MODULE + \'/\' + spec.imported.name;\n      const local = spec.local;\n      imports.push(t.importDeclaration([t.importDefaultSpecifier(local)], t.stringLiteral(named)));\n      imports.push(t.importDeclaration([], t.stringLiteral(\\`\\${named}/style.css\\`)));\n    }\n\n    // 替换原有的导入语句\n    path.replaceWithMultiple(imports);\n  }\n});`, `55732482363372690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 要识别的模块</span>\n<span class="token keyword">const</span> <span class="token constant">MODULE</span> <span class="token operator">=</span> <span class="token string">\'foo\'</span><span class="token punctuation">;</span>\n<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 访问导入语句</span>\n  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token constant">MODULE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 如果是空导入则直接删除掉</span>\n    <span class="token keyword">const</span> specs <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>specs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 判断是否包含了默认导入和命名空间导入</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>specs<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">isImportNamespaceSpecifier</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 抛出错误，Babel 会展示出错的代码帧</span>\n      <span class="token keyword">throw</span> path<span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token string">\'不能使用默认导入或命名空间导入\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 转换命名导入</span>\n    <span class="token keyword">const</span> imports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> spec <span class="token keyword">of</span> specs<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> named <span class="token operator">=</span> <span class="token constant">MODULE</span> <span class="token operator">+</span> <span class="token string">\'/\'</span> <span class="token operator">+</span> spec<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> local <span class="token operator">=</span> spec<span class="token punctuation">.</span>local<span class="token punctuation">;</span>\n      imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>named<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>named<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/style.css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 替换原有的导入语句</span>\n    path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>imports<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>逻辑还算简单，babel-plugin-import 可比这复杂得多。</p>\n<p>接下来，我们将它封装成标准的 Babel 插件。按照规范，我们需要创建一个 babel-plugin-* 前缀的包名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31077232349269310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mkdir babel-plugin-toy-import\ncd babel-plugin-toy-import\nyarn init -y\ntouch index.js`, `31077232349269310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">mkdir</span> babel-plugin-toy-import\n<span class="token builtin class-name">cd</span> babel-plugin-toy-import\n<span class="token function">yarn</span> init -y\n<span class="token function">touch</span> index.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你也可以通过 <a href="https://github.com/babel/generator-babel-plugin/tree/master/generators/app/templates" target="_blank" rel="nofollow noreferrer noopener">generator-babel-plugin</a> 来生成项目模板</p>\n</blockquote>\n<p>在 index.js 文件中填入我们的代码。index.js 默认导出一个函数，函数结构如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41846734151239650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 接受一个 babel-core 对象\nexport default function(babel) {\n  const { types: t } = babel;\n  return {\n    pre(state) {\n      // 前置操作，可选，可以用于准备一些资源\n    },\n    visitor: {\n      // 我们的访问者代码将放在这里\n      ImportDeclaration(path, state) {\n        // ...\n      }\n    },\n    post(state) {\n      // 后置操作，可选\n    }\n  };\n}`, `41846734151239650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 接受一个 babel-core 对象</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> types<span class="token punctuation">:</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 前置操作，可选，可以用于准备一些资源</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 我们的访问者代码将放在这里</span>\n      <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 后置操作，可选</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以从访问器方法的第二个参数 state 中获取用户传入的参数。假设用户配置为:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55045443628523100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  plugins: [[\'toy-plugin\', { name: \'foo\' }]];\n}`, `55045443628523100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">\'toy-plugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'foo\'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们可以这样获取用户传入的参数:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22099829421960827000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default function(babel) {\n  const { types: t } = babel;\n  return {\n    visitor: {\n      ImportDeclaration(path, state) {\n        const mod = state.opts && state.opts.name;\n        if (mod == null) {\n          return;\n        }\n        // ...\n      }\n    }\n  };\n}`, `22099829421960827000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> types<span class="token punctuation">:</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> mod <span class="token operator">=</span> state<span class="token punctuation">.</span>opts <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>name<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>mod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后 <code class="language-text">npm publish</code></p>\n<h1 id="关于宏"><a href="#%E5%85%B3%E4%BA%8E%E5%AE%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于宏</h1>\n<p>Wiki 上面对宏的定义是：宏(Macro)，是一种批处理的称谓，它根据一系列的预定义规则转换一定的文本模式。解释器或编译器在遇到宏时会自动进行这一模式转换，这个转换过程被称为“宏展开(Macro Expansion)”。对于编译语言，宏展开在编译时发生，进行宏展开的工具常被称为宏展开器。</p>\n<p>你可以认为，宏就是用来生成代码的代码，它有能力进行一些句法解析和代码转换。宏大致可以分为两种: 文本替换和语法扩展</p>\n<h2 id="文本替换式"><a href="#%E6%96%87%E6%9C%AC%E6%9B%BF%E6%8D%A2%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文本替换式</h2>\n<p>大家或多或少有接触过宏，很多程序员第一门语言是 C/C++(包括 C 的衍生语言 Objective-C)，在 C 中就有宏的概念。使用 #define 指令定义一个宏:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4017413989201479000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#define MIN(X, Y) ((X) < (Y) ? (X) : (Y))`, `4017413989201479000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> MIN(X, Y) ((X) &lt; (Y) ? (X) : (Y))</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果我们的程序使用了这个宏，就会在编译阶段被展开，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15765375795140635000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`MIN(a + b, c + d);`, `15765375795140635000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token constant">MIN</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">,</span> c <span class="token operator">+</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>会被展开为:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32621129384281387000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a + b < c + d ? a + b : c + d;`, `32621129384281387000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">a <span class="token operator">+</span> b <span class="token operator">&lt;</span> c <span class="token operator">+</span> d <span class="token operator">?</span> a <span class="token operator">+</span> b <span class="token punctuation">:</span> c <span class="token operator">+</span> d<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>除了函数宏，C 中还有对象宏，我们通常使用它来声明 <code class="language-text">常量</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="686701032810810200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#define PI 3.1214`, `686701032810810200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="c"\n              >\n                <span class="gatsby-code-button-language">c</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> PI 3.1214</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-27-00-35-38-14da19a5381535b2103f89f4430af938-10d55.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 406px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.896551724137936%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABc0lEQVQoz12S2a6CQBBE+f8vIr5AjIkLiSgYdw1uiIILuCD7PTpKrnbCpKdnuqq6BqkoCtu2l8tlFEWHw6Hb7eq67roudcdxSPI8n06nFE3TDMOQev4Jic1iseh0OsfjkX7Lskaj0e12i+OYBKzL5cJRu93mWvEdUpIkQRBst9t+v79arebzuWEYUJEAAdZgMJhMJoqi1Ot1mCE8n8/cRJSUpikbBN/vd8AAooEc0NPpxFHyitlsxmgMyGmv1wPu8Xg8ZWdZBp5IwGIVqrJXiESMygoNKEh7ysaV3W4HpO/7HDSbTeSRQMuQ1GFgxRRN05B9vV5RJxyVMAkbG43Gfr9HHgNzjyLKmXY4HOIcngG0Xq9Z4aDyNgxJrVZLVVUm2Ww2lUpFlmXM4yoMJCikjqMk0H65TTNU1WoV/eyBqNVqFIGHxPO89BU0M105+buZD4VAiiqujsdjmhlP+C9C/BW/7/x/I54HQt4DqeX/VPb/NP8BOKdk9Da4r3YAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 27 00 35 38" title="" data-src="/static/2021-07-27-00-35-38-14da19a5381535b2103f89f4430af938-10d55.png" data-srcset="/static/2021-07-27-00-35-38-14da19a5381535b2103f89f4430af938-e6500.png 200w,\n/static/2021-07-27-00-35-38-14da19a5381535b2103f89f4430af938-9c575.png 400w,\n/static/2021-07-27-00-35-38-14da19a5381535b2103f89f4430af938-10d55.png 406w" data-sizes="(max-width: 406px) 100vw, 406px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如上图，宏本质上不是 C 语言的一部分，它由 C 预处理器提供，预处理器在编译之前对源代码进行文本替换，生成真正的 C 代码，再传递给编译器。</p>\n<blockquote>\n<p>当然 C 预处理器不仅仅会处理宏，它还包含了头文件引入、条件编译、行控制等操作</p>\n</blockquote>\n<p>除此之外，GNU m4 是一个更专业/更强大/更通用的预处理器（宏展开器）。这是一个通用的宏展开器，不仅可以用于 C，也可以用于其他语言和文本文件的处理(参考这篇有趣的文章：<a href="https://segmentfault.com/a/1190000004342956" target="_blank" rel="nofollow noreferrer noopener">使用 GNU m4 为 Markdown 添加目录支持</a>)， 关于 m4 可以看 <a href="https://segmentfault.com/a/1190000004104696" target="_blank" rel="nofollow noreferrer noopener">让这世界再多一份 GNU m4 教程</a> 系列文章</p>\n<p>文本替换式宏很容易理解、实现也简单，因为它们只是纯文本替换, 换句话说它就像 <code class="language-text">文本编辑器</code>。所以相对而言，这种形式的宏能力有限，比如它不会检验语法是否合法，使用它经常会出现问题。</p>\n<p>所以随着现代编程语言表达能力越来越强，很多语言都不再推荐使用宏/不提供宏，而是使用语言本身的机制(例如函数)来解决问题，这样更安全、更容易理解和调试。没有宏机制，现代语言可以通过提供强大的反射机制或者动态编程特性(如 Javascript 的 Proxy、Python 的装饰器)来弥补缺失宏导致的元编程短板。所以反过来推导，之所以 C 语言需要宏，正是因为 C 语言的表达能力太弱了。</p>\n<h2 id="语法扩展式"><a href="#%E8%AF%AD%E6%B3%95%E6%89%A9%E5%B1%95%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法扩展式</h2>\n<p>真正的宏起源于 Lisp，这个得益于 Lisp 语言本身的一些特性：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-27-11-29-06-79f7731a7f0112e041494e68fe30da7f-f4ef4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 705px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.680851063829785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4ElEQVQoz5WQ2w6CMBBE+///5qMaNYoGkEJasEDvFxx5UKPR6KbZtNueme2S6bew1lZVpZR6LpJfyBgjSOdcXddCXB5wiDGlFOMUYvLzAQkZ60UCPPzbtm2aJs23pGDnVbHZZuUho4x3zgcsbR3yewtCCMYYJMqyvMHKmF2xX2yWy3Ve0UvD2ux4ss47719IYOM4dl0HCRxhTuausZ2k1IxxKZX3HsX3tlHv+55zPgwDhO4Du72TUuIzWusvk8MtzEHCn1JKpj8DH4YNNpjcA05zfGJCCLA1xoDEtPI8h8oVRl8N/RoO6TQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 27 11 29 06" title="" data-src="/static/2021-07-27-11-29-06-79f7731a7f0112e041494e68fe30da7f-f4ef4.png" data-srcset="/static/2021-07-27-11-29-06-79f7731a7f0112e041494e68fe30da7f-3d360.png 200w,\n/static/2021-07-27-11-29-06-79f7731a7f0112e041494e68fe30da7f-f7ff6.png 400w,\n/static/2021-07-27-11-29-06-79f7731a7f0112e041494e68fe30da7f-f4ef4.png 705w" data-sizes="(max-width: 705px) 100vw, 705px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>它的语法非常简单，只有 S-表达式(s-expression)（特征为括号化的前缀表示法, 可以认为 S-表达式就是近似的 Lisp 的抽象语法树(AST)）</li>\n<li>数据即代码，S-表达式本身就是树形数据结构，另外 Lisp 支持数据和代码之间的转换</li>\n</ul>\n<p>由于 Lisp 这种简单的语法结构，使得数据和程序之间只有一线之隔(quote 修饰就是数据，没有 quote 就是程序)，换句话说就是程序和数据之间可以灵活地转换。这种数据即程序、程序即数据的概念，使得 Lisp 可以轻松地自定义宏。不妨来看一下 Lisp 定义宏的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29722755192084627000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`; 使用defmacro定义一个nonsense宏, 接收一个function-name参数. 宏需要返回一个quoted\n; \\` 这是quote函数的简写，表示quote，即这段‘程序’是一段‘数据’, 或者说将‘程序’转换为‘数据’. quote不会被‘求值’\n; defun 定义一个函数\n; , 这是unquote函数的简写， 表示unquote，即将‘数据’转换为‘程序’. unquote会进行求值\n; intern 将字符串转换为symbol，即标识符\n\n(defmacro nonsense (function-name)\n  \\`(defun ,(intern (concat &quot;nonsense-&quot; function-name)) (input) ; 定义一个nonsense-\\${function-name} 方法\n     (print (concat ,function-name input))))                   ; 输入\\`\\${function-name}\\${input}\\``, `29722755192084627000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="lisp"\n              >\n                <span class="gatsby-code-button-language">lisp</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="lisp"><pre style="counter-reset: linenumber NaN" class="language-lisp line-numbers"><code class="language-lisp"><span class="token comment">; 使用defmacro定义一个nonsense宏, 接收一个function-name参数. 宏需要返回一个quoted</span>\n<span class="token comment">; ` 这是quote函数的简写，表示quote，即这段‘程序’是一段‘数据’, 或者说将‘程序’转换为‘数据’. quote不会被‘求值’</span>\n<span class="token comment">; defun 定义一个函数</span>\n<span class="token comment">; , 这是unquote函数的简写， 表示unquote，即将‘数据’转换为‘程序’. unquote会进行求值</span>\n<span class="token comment">; intern 将字符串转换为symbol，即标识符</span>\n\n<span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defmacro</span> <span class="token function">nonsense</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">function-name</span></span><span class="token punctuation">)</span></span>\n  <span class="token punctuation">`(</span><span class="token car">defun</span> <span class="token punctuation">,(</span><span class="token car">intern</span> <span class="token punctuation">(</span><span class="token keyword">concat</span> <span class="token string">"nonsense-"</span> function-name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">input</span><span class="token punctuation">)</span> <span class="token comment">; 定义一个nonsense-${function-name} 方法</span>\n     <span class="token punctuation">(</span><span class="token car">print</span> <span class="token punctuation">(</span><span class="token keyword">concat</span> <span class="token splice symbol variable">,function-name</span> input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">; 输入`${function-name}${input}`</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你不理解上面程序的含义，这里有一个 Javascript 的实现</p>\n<p>注意：<code class="language-text">宏</code> 一般在编译阶段被展开, 下面代码只是为了协作你理解上述的 Lisp 代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74014347078135920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function nonsense(name) {\n  let rtn;\n  eval(\\`rtn = function nonsense\\${name}(input) {\n    console.log(\'\\${name}\', input)\n  }\\`);\n  return rtn;\n}`, `74014347078135920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">nonsense</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> rtn<span class="token punctuation">;</span>\n  <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rtn = function nonsense</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(input) {\n    console.log(\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', input)\n  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> rtn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>应用宏展开：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28259904121094090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(nonsense &quot;apple&quot;)           ; 展开宏，这里会创建一个nonsense-apple函数\n(nonsense-apple &quot; is good&quot;)  ; 调用刚刚创建的宏\n                             ; => &quot;apple is good&quot;`, `28259904121094090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="lisp"\n              >\n                <span class="gatsby-code-button-language">lisp</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="lisp"><pre style="counter-reset: linenumber NaN" class="language-lisp line-numbers"><code class="language-lisp"><span class="token punctuation">(</span><span class="token car">nonsense</span> <span class="token string">"apple"</span><span class="token punctuation">)</span>           <span class="token comment">; 展开宏，这里会创建一个nonsense-apple函数</span>\n<span class="token punctuation">(</span><span class="token car">nonsense-apple</span> <span class="token string">" is good"</span><span class="token punctuation">)</span>  <span class="token comment">; 调用刚刚创建的宏</span>\n                             <span class="token comment">; => "apple is good"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>对于 Lisp 而言，宏有点像一个函数，只不过这个函数必须返回一个 quoted 数据；当调用这个宏时，Lisp 会使用 unquote 函数将宏返回的 quoted 数据转换为程序。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-6a72b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.56756756756757%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAdklEQVQI16WOUQrDMAxDc//r7Wd0dHRsrGQhMU3s2I4TtuwMFehHPCG57wm5aSJCxDE6sm0fvXsBtNGNmRGpm6na5uvtTXuSiYlIKWhm/zIAxBhV5Si87nV5YcxNuOacU4KZI/H1kS5rfPqiqnMphNBac2du/wBlyelhO2VqDgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 29 09 27 34" title="" data-src="/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-fee1c.png" data-srcset="/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-a67b7.png 200w,\n/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-0b187.png 400w,\n/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-fee1c.png 800w,\n/static/2021-07-29-09-27-34-2cd21f4fbba35f45d8f1c1584988be88-6a72b.png 925w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通过上面的示例，你会感叹 Lisp 的宏实现竟然如此清奇，如此简单。</p>\n<p>Lisp 宏的灵活性得益于简单的语法(S-表达式可以等价于它的 AST)，对于复杂语法的语言(例如 Javascript)，要实现类似 Lisp 的宏就难得多. 因此很少有现代语言提供宏机制可能也是这个原因。</p>\n<p>尽管如此，现在很多技术难点慢慢被解决，很多现代语言也引入类 Lisp 的宏机制，如 Rust、Julia，还有 Javascript 的 Sweet.js</p>\n<h2 id="sweetjs"><a href="#sweetjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sweet.js</h2>\n<p>Sweet.js 和 Rust 师出同门，所以两个的宏语法和非常接近(初期)。不过需要注意的是: 官方认为 Sweet.js 目前仍处于实验阶段，而且 Github 最后提交时间停留在 2 年前，社区上也未见大规模的使用。所以不要在生产环境中使用它，但是不妨碍我们去学习一个现代编程语言的宏机制。</p>\n<p>我们先使用 Sweet.js 来实现上面我们通过 Lisp 实现的 nosense 宏, 对比起来更容易理解</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29672130949335320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { unwrap, fromIdentifier, fromStringLiteral } from \'@sweet-js/helpers\' for syntax;\n\nsyntax nosense = function (ctx) {\n  let name = ctx.next().value;\n  let funcName = \'nonsense\' + unwrap(name).value\n\n  return #\\`function \\${fromIdentifier(name, funcName)} () {\n    console.log(\\${fromStringLiteral(name, unwrap(name).value)} + input)\n  }\\`;\n};\n\nnosense Apple\nnosenseApple(&quot; is Good&quot;) // Apple is Good`, `29672130949335320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> unwrap<span class="token punctuation">,</span> fromIdentifier<span class="token punctuation">,</span> fromStringLiteral <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@sweet-js/helpers\'</span> <span class="token keyword">for</span> syntax<span class="token punctuation">;</span>\n\nsyntax <span class="token function-variable function">nosense</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> name <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> funcName <span class="token operator">=</span> <span class="token string">\'nonsense\'</span> <span class="token operator">+</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>value\n\n  <span class="token keyword">return</span> #<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">fromIdentifier</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> funcName<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> () {\n    console.log(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">fromStringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">unwrap</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> + input)\n  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nnosense Apple\n<span class="token function">nosenseApple</span><span class="token punctuation">(</span><span class="token string">" is Good"</span><span class="token punctuation">)</span> <span class="token comment">// Apple is Good</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先，Sweet.js 使用 syntax 关键字来定义一个宏，其语法类似于 const 或者 let。</p>\n<p>本质上一个宏就是一个函数，只不过在编译阶段被执行。这个函数接收一个 TransformerContext 对象，你也通过这个对象获取宏应用传入的语法对象（Syntax Object）数组，最终这个宏也要返回语法对象数组。</p>\n<p>什么是语法对象？语法对象是 Sweet.js 关于语法的内部表示，你可以类比上文 Lisp 的 quoted 数据。在复杂语法的语言中，没办法使用 quoted 这么简单的序列来表示语法，而使用 AST 则更复杂，开发者更难以驾驭。所以大部分宏实现会参考 Lisp 的 S-表达式，取折中方案，将传入的程序转换为 Tokens，再组装成类似 quoted 的数据结构。</p>\n<p>举个例子，Sweet.js 会将 <code class="language-text">foo,bar(&#39;baz&#39;, 1)</code> 转换成这样的数据结构:</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-beb40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.729166666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAxElEQVQY041QXQ+DIAz0//+07WV782mJDgRTQcWMgp873WaWzIddQnMtPXo0WZZl2ND3PTNP07T8jQQnz/Msy8RdpGmqtcYr3vu2bdkzBzbOmM6EgY/FVVURkXMOgrIsEY0xRVFYY6mma3Y53066U8ficQOcI8YYQwiImL+Soffx0XR1HOLe8yJv8TeappFSYrhSiiqy1mqla1vDGkzhdq0ToWGe52Mxfo5FwLkQAikEQgqkqKMCAv2BGNsePwDfff4CzU8ThJNM7ZKGmgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 29 09 30 55" title="" data-src="/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-fee1c.png" data-srcset="/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-a67b7.png 200w,\n/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-0b187.png 400w,\n/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-fee1c.png 800w,\n/static/2021-07-29-09-30-55-866abbe42473d20d098b2e6e64360a60-beb40.png 960w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上图可知，Sweet.js 会将传入的程序解析成嵌套的 Token 序列，这个结构和 Lisp 的 S-表达式非常相似。也就是, 说对于闭合的词法单元会被嵌套存储，例如上例的 <code class="language-text">(&#39;baz&#39;, 1)</code></p>\n<blockquote>\n<p>Elixir 也采用了类似的 <a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html" target="_blank" rel="nofollow noreferrer noopener">quote/unquote</a> 机制，可以结合着一起理解</p>\n</blockquote>\n<p>TransformerContext 实现了迭代器方法，所以我们通过调用它的 <code class="language-text">next()</code> 来遍历获取语法对象。最后宏必须返回一个语法对象数组，Sweet.js 使用了类似字符串模板的语法(称为语法模板)来简化开发，这个模板最终转换为语法对象数组。</p>\n<blockquote>\n<p>需要注意的是语法模板的内嵌值只能是语法对象、语法对象序列或者 TransformerContext</p>\n</blockquote>\n<p>旧版本使用了模式匹配，和 Rust 语法类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26347318504573300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`macro define {\n  rule { \\$x } => {\n    var \\$x\n  }\n\n  rule { \\$x = \\$expr } => {\n    var \\$x = \\$expr\n  }\n}\n\ndefine y;\ndefine y = 5;`, `26347318504573300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">macro define <span class="token punctuation">{</span>\n  rule <span class="token punctuation">{</span> $x <span class="token punctuation">}</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> $x\n  <span class="token punctuation">}</span>\n\n  rule <span class="token punctuation">{</span> $x <span class="token operator">=</span> $expr <span class="token punctuation">}</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> $x <span class="token operator">=</span> $expr\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\ndefine y<span class="token punctuation">;</span>\ndefine y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>说了这么多，类似 Sweet.js 语法对象的设计是现代编程语言为了贴近 Lisp 宏的一个关键技术点。我发现 Elixir、Rust 等语言也使用了类似的设计。除了数据结构的设计，现代编程语言的宏机制还包含以下特性：</p>\n<h3 id="卫生宏hygiene"><a href="#%E5%8D%AB%E7%94%9F%E5%AE%8Fhygiene" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>卫生宏(Hygiene)</h3>\n<p>卫生宏指的是在宏内生成的变量不会污染外部作用域，也就是说在宏展开时，Sweet.js 会避免宏内定义的变量和外部冲突</p>\n<p>举个例子，我们创建一个 swap 宏，交换变量的值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99414538481238690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`syntax swap = (ctx) => {\n const a = ctx.next().value\n ctx.next() // 吃掉\',\'\n const b = ctx.next().value\n return #\\`\n let temp = \\${a}\n \\${a} = \\${b}\n \\${b} = temp\n \\`;\n}\n\nswap foo,bar`, `99414538481238690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">syntax <span class="token function-variable function">swap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n <span class="token keyword">const</span> a <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value\n ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 吃掉\',\'</span>\n <span class="token keyword">const</span> b <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value\n <span class="token keyword">return</span> #<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n let temp = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = temp\n </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nswap foo<span class="token punctuation">,</span>bar</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>展开会输出为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10877426090223553000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let temp_10 = foo; // temp 变量被重命名为 temp_10\nfoo = bar;\nbar = temp_10;`, `10877426090223553000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> temp_10 <span class="token operator">=</span> foo<span class="token punctuation">;</span> <span class="token comment">// temp 变量被重命名为 temp_10</span>\nfoo <span class="token operator">=</span> bar<span class="token punctuation">;</span>\nbar <span class="token operator">=</span> temp_10<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果你想引用外部的变量也可以，不过不建议这么做，宏不应该假定其被展开的上下文:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39266363190566640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`syntax swap = (ctx) => {\n  // ...\n  return #\\`\n  temp = \\${a} // 不使用 let 声明\n  \\${a} = \\${b}\n  \\${b} = temp\n  \\`;\n}`, `39266363190566640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">syntax <span class="token function-variable function">swap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">return</span> #<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  temp = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> // 不使用 let 声明\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = temp\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="模块化"><a href="#%E6%A8%A1%E5%9D%97%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块化</h3>\n<p>Sweet.js 的宏是模块化的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98606134162361840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'lang sweet.js\';\n// 导出宏\nexport syntax class = function (ctx) {\n  // ...\n};`, `98606134162361840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'lang sweet.js\'</span><span class="token punctuation">;</span>\n<span class="token comment">// 导出宏</span>\n<span class="token keyword">export</span> syntax <span class="token function-variable function">class</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>导入</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96810655268732800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { class } from \'./es2015-macros\';\n\nclass Droid {\n  constructor(name, color) {\n    this.name = name;\n    this.color = color;\n  }\n\n  rollWithIt(it) {\n    return this.name + &quot; is rolling with &quot; + it;\n  }\n}`, `96810655268732800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">class</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./es2015-macros\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Droid</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">rollWithIt</span><span class="token punctuation">(</span><span class="token parameter">it</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">" is rolling with "</span> <span class="token operator">+</span> it<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>相对 Babel（编译器）来说，Sweet.js 的宏是模块化/显式的。Babel 需要在配置文件中配置各种插件和选项，尤其是团队项目构建有统一规范和环境时，项目构建脚本修改可能有限制。而模块化的宏是源代码的一部分，而不是构建脚本的一部分，这使得它们可以被灵活地使用、重构以及废弃。</p>\n<p>下文介绍的 babel-plugin-macros 最大的优势就在这里，通常我们希望构建环境是统一的、稳定的、开发人员应该专注于代码的开发，而不是如何去构建程序，正是因为代码多变性，才催生出了这些方案。</p>\n<p>需要注意的是宏是在编译阶段展开的，所以无法运行用户代码，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98466002889419570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let log = msg => console.log(msg); // 用户代码, 运行时被求值，所以无法被访问\n\nsyntax m = ctx => {\n  // 宏函数在编译阶段被执行\n  log(\'doing some Sweet things\'); // ERROR: 未找到变量 log\n  // ...\n};`, `98466002889419570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户代码, 运行时被求值，所以无法被访问</span>\n\nsyntax <span class="token function-variable function">m</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 宏函数在编译阶段被执行</span>\n  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'doing some Sweet things\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ERROR: 未找到变量 log</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Sweet.js 和其他语言的宏一样，有了它你可以:</p>\n<ul>\n<li>新增语法糖(和 Sweet.js 一样甜)，实现自己的语法或者某些实验性的语言特性</li>\n<li>自定义<a href="https://www.sweetjs.org/doc/tutorial#sweet-operators" target="_blank" rel="nofollow noreferrer noopener">操作符</a>，很强大</li>\n<li>消灭重复的代码，提升语言的表达能力。</li>\n</ul>\n<p>很遗憾！Sweet.js 基本死了。所以现在当个玩具玩玩尚可，切勿用于生产环境。即使没有死，Sweet.js 这种非标准的语法，和现有的 Javascript 工具链生态格格不入，开发和调试都会比较麻烦(比如 Typescript)</p>\n<p>归根到底，Sweet.js 的失败，是社区抛弃了它。Javascript 语言表达能力越来越强，版本迭代快速，加上有了 Babel 和 Typescript 这些解决方案，实在拿不出什么理由来使用 Sweet.js</p>\n<h2 id="小结"><a href="#%E5%B0%8F%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h2>\n<p>这一节扯得有点多，将宏的历史和分类讲了个遍。最后的总结是 Elixir 官方教程里面的一句话：显式好于隐式，清晰的代码优于简洁的代码(Clear code is better than concise code)</p>\n<p>能力越大、责任越大。宏强大，比正常程序要更难以驾驭，你可能需要一定的成本去学习和理解它，所以能不用宏就不用宏，宏应该是最后的法宝</p>\n<h1 id="既生-plugin-何生-macro"><a href="#%E6%97%A2%E7%94%9F-plugin-%E4%BD%95%E7%94%9F-macro" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>既生 Plugin 何生 Macro</h1>\n<p>既然 Babel 有了 Plugin 为什么又冒出了个 babel-plugin-macros?</p>\n<blockquote>\n<p>如果你尚不了解 Babel Macro，可以先读一下官方文档，另外 Creact-React-APP 已经内置</p>\n</blockquote>\n<p>这个得从 Create-React-App（CRA） 说起，CRA 将所有的项目构建逻辑都封装在 react-scripts 服务中。这样的好处是，开发者不需要再关心构建的细节，另外构建工具的升级也变得非常方便，直接升级 react-scripts 即可。</p>\n<p>如果自己维护构建脚本的话，升一次级你需要升级一大堆的依赖，如果你要维护跨项目的构建脚本，那就更蛋疼了。</p>\n<p>CRA 是强约定的，它是按照 React 社区的最佳实践给你准备的，为了保护封装带来的红利，它不推荐你去手动配置 Webpack、Babel… 所以才催生了 babel-plugin-macros，大家可以看这个 <a href="https://github.com/facebook/create-react-app/issues/2730" target="_blank" rel="nofollow noreferrer noopener">Issue: RFC - babel-macros</a></p>\n<p>所以为 Babel 寻求一个零配置的机制是 babel-plugin-macros 诞生的主要动机。</p>\n<p>这篇文章正好证实了这个动机：<a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros" target="_blank" rel="nofollow noreferrer noopener">Zero-config code transformation with babel-plugin-macros</a>，这篇文章引述了一个重要的观点：<code class="language-text">Compilers are the New Frameworks</code></p>\n<p>Babel 在现代的前端开发中扮演着一个很重要的角色，越来越多的框架或库会创建自己的 Babel 插件，它们会在编译阶段做一些优化，来提高用户体验、开发体验以及运行时的性能。比如:</p>\n<ul>\n<li>babel-plugin-lodash：将 lodash 导入转换为按需导入</li>\n<li>babel-plugin-import：实现按需导入</li>\n<li>babel-react-optimize：静态分析 React 代码，利用一定的措施优化运行效率。比如将静态的 props 或组件抽离为常量</li>\n<li>root-import：将基于根目录的导入路径重写为相对路径</li>\n<li>styled-components：典型的 CSS-in-js 方案，利用 Babel 插件来支持服务端渲染、预编译模板、样式压缩、清除死代码、提升调试体验</li>\n<li>preval：在编译时预执行代码</li>\n<li>babel-plugin-graphql-tag：预编译 GraphQL 查询</li>\n</ul>\n<p>上面列举的插件场景中，并不是所有插件都是通用的，它们要么是跟某一特定的框架绑定、要么用于处理特定的文件类型或数据，这些非通用的插件是最适合使用 macro 取代的。</p>\n<p>用 preval 举个例子，使用插件形式，你首先要配置插件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68634633126690320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;plugins&quot;: [&quot;preval&quot;]\n}`, `68634633126690320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"preval"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93637123780637180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 传递给 preval 的字符串会在编译阶段被执行\n// preval 插件会查找 preval 标识符，将字符串提取出来执行，在将执行的结果赋值给 greeting\nconst greeting = preval\\`\n  const fs = require(\'fs\')\n  module.exports = fs.readFileSync(require.resolve(\'./greeting.txt\'), \'utf8\')\n\\`;`, `93637123780637180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 传递给 preval 的字符串会在编译阶段被执行</span>\n<span class="token comment">// preval 插件会查找 preval 标识符，将字符串提取出来执行，在将执行的结果赋值给 greeting</span>\n<span class="token keyword">const</span> greeting <span class="token operator">=</span> preval<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  const fs = require(\'fs\')\n  module.exports = fs.readFileSync(require.resolve(\'./greeting.txt\'), \'utf8\')\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 Macro 方式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3511430204850896000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 首先你要显式导入\nimport preval from \'preval.macro\';\n\n// 和上面一样\nconst greeting = preval\\`\n  const fs = require(\'fs\')\n  module.exports = fs.readFileSync(require.resolve(\'./greeting.txt\'), \'utf8\')\n\\`;`, `3511430204850896000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 首先你要显式导入</span>\n<span class="token keyword">import</span> preval <span class="token keyword">from</span> <span class="token string">\'preval.macro\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 和上面一样</span>\n<span class="token keyword">const</span> greeting <span class="token operator">=</span> preval<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  const fs = require(\'fs\')\n  module.exports = fs.readFileSync(require.resolve(\'./greeting.txt\'), \'utf8\')\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这两者达到的效果是一样的，但意义却不太一样。有哪些区别？</p>\n<ol>\n<li>\n<p>很显然，Macro 不需要配置 <code class="language-text">.babelrc</code>（当然 babel-plugin-macros 这个基座需要装好），这个对于 CRA 这种不推荐配置构建脚本的工具来说很有帮助</p>\n</li>\n<li>\n<p>由隐式转换为了显式。上一节就说了显式好于隐式。你必须在源代码中通过导入语句声明你使用了 Macro；而基于插件的方式，你可能不知道 preval 这个标识符哪里来的? 如何被应用？何时被应用？而且通常你还需要和其他工具链的配合，例如 ESlint、Typescript 声明等</p>\n<p>Macro 由代码显式地引用，我们更明确它被应用的目的和时机，对源代码的侵入性最小。因为中间多了 <code class="language-text">babel-plugin-macro</code> 这一层，我们降低了对构建环境的耦合，让我们的代码更方便被迁移</p>\n</li>\n<li>\n<p>Macro 相比 Plugin 更容易被实现。因为它专注于具体的 AST 节点，见下文</p>\n</li>\n<li>\n<p>另外，当配置出错时，Macro 可以得到更好的错误提示</p>\n</li>\n</ol>\n<p>有利有弊，Babel Macro 肯定也有些缺陷，例如相对于插件来说只能显式转换，这样代码可能会比较啰嗦，不过个人觉得在某些场景利大于弊，能显式的就显式。</p>\n<p>那么 Babel Macro 也是宏？相对于 Sweet.js 这些正统的宏机制有哪些不足？</p>\n<ul>\n<li>首先 Babel Macro 必须是合法的 Javascript 语法。不支持自定义语法，也要分两面讨论，合法的 Javascript 语法不至于打破现有的工具协作链，如果允许用户毫无限制地创建新的语法，将来指不定会和标准的语法发生歧义。反过来不能自定义语法的宏，是否显得不太地道，不够强大?</li>\n<li>因为必须是合法的 Javascript 语法，Babel Macro 实现 DSL（Domain-specific languages）能力就弱化了</li>\n<li>再者，Babel Macro 和 Babel Plugin 没有本质的区别，相比 Sweet.js 提供了显式定义和应用宏的语法，Babel Macro 直接操作 AST 则要复杂得多，你还是需要了解一些编译原理，这把一般的开发者挡在了门外。</li>\n</ul>\n<blockquote>\n<p>Babel 可以实现自定义语法，只不过你需要 Fork <code class="language-text">@babel/parser</code>，对它进行改造(可以看这篇文章<a href="https://juejin.im/post/5d9be731f265da5bbc3e879b" target="_blank" rel="nofollow noreferrer noopener">用 Babel 创造自定义 JS 语法</a>)。这个有点折腾，不太推荐</p>\n</blockquote>\n<p>总之，Babel Macro 本质上和 Babel Plugin 没有什么区别，它只是在 Plugin 之上封装了一层(分层架构模式的强大)，创建了一个新的平台，让开发者可以在源代码层面显式地应用代码转换。所以，任何适合显式去转换的场景都适合用 Babel Macro 来做：</p>\n<ul>\n<li>特定框架、库的代码转换，如 styled-components</li>\n<li>动态生成代码，如 preval</li>\n<li>特定文件、语言的处理，如 <code class="language-text">graphql-tag.macro</code>、<code class="language-text">yaml.macro</code>、<code class="language-text">svgr.macro</code></li>\n</ul>\n<h1 id="如何写一个-babel-macro"><a href="#%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA-babel-macro" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何写一个 Babel Macro</h1>\n<p>所以 Babel Macro 是如何运作的呢？ babel-plugin-macros 要求开发者必须显式地导入 Macro，它会遍历匹配所有导入语句，如果导入源匹配 <code class="language-text">/[./]macro(\\.js)?$/</code> 正则，就会认为你在启用 Macro。例如下面这些导入语句都匹配正则：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58125441829251810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import foo from \'my.macro\';\nimport { bar } from \'./bar/macro\';\nimport { baz as _baz } from \'baz/macro.js\';\n// 不支持命名空间导入`, `58125441829251810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">\'my.macro\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./bar/macro\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> baz <span class="token keyword">as</span> _baz <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'baz/macro.js\'</span><span class="token punctuation">;</span>\n<span class="token comment">// 不支持命名空间导入</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当匹配到导入语句后，babel-plugin-macros 就会去导入你指定的 macro 模块或者 npm 包(Macro 即可以是本地文件，也可以是公开的 npm 包， 或者是 npm 包中的子路径)。</p>\n<p>那么 macro 文件里面要包含什么内容呢？如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52747750539042370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { createMacro } = require(\'babel-plugin-macros\');\n\nmodule.exports = createMacro(({ references, state, babel }) => {\n  // ... macro 逻辑\n});`, `52747750539042370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> createMacro <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'babel-plugin-macros\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">createMacro</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> references<span class="token punctuation">,</span> state<span class="token punctuation">,</span> babel <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ... macro 逻辑</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>macro 文件必须默认导出一个由 createMacro 创建的实例，在其回调中可以获取到一些关键对象</p>\n<ul>\n<li>babel 和普通的 Babel 插件一样，Macro 可以获取到一个 babel-core 对象</li>\n<li>state 这个我们也比较熟悉，Babel 插件的 visitor 方法的第二个参数就是它，我们可以通过它获取一些配置信息以及保存一些自定义状态</li>\n<li>references 获取 Macro 导出标识符的所有引用</li>\n</ul>\n<p>假设用户这样子使用你的 Macro</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80740787689809720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import foo, { bar, baz as Baz } from \'./my.macro\'; // 创建三个绑定\n\n// 下面开始引用这些绑定\nfoo(1);\nfoo(2);\n\nbar\\`by tagged Template\\`;\n<Baz>by JSX</Baz>;`, `80740787689809720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> foo<span class="token punctuation">,</span> <span class="token punctuation">{</span> bar<span class="token punctuation">,</span> baz <span class="token keyword">as</span> Baz <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./my.macro\'</span><span class="token punctuation">;</span> <span class="token comment">// 创建三个绑定</span>\n\n<span class="token comment">// 下面开始引用这些绑定</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nbar<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">by tagged Template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token operator">&lt;</span>Baz<span class="token operator">></span>by <span class="token constant">JSX</span><span class="token operator">&lt;</span><span class="token operator">/</span>Baz<span class="token operator">></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么你将拿到 references 结构是这样的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62106026141171425000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  // key 为\'绑定\', value 为\'引用数组\'\n  default: [NodePath/*Identifier(foo)*/, NodePath/*Identifier(foo)*/], // 默认导出，即foo\n  bar: [NodePath/*Identifier(bar)*/],\n  baz: [NodePath/*JSXIdentifier(Baz)*/], // 注意key为baz，不是Baz\n}`, `62106026141171425000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token comment">// key 为\'绑定\', value 为\'引用数组\'</span>\n  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>NodePath<span class="token comment">/*Identifier(foo)*/</span><span class="token punctuation">,</span> NodePath<span class="token comment">/*Identifier(foo)*/</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 默认导出，即foo</span>\n  bar<span class="token punctuation">:</span> <span class="token punctuation">[</span>NodePath<span class="token comment">/*Identifier(bar)*/</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  baz<span class="token punctuation">:</span> <span class="token punctuation">[</span>NodePath<span class="token comment">/*JSXIdentifier(Baz)*/</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 注意key为baz，不是Baz</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来你就可以遍历 references，对这些节点进行转换，实现你想要的宏功能</p>\n<h2 id="实战"><a href="#%E5%AE%9E%E6%88%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实战</h2>\n<p>这一次我们模范 preval 创建一个 <code class="language-text">eval.macro</code>, 利用它在编译阶段执行（eval）一些代码，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37591808365810780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import evalm from \'eval.macro\';\nconst x = evalm\\`\nfunction fib(n) {\n  const SQRT_FIVE = Math.sqrt(5);\n  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));\n}\n\nfib(20)\n\\`;\n\nconst x = 6765;`, `37591808365810780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> evalm <span class="token keyword">from</span> <span class="token string">\'eval.macro\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> x <span class="token operator">=</span> evalm<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nfunction fib(n) {\n  const SQRT_FIVE = Math.sqrt(5);\n  return Math.round(1/SQRT_FIVE * (Math.pow(0.5 + SQRT_FIVE/2, n) - Math.pow(0.5 - SQRT_FIVE/2, n)));\n}\n\nfib(20)\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">6765</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建 Macro 文件，按照上一节的介绍</p>\n<ol>\n<li>我们使用 createMacro 来创建一个 Macro 实例</li>\n<li>并从 references 中拿出所有导出标识符的引用路径</li>\n<li>接着就是对这些引用路径进行 AST 转换</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5161991397440268000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { createMacro, MacroError } = require(\'babel-plugin-macros\');\n\nfunction myMacro({ references, state, babel }) {\n  // 获取默认导出的所有引用\n  const { default: defaultImport = [] } = references;\n\n  // 遍历引用并进行求值\n  defaultImport.forEach((referencePath) => {\n    if (referencePath.parentPath.type === \'TaggedTemplateExpression\') {\n      const val = referencePath.parentPath.get(\'quasi\').evaluate().value;\n      const res = eval(val);\n      const ast = objToAst(res);\n      referencePath.parentPath.replaceWith(ast);\n    } else {\n      // 输出友好的报错信息\n      throw new MacroError(\'只支持标签模板字符串, 例如：evalm\\`1\\`\');\n    }\n  });\n}\n\nmodule.exports = createMacro(myMacro);`, `5161991397440268000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> createMacro<span class="token punctuation">,</span> MacroError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'babel-plugin-macros\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">myMacro</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> references<span class="token punctuation">,</span> state<span class="token punctuation">,</span> babel <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取默认导出的所有引用</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> defaultImport <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> references<span class="token punctuation">;</span>\n\n  <span class="token comment">// 遍历引用并进行求值</span>\n  defaultImport<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">referencePath</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'TaggedTemplateExpression\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> val <span class="token operator">=</span> referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'quasi\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">objToAst</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 输出友好的报错信息</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MacroError</span><span class="token punctuation">(</span><span class="token string">\'只支持标签模板字符串, 例如：evalm`1`\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">createMacro</span><span class="token punctuation">(</span>myMacro<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了行文简洁，本案例中只支持 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings" target="_blank" rel="nofollow noreferrer noopener">标签模板字符串</a> 形式调用，但是标签模板字符串中可能包含内插的字符串，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94557413534428170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hello\\`\nhello world \\${foo} + \\${bar + baz}\n\\`;`, `94557413534428170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">hello<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nhello world </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>foo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> + </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bar <span class="token operator">+</span> baz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>其 AST 结构如下</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-07-29-10-02-19-0e3f724d0a2ab5c4cc0308f86065c358-59d2e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 400px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 101.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB70lEQVQ4y52TTY/TMBCG+/+PcAMhuuJAtfAPOCDaReLAhVXa7qYtTeLE8Xg8M052u4gbk/SLRduCeDOxHcuPZzzjDJgbdgllz23+Ks0uZ9n7afYOYcT+rWDXMo4kjO5ptOHLDb9p+SvLRoRFZMDcNjG7pws2zxp4Wblh5V4/yPBnHP6Qoz3wcMMXG37RypcjLNIIlQwf7mTC/JnCFYdJwE8hjCONWx63MtnbVSsfG7kVuTvAIhhcltg8WRVFslrf5nVaiRqEhjmKtI+tkb00bJYYI7Ezi9lqsSrWS2N0shWOCnYe/rCjBvuBzjbWY57NjYO0dnXA2NNndICV1icIuSgUmGTn+TzMXSS6DABvSn9j/LTAudFxqDwF6sTM52CVLqlcVebz3Npp4WeFX1TBeazqmk7CR0UOAEXiyzlCaZGwd8m9/n5m8BbMDF2+tJSWqG0JoXYO8OnkDQ6b9k6Ofddti3PK767OuoIoeBsJdH/10UZpYpfF/jOeqtkWjuzBZNfLdVo4LFwwQHpm1Tbb2p6A95emDvQtp6nBmcHrzC9scABq4L2258LWwC2CMkpqkZPcr+oOrv8RdtgV9rsN65qWVcgdeUQlEVHfk6VSujuV/gwxNn2qdgn7TU/DehG25KFKj43PXZLKWo0N/ku/ADx6SJPvkxaWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 07 29 10 02 19" title="" data-src="/static/2021-07-29-10-02-19-0e3f724d0a2ab5c4cc0308f86065c358-59d2e.png" data-srcset="/static/2021-07-29-10-02-19-0e3f724d0a2ab5c4cc0308f86065c358-01f55.png 200w,\n/static/2021-07-29-10-02-19-0e3f724d0a2ab5c4cc0308f86065c358-59d2e.png 400w" data-sizes="(max-width: 400px) 100vw, 400px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们需要将 TaggedTemplateExpression 节点转换为字符串。手动去拼接会很麻烦，好在每个 AST 节点的 Path 对象都有一个 evaluate 方法，这个方法可以对节点进行静态求值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90208744861191880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`t.evaluate(parse(\'5 + 5\')); // { confident: true, value: 10 }\nt.evaluate(parse(\'!true\')); // { confident: true, value: false }\n// ❌两个变量相加无法求值，因为变量值在运行时才存在，这里confident为false：\nt.evaluate(parse(\'foo + foo\')); // { confident: false, value: undefined }`, `90208744861191880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">t<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'5 + 5\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { confident: true, value: 10 }</span>\nt<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'!true\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { confident: true, value: false }</span>\n<span class="token comment">// ❌两个变量相加无法求值，因为变量值在运行时才存在，这里confident为false：</span>\nt<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'foo + foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { confident: false, value: undefined }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此这样子的标签模板字符串是无法求值的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34299771619240116000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`evalm\\`1 + \\${foo}\\`; // 包含变量\nevalm\\`1 + \\${bar(1)}\\`; // 包含函数调`, `34299771619240116000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">evalm<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1 + </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>foo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 包含变量</span>\nevalm<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1 + </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 包含函数调</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个和 Typescript 的 enum，还有一些编译语言的常量是一样的，它们在编译阶段被求值，只有一些原始值以及一些原始值的表达式才支持在编译阶段被求值</p>\n<p>So，上面的代码还不够健壮，我们再优化一下，在求值失败时给用户更好的提示:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46115815648462455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`defaultImport.forEach((referencePath) => {\n  if (referencePath.parentPath.type === \'TaggedTemplateExpression\') {\n    const evaluated = referencePath.parentPath.get(\'quasi\').evaluate();\n    // 转换标签模板字符串失败\n    if (!evaluated.confident) {\n      throw new MacroError(\'标签模板字符串内插值只支持原始值和原始值表达式\');\n    }\n\n    try {\n      const res = eval(evaluated.value);\n      const ast = objToAst(res);\n      // 替换掉调用节点\n      referencePath.parentPath.replaceWith(ast);\n    } catch (err) {\n      throw new MacroError(\\`求值失败: \\${err.message}\\`);\n    }\n  } else {\n    throw new MacroError(\'只支持标签模板字符串, 例如：evalm\\`1 + 1\\`\');\n  }\n});`, `46115815648462455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">defaultImport<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">referencePath</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">\'TaggedTemplateExpression\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> evaluated <span class="token operator">=</span> referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'quasi\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 转换标签模板字符串失败</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>evaluated<span class="token punctuation">.</span>confident<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MacroError</span><span class="token punctuation">(</span><span class="token string">\'标签模板字符串内插值只支持原始值和原始值表达式\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>evaluated<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">objToAst</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 替换掉调用节点</span>\n      referencePath<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MacroError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">求值失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MacroError</span><span class="token punctuation">(</span><span class="token string">\'只支持标签模板字符串, 例如：evalm`1 + 1`\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来将执行后的值转换为 AST，然后替换掉 TaggedTemplateExpression</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4160618072929512000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function objToAst(res) {\n  let str = JSON.stringify(res);\n  if (str == null) {\n    str = \'undefined\';\n  }\n  const variableDeclarationNode = babel.template(\\`var x = \\${str}\\`, {})();\n  // 取出初始化表达式的 AST\n  return variableDeclarationNode.declarations[0].init;\n}`, `4160618072929512000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">objToAst</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    str <span class="token operator">=</span> <span class="token string">\'undefined\'</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> variableDeclarationNode <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var x = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 取出初始化表达式的 AST</span>\n  <span class="token keyword">return</span> variableDeclarationNode<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>init<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里 <code class="language-text">@babel/template</code> 就派上用场了，它可以将字符串代码解析成 AST，当然直接使用 parse 方法解析也是可以的。</p>\n<p>Babel Macro 本质上还是 Babel 插件，只不过它是模块化的，你要使用它必须显式地导入。和正统宏相比，Babel Macro 直接操作 AST，需要你掌握编译原理，正统宏可以实现的东西，Babel Macro 也可以实现(例如卫生宏)。虽然相比 Babel 插件略有简化，还是比较啰嗦。另外 Babel Macro 不能创建新的语法，这使得它可以和现有的工具生态保持兼容。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/深入理解 Babel/index.md absPath of file >>> MarkdownRemark",timeToRead:21,frontmatter:{date:"2021-07-26 23:10:50",path:"/deep-learn-babel/",tags:"前端, Babel, 前端构建工具",title:"深入理解 Babel",draft:null}},{excerpt:"概括 Webpack 以其使用简单著称，在使用它的过程中，使用者只需把它当作一个黑盒，需要关心的只有它暴露出来的配置。 本节将带你走进这个黑盒，看看 Webpack 是如何运行的。 基本概念 在了解 Webpack 原理前，需要掌握以下几个核心概念，以方便后面的理解： Entry：入口，Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入。 Module：模块，在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry…",html:'<h1 id="概括"><a href="#%E6%A6%82%E6%8B%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概括</h1>\n<p>Webpack 以其使用简单著称，在使用它的过程中，使用者只需把它当作一个黑盒，需要关心的只有它暴露出来的配置。 本节将带你走进这个黑盒，看看 Webpack 是如何运行的。</p>\n<h2 id="基本概念"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p>在了解 Webpack 原理前，需要掌握以下几个核心概念，以方便后面的理解：</p>\n<ul>\n<li>Entry：入口，Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入。</li>\n<li>Module：模块，在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry 开始递归找出所有依赖的模块。</li>\n<li>Chunk：代码块，一个 Chunk 由多个模块组合而成，用于代码合并与分割。</li>\n<li>Loader：模块转换器，用于把模块原内容按照需求转换成新内容。</li>\n<li>Plugin：扩展插件，在 Webpack 构建流程中的特定时机会广播出对应的事件，插件可以监听这些事件的发生，在特定时机做对应的事情。</li>\n</ul>\n<h2 id="流程概括"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概括</h2>\n<p>Webpack 的运行流程是一个串行的过程，从启动到结束会依次执行以下流程：</p>\n<ol>\n<li>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数；</li>\n<li>开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</li>\n<li>确定入口：根据配置中的 entry 找出所有的入口文件；</li>\n<li>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；</li>\n<li>完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</li>\n<li>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</li>\n<li>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li>\n</ol>\n<p>在以上过程中，Webpack 会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用 Webpack 提供的 API 改变 Webpack 的运行结果。</p>\n<h2 id="流程细节"><a href="#%E6%B5%81%E7%A8%8B%E7%BB%86%E8%8A%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程细节</h2>\n<p>Webpack 的构建流程可以分为以下三大阶段：</p>\n<ol>\n<li>初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler。</li>\n<li>编译：从 Entry 发出，针对每个 Module 串行调用对应的 Loader 去翻译文件内容，再找到该 Module 依赖的 Module，递归地进行编译处理。</li>\n<li>输出：对编译后的 Module 组合成 Chunk，把 Chunk 转换成文件，输出到文件系统。</li>\n</ol>\n<p>如果只执行一次构建，以上阶段将会按照顺序各执行一次。但在开启监听模式下，流程将变为如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 339px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 122.4188790560472%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsSAAALEgHS3X78AAACOklEQVQ4y6VUSYoiQRR1th1KRbfiGRS8ge60wQnbe+gRRMQZhxMI7twozrpRQXCniPOEE+KAwwn6EdlVZVeZVQ39Fp8f8eNlZP73fjIYf4PJZCJqtVqHw2GxWKxWq91u/0Vgs9mwxCZylUrF+AwWi4Xo9/uPx+NkMpnNZq1Wq9lsIvZ6veVyic3D4WA2m2nJPp9vv9+PRqPxeJzJZJLJZCqVqtfri8ViOByi9BXZ6XTiaC6XKxaLlUqlVqtVq9VSqYRlPp9HSafTMejA5XIFAsEPAuQikejl5QW5gEAoFLLZ7PcmCQlQ5vF4fD4fBJQRkWNfLpcjp71HKpVyOBwkiKDxCMCkbkMVCb6I/QpKlD9kvBiDHhyC5zVcQpGZBEggaSgUcrvdHo/H6/XGYrFIJOIhwGYwGNRoNE/IVLfBvF6vEGa323U6HeiEPkPzzWYDqS+XC9xCSw4EAufzeTqdrtfrbrebTqfhE5DBRDydTvAZ7WvDm/F4HFbBU/CSiUQiGo0GCLCJEvz7kUwHFsE3DXs8/aYKckqw51J9e/M/SfU4mKxXIIdJqAOPm7TddrlcaC9mgBoGxHK5XCIoFAqNRkOv19OSYQwo3O/35/M5ngKTZLNZzDOGeTAYoGQymWjJ4XD4fr+vViucA7/dbkNtLLfbLeLtdoMFn3wz9TFqtRrjbjQafxLgvwNXGAkMBgOuVSqV72SxWPxFt9/M81wJmUyGuRW9QiKRSB+gUCgwec91/uCKz6C11//gNyZCGYbNevPtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 11 17 11 55 09" title="" data-src="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png" data-srcset="/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-bb04d.png 200w,\n/static/2020-11-17-11-55-09-c7f1268f7c8c09615cbcff76cf43b386-aa752.png 339w" data-sizes="(max-width: 339px) 100vw, 339px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在每个大阶段中又会发生很多事件，Webpack 会把这些事件广播出来供给 Plugin 使用，下面来一一介绍。</p>\n<h2 id="初始化阶段"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">初始化参数</td>\n<td align="center">从配置文件和 Shell 语句中读取与合并参数，得出最终的参数。 这个过程中还会执行配置文件中的插件实例化语句 new Plugin()。</td>\n</tr>\n<tr>\n<td align="center">实例化 Compiler</td>\n<td align="center">用上一步得到的参数初始化 Compiler 实例，Compiler 负责文件监听和启动编译。Compiler 实例中包含了完整的 Webpack 配置，全局只有一个 Compiler 实例。</td>\n</tr>\n<tr>\n<td align="center">加载插件</td>\n<td align="center">依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点。同时给插件传入 compiler 实例的引用，以方便插件通过 compiler 调用 Webpack 提供的 API。</td>\n</tr>\n<tr>\n<td align="center">environment</td>\n<td align="center">开始应用 Node.js 风格的文件系统到 compiler 对象，以方便后续的文件寻找和读取。</td>\n</tr>\n<tr>\n<td align="center">entry-option</td>\n<td align="center">读取配置的 Entrys，为每个 Entry 实例化一个对应的 EntryPlugin，为后面该 Entry 的递归解析工作做准备。</td>\n</tr>\n<tr>\n<td align="center">after-plugins</td>\n<td align="center">调用完所有内置的和配置的插件的 apply 方法。</td>\n</tr>\n<tr>\n<td align="center">after-resolvers</td>\n<td align="center">根据配置初始化完 resolver，resolver 负责在文件系统中寻找指定路径的文件。</td>\n</tr>\n</tbody>\n</table>\n<h2 id="编译阶段"><a href="#%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">run</td>\n<td align="center">启动一次新的编译。</td>\n</tr>\n<tr>\n<td align="center">watch-run</td>\n<td align="center">和 run 类似，区别在于它是在监听模式下启动的编译，在这个事件中可以获取到是哪些文件发生了变化导致重新启动一次新的编译。</td>\n</tr>\n<tr>\n<td align="center">compile</td>\n<td align="center">该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上 compiler 对象。</td>\n</tr>\n<tr>\n<td align="center">compilation</td>\n<td align="center">当 Webpack 以开发模式运行时，每当检测到文件变化，一次新的 Compilation 将被创建。一个 Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。Compilation 对象也提供了很多事件回调供插件做扩展。</td>\n</tr>\n<tr>\n<td align="center">make</td>\n<td align="center">一个新的 Compilation 创建完毕，即将从 Entry 开始读取文件，根据文件类型和配置的 Loader 对文件进行编译，编译完后再找出该文件依赖的文件，递归的编译和解析。</td>\n</tr>\n<tr>\n<td align="center">after-compile</td>\n<td align="center">一次 Compilation 执行完成。</td>\n</tr>\n<tr>\n<td align="center">invalid</td>\n<td align="center">当遇到文件不存在、文件编译错误等异常时会触发该事件，该事件不会导致 Webpack 退出。</td>\n</tr>\n</tbody>\n</table>\n<p>在编译阶段中，最重要的要数 compilation 事件了，因为在 compilation 阶段调用了 Loader 完成了每个模块的转换操作，在 compilation 阶段又包括很多小的事件，它们分别是：</p>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">build-module</td>\n<td align="center">使用对应的 Loader 去转换一个模块。</td>\n</tr>\n<tr>\n<td align="center">normal-module-loader</td>\n<td align="center">在用 Loader 对一个模块转换完后，使用 acorn 解析转换后的内容，输出对应的抽象语法树（AST），以方便 Webpack 后面对代码的分析。</td>\n</tr>\n<tr>\n<td align="center">program</td>\n<td align="center">从配置的入口模块开始，分析其 AST，当遇到 require 等导入其它模块语句时，便将其加入到依赖的模块列表，同时对新找出的依赖模块递归分析，最终搞清所有模块的依赖关系。</td>\n</tr>\n<tr>\n<td align="center">seal</td>\n<td align="center">所有模块及其依赖的模块都通过 Loader 转换完成后，根据依赖关系开始生成 Chunk。</td>\n</tr>\n</tbody>\n</table>\n<h2 id="输出阶段"><a href="#%E8%BE%93%E5%87%BA%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出阶段</h2>\n<table>\n<thead>\n<tr>\n<th align="center">事件名</th>\n<th align="center">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">should-emit</td>\n<td align="center">所有需要输出的文件已经生成好，询问插件哪些文件需要输出，哪些不需要。</td>\n</tr>\n<tr>\n<td align="center">emit</td>\n<td align="center">确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容。</td>\n</tr>\n<tr>\n<td align="center">after-emit</td>\n<td align="center">文件输出完毕。</td>\n</tr>\n<tr>\n<td align="center">done</td>\n<td align="center">成功完成一次完成的编译和输出流程。</td>\n</tr>\n<tr>\n<td align="center">failed</td>\n<td align="center">如果在编译和输出流程中遇到异常导致 Webpack 退出时，就会直接跳转到本步骤，插件可以在本事件中获取到具体的错误原因。</td>\n</tr>\n</tbody>\n</table>\n<p>在输出阶段已经得到了各个模块经过转换后的结果和其依赖关系，并且把相关模块组合在一起形成一个个 Chunk。 在输出阶段会根据 Chunk 的类型，使用对应的模版生成最终要要输出的文件内容。</p>\n<p>至于如何把 Chunk 输出为具体的文件，详情可以阅读 5-2 输出文件分析。</p>\n<h1 id="输出文件分析"><a href="#%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出文件分析</h1>\n<p>虽然在前面的章节中你学会了如何使用 Webpack ，也大致知道其工作原理，可是你想过 Webpack 输出的 bundle.js 是什么样子的吗？ 为什么原来一个个的模块文件被合并成了一个单独的文件？为什么 bundle.js 能直接运行在浏览器中？ 本节将解释清楚以上问题。</p>\n<p>最简单的项目构建出的 bundle.js 文件内容，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80440023046490800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// webpackBootstrap 启动函数\n// modules 即为存放所有模块的数组，数组中的每一个元素都是一个函数\n(function(modules) {\n  // 安装过的模块都存放在这里面\n  // 作用是把已经加载过的模块缓存在内存中，提升性能\n  var installedModules = {};\n\n  // 去数组中加载一个模块，moduleId 为要加载模块在数组中的 index\n  // 作用和 Node.js 中 require 语句相似\n  function __webpack_require__(moduleId) {\n    // 如果需要加载的模块已经被加载过，就直接从内存缓存中返回\n    if (installedModules[moduleId]) {\n      return installedModules[moduleId].exports;\n    }\n\n    // 如果缓存中不存在需要加载的模块，就新建一个模块，并把它存在缓存中\n    var module = (installedModules[moduleId] = {\n      // 模块在数组中的 index\n      i: moduleId,\n      // 该模块是否已经加载完毕\n      l: false,\n      // 该模块的导出值\n      exports: {}\n    });\n\n    // 从 modules 中获取 index 为 moduleId 的模块对应的函数\n    // 再调用这个函数，同时把函数需要的参数传入\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    // 把这个模块标记为已加载\n    module.l = true;\n    // 返回这个模块的导出值\n    return module.exports;\n  }\n\n  // Webpack 配置中的 publicPath，用于加载被分割出去的异步代码\n  __webpack_require__.p = \'\';\n\n  // 使用 __webpack_require__ 去加载 index 为 0 的模块，并且返回该模块导出的内容\n  // index 为 0 的模块就是 main.js 对应的文件，也就是执行入口模块\n  // __webpack_require__.s 的含义是启动模块对应的 index\n  return __webpack_require__((__webpack_require__.s = 0));\n})(\n  // 所有的模块都存放在了一个数组里，根据每个模块在数组的 index 来区分和定位模块\n  [\n    /* 0 */\n    function(module, exports, __webpack_require__) {\n      // 通过 __webpack_require__ 规范导入 show 函数，show.js 对应的模块 index 为 1\n      const show = __webpack_require__(1);\n      // 执行 show 函数\n      show(\'Webpack\');\n    },\n    /* 1 */\n    function(module, exports) {\n      function show(content) {\n        window.document.getElementById(\'app\').innerText = \'Hello,\' + content;\n      }\n      // 通过 CommonJS 规范导出 show 函数\n      module.exports = show;\n    }\n  ]\n);`, `80440023046490800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// webpackBootstrap 启动函数</span>\n<span class="token comment">// modules 即为存放所有模块的数组，数组中的每一个元素都是一个函数</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 安装过的模块都存放在这里面</span>\n  <span class="token comment">// 作用是把已经加载过的模块缓存在内存中，提升性能</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 去数组中加载一个模块，moduleId 为要加载模块在数组中的 index</span>\n  <span class="token comment">// 作用和 Node.js 中 require 语句相似</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果需要加载的模块已经被加载过，就直接从内存缓存中返回</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 如果缓存中不存在需要加载的模块，就新建一个模块，并把它存在缓存中</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 模块在数组中的 index</span>\n      i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n      <span class="token comment">// 该模块是否已经加载完毕</span>\n      l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token comment">// 该模块的导出值</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 从 modules 中获取 index 为 moduleId 的模块对应的函数</span>\n    <span class="token comment">// 再调用这个函数，同时把函数需要的参数传入</span>\n    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 把这个模块标记为已加载</span>\n    module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token comment">// 返回这个模块的导出值</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Webpack 配置中的 publicPath，用于加载被分割出去的异步代码</span>\n  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 __webpack_require__ 去加载 index 为 0 的模块，并且返回该模块导出的内容</span>\n  <span class="token comment">// index 为 0 的模块就是 main.js 对应的文件，也就是执行入口模块</span>\n  <span class="token comment">// __webpack_require__.s 的含义是启动模块对应的 index</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n  <span class="token comment">// 所有的模块都存放在了一个数组里，根据每个模块在数组的 index 来区分和定位模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">/* 0 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 通过 __webpack_require__ 规范导入 show 函数，show.js 对应的模块 index 为 1</span>\n      <span class="token keyword">const</span> show <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 执行 show 函数</span>\n      <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">/* 1 */</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">\'Hello,\'</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 通过 CommonJS 规范导出 show 函数</span>\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上看上去复杂的代码其实是一个立即执行函数，可以简写为如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30883607182508980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  // 模拟 require 语句\n  function __webpack_require__() {}\n\n  // 执行存放所有模块数组中的第0个模块\n  __webpack_require__(0);\n})([\n  /*存放所有模块的数组*/\n]);`, `30883607182508980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 模拟 require 语句</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token comment">// 执行存放所有模块数组中的第0个模块</span>\n  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token comment">/*存放所有模块的数组*/</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js 能直接运行在浏览器中的原因在于输出的文件中通过 <code class="language-text">__webpack_require__</code> 函数定义了一个可以在浏览器中执行的加载函数来模拟 Node.js 中的 require 语句。</p>\n<p>原来一个个独立的模块文件被合并到了一个单独的 bundle.js 的原因在于浏览器不能像 Node.js 那样快速地去本地加载一个个模块文件，而必须通过网络请求去加载还未得到的文件。 如果模块数量很多，加载时间会很长，因此把所有模块都存放在了数组中，执行一次网络加载。</p>\n<p>如果仔细分析 <code class="language-text">__webpack_require__</code> 函数的实现，你还有发现 Webpack 做了缓存优化： 执行加载过的模块不会再执行第二次，执行结果会缓存在内存中，当某个模块第二次被访问时会直接去内存中读取被缓存的返回值。</p>\n<h2 id="分割代码时的输出"><a href="#%E5%88%86%E5%89%B2%E4%BB%A3%E7%A0%81%E6%97%B6%E7%9A%84%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分割代码时的输出</h2>\n<p>在采用了 4-12 按需加载 中介绍过的优化方法时，Webpack 的输出文件会发生变化。</p>\n<p>例如把源码中的 main.js 修改为如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96951263661131320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 异步加载 show.js\nimport(\'./show\').then((show) => {\n  // 执行 show 函数\n  show(\'Webpack\');\n});`, `96951263661131320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 异步加载 show.js</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./show\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 执行 show 函数</span>\n  <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重新构建后会输出两个文件，分别是执行入口文件 bundle.js 和 异步加载文件 0.bundle.js。</p>\n<p>其中 0.bundle.js 内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26636962361618653000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 加载在本文件(0.bundle.js)中包含的模块\nwebpackJsonp(\n  // 在其它文件中存放着的模块的 ID\n  [0],\n  // 本文件所包含的模块\n  [\n    // show.js 所对应的模块\n    function(module, exports) {\n      function show(content) {\n        window.document.getElementById(\'app\').innerText = \'Hello,\' + content;\n      }\n\n      module.exports = show;\n    }\n  ]\n);`, `26636962361618653000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 加载在本文件(0.bundle.js)中包含的模块</span>\n<span class="token function">webpackJsonp</span><span class="token punctuation">(</span>\n  <span class="token comment">// 在其它文件中存放着的模块的 ID</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token comment">// 本文件所包含的模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">// show.js 所对应的模块</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">\'Hello,\'</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bundle.js 内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41908956709708956000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {\n  /***\n   * webpackJsonp 用于从异步加载的文件中安装模块。\n   * 把 webpackJsonp 挂载到全局是为了方便在其它文件中调用。\n   *\n   * @param chunkIds 异步加载的文件中存放的需要安装的模块对应的 Chunk ID\n   * @param moreModules 异步加载的文件中存放的需要安装的模块列表\n   * @param executeModules 在异步加载的文件中存放的需要安装的模块都安装成功后，需要执行的模块对应的 index\n   */\n  window[\'webpackJsonp\'] = function webpackJsonpCallback(chunkIds, moreModules, executeModules) {\n    // 把 moreModules 添加到 modules 对象中\n    // 把所有 chunkIds 对应的模块都标记成已经加载成功\n    var moduleId,\n      chunkId,\n      i = 0,\n      resolves = [],\n      result;\n    for (; i < chunkIds.length; i++) {\n      chunkId = chunkIds[i];\n      if (installedChunks[chunkId]) {\n        resolves.push(installedChunks[chunkId][0]);\n      }\n      installedChunks[chunkId] = 0;\n    }\n    for (moduleId in moreModules) {\n      if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n        modules[moduleId] = moreModules[moduleId];\n      }\n    }\n    while (resolves.length) {\n      resolves.shift()();\n    }\n  };\n\n  // 缓存已经安装的模块\n  var installedModules = {};\n\n  // 存储每个 Chunk 的加载状态；\n  // 键为 Chunk 的 ID，值为0代表已经加载成功\n  var installedChunks = {\n    1: 0\n  };\n\n  // 模拟 require 语句，和上面介绍的一致\n  function __webpack_require__(moduleId) {\n    // ... 省略和上面一样的内容\n  }\n\n  /**\n   * 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件\n   * @param chunkId 需要异步加载的 Chunk 对应的 ID\n   * @returns {Promise}\n   */\n  __webpack_require__.e = function requireEnsure(chunkId) {\n    // 从上面定义的 installedChunks 中获取 chunkId 对应的 Chunk 的加载状态\n    var installedChunkData = installedChunks[chunkId];\n    // 如果加载状态为0表示该 Chunk 已经加载成功了，直接返回 resolve Promise\n    if (installedChunkData === 0) {\n      return new Promise(function(resolve) {\n        resolve();\n      });\n    }\n\n    // installedChunkData 不为空且不为0表示该 Chunk 正在网络加载中\n    if (installedChunkData) {\n      // 返回存放在 installedChunkData 数组中的 Promise 对象\n      return installedChunkData[2];\n    }\n\n    // installedChunkData 为空，表示该 Chunk 还没有加载过，去加载该 Chunk 对应的文件\n    var promise = new Promise(function(resolve, reject) {\n      installedChunkData = installedChunks[chunkId] = [resolve, reject];\n    });\n    installedChunkData[2] = promise;\n\n    // 通过 DOM 操作，往 HTML head 中插入一个 script 标签去异步加载 Chunk 对应的 JavaScript 文件\n    var head = document.getElementsByTagName(\'head\')[0];\n    var script = document.createElement(\'script\');\n    script.type = \'text/javascript\';\n    script.charset = \'utf-8\';\n    script.async = true;\n    script.timeout = 120000;\n\n    // 文件的路径为配置的 publicPath、chunkId 拼接而成\n    script.src = __webpack_require__.p + \'\' + chunkId + \'.bundle.js\';\n\n    // 设置异步加载的最长超时时间\n    var timeout = setTimeout(onScriptComplete, 120000);\n    script.onerror = script.onload = onScriptComplete;\n\n    // 在 script 加载和执行完成时回调\n    function onScriptComplete() {\n      // 防止内存泄露\n      script.onerror = script.onload = null;\n      clearTimeout(timeout);\n\n      // 去检查 chunkId 对应的 Chunk 是否安装成功，安装成功时才会存在于 installedChunks 中\n      var chunk = installedChunks[chunkId];\n      if (chunk !== 0) {\n        if (chunk) {\n          chunk[1](new Error(\'Loading chunk \' + chunkId + \' failed.\'));\n        }\n        installedChunks[chunkId] = undefined;\n      }\n    }\n    head.appendChild(script);\n\n    return promise;\n  };\n\n  // 加载并执行入口模块，和上面介绍的一致\n  return __webpack_require__((__webpack_require__.s = 0));\n})(\n  // 存放所有没有经过异步加载的，随着执行入口文件加载的模块\n  [\n    // main.js 对应的模块\n    function(module, exports, __webpack_require__) {\n      // 通过 __webpack_require__.e 去异步加载 show.js 对应的 Chunk\n      __webpack_require__\n        .e(0)\n        .then(__webpack_require__.bind(null, 1))\n        .then((show) => {\n          // 执行 show 函数\n          show(\'Webpack\');\n        });\n    }\n  ]\n);`, `41908956709708956000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">/***\n   * webpackJsonp 用于从异步加载的文件中安装模块。\n   * 把 webpackJsonp 挂载到全局是为了方便在其它文件中调用。\n   *\n   * @param chunkIds 异步加载的文件中存放的需要安装的模块对应的 Chunk ID\n   * @param moreModules 异步加载的文件中存放的需要安装的模块列表\n   * @param executeModules 在异步加载的文件中存放的需要安装的模块都安装成功后，需要执行的模块对应的 index\n   */</span>\n  window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">chunkIds<span class="token punctuation">,</span> moreModules<span class="token punctuation">,</span> executeModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 把 moreModules 添加到 modules 对象中</span>\n    <span class="token comment">// 把所有 chunkIds 对应的模块都标记成已经加载成功</span>\n    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>\n      chunkId<span class="token punctuation">,</span>\n      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      result<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缓存已经安装的模块</span>\n  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 存储每个 Chunk 的加载状态；</span>\n  <span class="token comment">// 键为 Chunk 的 ID，值为0代表已经加载成功</span>\n  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 模拟 require 语句，和上面介绍的一致</span>\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ... 省略和上面一样的内容</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">/**\n   * 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件\n   * @param chunkId 需要异步加载的 Chunk 对应的 ID\n   * @returns {Promise}\n   */</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 从上面定义的 installedChunks 中获取 chunkId 对应的 Chunk 的加载状态</span>\n    <span class="token keyword">var</span> installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果加载状态为0表示该 Chunk 已经加载成功了，直接返回 resolve Promise</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// installedChunkData 不为空且不为0表示该 Chunk 正在网络加载中</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 返回存放在 installedChunkData 数组中的 Promise 对象</span>\n      <span class="token keyword">return</span> installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// installedChunkData 为空，表示该 Chunk 还没有加载过，去加载该 Chunk 对应的文件</span>\n    <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">;</span>\n\n    <span class="token comment">// 通过 DOM 操作，往 HTML head 中插入一个 script 标签去异步加载 Chunk 对应的 JavaScript 文件</span>\n    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">\'text/javascript\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">120000</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 文件的路径为配置的 publicPath、chunkId 拼接而成</span>\n    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">\'\'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\'.bundle.js\'</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 设置异步加载的最长超时时间</span>\n    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onScriptComplete<span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> onScriptComplete<span class="token punctuation">;</span>\n\n    <span class="token comment">// 在 script 加载和执行完成时回调</span>\n    <span class="token keyword">function</span> <span class="token function">onScriptComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 防止内存泄露</span>\n      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 去检查 chunkId 对应的 Chunk 是否安装成功，安装成功时才会存在于 installedChunks 中</span>\n      <span class="token keyword">var</span> chunk <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Loading chunk \'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">\' failed.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 加载并执行入口模块，和上面介绍的一致</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n  <span class="token comment">// 存放所有没有经过异步加载的，随着执行入口文件加载的模块</span>\n  <span class="token punctuation">[</span>\n    <span class="token comment">// main.js 对应的模块</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 通过 __webpack_require__.e 去异步加载 show.js 对应的 Chunk</span>\n      __webpack_require__\n        <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token comment">// 执行 show 函数</span>\n          <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">\'Webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 bundle.js 和上面所讲的 bundle.js 非常相似，区别在于：</p>\n<ul>\n<li>多了一个 <code class="language-text">__webpack_require__.e</code> 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件;</li>\n<li>多了一个 webpackJsonp 函数用于从异步加载的文件中安装模块。</li>\n</ul>\n<p>在使用了 CommonsChunkPlugin 去提取公共代码时输出的文件和使用了异步加载时输出的文件是一样的，都会有 <code class="language-text">__webpack_require__.e</code> 和 webpackJsonp。 原因在于提取公共代码和异步加载本质上都是代码分割。</p>\n<h1 id="编写-loader"><a href="#%E7%BC%96%E5%86%99-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写 Loader</h1>\n<p>Loader 就像是一个翻译员，能把源文件经过转化后输出新的结果，并且一个文件还可以链式的经过多个翻译员翻译。</p>\n<p>以处理 SCSS 文件为例：</p>\n<ol>\n<li>SCSS 源代码会先交给 sass-loader 把 SCSS 转换成 CSS；</li>\n<li>把 sass-loader 输出的 CSS 交给 css-loader 处理，找出 CSS 中依赖的资源、压缩 CSS 等；</li>\n<li>把 css-loader 输出的 CSS 交给 style-loader 处理，转换成通过脚本加载的 JavaScript 代码；</li>\n</ol>\n<p>可以看出以上的处理过程需要有顺序的链式执行，先 sass-loader 再 css-loader 再 style-loader。 以上处理的 Webpack 相关配置如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41364187200135410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        // 增加对 SCSS 文件的支持\n        test: /\\.scss\\$/,\n        // SCSS 文件的处理顺序为先 sass-loader 再 css-loader 再 style-loader\n        use: [\n          \'style-loader\',\n          {\n            loader: \'css-loader\',\n            // 给 css-loader 传入配置项\n            options: {\n              minimize: true\n            }\n          },\n          \'sass-loader\'\n        ]\n      }\n    ]\n  }\n};`, `41364187200135410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        <span class="token comment">// 增加对 SCSS 文件的支持</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.scss$/</span><span class="token punctuation">,</span>\n        <span class="token comment">// SCSS 文件的处理顺序为先 sass-loader 再 css-loader 再 style-loader</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n          <span class="token string">\'style-loader\'</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            loader<span class="token punctuation">:</span> <span class="token string">\'css-loader\'</span><span class="token punctuation">,</span>\n            <span class="token comment">// 给 css-loader 传入配置项</span>\n            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              minimize<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token string">\'sass-loader\'</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="loader-的职责"><a href="#loader-%E7%9A%84%E8%81%8C%E8%B4%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 的职责</h2>\n<p>由上面的例子可以看出：一个 Loader 的职责是单一的，只需要完成一种转换。 如果一个源文件需要经历多步转换才能正常使用，就通过多个 Loader 去转换。 在调用多个 Loader 去转换一个文件时，每个 Loader 会链式的顺序执行，第一个 Loader 将会拿到需处理的原内容，上一个 Loader 处理后的结果会传给下一个接着处理，最后的 Loader 将处理后的最终结果返回给 Webpack。</p>\n<p>所以在你开发一个 Loader 时，请保持其职责的单一性，你只需关心输入和输出。</p>\n<h2 id="loader-基础"><a href="#loader-%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 基础</h2>\n<p>由于 Webpack 是运行在 Node.js 之上的，一个 Loader 其实就是一个 Node.js 模块，这个模块需要导出一个函数。 这个导出的函数的工作就是获得处理前的原内容，对原内容执行处理后，返回处理后的内容。</p>\n<p>一个最简单的 Loader 的源码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40481369591237780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // source 为 compiler 传递给 Loader 的一个文件的原内容\n  // 该函数需要返回处理后的内容，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换\n  return source;\n};`, `40481369591237780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// source 为 compiler 传递给 Loader 的一个文件的原内容</span>\n  <span class="token comment">// 该函数需要返回处理后的内容，这里简单起见，直接把原内容返回了，相当于该 Loader 没有做任何转换</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 Loader 运行在 Node.js 中，你可以调用任何 Node.js 自带的 API，或者安装第三方模块进行调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83533800630241820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const sass = require(\'node-sass\');\nmodule.exports = function(source) {\n  return sass(source);\n};`, `83533800630241820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-sass\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">sass</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="loader-进阶"><a href="#loader-%E8%BF%9B%E9%98%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader 进阶</h2>\n<p>以上只是个最简单的 Loader，Webpack 还提供一些 API 供 Loader 调用，下面来一一介绍。</p>\n<h3 id="获得-loader-的-options"><a href="#%E8%8E%B7%E5%BE%97-loader-%E7%9A%84-options" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获得 Loader 的 options</h3>\n<p>在最上面处理 SCSS 文件的 Webpack 配置中，给 css-loader 传了 options 参数，以控制 css-loader。 如何在自己编写的 Loader 中获取到用户传入的 options 呢？需要这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38159739387781770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const loaderUtils = require(\'loader-utils\');\nmodule.exports = function(source) {\n  // 获取到用户给当前 Loader 传入的 options\n  const options = loaderUtils.getOptions(this);\n  return source;\n};`, `38159739387781770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'loader-utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取到用户给当前 Loader 传入的 options</span>\n  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="返回其它结果"><a href="#%E8%BF%94%E5%9B%9E%E5%85%B6%E5%AE%83%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回其它结果</h3>\n<p>上面的 Loader 都只是返回了原内容转换后的内容，但有些场景下还需要返回除了内容之外的东西。</p>\n<p>例如以用 babel-loader 转换 ES6 代码为例，它还需要输出转换后的 ES5 代码对应的 Source Map，以方便调试源码。 为了把 Source Map 也一起随着 ES5 代码返回给 Webpack，可以这样写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91596250198936170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 通过 this.callback 告诉 Webpack 返回的结果\n  this.callback(null, source, sourceMaps);\n  // 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，\n  // 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中\n  return;\n};`, `91596250198936170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 通过 this.callback 告诉 Webpack 返回的结果</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 当你使用 this.callback 返回内容时，该 Loader 必须返回 undefined，</span>\n  <span class="token comment">// 以让 Webpack 知道该 Loader 返回的结果在 this.callback 中，而不是 return 中</span>\n  <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中的 this.callback 是 Webpack 给 Loader 注入的 API，以方便 Loader 和 Webpack 之间通信。 this.callback 的详细使用方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92843871771642270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.callback(\n    // 当无法转换原内容时，给 Webpack 返回一个 Error\n    err: Error | null,\n    // 原内容转换后的内容\n    content: string | Buffer,\n    // 用于把转换后的内容得出原内容的 Source Map，方便调试\n    sourceMap?: SourceMap,\n    // 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，\n    // 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能\n    abstractSyntaxTree?: AST\n);`, `92843871771642270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>\n    <span class="token comment">// 当无法转换原内容时，给 Webpack 返回一个 Error</span>\n    err<span class="token punctuation">:</span> Error <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    <span class="token comment">// 原内容转换后的内容</span>\n    content<span class="token punctuation">:</span> string <span class="token operator">|</span> Buffer<span class="token punctuation">,</span>\n    <span class="token comment">// 用于把转换后的内容得出原内容的 Source Map，方便调试</span>\n    sourceMap<span class="token operator">?</span><span class="token punctuation">:</span> SourceMap<span class="token punctuation">,</span>\n    <span class="token comment">// 如果本次转换为原内容生成了 AST 语法树，可以把这个 AST 返回，</span>\n    <span class="token comment">// 以方便之后需要 AST 的 Loader 复用该 AST，以避免重复生成 AST，提升性能</span>\n    abstractSyntaxTree<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token constant">AST</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Source Map 的生成很耗时，通常在开发环境下才会生成 Source Map，其它环境下不用生成，以加速构建。 为此 Webpack 为 Loader 提供了 this.sourceMap API 去告诉 Loader 当前构建环境下用户是否需要 Source Map。 如果你编写的 Loader 会生成 Source Map，请考虑到这点。</p>\n<h3 id="同步与异步"><a href="#%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同步与异步</h3>\n<p>Loader 有同步和异步之分，上面介绍的 Loader 都是同步的 Loader，因为它们的转换流程都是同步的，转换完成后再返回结果。 但在有些场景下转换的步骤只能是异步完成的，例如你需要通过网络请求才能得出结果，如果采用同步的方式网络请求就会阻塞整个构建，导致构建非常缓慢。</p>\n<p>在转换步骤是异步时，你可以这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79911569471380290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果\n  var callback = this.async();\n  someAsyncOperation(source, function(err, result, sourceMaps, ast) {\n    // 通过 callback 返回异步执行后的结果\n    callback(err, result, sourceMaps, ast);\n  });\n};`, `79911569471380290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 告诉 Webpack 本次转换是异步的，Loader 会在 callback 中回调结果</span>\n  <span class="token keyword">var</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">,</span> ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 通过 callback 返回异步执行后的结果</span>\n    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="处理二进制数据"><a href="#%E5%A4%84%E7%90%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理二进制数据</h3>\n<p>在默认的情况下，Webpack 传给 Loader 的原内容都是 UTF-8 格式编码的字符串。但有些场景下 Loader 不是处理文本文件，而是处理二进制文件，例如 file-loader，就需要 Webpack 给 Loader 传入二进制格式的数据。 为此，你需要这样编写 Loader：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53585290125011570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的\n  source instanceof Buffer === true;\n  // Loader 返回的类型也可以是 Buffer 类型的\n  // 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果\n  return source;\n};\n// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据\nmodule.exports.raw = true;`, `53585290125011570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在 exports.raw === true 时，Webpack 传给 Loader 的 source 是 Buffer 类型的</span>\n  source <span class="token keyword">instanceof</span> <span class="token class-name">Buffer</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Loader 返回的类型也可以是 Buffer 类型的</span>\n  <span class="token comment">// 在 exports.raw !== true 时，Loader 也可以返回 Buffer 类型的结果</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 通过 exports.raw 属性告诉 Webpack 该 Loader 是否需要二进制数据</span>\nmodule<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码中最关键的代码是最后一行 module.exports.raw = true;，没有该行 Loader 只能拿到字符串。</p>\n<h3 id="缓存加速"><a href="#%E7%BC%93%E5%AD%98%E5%8A%A0%E9%80%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存加速</h3>\n<p>在有些情况下，有些转换操作需要大量计算非常耗时，如果每次构建都重新执行重复的转换操作，构建将会变得非常缓慢。 为此，Webpack 会默认缓存所有 Loader 的处理结果，也就是说在需要被处理的文件或者其依赖的文件没有发生变化时， 是不会重新调用对应的 Loader 去执行转换操作的。</p>\n<p>如果你想让 Webpack 不缓存该 Loader 的处理结果，可以这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4815707302711813000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = function(source) {\n  // 关闭该 Loader 的缓存功能\n  this.cacheable(false);\n  return source;\n};`, `4815707302711813000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 关闭该 Loader 的缓存功能</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="其它-loader-api"><a href="#%E5%85%B6%E5%AE%83-loader-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它 Loader API</h2>\n<p>除了以上提到的在 Loader 中能调用的 Webpack API 外，还存在以下常用 API：</p>\n<ul>\n<li>this.context：当前处理文件的所在目录，假如当前 Loader 处理的文件是 /src/main.js，则 this.context 就等于 /src。</li>\n<li>this.resource：当前处理文件的完整请求路径，包括 querystring，例如 /src/main.js?name=1。</li>\n<li>this.resourcePath：当前处理文件的路径，例如 /src/main.js。</li>\n<li>this.resourceQuery：当前处理文件的 querystring。</li>\n<li>this.target：等于 Webpack 配置中的 Target，详情见 2-7 其它配置项-Target。</li>\n<li>this.loadModule：当 Loader 在处理一个文件时，如果依赖其它文件的处理结果才能得出当前文件的结果时， 就可以通过 this.loadModule(request: string, callback: function(err, source, sourceMap, module)) 去获得 request 对应文件的处理结果。</li>\n<li>this.resolve：像 require 语句一样获得指定文件的完整路径，使用方法为 resolve(context: string, request: string, callback: function(err, result: string))。</li>\n<li>this.addDependency：给当前处理文件添加其依赖的文件，以便再其依赖的文件发生变化时，会重新调用 Loader 处理该文件。使用方法为 addDependency(file: string)。</li>\n<li>this.addContextDependency：和 addDependency 类似，但 addContextDependency 是把整个目录加入到当前正在处理文件的依赖中。使用方法为 addContextDependency(directory: string)。</li>\n<li>this.clearDependencies：清除当前正在处理文件的所有依赖，使用方法为 clearDependencies()。</li>\n<li>this.emitFile：输出一个文件，使用方法为 emitFile(name: string, content: Buffer|string, sourceMap: {…})</li>\n</ul>\n<h2 id="加载本地-loader"><a href="#%E5%8A%A0%E8%BD%BD%E6%9C%AC%E5%9C%B0-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载本地 Loader</h2>\n<p>在开发 Loader 的过程中，为了测试编写的 Loader 是否能正常工作，需要把它配置到 Webpack 中后，才可能会调用该 Loader。 在前面的章节中，使用的 Loader 都是通过 Npm 安装的，要使用 Loader 时会直接使用 Loader 的名称，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22708373269457780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        test: /\\.css\\$/,\n        use: [\'style-loader\']\n      }\n    ]\n  }\n};`, `22708373269457780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'style-loader\'</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果还采取以上的方法去使用本地开发的 Loader 将会很麻烦，因为你需要确保编写的 Loader 的源码是在 node_modules 目录下，为此你需要先把编写的 Loader 发布到 Npm 仓库后再安装到本地项目使用。</p>\n<p>解决以上问题的便捷方法有两种，分别如下：</p>\n<h3 id="npm-link"><a href="#npm-link" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Npm link</h3>\n<p>Npm link 专门用于开发和调试本地 Npm 模块，能做到在不发布模块的情况下，把本地的一个正在开发的模块的源码链接到项目的 node_modules 目录下，让项目可以直接使用本地的 Npm 模块。由于是通过软链接的方式实现的，编辑了本地的 Npm 模块代码，在项目中也能使用到编辑后的代码。</p>\n<p>完成 Npm link 的步骤如下：</p>\n<ol>\n<li>确保正在开发的本地 Npm 模块（也就是正在开发的 Loader）的 package.json 已经正确配置好；</li>\n<li>在本地 Npm 模块根目录下执行 npm link，把本地模块注册到全局；</li>\n<li>在项目根目录下执行 npm link loader-name，把第 2 步注册到全局的本地 Npm 模块链接到项目的 node_moduels 下，其中的 loader-name 是指在第 1 步中的 package.json 文件中配置的模块名称。链接好 Loader 到项目后你就可以像使用一个真正的 Npm 模块一样使用本地的 Loader 了。</li>\n</ol>\n<h3 id="resolveloader"><a href="#resolveloader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ResolveLoader</h3>\n<p>假如本地的 Loader 在项目目录中的 ./loaders/loader-name 中，则需要如下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90415302017274100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  resolveLoader: {\n    // 去哪些目录下寻找 Loader，有先后顺序之分\n    modules: [\'node_modules\', \'./loaders/\']\n  }\n};`, `90415302017274100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 去哪些目录下寻找 Loader，有先后顺序之分</span>\n    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">,</span> <span class="token string">\'./loaders/\'</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>加上以上配置后， Webpack 会先去 node_modules 项目下寻找 Loader，如果找不到，会再去 ./loaders/ 目录下寻找。</p>\n<h2 id="实战"><a href="#%E5%AE%9E%E6%88%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实战</h2>\n<p>上面讲了许多理论，接下来从实际出发，来编写一个解决实际问题的 Loader。</p>\n<p>该 Loader 名叫 comment-require-loader，作用是把 JavaScript 代码中的注释语法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35666651377454195000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// @require \'../style/index.css\'`, `35666651377454195000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// @require \'../style/index.css\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>转换成</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18141883947769367000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`require(\'../style/index.css\');`, `18141883947769367000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../style/index.css\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>该 Loader 的使用场景是去正确加载针对 Fis3 编写的 JavaScript，这些 JavaScript 中存在通过注释的方式加载依赖的 CSS 文件。</p>\n<p>该 Loader 的使用方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81384324922888160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  module: {\n    rules: [\n      {\n        test: /\\.js\\$/,\n        use: [\'comment-require-loader\'],\n        // 针对采用了 fis3 CSS 导入语法的 JavaScript 文件通过 comment-require-loader 去转换\n        include: [path.resolve(__dirname, \'node_modules/imui\')]\n      }\n    ]\n  }\n};`, `81384324922888160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n        test<span class="token punctuation">:</span> <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'comment-require-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token comment">// 针对采用了 fis3 CSS 导入语法的 JavaScript 文件通过 comment-require-loader 去转换</span>\n        include<span class="token punctuation">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'node_modules/imui\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该 Loader 的实现非常简单，完整代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7901599079359745000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function replace(source) {\n  // 使用正则把 // @require \'../style/index.css\' 转换成 require(\'../style/index.css\');\n  return source.replace(/(\\/\\/ *@require) +((\'|&quot;).+(\'|&quot;)).*/, \'require(\\$2);\');\n}\n\nmodule.exports = function(content) {\n  return replace(content);\n};`, `7901599079359745000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 使用正则把 // @require \'../style/index.css\' 转换成 require(\'../style/index.css\');</span>\n  <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(\\/\\/ *@require) +((\'|").+(\'|")).*/</span><span class="token punctuation">,</span> <span class="token string">\'require($2);\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="编写-plugin"><a href="#%E7%BC%96%E5%86%99-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编写 Plugin</h1>\n<p>Webpack 通过 Plugin 机制让其更加灵活，以适应各种应用场景。在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。</p>\n<p>一个最基础的 Plugin 的代码是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47525881375881340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BasicPlugin {\n  // 在构造函数中获取用户给该插件传入的配置\n  constructor(options) {}\n\n  // Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象\n  apply(compiler) {\n    compiler.plugin(\'compilation\', function(compilation) {});\n  }\n}\n\n// 导出 Plugin\nmodule.exports = BasicPlugin;`, `47525881375881340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BasicPlugin</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在构造函数中获取用户给该插件传入的配置</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token comment">// Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'compilation\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 导出 Plugin</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> BasicPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在使用这个 Plugin 时，相关配置代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97573847138353600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const BasicPlugin = require(\'./BasicPlugin.js\');\nmodule.export = {\n  plugins: [new BasicPlugin(options)]\n};`, `97573847138353600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> BasicPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./BasicPlugin.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">BasicPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Webpack 启动后，在读取配置的过程中会先执行 new BasicPlugin(options) 初始化一个 BasicPlugin 获得其实例。 在初始化 compiler 对象后，再调用 basicPlugin.apply(compiler) 给插件实例传入 compiler 对象。 插件实例在获取到 compiler 对象后，就可以通过 compiler.plugin(事件名称, 回调函数) 监听到 Webpack 广播出来的事件。 并且可以通过 compiler 对象去操作 Webpack。</p>\n<p>通过以上最简单的 Plugin 相信你大概明白了 Plugin 的工作原理，但实际开发中还有很多细节需要注意，下面来详细介绍。</p>\n<h2 id="compiler-和-compilation"><a href="#compiler-%E5%92%8C-compilation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiler 和 Compilation</h2>\n<p>在开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack 之间的桥梁。 Compiler 和 Compilation 的含义如下：</p>\n<ul>\n<li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li>\n<li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。</li>\n</ul>\n<p>Compiler 和 Compilation 的区别在于：Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译。</p>\n<h2 id="事件流"><a href="#%E4%BA%8B%E4%BB%B6%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件流</h2>\n<p>Webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。 这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。 插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</p>\n<p>Webpack 通过 Tapable 来组织这条复杂的生产线。 Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。 Webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。</p>\n<p>Webpack 的事件流机制应用了观察者模式，和 Node.js 中的 EventEmitter 非常相似。 Compiler 和 Compilation 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19200202086700835000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 广播出事件\n * event-name 为事件名称，注意不要和现有的事件重名\n * params 为附带的参数\n */\ncompiler.apply(\'event-name\', params);\n\n/**\n * 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。\n * 同时函数中的 params 参数为广播事件时附带的参数。\n */\ncompiler.plugin(\'event-name\', function(params) {});`, `19200202086700835000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 广播出事件\n * event-name 为事件名称，注意不要和现有的事件重名\n * params 为附带的参数\n */</span>\n<span class="token function">compiler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">\'event-name\'</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。\n * 同时函数中的 params 参数为广播事件时附带的参数。\n */</span>\ncompiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'event-name\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同理，compilation.apply 和 compilation.plugin 使用方法和上面一致。</p>\n<p>在开发插件时，你可能会不知道该如何下手，因为你不知道该监听哪个事件才能完成任务。</p>\n<p>在开发插件时，还需要注意以下两点：</p>\n<ul>\n<li>\n<p>只要能拿到 Compiler 或 Compilation 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。</p>\n</li>\n<li>\n<p>传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件。</p>\n</li>\n<li>\n<p>有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16769998249533180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', function(compilation, callback) {\n// 支持处理逻辑\n\n// 处理完毕后执行 callback 以通知 Webpack\n// 如果不执行 callback，运行流程将会一直卡在这不往下执行\ncallback();\n});`, `16769998249533180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token comment">// 支持处理逻辑</span>\n\n<span class="token comment">// 处理完毕后执行 callback 以通知 Webpack</span>\n<span class="token comment">// 如果不执行 callback，运行流程将会一直卡在这不往下执行</span>\n<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="常用-api"><a href="#%E5%B8%B8%E7%94%A8-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用 API</h2>\n<p>插件可以用来修改输出文件、增加输出文件、甚至可以提升 Webpack 性能等等，总之插件通过调用 Webpack 提供的 API 能完成很多事情。 由于 Webpack 提供的 API 非常多，有很多 API 很少用的上，又加上篇幅有限，下面来介绍一些常用的 API。</p>\n<h3 id="读取输出资源、代码块、模块及其依赖"><a href="#%E8%AF%BB%E5%8F%96%E8%BE%93%E5%87%BA%E8%B5%84%E6%BA%90%E3%80%81%E4%BB%A3%E7%A0%81%E5%9D%97%E3%80%81%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B6%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取输出资源、代码块、模块及其依赖</h3>\n<p>有些插件可能需要读取 Webpack 的处理结果，例如输出资源、代码块、模块及其依赖，以便做下一步处理。</p>\n<p>在 emit 事件发生时，代表源文件的转换和组装已经完成，在这里可以读取到最终将输出的资源、代码块、模块及其依赖，并且可以修改输出资源的内容。 插件代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96689193348436260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Plugin {\n  apply(compiler) {\n    compiler.plugin(\'emit\', function(compilation, callback) {\n      // compilation.chunks 存放所有代码块，是一个数组\n      compilation.chunks.forEach(function(chunk) {\n        // chunk 代表一个代码块\n        // 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块\n        chunk.forEachModule(function(module) {\n          // module 代表一个模块\n          // module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组\n          module.fileDependencies.forEach(function(filepath) {});\n        });\n\n        // Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件\n        // 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，\n        // 该 Chunk 就会生成 .js 和 .css 两个文件\n        chunk.files.forEach(function(filename) {\n          // compilation.assets 存放当前所有即将输出的资源\n          // 调用一个输出资源的 source() 方法能获取到输出资源的内容\n          let source = compilation.assets[filename].source();\n        });\n      });\n\n      // 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。\n      // 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。\n      callback();\n    });\n  }\n}`, `96689193348436260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// compilation.chunks 存放所有代码块，是一个数组</span>\n      compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// chunk 代表一个代码块</span>\n        <span class="token comment">// 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块</span>\n        chunk<span class="token punctuation">.</span><span class="token function">forEachModule</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// module 代表一个模块</span>\n          <span class="token comment">// module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组</span>\n          module<span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filepath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件</span>\n        <span class="token comment">// 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，</span>\n        <span class="token comment">// 该 Chunk 就会生成 .js 和 .css 两个文件</span>\n        chunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// compilation.assets 存放当前所有即将输出的资源</span>\n          <span class="token comment">// 调用一个输出资源的 source() 方法能获取到输出资源的内容</span>\n          <span class="token keyword">let</span> source <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。</span>\n      <span class="token comment">// 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。</span>\n      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="监听文件变化"><a href="#%E7%9B%91%E5%90%AC%E6%96%87%E4%BB%B6%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听文件变化</h3>\n<p>Webpack 会从配置的入口模块出发，依次找出所有的依赖模块，当入口模块或者其依赖的模块发生变化时， 就会触发一次新的 Compilation。</p>\n<p>在开发插件时经常需要知道是哪个文件发生变化导致了新的 Compilation，为此可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88065970940048300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当依赖的文件发生变化时会触发 watch-run 事件\ncompiler.plugin(\'watch-run\', (watching, callback) => {\n  // 获取发生变化的文件列表\n  const changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;\n  // changedFiles 格式为键值对，键为发生变化的文件路径。\n  if (changedFiles[filePath] !== undefined) {\n    // filePath 对应的文件发生了变化\n  }\n  callback();\n});`, `88065970940048300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当依赖的文件发生变化时会触发 watch-run 事件</span>\ncompiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'watch-run\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">watching<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取发生变化的文件列表</span>\n  <span class="token keyword">const</span> changedFiles <span class="token operator">=</span> watching<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>watchFileSystem<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span>mtimes<span class="token punctuation">;</span>\n  <span class="token comment">// changedFiles 格式为键值对，键为发生变化的文件路径。</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>changedFiles<span class="token punctuation">[</span>filePath<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// filePath 对应的文件发生了变化</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>默认情况下 Webpack 只会监视入口和其依赖的模块是否发生变化，在有些情况下项目可能需要引入新的文件，例如引入一个 HTML 文件。 由于 JavaScript 文件不会去导入 HTML 文件，Webpack 就不会监听 HTML 文件的变化，编辑 HTML 文件时就不会重新触发新的 Compilation。 为了监听 HTML 文件的变化，我们需要把 HTML 文件加入到依赖列表中，为此可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87528393027560210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'after-compile\', (compilation, callback) => {\n  // 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译\n  compilation.fileDependencies.push(filePath);\n  callback();\n});`, `87528393027560210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'after-compile\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译</span>\n  compilation<span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="修改输出资源"><a href="#%E4%BF%AE%E6%94%B9%E8%BE%93%E5%87%BA%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改输出资源</h3>\n<p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 emit 事件，因为发生 emit 事件时所有模块的转换和代码块对应的文件已经生成好， 需要输出的资源即将输出，因此 emit 事件是修改 Webpack 输出资源的最后时机。</p>\n<p>所有需要输出的资源会存放在 compilation.assets 中，compilation.assets 是一个键值对，键为需要输出的文件名称，值为文件对应的内容。</p>\n<p>设置 compilation.assets 的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31010403613461810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', (compilation, callback) => {\n  // 设置名称为 fileName 的输出资源\n  compilation.assets[fileName] = {\n    // 返回文件内容\n    source: () => {\n      // fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer\n      return fileContent;\n    },\n    // 返回文件大小\n    size: () => {\n      return Buffer.byteLength(fileContent, \'utf8\');\n    }\n  };\n  callback();\n});`, `31010403613461810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 设置名称为 fileName 的输出资源</span>\n  compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 返回文件内容</span>\n    <span class="token function-variable function">source</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span>\n      <span class="token keyword">return</span> fileContent<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// 返回文件大小</span>\n    <span class="token function-variable function">size</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>读取 compilation.assets 的代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89651901054878700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.plugin(\'emit\', (compilation, callback) => {\n  // 读取名称为 fileName 的输出资源\n  const asset = compilation.assets[fileName];\n  // 获取输出资源的内容\n  asset.source();\n  // 获取输出资源的文件大小\n  asset.size();\n  callback();\n});`, `89651901054878700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'emit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 读取名称为 fileName 的输出资源</span>\n  <span class="token keyword">const</span> asset <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 获取输出资源的内容</span>\n  asset<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 获取输出资源的文件大小</span>\n  asset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="判断-webpack-使用了哪些插件"><a href="#%E5%88%A4%E6%96%AD-webpack-%E4%BD%BF%E7%94%A8%E4%BA%86%E5%93%AA%E4%BA%9B%E6%8F%92%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>判断 Webpack 使用了哪些插件</h3>\n<p>在开发一个插件时可能需要根据当前配置是否使用了其它某个插件而做下一步决定，因此需要读取 Webpack 当前的插件配置情况。 以判断当前是否使用了 ExtractTextPlugin 为例，可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84939345866053120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 判断当前配置使用使用了 ExtractTextPlugin，\n// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数\nfunction hasExtractTextPlugin(compiler) {\n  // 当前配置所有使用的插件列表\n  const plugins = compiler.options.plugins;\n  // 去 plugins 中寻找有没有 ExtractTextPlugin 的实例\n  return plugins.find((plugin) => plugin.__proto__.constructor === ExtractTextPlugin) != null;\n}`, `84939345866053120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 判断当前配置使用使用了 ExtractTextPlugin，</span>\n<span class="token comment">// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数</span>\n<span class="token keyword">function</span> <span class="token function">hasExtractTextPlugin</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 当前配置所有使用的插件列表</span>\n  <span class="token keyword">const</span> plugins <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>\n  <span class="token comment">// 去 plugins 中寻找有没有 ExtractTextPlugin 的实例</span>\n  <span class="token keyword">return</span> plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> ExtractTextPlugin<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实战-1"><a href="#%E5%AE%9E%E6%88%98-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实战</h2>\n<p>下面我们举一个实际的例子，带你一步步去实现一个插件。</p>\n<p>该插件的名称取名叫 EndWebpackPlugin，作用是在 Webpack 即将退出时再附加一些额外的操作，例如在 Webpack 成功编译和输出了文件后执行发布操作把输出的文件上传到服务器。 同时该插件还能区分 Webpack 构建是否执行成功。使用该插件时方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40185610327168760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  plugins: [\n    // 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；\n    new EndWebpackPlugin(\n      () => {\n        // Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作\n      },\n      (err) => {\n        // Webpack 构建失败，err 是导致错误的原因\n        console.error(err);\n      }\n    )\n  ]\n};`, `40185610327168760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token comment">// 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；</span>\n    <span class="token keyword">new</span> <span class="token class-name">EndWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// Webpack 构建失败，err 是导致错误的原因</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要实现该插件，需要借助两个事件：</p>\n<ul>\n<li>done：在成功构建并且输出了文件后，Webpack 即将退出时发生；</li>\n<li>failed：在构建出现异常导致构建失败，Webpack 即将退出时发生；</li>\n</ul>\n<p>实现该插件非常简单，完整代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20029748808159265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class EndWebpackPlugin {\n  constructor(doneCallback, failCallback) {\n    // 存下在构造函数中传入的回调函数\n    this.doneCallback = doneCallback;\n    this.failCallback = failCallback;\n  }\n\n  apply(compiler) {\n    compiler.plugin(\'done\', (stats) => {\n      // 在 done 事件中回调 doneCallback\n      this.doneCallback(stats);\n    });\n    compiler.plugin(\'failed\', (err) => {\n      // 在 failed 事件中回调 failCallback\n      this.failCallback(err);\n    });\n  }\n}\n// 导出插件\nmodule.exports = EndWebpackPlugin;`, `20029748808159265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">EndWebpackPlugin</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">doneCallback<span class="token punctuation">,</span> failCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 存下在构造函数中传入的回调函数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>doneCallback <span class="token operator">=</span> doneCallback<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>failCallback <span class="token operator">=</span> failCallback<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'done\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在 done 事件中回调 doneCallback</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doneCallback</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在 failed 事件中回调 failCallback</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">failCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 导出插件</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> EndWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从开发这个插件可以看出，找到合适的事件点去完成功能在开发插件时显得尤为重要。 工作原理概括中详细介绍过 Webpack 在运行过程中广播出常用事件，你可以从中找到你需要的事件。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack原理入门/index.md absPath of file >>> MarkdownRemark",timeToRead:16,frontmatter:{date:"2020-11-17 11:41:47",path:"/webpack-principle-introduction/",tags:"前端, 前端构建工具, webpack",title:"Webpack原理入门",draft:null}},{excerpt:"首先了解一下 webpack 的打包原理 webpack 的打包原理 chunk 和 module webpack 里面有两个很核心的概念，叫 chunk 和 module，这里为了简单，只看 js 相关的，用笔者自己的理解去解释一下他们直接的区别： module：每一个源码 js 文件其实都可以看成一个 module chunk：每一个打包落地的 js 文件其实都是一个 chunk，每个 chunk 都包含很多 module 默认的 chunk 数量实际上是由你的入口文件的 js…",html:'<p>首先了解一下 webpack 的打包原理</p>\n<h1 id="webpack-的打包原理"><a href="#webpack-%E7%9A%84%E6%89%93%E5%8C%85%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 的打包原理</h1>\n<h2 id="chunk-和-module"><a href="#chunk-%E5%92%8C-module" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>chunk 和 module</h2>\n<p>webpack 里面有两个很核心的概念，叫 chunk 和 module，这里为了简单，只看 js 相关的，用笔者自己的理解去解释一下他们直接的区别：</p>\n<blockquote>\n<p>module：每一个源码 js 文件其实都可以看成一个 module<br>\nchunk：每一个打包落地的 js 文件其实都是一个 chunk，每个 chunk 都包含很多 module</p>\n</blockquote>\n<p>默认的 chunk 数量实际上是由你的入口文件的 js 数量决定的，但是如果你配置动态加载或者提取公共包的话，也会生成新的 chunk。</p>\n<h2 id="打包代码解读"><a href="#%E6%89%93%E5%8C%85%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包代码解读</h2>\n<p>有了基本理解后，我们需要去理解 webpack 打包后的代码在浏览器端是如何加载执行的。为此我们准备一个非常简单的 demo，来看一下它的生成文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38888249079999390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// src\n// ---main.js\n// ---moduleA.js\n// ---moduleB.js\n\n/**\n * moduleA.js\n */\nexport default function testA() {\n  console.log(\'this is A\');\n}\n\n/**\n * main.js\n */\nimport testA from \'./moduleA\';\n\ntestA();\n\nimport(\'./moduleB\').then((module) => {});`, `38888249079999390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// src</span>\n<span class="token comment">// ---main.js</span>\n<span class="token comment">// ---moduleA.js</span>\n<span class="token comment">// ---moduleB.js</span>\n\n<span class="token comment">/**\n * moduleA.js\n */</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'this is A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/**\n * main.js\n */</span>\n<span class="token keyword">import</span> testA <span class="token keyword">from</span> <span class="token string">\'./moduleA\'</span><span class="token punctuation">;</span>\n\n<span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./moduleB\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>非常简单，入口 js 是 main.js，里面就是直接引入 moduleA.js，然后动态引入 moduleB.js，那么最终生成的文件就是两个 chunk，分别是:</p>\n<ol>\n<li>main.js 和 moduleA.js 组成的 bundle.js</li>\n<li>moduleB.js 组成的 0.bundle.js</li>\n</ol>\n<p>如果你了解 webpack 底层原理的话，那你会知道这里是用 mainTemplate 和 chunkTemplate 分别渲染出来的，不了解也没关系，我们继续解读生成的代码</p>\n<h3 id="import-变成了什么样"><a href="#import-%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%80%E4%B9%88%E6%A0%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>import 变成了什么样</h3>\n<p>整个 main.js 的代码打包后是下面这样的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66662411328495600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(module, __webpack_exports__, __webpack_require__) {\n  \'use strict\';\n  __webpack_require__.r(__webpack_exports__);\n  /* harmony import */\n  var _moduleA__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*!        ./moduleA */ \'./src/moduleA.js\');\n\n  Object(_moduleA__WEBPACK_IMPORTED_MODULE_0__[\'default\'])();\n\n  __webpack_require__\n    .e(/*! import() */ 0)\n    .then(__webpack_require__.bind(null, /*! ./moduleB             */ \'./src/moduleB.js\'))\n    .then((module) => {});\n});`, `66662411328495600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n  __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">/* harmony import */</span>\n  <span class="token keyword">var</span> _moduleA__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*!        ./moduleA */</span> <span class="token string">\'./src/moduleA.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">Object</span><span class="token punctuation">(</span>_moduleA__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">\'default\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  __webpack_require__\n    <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/*! ./moduleB             */</span> <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，我们的直接 import moduleA 最后会变成 webpack_require，而这个函数是 webpack 打包后的一个核心函数，就是解决依赖引入的。</p>\n<h3 id="webpack_require-是怎么实现的"><a href="#webpack_require-%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack_require 是怎么实现的</h3>\n<p>那我们看一下 webpack_require 它是怎么实现的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9324095439506985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function __webpack_require__(moduleId) {\n  // Check if module is in cache\n  // 先检查模块是否已经加载过了，如果加载过了直接返回\n  if (installedModules[moduleId]) {\n    return installedModules[moduleId].exports;\n  }\n  // Create a new module (and put it into the cache)\n  // 如果一个import的模块是第一次加载，那之前必然没有加载过，就会去执行加载过程\n  var module = (installedModules[moduleId] = {\n    i: moduleId,\n    l: false,\n    exports: {}\n  });\n  // Execute the module function\n  modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n  // Flag the module as loaded\n  module.l = true;\n  // Return the exports of the module\n  return module.exports;\n}`, `9324095439506985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Check if module is in cache</span>\n  <span class="token comment">// 先检查模块是否已经加载过了，如果加载过了直接返回</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Create a new module (and put it into the cache)</span>\n  <span class="token comment">// 如果一个import的模块是第一次加载，那之前必然没有加载过，就会去执行加载过程</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>\n    l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Execute the module function</span>\n  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// Flag the module as loaded</span>\n  module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token comment">// Return the exports of the module</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果简化一下它的实现，其实很简单，就是每次 require，先去缓存的 installedModules 这个缓存 map 里面看是否加载过了，如果没有加载过，那就从 modules 这个所有模块的 map 里去加载。</p>\n<h3 id="modules-从哪里来的"><a href="#modules-%E4%BB%8E%E5%93%AA%E9%87%8C%E6%9D%A5%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>modules 从哪里来的</h3>\n<p>那相信很多人都有疑问了，modules 这么个至关重要的 map 是从哪里来的呢，我们把 bundle.js 生成的 js 再简化一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52041007237325185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(modules) {})({\n  \'./src/main.js\': function(module, __webpack_exports__, __webpack_require__) {},\n  \'./src/moduleA.js\': function(module, __webpack_exports__, __webpack_require__) {}\n});`, `52041007237325185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token string">\'./src/main.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">\'./src/moduleA.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以可以看到，这其实是个立即执行函数，modules 就是函数的入参，具体值就是我们包含的所有 module，到此一个 chunk 是如何加载的，以及 chunk 如何包含 module，相信大家一定会有自己的理解了。</p>\n<h3 id="动态引入如何操作呢"><a href="#%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5%E5%A6%82%E4%BD%95%E6%93%8D%E4%BD%9C%E5%91%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态引入如何操作呢</h3>\n<p>上面的 chunk 就是一个 js 文件，所以维护了自己的局部 modules，然后自己使用没啥问题，但是动态引入我们知道是会生成一个新的 js 文件的，那这个新的 js 文件 0.bundle.js 里面是不是也有自己的 modules 呢？那 bundle.js 如何知道 0.bundle.js 里面的 modules 呢？</p>\n<p>先看动态 import 的代码变成了什么样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90524393140736200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`__webpack_require__\n  .e(/*! import() */ 0)\n  .then(__webpack_require__.bind(null, /*! ./moduleB             */ \'./src/moduleB.js\'))\n  .then((module) => {});`, `90524393140736200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">__webpack_require__\n  <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">/*! ./moduleB             */</span> <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码看，实际上就是外面套了一层 webpck<em>require.e，然后这是一个 promise，在 then 里面再去执行 webpack</em>require。</p>\n<p>实际上 webpck_require.e 就是去加载 chunk 的 js 文件 0.bundle.js，具体代码就不贴了，没啥特别的。</p>\n<p>等到加载回来后它认为 bundle.js 里面的 modules 就一定会有了 0.bundle.js 包含的那些 modules，这是如何做到的呢？</p>\n<p>我们看 0.bundle.js 到底是什么内容，让它拥有这样的魔力：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10134598295006224000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(window[\'webpackJsonp\'] = window[\'webpackJsonp\'] || []).push([\n  [0],\n  {\n    \'./src/moduleB.js\': function(module, __webpack_exports__, __webpack_require__) {}\n  }\n]);`, `10134598295006224000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    <span class="token string">\'./src/moduleB.js\'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>拿简化后的代码一看，大家第一眼想到的是 jsonp，但是很遗憾的是它不是一个函数，却只是向一个全局数组里面 push 了自己的模块 id 以及对应的 modules。那看起来魔法的核心应该是在 bundle.js 里面了，事实的确也是如此。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11260167707866108000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var jsonpArray = (window[\'webpackJsonp\'] = window[\'webpackJsonp\'] || []);\nvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\njsonpArray.push = webpackJsonpCallback;\njsonpArray = jsonpArray.slice();\nfor (var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\nvar parentJsonpFunction = oldJsonpFunction;`, `11260167707866108000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> jsonpArray <span class="token operator">=</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">\'webpackJsonp\'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> oldJsonpFunction <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">)</span><span class="token punctuation">;</span>\njsonpArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback<span class="token punctuation">;</span>\njsonpArray <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jsonpArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> oldJsonpFunction<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 bundle.js 的里面，我们看到这么一段代码，其实就是说我们劫持了 push 函数，那 0.bundle.js 一旦加载完成，我们岂不是就会执行这里，那不就能拿到所有的参数，然后把 0.bundle.js 里面的所有 module 加到自己的 modules 里面去！</p>\n<h2 id="总结一下"><a href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结一下</h2>\n<p>如果你没有很理解，可以配合下面的图片，再把上面的代码读几遍。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-79633.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.590308370044056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACkUlEQVQoz02SXUxSYRjHuey6u2676qab2loXtdbWzJptfkxgFLbV1tb8IFfrpma1bHMDkwLl8JGBKAQHiWwIHBADQS80KN3MWWYGRmluyMf54Jz3fTrHvPDdf3uf9+K35/m//0eGMLA80DVJbA04HnPCnnjgERw8nABVDiqiWKkQn7LlAu4exw+D0BOE+wHUQeJ2Ejp9cMuN3AtYZDAGJN1gm0Uqu9DlwxofVo8IljSSZXKgtjMaz67GU2pz4uvD25325XbH2hWCJ1ISJJLC3gjGJG4woy5v7Q7JNZr5F9NINpcDg8eZDx9fDNYrX/NWv6uYOvclplJYdozTHOKq1SpdrtAgVPujrGIoPxdq/xqX97kndNMgm82B1Uuw0cO58Im2EU7rmZwNqCh/R4vhlzFeFeFSqVylGdGyfqqmMBUSwe4lStU7NrkPm8lXdPzoj/CZ5v7VJ4OGBe9Z6s21xoH156EdplKkGUbsLDBFHcUoifwn6uZmokHrIrUS/BMspJ1NndyI1bcacn0OV3aiIfK2q8X4+2W0zNGl4q4kQPRAjJObNhOTd5ei6t6xoNRZ9Ex4bSXqyPfQabWT1/vDK/G2dOSewloyzYgfhRiGlTzzFV2EVpo2P1M3Ch8u69zj2v9jD5NGiB/aihy7amet/tFS8tTqlFJpK5rTUlJoPyqkjwutQ7lU8PYK1fxs7L3UeSEPPa65d4FHLr9e7ag9cC86A1azn5TbGGv6YFTYkASFtRgLPf0Y0zwejUlwNofrTaiOgIsENFqESwQ6b4I6M1wwImMCHcyZmEFNFkHpALkdmmx4MIlkhV3wZgRflhflzSAyIxbceLY2No/mN/Y3bG/BYKsM37Zh/S8WtbaN/5TgH4cyKr0uve2BAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 30 20 18 37" title="" data-src="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-fee1c.png" data-srcset="/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-a67b7.png 200w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-0b187.png 400w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-fee1c.png 800w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-b1a91.png 1200w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-95179.png 1600w,\n/static/2020-06-30-20-18-37-541336a0f78dedb6cf7d1cd22b00704e-79633.png 1816w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>其实简单来说就是，对于 mainChunk 文件，我们维护一个 modules 这样的所有模块 map，并且提供类似 webpack_require 这样的函数。对于 chunkA 文件（可能是因为提取公共代码生成的、或者是动态加载）我们就用类似 jsonp 的方式，让它把自己的所有 modules 添加到主 chunk 的 modules 里面去。</p>\n<h1 id="module-federation"><a href="#module-federation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation</h1>\n<h2 id="module-federation-的介绍"><a href="#module-federation-%E7%9A%84%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的介绍</h2>\n<p>允许运行时动态决定代码的引入和加载。</p>\n<h2 id="module-federation-的-demo"><a href="#module-federation-%E7%9A%84-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的 demo</h2>\n<p>我们最关心的还是 Module federation 的实现方式：</p>\n<p><a href="https://github.com/module-federation/module-federation-examples/tree/master/basic-host-remote" target="_blank" rel="nofollow noreferrer noopener">module-federation-examples/basic-host-remote</a></p>\n<p>在此之前，还是需要向大家介绍一下这个 demo 做的事情</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61986514101006615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app1\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n\napp2\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n---Button.js react组件`, `61986514101006615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app1\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n\napp2\n---index.js 入口文件\n---bootstrap.js 启动文件\n---App.js react组件\n---Button.js react组件</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是文件结构，其实你可以看成是两个独立应用 app1 和 app2，那他们之前有什么爱恨情仇呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64609001389423780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** app1 **/\n/**\n * index.js\n **/\nimport(\'./bootstrap\');\n\n/**\n * bootstrap.js\n **/\nimport(\'./bootstrap\');\nimport App from \'./App\';\nimport React from \'react\';\nimport ReactDOM from \'react-dom\';\n\nReactDOM.render(<App />, document.getElementById(\'root\'));\n\n/**\n * App.js\n **/\nimport(\'./bootstrap\');\nimport React from \'react\';\n\nimport RemoteButton from \'app2/Button\';\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 1</h2>\n    <React.Suspense fallback=\'Loading Button\'>\n      <RemoteButton />\n    </React.Suspense>\n  </div>\n);\n\nexport default App;`, `64609001389423780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** app1 **/</span>\n<span class="token comment">/**\n * index.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * bootstrap.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'./App\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * App.js\n **/</span>\n<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'./bootstrap\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Suspense fallback<span class="token operator">=</span><span class="token string">\'Loading Button\'</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>RemoteButton <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Suspense<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我这里只贴了 app1 的 js 代码，app2 的代码你不需要关心。代码没有什么特殊的，只有一点，app1 的 App.js 里面：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82879326644363030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import RemoteButton from \'app2/Button\';`, `82879326644363030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也就是关键来了，跨应用复用代码来了！app1 的代码用了 app2 的代码，但是这个代码最终长什么样？是如何引入 app2 的代码的？</p>\n<h2 id="module-federation-的配置"><a href="#module-federation-%E7%9A%84%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的配置</h2>\n<p>先看我们的 webpack 需要如何配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30246342734547247000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * app1/webpack.js\n */\n{\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app1\',\n      library: {\n        type: \'var\',\n        name: \'app1\'\n      },\n      remotes: {\n        app2: \'app2\'\n      },\n      shared: [\'react\', \'react-dom\']\n    })\n  ];\n}`, `30246342734547247000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * app1/webpack.js\n */</span>\n<span class="token punctuation">{</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span>\n        name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        app2<span class="token punctuation">:</span> <span class="token string">\'app2\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个其实就是 Module federation 的配置了，大概能看到想表达的意思：</p>\n<ol>\n<li>用了远程模块 app2，它叫 app2</li>\n<li>用了共享模块，它叫 shared</li>\n</ol>\n<p>remotes 和 shared 还是有一点区别的，我们先来看效果。</p>\n<p>生成的 html 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32399584312953110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<html>\n  <head>\n    <script src=&quot;app2/remoteEntry.js&quot;></script>\n  </head>\n  <body>\n    <div id=&quot;root&quot;></div>\n    <script src=&quot;app1/app1.js&quot;></script>\n    <script src=&quot;app1/main.js&quot;></script>\n  </body>\n</html>`, `32399584312953110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app2/remoteEntry.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app1/app1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app1/main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ps：这里的 js 路径有修改，这个是可以配置的，这里只是表明从哪里加载了哪些 js 文件</p>\n<p>app1 打包生成的文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90327240396604650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app1/index.html\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp1/src_bootstrap.js`, `90327240396604650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app1/index.html\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ps: app2 你也需要打包，只是我没有贴 app2 的代码以及配置文件，后面需要的时候会再贴出来的</p>\n<p>最终页面表现以及加载的 js：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-6cb4b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.17386231038506%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABBUlEQVQoz4VRXWuEMBD0//83QZ8Ozqt6JkYrpyZePjabqF1pKfTBOgxLQpjd2UmS53lRFFRvt1uWZWmaMsb2fd+2jSpo3dzvPeeibYUQ9PRkXVU3H2XDOU+GYTDGSCm11kqpaZqstb9iZ8z8OehlcdaoRVesbxi14KLry7JO+r7fz4EYfEDwnnqBR7ksykwvNdKTdS6R8xxCOBMHRA+wrWsIGOmC3nvAgCSJMSRnsm/b2piqZqIbyPNbu4MGFu0Ovm2y/wsa1LB2nCR5tg4dED2dMUTitZhx/mwo5qNy3lJUxlqyTTtciAGAZI+yeo3jsS5QdjT3BxdimkD/5wBijOtKwf3BF19KBzppj0CVAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 30 20 52 54" title="" data-src="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-fee1c.png" data-srcset="/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-a67b7.png 200w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-0b187.png 400w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-fee1c.png 800w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-b1a91.png 1200w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-95179.png 1600w,\n/static/2020-06-30-20-52-54-74cb5a4206669b82272c42ae97e959fe-6cb4b.png 1714w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上往下加载的 js 时序其实是很有讲究的，后面将会是解密的关键：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23288317216328626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js\napp1/src_bootstrap.js`, `23288317216328626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里最需要关注的其实还是每个文件从哪里加载，在不去分析原理之前，看文件加载我们至少有这些结论：</p>\n<ol>\n<li>remotes 的代码自己不打包，类似 external，例如 app2/button 就是加载 app2 打包的代码</li>\n<li>shared 的代码自己是有打包的</li>\n</ol>\n<h2 id="module-federation-的原理"><a href="#module-federation-%E7%9A%84%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module federation 的原理</h2>\n<p>在讲解原理之前，我还是放出之前的一张图，因为这是 webpack 的文件模块核心，即使升级 5，也没有发生变化</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-6a653.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.5755237045204%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQoz12QS28SYRSGZ+VGl13rT9B/0GhMadQYYi0wVSC4Mca4ME2kCRZiwyWgrZdioQoy5eIgzIVhZhAol2LSumkq0JRNk6q7aqKNRqTY7+JHwaTxLM7qefK+51Dvd3B6A8ibB9kmEOpIbIBM40CoA6mJOn8wmZVtxH0AyuaBdAQQ6yDbRJS7AIefITqGdQy+FASaID4XwOcX8HgYfPvVk60ZeHYeX09gXaQHjBwCIwvYEAGUr4IfJAp5eSrCv7y2BJ9wiqo6/RxvicO9NnGRI4d9rECAAMcSICikVMX5KJ2/8RpTzhJmU3ZcPdbKaegI5OWnu7VRWfaYYn0Z2lT8VrhFgDXZaGDwcs6xW9MkpYAxjilXCTNvPJ3S0Lp8hWZQkvd+Lo8KwrQphvbaqC+L3OTv5aGKdNPAIDVjJUCMmzUlDuVoehasnq4XLXQERPnnW4UxlveZBzKyKVgSbWD1TC03Se7kRddWfiycXhzISylvt3pyI6cnclJ8/Kmq5TNO86A2IskSf69bPbWi3DZEoJJ1fKxoo/y8qV87npqB5RMN5SLNwKiw2CroWWHOfKS2zN2B5ePvshZSm8+4W0VdiHvRS/aUsZ8N7eSHi9JdcrMo+79WLqhZl/nft6dVUu0hAURxhmZASbV9IQ8T58xE9pbg5WB34lVHH96/Ggb6cJsO/xgPtSeWwPeejG0y1C7+D+hC+8YYoNh1aJWgPYfsKnKokGwSdV9Bzjz8ud+TQ2twKtsH4FHAXYR/AVrIz1X6SB9CAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 10 14 59 24" title="" data-src="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-fee1c.png" data-srcset="/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-a67b7.png 200w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-0b187.png 400w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-fee1c.png 800w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-b1a91.png 1200w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-95179.png 1600w,\n/static/2020-07-10-14-59-24-f7b65ff3c10656a019bdd58ed416eac2-6a653.png 1814w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>app1 和 app2 还是有自己的 modules，所以实现的关键就是两个 modules 如何同步，或者说如何注入，那我们就来看看 Module federation 如何实现的。</p>\n<h3 id="import-变成了什么"><a href="#import-%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>import 变成了什么</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49327914951330330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// import源码\nimport RemoteButton from \'app2/Button\';\n\n// import打包代码 在app1/src_bootstrap.js里面\n/* harmony import */\nvar app2_Button__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! app2/Button */ \'?ad8d\');\n/* harmony import */\nvar app2_Button__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/ __webpack_require__.n(\n  app2_Button__WEBPACK_IMPORTED_MODULE_1__\n);`, `49327914951330330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// import源码</span>\n<span class="token keyword">import</span> RemoteButton <span class="token keyword">from</span> <span class="token string">\'app2/Button\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// import打包代码 在app1/src_bootstrap.js里面</span>\n<span class="token comment">/* harmony import */</span>\n<span class="token keyword">var</span> app2_Button__WEBPACK_IMPORTED_MODULE_1__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! app2/Button */</span> <span class="token string">\'?ad8d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">/* harmony import */</span>\n<span class="token keyword">var</span> app2_Button__WEBPACK_IMPORTED_MODULE_1___default <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">n</span><span class="token punctuation">(</span>\n  app2_Button__WEBPACK_IMPORTED_MODULE_1__\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从这里来看，我们好像看不出什么，因为还是正常的 webpack<em>require，难道说它真的像我们之前所设想的那样，重写了 webpack</em>require 吗？</p>\n<p>遗憾的是，从源码看这个函数是没有什么变化的，所以核心点不是这里。</p>\n<p>但是你注意看加载的 js 顺序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74623399993143850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js // app2的button竟然先加载了，比我们的自己启动文件还前面\napp1/src_bootstrap.js`, `74623399993143850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">app2/remoteEntry.js\napp1/app1.js\napp1/main.js\napp1/react.js\napp1/react-dom.js\napp2/src_button_js.js // app2的button竟然先加载了，比我们的自己启动文件还前面\napp1/src_bootstrap.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么是不是我们需要将依赖前置，也就是说在加载远程模块时，它知道自己依赖哪些共享模块，然后去检测是否存在，不存在依次去加载，所以依赖就位后才开始执行自己。</p>\n<p>所以它是不是通过依赖前置来解决的呢？</p>\n<h3 id="mainjs-文件内容"><a href="#mainjs-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>main.js 文件内容</h3>\n<p>因为 html 里面和 app1 相关的只有两个文件：app1/app1.js 以及 app1/main.js</p>\n<p>那我们看看 main.js 到底写了啥</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60337056581800840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(() => {\n  // webpackBootstrap\n  var __webpack_modules__ = {};\n\n  var __webpack_module_cache__ = {};\n\n  function __webpack_require__(moduleId) {\n    if (__webpack_module_cache__[moduleId]) {\n      return __webpack_module_cache__[moduleId].exports;\n    }\n    var module = (__webpack_module_cache__[moduleId] = {\n      exports: {}\n    });\n    __webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n    return module.exports;\n  }\n  __webpack_require__.m = __webpack_modules__;\n\n  __webpack_require__(\'./src/index.js\');\n})();`, `60337056581800840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// webpackBootstrap</span>\n  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> __webpack_module_cache__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>__webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n      exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> __webpack_modules__<span class="token punctuation">;</span>\n\n  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./src/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到区别不大，只是把之前的 modules 换成了 webpack_modules，然后把这个 modules 的初始化由参数改成了内部声明变量。</p>\n<p>那我们来看看 webpack_modules 内部的实现:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22757236670478287000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var __webpack_modules__ = {\n  \'./src/index.js\': (__unused_webpack_module, __unused_webpack_exports, __webpack_require__) => {\n    __webpack_require__\n      .e(/*! import() */ \'src_bootstrap_js\')\n      .then(__webpack_require__.bind(__webpack_require__, /*! ./bootstrap */ \'./src/bootstrap.js\'));\n  },\n\n  \'container-reference/app2\': (module) => {\n    \'use strict\';\n    module.exports = app2;\n  },\n\n  \'?8bfd\': (module, __unused_webpack_exports, __webpack_require__) => {\n    \'use strict\';\n    var external = __webpack_require__(\'container-reference/app2\');\n    module.exports = external;\n  }\n};`, `22757236670478287000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'./src/index.js\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token string">\'src_bootstrap_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">,</span> <span class="token comment">/*! ./bootstrap */</span> <span class="token string">\'./src/bootstrap.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'container-reference/app2\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'?8bfd\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> external <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'container-reference/app2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> external<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码看起来就三个 module：</p>\n<ol>\n<li><code class="language-text">./src/index.js</code> 这个看起来就是我们的 <code class="language-text">app1/index.js</code>，里面去动态加载 <code class="language-text">bootstrap.js</code> 对应的 <code class="language-text">chunk src_bootstrap_js</code></li>\n<li><code class="language-text">container-reference/app2</code> 直接返回一个全局的 <code class="language-text">app2</code>，这里感觉和我们的 <code class="language-text">app2</code> 有关系</li>\n<li><code class="language-text">?8bfd</code> 这个字符串是我们上面提到的 <code class="language-text">app2/button</code> 对应的文件引用 <code class="language-text">id</code></li>\n</ol>\n<p>那在加载 src<em>bootstrap.js 之前加载的那些 react 文件还有 app2/button 文件都是谁做的呢？通过 debug，我们发现秘密就在 webpack</em>require__.e(“src<em>bootstrap</em>js”) 这句话</p>\n<blockquote>\n<p>实际上 webpck_require.e 就是去加载 chunk 的 js 文件 0.bundle.js，等到加载回来后它认为 bundle.js 里面的 modules 就一定会有了 0.bundle.js 包含的那些 modules</p>\n</blockquote>\n<p>也就是说原来的 webpack<em>require\\</em>_.e 平淡无奇，就是加载一个 script，以致于我们都不想去贴出它的代码，但是这次升级后一切变的不一样了，它成了关键中的关键！</p>\n<h3 id="webpackrequire_e-做了什么"><a href="#webpackrequire_e-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack<em>require\\</em>_.e 做了什么</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20131257874848240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`__webpack_require__.e = (chunkId) => {\n  return Promise.all(\n    Object.keys(__webpack_require__.f).reduce((promises, key) => {\n      __webpack_require__.f[key](chunkId, promises);\n      return promises;\n    }, [])\n  );\n};`, `20131257874848240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promises<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      __webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">,</span> promises<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> promises<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看代码，的确发生了变化，现在底层是去调用 webpack_require.f 上面的函数了，等到所有函数都执行完了，才执行 promise 的 then</p>\n<p>那问题的核心又变成了 webpack_require.f 上面有哪些函数了，最后发现有三个函数：</p>\n<h4 id="overridables"><a href="#overridables" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>overridables</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86447723100774510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/overridables */\n__webpack_require__.O = {};\nvar chunkMapping = {\n  src_bootstrap_js: [\'?a75e\', \'?6365\']\n};\nvar idToNameMapping = {\n  \'?a75e\': \'react-dom\',\n  \'?6365\': \'react\'\n};\nvar fallbackMapping = {\n  \'?a75e\': () => {\n    return __webpack_require__\n      .e(\'vendors-node_modules_react-dom_index_js\')\n      .then(() => () => __webpack_require__(\'./node_modules/react-dom/index.js\'));\n  },\n  \'?6365\': () => {\n    return __webpack_require__\n      .e(\'vendors-node_modules_react_index_js\')\n      .then(() => () => __webpack_require__(\'./node_modules/react/index.js\'));\n  }\n};\n__webpack_require__.f.overridables = (chunkId, promises) => {};`, `86447723100774510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/overridables */</span>\n__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?a75e\'</span><span class="token punctuation">,</span> <span class="token string">\'?6365\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?a75e\'</span><span class="token punctuation">:</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">,</span>\n  <span class="token string">\'?6365\'</span><span class="token punctuation">:</span> <span class="token string">\'react\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> fallbackMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?a75e\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'vendors-node_modules_react-dom_index_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./node_modules/react-dom/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">\'?6365\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'vendors-node_modules_react_index_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'./node_modules/react/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">overridables</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="remotes"><a href="#remotes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>remotes</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87788275568913290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/remotes loading */\nvar chunkMapping = {\n  src_bootstrap_js: [\'?ad8d\']\n};\nvar idToExternalAndNameMapping = {\n  \'?ad8d\': [\'?8bfd\', \'Button\']\n};\n__webpack_require__.f.remotes = (chunkId, promises) => {};`, `87788275568913290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/remotes loading */</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?ad8d\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToExternalAndNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?ad8d\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">remotes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="jsonp"><a href="#jsonp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsonp</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91078007672389940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/jsonp chunk loading */\nvar installedChunks = {\n  main: 0\n};\n\n__webpack_require__.f.j = (chunkId, promises) => {};`, `91078007672389940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/jsonp chunk loading */</span>\n<span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>\n  main<span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">j</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这三个函数我把核心部分节选出来了，其实注释也写得比较清楚了，我还是解释一下：</p>\n<ol>\n<li>overridables 可覆盖的，看代码你应该已经知道和 shared 配置有关</li>\n<li>remotes 远程的，看代码非常明显是和 remotes 配置相关</li>\n<li>jsonp 这个就是原有的加载 chunk 函数，对应的是以前的懒加载或者公共代码提取</li>\n</ol>\n<h3 id="加载流程"><a href="#%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载流程</h3>\n<p>知道了核心在 webpack_require.e 以及内部实现后，不知道你脑子里是不是对整个加载流程有了一定的思路，如果没有，容我来给你解析一下</p>\n<ol>\n<li>先加载 src_main.js，这个没什么好说的，注入在 html 里面的</li>\n<li>src<em>main.js 里面执行 webpack</em>require(“./src/index.js”)</li>\n<li>src/index.js 这个 module 的逻辑很简单，就是动态加载 src<em>bootstrap</em>js 这个 chunk</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 overridables，发现这个 chunk 依赖了 react、react-dom，那就看是否已经加载，没有加载就去加载对应的 js 文件，地址也告诉你了</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 remotes，发现这个 chunk 依赖了?ad8d，那就去加载这个 js</li>\n<li>动态加载 src<em>bootstrap</em>js 这个 chunk 时，经过 jsonp，就正常加载就好了</li>\n<li>所有依赖以及 chunk 都加载完成了，就去执行 then 逻辑：webpack<em>require src</em>bootstrap_js 里面的 module：./src/bootstrap.js</li>\n</ol>\n<p>到此就一切都正常启动了，其实就是我们之前提到的依赖前置，先去分析，然后生成配置文件，再去加载。</p>\n<p>看起来一切都很美好，但其实还是有一个关键信息没有解决！</p>\n<h3 id="如何知道-app2-的存在"><a href="#%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93-app2-%E7%9A%84%E5%AD%98%E5%9C%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何知道 app2 的存在</h3>\n<p>上面的第 4 步加载 react 的时候，因为我们自己实际上也打包了 react 文件，所以当没有加载的时候，我们可以去加载一份，也知道地址</p>\n<p>但是第五步的时候，当页面从来没有加载过 app2/Button 的时候，我们去什么地址加载什么文件呢？</p>\n<p>这个时候就要用到前面我们提到的 main.js 里面的 webpack_modules 了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81078615496656580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var __webpack_modules__ = {\n  \'container-reference/app2\': (module) => {\n    \'use strict\';\n    module.exports = app2;\n  },\n\n  \'?8bfd\': (module, __unused_webpack_exports, __webpack_require__) => {\n    \'use strict\';\n    var external = __webpack_require__(\'container-reference/app2\');\n    module.exports = external;\n  }\n};`, `81078615496656580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'container-reference/app2\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token string">\'?8bfd\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __unused_webpack_exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> external <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'container-reference/app2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> external<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里面有三个 module，我们还有 ?8bfd、container-reference/app2 没有用到，我们再看一下 remotes 的实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19040773322457506000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* webpack/runtime/remotes loading */\nvar chunkMapping = {\n  src_bootstrap_js: [\'?ad8d\']\n};\nvar idToExternalAndNameMapping = {\n  \'?ad8d\': [\'?8bfd\', \'Button\']\n};\n__webpack_require__.f.remotes = (chunkId, promises) => {\n  if (__webpack_require__.o(chunkMapping, chunkId)) {\n    chunkMapping[chunkId].forEach((id) => {\n      if (__webpack_modules__[id]) return;\n      var data = idToExternalAndNameMapping[id];\n      promises.push(\n        Promise.resolve(__webpack_require__(data[0]).get(data[1])).then((factory) => {\n          __webpack_modules__[id] = (module) => {\n            module.exports = factory();\n          };\n        })\n      );\n    });\n  }\n};`, `19040773322457506000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* webpack/runtime/remotes loading */</span>\n<span class="token keyword">var</span> chunkMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  src_bootstrap_js<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?ad8d\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> idToExternalAndNameMapping <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'?ad8d\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n__webpack_require__<span class="token punctuation">.</span>f<span class="token punctuation">.</span><span class="token function-variable function">remotes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> promises</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>chunkMapping<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    chunkMapping<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_modules__<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> data <span class="token operator">=</span> idToExternalAndNameMapping<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>\n        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          __webpack_modules__<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们加载 src<em>bootstrap</em>js 这个 chunk 时，经过 remotes，发现这个 chunk 依赖了?ad8d，那在运行时的时候：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80064421182893970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`id = \'?8bfd\';\ndata = [\'?8bfd\', \'Button\'];\n// 源码\n__webpack_require__(data[0]).get(data[1]);\n// 运行时\n__webpack_require__(\'?8bfd\').get(\'Button\');`, `80064421182893970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">id <span class="token operator">=</span> <span class="token string">\'?8bfd\'</span><span class="token punctuation">;</span>\ndata <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">,</span> <span class="token string">\'Button\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 源码</span>\n<span class="token function">__webpack_require__</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 运行时</span>\n<span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'?8bfd\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'Button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合 main.js 的 module ?8bfd 的代码，那最终就是 app2.get(“Button”)</p>\n<p>这不就是个全局变量吗？看起来有些蹊跷啊！</p>\n<h3 id="再看-app2remoteentryjs"><a href="#%E5%86%8D%E7%9C%8B-app2remoteentryjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再看 app2/remoteEntry.js</h3>\n<p>我们好像一直忽略了这个文件，它是第一个加载的，必然有它的作用，带着对全局 app2 有什么蹊跷的疑问，我们去看了这个文件，果然发现了玄机！</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36491545875633920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var app2;\napp2 = (() => {\n  \'use strict\';\n  var __webpack_modules__ = {\n    \'?8619\': (__unused_webpack_module, exports, __webpack_require__) => {\n      var moduleMap = {\n        Button: () => {\n          return __webpack_require__\n            .e(\'src_Button_js\')\n            .then(() => () => __webpack_require__(/*! ./src/Button */ \'./src/Button.js\'));\n        }\n      };\n      var get = (module) => {\n        return __webpack_require__.o(moduleMap, module)\n          ? moduleMap[module]()\n          : Promise.resolve().then(() => {\n              throw new Error(\'Module \' + module + \' does not exist in container.\');\n            });\n      };\n      var override = (override) => {\n        Object.assign(__webpack_require__.O, override);\n      };\n\n      __webpack_require__.d(exports, {\n        get: () => get,\n        override: () => override\n      });\n    }\n  };\n  return __webpack_require__(\'?8619\');\n})();`, `36491545875633920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> app2<span class="token punctuation">;</span>\napp2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'?8619\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> moduleMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n        <span class="token function-variable function">Button</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> __webpack_require__\n            <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'src_Button_js\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./src/Button */</span> <span class="token string">\'./src/Button.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> module<span class="token punctuation">)</span>\n          <span class="token operator">?</span> moduleMap<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token punctuation">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Module \'</span> <span class="token operator">+</span> module <span class="token operator">+</span> <span class="token string">\' does not exist in container.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">var</span> <span class="token function-variable function">override</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">override</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">,</span> override<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">,</span>\n        <span class="token function-variable function">override</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> override\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">\'?8619\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你细心看，就会发现，这个文件定义了全局的 app2 变量，然后提供了一个 get 函数，里面实际上就是去加载具体的模块</p>\n<p>所以 app2.get(“Button”) 在这里就变成了 app2 内部定义的 get 函数，随后执行自己的 webpack_require</p>\n<p>是不是有种焕然大悟的感觉！</p>\n<p>原来它是这样在两个独立打包的应用之间，通过全局变量去建立了一座彩虹桥！</p>\n<p>当然，app2/remoteEntry.js 是由 app2 根据配置打包出来的，里面实际上就是根据配置文件的导出模块，生成对应的内部 modules</p>\n<h3 id="你可能忽略的-bootstrapjs"><a href="#%E4%BD%A0%E5%8F%AF%E8%83%BD%E5%BF%BD%E7%95%A5%E7%9A%84-bootstrapjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>你可能忽略的 bootstrap.js</h3>\n<p>在入口文件 index.js 和真正的文件 app.js 之间多了一个 bootstrap.js，而且里面内容就是异步加载 app.js</p>\n<p>那这个文件是不是多余的，笔者试了一下，直接把入口换成 app.js 或者这里换成同步加载，整个应用就跑不起来了</p>\n<p>其实从原理上分析后也是可以理解的：</p>\n<p>因为依赖需要前置，并且等依赖加载完成后才能执行自己的入口文件，如果不把入口变成一个异步的 chunk，那如何去实现这样的依赖前置呢？毕竟实现依赖前置加载的核心是 webpack_require.e</p>\n<h2 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>\n<p>这里解决的主要是 2 个问题：</p>\n<ol>\n<li>如何解决依赖问题，这里的实现方式是重写了加载 chunk 的 webpack_require.e，从而前置加载依赖</li>\n<li>如何解决 modules 的共享问题，这里是使用全局变量来 hook</li>\n</ol>\n<p>这种实现方式的优缺点其实也明显：</p>\n<p>优点：做到代码的运行时加载，而且 shared 代码无需自己手动打包缺点：对于其他应用的依赖，实际上是强依赖的，也就是说 app2 有没有按照接口实现，你是不知道的</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Module federation 原理研究/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2020-07-10 15:29:05",path:"/module-federation-principle-research/",tags:"前端, 前端构建工具, webpack",title:"Module federation 原理研究",draft:null}}],length:11,tag:"前端构建工具",pagesSum:3,page:1}}}});