webpackJsonp([0x7b71d9db271c],{1333:function(n,s){n.exports={data:{site:{siteMetadata:{description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验 一期优化 主要针对 cra + webpack3/4 进行的优化 具体功能 cra 配置优化 核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度 config-overrides.js Dockerfile 配置缓存优化 需求背景 为了充分利用缓存，采用 docker…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验</p>\n<h1 id="一期优化"><a href="#%E4%B8%80%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一期优化</h1>\n<p>主要针对 cra + webpack3/4 进行的优化</p>\n<h2 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra-配置优化"><a href="#cra-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra 配置优化</h3>\n<p>核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度</p>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62812293517260410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   addWebpackModuleRule,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst HardSourceWebpackPlugin = require(\'hard-source-webpack-plugin\');\n\nconst packageJson = require(\'./package.json\');\nconst FixHardSourceWebpackPlugin = require(\'./plugins/FixHardSourceWebpackPlugin\');\n// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')\n// const smp = new SpeedMeasurePlugin()\n\n// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭\nconst { DISABLE_HARD_SOURCE_PLUGIN } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\n// 打印 webpack 的相关配置，便于调试\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\n// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.1.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\n// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nconst getHardSourceWebpackPlugins = (env) =>\n   !DISABLE_HARD_SOURCE_PLUGIN\n      ? [\n           addWebpackPlugin(\n              new HardSourceWebpackPlugin({\n                 // Either an absolute path or relative to webpack\'s options.context.\n                 cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}/[confighash]\\`),\n                 // Either a string of object hash function given a webpack config.\n                 configHash: (webpackConfig) => {\n                    // node-object-hash on npm can be used to build this.\n                    // 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存\n                    return require(\'node-object-hash\')({ sort: false }).hash({\n                       webpackConfig,\n                       dependencies: packageJson.dependencies\n                    });\n                 },\n                 // Either false, a string, an object, or a project hashing function.\n                 environmentHash: {\n                    root: process.cwd(),\n                    directories: [],\n                    files: []\n                 },\n                 // An object.\n                 info: {\n                    // \'none\' or \'test\'.\n                    mode: \'none\',\n                    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n                    level: \'debug\'\n                 },\n                 // Clean up large, old caches automatically.\n                 cachePrune: {\n                    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n                    // be at least this (default: 2 days) old in milliseconds.\n                    maxAge: 2 * 24 * 60 * 60 * 1000,\n                    // All caches together must be larger than \\`sizeThreshold\\` before any\n                    // caches will be deleted. Together they must be at least this\n                    // (default: 50 MB) big in bytes.\n                    sizeThreshold: 50 * 1024 * 1024\n                 }\n              })\n           ),\n           env === \'production\' &&\n              // 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明\n              addWebpackPlugin(\n                 new FixHardSourceWebpackPlugin({\n                    cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}\\`)\n                 })\n              )\n        ]\n      : [];\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            javascriptEnabled: true\n            // modifyVars: { \'@primary-color\': \'#1DA570\' }\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         addWebpackModuleRule({\n            // test: /StreamDataWorker\\.js/,\n            test: /(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/,\n            use: { loader: \'worker-loader\', options: { filename: \'worker.[hash].js\' } }\n         }),\n         // TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致\n         // addWebpackModuleRule({\n         //   test: /\\.worker\\.js\\$/,\n         //   use: { loader: \'worker-loader\' }\n         // }),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         // TODO 以下分包策略不是最优解\n         // isProd &&\n         //   setWebpackOptimizationSplitChunks({\n         //     chunks: \'all\',\n         //     maxInitialRequests: 10,\n         //     minSize: 0,\n         //     cacheGroups: {\n         //       vendor: {\n         //         test: module => {\n         //           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大\n         //           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {\n         //             return false\n         //           }\n         //           return /[\\\\/]node_modules[\\\\/]/.test(module.context)\n         //         },\n         //         name: module => {\n         //           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/)[1]\n         //           return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`\n         //         }\n         //       }\n         //     }\n         //   }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         // 显示编译进度\n         addWebpackPlugin(new WebpackBarPlugin()),\n         ...getHardSourceWebpackPlugins(env)\n      )(config);\n\n      // 注入 thread-loader\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      // 限制编译范围\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n\n      // 本地开发采用更轻量级的 cheap-module-eval-source-map\n      if (!isProd) {\n         localConfig.devtool = \'cheap-module-eval-source-map\';\n      }\n\n      // if (isProd) {\n      //   localConfig.optimization = {\n      //     ...localConfig.optimization,\n      //     nodeEnv: \'production\',\n      //     sideEffects: true,\n      //     concatenateModules: true,\n      //     runtimeChunk: \'single\'\n      //   }\n      // }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.quiet = false;\n\n      // 显示构建耗时\n      config.stats = {\n         errors: true,\n         children: false,\n         warnings: false,\n         colors: true,\n         assets: false,\n         modules: false,\n         entrypoints: false\n      };\n\n      // 关闭 host 检测，以免非 localhost 域名访问时热更新不生效\n      config.disableHostCheck = true;\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `62812293517260410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   addWebpackModuleRule<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> HardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'hard-source-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> FixHardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/FixHardSourceWebpackPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')</span>\n<span class="token comment">// const smp = new SpeedMeasurePlugin()</span>\n\n<span class="token comment">// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 打印 webpack 的相关配置，便于调试</span>\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数</span>\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.1.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分</span>\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getHardSourceWebpackPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token operator">!</span><span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span>\n      <span class="token operator">?</span> <span class="token punctuation">[</span>\n           <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n              <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                 <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n                 cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/[confighash]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n                 <span class="token function-variable function">configHash</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n                    <span class="token comment">// 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存</span>\n                    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                       webpackConfig<span class="token punctuation">,</span>\n                       dependencies<span class="token punctuation">:</span> packageJson<span class="token punctuation">.</span>dependencies\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n                 environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// An object.</span>\n                 info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// \'none\' or \'test\'.</span>\n                    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n                    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n                    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Clean up large, old caches automatically.</span>\n                 cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n                    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n                    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n                    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n                    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n                    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n                    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>\n                 <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n           <span class="token punctuation">)</span><span class="token punctuation">,</span>\n           env <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">&amp;&amp;</span>\n              <span class="token comment">// 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明</span>\n              <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n                 <span class="token keyword">new</span> <span class="token class-name">FixHardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">)</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token comment">// modifyVars: { \'@primary-color\': \'#1DA570\' }</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackModuleRule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// test: /StreamDataWorker\\.js/,</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">{</span> loader<span class="token punctuation">:</span> <span class="token string">\'worker-loader\'</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">\'worker.[hash].js\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致</span>\n         <span class="token comment">// addWebpackModuleRule({</span>\n         <span class="token comment">//   test: /\\.worker\\.js$/,</span>\n         <span class="token comment">//   use: { loader: \'worker-loader\' }</span>\n         <span class="token comment">// }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 以下分包策略不是最优解</span>\n         <span class="token comment">// isProd &amp;&amp;</span>\n         <span class="token comment">//   setWebpackOptimizationSplitChunks({</span>\n         <span class="token comment">//     chunks: \'all\',</span>\n         <span class="token comment">//     maxInitialRequests: 10,</span>\n         <span class="token comment">//     minSize: 0,</span>\n         <span class="token comment">//     cacheGroups: {</span>\n         <span class="token comment">//       vendor: {</span>\n         <span class="token comment">//         test: module => {</span>\n         <span class="token comment">//           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大</span>\n         <span class="token comment">//           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {</span>\n         <span class="token comment">//             return false</span>\n         <span class="token comment">//           }</span>\n         <span class="token comment">//           return /[\\\\/]node_modules[\\\\/]/.test(module.context)</span>\n         <span class="token comment">//         },</span>\n         <span class="token comment">//         name: module => {</span>\n         <span class="token comment">//           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/)[1]</span>\n         <span class="token comment">//           return `npm.${packageName.replace(\'@\', \'\')}`</span>\n         <span class="token comment">//         }</span>\n         <span class="token comment">//       }</span>\n         <span class="token comment">//     }</span>\n         <span class="token comment">//   }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 显示编译进度</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token operator">...</span><span class="token function">getHardSourceWebpackPlugins</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 注入 thread-loader</span>\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 限制编译范围</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>mainFields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'jsnext:main\'</span><span class="token punctuation">,</span> <span class="token string">\'main\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 本地开发采用更轻量级的 cheap-module-eval-source-map</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>devtool <span class="token operator">=</span> <span class="token string">\'cheap-module-eval-source-map\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// if (isProd) {</span>\n      <span class="token comment">//   localConfig.optimization = {</span>\n      <span class="token comment">//     ...localConfig.optimization,</span>\n      <span class="token comment">//     nodeEnv: \'production\',</span>\n      <span class="token comment">//     sideEffects: true,</span>\n      <span class="token comment">//     concatenateModules: true,</span>\n      <span class="token comment">//     runtimeChunk: \'single\'</span>\n      <span class="token comment">//   }</span>\n      <span class="token comment">// }</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>quiet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 显示构建耗时</span>\n      config<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n         errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 关闭 host 检测，以免非 localhost 域名访问时热更新不生效</span>\n      config<span class="token punctuation">.</span>disableHostCheck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dockerfile-配置缓存优化"><a href="#dockerfile-%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 配置缓存优化</h3>\n<h4 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了充分利用缓存，采用 docker 的缓存策略</p>\n<h4 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h4>\n<p><a href="/docker-introduce-learning/">Docker 入门学习</a></p>\n<h4 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h4>\n<p>这里的主要问题在于一旦改了源码需要编译的时候，缓存失效了</p>\n<p>原因是标红行部分复制了文件，再进行构建的时候，因为已经是新的文件了，所以这里 build 的时候不能使用缓存</p>\n<p>Dockerfile-client</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45837289313485650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:14-alpine as builder\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry https://registry.npmmirror.com\n\nWORKDIR /home/\n\n# 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install\nCOPY package.json package-lock.json ./\n# 安装依赖\nRUN npm i\n\n# 复制剩余文件\nCOPY . .\n\nRUN ls && npm run build && ls\n\nFROM nginx:alpine\nCOPY --from=builder /home/build /usr/share/nginx/html/\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `45837289313485650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{14}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install</span>\n<span class="token keyword">COPY</span> package.json package<span class="token punctuation">-</span>lock.json ./\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> npm i\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">COPY</span> . .</span>\n<span class="token keyword">RUN</span> ls &amp;&amp; npm run build &amp;&amp; ls\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /home/build /usr/share/nginx/html/\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h4>\n<p>由于第一版的问题，所以需要想办法在 build 过程中也要尽可能的使用缓存</p>\n<p>这里由于缓存容易损坏（由上面提到的 hard-source-webpack-plugin 造成），需要给缓存一个版本的概念，同时也要控制是否使用缓存</p>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1811633388329370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖同时读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\n# build 并读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\n# 以下是二阶段\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `1811633388329370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="token keyword">RUN</span> pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖同时读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token comment"># build 并读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token comment"># 以下是二阶段</span>\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最终采用第二版，同时为了减少构建上下文，需要添加如下的文件</p>\n<p>.dockerignore</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13051189363110361000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`*\n# 静态文件\n!public\n# 为了兼容老版本的 jenkins 不报错，实际上不该加\n!build\n\n# 源码\n!src\n\n# 构建相关\n!.env.production\n!config-overrides.js\n!plugins\n!scripts\n\n# 依赖库\n!package.json\n!pnpm-lock.yaml\n\n# nginx\n!nginx.conf`, `13051189363110361000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">*\n<span class="token comment"># 静态文件</span>\n!public\n<span class="token comment"># 为了兼容老版本的 jenkins 不报错，实际上不该加</span>\n!build\n\n<span class="token comment"># 源码</span>\n!src\n\n<span class="token comment"># 构建相关</span>\n!.env.production\n!config<span class="token punctuation">-</span>overrides.js\n!plugins\n!scripts\n\n<span class="token comment"># 依赖库</span>\n!package.json\n!pnpm<span class="token punctuation">-</span>lock.yaml\n\n<span class="token comment"># nginx</span>\n!nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="调用"><a href="#%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用</h4>\n<ol>\n<li><code class="language-text">BUILDKIT_CACHE_MOUNT_NS</code> 就类似于缓存版本的概念</li>\n<li>可以传入 <code class="language-text">--no-cache</code> 来控制不使用缓存，默认使用（这里的 docker 18 版本的 <code class="language-text">--no-cache</code> 不对 <code class="language-text">type=cache</code> 生效，20 版本的反而生效）</li>\n<li>以上 2 个参数可以配合 jenkins 来控制</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59618133001981310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;build&quot;: &quot;node scripts/build.js&quot;,\n      &quot;docker:build&quot;: &quot;DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit .&quot;,\n      &quot;docker:run&quot;: &quot;docker run -it -p 3000:3000 --rm frontend&quot;,\n      &quot;docker:start&quot;: &quot;npm run docker:build && npm run docker:run&quot;\n   }\n}`, `59618133001981310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:build"</span><span class="token operator">:</span> <span class="token string">"DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit ."</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:run"</span><span class="token operator">:</span> <span class="token string">"docker run -it -p 3000:3000 --rm frontend"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:start"</span><span class="token operator">:</span> <span class="token string">"npm run docker:build &amp;&amp; npm run docker:run"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-切换到-pnpm"><a href="#npm-%E5%88%87%E6%8D%A2%E5%88%B0-pnpm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 切换到 pnpm</h3>\n<h4 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在公司的 jenkins 平台上打包时发现 npm install 的过程特别慢，主要是老项目的依赖库太多，故考虑转向安装速度更快的 pnpm</p>\n<h4 id="实现方式"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>因为老项目里面已有 package-lock.json，所以通过 <code class="language-text">pnpm import</code> 可以实现一键迁移，当然有些三方库使用错误导致白屏，这些库需要特殊处理</li>\n<li>配合上面的 dockerfile 可实现深度缓存</li>\n<li>由于上面提到的是否使用缓存一部分是由 package.json 里面的 dependencies 决定，所以需要规范 dependencies 的用法</li>\n</ol>\n<h3 id="npm-install-校验命令"><a href="#npm-install-%E6%A0%A1%E9%AA%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm install 校验命令</h3>\n<h4 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了统一库的安装工具，防止团队成员使用别的库安装工具</p>\n<h4 id="实现方式-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>通过 volta 限制只能使用 pnpm（截止 2022-11-21 11:21:42 <a href="https://github.com/volta-cli/volta/issues/737" target="_blank" rel="nofollow noreferrer noopener">不支持 pnpm</a>）</li>\n<li>手动写 hook 脚本</li>\n</ol>\n<p>最终 2 种方式都采用</p>\n<h4 id="volta"><a href="#volta" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volta</h4>\n<p>安装过程见 <a href="/frontend-devlopment-environment-setting/#volta">volta</a></p>\n<p>同时在 package.json 加如下几行，这样切入项目目录就会自动切换构建工具</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57084537982153230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;volta&quot;: {\n      &quot;node&quot;: &quot;14.20.0&quot;,\n      &quot;pnpm&quot;: &quot;7.14.1&quot;\n   }\n}`, `57084537982153230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"volta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"14.20.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm"</span><span class="token operator">:</span> <span class="token string">"7.14.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="hook-脚本"><a href="#hook-%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook 脚本</h4>\n<p>scripts/node-check-version.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83774544223660820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { exec } = require(\'child_process\');\nexec(\'node -v\', (err, stdout) => {\n   if (err) throw err;\n   if (parseInt(stdout.slice(1)) !== 14) {\n      // NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.\n      throw new Error(\\`[ERROR] You need node version @=14 but you have \\${stdout}\\`);\n   }\n});`, `83774544223660820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'node -v\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need node version @=14 but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/only-allow.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81810349593333450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const pmFromUserAgent = (userAgent) => {\n   const pmSpec = userAgent.split(\' \')[0];\n   const separatorPos = pmSpec.lastIndexOf(\'/\');\n   return {\n      name: pmSpec.substr(0, separatorPos),\n      version: pmSpec.substr(separatorPos + 1)\n   };\n};\n\nif (!process.env.npm_config_user_agent) {\n   throw new Error(\'[ERROR] Please check your npm!\');\n}\n\nconst [name, version] = process.argv.slice(2);\n\nconst pm = pmFromUserAgent(process.env.npm_config_user_agent);\n\nif (name !== pm.name) {\n   const errors = [\\`[ERROR] You need \\${name}\\`];\n\n   const urlMap = {\n      pnpm: \'https://pnpm.js.org/\',\n      yarn: \'https://yarnpkg.com/\'\n   };\n\n   if (urlMap[name]) {\n      errors.push(\\`Please go to \\${urlMap[name]}\\`);\n   }\n\n   throw new Error(errors.join(\', \'));\n}\n\nif (parseFloat(pm.version) < version) {\n   throw new Error(\\`[ERROR] You need \\${name} version @>=\\${version} but you have \\${pm.version}\\`);\n}`, `81810349593333450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">pmFromUserAgent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userAgent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> pmSpec <span class="token operator">=</span> userAgent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> separatorPos <span class="token operator">=</span> pmSpec<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorPos<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      version<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>separatorPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'[ERROR] Please check your npm!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> version<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> pm <span class="token operator">=</span> <span class="token function">pmFromUserAgent</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> pm<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> urlMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n      pnpm<span class="token punctuation">:</span> <span class="token string">\'https://pnpm.js.org/\'</span><span class="token punctuation">,</span>\n      yarn<span class="token punctuation">:</span> <span class="token string">\'https://yarnpkg.com/\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please go to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\', \'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> version @>=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pm<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94203682675499520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;preinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;node-check-version&quot;: &quot;node scripts/node-check-version.js&quot;,\n      &quot;only-allow&quot;: &quot;node scripts/only-allow.js pnpm 7&quot;,\n      &quot;pnpm:devPreinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;verify-version&quot;: &quot;npm run node-check-version && npm run only-allow&quot;\n   }\n}`, `94203682675499520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"preinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"node-check-version"</span><span class="token operator">:</span> <span class="token string">"node scripts/node-check-version.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"only-allow"</span><span class="token operator">:</span> <span class="token string">"node scripts/only-allow.js pnpm 7"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm:devPreinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"verify-version"</span><span class="token operator">:</span> <span class="token string">"npm run node-check-version &amp;&amp; npm run only-allow"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里要注意，由于 pnpm 下的 preinstall 是 install 后才执行的，所以增加了 <code class="language-text">pnpm:devPreinstall</code>，同时生产环境通过添加 <code class="language-text">--ignore-scripts=true</code> 参数不运行此钩子</p>\n<p>以上就可以限制只能通过 pnpm 来进行 install（以上脚本还限制了版本）</p>\n<h3 id="hard-source-webpack-plugin-的线上修复"><a href="#hard-source-webpack-plugin-%E7%9A%84%E7%BA%BF%E4%B8%8A%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hard-source-webpack-plugin 的线上修复</h3>\n<h4 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在使用了 hard-source-webpack-plugin 作缓存加速时，有以下比较明显的问题</p>\n<ol>\n<li>二次编译有时不能正常停止</li>\n<li>二次编译会出现各种编译报错，清空缓存后重新编译却正常</li>\n</ol>\n<h4 id="实现方式-2"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<p>针对以上问题，有以下解决方式</p>\n<ol>\n<li>二次编译时识别到 done 即编译完成，此时调用 <code class="language-text">process.exit(0)</code> 手动结束</li>\n<li>二次编译时一旦编译报错则认为是缓存损坏，此时清空缓存，重启 build 命令</li>\n</ol>\n<p>scripts/const.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77490622791515930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const CACHE_ERROR_CODE = 10;\n\nmodule.exports = {\n   CACHE_ERROR_CODE\n};`, `77490622791515930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token constant">CACHE_ERROR_CODE</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39136700923904090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nconst { CACHE_ERROR_CODE } = require(\'./const\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'react-app-rewired\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      // 接受到缓存损坏信号，重启命令\n      if (code === CACHE_ERROR_CODE) {\n         spawn(mainModule);\n         // 除了正常停止的 0 外，其他错误码均认为异常\n      } else if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--max-old-space-size=4096\', \'build\']);`, `39136700923904090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'react-app-rewired\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 接受到缓存损坏信号，重启命令</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">spawn</span><span class="token punctuation">(</span>mainModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 除了正常停止的 0 外，其他错误码均认为异常</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--max-old-space-size=4096\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>plugins/FixHardSourceWebpackPlugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75361992489505820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rimraf = require(\'rimraf\');\nconst { get } = require(\'lodash\');\nconst { CACHE_ERROR_CODE } = require(\'../scripts/const\');\n\nclass FixHardSourceWebpackPlugin {\n   constructor(options) {\n      this.options = options || {};\n      // 是否读取了上次的缓存\n      this.cacheRead = false;\n   }\n\n   apply(compiler) {\n      compiler.hooks.hardSourceLog.tap(\'hardSourceLog\', (message) => {\n         // eslint-disable-next-line no-useless-call\n         // console[message.level].call(console, message)\n\n         const id = get(message, \'data.id\');\n\n         if (id === \'confighash--reused\') {\n            this.cacheRead = true;\n         }\n      });\n\n      const handleClearCache = () => {\n         // 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令\n         // 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令\n         const { cacheDirectory } = this.options;\n         console.log(\'[FixHardSourceWebpackPlugin] Clearing Cache\', cacheDirectory);\n         rimraf.sync(cacheDirectory);\n         console.log(\'[FixHardSourceWebpackPlugin] Cache Cleared\');\n         if (this.cacheRead) {\n            console.log(\'[FixHardSourceWebpackPlugin] Restarting...\');\n            process.exit(CACHE_ERROR_CODE);\n         }\n      };\n\n      // 找不到具体的模块时会调用，比如随便导入一个不存在的模块\n      // import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）\n      compiler.hooks.failed.tap(\'FixHardSourceWebpack Cache Error\', () => {\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Failed\');\n         handleClearCache();\n      });\n\n      // 导出一个不存在的模块并使用时会调用\n      // import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）\n      compiler.hooks.done.tap(\'FixHardSourceWebpack Cache Error\', (stats) => {\n         const hasErrors = stats.hasErrors();\n         if (!hasErrors) {\n            return;\n         }\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Done\');\n         handleClearCache();\n      });\n\n      compiler.hooks.done.tap(\'FixHardSourceWebpackPlugin Force Stop\', (stats) => {\n         if (!this.cacheRead) {\n            return;\n         }\n\n         // 编译完成强制结束\n         // HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因\n         setTimeout(() => {\n            console.log(\'[FixHardSourceWebpackPlugin] Force Stop\');\n            process.exit(0);\n         });\n      });\n   }\n}\n\nmodule.exports = FixHardSourceWebpackPlugin;`, `75361992489505820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'rimraf\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">FixHardSourceWebpackPlugin</span> <span class="token punctuation">{</span>\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否读取了上次的缓存</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>hardSourceLog<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'hardSourceLog\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// eslint-disable-next-line no-useless-call</span>\n         <span class="token comment">// console[message.level].call(console, message)</span>\n\n         <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">\'data.id\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">\'confighash--reused\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">handleClearCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令</span>\n         <span class="token comment">// 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Clearing Cache\'</span><span class="token punctuation">,</span> cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Cache Cleared\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Restarting...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 找不到具体的模块时会调用，比如随便导入一个不存在的模块</span>\n      <span class="token comment">// import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>failed<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Failed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 导出一个不存在的模块并使用时会调用</span>\n      <span class="token comment">// import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> hasErrors <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasErrors<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Done\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpackPlugin Force Stop\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 编译完成强制结束</span>\n         <span class="token comment">// HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因</span>\n         <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Force Stop\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> FixHardSourceWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="后续问题"><a href="#%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续问题</h4>\n<p>在代码变动之后，如果通过缓存生成，查看编译后的代码还是之前的老代码，需要暂时关闭缓存待以后解决</p>\n<h3 id="preload-webpack-plugin-失效处理"><a href="#preload-webpack-plugin-%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>preload-webpack-plugin 失效处理</h3>\n<h4 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>此插件在 pnpm 下不生效，在 npm 下反而生效</p>\n<h4 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>require 指向的 html-webpack-plugin 不是同一个，导致 hook 不能被调用，具体见 <a href="https://github.com/jantimon/html-webpack-plugin/issues/1091#issuecomment-434708455" target="_blank" rel="nofollow noreferrer noopener">issue</a></p>\n<h4 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>升级到 3.0.0-beta.4 即可，对比可知源码做了以上处理</p>\n<p>3.0.0-beta.3 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64781096262405320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n   hook = HtmlWebpackPlugin.getHooks(compilation).beforeEmit;\n}`, `64781096262405320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>3.0.0-beta.4 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6950230089163334000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const [HtmlWebpackPlugin] = compiler.options.plugins.filter(\n      (plugin) => plugin.constructor.name === \'HtmlWebpackPlugin\'\n   );\n   assert(HtmlWebpackPlugin, \'Unable to find an instance of \' + \'HtmlWebpackPlugin in the current compilation.\');\n   hook = HtmlWebpackPlugin.constructor.getHooks(compilation).beforeEmit;\n}`, `6950230089163334000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>HtmlWebpackPlugin<span class="token punctuation">]</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'HtmlWebpackPlugin\'</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">assert</span><span class="token punctuation">(</span>HtmlWebpackPlugin<span class="token punctuation">,</span> <span class="token string">\'Unable to find an instance of \'</span> <span class="token operator">+</span> <span class="token string">\'HtmlWebpackPlugin in the current compilation.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包失效问题"><a href="#%E5%88%86%E5%8C%85%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包失效问题</h3>\n<h4 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>发现分包结果和原来的不一致，比原来大很多，比如看下面的三方库</p>\n<p>原来的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.109375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACzElEQVQozyWS3U/TYBjF+9fpFcEbidyYkHihRi4wYQZkJopOiLoZxAuixjgBIcBwDANMPgZzMka3dd3Wteu6dt9rN9rStesnq+8kOTl5b05+53meF2rz7TIRrjWqgiRdyp2OIvcM/VpXmgbU0zTbttuRUGnGWV1w456X9W+fClMOdOIxxPIXxXoTeNc0ZENTDV1XFE2WdUXWgcsKcMu2iz9Xo7dv4I4H2OQoPfs8eutm4s4gRDfbZJ1jOyona62u0ZZ1QVR4QRZFRRT6EgS5Y9jMr03k3hA17Ug7xxq+FXp1kV72QpVGJZsnUtkMXiA5gQdkQ1X1rnLNt0BzVe3ZNrfrz43eLbyawB33xd2tWjhUOdiDeJHNEjkYSWbwXDKDFhma51i2Vm2Uy1y9ZqndnmH0Z0aR4rKX8W9UAv7GD+/v4UH44Qh00a7ieRzNZnIE0eBYSZKuDMPS+3wTrMo0LQuMbGcZYWmPDEQqgaRIhs9pj4tZmIOENotl0vD5eSqZJAmiWqmUaJoiSapQkESxZ1m60Q9vR+qjc1nPWml2tYzGClzkqHh8CKlCmSKwDILkMQyNxxmKUjuS1pEMcDNd72mqrvVrb582nO6zue/E2y0+thaMPhpBpsYhvlnEM2g6kcihKN9sSjwvtDgTjKpplqqCbZmGCcJp+mIjiO3+YfaxS+rwGH06RrpdEM82MTQVPzsDWBLDSBwvUQVd7lyHLU29svpkisf9+fW9UuCQDZYYWIxFm7G/kCQIoDACw9lUCkujaDJBkyQg26ZxLfNKB+Gj1sFYevQ1/uJdzRMNf8WmnbBrEpBLmRRydnqKJOLJOExTxVq5fMnzWv/O4HspiqpYVi/UDD3LTs0T772tlZOtuZ2hgdXhAcgfRtb2Y0s7kZXgKZAvFPefJH1H8MZ/gcd6CN48SX0Ibo/755/4Ps7sry0sLn558eazy/0P0amGPG/S4poAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 51 16" title="" data-src="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png" data-srcset="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a67b7.png 200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-0b187.png 400w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png 800w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-b1a91.png 1200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>新的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.9375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/klEQVQ4y02SW4+bVhDH+ez5AH1oVGkbrZRKURsp6UMeojbVpvJmk+zaqzX3A4eDuWPAcLituRiMoYOdh0o/Hc+5zMx//oYpn6uALAtf7o+ncRimcQTG0+n/nIYBgNu+7/ZV1QbbVsetbTBFvrdW73z+43a7y2nynOdFlrZVNZ1fj8fjD6B23499P01T8fiwe/+2+HbLFEkSRzQMdnkSd01zqCqga+pT2w59d2zqY9sMh3Y4HGbgcBzpzd/+1c/xh3cMjXeOsQlcp2vaoeuPhw7ogfbQd31X11Bxji807XE4pYub4LdX8fvfGdeLdMP3gyxJ63BXxrRKs4ZeKA4J3dO0umzhPKZ1UXXZ7U30+tf04ZZ5LosoCJM4oQmID9umuRg2OzednRtO02kERmCAaKp0rV4tvYwwZRYRrEiiJAoCwdh1nK3vA67r+J7ruS7EnufpOnFs27Es23HqwJuI+d3/xHT73CRYU1SiKERVkSBgRQFknscISTyvyjLwuFwiUZQ4FhOS3H3Orq8X5E/mUHiegU19Y+m6Z9uB60bbLRA4TggSbDv03NDzbMOAK9+yYkqTxT/JLy/vzY9MHnmKwCGBlzhOV9Ut5HgepPlQaF4tyAGgNFxB8jYI6ZfPyasr2bpj2n1pEg0EAzqG6aVLDCJBPBTVkAz6n1YrVZIQTIG14u7f9M31XpaYag/mwQNZQUjDWFUUnRAAAk3TYCXwo2F2vcZQEcmw2RlWpHt0dc+UaWRuCLwALMNIkyTPsiLLMkrzecnSLAfCaEdpGidpllJWyz7JvbP4yjRlBm7PVivKRpv1G4QA85YQpGqqpqtYX7MCnMhINU3jw13w4o1tIpupy4IgBBMqMCTIOv9DWJYlnoNZWE7kRQR8u18KggQlVKwuHsOf3loE+3OycW4IVkNn7dwfOmsI6RqREYa2wNOaRyqRkLrZ6It1cvUX3Sx5pioLTZkbwveAJElkWfgkQIXIcZIorqGzIHOC9PX7A8/y6zUHnt6y8R9fMvdJ+A+6oH9QRieClwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 52 53" title="" data-src="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png" data-srcset="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a67b7.png 200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-0b187.png 400w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png 800w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-b1a91.png 1200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-1"><a href="#%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>经分析 treeShaking 失效，说明 main 没有识别到 es6 的语法</p>\n<h4 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>需要注释掉 mainFields 这一行，默认 cra 已做了 es6 语法的处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73805684680100300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];`, `73805684680100300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="修复-fastrefresh-在-worker-报错"><a href="#%E4%BF%AE%E5%A4%8D-fastrefresh-%E5%9C%A8-worker-%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 fastRefresh 在 worker 报错</h3>\n<h4 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>如果一个文件导出函数时被前端代码和 worker 同时使用时报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.986754966887418%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY0yWNyXKEIBQA/f/fSg6zqUQYXHgEcMFlxBGUaGUuMUlVV9+6OrCrX8xkWNmgvA2pjNLwQuIL+TghGmVpAvhGgUBXaj/OfrKLmVczu8d0ENhlneZF905gzqOUJsAwpAmjcabKBy5qlCoKTSF0IdvDVfeUjRntPrrvv9h5Y7eBQndFFcnziBBEUYjjECdJxnjFpGZC87IDqZt+1oPtzDJMa+CO2PrBeJ2L4hxnMaWn+H4j17fz7f1KUIrvgCi/F4qyimSCq6HsnqIZK21+z7Pzzm1TP+aF4KA4V/BZ5iBB1VzWqmrduttlP3zgt9f69fr3D+qQCTlnM4VyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 58 09" title="" data-src="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" data-srcset="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-765e7.png 200w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-c9f48.png 400w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-2"><a href="#%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>在 development 模式下，如果一个文件里面的 function 同时被 worker 和前端文件使用（即被前端的 <code class="language-text">babel-loader/react-refresh</code> 处理过，此时就有了 fastRefresh 的插件代码），而 fastRefresh 里面没有针对 worker 运行环境的处理，此时会报错</p>\n<h4 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h4>\n<p>需要对 <code class="language-text">$RefreshReg$</code> 做兼容处理，即确保只在开发环境的 worker 添加以下代码（注意这里的代码必须写成单独的文件并使用 import 放在 worker 的第一行，否则会因为执行时机的问题不起作用）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65472084563574450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global.\\$RefreshReg\\$ = () => {};\nglobal.\\$RefreshSig\\$ = () => {};`, `65472084563574450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">global<span class="token punctuation">.</span><span class="token function-variable function">$RefreshReg$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nglobal<span class="token punctuation">.</span><span class="token function-variable function">$RefreshSig$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ol>\n<li>不对 worker 文件做 babel 处理（此方案改动较大，不现实）</li>\n<li>\n<p>在 worker-loader 前插入新的 loader，此 loader 插入以上代码，注意只在 development 环境插入一行代码</p>\n<ol>\n<li>找现成的插入代码的 loader</li>\n<li>自己写 loader</li>\n</ol>\n</li>\n</ol>\n<h3 id="懒编译"><a href="#%E6%87%92%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒编译</h3>\n<h4 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>目前老项目在开发模式下全量编译过慢，而有时只需要开发少数几个页面</p>\n<h4 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h4>\n<p>因老项目使用的是 webpack4，历史代码太多不好升级，所以需要通过模仿 webpack5 的懒编译实现，有以下几个选型</p>\n<ol>\n<li><a href="https://github.com/bahmutov/web-packing" target="_blank" rel="nofollow noreferrer noopener">web-packing</a> 实现了网络请求来打包对应组件，实现思路类似懒编译，但和理想中的相差较远</li>\n<li><a href="https://github.com/sysgears/webpack-virtual-modules" target="_blank" rel="nofollow noreferrer noopener">webpack-virtual-modules</a> 实现了在内存中动态创建文件，但需要重新开始写懒编译效果</li>\n<li><a href="https://github.com/lisiyizu/vue-dynamic-module-example" target="_blank" rel="nofollow noreferrer noopener">vue-dynamic-module-example</a> 实现了在 vue 中懒编译文件，但只能在命令行中指定要编译哪些模块，不能从网络请求来决定编译哪些模块</li>\n<li><a href="https://github.com/liximomo/lazy-compile-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-compile-webpack-plugin</a> 基本实现了根据请求来编译对应页面的效果，但请求一个页面会触发多次编译，且二次请求这个页面还会触发编译</li>\n<li><a href="https://github.com/devtreehouse/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a> 修复以上问题，但在老项目里面运行会出现循环依赖的报错</li>\n<li><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">towavephone/lazy-build-webpack-plugin</a> 修复循环依赖问题</li>\n</ol>\n<h4 id="具体实现"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实现</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98146652116223670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const LazyBuildWebpackPlugin = require(\'@towavephone/lazy-build-webpack-plugin\');\n\nconst { LAZY_BUILD } = process.env;\n\n// 默认不开启懒编译\nLAZY_BUILD &&\n   addWebpackPlugin(\n      // 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下\n      // https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15\n      new LazyBuildWebpackPlugin({\n         ignores: [/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/]\n      })\n   );`, `98146652116223670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> LazyBuildWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@towavephone/lazy-build-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\n<span class="token comment">// 默认不开启懒编译</span>\n<span class="token constant">LAZY_BUILD</span> <span class="token operator">&amp;&amp;</span>\n   <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token comment">// 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下</span>\n      <span class="token comment">// https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15</span>\n      <span class="token keyword">new</span> <span class="token class-name">LazyBuildWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ignores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5655476261517256000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主入口需要加这几行代码，否则懒编译完成后页面不刷新\nif (module.hot) {\n   module.hot.accept();\n}`, `5655476261517256000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主入口需要加这几行代码，否则懒编译完成后页面不刷新</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编译效果"><a href="#%E7%BC%96%E8%AF%91%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译效果</h4>\n<ol>\n<li>懒编译开启前，即全量编译．时长在 3 分钟左右</li>\n<li>懒编译开启后，即单页面编译，随机挑选一个页面，时长在 20 秒左右</li>\n</ol>\n<h4 id="源码解析"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h4>\n<p><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a></p>\n<h3 id="jenkins-编译速度优化"><a href="#jenkins-%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jenkins 编译速度优化</h3>\n<p><a href="/jenkins-build-speed-optimize/">原文链接</a></p>\n<h2 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<h3 id="生产环境"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p>只算前端编译过程，原来的正在用的前端编译时间 9 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-602dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.15426781519186%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABlUlEQVQoz01RC8+cIBD0//+0Jl++tPf0TgVUFHycb/T0dLpim5aELLO7LDODUzcN4kTCjCP29VlXLOvnX9z+x8f5Pc9YPkdtz8/LYvG6bXDwZ/0tNm2LMIowThParkPf9+BCoKNzW70wUGSc25oxhvYIxjh0lmGjOU7TDyirClmeoyhLJDrFk/tIiwxZVSAi/NgxbeZ5kIEHEQskuUZKW5UZ/JAhVokl5cjiBS5T1E1tpYS9wr3jYFOKcKXmUcI1Efz8QfmQoocH1fc8X5Ttu/cCbEiwkkKnHSfokqSYwUqXU24bxKIRbQX4mxiaGPzl4dmH4CXFIQSjvPhoiFnDJcxNenhY9QYiUSS3wPR+g7USp2q/TKymBG4rCPt46hsxExTvuNBwl87+JOENMc61B6+J7B84r45MlwmUVvZD3JzhS13oko9by/GLpP6QJ5zDn7jQ4Gt8xre64lQ+qc5wrQJ86StuRXAwrIcRgjxs2gaEEZsMt91DkrR7FOwsycMgc+HSI0y7lqk/JiQ5A5/V0b97SAN+AyGCWTyEvk29AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 27 36" title="" data-src="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-fee1c.png" data-srcset="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-a67b7.png 200w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-0b187.png 400w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-fee1c.png 800w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-b1a91.png 1200w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-602dc.png 1277w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>优化缓存过后，分 2 种情况，初次编译完全无缓存的情况下编译时间 8 分钟，第二次有缓存的情况下 3 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABUUlEQVQoz22R6W6DQAyEef/Hq6oCCTfhhnAEWEiAr2bTSv1RS6MZjb22VzbariUIQ7I8Zzt29uNg5+CM/XirQ+tf781nbD/5v57BPzGpmTTPWNaV4THQC9bnKkMzZqU4l2iaWrwnVV2hloVu6CmrEuPs/ZJJwzTSivmYJ5q25cu0uLcdwzhK05FatGlftJdXNUGc8JhmbkkqA3ryosSXnxpz01BFMYXrUAe+ICDxL3jXTyLfJokdUoHvWjiXT26BTSh5+2rpvGN/ELimrjlhPGR609zJ0oRlUezbRjSmmIOHO8WEr1zDm29Y/ds7tafebA0+zhgRrJkgxaiHkfze0/Ud6+spB4F4LrDGUB6lRHulcerLHOMKn/qX7SnCnRPCrdQwntuLtu8pykIf4ZCLxargawzwlpTwkMK9xBVtTaFmRza7qpvOm1LnqIRgK/DlJ99HFBFOtd8jtQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-a67b7.png 200w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0b187.png 400w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png 800w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="开发环境"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境</h3>\n<p>看自己电脑配置来定，目前本人电脑上前端初次编译 5 分钟，二次编译 2 分钟（不过不建议开启缓存插件，会影响热更新速度且时间长会报错，可通过上面提到的 <code class="language-text">DISABLE_HARD_SOURCE_PLUGIN</code> 关闭）</p>\n<h2 id="后期优化"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>后期优化偏向页面加载性能方面，有以下几点可以考虑：</p>\n<ol>\n<li>页面分包优化</li>\n<li>worker.js loader 优化</li>\n<li>不必要的三方库优化</li>\n</ol>\n<h1 id="二期优化"><a href="#%E4%BA%8C%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二期优化</h1>\n<p>主要升级 cra + webpack5 以及对其他编译工具的调研</p>\n<h2 id="具体功能-1"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra--webpack5"><a href="#cra--webpack5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra + webpack5</h3>\n<h4 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h4>\n<p>.env</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44848282482720900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\nPORT=3000\nBROWSER=none\n\n# LAZY_BUILD=true\n# DISABLE_CACHE=true\n# DEBUG_CACHE=true`, `44848282482720900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3000</span>\n<span class="token assign-left variable">BROWSER</span><span class="token operator">=</span>none\n\n<span class="token comment"># LAZY_BUILD=true</span>\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token comment"># DEBUG_CACHE=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.env.production</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99508827333007330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\n\n# DISABLE_CACHE=true\nDEBUG_CACHE=true\n# BUNDLE_ANALYZER=true`, `99508827333007330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token assign-left variable">DEBUG_CACHE</span><span class="token operator">=</span>true\n<span class="token comment"># BUNDLE_ANALYZER=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="核心配置"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81714078221295750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         // 适配 cra 下 less-loader 的兼容性问题\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/,\n                     /.cjs\\$/,\n                     /.svg\\$/,\n                     /.ttf\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         // 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      // 兼容处理\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      // 懒编译功能，默认关闭\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      } // 开启缓存调试日志，默认关闭，配合环境变量使用\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      } // 是否关闭缓存，默认开启\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `81714078221295750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 适配 cra 下 less-loader 的兼容性问题</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.cjs$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.svg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.ttf$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 兼容处理</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 懒编译功能，默认关闭</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 开启缓存调试日志，默认关闭，配合环境变量使用</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 是否关闭缓存，默认开启</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json 只显示增加部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34981540794992562000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;dependencies&quot;: {\n      &quot;html-webpack-plugin&quot;: &quot;^5.5.0&quot;,\n      &quot;less-loader&quot;: &quot;^11.1.0&quot;,\n      &quot;react-scripts&quot;: &quot;npm:@towavephone/react-scripts@^5.0.3&quot;,\n      &quot;webpack&quot;: &quot;5.78.0&quot;,\n      &quot;webpack-bundle-analyzer&quot;: &quot;^4.7.0&quot;,\n      &quot;webpack-dev-server&quot;: &quot;4.13.2&quot;,\n      &quot;buffer&quot;: &quot;^6.0.3&quot;\n   }\n}`, `34981540794992562000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"html-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^5.5.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"less-loader"</span><span class="token operator">:</span> <span class="token string">"^11.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"npm:@towavephone/react-scripts@^5.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"5.78.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-bundle-analyzer"</span><span class="token operator">:</span> <span class="token string">"^4.7.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-dev-server"</span><span class="token operator">:</span> <span class="token string">"4.13.2"</span><span class="token punctuation">,</span>\n      <span class="token property">"buffer"</span><span class="token operator">:</span> <span class="token string">"^6.0.3"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="worker-loader-的兼容处理"><a href="#worker-loader-%E7%9A%84%E5%85%BC%E5%AE%B9%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>worker-loader 的兼容处理</h4>\n<p>去掉 worker-loader，使用 <code class="language-text">new Worker(new URL(&#39;worker文件路径&#39;, import.meta.url))</code> 代替</p>\n<h4 id="修复-react-scripts-生产环境缓存"><a href="#%E4%BF%AE%E5%A4%8D-react-scripts-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 react-scripts 生产环境缓存</h4>\n<p><a href="https://github.com/yicheny/create-react-app/compare/main...towavephone:create-react-app:main" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<p>生产环境下 cra 不能正常生成文件缓存，原因是没有调用 webpack5 的 <code class="language-text">compiler.close</code>，同时需要注意 close 之后需要正常终止</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18600802059309810"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.close((err) => {\n   if (err && err.message) {\n      console.log(err.message);\n      process.exit(1);\n   }\n\n   process.exit(0);\n});`, `18600802059309810`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/cra-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<p>相比于一期优化的本地和生产模式编译时间都为 2~3 分钟，优缺点如下</p>\n<ul>\n<li>优点：二次编译速度快，开发模式在 18 秒左右，生产模式在 40 秒左右</li>\n<li>缺点：首次编译速度慢，需要 3~4 分钟</li>\n</ul>\n<h3 id="rspack"><a href="#rspack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rspack</h3>\n<h4 id="核心配置-1"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>rspack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45502700672105070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\n// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')\n// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')\n\nmodule.exports = {\n   mode: \'development\',\n   entry: {\n      main: \'./src/index.js\'\n   },\n   builtins: {\n      html: [\n         {\n            template: \'./public/index.html\'\n         }\n      ],\n      pluginImport: [\n         {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }\n      ],\n      define: {\n         // \'process.env.NODE_ENV\': &quot;\'development\'&quot;,\n         \'import.meta.env\': &quot;\'development\'&quot;,\n         \'import.meta.env.MODE\': &quot;\'development\'&quot;,\n         \'process.env.NODE_DEBUG\': false,\n         \'process.env.BUILD_TOOL\': &quot;\'rspack\'&quot;\n      }\n   },\n   module: {\n      rules: [\n         {\n            test: /\\.js\\$/,\n            include: /src/,\n            type: \'jsx\'\n         },\n         {\n            test: /(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/,\n            // use: [\n            //   {\n            //     loader: \'worker-loader\',\n            //     options: {\n            //       filename: \'[name].[hash].worker.js\'\n            //     }\n            //   }\n            // ]\n            type: \'asset/resource\'\n         },\n         {\n            test: /\\.less\\$/,\n            exclude: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css/module\'\n         },\n         {\n            test: /\\.less\\$/,\n            include: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css\'\n         },\n         // {\n         //   test: /\\.css\\$/,\n         //   type: \'css\'\n         // },\n         {\n            test: /\\.(png|svg|jpg|jpeg|ttf)\\$/,\n            type: \'asset\'\n         }\n      ]\n   },\n   resolve: {\n      alias: {\n         \'@\': path.resolve(__dirname, \'./src\'),\n         \'antd/es/theme\': false // 修复因 @ant-design/pro-components 导致的编译报错问题\n      },\n      extensions: [\'.js\'],\n      mainFields: [\'main\']\n   },\n   // plugins: [\n   //   new MonacoWebpackPlugin({\n   //     languages: [\'json\']\n   //   })\n   //   // new NodePolyfill()\n   // ],\n   devServer: {\n      port: 3000,\n      allowedHosts: \'all\'\n   },\n   devtool: \'source-map\',\n   snapshot: {\n      resolve: {\n         hash: true,\n         timestamp: false\n      },\n      module: {\n         hash: true,\n         timestamp: false\n      }\n   },\n   stats: {\n      preset: \'errors-only\',\n      reasons: true,\n      hash: true,\n      builtAt: true,\n      timings: true\n   },\n   experiments: {\n      incrementalRebuild: true\n   }\n};`, `45502700672105070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')</span>\n<span class="token comment">// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n   entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      main<span class="token punctuation">:</span> <span class="token string">\'./src/index.js\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   builtins<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      html<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            template<span class="token punctuation">:</span> <span class="token string">\'./public/index.html\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      pluginImport<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token comment">// \'process.env.NODE_ENV\': "\'development\'",</span>\n         <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'import.meta.env.MODE\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'rspack\'"</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/src/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/</span><span class="token punctuation">,</span>\n            <span class="token comment">// use: [</span>\n            <span class="token comment">//   {</span>\n            <span class="token comment">//     loader: \'worker-loader\',</span>\n            <span class="token comment">//     options: {</span>\n            <span class="token comment">//       filename: \'[name].[hash].worker.js\'</span>\n            <span class="token comment">//     }</span>\n            <span class="token comment">//   }</span>\n            <span class="token comment">// ]</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'asset/resource\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css/module\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token comment">// {</span>\n         <span class="token comment">//   test: /\\.css$/,</span>\n         <span class="token comment">//   type: \'css\'</span>\n         <span class="token comment">// },</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.(png|svg|jpg|jpeg|ttf)$/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'asset\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token string">\'antd/es/theme\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// 修复因 @ant-design/pro-components 导致的编译报错问题</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'main\'</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [</span>\n   <span class="token comment">//   new MonacoWebpackPlugin({</span>\n   <span class="token comment">//     languages: [\'json\']</span>\n   <span class="token comment">//   })</span>\n   <span class="token comment">//   // new NodePolyfill()</span>\n   <span class="token comment">// ],</span>\n   devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>\n      allowedHosts<span class="token punctuation">:</span> <span class="token string">\'all\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   devtool<span class="token punctuation">:</span> <span class="token string">\'source-map\'</span><span class="token punctuation">,</span>\n   snapshot<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   stats<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preset<span class="token punctuation">:</span> <span class="token string">\'errors-only\'</span><span class="token punctuation">,</span>\n      reasons<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      timings<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   experiments<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      incrementalRebuild<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板-1"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/rspack-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点-1"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译，hmr 速度快</li>\n<li>缺点：目前只适用于开发环境，主要是还不支持 <code class="language-text">worker-loader</code> 的用法</li>\n</ul>\n<p>由于以上原因，暂时只在开发模式下使用</p>\n<h3 id="vite"><a href="#vite" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vite</h3>\n<h4 id="核心配置-2"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<ol>\n<li>index.html 下的 script 脚本需要改成 module 类型</li>\n<li>worker-loader 替换为 <code class="language-text">import Worker from &#39;文件路径?worker&#39;</code></li>\n<li>所有使用 require 的地方替换为 import</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98648029766058930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;devDependencies&quot;: {\n      &quot;@vitejs/plugin-react&quot;: &quot;^3.1.0&quot;,\n      &quot;vite&quot;: &quot;^4.3.1&quot;,\n      &quot;vite-plugin-imp&quot;: &quot;^2.3.1&quot;\n   }\n}`, `98648029766058930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"@vitejs/plugin-react"</span><span class="token operator">:</span> <span class="token string">"^3.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite"</span><span class="token operator">:</span> <span class="token string">"^4.3.1"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite-plugin-imp"</span><span class="token operator">:</span> <span class="token string">"^2.3.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>vite.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92639453344210670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { defineConfig } from \'vite\';\nimport react from \'@vitejs/plugin-react\';\nimport fs from \'fs/promises\';\nimport path from \'path\';\nimport vitePluginImp from \'vite-plugin-imp\';\n\nexport default defineConfig({\n   plugins: [react(), vitePluginImp()],\n   css: {\n      preprocessorOptions: {\n         less: {\n            javascriptEnabled: true\n         }\n      }\n   },\n   esbuild: {\n      loader: \'jsx\',\n      include: /src\\/.*\\.js?\\$/,\n      exclude: []\n   },\n   resolve: {\n      alias: [\n         {\n            // 处理 @import \'~antd/es/style/themes/default.less\' 报错\n            find: /^~/,\n            replacement: \'\'\n         },\n         {\n            find: \'@\',\n            replacement: path.resolve(__dirname, \'./src\')\n         }\n      ]\n   },\n   define: {\n      \'import.meta.env\': &quot;\'development\'&quot;,\n      \'process.env.NODE_DEBUG\': false,\n      \'module.hot\': false\n   },\n   server: {\n      port: 3000\n   },\n   optimizeDeps: {\n      esbuildOptions: {\n         plugins: [\n            {\n               name: \'load-js-files-as-jsx\',\n               // 把 js 文件当成 jsx 处理\n               setup(build) {\n                  build.onLoad({ filter: /src\\/.*\\.js\\$/ }, async (args) => ({\n                     loader: \'jsx\',\n                     contents: await fs.readFile(args.path, \'utf8\')\n                  }));\n               }\n            }\n         ]\n      }\n   }\n});`, `92639453344210670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'vite\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">\'@vitejs/plugin-react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">\'fs/promises\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> vitePluginImp <span class="token keyword">from</span> <span class="token string">\'vite-plugin-imp\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vitePluginImp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   css<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preprocessorOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         less<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   esbuild<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n      include<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js?$/</span><span class="token punctuation">,</span>\n      exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// 处理 @import \'~antd/es/style/themes/default.less\' 报错</span>\n            find<span class="token punctuation">:</span> <span class="token regex">/^~/</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            find<span class="token punctuation">:</span> <span class="token string">\'@\'</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n      <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token string">\'module.hot\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   optimizeDeps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      esbuildOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n               name<span class="token punctuation">:</span> <span class="token string">\'load-js-files-as-jsx\'</span><span class="token punctuation">,</span>\n               <span class="token comment">// 把 js 文件当成 jsx 处理</span>\n               <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                  build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n                     loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n                     contents<span class="token punctuation">:</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="优缺点-2"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译速度快</li>\n<li>缺点：此方案初次页面跳转编译速度较慢，而且编译问题较多，同时不太适合生产环境使用</li>\n</ul>\n<p>由于以上原因，不采用此方案</p>\n<h3 id="dockerfile-pnpm-缓存不生效"><a href="#dockerfile-pnpm-%E7%BC%93%E5%AD%98%E4%B8%8D%E7%94%9F%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerfile pnpm 缓存不生效</h3>\n<h4 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在 jenkins 下运行 docker，缓存不能被使用，因为是跨磁盘（home 目录与 root 目录不在一个磁盘上）的，即 pnpm 不支持硬连接操作，同时 pnpm@7.14.1 也没有对这种情况进行处理，详见 <a href="https://github.com/pnpm/pnpm/releases/tag/v7.14.2" target="_blank" rel="nofollow noreferrer noopener">资料</a></p>\n<h4 id="解决方案-2"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<ol>\n<li>升级到 pnpm@7 下的最新版本</li>\n<li>设置缓存路径</li>\n</ol>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20137437776728383000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm@7.32.1\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `20137437776728383000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{8,16,24}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{8,16,24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm@7.32.1</span>\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-1"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p>以下都是在二次缓存下的展示，首次编译性能并没有一期优化的性能好</p>\n<h3 id="本地环境"><a href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地环境</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79795125329697750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Compiled successfully!\n\nYou can now view sim_ui in the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use npm run build.\n\n2023-04-25 16:54:30: webpack 5.78.0 compiled successfully in 18559 ms (c2255578550bc936f958)`, `79795125329697750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Compiled successfully<span class="token operator">!</span>\n\nYou can now view sim_ui <span class="token keyword">in</span> the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use <span class="token function">npm</span> run build.\n\n<span class="token number">2023</span>-04-25 <span class="token number">16</span>:54:30: webpack <span class="token number">5.78</span>.0 compiled successfully <span class="token keyword">in</span> <span class="token number">18559</span> ms <span class="token punctuation">(</span>c2255578550bc936f958<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="生产环境-1"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-a2427.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.995807127882596%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABCklEQVQY0yWQiZKDIBBE/f+/yyYVj8QLNFwqgoqbTa29I0vVFDPNm2YgAa3jOGKs64p1WTHbGYtfME0TwrZhDwFKKsyzw2QtvPdwlA9miKxWCnayMFoj8esGYwwsgUILcNFBjgrCSLAXp1xDUTDShezRVxV4z2J96nJQaKk+97MnYWKIkxy/B7og8dwY2vcLVeiQuwrsR4J/SA8cjW/Q6hyVq1HuHdrvfy6bT46GITaRg4Vzc3xyHxRKMmx2AjcytFWEug/p1NguDJ0tUZPxadTsPWriMtLYmy6mSLjQEELE/3uMNa5DjsLXSO0TXyqNeUEGt7FAZuiMX3An/TY+4gtSMruoe8wL1+APtnp1JSj7VIYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 04 25 16 58 25" title="" data-src="/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-fee1c.png" data-srcset="/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-a67b7.png 200w,\n/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-0b187.png 400w,\n/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-fee1c.png 800w,\n/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-b1a91.png 1200w,\n/static/2023-04-25-16-58-25-6c30f7cd0fc866842f9122c75f38d012-a2427.png 1431w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="后期优化-1"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>待 rspack 生产环境可用且性能较好的时候考虑迁移</p>\n<h1 id="三期优化"><a href="#%E4%B8%89%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三期优化</h1>\n<h2 id="具体功能-2"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="格式化"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化</h3>\n<p>需要对老项目的 js 代码格式化，分为 eslint/prettier</p>\n<p>如下可实现 git commit 前只对暂存到 git 的代码进行格式化修复及校验</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49503860918135456000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n   &quot;eslint&quot;: &quot;npm run eslint:files -- src&quot;,\n   &quot;eslint:files&quot;: &quot;eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0&quot;,\n   &quot;fix&quot;: &quot;npm run fix:js&quot;,\n   &quot;fix:js&quot;: &quot;npm run prettier -- --write&quot;,\n   &quot;fl&quot;: &quot;npm run fix && npm run lint&quot;,\n   &quot;lint&quot;: &quot;npm run lint:js&quot;,\n   &quot;lint:js&quot;: &quot;npm run prettier -- --check && npm run eslint&quot;,\n   &quot;lint:js:log2file&quot;: &quot;npm run prettier -- --check && npm run eslint -- -o .cra/eslint-error.log --no-color&quot;,\n   &quot;lint:log2file&quot;: &quot;npm run lint:js:log2file&quot;,\n   &quot;prettier&quot;: &quot;npm run prettier:files -- \'src/**/*.js\'&quot;,\n   &quot;prettier:files&quot;: &quot;prettier --cache --cache-strategy content&quot;\n},\n&quot;husky&quot;: {\n   &quot;hooks&quot;: {\n      &quot;pre-commit&quot;: &quot;node scripts/pre-commit.js&quot;\n   }\n},\n&quot;dependencies&quot;: {\n   &quot;eslint-config-prettier&quot;: &quot;^8.8.0&quot;,\n   &quot;eslint-plugin-eslint-comments&quot;: &quot;^3.2.0&quot;,\n   &quot;prettier&quot;: &quot;^2.8.8&quot;,\n   &quot;confusing-browser-globals&quot;: &quot;^1.0.11&quot;\n},\n&quot;devDependencies&quot;: {\n   &quot;husky&quot;: &quot;^1.0.0-rc.2&quot;,\n   &quot;lint-staged&quot;: &quot;^13.2.2&quot;\n}`, `49503860918135456000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint"</span><span class="token operator">:</span> <span class="token string">"npm run eslint:files -- src"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint:files"</span><span class="token operator">:</span> <span class="token string">"eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix"</span><span class="token operator">:</span> <span class="token string">"npm run fix:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --write"</span><span class="token punctuation">,</span>\n   <span class="token property">"fl"</span><span class="token operator">:</span> <span class="token string">"npm run fix &amp;&amp; npm run lint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint -- -o .cra/eslint-error.log --no-color"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js:log2file"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"npm run prettier:files -- \'src/**/*.js\'"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier:files"</span><span class="token operator">:</span> <span class="token string">"prettier --cache --cache-strategy content"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"husky"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"hooks"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"node scripts/pre-commit.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint-config-prettier"</span><span class="token operator">:</span> <span class="token string">"^8.8.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint-plugin-eslint-comments"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"^2.8.8"</span><span class="token punctuation">,</span>\n   <span class="token property">"confusing-browser-globals"</span><span class="token operator">:</span> <span class="token string">"^1.0.11"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"husky"</span><span class="token operator">:</span> <span class="token string">"^1.0.0-rc.2"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"^13.2.2"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/pre-commit.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3073092265372068400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'lint-staged\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--no-stash\']);`, `3073092265372068400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'lint-staged\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--no-stash\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.eslintrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24762931287435588000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const restrictedGlobals = require(\'confusing-browser-globals\');\n\nconst excludeRestrictedGlobals = restrictedGlobals.filter((item) => ![\'self\'].includes(item));\n\n// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)\n\nmodule.exports = {\n   extends: [\'react-app\', \'prettier\', \'plugin:eslint-comments/recommended\'],\n   // plugins: [\'prettier\'],\n   rules: {\n      // \'prettier/prettier\': 2,\n      \'no-unused-vars\': 2,\n      \'no-restricted-globals\': [\'error\'].concat(excludeRestrictedGlobals),\n      \'no-debugger\': 2,\n      \'eslint-comments/no-use\': [\'error\', { allow: [\'eslint-disable-next-line\'] }]\n   }\n};`, `24762931287435588000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> restrictedGlobals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'confusing-browser-globals\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> excludeRestrictedGlobals <span class="token operator">=</span> restrictedGlobals<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">\'self\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token keyword">extends</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react-app\'</span><span class="token punctuation">,</span> <span class="token string">\'prettier\'</span><span class="token punctuation">,</span> <span class="token string">\'plugin:eslint-comments/recommended\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [\'prettier\'],</span>\n   rules<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \'prettier/prettier\': 2,</span>\n      <span class="token string">\'no-unused-vars\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-restricted-globals\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>excludeRestrictedGlobals<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-debugger\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'eslint-comments/no-use\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> allow<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'eslint-disable-next-line\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.prettierrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30534740794616844000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   arrowParens: \'avoid\',\n   bracketSpacing: true,\n   printWidth: 200,\n   semi: false,\n   singleQuote: true,\n   tabWidth: 2,\n   trailingComma: \'none\',\n   useTabs: false\n};`, `30534740794616844000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   arrowParens<span class="token punctuation">:</span> <span class="token string">\'avoid\'</span><span class="token punctuation">,</span>\n   bracketSpacing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   printWidth<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>\n   semi<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n   singleQuote<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   tabWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n   trailingComma<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n   useTabs<span class="token punctuation">:</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.lintstagedrc.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37044373049796910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ESLint } from \'eslint\';\n\nconst removeIgnoredFiles = async (files) => {\n   const eslint = new ESLint();\n   const isIgnored = await Promise.all(\n      files.map((file) => {\n         return eslint.isPathIgnored(file);\n      })\n   );\n   const filteredFiles = files.filter((_, i) => !isIgnored[i]);\n   return filteredFiles;\n};\n\nexport default {\n   \'src/**/*.js\': async (files) => {\n      let filteredFiles = await removeIgnoredFiles(files);\n\n      if (filteredFiles.length === 0) {\n         return [];\n      }\n\n      // 提交文件超过 20 个的强制检测全部文件\n      if (filteredFiles.length > 20) {\n         filteredFiles = [\'src/**/*.js\'];\n      }\n\n      // console.log(\'filteredFiles\', filteredFiles)\n\n      const filesToLint = filteredFiles.join(\' \');\n      const cmds = [\n         \\`npm run prettier:files -- --write \\${filesToLint}\\`,\n         \\`npm run prettier:files -- --check \\${filesToLint}\\`,\n         \\`npm run eslint:files -- \\${filesToLint}\\`\n      ];\n      // console.log(\'cmds\', cmds)\n      return cmds;\n   }\n};`, `37044373049796910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ESLint <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'eslint\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeIgnoredFiles</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> eslint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ESLint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> isIgnored <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n      files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> eslint<span class="token punctuation">.</span><span class="token function">isPathIgnored</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> filteredFiles <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>isIgnored<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> filteredFiles<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   <span class="token string">\'src/**/*.js\'</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> filteredFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">removeIgnoredFiles</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 提交文件超过 20 个的强制检测全部文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         filteredFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'src/**/*.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// console.log(\'filteredFiles\', filteredFiles)</span>\n\n      <span class="token keyword">const</span> filesToLint <span class="token operator">=</span> filteredFiles<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> cmds <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --write </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --check </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run eslint:files -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// console.log(\'cmds\', cmds)</span>\n      <span class="token keyword">return</span> cmds<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包策略"><a href="#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包策略</h3>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35480170569197543000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst getLoaders = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst getAssetModules = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'type\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst addBeforeLoaders = (webpackConfig, matcher, newLoader = []) => {\n   const matchLoaders = getLoaders(webpackConfig, matcher);\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      const props = [\'loader\', \'options\'];\n      item.use = [...newLoader, pick(item, props)];\n      props.forEach((item2) => {\n         delete item[item2];\n      });\n   });\n};\n\nconst removeAssetDataUrlCondition = (webpackConfig) => {\n   const matchLoaders = getAssetModules(webpackConfig, \'asset\');\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      if (!item.parser) {\n         return;\n      }\n      delete item.parser;\n   });\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            // 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效\n            setWebpackOptimizationSplitChunks({\n               chunks: \'all\',\n               maxInitialRequests: 10,\n               minSize: 0,\n               cacheGroups: {\n                  defaultVendors: {\n                     // 抽取三方库\n                     test: (module) => {\n                        return /[\\\\/]node_modules[\\\\/]/.test(module.context);\n                     },\n                     name: (module) => {\n                        // 从后往前匹配 node_modules 后的包名\n                        //\n                        // /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/\n                        // 结果为 @antv\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20/323\n                        // 结果为 @antv+g2plot@2.4.20\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20\n                        // 结果为 @antv+g2plot@2.4.20\n                        const matchResult = module.context.match(/(?<=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|\\$))/g);\n                        const packageName = matchResult[matchResult.length - 1];\n                        // console.log(\\`packageName: \\${packageName}\\`, module.context)\n                        return \\`pnpm.\\${packageName.replace(/@|\\./g, \'\')}\\`;\n                     },\n                     priority: -10,\n                     reuseExistingChunk: true\n                  },\n                  default: {\n                     // 抽取页面的公共部分\n                     test: (module) => {\n                        // console.log(\'test module.context---------- \', module.context)\n                        return new RegExp(\\`\\${process.cwd()}[\\\\/](src|public)[\\\\/]\\`).test(module.context);\n                     },\n                     name: (module) => {\n                        // console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)\n                        const relativePath = module.resourceResolveData.relativePath\n                           .split(\'/\')\n                           .slice(1)\n                           .join(\'~\');\n                        return relativePath;\n                     },\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n      removeAssetDataUrlCondition(localConfig);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      }\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      }\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n\n         localConfig.optimization = {\n            ...localConfig.optimization,\n            nodeEnv: \'production\',\n            sideEffects: true,\n            concatenateModules: true,\n            runtimeChunk: \'single\'\n         };\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `35480170569197543000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{121-169,253-259}"\n              >\n                <span class="gatsby-code-button-language">js{121-169,253-259}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getAssetModules</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'type\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getLoaders</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeAssetDataUrlCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getAssetModules</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'asset\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">delete</span> item<span class="token punctuation">.</span>parser<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">         isProd <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">            <span class="token comment">// 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效</span></span><span class="gatsby-highlight-code-line">            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">               chunks<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               maxInitialRequests<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  defaultVendors<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取三方库</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token operator">/</span><span class="token punctuation">[</span>\\\\<span class="token regex">/]node_modules[\\\\/]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 从后往前匹配 node_modules 后的包名</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20/323</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> matchResult <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|$))/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> packageName <span class="token operator">=</span> matchResult<span class="token punctuation">[</span>matchResult<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(`packageName: ${packageName}`, module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pnpm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@|\\./g</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取页面的公共部分</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'test module.context---------- \', module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[\\\\/](src|public)[\\\\/]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> relativePath <span class="token operator">=</span> module<span class="token punctuation">.</span>resourceResolveData<span class="token punctuation">.</span>relativePath</span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'~\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> relativePath<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span></span>               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">removeAssetDataUrlCondition</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">         <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">         localConfig<span class="token punctuation">.</span>optimization <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token operator">...</span>localConfig<span class="token punctuation">.</span>optimization<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            nodeEnv<span class="token punctuation">:</span> <span class="token string">\'production\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            sideEffects<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            concatenateModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>            runtimeChunk<span class="token punctuation">:</span> <span class="token string">\'single\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-2"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-0424d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.67657992565056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQoz42RW3OCMBCFea2XqiCItTqd1orKPZEQEGzr//9Pp9nVcXyp5eHMEib5ds9Z6/yuoacRKi/GcZ6hmiWo/RRHP+NaeQny/ifSpw9kvfWt/iWrWQgDjFFMdijdCGoasrQb85kkn4N/QTfgaXlA7SYM/VoVOL1K8D8zHYEJSM06A1sCGBGU7JFtmq72UhxGW8hRADHcMLCLbas0+R1nGRo/NxADNTACErx0IpayQ+SDTbcMz28aPyvFUFK7kLwQaqSvIqgYBt2A7YvA97JgiHJCnkYaq2nPPOyvWfd2H4nuWIW957zIrjLflJcwW6XNyvGW4fd2H4knVJO9yS1BM8+5kqgBbV07EdfSvtTqKnpTjHccRe2mfE8MLov7BTNQ/81VMpNzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 05 15" title="" data-src="/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-fee1c.png" data-srcset="/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-a67b7.png 200w,\n/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-0b187.png 400w,\n/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-fee1c.png 800w,\n/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-b1a91.png 1200w,\n/static/2023-07-04-15-05-15-3184754b7008219dbfbee8dfe7bee8bc-0424d.png 1345w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-08-47-b38d2a7893ebc90d1b4190531fb8c94b-1f825.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 552px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.869565217391305%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABk0lEQVQoz1WP227aUBBFeWlL2qQEmhBR7ldxMcY2xgZjJwYMpIBNmgDq7an//w+rU6dC6sPWnjlztGZ2wiwbjCstRtkmS3H3rs0orWKmOqIuVlqJayvdw8ooGFdt1GRd1DhrcNFAe1+PPeG3Hoh6Jn6hx2NzyKpu8KQ6BFWdtfS7js2saMi7xaZtE1T6mB+rjFK1WONMDfOqfoYmFNk4TuWZfCphXxexUkXG6bx8LkpfiKVdlDEuSwIq4dyUsdN/QdVYbvYVfgZqWU02z1i3fLnCwy+NmVecWKGyJKi5jK67cVT9Q4vem9p/cdVk8x/sVQk9N+BgfCFSFhLZ46u2FndZ16cS2eVFZquaE8+2HZ/7zwZaUqDv5KrYq3Hdf1uhL3XCbrn8Dn9w8vf8XB44zfZ8Xzxzuo/4Nn/i+BCyGwYcvS3P7oZfqwPb4YxpYcAo02Wa07BvFLy8iXPbF2DZJdTmbPozQn3JcRqyN1fMGxMiPWCnLYiGSyIjYNWe4haHeGWTSU7FEpCbN3DuVCa3KrYs+AMFgtdNtYO+3wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 08 47" title="" data-src="/static/2023-07-04-15-08-47-b38d2a7893ebc90d1b4190531fb8c94b-1f825.png" data-srcset="/static/2023-07-04-15-08-47-b38d2a7893ebc90d1b4190531fb8c94b-632a9.png 200w,\n/static/2023-07-04-15-08-47-b38d2a7893ebc90d1b4190531fb8c94b-cac39.png 400w,\n/static/2023-07-04-15-08-47-b38d2a7893ebc90d1b4190531fb8c94b-1f825.png 552w" data-sizes="(max-width: 552px) 100vw, 552px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-eb534.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 113.67061356297093%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsSAAALEgHS3X78AAADsUlEQVQ4y11Va3PbNhDkv27s2I3k/MB+60zbWJYovknw/Ral7S4gOZlo5uYo3OGwt3sgvf3bDrvdN7y+vmC/3+H79zfs6L++vOCPpye8/vlqY8/PT85/fcYL/SN//7bHN8W+fLExr0lSDP2AcZzQ0OdlhbPpEaQG57xGnBsUVW3Xy6ZD3fVoh5G5IzruscZ90zQjbyd4Bz/EOYwQxgkiFv/nxwGHU4B/3w/47/CB9+MJfhjjGKU4BcyNEsRZjpC5AffIksLwsBZF3cD766PA6XS0mwyRVAzI6razvunouxF/B0TOgipQMdb0PWPO6s7lVm0LLylKJLnMIExzRLQgyYjgYfnns43FKc60KM1c3m/5XmwaBFmJuKhQtMPdxru5Z0OfNwO9WzP3NT2X3c81ea8U4VmGjrB7tjGOI+Zpsv8v64qavFwuFzRNg2VZ7PpAUZT3WKuqCuu6MLeGV1QtttsVNwDX6w2XbcO2Xa3/1a63G/qBSCUAQVwuG37/3ZjjReEZMfmQckleoL6LIuUlkmLyUruRSCS+pSibPXiz6K/Xq0XcsUNvqEL4vg9Tlpjn2bbp2qix0tdsayIFURSz1QEZD9bMCs1yzxVatZ1wlLy+ijgOAQpTWk60WUk6QF6IdHp4L6iDtP7rb2VhcZtRC68vA/jnABnbzfLcFlCCCorolom6BcppGVPhiuQ/OJPxyR5SFAW8zgT4OB4RE64hSqEQSpEvCoRaqp5IS88rpuFWTPw9ipbLZvclSQJvrOPPlmWGd1aFNC62FRKt/1EUoZtWFJMm4fqJ7kZBNpoKFsY4hP75bFvOCbng6RoPoRVSka1ktayXQEOFR65L3XmhKBe2u90wrxtK0mQRRrHjRbwNFEDtPAZaIzKTn4h3WPyGHKeAaEMZr+B7WOAj4Tugm1DzcIvQtWwsOhVUi0KoG6ODhFCFpLZQT9NoQUgkcV+wu2WebNzNIdtRuyVPeMxWSS7lncoTAhbUf/Eq00SoQEYQVVljEwUEYsfmePKRcmCFcr0XFEJb8M6ZDtWGRzxJU4s85tvGmIr0rK5gV4YciTNywlZRoRQiFXdj01oaVPAx9PIxOXUFM1LlZlbr3kBRRLDlUMreUYg7edsy1zTQ7pq51lLeCvvaZ7GqaqyQituWJYoS7P1dHXR79TSPGmwiDDjQQiAk8zwiVctct98c2rLMTpQs5feCLZ/Ykk/idQsKCqLvi55Fuobd1w0xNd/Usgo/TglMxjj3lRSl14eLn4P/ATquv1jYwePvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 09 21" title="" data-src="/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-fee1c.png" data-srcset="/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-a67b7.png 200w,\n/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-0b187.png 400w,\n/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-fee1c.png 800w,\n/static/2023-07-04-15-09-21-24e4d56dfbccd07f9ec37f8e4f392201-eb534.png 929w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/CRA 项目构建速度优化/index.md absPath of file >>> MarkdownRemark",timeToRead:31,frontmatter:{date:"2022-12-16 17:34:33",path:"/cra-project-build-speed-optimize/",tags:"前端, webpack, Docker, 预研",title:"CRA 项目构建速度优化",draft:null}},{excerpt:"需求背景 完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能 动效 逐行显示 需求背景 实现功能如下： x 旋转 -> 不同文字由下而上透明度从 0 到 1 实现要点如下： 进入视口执行一次 离开视口重置动画 实现如下所示动效： 选型过程 选型 优点 缺点 react-spring 使用方便，基于弹簧物理的动画库 改变 state 会导致多次执行 不能自由控制播放进度 animate.css 原生方法体积小，提供回退兼容性好 使用较为繁琐，需要同时写 css、js gsap…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能</p>\n<h1 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h1>\n<h2 id="逐行显示"><a href="#%E9%80%90%E8%A1%8C%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>逐行显示</h2>\n<h3 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<p>x 旋转 -> 不同文字由下而上透明度从 0 到 1</p>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/line-by-line-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/pmndrs/react-spring" target="_blank" rel="nofollow noreferrer noopener">react-spring</a></td>\n<td align="left">使用方便，基于弹簧物理的动画库</td>\n<td align="left"><ol>\n<li>\n改变 state 会导致多次执行\n</li>\n<li>\n不能自由控制播放进度\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://animate.style/" target="_blank" rel="nofollow noreferrer noopener">animate.css</a></td>\n<td align="left">原生方法体积小，提供回退兼容性好</td>\n<td align="left">使用较为繁琐，需要同时写 css、js</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a></td>\n<td align="left"><ol>\n<li>\n可控制播放进度或自动播放，可配合之后提到的 react-scrollmagic 实现动效进度控制\n</li>\n<li>\n示例丰富，可实现很多动效\n</li>\n</ol></td>\n<td align="left">api 过于原始，需要封装</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a></td>\n<td align="left">除了以上优点，可直接在 react 中使用</td>\n<td align="left">有些 gsap 动效不能直接在 react-gsap 中使用，比如说和 react-scrollmagic 相同的效果</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-spring"><a href="#react-spring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<p>最初采用 react-spring 版本，主要实现了如下功能</p>\n<ol>\n<li>react-spring 时间序列化（react-spring ref delay）</li>\n<li>useContext 全局控制，实现 react-spring 的反向动画</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56920373584177050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { CSSProperties, ReactNode, Children, useRef, useEffect, useContext } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTransition, useSpringRef, useSpring } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport XIcon from \'@/components/xIcon\';\nimport ConfigContext from \'@/components/layout/configContext\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\nexport interface AnimationTitleProps {\n   className?: string;\n   title?: ReactNode;\n   subTitle?: ReactNode;\n   closeIcon?: ReactNode;\n   delay?: number;\n   style?: CSSProperties;\n   animation?: boolean;\n   isOnce?: boolean;\n}\n\ntype TransitionProps = Parameters<typeof useTransition>[1];\n\nconst AnimationTitle = ({\n   className,\n   title,\n   subTitle,\n   closeIcon = <XIcon name=\'title-x\' />,\n   delay = 300,\n   style,\n   animation = true,\n   isOnce = false\n}: AnimationTitleProps) => {\n   const { isRunMultiTime } = useContext(ConfigContext);\n\n   const closeIconRef = useSpringRef();\n   const closeIconStyle = useSpring({\n      ref: closeIconRef,\n      from: {\n         opacity: 0,\n         rotate: -100\n      },\n      to: {\n         rotate: 0,\n         opacity: 1\n      }\n   });\n\n   const titleRef = useSpringRef();\n   const titleStyle = useSpring({\n      ref: titleRef,\n      from: {\n         scale: 0,\n         opacity: 0\n      },\n      to: {\n         scale: 1,\n         opacity: 1\n      },\n      config: {\n         tension: 100,\n         friction: 14\n      }\n   });\n\n   const renderSubTitle: ReactNode[] = Children.map(Children.toArray(subTitle), (child, index) => {\n      if (typeof child === \'string\') {\n         return <div key={index}>{child}</div>;\n      }\n      return child;\n   });\n\n   const subTitleRef = useSpringRef();\n   const transitionProps: TransitionProps = {\n      from: {\n         opacity: 0,\n         y: 50\n      },\n      enter: (msg, i) => ({\n         delay: () => {\n            return i * 400;\n         },\n         to: {\n            opacity: 1,\n            y: 0\n         }\n      }),\n      ref: subTitleRef\n   };\n\n   if (!isRunMultiTime || isOnce) {\n      transitionProps.keys = (item: { key: any }) => item.key;\n   }\n\n   const transitions = useTransition(renderSubTitle, transitionProps);\n\n   const domRef = useRef<HTMLDivElement>(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         if (closeIcon) {\n            closeIconRef.start();\n         }\n         if (title) {\n            await Promise.all(titleRef.start());\n         }\n         if (subTitle) {\n            await Promise.all(subTitleRef.start());\n         }\n      };\n\n      const reverseAnimation = () => {\n         [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n            item.start({\n               reverse: true\n            });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else if (isRunMultiTime && !isOnce) {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.textDisplay, \'text-display\', className)} style={style}>\n         {closeIcon && (\n            <a.div style={getStyle(closeIconStyle)} className={classnames(PageStyles.closeIcon, \'close-icon\')}>\n               {closeIcon}\n            </a.div>\n         )}\n         {title && (\n            <a.div style={getStyle(titleStyle)} className={classnames(PageStyles.title, \'text-display-title\')}>\n               {title}\n            </a.div>\n         )}\n         {subTitle && (\n            <div className={classnames(PageStyles.subTitleContainer, \'text-display-sub-title-container\')}>\n               {transitions((style, item: any) => {\n                  return (\n                     <a.div\n                        style={getStyle(style)}\n                        className={classnames(PageStyles.subTitle, \'text-display-sub-title\')}\n                     >\n                        {item}\n                     </a.div>\n                  );\n               })}\n            </div>\n         )}\n      </div>\n   );\n};\n\nexport default AnimationTitle;`, `56920373584177050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> CSSProperties<span class="token punctuation">,</span> ReactNode<span class="token punctuation">,</span> Children<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTransition<span class="token punctuation">,</span> useSpringRef<span class="token punctuation">,</span> useSpring <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties<span class="token punctuation">;</span>\n   animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> TransitionProps <span class="token operator">=</span> Parameters<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useTransition</span><span class="token punctuation">></span></span><span class="token plain-text">[1];\n\nconst AnimationTitle = (</span><span class="token punctuation">{</span>\n   className<span class="token punctuation">,</span>\n   title<span class="token punctuation">,</span>\n   subTitle<span class="token punctuation">,</span>\n   closeIcon <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>\n   delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n   style<span class="token punctuation">,</span>\n   animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   isOnce <span class="token operator">=</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token plain-text">: AnimationTitleProps) => </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> closeIconStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> closeIconRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         rotate<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> titleStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> titleRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      config<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         tension<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>\n         friction<span class="token punctuation">:</span> <span class="token number">14</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> renderSubTitle<span class="token punctuation">:</span> ReactNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>child<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> child<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> transitionProps<span class="token punctuation">:</span> TransitionProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         y<span class="token punctuation">:</span> <span class="token number">50</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">enter</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token function-variable function">delay</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> i <span class="token operator">*</span> <span class="token number">400</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> subTitleRef\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunMultiTime <span class="token operator">||</span> isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      transitionProps<span class="token punctuation">.</span><span class="token function-variable function">keys</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">const</span> transitions <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span>renderSubTitle<span class="token punctuation">,</span> transitionProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            closeIconRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>titleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>subTitleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span> <span class="token string">\'text-display\'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>closeIcon <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>closeIconStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>title <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>titleStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string">\'text-display-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>subTitle <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title-container\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span><span class="token function">transitions</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                        <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n   );\n};\n\nexport default AnimationTitle;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap"><a href="#react-gsap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>为了解决渲染多次组件带来的多次执行动效的问题，之后采用 react-gsap 实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1625025697226756400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n  CSSProperties,\n  ReactNode,\n  Children,\n  useContext,\n  useRef,\n  useEffect\n} from \'react\'\nimport classnames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\nimport { useInViewport } from \'ahooks\'\n\nimport XIcon from \'@/components/xIcon\'\nimport ConfigContext from \'@/components/layout/configContext\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { delayFunc } from \'@/utils\'\n\nimport PageStyles from \'./index.module.less\'\n\nexport interface AnimationTitleProps {\n  className?: string\n  title?: ReactNode\n  subTitle?: ReactNode\n  closeIcon?: ReactNode\n  delay?: number\n  style?: CSSProperties\n  animation?: boolean\n  isOnce?: boolean\n  titleStyle?: CSSProperties\n  closeIconStyle?: CSSProperties\n  reverseAnimationRef?: any\n  startAnimationRef?: any\n}\n\nexport const defaultCloseIcon = (<XIcon\n  name=\'title-x\'\n/>)\n\nconst AnimationTitle = (props: AnimationTitleProps) => {\n  const {\n    className,\n    title,\n    subTitle,\n    closeIcon = defaultCloseIcon,\n    delay = 300,\n    style,\n    animation = true,\n    isOnce = false,\n    closeIconStyle,\n    titleStyle,\n    reverseAnimationRef = null,\n    startAnimationRef = null\n  } = props\n\n  const { isRunMultiTime } = useContext(ConfigContext)\n  const closeIconRef = useRef(null)\n  const titleRef = useRef(null)\n  const subTitleRef = useRef(null)\n\n  const domRef = useRef<HTMLDivElement>(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const { state } = useStoreContext()\n\n  useEffect(() => {\n    if (!animation || state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n    const startAnimation = async () => {\n      await delayFunc(delay)\n      if (closeIcon) {\n        closeIconRef.current?.getGSAP().play()\n      }\n      await delayFunc(200)\n      if (title) {\n        titleRef.current?.getGSAP().play()\n      }\n      // 等 title 动画的一半就开始运行\n      await delayFunc(500)\n      if (subTitle) {\n        await subTitleRef.current?.getGSAP().play()\n      }\n    }\n\n    const reverseAnimation = () => {\n      [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n        item.current?.getGSAP().reverse()\n      })\n    }\n\n    if (reverseAnimationRef) {\n      reverseAnimationRef.current = reverseAnimation\n    }\n\n    if (startAnimationRef) {\n      startAnimationRef.current = startAnimation\n    }\n\n    if (inViewPort) {\n      startAnimation()\n    } else if (isRunMultiTime && !isOnce) {\n      reverseAnimation()\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) {\n    playState = PlayState.stopEnd\n  }\n\n  return (\n    <div\n      className={classnames(\n        PageStyles.textDisplay,\n        \'text-display\',\n        className\n      )}\n      style={style}\n      ref={domRef}\n    >\n      {\n        closeIcon && <Tween\n          ref={closeIconRef}\n          from={{\n            opacity: 0,\n            rotate: -100\n          }}\n          to={{\n            opacity: 1,\n            rotate: 0\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(PageStyles.closeIcon, \'close-icon\')}\n            style={closeIconStyle}\n          >\n            {closeIcon}\n          </div>\n        </Tween>\n      }\n      {\n        title && <Tween\n          ref={titleRef}\n          from={{\n            scale: 0,\n            opacity: 0\n          }}\n          to={{\n            opacity: 1,\n            scale: 1\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(\n              PageStyles.title,\n              \'text-display-title\'\n            )}\n            style={titleStyle}\n          >\n            {title}\n          </div>\n        </Tween>\n      }\n      {\n        subTitle && <div\n          className={classnames(\n            PageStyles.subTitleContainer,\n            \'text-display-sub-title-container\'\n          )}\n        >\n          <Tween\n            ref={subTitleRef}\n            from={{\n              opacity: 0,\n              y: 50\n            }}\n            to={{\n              opacity: 1,\n              y: 0\n            }}\n            stagger={0.6}\n            duration={Children.toArray(subTitle).length * 0.4}\n            playState={playState}\n          >\n            {\n              Children.toArray(subTitle).map((item: any, index: number) => {\n                return (\n                  <div\n                    className={classnames(\n                      PageStyles.subTitle,\n                      \'text-display-sub-title\'\n                    )}\n                    key={index}\n                  >\n                    {item}\n                  </div>\n                )\n              })\n            }\n          </Tween>\n        </div>\n      }\n    </div>\n  )\n}\n\nexport default AnimationTitle`, `1625025697226756400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  CSSProperties<span class="token punctuation">,</span>\n  ReactNode<span class="token punctuation">,</span>\n  Children<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">,</span>\n  useRef<span class="token punctuation">,</span>\n  useEffect\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  titleStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  closeIconStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  reverseAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n  startAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> defaultCloseIcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span>\n  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span>\n<span class="token punctuation">/></span></span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">AnimationTitle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">:</span> AnimationTitleProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    className<span class="token punctuation">,</span>\n    title<span class="token punctuation">,</span>\n    subTitle<span class="token punctuation">,</span>\n    closeIcon <span class="token operator">=</span> defaultCloseIcon<span class="token punctuation">,</span>\n    delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n    style<span class="token punctuation">,</span>\n    animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    isOnce <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    closeIconStyle<span class="token punctuation">,</span>\n    titleStyle<span class="token punctuation">,</span>\n    reverseAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    startAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> props\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>animation <span class="token operator">||</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closeIconRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        titleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 等 title 动画的一半就开始运行</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> subTitleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        item<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverseAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      reverseAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> reverseAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>startAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      startAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> startAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) </span><span class="token punctuation">{</span>\n    playState <span class="token operator">=</span> PlayState<span class="token punctuation">.</span>stopEnd\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n        PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span>\n        <span class="token string">\'text-display\'</span><span class="token punctuation">,</span>\n        className\n      <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        closeIcon <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        title <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n              PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span>\n              <span class="token string">\'text-display-title\'</span>\n            <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        subTitle <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n            PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span>\n            <span class="token string">\'text-display-sub-title-container\'</span>\n          <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>subTitleRef<span class="token punctuation">}</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">50</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">0</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">stagger</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.6</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>\n              Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n                    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n                      PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span>\n                      <span class="token string">\'text-display-sub-title\'</span>\n                    <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                    <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                <span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default AnimationTitle</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-spring-1"><a href="#react-spring-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/b03lty?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-1"><a href="#react-gsap-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yibidu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="数字滚动展示"><a href="#%E6%95%B0%E5%AD%97%E6%BB%9A%E5%8A%A8%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数字滚动展示</h2>\n<h3 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>数字有滚动效果</li>\n<li>整体有位移、透明度变化效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/number-change-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-1"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code> 的选型过程，这里使用的是 react-spring</p>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18149652967464514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode, useRef, useEffect } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTrail, useSprings, useSpringRef } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\ninterface TitleContent {\n   title: string;\n}\n\ninterface NumberContent {\n   number: string;\n   unit: string;\n   precision?: number;\n   render?: (value: number) => string;\n}\n\ninterface CommonDataItem {\n   hint: string;\n}\n\ntype DataItem = CommonDataItem & (TitleContent | NumberContent);\n\ninterface Props {\n   data: DataItem[];\n   className?: string;\n   delay?: number;\n}\n\nconst CarConfiguration = ({ data, className, delay = 300 }: Props) => {\n   const [trails, trailsApi] = useTrail(data.length, () => ({\n      opacity: 0,\n      y: 40\n   }));\n\n   const springsRef = useSpringRef();\n   const springs = useSprings(\n      data.length,\n      data.map((item) => ({\n         ref: springsRef,\n         from: {\n            number: 0\n         },\n         to: {\n            number: Number((item as NumberContent).number)\n         }\n      }))\n   );\n\n   const domRef = useRef();\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         trailsApi.start({\n            y: 0,\n            opacity: 1\n         });\n         await delayFunc(1200);\n         springsRef.start();\n      };\n\n      const reverseAnimation = () => {\n         trailsApi.start({\n            y: 40,\n            opacity: 0\n         });\n         [springsRef].forEach((item) => {\n            item &&\n               item.start({\n                  reverse: true\n               });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort]);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.configuration, className, \'car-configuration\')}>\n         {trails.map((style, index) => {\n            const item = data[index];\n            let title: ReactNode = (item as TitleContent).title;\n            const titleComponent = (\n               <>\n                  <span\n                     className={PageStyles.configurationTitle}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as TitleContent).title }}\n                  />\n                  <span\n                     className={PageStyles.unit}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as any).unit }}\n                  />\n               </>\n            );\n            const numberItem = item as NumberContent;\n            if (!title && numberItem.number) {\n               const renderFunc = numberItem.render\n                  ? numberItem.render\n                  : (value: number) => value.toFixed(numberItem.precision || 0);\n               title = (\n                  <>\n                     <a.span>{springs[index].number.to(renderFunc)}</a.span>\n                     <span\n                        className={PageStyles.unit}\n                        key={Math.random()}\n                        dangerouslySetInnerHTML={{ __html: numberItem.unit }}\n                     />\n                  </>\n               );\n            }\n            return (\n               <>\n                  <a.div\n                     key={index}\n                     className={classnames(PageStyles.configurationItem, \'car-configuration-item\')}\n                     style={style}\n                  >\n                     {typeof title === \'string\' ? (\n                        titleComponent\n                     ) : (\n                        <div className={PageStyles.configurationTitle}>{title} </div>\n                     )}\n                     <div className={PageStyles.configurationHint}>{item.hint}</div>\n                  </a.div>\n                  {index < trails.length - 1 && <a.div key={index} className={PageStyles.divider} style={style} />}\n               </>\n            );\n         })}\n      </div>\n   );\n};\n\nexport default CarConfiguration;`, `18149652967464514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTrail<span class="token punctuation">,</span> useSprings<span class="token punctuation">,</span> useSpringRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">TitleContent</span> <span class="token punctuation">{</span>\n   title<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">NumberContent</span> <span class="token punctuation">{</span>\n   <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   unit<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   precision<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   render<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">CommonDataItem</span> <span class="token punctuation">{</span>\n   hint<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> DataItem <span class="token operator">=</span> CommonDataItem <span class="token operator">&amp;</span> <span class="token punctuation">(</span>TitleContent <span class="token operator">|</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">:</span> DataItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">CarConfiguration</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> className<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">:</span> Props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>trails<span class="token punctuation">,</span> trailsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTrail</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n      opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      y<span class="token punctuation">:</span> <span class="token number">40</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> springsRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> springs <span class="token operator">=</span> <span class="token function">useSprings</span><span class="token punctuation">(</span>\n      data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>\n      data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ref<span class="token punctuation">:</span> springsRef<span class="token punctuation">,</span>\n         <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item <span class="token keyword">as</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         springsRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">[</span>springsRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item <span class="token operator">&amp;&amp;</span>\n               item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configuration<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token string">\'car-configuration\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>trails<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> title<span class="token punctuation">:</span> ReactNode <span class="token operator">=</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n            <span class="token keyword">const</span> titleComponent <span class="token operator">=</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> numberItem <span class="token operator">=</span> item <span class="token keyword">as</span> NumberContent<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>title <span class="token operator">&amp;&amp;</span> numberItem<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">const</span> renderFunc <span class="token operator">=</span> numberItem<span class="token punctuation">.</span>render\n                  <span class="token operator">?</span> numberItem<span class="token punctuation">.</span><span class="token function-variable function">render</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>numberItem<span class="token punctuation">.</span>precision <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               title <span class="token operator">=</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.span</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>springs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>renderFunc<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.span</span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> numberItem<span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n               <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configurationItem<span class="token punctuation">,</span> <span class="token string">\'car-configuration-item\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token punctuation">{</span><span class="token keyword">typeof</span> title <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n                        titleComponent\n                     <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                     <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationHint<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>hint<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token punctuation">{</span>index <span class="token operator">&lt;</span> trails<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>divider<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> CarConfiguration<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-1"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ocnfxs?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="固定页面滚动控制"><a href="#%E5%9B%BA%E5%AE%9A%E9%A1%B5%E9%9D%A2%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>固定页面滚动控制</h2>\n<h3 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现要点：</p>\n<ol>\n<li>随着鼠标滚轮滚动而触发的动效（跟随鼠标滚动，鼠标停顿时，动效也会停顿）</li>\n<li>需要固定页面</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/fix-page-scroll-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-2"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/janpaepke/ScrollMagic" target="_blank" rel="nofollow noreferrer noopener">ScrollMagic</a></td>\n<td align="left">官网例子满足需求</td>\n<td align="left">需要封装成 react</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-scrollmagic" target="_blank" rel="nofollow noreferrer noopener">react-scrollmagic</a></td>\n<td align="left"><ol>\n<li>\n可在 react 中直接使用\n</li>\n<li>\n提供固定页面的百分比可完美用于 react-gsap 动效\n</li>\n</ol></td>\n<td align="left"><ol>\n<li>\n滑动过快会出现“抖动”\n</li>\n<li>\n不能实现切屏 + 固定页面同时存在的效果\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了“抖动”问题</td>\n<td align="left">react-gsap 暴露的 api 不够底层，实现切屏 + 固定页面较困难</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了以上的所有缺点</td>\n<td align="left">代码量过多，react 下需要考虑情况较多</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-scrollmagic"><a href="#react-scrollmagic" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<p>web/components/reactScrollMagic/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69547015564688320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, ReactElement } from \'react\'\nimport { Controller as XPController, Scene, SceneProps as XPSceneProps } from \'xp-react-scrollmagic\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { getWindowHeight } from \'@/utils\'\n\nconst defaultControllerProps = {\n  // container: getDocument()?.querySelector(\'h\')\n}\n\nconst defaultSceneProps = {\n  indicators: false,\n  triggerHook: 0,\n  duration: getWindowHeight()\n}\n\ninterface ProgressEventsParams {\n  progress: number\n  event: {\n    state: string\n    type: string\n  }\n}\n\nexport interface SceneProps {\n  sceneProps?: (Partial<XPSceneProps> & { enableParams: boolean }) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps {\n  children: Array<ReactElement<SceneProps>> | ReactElement<SceneProps>\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => {\n  const { state } = useStoreContext()\n\n  const renderChildren = Children.map(children, (item, index) => {\n    const sceneProps = {\n      ...defaultSceneProps,\n      pin: state?.clientType === CLIENT_TYPE.PC,\n      ...item.props.sceneProps\n    }\n    if (sceneProps.enableParams) {\n      const {\n        enableParams,\n        ...rest\n      } = sceneProps\n      return (\n        <Scene\n          {...rest}\n        >\n          {\n            (progress: number, event: { state: string }) => {\n              return <div>\n                {\n                  cloneElement(item, {\n                    ...item.props,\n                    sceneParams: {\n                      progress,\n                      event\n                    }\n                  })\n                }\n              </div>\n            }\n          }\n        </Scene>\n      )\n    }\n    return (\n      <Scene\n        {...sceneProps}\n      >\n        <div>\n          {item}\n        </div>\n      </Scene>\n    )\n  })\n\n  return (\n    <XPController {...defaultControllerProps}>\n      <div>\n        {renderChildren}\n      </div>\n    </XPController>\n  )\n}\n\nexport default ReactScrollMagic`, `69547015564688320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller <span class="token keyword">as</span> XPController<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> SceneProps <span class="token keyword">as</span> XPSceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'xp-react-scrollmagic\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">const</span> defaultControllerProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// container: getDocument()?.querySelector(\'h\')</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> defaultSceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  indicators<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  triggerHook<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ProgressEventsParams</span> <span class="token punctuation">{</span>\n  progress<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  event<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    state<span class="token punctuation">:</span> <span class="token builtin">string</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SceneProps</span> <span class="token punctuation">{</span>\n  sceneProps<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPSceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text"> &amp; </span><span class="token punctuation">{</span> enableParams<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token plain-text">) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps </span><span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ReactElement<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">> | ReactElement</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> renderChildren <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultSceneProps<span class="token punctuation">,</span>\n      pin<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">.</span>sceneProps\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>sceneProps<span class="token punctuation">.</span>enableParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span>\n        enableParams<span class="token punctuation">,</span>\n        <span class="token operator">...</span>rest\n      <span class="token punctuation">}</span> <span class="token operator">=</span> sceneProps\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token punctuation">{</span> state<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                </span><span class="token punctuation">{</span>\n                  <span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n                    <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n                    sceneParams<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                      progress<span class="token punctuation">,</span>\n                      event\n                    <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token plain-text">\n              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n        <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">sceneProps</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPController</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">defaultControllerProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>renderChildren<span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XPController</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nexport default ReactScrollMagic</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时：</p>\n<p>web/pages/p7/render.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84981523916409360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import ReactScrollMagic from \'@/components/reactScrollMagic\';\nimport { getWindowHeight } from \'@/utils\';\n\n<ReactScrollMagic>\n   <Sepa\n      sceneProps={{\n         enableParams: true,\n         duration: getWindowHeight() * 2 // 总共停 2 屏高度\n      }}\n   />\n</ReactScrollMagic>;`, `84981523916409360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> ReactScrollMagic <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Sepa</span></span>\n      <span class="token attr-name">sceneProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n         enableParams<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token comment">// 总共停 2 屏高度</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">/></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/sepa/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97479387439509030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\n\nimport { l } from \'@/components/lazyLoader\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.sepa.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const [animationTextProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2, // 滚动到一半的时候才开始动效\n      duration: 1 / 2 // 动效的持续百分比\n    }\n  ])\n\n  return (\n    <l.div\n      src=&quot;/public/p7/sepa/p7-p4-1.jpg&quot;\n      minSrcSet=&quot;/public/p7/sepa/p7-p4-1@mini.jpg&quot;\n      srcSet=&quot;/public/p7/sepa/p7-p4-1@2x.jpg&quot;\n      className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n    >\n      <Slot\n        modelType=\'P7\'\n        pageType=\'SEPA\'\n        buttonType=\'Arrow\'\n        itemList={[{\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-1.png\',\n            srcSet: \'/public/p7/d3/P7-d3-1@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle1\'),\n            title: t(\'p7.d3.title1\'),\n            subTitle: t(\'p7.d3.subTitle1\')\n          }\n        }, {\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-2.jpg\',\n            srcSet: \'/public/p7/d3/P7-d3-2@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle2\'),\n            title: t(\'p7.d3.title2\'),\n            subTitle: t(\'p7.d3.subTitle2\')\n          }\n        }]}\n      />\n      <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n        <ModelLeftText\n          topSubTitle={getValue(\'topSubTitle\')}\n          title={getValue(\'title\')}\n          subTitle={getValue(\'subTitle\')}\n          shortDesc={getValue(\'shortDesc\')}\n          buttonProps={{\n            onClick: () => {\n              api.current?.open()\n            },\n            type: \'ghost\'\n          }}\n        />\n      </div>\n      {\n        animationTextProgress > 0 && <AnimationBg type={2} className={styles.animationBg}>\n          <Tween\n            from={{\n              scale: 40\n            }}\n            totalProgress={animationTextProgress}\n            playState={PlayState.pause}\n          >\n            <div className={styles.animationText}>\n              {/* 这里所有国家都是这个，不需要国际化 */}\n              XPILOT\n            </div>\n          </Tween>\n        </AnimationBg>\n      }\n    </l.div>\n  )\n}\n\nexport default Index`, `97479387439509030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.sepa.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>animationTextProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滚动到一半的时候才开始动效</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// 动效的持续百分比</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.div</span>\n      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">minSrcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@mini.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">srcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@2x.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n        <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P7<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>SEPA<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>Arrow<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1.png\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle1\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle2\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n          <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        animationTextProgress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationBg<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              scale<span class="token punctuation">:</span> <span class="token number">40</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">totalProgress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>animationTextProgress<span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PlayState<span class="token punctuation">.</span>pause<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationText<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span><span class="token comment">/* 这里所有国家都是这个，不需要国际化 */</span><span class="token punctuation">}</span><span class="token plain-text">\n              XPILOT\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>l.div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap-2"><a href="#react-gsap-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>后期需要实现 <code class="language-text">切屏 + 固定页面</code> 的效果，暂未实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94697465782290150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, useRef, useEffect, useState } from \'react\';\nimport { gsap } from \'gsap\';\nimport produce from \'immer\';\n\nimport { getDocument } from \'@/utils\';\n\nif (getDocument()) {\n   import(\'gsap/ScrollTrigger\').then((component) => {\n      const ScrollTrigger = component.default;\n      gsap.registerPlugin(ScrollTrigger);\n   });\n}\nconst ReactScrollMagic = ({ children }) => {\n   const revealRefs = useRef([]);\n   const [updateParams, setUpdateParams] = useState([]);\n   revealRefs.current = [];\n\n   useEffect(() => {\n      revealRefs.current.forEach((el, index) => {\n         gsap.from(el, {\n            scrollTrigger: {\n               trigger: el,\n               pin: true,\n               start: \'top top\',\n               end: \'+=300%\',\n               markers: true,\n               anticipatePin: 2, // 滑动过快时的“防抖”参数\n               onUpdate: (self) => {\n                  console.log(\n                     self,\n                     \'progress:\',\n                     self.isActive,\n                     self.progress.toFixed(3),\n                     \'direction:\',\n                     self.direction,\n                     \'velocity\',\n                     self.getVelocity()\n                  );\n                  const { progress, isActive } = self;\n                  setUpdateParams(\n                     produce((draftState) => {\n                        draftState[index] = {\n                           progress,\n                           isActive\n                        };\n                     })\n                  );\n               }\n            }\n         });\n      });\n   }, []);\n\n   const addToRefs = (el, index) => {\n      if (el && !revealRefs.current.includes(el)) {\n         revealRefs.current[index] = el;\n      }\n      console.log(revealRefs.current);\n   };\n\n   return Children.map(children, (item, index) => {\n      // const sceneProps = {\n      //   ...defaultSceneProps,\n      //   ...item.props.sceneProps\n      // }\n      return (\n         <div ref={(el) => addToRefs(el, index)}>\n            {cloneElement(item, {\n               ...item.props,\n               sceneParams: updateParams[index] || {}\n            })}\n         </div>\n      );\n   });\n};\n\nexport default ReactScrollMagic;`, `94697465782290150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> gsap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'gsap\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'gsap/ScrollTrigger\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ScrollTrigger <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>\n      gsap<span class="token punctuation">.</span><span class="token function">registerPlugin</span><span class="token punctuation">(</span>ScrollTrigger<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">const</span> <span class="token function-variable function">ReactScrollMagic</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> revealRefs <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>updateParams<span class="token punctuation">,</span> setUpdateParams<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   revealRefs<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         gsap<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            scrollTrigger<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               trigger<span class="token punctuation">:</span> el<span class="token punctuation">,</span>\n               pin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               start<span class="token punctuation">:</span> <span class="token string">\'top top\'</span><span class="token punctuation">,</span>\n               end<span class="token punctuation">:</span> <span class="token string">\'+=300%\'</span><span class="token punctuation">,</span>\n               markers<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               anticipatePin<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滑动过快时的“防抖”参数</span>\n               <span class="token function-variable function">onUpdate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">self</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n                     self<span class="token punctuation">,</span>\n                     <span class="token string">\'progress:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>isActive<span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                     <span class="token string">\'direction:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>direction<span class="token punctuation">,</span>\n                     <span class="token string">\'velocity\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span><span class="token function">getVelocity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span> progress<span class="token punctuation">,</span> isActive <span class="token punctuation">}</span> <span class="token operator">=</span> self<span class="token punctuation">;</span>\n                  <span class="token function">setUpdateParams</span><span class="token punctuation">(</span>\n                     <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                        draftState<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n                           progress<span class="token punctuation">,</span>\n                           isActive\n                        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n                     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">addToRefs</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> el<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// const sceneProps = {</span>\n      <span class="token comment">//   ...defaultSceneProps,</span>\n      <span class="token comment">//   ...item.props.sceneProps</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addToRefs</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n               <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n               sceneParams<span class="token punctuation">:</span> updateParams<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ReactScrollMagic<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-2"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-scrollmagic-1"><a href="#react-scrollmagic-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6t81il?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-3"><a href="#react-gsap-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jhqw77?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="视频进度同步--缩放动效"><a href="#%E8%A7%86%E9%A2%91%E8%BF%9B%E5%BA%A6%E5%90%8C%E6%AD%A5--%E7%BC%A9%E6%94%BE%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频进度同步 / 缩放动效</h2>\n<h3 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>页面往下完全滚动到第二屏时，视频开始播放，鼠标的滚动一段距离后，触发视频缩小到右下角视频的动效</li>\n<li>文字、图片有缩放效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>视频在视口范围内只会播放一次，完全离开视口重置播放进度，完全进入视口播放视频</li>\n<li>由 2 个视频拼接而成，触发缩放的瞬间进度需要同步（在视频未播放完成的情况下需要同步）</li>\n<li>过渡时需要使用 visibility 来控制显隐</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-sync-scale-play.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-3"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code>、<code class="language-text">固定页面滚动控制</code> 的选型过程</p>\n<h3 id="核心代码-3"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/pages/p7/components/learnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61469199690705570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useRef, useEffect } from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { useInViewport } from \'ahooks\'\nimport { isNumber } from \'lodash\'\n\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport { l, VideoRef } from \'@/components/lazyLoader\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport ModelLearnMore from \'../modelLearnMore\'\n\nimport styles from \'./index.module.less\'\n\nexport type VisibleComponent = \'JsmpegPlayer\' | \'ModelLearnMore\'\n\nconst MAX_THRESHOLD = 0.99\nconst MIN_THRESHOLD = 0.01\nconst THRESHOLD = [MIN_THRESHOLD, MAX_THRESHOLD]\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.learnMore.\\${param}\\`)\n\n  const {\n    progress = 0\n  } = sceneParams || {}\n\n  const [modelLearnMoreProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2,\n      duration: 1 / 2\n    }\n  ])\n\n  // 设置哪个组件可见\n  const [visibleComponent, setVisibleComponent] = useState<VisibleComponent>(\'JsmpegPlayer\')\n\n  const { state } = useStoreContext()\n\n  const videoRef = useRef<VideoRef>(null)\n  const miniVideoRef = useRef<VideoRef>(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, {\n    threshold: THRESHOLD\n  })\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!isNumber(ratio) || !videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'JsmpegPlayer\') {\n      videoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio < MIN_THRESHOLD) {\n      videoDom.currentTime = 0\n      videoDom.pause()\n\n      miniVideoDom.currentTime = 0\n      miniVideoDom.pause()\n      setIsPlayed(false)\n    }\n  }, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.currentTime = videoDom.currentTime\n      if (miniVideoDom.currentTime < miniVideoDom.duration) {\n        miniVideoDom.play()\n      }\n    } else {\n      videoDom.currentTime = miniVideoDom.currentTime\n      if (videoDom.currentTime < videoDom.duration) {\n        videoDom.play()\n      }\n    }\n  }, [visibleComponent])\n\n  let miniVideoProps = {\n    type: \'video\',\n    srcPoster: \'/public/p7/learn-more/p7-wing@mini.jpg\',\n    src: \'/public/p7/learn-more/p7-wing-origin-fast.mp4\'\n  }\n\n  if (state?.clientType === CLIENT_TYPE.PC) {\n    miniVideoProps = {\n      ...miniVideoProps,\n      loop: false,\n      autoPlay: false,\n      ref: miniVideoRef,\n      isNeedScale: true\n    }\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={styles.container}\n    >\n      {\n        state?.clientType === CLIENT_TYPE.PC && <l.video\n          ref={videoRef}\n          loop={false}\n          autoPlay={false}\n          src=&quot;/public/p7/learn-more/p7-wing-origin-fast.mp4&quot;\n          className={classNames(styles.player, visibleComponent !== \'JsmpegPlayer\' ? styles.hidden : \'\')}\n        />\n      }\n      <ModelLearnMore\n        className={state?.clientType === CLIENT_TYPE.PC && visibleComponent !== \'ModelLearnMore\' ? styles.hidden : \'\'}\n        progress={state?.clientType === CLIENT_TYPE.PC ? modelLearnMoreProgress : 100}\n        modelCenterTextProps={{\n          topSubTitle: getValue(\'topSubTitle\'),\n          title: getValue(\'title\'),\n          subTitle: getValue(\'subTitle\'),\n          shortDesc: getValue(\'shortDesc\'),\n          buttonText: getValue(\'button\'),\n          animation: state?.clientType === CLIENT_TYPE.H5\n        }}\n        onSetVisibleComponent={setVisibleComponent}\n        displayersProps={[\n          {\n            src: \'/public/p7/learn-more/p7-p2-1.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-1@2x.jpg\'\n          },\n          {\n            src: \'/public/p7/learn-more/p7-p2-2.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-2@2x.jpg\',\n            minSrcSet: \'/public/p7/learn-more/p7-p2-2@mini.jpg\'\n          },\n          miniVideoProps\n        ]}\n        itemList={[\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-1-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle1\'),\n              title: t(\'p7.d1.title1\'),\n              subTitle: t(\'p7.d1.subTitle1\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-2-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle2\'),\n              title: t(\'p7.d1.title2\'),\n              subTitle: t(\'p7.d1.subTitle2\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-3-1.mp4\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-3-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-3-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle3\'),\n              title: t(\'p7.d1.title3\'),\n              subTitle: t(\'p7.d1.subTitle3\')\n            }\n          }\n        ]}\n      />\n    </div>\n  )\n}\n\nexport default Index`, `61469199690705570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> VideoRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> ModelLearnMore <span class="token keyword">from</span> <span class="token string">\'../modelLearnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">type</span> VisibleComponent <span class="token operator">=</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">|</span> <span class="token string">\'ModelLearnMore\'</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.99</span>\n<span class="token keyword">const</span> <span class="token constant">MIN_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">const</span> <span class="token constant">THRESHOLD</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">,</span> <span class="token constant">MAX_THRESHOLD</span><span class="token punctuation">]</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.learnMore.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>modelLearnMoreProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token comment">// 设置哪个组件可见</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>visibleComponent<span class="token punctuation">,</span> setVisibleComponent<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">(\'JsmpegPlayer\')\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  const videoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const miniVideoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, </span><span class="token punctuation">{</span>\n    threshold<span class="token punctuation">:</span> <span class="token constant">THRESHOLD</span>\n  <span class="token punctuation">}</span><span class="token plain-text">)\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNumber</span><span class="token punctuation">(</span>ratio<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">&lt;</span> <span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> videoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> miniVideoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> miniVideoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> videoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [visibleComponent])\n\n  let miniVideoProps = </span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span><span class="token punctuation">,</span>\n    srcPoster<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing@mini.jpg\'</span><span class="token punctuation">,</span>\n    src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing-origin-fast.mp4\'</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  if (state?.clientType === CLIENT_TYPE.PC) </span><span class="token punctuation">{</span>\n    miniVideoProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>miniVideoProps<span class="token punctuation">,</span>\n      loop<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      autoPlay<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> miniVideoRef<span class="token punctuation">,</span>\n      isNeedScale<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>containerRef<span class="token punctuation">}</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>videoRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">loop</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">autoPlay</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/learn-more/p7-wing-origin-fast.mp4<span class="token punctuation">"</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">,</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLearnMore</span></span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'ModelLearnMore\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">?</span> modelLearnMoreProgress <span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">modelCenterTextProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          topSubTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          title<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          subTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          shortDesc<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          buttonText<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          animation<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">onSetVisibleComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setVisibleComponent<span class="token punctuation">}</span></span>\n        <span class="token attr-name">displayersProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@2x.jpg\'</span><span class="token punctuation">,</span>\n            minSrcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@mini.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          miniVideoProps\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-1.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default Index</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/modelLearnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60259996014184990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useState, Dispatch, SetStateAction, useRef } from \'react\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState, Timeline } from \'react-gsap\'\nimport { useSize } from \'ahooks\'\n\nimport { l, ImgProps, VideoProps } from \'@/components/lazyLoader\'\nimport XButton from \'@/components/xButton\'\nimport ModelCenterText, { ModelCenterTextProps } from \'@/components/modelCenterText\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent, { ImgAndTextSwiperProps } from \'@/hooks/useTmpComponent\'\n\nimport { evaluateCalc, getDocument } from \'@/utils\'\n\nimport { VisibleComponent } from \'../../components/learnMore\'\n\nimport styles from \'./index.module.less\'\n\ntype Repeat<T, C extends number, U extends any[] = []> =\n  U[\'length\'] extends C ? U : Repeat<T, C, [...U, T]>\n\ntype DisplayerProps = ((ImgProps & { type?: \'img\'}) | (VideoProps & { type?: \'video\' })) & {\n  isNeedScale?: boolean\n}\n\ninterface ModelLearnMoreProps {\n  modelCenterTextProps: ModelCenterTextProps\n  displayersProps: Repeat<DisplayerProps, 3>\n  progress?: number\n  className?: string\n  onSetVisibleComponent?: Dispatch<SetStateAction<VisibleComponent>>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps & ImgAndTextSwiperProps) => {\n  const { api, Slot } = useTmpComponent()\n\n  const getFromProps = () => {\n    const startBottom = \'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'\n    const startRight = \'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'\n\n    return {\n      // 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2\n      // bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',\n      // right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',\n      bottom: \\`-\\${evaluateCalc(startBottom)}px\\`,\n      right: \\`-\\${evaluateCalc(startRight)}px\\`,\n      width: \'calc(100vw - 0.520833rem)\',\n      height: \'100vh\',\n      scale: 0.5\n    }\n  }\n\n  const tweenRef = useRef(null)\n  const size = useSize(getDocument()?.documentElement)\n  useEffect(() => {\n    if (!tweenRef.current) {\n      return\n    }\n\n    tweenRef.current.getGSAP().vars = {\n      ...tweenRef.current.getGSAP().vars,\n      startAt: getFromProps()\n    }\n  }, [size])\n\n  const timerRef = useRef<NodeJS.Timeout>()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => {\n    if (progress >= 0) {\n      onSetVisibleComponent && onSetVisibleComponent(\'ModelLearnMore\')\n    } else {\n      timerRef.current = setTimeout(() => {\n        onSetVisibleComponent && onSetVisibleComponent(\'JsmpegPlayer\')\n      }, 800)\n    }\n    return () => {\n      timerRef.current && clearTimeout(timerRef.current)\n    }\n  }, [progress])\n\n  const { buttonText, ...rest } = modelCenterTextProps\n  return (\n    <AnimationBg type={1} className={className}>\n      <Slot\n        itemList={itemList}\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      <div ref={ref} className={classNames(\'full-page-with-top-menu\', styles.container)}>\n        <Tween\n          from={{\n            scale: 2\n          }}\n          duration={0.8}\n          playState={progress > 0 ? PlayState.play : PlayState.reverse}\n        >\n          <div className={classNames(\'body\', styles.body)}>\n            <ModelCenterText\n              className={styles.titleContainer}\n              {...rest}\n            />\n            <div className={styles.displayerContainer}>\n              {\n                displayersProps.map((item, index) => {\n                  const {\n                    type = \'img\',\n                    isNeedScale,\n                    ...rest\n                  } = item\n                  const Component = l[type]\n                  if (isNeedScale) {\n                    return (\n                      <Timeline\n                        playState={progress > 0 ? PlayState.play : PlayState.reverse}\n                        target={\n                          <>\n                            <div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                              <Component\n                                className={styles.displayer}\n                                {...rest}\n                              />\n                            </div>\n                          </>\n                        }\n                      >\n                        <Tween\n                          ref={tweenRef}\n                          from={getFromProps()}\n                          to={{\n                            width: \'23.65rem\',\n                            height: \'13.33rem\',\n                            bottom: 0,\n                            right: 0,\n                            scale: 1\n                          }}\n                          target={0}\n                        />\n                      </Timeline>\n                    )\n                  }\n                  return (<div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                    <Component\n                      className={styles.displayer}\n                      {...rest}\n                    />\n                  </div>)\n                })\n              }\n            </div>\n            <XButton\n              type=&quot;primary&quot;\n              className={styles.button}\n              onClick={() => {\n                api.current?.open()\n              }\n              }\n            >\n              {buttonText}\n            </XButton>\n          </div>\n        </Tween>\n      </div>\n    </AnimationBg>\n  )\n}\n\nexport default ModelLearnMore`, `60259996014184990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> Dispatch<span class="token punctuation">,</span> SetStateAction<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState<span class="token punctuation">,</span> Timeline <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> ImgProps<span class="token punctuation">,</span> VideoProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n<span class="token keyword">import</span> ModelCenterText<span class="token punctuation">,</span> <span class="token punctuation">{</span> ModelCenterTextProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> ImgAndTextSwiperProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> evaluateCalc<span class="token punctuation">,</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> VisibleComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../../components/learnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">type</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token keyword">extends</span> <span class="token class-name">number</span><span class="token punctuation">,</span> <span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token operator">=</span>\n  <span class="token constant">U</span><span class="token punctuation">[</span><span class="token string">\'length\'</span><span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token class-name">C</span> <span class="token operator">?</span> <span class="token constant">U</span> <span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token constant">U</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">></span>\n\n<span class="token keyword">type</span> DisplayerProps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ImgProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'img\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>VideoProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n  isNeedScale<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ModelLearnMoreProps</span> <span class="token punctuation">{</span>\n  modelCenterTextProps<span class="token punctuation">:</span> ModelCenterTextProps\n  displayersProps<span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span>DisplayerProps<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">></span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  onSetVisibleComponent<span class="token operator">?</span><span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>SetStateAction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps &amp; ImgAndTextSwiperProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getFromProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> startBottom <span class="token operator">=</span> <span class="token string">\'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'</span>\n    <span class="token keyword">const</span> startRight <span class="token operator">=</span> <span class="token string">\'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2</span>\n      <span class="token comment">// bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',</span>\n      <span class="token comment">// right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',</span>\n      bottom<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startBottom<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      right<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startRight<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      width<span class="token punctuation">:</span> <span class="token string">\'calc(100vw - 0.520833rem)\'</span><span class="token punctuation">,</span>\n      height<span class="token punctuation">:</span> <span class="token string">\'100vh\'</span><span class="token punctuation">,</span>\n      scale<span class="token punctuation">:</span> <span class="token number">0.5</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> tweenRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">useSize</span><span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars<span class="token punctuation">,</span>\n      startAt<span class="token punctuation">:</span> <span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> timerRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NodeJS.Timeout</span></span><span class="token punctuation">></span></span><span class="token plain-text">()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [progress])\n\n  const </span><span class="token punctuation">{</span> buttonText<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token plain-text"> = modelCenterTextProps\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      &lt;Slot\n        itemList=</span><span class="token punctuation">{</span>itemList<span class="token punctuation">}</span><span class="token plain-text">\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">2</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.8</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelCenterText</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>titleContainer<span class="token punctuation">}</span></span>\n              <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayerContainer<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>\n                displayersProps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">\'img\'</span><span class="token punctuation">,</span>\n                    isNeedScale<span class="token punctuation">,</span>\n                    <span class="token operator">...</span>rest\n                  <span class="token punctuation">}</span> <span class="token operator">=</span> item\n                  <span class="token keyword">const</span> Component <span class="token operator">=</span> l<span class="token punctuation">[</span><span class="token keyword">type</span><span class="token punctuation">]</span>\n                  <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedScale<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Timeline</span></span>\n                        <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>\n                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                                <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                                <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                              <span class="token punctuation">/></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n                        <span class="token punctuation">}</span></span>\n                      <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n                          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>tweenRef<span class="token punctuation">}</span></span>\n                          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                            width<span class="token punctuation">:</span> <span class="token string">\'23.65rem\'</span><span class="token punctuation">,</span>\n                            height<span class="token punctuation">:</span> <span class="token string">\'13.33rem\'</span><span class="token punctuation">,</span>\n                            bottom<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            right<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n                          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span>\n                        <span class="token punctuation">/></span></span><span class="token plain-text">\n                      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Timeline</span></span><span class="token punctuation">></span></span>\n                    <span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                      <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                    <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span>\n              <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span></span>\n              <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span></span>\n            <span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>buttonText<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default ModelLearnMore</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化"><a href="#%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="计算-calc-的实际-px-值"><a href="#%E8%AE%A1%E7%AE%97-calc-%E7%9A%84%E5%AE%9E%E9%99%85-px-%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算 calc 的实际 px 值</h4>\n<p>web/utils/index.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37970309560185100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 只支持计算值为正值\nexport const evaluateCalc = (expression: string, container = getDocument()?.body) => {\n  // 不能加以下代码，影响动效\n  // if (!container || !Object.keys(container).length) {\n  //   return 0\n  // }\n  if (!__isBrowser__) {\n    return 0\n  }\n  const el = document.createElement(\'div\')\n  el.style.position = \'absolute\'\n  el.style.visibility = \'hidden\'\n  el.innerHTML = \\`<div style=&quot;width: \\${expression}&quot;></div>\\`\n  container.insertBefore(el, container.firstChild)\n  const calcPx = el.clientWidth\n  container.removeChild(el)\n  return calcPx\n}`, `37970309560185100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token comment">// 只支持计算值为正值</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">evaluateCalc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">expression<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> container <span class="token operator">=</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>body</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 不能加以下代码，影响动效</span>\n  <span class="token comment">// if (!container || !Object.keys(container).length) {</span>\n  <span class="token comment">//   return 0</span>\n  <span class="token comment">// }</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__isBrowser__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'absolute\'</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">\'hidden\'</span>\n  el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div style="width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/div></span><span class="token template-punctuation string">`</span></span>\n  container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> calcPx <span class="token operator">=</span> el<span class="token punctuation">.</span>clientWidth\n  container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> calcPx\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="p7-resize-后动画定位不准的-bug"><a href="#p7-resize-%E5%90%8E%E5%8A%A8%E7%94%BB%E5%AE%9A%E4%BD%8D%E4%B8%8D%E5%87%86%E7%9A%84-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>p7 resize 后动画定位不准的 bug</h4>\n<p>需要全部使用 rem 单位，否则 resize 后定位不准</p>\n<h3 id="运行效果-3"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/2h37rw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="序列帧滚动控制"><a href="#%E5%BA%8F%E5%88%97%E5%B8%A7%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列帧滚动控制</h2>\n<h3 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现如下所示动效，随着鼠标滚轮滚动播放视频或图片</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-frame-scroll-control.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-4"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<h4 id="视频方向"><a href="#%E8%A7%86%E9%A2%91%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频方向</h4>\n<ol>\n<li>\n<p>video + av01、vp9、h264 编码的 mp4 视频（av01、vp9、h264 编码一一尝试，随着文件体积的增加，解码性能逐渐增加，但以 UI 给的视频素材测试 h264 在某些电脑比如苹果电脑上还是卡顿；在此过程中一旦使用 ffmpeg 压缩 UI 给的视频素材会导致卡顿，暂时未知是解码性能的原因还是使用了 currentTime 无法跳转到指定帧，只能跳转到关键帧，而关键帧之间并不是连续的流畅画面，fps 不平均的原因）</p>\n</li>\n<li>\n<p>ogv.js + vp9 编码的 webm 视频（解码速度较慢导致卡顿、随机跳转会报错且视频会卡住）</p>\n</li>\n<li>\n<p>提前将 video 的每一帧预渲染，可能效率较低，导致浏览器卡住，相关库：<a href="https://github.com/rnicholus/frame-grab.js" target="_blank" rel="nofollow noreferrer noopener">frame-grab</a>、<a href="https://github.com/wch1n/video-frame-previewer" target="_blank" rel="nofollow noreferrer noopener">video-frame-previewer</a>、<a href="https://github.com/feross/capture-frame" target="_blank" rel="nofollow noreferrer noopener">capture-frame</a></p>\n</li>\n<li>\n<p>jsmpeg + mpeg1 编码的 mpeg 视频（最新版本得不到总帧数、无法实现帧寻址、采用 ts 流导致不能立马跳转成功、实际使用 currentTime 无法跳成功等等缺点，故使用 v0.2 实现。缺点：同等画质下体积较大；颜色范围有限制 16~235，即不能纯白纯黑。优点：解码速度满足要求）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77793800715589040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# ts 压缩\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf 0 -r 20 -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf 0 -r 20 -an demo.mpeg\n\n# mpeg 压缩\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf 0 -r 30 -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 30 -an demo@2048.mpeg\n\n# mp4 压缩\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf 0 -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart p7-p3-1@2048.mp4\n\n# 批量压缩\n#!/bin/bash\nfor i in *.mp4\ndo\n  echo &quot;File \\$i selected&quot;\n  # ffmpeg -i &quot;\\$i&quot; &quot;\\$i.mp3&quot;\n  ffmpeg -i &quot;\\$i&quot; -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart &quot;\\$i.mp4&quot;\ndone`, `77793800715589040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># ts 压缩</span>\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo.mpeg\n\n<span class="token comment"># mpeg 压缩</span>\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">30</span> -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">30</span> -an demo@2048.mpeg\n\n<span class="token comment"># mp4 压缩</span>\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart p7-p3-1@2048.mp4\n\n<span class="token comment"># 批量压缩</span>\n<span class="token comment">#!/bin/bash</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> *.mp4\n<span class="token keyword">do</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"File <span class="token variable">$i</span> selected"</span>\n  <span class="token comment"># ffmpeg -i "$i" "$i.mp3"</span>\n  ffmpeg -i <span class="token string">"<span class="token variable">$i</span>"</span> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart <span class="token string">"<span class="token variable">$i</span>.mp4"</span>\n<span class="token keyword">done</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h4 id="图片方向"><a href="#%E5%9B%BE%E7%89%87%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图片方向</h4>\n<ol>\n<li>预加载所有图片 + 图片序列帧（参考张博客，体积较大）</li>\n<li>pixi-apngAndGif，使用 apng 控制播放进度（体积太大）</li>\n<li>针对方案 1，使用 avif + avif.js，暂时未知解码性能如何，猜测同样都是 av1 解码，可能解码性能不行；</li>\n<li>针对方案 1，使用 webp，解码性能同样可能不行</li>\n<li>针对方案 1，使用 jpg</li>\n</ol>\n<h3 id="核心代码-4"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="pixi-apngandgif"><a href="#pixi-apngandgif" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1041410419855326500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useRef, useState } from \'react\'\nimport { InputNumber } from \'antd\'\n\nimport XButton from \'@/components/xButton\'\n\nconst Index = () => {\n  const domRef = useRef(null)\n  const [apngApi, setApngApi] = useState()\n  const [value, setValue] = useState(0)\n\n  useEffect(() => {\n    import(\'@/lib/pixi-apng\').then((pixiApng) => {\n      const PixiApng = pixiApng.default\n      const { PIXI } = pixiApng\n      const app = new PIXI.Application({\n        width: domRef.current?.width,\n        height: domRef.current?.height,\n        view: domRef.current,\n        transparent: true,\n        antialias: true\n      })\n      const loader = PIXI.Loader.shared\n      const loadOption = {\n        loadType: PIXI.LoaderResource.LOAD_TYPE.XHR,\n        xhrType: PIXI.LoaderResource.XHR_RESPONSE_TYPE.BUFFER,\n        crossOrigin: \'\'\n      }\n      const imgs = {\n        apng: \'/public/demo/demo.png\'\n      }\n      loader.add(imgs.apng, loadOption)\n\n      loader.load((progress, resources) => {\n        const apngApi = new PixiApng(imgs.apng, resources)\n        setApngApi(apngApi)\n        const apngSprite = apngApi.sprite\n\n        apngSprite.x = 0\n        apngSprite.y = 0\n\n        apngSprite.width = 1000\n        apngSprite.height = 500\n\n        app.stage.addChild(apngSprite)\n      })\n    })\n  }, [])\n\n  return (\n    <div style={{ marginTop: 100, width: 1920, height: 1080 }}>\n      <XButton onClick={() => {\n        apngApi.play()\n      }}>\n        开始\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.pause()\n      }}>\n        停止\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.stop()\n      }}>\n        终止\n      </XButton>\n      <InputNumber value={value} onChange={setValue} precision={0} />\n      <XButton onClick={() => {\n        apngApi.jumpToFrame(value)\n      }}>\n        停到第几帧\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getDuration())\n      }}>\n        时长\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getFramesLength())\n      }}>\n        帧数\n      </XButton>\n      <canvas ref={domRef} width=&quot;1920&quot; height=&quot;1080&quot;></canvas>\n    </div>\n  )\n}\n\nexport default Index`, `1041410419855326500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> InputNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span>\n\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>apngApi<span class="token punctuation">,</span> setApngApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'@/lib/pixi-apng\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pixiApng</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> PixiApng <span class="token operator">=</span> pixiApng<span class="token punctuation">.</span><span class="token keyword">default</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PIXI</span> <span class="token punctuation">}</span> <span class="token operator">=</span> pixiApng\n      <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Application</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        width<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n        height<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n        view<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n        transparent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        antialias<span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>Loader<span class="token punctuation">.</span>shared\n      <span class="token keyword">const</span> loadOption <span class="token operator">=</span> <span class="token punctuation">{</span>\n        loadType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">LOAD_TYPE</span><span class="token punctuation">.</span><span class="token constant">XHR</span><span class="token punctuation">,</span>\n        xhrType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">XHR_RESPONSE_TYPE</span><span class="token punctuation">.</span><span class="token constant">BUFFER</span><span class="token punctuation">,</span>\n        crossOrigin<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token punctuation">{</span>\n        apng<span class="token punctuation">:</span> <span class="token string">\'/public/demo/demo.png\'</span>\n      <span class="token punctuation">}</span>\n      loader<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> loadOption<span class="token punctuation">)</span>\n\n      loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">,</span> resources</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> apngApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PixiApng</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> resources<span class="token punctuation">)</span>\n        <span class="token function">setApngApi</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">)</span>\n        <span class="token keyword">const</span> apngSprite <span class="token operator">=</span> apngApi<span class="token punctuation">.</span>sprite\n\n        apngSprite<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span>\n        apngSprite<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span>\n\n        apngSprite<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1000</span>\n        apngSprite<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">500</span>\n\n        app<span class="token punctuation">.</span>stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>apngSprite<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginTop<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">1080</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        开始\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        终止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputNumber</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setValue<span class="token punctuation">}</span></span> <span class="token attr-name">precision</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">jumpToFrame</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停到第几帧\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        时长\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getFramesLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        帧数\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1920<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1080<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="ogvjs"><a href="#ogvjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24746036418817960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\';\nimport classNames from \'classnames\';\nimport { useInViewport, useAsyncEffect } from \'ahooks\';\n\nimport { loadScript } from \'@/utils\';\n\nimport styles from \'./index.module.less\';\n\ninterface JsmpegPlayerProps {\n   src: string;\n   progress?: number; // 播放进度，0~1\n   className?: string;\n   autoplay?: boolean;\n   loop?: boolean;\n   seekable?: boolean;\n   preserveDrawingBuffer?: boolean;\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({ src, progress, className, ...rest }: JsmpegPlayerProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true);\n   const playerRef = useRef();\n   const domRef = useRef(null);\n\n   useAsyncEffect(async () => {\n      await loadScript(\'/public/lib/ogvjs-1.8.6/ogv.js\');\n      setIsLoadJsmpeg(false);\n   }, []);\n\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      if (!inViewPort || isLoadJsmpeg || !isLoad) {\n         return;\n      }\n      // eslint-disable-next-line new-cap\n      playerRef.current = new window.OGVPlayer({\n         wasm: true, // force,\n         simd: true // experimental\n         // threading: true\n      });\n      domRef.current.appendChild(playerRef.current);\n      playerRef.current.muted = true;\n      playerRef.current.src = src;\n      playerRef.current.addEventListener(\'loadedmetadata\', () => {\n         setIsLoad(false);\n      });\n   }, [inViewPort, isLoadJsmpeg]);\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\') {\n         return;\n      }\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      console.log(\'calcProgress\', calcProgress);\n      playerRef.current.currentTime = calcProgress * playerRef.current.duration;\n   }, [progress, isLoad]);\n\n   return <div ref={domRef}></div>;\n};\n\nexport default JsmpegPlayer;`, `24746036418817960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n   src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token comment">// 播放进度，0~1</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   autoplay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   loop<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   seekable<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   preserveDrawingBuffer<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/ogvjs-1.8.6/ogv.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line new-cap</span>\n      playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>OGVPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         wasm<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// force,</span>\n         simd<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// experimental</span>\n         <span class="token comment">// threading: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>playerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'loadedmetadata\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'calcProgress\'</span><span class="token punctuation">,</span> calcProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="video"><a href="#video" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>web/components/lazyLoader/components/video/components/core/hooks/useProgressControl.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55090834945751750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useState } from \'react\';\n\nimport { CommonProps } from \'../index\';\n\nexport interface UseProgressControlProps {\n   progress?: number;\n   playStrategy?: \'progressControl\';\n}\n\nconst useProgressControl = ({\n   progress,\n   playStrategy,\n   onSetVideoProps,\n   domRef\n}: UseProgressControlProps & CommonProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [duration, setDuration] = useState(0);\n\n   const handleLoadedMetadata = () => {\n      const { duration } = domRef.current;\n      setDuration(duration);\n      setIsLoad(false);\n   };\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\' || playStrategy !== \'progressControl\') {\n         return;\n      }\n\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      domRef.current.currentTime = calcProgress * duration;\n   }, [progress, isLoad]);\n\n   useEffect(() => {\n      if (playStrategy === \'progressControl\') {\n         onSetVideoProps({\n            muted: true,\n            playsInline: true,\n            preload: \'metadata\'\n         });\n      }\n   }, [playStrategy]);\n\n   return {\n      handleLoadedMetadata\n   };\n};\n\nexport default useProgressControl;`, `55090834945751750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../index\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UseProgressControlProps</span> <span class="token punctuation">{</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   playStrategy<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useProgressControl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n   progress<span class="token punctuation">,</span>\n   playStrategy<span class="token punctuation">,</span>\n   onSetVideoProps<span class="token punctuation">,</span>\n   domRef\n<span class="token punctuation">}</span><span class="token punctuation">:</span> UseProgressControlProps <span class="token operator">&amp;</span> CommonProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>duration<span class="token punctuation">,</span> setDuration<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleLoadedMetadata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> duration <span class="token punctuation">}</span> <span class="token operator">=</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n      <span class="token function">setDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span> <span class="token operator">||</span> playStrategy <span class="token operator">!==</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>playStrategy <span class="token operator">===</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">onSetVideoProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            muted<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            playsInline<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            preload<span class="token punctuation">:</span> <span class="token string">\'metadata\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>playStrategy<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      handleLoadedMetadata\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useProgressControl<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="jsmpeg"><a href="#jsmpeg" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<p>现阶段采用的技术选型</p>\n<p>web/components/jsmpegPlayer/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57394417838488620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\'\nimport classNames from \'classnames\'\nimport { useInViewport, useAsyncEffect } from \'ahooks\'\n\nimport { l } from \'@/components/lazyLoader\'\n\nimport { loadScript } from \'@/utils\'\n\nimport styles from \'./index.module.less\'\n\ninterface JsmpegPlayerProps {\n  src: string\n  progress?: number // 播放进度，0~1\n  className?: string\n  poster?: string\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({\n  src,\n  progress,\n  className,\n  poster,\n  ...rest\n}: JsmpegPlayerProps) => {\n  const [isLoad, setIsLoad] = useState(true)\n  const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true)\n  const playerRef = useRef()\n  const domRef = useRef(null)\n\n  useAsyncEffect(async () => {\n    await loadScript(\'/public/lib/jsmpeg.min.js\')\n    setIsLoadJsmpeg(false)\n  }, [])\n\n  const [inViewPort] = useInViewport(domRef)\n  useEffect(() => {\n    if (!inViewPort || isLoadJsmpeg || !isLoad) {\n      return\n    }\n    // eslint-disable-next-line new-cap\n    playerRef.current = new window.jsmpeg(src, {\n      ...rest,\n      canvas: domRef.current?.querySelector(\'canvas\'),\n      seekable: true,\n      onload: () => {\n        setIsLoad(false)\n        // console.log(playerRef.current?.duration, playerRef.current?.frameCount)\n      }\n    })\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isLoadJsmpeg])\n\n  useEffect(() => {\n    if (isLoad || typeof progress !== \'number\') {\n      return\n    }\n    const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress\n    const frameCount = playerRef.current?.frameCount - 1 // 最大帧需减一\n    playerRef.current?.seekToFrame(calcProgress * frameCount, true)\n  }, [progress, isLoad])\n\n  const isShowPoster = (isLoad || isLoadJsmpeg) && poster\n  return <div\n    ref={domRef}\n    className={classNames(styles.container, className)}\n  >\n    <div className={styles.body}>\n      <canvas\n        className={styles.video}\n      />\n      {\n        isShowPoster && <l.img\n          src={poster}\n          className={styles.poster}\n        />\n      }\n    </div>\n  </div>\n}\n\nexport default JsmpegPlayer`, `57394417838488620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n  src<span class="token punctuation">:</span> <span class="token builtin">string</span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 播放进度，0~1</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  poster<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  src<span class="token punctuation">,</span>\n  progress<span class="token punctuation">,</span>\n  className<span class="token punctuation">,</span>\n  poster<span class="token punctuation">,</span>\n  <span class="token operator">...</span>rest\n<span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/jsmpeg.min.js\'</span><span class="token punctuation">)</span>\n    <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line new-cap</span>\n    playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>jsmpeg</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>rest<span class="token punctuation">,</span>\n      canvas<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      seekable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onload</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n        <span class="token comment">// console.log(playerRef.current?.duration, playerRef.current?.frameCount)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress\n    <span class="token keyword">const</span> frameCount <span class="token operator">=</span> playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>frameCount <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 最大帧需减一</span>\n    playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">seekToFrame</span><span class="token punctuation">(</span>calcProgress <span class="token operator">*</span> frameCount<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowPoster <span class="token operator">=</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> isLoadJsmpeg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> poster\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n    <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n  <span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>video<span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        isShowPoster <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.img</span>\n          <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>poster<span class="token punctuation">}</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>poster<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p5/components/smartSpaceInternal/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26120635569047822000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\n\nimport ModelCenterText from \'@/components/modelCenterText\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport JsmpegPlayer from \'@/components/jsmpegPlayer\'\nimport { l } from \'@/components/lazyLoader\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\nimport useStoreContext, { CLIENT_TYPE, DATA_ANALYSIS_TYPES } from \'@/hooks/useStoreContext\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\nimport { dataAnalysisClickTrack } from \'@/utils/dataAnalysis\'\nimport XTracker from \'@/components/xTracker\'\nimport { setDataLayer } from \'@/hooks/useSetDataLayer\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const trackRef = XTracker.useExposureNode({\n    type: \'P5\',\n    event: \'IntelligentSpace_Show\'\n  })\n  const getValue = (param: string) => t(\\`p5.smartSpaceInternal.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const { state } = useStoreContext()\n\n  const [playerProgress] = getAnimateProgresses(progress, [\n    {\n      start: 0,\n      duration: 2 / 3\n    }\n  ])\n\n  const isShowAnimationText = playerProgress > 0.47 // 窗帘收起时文字出现\n\n  return (\n    <>\n      {\n        state?.clientType === CLIENT_TYPE.PC && <JsmpegPlayer\n          className={styles.player}\n          src=&quot;/public/p5/smart-space-internal/p5-inside.mpeg&quot;\n          poster=&quot;/public/p5/smart-space-internal/p5-inside-first-frame.jpg&quot;\n          progress={playerProgress}\n        />\n      }\n      <div\n        className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n      >\n        {\n          state?.clientType === CLIENT_TYPE.H5 && <l.video\n            className={styles.player}\n            src=&quot;/public/p5/smart-space-internal/p5-inside-origin.mp4&quot;\n            srcPoster=&quot;/public/p5/smart-space-internal/p5-inside@mini.jpg&quot;\n            playIconPosition=&quot;bottom&quot;\n          />\n        }\n        <Slot\n          modelType=\'P5\'\n          pageType=\'IntelligentSpace\'\n          buttonType=\'LearnMore\'\n          itemList={[{\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-1.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-1@2x.jpg\'\n            }],\n            background: \'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle1\'),\n              title: t(\'p5.d3.title1\'),\n              subTitle: t(\'p5.d3.subTitle1\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-2.mp4\'\n            }],\n            background: \'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle2\'),\n              title: t(\'p5.d3.title2\'),\n              subTitle: t(\'p5.d3.subTitle2\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-3.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-3@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle3\'),\n              title: t(\'p5.d3.title3\'),\n              subTitle: t(\'p5.d3.subTitle3\')\n            }\n          }]}\n        />\n        <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n          {\n            isShowAnimationText && state?.clientType === CLIENT_TYPE.PC && <ModelCenterText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonText={getValue(\'button\')}\n              buttonProps={{\n                onClick: () => {\n                  dataAnalysisClickTrack(\\`\\${DATA_ANALYSIS_TYPES.P5}_IntelligentSpace_LearnMoreBtn\\`)\n                  api?.current?.open()\n                  setDataLayer({\n                    event_category: \'click_button\',\n                    car_model: \'p5\',\n                    button_group: \'learn more\',\n                    click_text: getValue(\'button\')\n                  })\n                },\n                type: \'ghost\',\n                dark: true,\n                plain: true\n              }}\n              closeIcon={null}\n            />\n          }\n          {\n            state?.clientType === CLIENT_TYPE.H5 && <ModelLeftText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonProps={{\n                onClick: () => {\n                  api?.current?.open()\n                },\n                type: \'ghost\'\n              }}\n              closeIcon={null}\n            />\n          }\n        </div>\n      </div>\n    </>\n\n  )\n}\n\nexport default Index`, `26120635569047822000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n\n<span class="token keyword">import</span> ModelCenterText <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> JsmpegPlayer <span class="token keyword">from</span> <span class="token string">\'@/components/jsmpegPlayer\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">,</span> <span class="token constant">DATA_ANALYSIS_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> dataAnalysisClickTrack <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/dataAnalysis\'</span>\n<span class="token keyword">import</span> XTracker <span class="token keyword">from</span> <span class="token string">\'@/components/xTracker\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDataLayer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useSetDataLayer\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> trackRef <span class="token operator">=</span> XTracker<span class="token punctuation">.</span><span class="token function">useExposureNode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'P5\'</span><span class="token punctuation">,</span>\n    event<span class="token punctuation">:</span> <span class="token string">\'IntelligentSpace_Show\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p5.smartSpaceInternal.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>playerProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowAnimationText <span class="token operator">=</span> playerProgress <span class="token operator">></span> <span class="token number">0.47</span> <span class="token comment">// 窗帘收起时文字出现</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">JsmpegPlayer</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside.mpeg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-first-frame.jpg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playerProgress<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>\n          state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n            <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-origin.mp4<span class="token punctuation">"</span></span>\n            <span class="token attr-name">srcPoster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside@mini.jpg<span class="token punctuation">"</span></span>\n            <span class="token attr-name">playIconPosition</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bottom<span class="token punctuation">"</span></span>\n          <span class="token punctuation">/></span></span>\n        <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n          <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P5<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>IntelligentSpace<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>LearnMore<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-2.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            isShowAnimationText <span class="token operator">&amp;&amp;</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>ModelCenterText\n              topSubTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              subTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              shortDesc<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonText<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonProps<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token function">dataAnalysisClickTrack</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DATA_ANALYSIS_TYPES</span><span class="token punctuation">.</span><span class="token constant">P5</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IntelligentSpace_LearnMoreBtn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token function">setDataLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    event_category<span class="token punctuation">:</span> <span class="token string">\'click_button\'</span><span class="token punctuation">,</span>\n                    car_model<span class="token punctuation">:</span> <span class="token string">\'p5\'</span><span class="token punctuation">,</span>\n                    button_group<span class="token punctuation">:</span> <span class="token string">\'learn more\'</span><span class="token punctuation">,</span>\n                    click_text<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span><span class="token punctuation">,</span>\n                dark<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                plain<span class="token punctuation">:</span> <span class="token boolean">true</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span>\n              closeIcon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span>\n            <span class="token operator">/</span><span class="token operator">></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n              <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">closeIcon</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-4"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="pixi-apngandgif-1"><a href="#pixi-apngandgif-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fzmi7s?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="ogvjs-1"><a href="#ogvjs-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/dv2njm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="video-1"><a href="#video-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>利用 <code class="language-text">懒加载</code> 功能写出的进度控制如下：</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/16i1lw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="jsmpeg-1"><a href="#jsmpeg-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0ywivn?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="优化-1"><a href="#%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h4>\n<p>视频批量压缩脚本、支持单个压缩（有声音、转 mpeg 单独压缩）</p>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40469405263189475000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `40469405263189475000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34460877535488123000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const ProgressBar = require(\'progress\');\nconst os = require(\'os\');\nconst cpus = os.cpus();\n\n/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = cpus.length + 1, taskName = \'未命名\') {\n   if (!fnList.length) return;\n\n   console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n   const bar = new ProgressBar(\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n      total: fnList.length\n   });\n\n   const replyList = []; // 收集任务执行结果\n   // const count = fnList.length // 总任务数量\n   const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n   // let current = 0\n   // 任务执行程序\n   const schedule = async (index) => {\n      // eslint-disable-next-line no-async-promise-executor\n      return new Promise(async (resolve) => {\n         try {\n            const fn = fnList[index];\n            if (!fn) return resolve();\n\n            // 执行当前异步任务\n            const reply = await fn();\n            replyList[index] = reply;\n         } catch (e) {\n            console.log(e);\n            // 报错了不管继续下一个\n            resolve();\n         }\n\n         bar.tick();\n         // current++\n         // console.log(\n         //   \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n         // )\n\n         // 执行完当前任务后，继续执行任务池的剩余任务\n         await schedule(index + max);\n         resolve();\n      });\n   };\n\n   // 任务池执行程序\n   const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n   // 使用 Promise.all 批量执行\n   await Promise.all(scheduleList);\n\n   const cost = (new Date().getTime() - startTime) / 1000;\n   if (bar.complete) {\n      console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n   }\n   return replyList;\n};`, `34460877535488123000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> cpus<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      total<span class="token punctuation">:</span> fnList<span class="token punctuation">.</span>length\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n   <span class="token comment">// const count = fnList.length // 总任务数量</span>\n   <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n   <span class="token comment">// let current = 0</span>\n   <span class="token comment">// 任务执行程序</span>\n   <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// eslint-disable-next-line no-async-promise-executor</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 执行当前异步任务</span>\n            <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 报错了不管继续下一个</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// current++</span>\n         <span class="token comment">// console.log(</span>\n         <span class="token comment">//   `${taskName} 事务进度，第 ${current} 个，共 ${count} 个，进度为 ${((current / count) * 100).toFixed(2)}% `</span>\n         <span class="token comment">// )</span>\n\n         <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n         <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 任务池执行程序</span>\n   <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 使用 Promise.all 批量执行</span>\n   <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68754812921210220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `68754812921210220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="国际化"><a href="#%E5%9B%BD%E9%99%85%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>国际化</h1>\n<h2 id="语言动态加载"><a href="#%E8%AF%AD%E8%A8%80%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语言动态加载</h2>\n<p>利用 <code class="language-text">require.context</code> 动态读取目录下的文件内容，实现动态加载语言配置、自定义前缀功能</p>\n<h3 id="目录结构"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38853849036862490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE`, `38853849036862490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="核心代码-5"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26984720654780547000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `26984720654780547000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加所需的字段：</p>\n<p>web/locales/lang/en-US/p7/app-download.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40357559427961020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `40357559427961020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88219240174160670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useTranslation } from \'react-i18next\';\nconst { t } = useTranslation();\nconst getValue = (param: string) => t(\\`p7.appDownload.\\${param}\\`);\n// console.log(getValue(\'title\'))`, `88219240174160670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.appDownload.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(getValue(\'title\'))</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路由复用"><a href="#%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路由复用</h2>\n<h3 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>国家站的页面和国际站大部分的页面相同，只是语言不同，可以复用路由</p>\n<h3 id="核心代码-6"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>见标红部分代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99223834102930600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { join } = require(\'path\')\nconst { getFeDir } = require(\'ssr-server-utils\')\nconst fs = require(\'fs\')\n\nconst countryList = [\'no\', \'se\', \'dk\', \'nl\'] // 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL\n\n// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159\nconst renderRoutes = (pageDir, pathRecord, route) => {\n  let arr = []\n  const pagesFolders = fs.readdirSync(pageDir)\n  const prefixPath = pathRecord.join(\'/\')\n  const aliasPath = \\`@/pages\\${prefixPath}\\`\n  const routeArr = []\n  const fetchExactMatch = pagesFolders.filter(p => p.includes(\'fetch\'))\n  for (const pageFiles of pagesFolders) {\n    const abFolder = join(pageDir, pageFiles)\n    const isDirectory = fs.lstatSync(abFolder).isDirectory()\n    if (isDirectory) {\n      // 如果是文件夹则递归下去, 记录路径\n      pathRecord.push(pageFiles)\n      const childArr = renderRoutes(abFolder, pathRecord, Object.assign({}, route))\n      pathRecord.pop() // 回溯\n      arr = arr.concat(childArr)\n    } else {\n      // 遍历一个文件夹下面的所有文件\n      if (!pageFiles.includes(\'render\')) {\n        continue\n      }\n      // 拿到具体的文件\n      if (pageFiles.includes(\'render\\$\')) {\n        /* /news/:id */\n        route.path = \\`\\${prefixPath}/:\\${getDynamicParam(pageFiles)}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = \\`\\${webpackChunkName}-\\${getDynamicParam(pageFiles).replace(/\\/:\\??/g, \'-\').replace(\'?\', \'-optional\')}\\`\n      } else if (pageFiles.includes(\'render\')) {\n        /* /news */\n        route.path = \\`\\${prefixPath}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = webpackChunkName\n      }\n\n      if (fetchExactMatch.length >= 2) {\n        // fetch 文件数量 >=2 启用完全匹配策略 render\\$id => fetch\\$id, render => fetch\n        const fetchPageFiles = \\`\\${pageFiles.replace(\'render\', \'fetch\').split(\'.\')[0]}.ts\\`\n        if (fetchExactMatch.includes(fetchPageFiles)) {\n          route.fetch = \\`\\${aliasPath}/\\${fetchPageFiles}\\`\n        }\n      } else if (fetchExactMatch.includes(\'fetch.ts\')) {\n        // 单 fetch 文件的情况 所有类型的 render 都对应该 fetch\n        route.fetch = \\`\\${aliasPath}/fetch.ts\\`\n      }\n      routeArr.push({ ...route })\n    }\n  }\n  routeArr.forEach((r) => {\n    if (r.path?.includes(\'index\')) {\n      r.path && arr.push(JSON.parse(JSON.stringify(r)))\n      // /index 映射为 /\n      if (r.path.split(\'/\').length >= 3) {\n        r.path = r.path.replace(\'/index\', \'\')\n      } else {\n        r.path = r.path.replace(\'index\', \'\')\n      }\n    }\n\n    r.path && arr.push(r)\n  })\n\n  return arr\n}\n\nconst getDynamicParam = (url) => {\n  return url.split(\'\\$\').filter(r => r !== \'render\' && r !== \'\').map(r => r.replace(/\\.[\\s\\S]+/, \'\').replace(\'#\', \'?\')).join(\'/:\')\n}\n\nconst accessFile = (file) => {\n  try {\n    fs.accessSync(file)\n  } catch (error) {\n    return false\n  }\n  return true\n}\n\nconst { dynamic = true, routerPriority, routerOptimize } = {}\nconst prefix = \'\'\n// 根据目录结构生成前端路由表\nconst pathRecord = [\'\'] // 路径记录\nconst route = {}\nlet arr = renderRoutes(join(getFeDir(), \'pages\'), pathRecord, route)\nif (routerPriority) {\n  // 路由优先级排序\n  arr.sort((a, b) => {\n    // 没有显示指定的路由优先级统一为 0\n    return (routerPriority[b.path] || 0) - (routerPriority[a.path] || 0)\n  })\n}\n\nif (routerOptimize) {\n  // 路由过滤\n  if (routerOptimize.include && routerOptimize.exclude) {\n    throw new Error(\'include and exclude cannot exist synchronal\')\n  }\n  if (routerOptimize.include) {\n    arr = arr.filter(route => routerOptimize.include.includes(route.path))\n  }\n  if (routerOptimize.exclude) {\n    arr = arr.filter(route => !routerOptimize.exclude.includes(route.path))\n  }\n}\n\nconst countryRoutes = []\ncountryList.forEach(country => {\n  arr.forEach(route => {\n    const path = \\`/\\${country}\\${route.path}\\`\n    // 注意这里需要去除掉 2 个国家的无效路径\n    if (arr.every(route => route.path !== path) && path.split(\'/\').filter((item) => countryList.includes(item)).length <= 1) {\n      countryRoutes.push({\n        ...route,\n        path\n      })\n    }\n    if (route.path === \'/\') {\n      countryRoutes.push({\n        ...route,\n        path: \\`/\\${country}\\`\n      })\n    }\n  })\n})\n\narr = arr.concat(countryRoutes)\n\nconst accessReactApp = accessFile(join(getFeDir(), \'./components/layout/App.tsx\'))\nconst layoutFetch = accessFile(join(getFeDir(), \'./components/layout/fetch.ts\'))\nconst accessStore = accessFile(join(getFeDir(), \'./store/index.ts\'))\nconst re = /&quot;webpackChunkName&quot;:(&quot;(.+?)&quot;)/g\n\nlet routes = \\`\n        // The file is provisional，don\'t depend on it\n        export const FeRoutes = \\${JSON.stringify(arr)}\n        \\${accessReactApp ? \'export { default as App } from &quot;@/components/layout/App.tsx&quot;\' : \'\'}\n        \\${layoutFetch ? \'export { default as layoutFetch } from &quot;@/components/layout/fetch.ts&quot;\' : \'\'}\n        \\${accessStore ? \'export * from &quot;@/store/index.ts&quot;\' : \'\'}\n        \\${prefix ? \\`export const PrefixRouterBase=\'\\${prefix}\'\\` : \'\'}\n      \\`\nroutes = routes.replace(/&quot;component&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  if (dynamic) {\n    return \\`&quot;component&quot;: function dynamicComponent () {\n            return import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\n          }\n          \\`\n  } else {\n    return \\`&quot;component&quot;: require(\'\\${m2.replace(/\\^/g, \'&quot;\')}\').default\\`\n  }\n})\nre.lastIndex = 0\nroutes = routes.replace(/&quot;fetch&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  return \\`&quot;fetch&quot;: () => import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}-fetch&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\\`\n})\n\nfs.writeFileSync(join(getFeDir(), \'route.ts\'), routes)\n// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径\n// console.log(arr.map((item) => item.path).join(\'\\n\'))\nfs.writeFileSync(join(__dirname, \'../src/router.json\'), JSON.stringify(arr))`, `99223834102930600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{120-140}"\n              >\n                <span class="gatsby-code-button-language">ts{120-140}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> getFeDir <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'ssr-server-utils\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> countryList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'no\'</span><span class="token punctuation">,</span> <span class="token string">\'se\'</span><span class="token punctuation">,</span> <span class="token string">\'dk\'</span><span class="token punctuation">,</span> <span class="token string">\'nl\'</span><span class="token punctuation">]</span> <span class="token comment">// 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL</span>\n\n<span class="token comment">// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159</span>\n<span class="token keyword">const</span> <span class="token function-variable function">renderRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">pageDir<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> pagesFolders <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prefixPath <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> aliasPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/pages</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n  <span class="token keyword">const</span> routeArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> fetchExactMatch <span class="token operator">=</span> pagesFolders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pageFiles <span class="token keyword">of</span> pagesFolders<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> abFolder <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">,</span> pageFiles<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> isDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectory<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果是文件夹则递归下去, 记录路径</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span>\n      <span class="token keyword">const</span> childArr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 回溯</span>\n      arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childArr<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 遍历一个文件夹下面的所有文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">continue</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 拿到具体的文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render$\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news/:id */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/:\\??/g</span><span class="token punctuation">,</span> <span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">,</span> <span class="token string">\'-optional\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> webpackChunkName\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// fetch 文件数量 >=2 启用完全匹配策略 render$id => fetch$id, render => fetch</span>\n        <span class="token keyword">const</span> fetchPageFiles <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">,</span> <span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.ts</span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fetchPageFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fetchPageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 单 fetch 文件的情况 所有类型的 render 都对应该 fetch</span>\n        route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fetch.ts</span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span>\n      routeArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>route <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  routeArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token comment">// /index 映射为 /</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> arr\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getDynamicParam</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'$\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r <span class="token operator">!==</span> <span class="token string">\'render\'</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!==</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\.[\\s\\S]+/</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">,</span> <span class="token string">\'?\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/:\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">accessFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> dynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> routerPriority<span class="token punctuation">,</span> routerOptimize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token string">\'\'</span>\n<span class="token comment">// 根据目录结构生成前端路由表</span>\n<span class="token keyword">const</span> pathRecord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span> <span class="token comment">// 路径记录</span>\n<span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'pages\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由优先级排序</span>\n  arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 没有显示指定的路由优先级统一为 0</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>b<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>a<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由过滤</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include <span class="token operator">&amp;&amp;</span> routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'include and exclude cannot exist synchronal\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token operator">!</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> countryRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">countryList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">country</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 注意这里需要去除掉 2 个国家的无效路径</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> route<span class="token punctuation">.</span>path <span class="token operator">!==</span> path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> countryList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>countryRoutes<span class="token punctuation">)</span></span>\n<span class="token keyword">const</span> accessReactApp <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/App.tsx\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> layoutFetch <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> accessStore <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./store/index.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex">/"webpackChunkName":("(.+?)")/g</span>\n\n<span class="token keyword">let</span> routes <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">        // The file is provisional，don\'t depend on it</span>\n<span class="token string">        export const FeRoutes = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessReactApp <span class="token operator">?</span> <span class="token string">\'export { default as App } from "@/components/layout/App.tsx"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>layoutFetch <span class="token operator">?</span> <span class="token string">\'export { default as layoutFetch } from "@/components/layout/fetch.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessStore <span class="token operator">?</span> <span class="token string">\'export * from "@/store/index.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export const PrefixRouterBase=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">      </span><span class="token template-punctuation string">`</span></span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"component":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": function dynamicComponent () {</span>\n<span class="token string">            return import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span>\n<span class="token string">          }</span>\n<span class="token string">          </span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": require(\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\').default</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nre<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"fetch":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"fetch": () => import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-fetch" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span><span class="token template-punctuation string">`</span></span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'route.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span>\n<span class="token comment">// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径</span>\n<span class="token comment">// console.log(arr.map((item) => item.path).join(\'\\n\'))</span>\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../src/router.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="多平台适配"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台适配</h1>\n<h2 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要适配 PC、H5 的样式</p>\n<h2 id="选型过程-5"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<ol>\n<li>PC 使用 rem 单位，h5 使用 vw 单位（ipad 端适配有问题，需要全部使用 rem 单位，便于样式控制），使用 @our-patches/postcss-px-to-viewport 插件做转换</li>\n<li>h5 端 100vh 的高度展示有问题，需要实时计算高度，使用 postcss-viewport-height-correction 插件实现</li>\n</ol>\n<h2 id="核心代码-7"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<p>postcss.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69006042314794330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `69006042314794330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="swiper"><a href="#swiper" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>swiper</h1>\n<h2 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<ol>\n<li>swiper 嵌套时的垂直滚动不会离开当前嵌套的容器，需要做到滚动到边缘会离开当前嵌套容器即边缘检测</li>\n<li>需要实现 swiper 延迟滚动、解决滚轮不够顺滑问题</li>\n</ol>\n<h2 id="核心代码-8"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<h3 id="嵌套边缘检测"><a href="#%E5%B5%8C%E5%A5%97%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>嵌套边缘检测</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78835416211105920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const handleContainerWheel = (element) => {\n   const scrollHeight = element.scrollHeight\n   const slideSize = element.swiperSlideSize\n   const scrollDifferenceTop = scrollHeight - slideSize\n\n   const handleWheel = (event) => {\n      const scrollDifference = scrollHeight - slideSize - element.scrollTop\n\n      // Scroll wheel browser compatibility\n      const delta = event.wheelDelta || -1 * event.deltaY\n\n      // Enable scrolling if at edges\n      const spos = delta < 0 ? 0 : scrollDifferenceTop\n      const parseScrollDifference = Number.parseInt(\\`\\${scrollDifference}\\`)\n      const parseSpos = Number.parseInt(\\`\\${spos}\\`)\n\n      console.log(scrollDifference, spos)\n      if (parseScrollDifference !== parseSpos) {\n         console.log(\'stopPropagation\')\n         event.stopPropagation()\n      } else {\n         // 边缘释放参数关闭时才生效\n         if (!swiperRef?.current?.params?.mousewheel?.releaseOnEdges) {\n            // 滑动到最后一个幻灯片的底部，继续监听事件\n            if (parseScrollDifference === 0 && parseSpos === 0 && current === swiperRef?.current?.slides?.length - 1) {\n               return\n            }\n            // 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况\n         }\n         element.removeEventListener(\'wheel\', handleWheel)\n         element.removeEventListener(\'scroll\', handleScroll)\n      }\n   }\n\n   element.addEventListener(\'wheel\', handleWheel)\n}\n\nconst handleScrollContainerEvent = (activeSlide: ActiveSlide) => {\n   const hasVerticalScrollbar = activeSlide.scrollHeight > activeSlide.clientHeight;\n   if (!hasVerticalScrollbar) {\n      return;\n   }\n   // 进入时重置滚动条\n   activeSlide.scrollTo(0, 0);\n   activeSlide.addEventListener(\'scroll\', handleScroll);\n   handleContainerWheel(activeSlide);\n}\n\n// 监听 swiper 的 onSlideChange 事件\nreturn (\n   <Swiper\n      onSlideChange={(slide) => {\n         swiperRef.current = slide;\n         if (haveNestedScrollbar) {\n            handleScrollContainerEvent(slide.slides[slide.realIndex] as ActiveSlide);\n         }\n      }}\n   ></Swiper>\n)`, `78835416211105920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> <span class="token function-variable function">handleContainerWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> scrollHeight <span class="token operator">=</span> element<span class="token punctuation">.</span>scrollHeight\n   <span class="token keyword">const</span> slideSize <span class="token operator">=</span> element<span class="token punctuation">.</span>swiperSlideSize\n   <span class="token keyword">const</span> scrollDifferenceTop <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> scrollDifference <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize <span class="token operator">-</span> element<span class="token punctuation">.</span>scrollTop\n\n      <span class="token comment">// Scroll wheel browser compatibility</span>\n      <span class="token keyword">const</span> delta <span class="token operator">=</span> event<span class="token punctuation">.</span>wheelDelta <span class="token operator">||</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>deltaY\n\n      <span class="token comment">// Enable scrolling if at edges</span>\n      <span class="token keyword">const</span> spos <span class="token operator">=</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> scrollDifferenceTop\n      <span class="token keyword">const</span> parseScrollDifference <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scrollDifference<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> parseSpos <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>spos<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>scrollDifference<span class="token punctuation">,</span> spos<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">!==</span> parseSpos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'stopPropagation\'</span><span class="token punctuation">)</span>\n         event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 边缘释放参数关闭时才生效</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>params<span class="token operator">?</span><span class="token punctuation">.</span>mousewheel<span class="token operator">?</span><span class="token punctuation">.</span>releaseOnEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 滑动到最后一个幻灯片的底部，继续监听事件</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> parseSpos <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>slides<span class="token operator">?</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span>\n            <span class="token punctuation">}</span>\n            <span class="token comment">// 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况</span>\n         <span class="token punctuation">}</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">handleScrollContainerEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">activeSlide<span class="token punctuation">:</span> ActiveSlide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> hasVerticalScrollbar <span class="token operator">=</span> activeSlide<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> activeSlide<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasVerticalScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 进入时重置滚动条</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">handleContainerWheel</span><span class="token punctuation">(</span>activeSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 监听 swiper 的 onSlideChange 事件</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Swiper</span></span>\n      <span class="token attr-name">onSlideChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">slide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         swiperRef<span class="token punctuation">.</span>current <span class="token operator">=</span> slide<span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>haveNestedScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">handleScrollContainerEvent</span><span class="token punctuation">(</span>slide<span class="token punctuation">.</span>slides<span class="token punctuation">[</span>slide<span class="token punctuation">.</span>realIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> ActiveSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Swiper</span></span><span class="token punctuation">></span></span>\n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="延迟滚动"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<p>具体代码见 <a href="https://github.com/towavephone/swiper/commit/c7daf2d123e4fdda385b69c1eaa636d876562ee3" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="运行效果-5"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<h3 id="延迟滚动-1"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/n67jtt?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h1>\n<h2 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要对图片、视频进行懒加载</p>\n<h2 id="选型过程-6"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/tuupola/lazyload" target="_blank" rel="nofollow noreferrer noopener">lazyload</a></td>\n<td align="left">支持 img 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/aFarkas/lazysizes" target="_blank" rel="nofollow noreferrer noopener">lazysizes</a></td>\n<td align="left">支持 img、iframe 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload" target="_blank" rel="nofollow noreferrer noopener">vanilla-lazyload</a></td>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload#vanilla-lazyload-vs-lazysizes" target="_blank" rel="nofollow noreferrer noopener">优点</a></td>\n<td align="left">需要手动通知 dom 变化</td>\n</tr>\n</tbody>\n</table>\n<h2 id="实现难点"><a href="#%E5%AE%9E%E7%8E%B0%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现难点</h2>\n<ol>\n<li>lazyloader 循环引用导致的报错、检测</li>\n<li>lazyloader 加载不同分辨率的图片（ahooks 的 useReponsive 封装有问题，需要自己重新封装）</li>\n<li>封装使用形式类似 react-spring 的 lazyloader</li>\n<li>动态监听 src/srcSet 实现同步</li>\n<li>需要封装各种使用形式的组件，为此需要合理组织文件结构，需要实现的功能大致如下</li>\n</ol>\n<table>\n  <thead>\n    <tr>\n      <th>UI 类型</th>\n      <th>平台</th>\n      <th>策略</th>\n      <th>详细说明</th>\n      <th>传递属性</th>\n      <th>代码示例</th>\n   </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td rowspan="9">视频</td>\n      <td rowspan="8">pc</td>\n      <td>自动播放</td>\n      <td>默认自动循环静音播放</td>\n      <td>playStrategy = \'autoPlay\'，默认不用传</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放</td>\n      <td>点击循环静音播放、带自定义播放图标</td>\n      <td>playStrategy = \'clickPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>按住播放</td>\n      <td>按住循环播放、带自定义播放图标、带播放进度条显示</td>\n      <td>playStrategy = \'pressHoldPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击视频弹窗播放</td>\n      <td>短视频自动循环静音播放，点击短视频后弹窗自动播放长视频一次</td>\n      <td>\n         <ol>\n            <li>传递 playStrategy = \'clickVideoModalPlay\'</li>\n            <li>原有的 srcSet、minSrcSet、src 控制短视频，这 3 个属性加上 long 前缀控制长视频，即 longSrcSet、longMinSrcSet、longSrc，如果不传 long 前缀属性则取短视频属性</li>\n            <li>通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()</li>\n         </ol>\n      </td>\n      <td>\n         import { l, ClickVideoModalPlayRef } from &#x27;@/components/lazyLoader&#x27;\n         <br/>\n         <br/>\n         const videoRef = useRef&lt;ClickVideoModalPlayRef&gt;(null)\n         <br/>\n         <br/>\n         // 调用示例\n         useEffect(() =&gt; {\n            setTimeout(() =&gt; {\n               videoRef.current?.openModal()\n            }, 6000)\n         }, [])\n         <br/>\n         <br/>\n         &lt;l.video\n            ref={videoRef}\n            playStrategy=&quot;clickVideoModalPlay&quot;\n            src=&quot;/public/p7/xmart-os/p7-p6-1@short.mp4&quot;\n            longSrc=&quot;/public/p7/xmart-os/p7-p6-1@long.mp4&quot; // 不传则取 src\n         /&gt;\n      </td>\n    </tr>\n    <tr>\n      <td>悬停播放</td>\n      <td>鼠标悬浮循环静音播放视频，离开时回到初始状态</td>\n      <td>playStrategy = \'mouseOverPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进度控制</td>\n      <td>控制视频进度</td>\n      <td>playStrategy = \'progressControl\'，传递 progress（百分比，以 1 为单位）控制视频进度</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放（带控制条，播放状态控制）</td>\n      <td>点击后播放一次视频、自带控制条、初始播放状态控制</td>\n      <td>playStrategy = \'clickPlayWithControl\'，传递 playing 控制初始播放状态</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进入视口播放一次</td>\n      <td>完全 100% 看到视频从头开始播放一次（每次看到视频就会触发）</td>\n      <td>playStrategy = \'inViewportPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>点击图片弹窗播放</td>\n      <td>\n         <ol>\n            <li>\n               图片展示，带自定义播放图标，如无图片则取原视频第一帧\n            </li>\n            <li>\n               点击自定义播放图标弹窗自动播放一次视频\n            </li>\n         </ol>\n      </td>\n      <td>\n         <ol>\n            <li>\n               传 srcSetPoster, srcPoster, minSrcSetPoster 作为封面图片，可以只传 srcPoster\n            </li>\n            <li>\n               默认 h5 使用此策略，不需要传 playStrategy（playStrategy === \'clickImgModalPlay\'）\n            </li>\n            <li>\n               如需覆盖请直接传具体的 playStrategy\n            </li>\n            <li>\n               需要保证播放图标可以点击，全屏视频有可能点击不到，需要把视频样式的 z-index 去掉\n            </li>\n            <li>\n               传递 playIconPosition 代表播放按钮位置\n            </li>\n            <li>\n               showPlayIcon 代表是否展示播放图标\n            </li>\n            <li>\n               通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()\n            </li>\n         </ol>\n      </td>\n      <td></td>\n    </tr>\n    <tr>\n      <td rowspan="2">图片</td>\n      <td>pc</td>\n      <td>正常展示</td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>弹窗展示</td>\n      <td>点击弹窗后展示，等比例放大，宽度自适应（弹窗图片的左右切换实现难度大，之后再做）</td>\n      <td></td>\n      <td></td>\n    </tr>\n  </tbody>\n</table>\n<h2 id="运行效果-6"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/etwmhs?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h2>\n<ol>\n<li>编译原理相关：利用 ts-morph、ts-morpher 自动导入 lazyloader 的 lazyElement 的 div、video、img 组件</li>\n<li>img 组件没有封装，复用之前的组件</li>\n</ol>\n<h1 id="弹窗-hook-封装"><a href="#%E5%BC%B9%E7%AA%97-hook-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>弹窗 hook 封装</h1>\n<h2 id="需求背景-10"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>由于需要实现大量弹窗展示的功能，为了尽量减少代码行数，提高复用性，这里采用 hooks 的方式去实现弹窗</p>\n<h2 id="usemodal-封装"><a href="#usemodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useModal 封装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72738890513430870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n   useRef,\n   forwardRef,\n   useState,\n   useImperativeHandle,\n   useCallback,\n   ComponentType,\n   PropsWithoutRef\n} from \'react\';\nimport { ModalProps, Modal } from \'antd\';\n\ntype ModalRefType<T> =\n   | {\n        open: (initProp?: Partial<T>) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps<T> {\n   component: ComponentType<T>; // 子组件\n   modalProps?: Partial<ModalProps>; // 弹窗属性\n}\n\nconst useModal = function<T>({ component: Component, modalProps }: UseModalProps<T>) {\n   const modalRef = useRef<ModalRefType<T>>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef<ModalRefType<T>, T>((componetProps, componentRef) => {\n      const [visible, setVisible] = useState(false);\n      const [componentInitProp, setComponentInitProp] = useState<Partial<T>>();\n\n      const handleOk = (initProps?: Partial<T>) => {\n         if (initProps) {\n            setComponentInitProp(initProps);\n         }\n         setVisible(true);\n         setGlobalVisible(true);\n      };\n\n      const handleCancel = () => {\n         setVisible(false);\n         setGlobalVisible(false);\n      };\n\n      useImperativeHandle(componentRef, () => ({\n         open: handleOk,\n         close: handleCancel\n      }));\n\n      return (\n         <Modal onCancel={handleCancel} visible={visible} {...modalProps}>\n            <Component onCancel={handleCancel} {...componetProps} {...componentInitProp} />\n         </Modal>\n      );\n   });\n\n   return {\n      Slot: useCallback((props: PropsWithoutRef<T>) => {\n         return <ComponentModal ref={modalRef} {...props} />;\n         // eslint-disable-next-line react-hooks/exhaustive-deps\n      }, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;`, `72738890513430870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   useRef<span class="token punctuation">,</span>\n   forwardRef<span class="token punctuation">,</span>\n   useState<span class="token punctuation">,</span>\n   useImperativeHandle<span class="token punctuation">,</span>\n   useCallback<span class="token punctuation">,</span>\n   ComponentType<span class="token punctuation">,</span>\n   PropsWithoutRef\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ModalProps<span class="token punctuation">,</span> Modal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> =\n   | </span><span class="token punctuation">{</span>\n        open<span class="token punctuation">:</span> <span class="token punctuation">(</span>initProp<span class="token operator">?</span><span class="token punctuation">:</span> Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>\n   component<span class="token punctuation">:</span> ComponentType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 子组件\n   modalProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModalProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 弹窗属性\n}\n\nconst useModal = function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(</span><span class="token punctuation">{</span> component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> modalProps <span class="token punctuation">}</span><span class="token plain-text">: UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> modalRef <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef&lt;ModalRefType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">, T>((componetProps, componentRef) => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>componentInitProp<span class="token punctuation">,</span> setComponentInitProp<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n\n      const handleOk = (initProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>initProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">setComponentInitProp</span><span class="token punctuation">(</span>initProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      const handleCancel = () => </span><span class="token punctuation">{</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      useImperativeHandle(componentRef, () => (</span><span class="token punctuation">{</span>\n         open<span class="token punctuation">:</span> handleOk<span class="token punctuation">,</span>\n         close<span class="token punctuation">:</span> handleCancel\n      <span class="token punctuation">}</span><span class="token plain-text">));\n\n      return (\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Modal</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token attr-name">visible</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>visible<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">modalProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componetProps</span><span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componentInitProp</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Modal</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      );\n   });\n\n   return </span><span class="token punctuation">{</span>\n      Slot<span class="token punctuation">:</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">:</span> PropsWithoutRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentModal</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>modalRef<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>\n         <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n      <span class="token punctuation">}</span><span class="token plain-text">, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="usedisplayermodal-封装"><a href="#usedisplayermodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useDisplayerModal 封装</h2>\n<p>弹窗有一些公用属性，需要再次分层便于复用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60280765877059370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ComponentType } from \'react\';\n\nimport useModal from \'@/hooks/useModal\';\n\nimport styles from \'./index.module.less\';\n\nconst useDisplayerModal = function<T>(Component: ComponentType<T>) {\n   const result = useModal({\n      component: Component,\n      modalProps: {\n         className: styles.modal,\n         wrapClassName: styles.wrapClassName,\n         closable: false,\n         footer: null,\n         // 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug\n         destroyOnClose: true,\n         centered: false\n      }\n   });\n   return result;\n};\n\nexport default useDisplayerModal;`, `60280765877059370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ComponentType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useModal <span class="token keyword">from</span> <span class="token string">\'@/hooks/useModal\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useDisplayerModal</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(Component: ComponentType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">useModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>\n      modalProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         className<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>modal<span class="token punctuation">,</span>\n         wrapClassName<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>wrapClassName<span class="token punctuation">,</span>\n         closable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         footer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n         <span class="token comment">// 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug</span>\n         destroyOnClose<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         centered<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token plain-text">;\n\nexport default useDisplayerModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="运行效果-7"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/9pxwy5?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h1>\n<h2 id="loadscript-优化"><a href="#loadscript-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loadScript 优化</h2>\n<h3 id="需求背景-11"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要有一个方法来手动加载脚本，延迟脚本加载的时机</p>\n<h3 id="优化过程"><a href="#%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化过程</h3>\n<ol>\n<li>生成唯一性的 uuid 来判断这个脚本是否加载，以实现只加载一次脚本的功能</li>\n<li>由于 loadScript 方法会在同一个页面同一 src 多次调用，实际上判断脚本是否加载并不能完美实现（会导致同一脚本多次加载），考虑使用函数缓存实现</li>\n</ol>\n<h3 id="核心代码-9"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46297580451148915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { memoize } from \'lodash\';\n\ntype loadScriptOptions = Partial<Omit<HTMLScriptElement, \'src\' | \'async\'>> & {\n   attributesMap?: {\n      [key: string]: any;\n   };\n   [key: string]: any;\n};\n\n// 异步加载单个脚本\nasync function loadSingleScript(src: string, options: loadScriptOptions = {}) {\n   return await new Promise((resolve, reject) => {\n      // 这里未考虑到同一 src 同时发起的情况，改用缓存实现\n      // if (!id) {\n      //   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'\n      //   const PREFIX = \'script-id-\'\n      //   id = PREFIX + uuidv5(src, NAMESPACE)\n      // }\n      // if (!src || document.querySelector(\\`#\\${id}\\`)) {\n      //   return\n      // }\n      const script: any = document.createElement(\'script\');\n      const { attributesMap = {}, ...rest } = options;\n      Object.keys(rest).forEach((key) => {\n         script[key] = rest[key];\n      });\n      Object.keys(attributesMap).forEach((key) => {\n         script.setAttribute(key, attributesMap[key]);\n      });\n      script.async = true;\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = reject;\n      document.getElementsByTagName(\'head\')[0].appendChild(script);\n   });\n}\n\n// 异步加载多个脚本\n// memoize 默认情况下用第一个参数作为缓存的 key，即 src\nexport const loadScript = memoize(loadSingleScript);`, `46297580451148915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> memoize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> loadScriptOptions <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>Omit<span class="token operator">&lt;</span>HTMLScriptElement<span class="token punctuation">,</span> <span class="token string">\'src\'</span> <span class="token operator">|</span> <span class="token string">\'async\'</span><span class="token operator">>></span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n   attributesMap<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载单个脚本</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadSingleScript</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> loadScriptOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 这里未考虑到同一 src 同时发起的情况，改用缓存实现</span>\n      <span class="token comment">// if (!id) {</span>\n      <span class="token comment">//   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'</span>\n      <span class="token comment">//   const PREFIX = \'script-id-\'</span>\n      <span class="token comment">//   id = PREFIX + uuidv5(src, NAMESPACE)</span>\n      <span class="token comment">// }</span>\n      <span class="token comment">// if (!src || document.querySelector(`#${id}`)) {</span>\n      <span class="token comment">//   return</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">const</span> script<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> attributesMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> rest<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributesMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> attributesMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 异步加载多个脚本</span>\n<span class="token comment">// memoize 默认情况下用第一个参数作为缓存的 key，即 src</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> loadScript <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>loadSingleScript<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="视频播放进度控制失效"><a href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E8%BF%9B%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频播放进度控制失效</h2>\n<p>对于长视频，<code class="language-text">domRef.current.currentTime = 0</code> 方法失效，需要对服务器配置，具体见<a href="https://stackoverflow.com/questions/4360060/video-streaming-with-html-5-via-node-js#18241169" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="usescrolldirection-封装"><a href="#usescrolldirection-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useScrollDirection 封装</h2>\n<h3 id="需求背景-12"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要知道页面的向上、向下滚动来实现特定需求</p>\n<h3 id="实现要点"><a href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现要点</h3>\n<p>使用 ahooks 的 useScroll、usePrevious、useThrottle，来分别实现得到当前滚动信息、得到前一个滚动信息、性能优化的节流处理的功能</p>\n<h3 id="核心代码-10"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/hooks/useScrollDirection.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42678899126180995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useScroll, usePrevious, useThrottle } from \'ahooks\'\nimport type { Target, ScrollListenController } from \'ahooks/lib/useScroll\'\nimport type { ThrottleOptions } from \'ahooks/lib/useThrottle/throttleOptions\'\n\ninterface UseScrollDirectionResult {\n  leftDelta: number\n  topDelta: number\n  scrollXDirection?: \'left\' | \'right\'\n  scrollYDirection?: \'up\' | \'down\'\n  left: number\n  top: number\n}\n\nconst useScrollDirection = (target: Target, shouldUpdate?: ScrollListenController, options: ThrottleOptions & { enable: boolean } = {\n  enable: false,\n  wait: 300,\n  leading: true,\n  trailing: true\n}): UseScrollDirectionResult => {\n  const position = useScroll(target, shouldUpdate)\n  const prevPosition = usePrevious(position)\n\n  const throttledPosition = useThrottle(position, options)\n  const throttledPrevPosition = useThrottle(prevPosition, options)\n\n  const newPosition = options.enable ? throttledPosition : position\n  const newPrevPosition = options.enable ? throttledPrevPosition : prevPosition\n\n  if (!newPosition || !newPrevPosition) {\n    return {\n      leftDelta: 0,\n      topDelta: 0,\n      left: 0,\n      top: 0\n    }\n  }\n\n  const leftDelta = newPosition.left - newPrevPosition.left\n  const topDelta = newPosition.top - newPrevPosition.top\n\n  const scrollXDirection = leftDelta > 0 ? \'right\' : \'left\'\n  const scrollYDirection = topDelta > 0 ? \'down\' : \'up\'\n\n  // console.log(\'throttledPosition\', newPosition, newPrevPosition)\n\n  return {\n    leftDelta,\n    topDelta,\n    scrollXDirection,\n    scrollYDirection,\n    left: newPosition.left,\n    top: newPosition.top\n  }\n}\n\nexport default useScrollDirection`, `42678899126180995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useScroll<span class="token punctuation">,</span> usePrevious<span class="token punctuation">,</span> useThrottle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Target<span class="token punctuation">,</span> ScrollListenController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useScroll\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ThrottleOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useThrottle/throttleOptions\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">UseScrollDirectionResult</span> <span class="token punctuation">{</span>\n  leftDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  topDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  scrollXDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'left\'</span> <span class="token operator">|</span> <span class="token string">\'right\'</span>\n  scrollYDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'up\'</span> <span class="token operator">|</span> <span class="token string">\'down\'</span>\n  left<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  top<span class="token punctuation">:</span> <span class="token builtin">number</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> useScrollDirection <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> Target<span class="token punctuation">,</span> shouldUpdate<span class="token operator">?</span><span class="token punctuation">:</span> ScrollListenController<span class="token punctuation">,</span> options<span class="token punctuation">:</span> ThrottleOptions <span class="token operator">&amp;</span> <span class="token punctuation">{</span> enable<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  enable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  wait<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>\n  leading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  trailing<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">UseScrollDirectionResult</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> shouldUpdate<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prevPosition <span class="token operator">=</span> <span class="token function">usePrevious</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> throttledPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> throttledPrevPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>prevPosition<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> newPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPosition <span class="token punctuation">:</span> position\n  <span class="token keyword">const</span> newPrevPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPrevPosition <span class="token punctuation">:</span> prevPosition\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPosition <span class="token operator">||</span> <span class="token operator">!</span>newPrevPosition<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      leftDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      topDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      top<span class="token punctuation">:</span> <span class="token number">0</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> leftDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>left <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>left\n  <span class="token keyword">const</span> topDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>top <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>top\n\n  <span class="token keyword">const</span> scrollXDirection <span class="token operator">=</span> leftDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'right\'</span> <span class="token punctuation">:</span> <span class="token string">\'left\'</span>\n  <span class="token keyword">const</span> scrollYDirection <span class="token operator">=</span> topDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'down\'</span> <span class="token punctuation">:</span> <span class="token string">\'up\'</span>\n\n  <span class="token comment">// console.log(\'throttledPosition\', newPosition, newPrevPosition)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    leftDelta<span class="token punctuation">,</span>\n    topDelta<span class="token punctuation">,</span>\n    scrollXDirection<span class="token punctuation">,</span>\n    scrollYDirection<span class="token punctuation">,</span>\n    left<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>left<span class="token punctuation">,</span>\n    top<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>top\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useScrollDirection</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-8"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/sb4gnr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="set-cookie-失效"><a href="#set-cookie-%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>set-cookie 失效</h2>\n<p>UC 浏览器下服务器端设置 set-cookie 失效即 csrf token 设置失败，进而接口请求失败，原因未知</p>\n<p>// TODO set-cookie 失效待解决</p>\n<h2 id="子级滚动、父级不滚动"><a href="#%E5%AD%90%E7%BA%A7%E6%BB%9A%E5%8A%A8%E3%80%81%E7%88%B6%E7%BA%A7%E4%B8%8D%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子级滚动、父级不滚动</h2>\n<h3 id="需求背景-13"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>打开弹窗时此时有半透明遮罩，弹窗内是有滚动条的，此时弹窗的滚动条的滚动会牵连外面滚动条的滚动</p>\n<h3 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h3>\n<ol>\n<li>css：<code class="language-text">overscroll-behavior: contain</code>，但是在移动端 safari 不支持</li>\n<li>js：在不支持 css 的方法时，降级处理</li>\n</ol>\n<h3 id="核心代码-11"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41799753105815700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function enableBodyScroll() {\n   if (document.readyState === \'complete\') {\n      document.body.style.position = \'\';\n      document.body.style.overflowY = \'\';\n\n      if (document.body.style.marginTop) {\n         const scrollTop = -parseInt(document.body.style.marginTop, 10);\n         document.body.style.marginTop = \'\';\n         window.scrollTo({\n            left: window.pageXOffset,\n            top: scrollTop,\n            behavior: \'instant\' // 关闭动画\n         });\n      }\n   } else {\n      window.addEventListener(\'load\', enableBodyScroll);\n   }\n}\n\nexport function disableBodyScroll({ savePosition = false } = {}) {\n   if (document.readyState === \'complete\') {\n      if (document.body.scrollHeight > window.innerHeight) {\n         if (savePosition) document.body.style.marginTop = \\`-\\${window.pageYOffset}px\\`;\n         document.body.style.position = \'fixed\';\n         document.body.style.overflowY = \'scroll\';\n      }\n   } else {\n      window.addEventListener(\'load\', () => disableBodyScroll({ savePosition }));\n   }\n}`, `41799753105815700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> scrollTop <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n         window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            left<span class="token punctuation">:</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>\n            top<span class="token punctuation">:</span> scrollTop<span class="token punctuation">,</span>\n            behavior<span class="token punctuation">:</span> <span class="token string">\'instant\'</span> <span class="token comment">// 关闭动画</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> enableBodyScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> savePosition <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>savePosition<span class="token punctuation">)</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>pageYOffset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'fixed\'</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'scroll\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> savePosition <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="进度转换函数"><a href="#%E8%BF%9B%E5%BA%A6%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进度转换函数</h2>\n<h3 id="需求背景-14"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<ol>\n<li>页面固定动效多次用到百分比转换，需要封装函数便于使用、理解</li>\n<li>后期可能会实现缓动函数，需要提前封装便于修改</li>\n</ol>\n<h3 id="核心代码-12"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56702993300803084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`interface GetAnimateProgressProps {\n   progress: number;\n   start: number;\n   duration: number;\n}\n\n// 获取单个进度\nexport const getAnimateProgress = ({ progress, start, duration }: GetAnimateProgressProps) =>\n   (progress - start) / duration;\n\ntype GetAnimateProgressesOptions = Omit<GetAnimateProgressProps, \'progress\'>;\n\n// 获取多个进度\nexport const getAnimateProgresses = (progress: number, options: GetAnimateProgressesOptions[]) =>\n   options.map(({ start, duration }) =>\n      getAnimateProgress({\n         progress,\n         start,\n         duration\n      })\n   );`, `56702993300803084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">GetAnimateProgressProps</span> <span class="token punctuation">{</span>\n   progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   start<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   duration<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 获取单个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> progress<span class="token punctuation">,</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span><span class="token punctuation">:</span> GetAnimateProgressProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token punctuation">(</span>progress <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> duration<span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> GetAnimateProgressesOptions <span class="token operator">=</span> Omit<span class="token operator">&lt;</span>GetAnimateProgressProps<span class="token punctuation">,</span> <span class="token string">\'progress\'</span><span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token comment">// 获取多个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgresses</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> GetAnimateProgressesOptions<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   options<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token function">getAnimateProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         progress<span class="token punctuation">,</span>\n         start<span class="token punctuation">,</span>\n         duration\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cdn-链接替换"><a href="#cdn-%E9%93%BE%E6%8E%A5%E6%9B%BF%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cdn 链接替换</h2>\n<h3 id="需求背景-15"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>public 下的所有文件都需要放到 cdn，减少服务器的压力同时访问速度更快，即要对所有前缀为 /public 的资源路径做替换</p>\n<h3 id="选型过程-7"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<ol>\n<li>动态变量：在 midway 后端设置可读变量然后注入到前端 window 变量中，但是不能解决 midway、css 的前缀问题</li>\n<li>静态替换：在 build 阶段对所有的 /public 替换，但是目前运维不支持，运维只在 dev 环境中才能 build，需要运维解决</li>\n<li>静态资源 hash 处理：需要由 webpack 接管去处理</li>\n</ol>\n<h3 id="核心代码-13"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>以下是 <code class="language-text">静态替换</code> 的核心代码，见标红部分的核心代码</p>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72338387582563705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst fsExtra = require(\'fs-extra\');\nconst path = require(\'path\');\nconst fs = require(\'fs\');\nconst packageJson = require(\'../package.json\');\nconst glob = require(\'glob\');\nconst { merge } = require(\'lodash\');\n\nlet config = require(\'../dist/config/config.default\');\nconst ENV = process.env.EGG_SERVER_ENV || \'prod\';\nconst fakeConfigParams = {\n   name: \'\',\n   appDir: \'\'\n};\nconst configPath = \\`../dist/config/config.\\${ENV}.js\\`;\n// console.log(\'ENV\', ENV)\nif (fs.existsSync(path.resolve(__dirname, configPath))) {\n   config = merge(config.default(fakeConfigParams), require(configPath).default(fakeConfigParams));\n}\n\nconsole.log(\'Start handle source...\');\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../deploy\'), { overwrite: true });\nfsExtra.copySync(path.resolve(__dirname, \'../public\'), path.resolve(__dirname, \'../deploy/public\'), {\n   overwrite: true\n});\n\ndelete packageJson.devDependencies;\ndelete packageJson.scripts.preinstall;\n\nfs.writeFileSync(path.resolve(__dirname, \'../deploy/package.json\'), JSON.stringify(packageJson));\n\n// 暂时不需要处理异步加载的资源\n// const assetManifest = require(\'../build/client/asset-manifest.json\')\n// const runtimePagePath = path.resolve(\n//   __dirname,\n//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')\n// )\n\n// const runtimePage = fs.readFileSync(runtimePagePath).toString()\n\n// // 替换 webpack 打包的资源路径前缀\n// fs.writeFileSync(\n//   runtimePagePath,\n//   runtimePage.replace(/&quot;\\/public\\//g, \'window.__publicPath+&quot;/public/\')\n// )\n\nconst assetManifest = require(\'../build/client/asset-manifest.json\');\nconst runtimePagePath = assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'build\');\n// console.log(\'runtimePagePath\', runtimePagePath)\n\nconst replacePrefixFiles = [\n   ...glob.sync(\'build/{client,server}/**/*.{js,css}\'),\n   ...glob.sync(\'dist/config/{menu,site}/**/*.js\')\n].filter((item) => item !== runtimePagePath);\nconst newPublicPath = config.publicPath || \'\';\nconst publicPath = newPublicPath.endsWith(\'/\') ? newPublicPath + \'public/\' : newPublicPath + \'/public/\';\n// console.log(\'publicPath\', publicPath)\nreplacePrefixFiles.forEach(function(file) {\n   const fileContent = fs.readFileSync(file).toString();\n   if (config.publicPath) {\n      fs.writeFileSync(file, fileContent.replace(/\\/public\\//g, publicPath));\n   }\n});\n\nfsExtra.moveSync(path.resolve(__dirname, \'../build\'), path.resolve(__dirname, \'../deploy/build\'), { overwrite: true });\n\nif (fs.existsSync(path.resolve(__dirname, \'../dist\'))) {\n   fsExtra.moveSync(path.resolve(__dirname, \'../dist\'), path.resolve(__dirname, \'../deploy/dist\'), { overwrite: true });\n}\n\nfsExtra.moveSync(path.resolve(__dirname, \'../deploy\'), path.resolve(__dirname, \'../dist\'), { overwrite: true });\n\nglob.sync(path.resolve(__dirname, \'../dist/**/*.map\')).forEach(function(file) {\n   fs.unlinkSync(file);\n});\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../dist/node_modules\'), {\n   overwrite: true\n});\n\nshelljs.exec(\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\');`, `72338387582563705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{48-64}"\n              >\n                <span class="gatsby-code-button-language">ts{48-64}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fsExtra <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs-extra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../dist/config/config.default\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">EGG_SERVER_ENV</span> <span class="token operator">||</span> <span class="token string">\'prod\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fakeConfigParams <span class="token operator">=</span> <span class="token punctuation">{</span>\n   name<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n   appDir<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> configPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../dist/config/config.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(\'ENV\', ENV)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> configPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   config <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">require</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Start handle source...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nfsExtra<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>devDependencies<span class="token punctuation">;</span>\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span>preinstall<span class="token punctuation">;</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 暂时不需要处理异步加载的资源</span>\n<span class="token comment">// const assetManifest = require(\'../build/client/asset-manifest.json\')</span>\n<span class="token comment">// const runtimePagePath = path.resolve(</span>\n<span class="token comment">//   __dirname,</span>\n<span class="token comment">//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')</span>\n<span class="token comment">// )</span>\n\n<span class="token comment">// const runtimePage = fs.readFileSync(runtimePagePath).toString()</span>\n\n<span class="token comment">// // 替换 webpack 打包的资源路径前缀</span>\n<span class="token comment">// fs.writeFileSync(</span>\n<span class="token comment">//   runtimePagePath,</span>\n<span class="token comment">//   runtimePage.replace(/"\\/public\\//g, \'window.__publicPath+"/public/\')</span>\n<span class="token comment">// )</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> assetManifest <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../build/client/asset-manifest.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> runtimePagePath <span class="token operator">=</span> assetManifest<span class="token punctuation">[</span><span class="token string">\'runtime~Page.js\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/public\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'runtimePagePath\', runtimePagePath)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> replacePrefixFiles <span class="token operator">=</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'build/{client,server}/**/*.{js,css}\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'dist/config/{menu,site}/**/*.js\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">!==</span> runtimePagePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> newPublicPath <span class="token operator">=</span> config<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> publicPath <span class="token operator">=</span> newPublicPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'public/\'</span> <span class="token punctuation">:</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'/public/\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'publicPath\', publicPath)</span></span><span class="gatsby-highlight-code-line">replacePrefixFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>publicPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/public\\//g</span><span class="token punctuation">,</span> publicPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nglob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/**/*.map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/node_modules\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="dangerouslysetinnerhtml-编译更新失效"><a href="#dangerouslysetinnerhtml-%E7%BC%96%E8%AF%91%E6%9B%B4%E6%96%B0%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dangerouslySetInnerHTML 编译更新失效</h2>\n<h3 id="需求背景-16"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>使用了 dangerouslySetInnerHTML 渲染的富文本组件，在编译之后不生效</p>\n<h3 id="核心代码-14"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/components/htmlComponent/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77557717223077360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode } from \'react\';\n\ninterface HtmlComponentProps {\n   children: ReactNode;\n   className?: string;\n}\n\nconst HtmlComponent = ({ children, className }: HtmlComponentProps) =>\n   typeof children === \'string\' ? (\n      // key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败\n      <div className={className} key={Math.random()} dangerouslySetInnerHTML={{ __html: children }} />\n   ) : (\n      <div className={className}>{children}</div>\n   );\n\nexport default HtmlComponent;`, `77557717223077360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">HtmlComponentProps</span> <span class="token punctuation">{</span>\n   children<span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">HtmlComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> className <span class="token punctuation">}</span><span class="token punctuation">:</span> HtmlComponentProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n      <span class="token comment">// key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> children <span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>\n   <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> HtmlComponent<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/国际官网技术难点攻关/index.md absPath of file >>> MarkdownRemark",timeToRead:56,frontmatter:{date:"2022-12-16 17:26:58",path:"/international-official-website-technical-difficulties/",tags:"前端, 国际官网, 预研",title:"国际官网技术难点攻关",draft:null}},{excerpt:"架构 选型背景 搭建一个便于 SEO 的官网 技术栈团队成员熟悉，开发方便 提到 SEO，主流的渲染方式都是 SSR 框架选型 详见  http://doc.ssr-fc.com/docs/features$technology 支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的 特性 前端框架: React v17, 实时跟进 React17 的新特性 开发语言: TypeScript 代码风格(可选): 默认 eslint-config-standard…",html:'<h1 id="架构"><a href="#%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构</h1>\n<h2 id="选型背景"><a href="#%E9%80%89%E5%9E%8B%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型背景</h2>\n<ol>\n<li>搭建一个便于 SEO 的官网</li>\n<li>技术栈团队成员熟悉，开发方便</li>\n</ol>\n<p>提到 SEO，主流的渲染方式都是 SSR</p>\n<h2 id="框架选型"><a href="#%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>框架选型</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$technology" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$technology</a></p>\n<p>支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的</p>\n<h3 id="特性"><a href="#%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>特性</h3>\n<ul>\n<li>前端框架: React v17, 实时跟进 React17 的新特性</li>\n<li>开发语言: TypeScript</li>\n<li>代码风格(可选): 默认 eslint-config-standard-react-ts</li>\n<li>样式处理: less + css modules(根据后缀名自动识别 .module.less 文件使用 css-modules)</li>\n<li>UI 组件: 默认已对 antd 的使用做打包配置无需额外配置</li>\n<li>前端路由: 约定式路由/声明式路由</li>\n<li>数据管理: 使用 Hooks 提供的 useContext 实现极简的跨组件通信方案, 摒弃传统的 redux/dva 等数据管理方案</li>\n<li>构建工具: Webpack/Vite</li>\n</ul>\n<h3 id="优点"><a href="#%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h3>\n<ol>\n<li>\n<p>支持三种渲染模式</p>\n<p>支持服务端渲染与客户端渲染两种模式任意切换。随时安全降级。同时支持生成 html 文件独立部署也是同类型框架中唯一同时实现了三种功能的方案</p>\n</li>\n<li>\n<p>同时支持 Vite/Webpack</p>\n</li>\n<li>\n<p>轻量的数据管理方案（userContext + useReducer）</p>\n</li>\n<li>\n<p>支持约定式路由和声明式路由</p>\n</li>\n<li>\n<p>支持 antd 等流行框架（兼容 ssr）</p>\n</li>\n<li>\n<p>支持 midway，接口开发方便</p>\n</li>\n</ol>\n<h3 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ol>\n<li>有些三方库并不支持 ssr，大多数时候需要改源码</li>\n<li>开发模式下采用 webpack 多次编译后会内存溢出</li>\n<li>文件较多时 webpack 编译速度较慢</li>\n</ol>\n<h3 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>astro 孤岛架构，每个部分都可以延迟加载</li>\n<li>remix 的并行加载、预加载</li>\n<li><a href="https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/54.%E7%B2%BE%E8%AF%BB%E3%80%8A%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%90%E8%A1%8C%20serverRender%E3%80%8B.md" target="_blank" rel="nofollow noreferrer noopener">前端 ssr</a>，预渲染，设置合理缓存，减少服务器压力</li>\n<li>service worker 缓存</li>\n</ol>\n<h2 id="目录介绍"><a href="#%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录介绍</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$structure" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$structure</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79778882724841140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index => /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render\\$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render\\$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render\\$user\\$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch\\$id.ts\n│   │   │   └── render\\$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render\\$id 对应 fetch\\$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测`, `79778882724841140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index =&gt; /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render$user$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch$id.ts\n│   │   │   └── render$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render$id 对应 fetch$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="核心"><a href="#%E6%A0%B8%E5%BF%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心</h1>\n<h2 id="多语言"><a href="#%E5%A4%9A%E8%AF%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多语言</h2>\n<p>采用 react-i18next 适配多语言，支持解析多文件夹，携带路径前缀等特性</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33426452498943517000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts`, `33426452498943517000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<p>比如 locales/lang/da-DK/g3i/car-text.ts 下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11970513743816192000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `11970513743816192000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时拿到的 title 的 key 为 <code class="language-text">g3I.carText.title</code>, 是哪个国家根据后端拿到的 language 字符判断</p>\n<p>使用时代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48568243632746790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { t } = useTranslation();\nconst getValue = (param: string) => t(\\`g3I.carText.\\${param}\\`);`, `48568243632746790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">g3I.carText.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>进入通用组件，切换语言</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48318304159915246000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`initLanguage(state?.language).catch()\nconst { i18n } = useTranslation()\nuseEffect(() => {\n   state?.language && i18n.changeLanguage(state.language)\n   // eslint-disable-next-line react-hooks/exhaustive-deps\n}, [state?.language])`, `48318304159915246000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token function">initLanguage</span><span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> i18n <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   state<span class="token operator">?</span><span class="token punctuation">.</span>language <span class="token operator">&amp;&amp;</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>language<span class="token punctuation">)</span>\n   <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>读取文件夹下语言配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39074449288156980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `39074449288156980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-1"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>改造成 history.push 的跳转时切换多语言未生效</li>\n<li>不支持热加载，需重新刷新后才会生效</li>\n<li>多语言配置到后台，直接从后台读</li>\n</ol>\n<h2 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h2>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tblUDHlEq3ZXvNm4&#x26;view=vewUNrsVAJ&#x26;sheet=q7FBB0" target="_blank" rel="nofollow noreferrer noopener">动效一览</a></p>\n<ol>\n<li>react-spring（触发型动效）</li>\n<li>react-gsap（触发型动效，受控型动效）</li>\n<li>react-scrollmagic（页面停留组件）</li>\n<li>图片序列帧</li>\n</ol>\n<h3 id="触发型动效"><a href="#%E8%A7%A6%E5%8F%91%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>触发型动效</h3>\n<ol>\n<li>位移 + 数字跳动（react-spring）</li>\n<li>文字从上到下逐渐显示、p7-wing 鹏翼门的放大缩小（react-gsap）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="受控型动效"><a href="#%E5%8F%97%E6%8E%A7%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>受控型动效</h3>\n<ol>\n<li>受控的图片序列帧的播放（canvas 实现的视频播放器，jsmpeg，react-gsap + jsmpeg）</li>\n<li>播放镂空文字（react-gsap + mix-blend-mode）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="优化方向-2"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>图片序列帧的性能优化，目前方案在有些机器上帧率过低（采用图片序列帧 + avif）</li>\n<li>在页面滚动过快时，react-gsap 执行不完全</li>\n</ol>\n<h2 id="多端适配"><a href="#%E5%A4%9A%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多端适配</h2>\n<h3 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h3>\n<p>采用 @our-patches/postcss-px-to-viewport 插件</p>\n<ol>\n<li>PC 端根据 1920 px 的设计稿宽度直接转换成 rem 单位，再由 css 多媒体查询去控制</li>\n<li>h5 端直接使用 vw 单位</li>\n</ol>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>配置代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17734876276414480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `17734876276414480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99884247429679810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 2560px) and (max-width: 5119px) {\n   html {\n      font-size: 22.26px;\n   }\n}\n\n@media screen and (min-width: 2388px) and (max-width: 2559px) {\n   html {\n      font-size: 21.15px;\n   }\n}\n\n/* ... */`, `99884247429679810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2560px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 5119px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 22.26px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2388px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 2559px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 21.15px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* ... */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-3"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>\n<p>所有端都使用 rem 单位，便于控制</p>\n</li>\n<li>\n<p>适配 ipad 端</p>\n</li>\n<li>\n<p>使用以下语法，保证适配的合理性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76496530331393920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 375px) {\n  html {\n     /* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */\n     font-size: calc(16px + 2 * (100vw - 375px) / 39);\n  }\n}`, `76496530331393920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 375px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">html</span> <span class="token punctuation">{</span>\n     <span class="token comment">/* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */</span>\n     <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>16px + 2 * <span class="token punctuation">(</span>100vw - 375px<span class="token punctuation">)</span> / 39<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h2>\n<p>lazyLoader 通用组件使用 vanilla-lazyload，对 video、img、div 的懒加载封装</p>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tbldGkkqr5yse2oT&#x26;view=vew1FvZJiF&#x26;sheet=j9pMmo" target="_blank" rel="nofollow noreferrer noopener">文档</a></p>\n<h3 id="优化方向-4"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>预加载</li>\n<li>组件级别的懒加载、预加载</li>\n</ol>\n<h2 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h2>\n<h3 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h3>\n<p>需要对视频进行压缩，图片序列帧进行格式转换，支持多文件、并行压缩</p>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73102366478554040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `73102366478554040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27974774801953518000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `27974774801953518000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式-1"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89980656980713280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`yarn compress # 压缩全部视频文件\nyarn public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 # 部分压缩`, `89980656980713280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">yarn</span> compress <span class="token comment"># 压缩全部视频文件</span>\n<span class="token function">yarn</span> public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 <span class="token comment"># 部分压缩</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="优化方向-5"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>支持图片压缩</li>\n<li>压缩脚本工具化</li>\n<li>图片、视频的 cdn、格式优化（av1, avif）</li>\n</ol>\n<h1 id="痛点"><a href="#%E7%97%9B%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>痛点</h1>\n<ol>\n<li>国际站与国家站，pc 与 h5 代码相互影响</li>\n<li>复用样式太多，导致需要重置的样式也很多（尽量少写或不写复用样式，除非非常确定。pc 端与 h5 端样式利用媒体查询分开写）</li>\n<li>antd 组件的适配方式有问题，未转化为 rem 单位</li>\n<li>h5 下应该使用 antd-mobile 组件</li>\n<li>国家站车型部分重复代码过多</li>\n<li>生成路由含有 2 个国家及以上的（已解决）</li>\n<li>官网内的链接跳转未使用 history.push（解决中）</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/国际官网核心原理/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2022-12-16 17:26:23",path:"/international-official-website-core-principle/",tags:"前端, 国际官网, 预研",title:"国际官网核心原理",draft:null}},{excerpt:"源码结构 重点介绍标红行的内容 对象模型 概述 Python 是一门面向对象语言，实现了一个完整的面向对象体系，简洁而优雅。 一切皆对象 首先，在 Python 世界，基本类型也是对象，与通常意义的“对象”形成一个有机统一。换句话讲，Python 不再区别对待基本类型和对象，所有基本类型内部均由对象实现。一个整数是一个对象，一个字符串也是一个对象： 其次，Python 中的类型也是一种对象，称为类型对象。整数类型是一个对象，字符串类型是一个对象，程序中通过 class…",html:'<h1 id="源码结构"><a href="#%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码结构</h1>\n<p>重点介绍标红行的内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99499424119227740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cd Python-3.7.4\n\\$ tree -L 1\n.\n├── CODE_OF_CONDUCT.rst\n├── Doc # 文档相关\n├── Grammar # 语法规则\n├── Include # 头文件\n├── LICENSE\n├── Lib # 标准库\n├── Mac\n├── Makefile.pre.in\n├── Misc\n├── Modules\n├── Objects # 内建对象实现\n├── PC\n├── PCbuild\n├── Parser # 语法分析相关\n├── Programs\n├── Python # 虚拟机执行相关\n├── README.rst\n├── Tools\n├── aclocal.m4\n├── config.guess\n├── config.sub\n├── configure\n├── configure.ac\n├── install-sh\n├── m4\n├── pyconfig.h.in\n└── setup.py`, `99499424119227740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{7,14,19}"\n              >\n                <span class="gatsby-code-button-language">bash{7,14,19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">cd</span> Python-3.7.4\n$ tree -L <span class="token number">1</span>\n<span class="token builtin class-name">.</span>\n├── CODE_OF_CONDUCT.rst\n├── Doc <span class="token comment"># 文档相关</span>\n├── Grammar <span class="token comment"># 语法规则</span>\n<span class="gatsby-highlight-code-line">├── Include <span class="token comment"># 头文件</span></span>├── LICENSE\n├── Lib <span class="token comment"># 标准库</span>\n├── Mac\n├── Makefile.pre.in\n├── Misc\n├── Modules\n<span class="gatsby-highlight-code-line">├── Objects <span class="token comment"># 内建对象实现</span></span>├── PC\n├── PCbuild\n├── Parser <span class="token comment"># 语法分析相关</span>\n├── Programs\n<span class="gatsby-highlight-code-line">├── Python <span class="token comment"># 虚拟机执行相关</span></span>├── README.rst\n├── Tools\n├── aclocal.m4\n├── config.guess\n├── config.sub\n├── configure\n├── configure.ac\n├── install-sh\n├── m4\n├── pyconfig.h.in\n└── setup.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="对象模型"><a href="#%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象模型</h1>\n<h2 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h2>\n<p>Python 是一门面向对象语言，实现了一个完整的面向对象体系，简洁而优雅。</p>\n<h3 id="一切皆对象"><a href="#%E4%B8%80%E5%88%87%E7%9A%86%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一切皆对象</h3>\n<p>首先，在 Python 世界，基本类型也是对象，与通常意义的“对象”形成一个有机统一。换句话讲，Python 不再区别对待基本类型和对象，所有基本类型内部均由对象实现。一个整数是一个对象，一个字符串也是一个对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85618834098303550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> b = \'abc\'`, `85618834098303550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其次，Python 中的类型也是一种对象，称为类型对象。整数类型是一个对象，字符串类型是一个对象，程序中通过 class 关键字定义的类也是一个对象。</p>\n<p>举个例子，整数类型在 Python 内部是一个对象，称为类型对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34729721751990338000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int\n<class \'int\'>`, `34729721751990338000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int\n<span class="token operator">&lt;</span>class <span class="token string">\'int\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>通过整数类型实例化可以得到一个整数对象，称为实例对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86972166548086110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(\'1024\')\n1024`, `86972166548086110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int<span class="token punctuation">(</span><span class="token string">\'1024\'</span><span class="token punctuation">)</span>\n<span class="token number">1024</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>面向对象理论中的“类”和“对象”这两个基本概念，在 Python 内部都是通过对象实现的，这是 Python 最大的特点。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-06-58-cfca5e9f930b12991d1d8c14a4274a22-eca56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 554px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.87725631768953%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABP0lEQVQY022R207DMAyG+95c8RJcIyEkXmAIAUIDjZsVEEyo2lZYtR7XLV1b2qaJGyek7TSOVi5s2f5tfzGUUlJ+vb19c9sKgY2UuAt2jjLUH0OpBLY6frT2o7hg6McZ5RCR+fDh9MW+AcGE1FrS0FWUYQ2ScllD2zQPirtJuMq4v0rcKKk4BqSkXHjx6/X42LQGjWC7ye6mNu3UnJFHO3la5EUtKi5IziigG22X4VZ0OzYIiKJfm0Fpe+Y2D41pUN1b64uxc/vsj+dpWjY9hZ8nY3+n7BIFTc4uD63FyNCjnLj2CFtumBNTfe2eVl7WXkRkx6uq05C8kcxHKQTyf4Bp4UYoJ66uTGcaFN66sJcxAOiU3vPk/GAwOtLYdXMHvwP265/SEt7DLCkgSsrJzLVs94NWiMCAQtOiEgh95SeK+sak83RjOQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 06 58" title="" data-src="/static/2022-09-26-14-06-58-cfca5e9f930b12991d1d8c14a4274a22-eca56.png" data-srcset="/static/2022-09-26-14-06-58-cfca5e9f930b12991d1d8c14a4274a22-77254.png 200w,\n/static/2022-09-26-14-06-58-cfca5e9f930b12991d1d8c14a4274a22-789d0.png 400w,\n/static/2022-09-26-14-06-58-cfca5e9f930b12991d1d8c14a4274a22-eca56.png 554w" data-sizes="(max-width: 554px) 100vw, 554px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="类型、对象体系"><a href="#%E7%B1%BB%E5%9E%8B%E3%80%81%E5%AF%B9%E8%B1%A1%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类型、对象体系</h3>\n<p>a 是一个整数对象（实例对象），其类型是整数类型（类型对象）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39626644444530390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> type(a)\n<class \'int\'>\n>>> isinstance(a, int)\nTrue`, `39626644444530390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'int\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> isinstance<span class="token punctuation">(</span>a, int<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么整数类型的类型又是什么呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77973410565743180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(int)\n<class \'type\'>`, `77973410565743180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>int<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>可以看到，整数类型的类型还是一种类型，即类型的类型。只是这个类型比较特殊，它的实例对象还是类型对象。</p>\n<p>Python 中还有一个特殊类型 object，所有其他类型均继承于 object，换句话讲 object 是所有类型的基类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95243758772781800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(int, object)\nTrue`, `95243758772781800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>int, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>综合以上关系，得到以下关系图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-27-03-d003b10d203dbb41db1f5dfa1040a0c0-88eb7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 411px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.65936739659367%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz5WQ20vCABTG9//3Ug8RRfSQhEEUFWmEJWQXTZrXbTWrLeduLltq0dX5a1MkU3rogw8OHM7vnPMJlmWTTqfJ5XK0Wi0m1TAMUqkU+Xyedrs91Q+CAEmSB/Pd7jNCRkmQVrY4lDbJSEm+vnrIsoyqqjz5PgeFGtuixvblHUnxhk4I1XWdcrnE69sHVvWIpriBW9jEFHcQktIq6xdzxEMnyrHwykds28bzPCqlImunCkundywcq8Tz+mCZaZq4rkPtVse8iNM8nkU7mMHLLiNcG2VUK3KJWkOaeumq7lDUbEqag1J3cRwHI4xhpI57SydkdM0qj/UqwiSg3+//8qSidyP7YRwD4Ms7Nd1CazRxHp4QolDHPQ6J6iD4cS/sjxTle39f56qQQT7bRcnuUc3uT1/4l0aLxpe+f/bw5QTuyTze+RK+uPY/4Ag0rIfXupUkZmYRJ7uCcR7jG2PNUfvdx+1RAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 27 03" title="" data-src="/static/2022-09-26-14-27-03-d003b10d203dbb41db1f5dfa1040a0c0-88eb7.png" data-srcset="/static/2022-09-26-14-27-03-d003b10d203dbb41db1f5dfa1040a0c0-e0906.png 200w,\n/static/2022-09-26-14-27-03-d003b10d203dbb41db1f5dfa1040a0c0-4c29a.png 400w,\n/static/2022-09-26-14-27-03-d003b10d203dbb41db1f5dfa1040a0c0-88eb7.png 411w" data-sizes="(max-width: 411px) 100vw, 411px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>内置类型已经搞清楚了，自定义类型及对象关系又如何呢？定义一个简单的类来实验：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60414057138589100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(object):\n\n    def yelp(self):\n        print(\'woof\')`, `60414057138589100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">yelp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'woof\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建一个 Dog 实例，毫无疑问，其类型是 Dog：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94522193637371530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> dog = Dog()\n>>> dog.yelp()\nwoof\n>>> type(dog)\n<class \'__main__.Dog\'>`, `94522193637371530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> dog <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> dog.yelp<span class="token punctuation">(</span><span class="token punctuation">)</span>\nwoof\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>dog<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'__main__.Dog\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Dog 类的类型自然也是 type，其基类是 object (就算不显式继承也是如此)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64696857020465150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(Dog)\n<class \'type\'>\n>>> issubclass(Dog, object)\nTrue`, `64696857020465150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Dog<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Dog, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-31-23-001ef654f1c6a7054988e658d131dffa-6a9ea.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 413px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.847457627118644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACEUlEQVQoz3WS7U/TYBTF+//7xQ+IHyTxg+9ANAhEWEGYTDY69wYtVtaOrls327Vso5vt6NjPpzUahXiTm9z0pOfec84jDfwB8p5MsVSk/73P3bKsNru5nMBLjMfje/gsjtHUM0rFY+IoQioZMvv6OrL6hgNtg8lkShRHxLMZvueyUzd5W7VYL7fYbVgZ6UxgsSBKZ6e6yaDyGq+6inn0DKnQes96ZZlVZYkd9QWu6xEEAVfDIdpZgzXFYOWzyUrBYOPUQdM0ut0uYRiytbVF6/AJXmEZJ79EN7+M1L+ycUMbb9LBCax7krr+GCuYYF/9EHjIYrHIFg7FwtFoxDSwSYZt5uMOo34TaZGA1/OxjA7T6ygjub29zTqtRSKk9x1MXSOehtk313UxDCObe27A12abunqBP5wgNcwSn9QPHIk+OT/857qFIK2ZHT6eNpFrOlUxp94OBgPG19eYpomu7GB9EdLLm+jFTeHh5QbvGo9ZqwgPz5/T6/XxPA/fD6iUFba1Dq/qNi9FMPutAFVV6TlO5rGu69iFp1i5B8LHR1zKD5FqrWNKTZnjb7uc6AfM5/M/cpObG8pNm6OLLnm9TaXlZB7+tiVJEhwtT6++javmMBVx4d0QFvz6IX0SURTfCykNIiX6X0npxr87rRtxWa1Wy4x3nF52TYqkb1RRFGzbzlJO1YTCy9FoKJL3mU4n/AT3NN2N5kFDZwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 31 23" title="" data-src="/static/2022-09-26-14-31-23-001ef654f1c6a7054988e658d131dffa-6a9ea.png" data-srcset="/static/2022-09-26-14-31-23-001ef654f1c6a7054988e658d131dffa-7efe1.png 200w,\n/static/2022-09-26-14-31-23-001ef654f1c6a7054988e658d131dffa-33ab6.png 400w,\n/static/2022-09-26-14-31-23-001ef654f1c6a7054988e658d131dffa-6a9ea.png 413w" data-sizes="(max-width: 413px) 100vw, 413px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>自定义子类及实例对象在图中又处于什么位置？定义一个猎犬类进行实验：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85298813516730810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Sleuth(Dog):\n\n    def hunt(self):\n        pass`, `85298813516730810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Sleuth</span><span class="token punctuation">(</span>Dog<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">hunt</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，猎犬对象(sleuth)是猎犬类(Sleuth)的实例，Sleuth 的类型同样是 type：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73934063917340430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sleuth = Sleuth()\n>>> sleuth.hunt()\n>>> type(sleuth)\n<class \'__main__.Sleuth\'>\n>>> type(Sleuth)\n<class \'type\'>`, `73934063917340430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sleuth <span class="token operator">=</span> Sleuth<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> sleuth.hunt<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>sleuth<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'__main__.Sleuth\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Sleuth<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，Sleuth 类继承自 Dog 类，是 Dog 的子类，当然也是 object 的子类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92722320163384150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(Sleuth, Dog)\nTrue\n>>> issubclass(Sleuth, object)\nTrue`, `92722320163384150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Sleuth, Dog<span class="token punctuation">)</span>\nTrue\n<span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Sleuth, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-34-40-b3d92d6a1012d777104d5533b3e6464e-88eb7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 411px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.82968369829685%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACxklEQVQ4y3WU62/aSBTF/f9/qrRbrZrNt6rpqi1NqnbzaMijaVMIEIMXAzEPm0dsXsa8DcbAr+ORUnWT3SsdjT1z59x7z9wZpdPucHFxSeomhTfweGytZpOzeJxMOs14NHqyvgrXFEt3JBJJZnMf5VvxiHN9nzP9PVf5Ixb+giAIWK1WIoBLPFfhIF0VqHCaqzGZTAjDkOVyyVz42vkz2rcx2uo+9dQ+ymdjj7e3vwv8xt/aS9y+y3A4lBv/yWV5kzLZTTbYuTZ5l7PRdZ1ut8t8Pufq6zW1yz8ZJZ7jXD6j9/0FSsXRMd2CRMUuPCnJsPvk7wcU7KH4HsjsPc+ThJFUjVKKoFfCb+t4DQ1lE8CwN8FpdlkHW0my2WwkpIUBY7eL0zBZziZyKiJUVVXKMpwsKFs2Rq1Fxx2jaOUU11qcK/UErZx+kqFutfiSLXKeyZOr1GUg13UxDIPW/T0l9Ypi8pCCQCl9hnJefcNHfZePhV2O83s4Tpter8dAZHErTvao2OJ9sUNMd4jXXDRNwzRNarUad0aZ+5vX9L49Z5DcoX29g5KonvDFOOC8FCNR/ky4CmUW2+2WyXhE0uxwLEgP83WS9b483fF4LLHebOnop7TTf9HPxWil3qEs/YBgsWIpMB3PJFFkD+MmXOGI0pp1C38++6lhpJ+UeL0lFMRyXG9Q7solND1H0dC5SSefaFiz6txkVBKpDBk1y2KxoN/v/yvor6ZEDX2i73GsvxKNG5OlTKdTZrMZdcvkNG/yQbM4yFlcGDZNcXOish8IH0M5zr9iP/uCmPoHn25fCsKJJIxug2XW+KSZvFYt9sRtOSy0ZKCH1vovUqXj2fRGNt0InvMz9ag1fNG83synPZzSGU2F3xTbtvF9//9LfjwROUU6Re1RrVbF49CIZuXacuGTzWZpNBpSx/V6zUg8GIPBQP5Hcv0A338E+PnREMsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 34 40" title="" data-src="/static/2022-09-26-14-34-40-b3d92d6a1012d777104d5533b3e6464e-88eb7.png" data-srcset="/static/2022-09-26-14-34-40-b3d92d6a1012d777104d5533b3e6464e-e0906.png 200w,\n/static/2022-09-26-14-34-40-b3d92d6a1012d777104d5533b3e6464e-4c29a.png 400w,\n/static/2022-09-26-14-34-40-b3d92d6a1012d777104d5533b3e6464e-88eb7.png 411w" data-sizes="(max-width: 411px) 100vw, 411px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在不可避免需要讨论 type 以及 object 这两个特殊的类型。</p>\n<p>理论上，object 是所有类型的基类，本质上是一种类型，因此其类型必然是 type。而 type 是所有类型的类型，本质上也是一种类型，因此其类型必须是它自己！</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75341684272667670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(object)\n<class \'type\'>\n>>> type(object) is type\nTrue`, `75341684272667670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>object<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>object<span class="token punctuation">)</span> is <span class="token builtin class-name">type</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43689213610206970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(type)\n<class \'type\'>\n>>> type(type) is type\nTrue`, `43689213610206970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>type<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>type<span class="token punctuation">)</span> is <span class="token builtin class-name">type</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，由于 object 是所有类型的基类，理论上也是 type 的基类(<code class="language-text">__base__</code> 属性)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93819090461857700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(type, object)\nTrue\n>>> type.__base__\n<class \'object\'>`, `93819090461857700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>type, object<span class="token punctuation">)</span>\nTrue\n<span class="token operator">>></span><span class="token operator">></span> type.__base__\n<span class="token operator">&lt;</span>class <span class="token string">\'object\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 object 自身便不能有基类了。为什么呢？对于存在继承关系的类，成员属性和成员方法查找需要回溯继承链，不断查找基类。因此，继承链必须有一个终点，不然就死循环了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-39-00-0dbb7a586e3c39186f9c3f19df34840b-9e231.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 444px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACoElEQVQ4y22TW2/bRhBG+f8fA7RBihh9SGKkhmo4jes6TerEdqqIlawLRVuyJVO8iJR4E0lRlqjr6YotDDvJAAPsfuB+O3N2KAVBQLH4N9XqBWma8jCWyyXlcpkvpRKmafJ1zGYzmk2FdruVr+fzOVKp84Gj+iuOGi8ptf8im82ZLxaslguUmx57cpfXxTb7FQ3HC1mvVizERZPJBLv2Frv0Arf8CuX8gIaiCkP9HW8az3nb3OG8fUToj4iThFHgcyLX+KU+ZOdMGKoeSquDZRpMRTWFQgH9/GdCeQe/+Ix+45iOpiOFiUcwHuLFNqMkeNRStlhiBxGDKMX2I9YbGIvLhsMh9XqdyLPpXl7g9K5YTMdCd5Em6QS9Z3CpXrFdfx19y6SpNLAMPd9vW61Wqzlfw+xzevYZ+Z8KyTjF932kC+2UP5U93qt7lG9OmU0zMgF3Mc9o90yOVYPDWoeTaxvb9Rk4tnggC1VV6X7ZxyrtCo67WOo5hmUjyeYx+7VnHCg/8fn6dzw3IIojAs/jtFLnsBOyK1/zTotoa0ZuaFl9HFsYF19gnjwhKD7lVj5gFKdIXjwgmDi4iUWQuN8wNAW7S83CGY1zbTq9I8uyfJ2GNtPQ4M7XuUv8XJO8oY+umWhdnZ6mPzKci4P6bRelVqV9qeZzGoYhKzE6m83mG95bTSp3PvFeKfCh+Svy1af/GWbCbEZLtPhHvcvhxbVg3MN0BqTj8f3hzWb9IMV+W+FZ5zcK1R9F/sBH9Y2Yv0i82Jg0iXOGr6s9Xso3FBomThjlZuv1+oHp45QGI4t+eIsl0h3Z9+VHUUS2XGGNUowgwYnv8IJQMJzem30vpO9xcF2XSqVCu9UiDv8b9vX2V1QUWkKzbfu+0jiO8++32pbvv0YbvajiQ91/AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 39 00" title="" data-src="/static/2022-09-26-14-39-00-0dbb7a586e3c39186f9c3f19df34840b-9e231.png" data-srcset="/static/2022-09-26-14-39-00-0dbb7a586e3c39186f9c3f19df34840b-f72be.png 200w,\n/static/2022-09-26-14-39-00-0dbb7a586e3c39186f9c3f19df34840b-0eb67.png 400w,\n/static/2022-09-26-14-39-00-0dbb7a586e3c39186f9c3f19df34840b-9e231.png 444w" data-sizes="(max-width: 444px) 100vw, 444px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这就完整了！</p>\n<p>可以看到，所有类型的基类收敛于 object，所有类型的类型都是 type，包括它自己！这就是 Python 类型、对象体系全图，设计简洁、优雅、严谨。</p>\n<p>该图将成为后续阅读源码、探索 Python 对象模型的有力工具，像地图一样指明方向。图中所有实体在 Python 内部均以对象形式存在，至于对象到底长啥样，相互关系如何描述，这些问题先按下不表，后续一起到源码中探寻答案。</p>\n<h3 id="变量只是名字"><a href="#%E5%8F%98%E9%87%8F%E5%8F%AA%E6%98%AF%E5%90%8D%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量只是名字</h3>\n<p>先看一个例子，定义一个变量 a，并通过 id 内建函数取出其“地址”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13462711719839703000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> id(a)\n4302704784`, `13462711719839703000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>定义另一个变量 b，以 a 赋值，并取出 b 的“地址”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22041010494689940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b = a\n>>> id(b)\n4302704784`, `22041010494689940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>b<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>惊奇地看到，a 和 b 这两个变量的地址居然是相同的！这不合常理呀！</p>\n<p>对于大多数语言（C 语言为例），定义变量 a 即为其分配内存并存储变量值</p>\n<p>变量 b 内存空间与 a 独立，<code class="language-text">赋值时进行拷贝，不赋值时还是原来地址</code></p>\n<p>在 Python 中，一切皆对象，整数也是如此，变量只是一个与对象关联的名字</p>\n<p>而变量赋值，只是将当前对象与另一个名字进行关联，背后的对象是同一个</p>\n<p>因此，在 Python 内部，变量只是一个名字，保存指向实际对象的指针，进而与其绑定。变量赋值只拷贝指针，并不拷贝指针背后的对象</p>\n<h3 id="可变对象与不可变对象"><a href="#%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1%E4%B8%8E%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可变对象与不可变对象</h3>\n<p>定义一个整数变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46097464694368590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> id(a)\n4302704784`, `46097464694368590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，对其自增 1：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31448016011529490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a += 1\n>>> a\n2\n>>> id(a)\n4302704816`, `31448016011529490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704816</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>数值符合预期，但是对象变了！初学者一脸懵逼，这是什么鬼？</p>\n<p>一切要从可变对象和不可变对象说起。可变对象在对象创建后，其值可以进行修改；而不可变对象在对象创建后的整个生命周期，其值都不可修改。</p>\n<p>在 Python 中，整数类型是不可变类型，整数对象是不可变对象。修改整数对象时，Python 将以新数值创建一个新对象，变量名与新对象进行绑定；旧对象如无其他引用，将被释放。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-ec22f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.51851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAr0lEQVQI14WPSwvCMBCE8///ih5V8FjrQajgwWMv1SilD9OmTfPaJGva4tmPXVgYmJkl2kIvpAVnrGlYxUXnvQ8LiLiqAA4xaJji+ODxB6GfMcmrlst+aNLHJi22fGLs0z0p1Uq+e3nKq7obtRVZecjKHVctBgSA6E7i+iXEeTdINkwsHjF8lmMFxDVqUuJWJPfXmQ2NVoZzbq0l+I+As7UBdaXHS7FnYz2/o7Vz7gvDneSUGtVpiAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 55 02" title="" data-src="/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-fee1c.png" data-srcset="/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-a67b7.png 200w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-0b187.png 400w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-fee1c.png 800w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-b1a91.png 1200w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-95179.png 1600w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-5d5ba.png 2400w,\n/static/2022-09-26-14-55-02-61f5df318944c4f90b04a91b7409dae8-ec22f.png 2700w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<blockquote>\n<p>每次修改整数对象都要创建新对象、回收旧对象，效率不是很低吗？确实是，后续章节将从源码角度来解答：Python 如何通过小整数池等手段进行优化。</p>\n</blockquote>\n<p>可变对象是指创建后可以修改的对象，典型的例子是列表（list）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27489061315691753000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> l = [1, 2]\n>>> l\n[1, 2]\n>>> id(l)\n4385900424`, `27489061315691753000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> l\n<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>l<span class="token punctuation">)</span>\n<span class="token number">4385900424</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>往列表里头追加数据，发现列表对象还是原来那个，只不过多了一个元素了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99491861912630560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> l.append(3)\n>>> l\n[1, 2, 3]\n>>> id(l)\n4385900424`, `99491861912630560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> l.append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> l\n<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>l<span class="token punctuation">)</span>\n<span class="token number">4385900424</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际上，列表对象内部维护了一个动态数组，存储元素对象的指针：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-8132c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.74509803921568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACHUlEQVQoz5VSXW/SUBjm/3i3C3+BV8b4G0w0aoyaGBOjMf4CLxbDQshIhhplMRpBZqcEGGOMjTIYCgPKKP3go0JKaUtLy+mnB2jYUi6M70nOx5vzPO/7nPN4bNu2TNMyDcsy7X+FNY/l0aPr+l6F+FFl8hg1FnhBFHmBB2A644Tj0lUXywwMlxrFIIfF9oAzTQMGzCoimKrABYBlZEkRR5KuGU7lWRaADk0uYOKER0rB8Il/O/MmWgoU8NSiEgCA40YtppqrJ1As2fpzZpqmZ0kMD3DuDom7H9cefLp6y7d2e/vKZuolTE6nKscNDd3KNCPJzlasFYhjHzRN87heojckn4evv0Juvvh641n0Wuj4tW3a7JBdUJNMM33y8/A0gVFlp+0lUtfMVgfzZh5uFp8ECk+9ufvhgn86gTWAqqqSJPGcWCs3Br0hUHUHfNG5bhFdbD19z5d/5EMfrx/d+ZLfUCQgiIIsSxrQBnynThdrdJHhKUczx3H1eh3DMFEY9wZ05MwbIwNQ2M75xhGOzEjnFrAMO0chaeZ9qv3ugPjsaJZlud/vsywrS5Nun96tbO3hoWQzFMOCaDNxWVejXUmg0f0CUsbz7rbhB9I94ttvX7wVjDfffsf82cbuHOyYT1GU8wZOkbQ0llYfzOizvSweRWnkmNjJkpFqB136aXXjWTWdPJZLp7/S+wckQbncCa0yGo1mAmXZDf7f+AuJrfiQOuleQwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 57 36" title="" data-src="/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-fee1c.png" data-srcset="/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-a67b7.png 200w,\n/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-0b187.png 400w,\n/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-fee1c.png 800w,\n/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-b1a91.png 1200w,\n/static/2022-09-26-14-57-36-8fb4b5c2d45febca5adcc9bc13d62ef7-8132c.png 1275w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>列表对象增减元素，需要修改该数组。例如，追加元素 3 ：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-8132c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACk0lEQVQ4y5VTW08TQRjd/+SD8c0XY3zzB/jmiwQVMCYmxhjj9c0Ho1IwoUJipEITbgaWCkIpUgq0pbSlpdnu2na7pVv2fp+ZrbNt00iVKF92Z2dn53xzvu+cJZrNJkIQAIAQav4r3FZ0XwkI4XqaXsqw27mfiiTKsixKomWZbtNFLsLXWVk8MH5kmOrCZpyq8h4BAPCqqTqGbrV2nQIYuqFImqnbnZPxDWybKuQBcPDcdqxwdjaUmgxGRr5np7ZyZBuPi5JEqcwxKTq6dbBS4PZVXSa6HFBrlHVhMHD5zvSlm76LfYELz+dvtIk3Gjx03HQptsx8+Eb7F3LD5TpFtAngxO0UsiY8mrn+cOHa/cDVB3NXXpN9ECBBEAzT8FJItY0kGU6Q0fSqZirE7w3A+ypc6V144P12vy828DZ6ayzyGLO1bRv3Vdd1TdGzB3kqz0gnaqfmbkCI2Fp5OHJvZGfAFxsajt32R55gBRRFEUXRMAxZFSt1Olc8aCicaRkeGMvDMAxN04qs1njWFx0aTd4dTQz6Ev0TsaeaqmMJ3FbfDtm975XxVWYiVBxjG7QHxlkpisJgUZCOee7T3stA9kUg8+pz5lkw/kaWvWNV1eNZ4Ytr6dn11Fw4PS8o/GnaAHI19mvST+bGycPxpUN/KBVotdLFYJxCEuTtHzupRKbEsJ2a8be2NwGAtTq3mp/cqgaj1ZlNdnrjaBZB1FXEti3+5JguUQ60IAREj+lweSdiYzceC62Q8eQudkIH2ZI7V44vH31cTPsXM2PVBkP81bqOAwzDxGOPmYtcdq3wZb0QXDuaqktV4izT/zn3zodoP7mfiCeKVLFX5//5JbFhTMO0LOvcYNwzTdMkScK2OTe4J34BwVHZTr9/vF8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 57 53" title="" data-src="/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-fee1c.png" data-srcset="/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-a67b7.png 200w,\n/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-0b187.png 400w,\n/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-fee1c.png 800w,\n/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-b1a91.png 1200w,\n/static/2022-09-26-14-57-53-b75f6f655ad3d4d5d29ed0c570c863a6-8132c.png 1275w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="定长对象与变长对象"><a href="#%E5%AE%9A%E9%95%BF%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%98%E9%95%BF%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定长对象与变长对象</h3>\n<p>Python 一个对象多大呢？相同类型对象大小是否相同呢？想回答类似的问题，需要考察影响对象大小的因素。</p>\n<p>标准库 sys 模块提供了一个查看对象大小的函数 getsizeof：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87853775529148430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.getsizeof(1)\n28`, `87853775529148430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token number">28</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>先观察整数对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26347105382459970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(1)\n28\n>>> sys.getsizeof(100000000000000000)\n32\n>>> sys.getsizeof(100000000000000000000000000000000000000000000)\n44`, `26347105382459970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token number">28</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">100000000000000000</span><span class="token punctuation">)</span>\n<span class="token number">32</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">100000000000000000000000000000000000000000000</span><span class="token punctuation">)</span>\n<span class="token number">44</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见整数对象的大小跟其数值有关，像这样大小不固定的对象称为变长对象。</p>\n<p>我们知道，位数固定的整数能够表示的数值范围是有限的，可能导致溢出。Python 为解决这个问题，采用类似 C++ 中大整数类的思路实现整数对象——串联多个普通 32 位整数，以便支持更大的数值范围。至于需要多少个 32 位整数，则视具体数值而定，数值不大的一个足矣，避免浪费</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4klEQVQoz6WS3U/aYBTG/RuXbLqbJUt2MYNY4jKWqDde7MpNAZViRYqKjpSrOXVxtjATNiilUuvKhzEg9JPRpssyaI1tse8wXCxmW+LJyclJzvk975ucZ6R/jxjRf6ocX6hKRTdrEl2TaU4g63JlMLYsuyYwFZECU5muymCtItDd3i8As408fOJZP5tCSlCk6F0tQuHSc6y4OIB7XSNOzSKsd43xRWjvKj2JMJPRkxe83AAw1ypEWWgu9cQfe+SPjUKhB/Pppx/K4SGc5F6/wZ+9io29XHvoj47OJB5vlaeF9iWAzxpkmPTCeR+c80XyvpUstEyOY4XAADZ6JkrOhinP0pcJd20p61khJxBqild+w7Umu/sNxuvxPQ55fwoTjY39auSIwYYv77HreCuKN1G8GSOaKMGjBxVEVHgAX/Bl/Hwry6eI8+1DbiPbSqXriWNudwCbhvmxlIh/mt9JB3c+BzePFrYzgeTxstKRANwzunJHUFSxrUluuo3c4VX9++23DXO/hL77+hbLhzAymMwF3IrlQlJbAPDfL3llXlEXaUYiGDHDiG6TOZUz9CWu6R0AO3eH/aeM3XesvnVtW9eObTm3JvmnjYBU39F/6KqmKm1FEAVNU/8XHkrcYc/7ePsGRxGkqN1hNrgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 04 06" title="" data-src="/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-fee1c.png" data-srcset="/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-a67b7.png 200w,\n/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-0b187.png 400w,\n/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-fee1c.png 800w,\n/static/2022-09-26-15-04-06-f9d21975c1f631190eec7c3ac84cc722-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样一来，整数对象需要在头部额外存储一些信息，记录对象用了多少个 32 位整数。这就是变长对象典型的结构，先有个大概印象即可，后续讲解整数对象源码时再展开。</p>\n<p>接着观察字符串对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51790378977821975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(\'a\')\n50\n>>> sys.getsizeof(\'abc\')\n52`, `51790378977821975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>\n<span class="token number">50</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span>\n<span class="token number">52</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz6WO3U/aUBjG/RcX4262uyVKBJPFDLzZ/olStiLtmqGii8yLTYaMMUtV2try3UItCJzKp5MylSVSXbeDpy67WCbJnrznnCfneX/nPVM//0NTcJ0O2jnAKm1O6cBKwT2nJ3uDFuoYpyes3LIjpcPndbZnNG1Yqn7B07P+zAKWmvNyDp/gxKQnYjWBYKm668vNEpkFL+/AOAfOz8NmoRK34TzYI7KuF6HHi8S05/XDxVfT+OEcfB7B+ca+P+d8vvYIRm5y5in+4KU4n20wd5O1JJZ0LXNuSlqixKUA7/HuOyWNsScfsd4DF5F6Fjh0k6JnWXBjey5BTdhwGWQ+12juNBwtkRE5wPU2E4CGlwhW9XyyGRJ6WzH1TVSh+e7WLlgtg6wNa0COFVbYyruIFIykg9DE5JUjUESwfJz5IPvjWjAs+DZ5PF4Jvi8Qxapow2NZt/XbWMiOj1I9G1Uppr4e5n1vDzCmsf6xRMo16Q/4b7IsG/5UoZl6aKdE75RvjUrJtfSkcPyYZvWN7UJgu0hCE9MopX4fjHT5/aL1tdE507tGs9tvdvon7TNwMTyfCEYyTXN4Ofw2ODf6A6NvoE/dD1tj/bi5uTavTVgjc3Q1upoU/od+Abcf3lePqnEOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 04 55" title="" data-src="/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-fee1c.png" data-srcset="/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-a67b7.png 200w,\n/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-0b187.png 400w,\n/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-fee1c.png 800w,\n/static/2022-09-26-15-04-55-0a81d23ed0d5655a52117dc0a2ea7582-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>字符串对象也是变长对象，这个行为非常好理解，毕竟字符串长度不尽相同嘛。此外，注意到字符串对象大小比字符串本身大，因为对象同样需要维护一些额外的信息。至于具体需要维护哪些信息，同样留到源码剖析环节中详细介绍。</p>\n<p>那么，有啥对象是定长的呢——浮点数对象 float：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37639938204989630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(1.)\n24\n>>> sys.getsizeof(1000000000000000000000000000000000.)\n24`, `37639938204989630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span>.<span class="token punctuation">)</span>\n<span class="token number">24</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1000000000000000000000000000000000</span>.<span class="token punctuation">)</span>\n<span class="token number">24</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>浮点数背后是由一个 double 实现，就算表示很大的数，浮点数对象的大小也不变。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABm0lEQVQoz6WSyU/CUBDG+Qs9mODNg1FDAsoS0aPxQtREQcNusQJKJMEYoyIQQYrIIi1Ci7hQZSkCKhAxnoC2+KDlrmHy3mRe5vvNN4cn6I0QAnDrrRpO3WSr8YdavJ+rcbwcrjSKnOL754soR7KVGGgNurfEW6Tw8cTDyVdEh4kgXK5PiPWo2IRJtclp5PGYg3NUxpSSQLjUiEmAwJCYM6REp2kzDxNUxJyeX3ZOyg3jS/CEXDu+FZ2JFc57bB9+eXuA7xUrrkklJFy0CCWbYxvBqUvS3mM4ZzKkQUS6sNQYkxuiMn1Ypr6eDWZ4Z7KUNaOKncTCDroAJZUWbNGIzp+gEO/8TOH+vDX+eeR9hJGSI/ruCpZt6XyEc85TOYtXZfWvw741kCG3yhpYDWXOhnCRcONwkHSeYrsewnaVO/Rk4TQZ5ZwL5Ze9i42Dyy27T+MIbNu8mn2/Grk752GGYTog2h2aprvdbmfwADUHsyxYoL8D22MZhmb7chocHv5LgKGtr1az0ax/1iuVarvd/gc8XIEvuFowyg/7BUt0OQa8sN4OAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 05 08" title="" data-src="/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-fee1c.png" data-srcset="/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-a67b7.png 200w,\n/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-0b187.png 400w,\n/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-fee1c.png 800w,\n/static/2022-09-26-15-05-08-d4223cd68f989b97fbc9b2048d1f3626-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为啥 64 位的 double 可以表示这么大的范围呢？答案是：牺牲了精度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68192016343953310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(1000000000000000000000000000000000.)\n999999999999999945575230987042816`, `68192016343953310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int<span class="token punctuation">(</span><span class="token number">1000000000000000000000000000000000</span>.<span class="token punctuation">)</span>\n<span class="token number">999999999999999945575230987042816</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于浮点数存储位数是固定的，它能表示的数值范围也是有限的，超出便会抛锚：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23458763220384006000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> 10. ** 1000\nTraceback (most recent call last):\n   File &quot;<stdin>&quot;, line 1, in <module>\nOverflowError: (34, \'Result too large\')`, `23458763220384006000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">10</span>. ** <span class="token number">1000</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n   File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nOverflowError: <span class="token punctuation">(</span><span class="token number">34</span>, <span class="token string">\'Result too large\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO Python 源码剖析 <a href="https://fasionchan.com/python-source/object-model/pyobject/" target="_blank" rel="nofollow noreferrer noopener">https://fasionchan.com/python-source/object-model/pyobject/</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python源码剖析/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2022-09-26 11:08:48",path:"/python-source-analysis/",tags:"后端, python, 读书笔记",title:"Python源码剖析",draft:null}},{excerpt:"快速入门 绘制一个点 着色器代码放在 script 标签中 绘制一个矩形 attribute 关键字 声明顶点相关数据的时候需要用到 attribute 关键字，目的是为了 js 可以调用相关的 WebGL API 把顶点相关数据从 js 传递给顶点着色器 attribute 声明的变量。 drawArrays 整体执行顺序 硬件相关 着色器语言编写的程序称为着色器程序(shader program)，在 GPU 顶点着色器单元上执行的是顶点着色器程序，在 GPU…",html:'<h1 id="快速入门"><a href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速入门</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-09-14-26-57-ed4432cb963085603269690e4830d463-74e39.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 763px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.46264744429882%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAABvElEQVQoz4WS63KiQBCFef8X25+7ZoOJiTrADCC3YbgrIORDsom15dZWHa2hr6dPt3WdNbiMcXeJxilbP//CNOf9mOjcyQu3qGWqj00XYLTw9dc0SvbKf2m7ENPD5MsQC/cpOO3C0+4oNtq482wsHNOUU0wG23MfY1osf7BmrjCl1MYpa0UwRHBZVeNjqhpVVBKY0i0rWdayKD1I9mNKNPaqVt355Mrfz/YPU3jzXFwnbQXhzpM2xVTwIv1tEL4enSep7Ch+5x2n+zg9hNGbzoWnnk/x2/74M9WCfjS3mi40pdcPybA0kVCom6BuAxjRk8516y/G1kfRslG8u8upaQNUsD6VNA4lAILDHGRaYCcCF/xxMSTlMiNM5SXpYelMB3xJdoAnmmsjICncjadsCJPjuBt0ZiiqkCOcX66yGXC4ZksynGEF2B5qt+cwSt4RDFJErHaMuGDOm6FIWfZMMtMuW5n0glmf+4hWKHy/c97jnE1fy79F3jqPyVccDwZD8CwXD6/tHla90m6+afdDyoaaduH5n2Q6c3H5TVL+i8rzw1dPbVnmv079O5kfMqAQdwL4pBy00fbhnd/jAwZsFJTFiw6kAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 09 14 26 57" title="" data-src="/static/2022-08-09-14-26-57-ed4432cb963085603269690e4830d463-74e39.png" data-srcset="/static/2022-08-09-14-26-57-ed4432cb963085603269690e4830d463-5eda4.png 200w,\n/static/2022-08-09-14-26-57-ed4432cb963085603269690e4830d463-73d63.png 400w,\n/static/2022-08-09-14-26-57-ed4432cb963085603269690e4830d463-74e39.png 763w" data-sizes="(max-width: 763px) 100vw, 763px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="绘制一个点"><a href="#%E7%BB%98%E5%88%B6%E4%B8%80%E4%B8%AA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绘制一个点</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3c2kgh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="着色器代码放在-script-标签中"><a href="#%E7%9D%80%E8%89%B2%E5%99%A8%E4%BB%A3%E7%A0%81%E6%94%BE%E5%9C%A8-script-%E6%A0%87%E7%AD%BE%E4%B8%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>着色器代码放在 script 标签中</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18816773595096370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<!-- 顶点着色器源码 -->\n<script id=&quot;vertexShader&quot; type=&quot;x-shader/x-vertex&quot;>\n   void main() {\n     // 给内置变量 gl_PointSize 赋值像素大小\n     gl_PointSize = 20.0;\n     // 顶点位置，位于坐标原点\n     gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n   }\n</script>\n<!-- 片元着色器源码 -->\n<script id=&quot;fragmentShader&quot; type=&quot;x-shader/x-fragment&quot;>\n   void main() {\n     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n   }\n</script>`, `18816773595096370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- 顶点着色器源码 --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertexShader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     <span class="token comment">// 给内置变量 gl_PointSize 赋值像素大小</span>\n     gl_PointSize <span class="token operator">=</span> <span class="token number">20.0</span><span class="token punctuation">;</span>\n     <span class="token comment">// 顶点位置，位于坐标原点</span>\n     gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token comment">&lt;!-- 片元着色器源码 --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64723195755629590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点着色器源码\nvar vertexShaderSource = document.getElementById(\'vertexShader\').innerText;\n// 片元着色器源码\nvar fragShaderSource = document.getElementById(\'fragmentShader\').innerText;\n// 初始化着色器\nvar program = initShader(gl, vertexShaderSource, fragShaderSource);`, `64723195755629590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 顶点着色器源码</span>\n<span class="token keyword">var</span> vertexShaderSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'vertexShader\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>\n<span class="token comment">// 片元着色器源码</span>\n<span class="token keyword">var</span> fragShaderSource <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'fragmentShader\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>\n<span class="token comment">// 初始化着色器</span>\n<span class="token keyword">var</span> program <span class="token operator">=</span> <span class="token function">initShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vertexShaderSource<span class="token punctuation">,</span> fragShaderSource<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="绘制一个矩形"><a href="#%E7%BB%98%E5%88%B6%E4%B8%80%E4%B8%AA%E7%9F%A9%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绘制一个矩形</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/q3r5b7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="attribute-关键字"><a href="#attribute-%E5%85%B3%E9%94%AE%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>attribute 关键字</h3>\n<p>声明顶点相关数据的时候需要用到 attribute 关键字，目的是为了 js 可以调用相关的 WebGL API 把顶点相关数据从 js 传递给顶点着色器 attribute 声明的变量。</p>\n<h3 id="drawarrays-整体执行顺序"><a href="#drawarrays-%E6%95%B4%E4%BD%93%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>drawArrays 整体执行顺序</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-50b07.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.501519756838904%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAwklEQVQI1wG3AEj/AFad306X3/P57b3a6DaJ25fD5f//72qo4UWS3ev17Mvi6jGG3Iy85P//8G6r4kCQ3eby7NDk6j2O33604wASb9AHZ83l7uWUu9gAU8lsqN719eEpfNAAYc3c6ueoxtoATshdn9z//+QsfdAAX8/V5uWtydkAWs5KktkAOonYMYHU7/brsNDlFXLThrjh///tUJbZJ3zU5vLrwNrnD23PeK/f///vVZjZIHnU4O7qxd3oG3nYaKffYaF6lQgy0RIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 09 16 51 11" title="" data-src="/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-fee1c.png" data-srcset="/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-a67b7.png 200w,\n/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-0b187.png 400w,\n/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-fee1c.png 800w,\n/static/2022-08-09-16-51-11-90d5cb08b12e22656c560628d22a7c47-50b07.png 987w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="硬件相关"><a href="#%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>硬件相关</h3>\n<ul>\n<li>\n<p>着色器语言编写的程序称为着色器程序(shader program)，在 GPU 顶点着色器单元上执行的是顶点着色器程序，在 GPU 片元着色器单元上执行的是片元着色器程序。</p>\n<p>顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8627922285729306000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// attribute 声明 vec4 类型变量 apos\nattribute vec4 apos;\nvoid main() {\n   // 顶点坐标 apos 赋值给内置变量 gl_Position\n   // 逐顶点处理数据\n   gl_Position = apos;\n}`, `8627922285729306000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// attribute 声明 vec4 类型变量 apos</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> apos<span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 顶点坐标 apos 赋值给内置变量 gl_Position</span>\n   <span class="token comment">// 逐顶点处理数据</span>\n   gl_Position <span class="token operator">=</span> apos<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>片元着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24565389974800490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`void main() {\n   // 逐片元处理数据，所有片元(像素)设置为红色\n   gl_FragColor = vec4(1.0,0.0,0.0,1.0);\n}`, `24565389974800490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 逐片元处理数据，所有片元(像素)设置为红色</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>可编程顶点处理器(Programmable Vertex Processor)又称为顶点着色器，用来执行顶点着色器程序</p>\n</li>\n<li>\n<p>可编程片元处理器(Programmable Fragment Processor)又称为片元着色器，用来执行片元着色器程序</p>\n</li>\n<li>\n<p>GPU 中有各种专门的寄存器，比如用来接收顶点坐标数据的寄存器是输入寄存器，从数据类型的角度看属于浮点寄存器，用来临时存储浮点数；存储输出到显示器像素的帧缓存是输出寄存器，从处理速度的角度看是数据缓冲寄存器，GPU 处理数据的速度要比显示器扫描帧缓存中像素数据的速度要快得多</p>\n</li>\n<li>\n<p>显示器像素是显示器可以通过 RGB 值控制的最小单位，一幅图像是由大量像素点累积显示。着色器中的颜色定义会反映在显示器中</p>\n</li>\n<li>\n<p>显示器的分辨率就是显示器长度方向像素点的个数 X 显示器宽度方向像素点的个数</p>\n</li>\n<li>\n<p>屏幕相邻的两个像素单元的距离就是点距，点距越小显示效果越好，一般现在显示器 0.2mm~0.4mm 之间</p>\n</li>\n</ul>\n<h2 id="webgl-坐标系投影"><a href="#webgl-%E5%9D%90%E6%A0%87%E7%B3%BB%E6%8A%95%E5%BD%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 坐标系—投影</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/tf4psj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<ol>\n<li>canvas 画布宽高采用的是像素值定义，以显示器为准，WebGL 中顶点坐标的表示方法采用的是相对坐标，相对于 canvas 而言 WebGL 坐标系统，X 轴水平向右，也就是 canvas 画布的 width 表示的宽度方向，x 等于 -1 表示 canvas 画布的左边界，x 等于 1 表示 canvas 画布的右边界，x 等于 0 对应的是画布宽度方向的中间。</li>\n<li>WebGL 坐标系统，Y 轴竖直向上，也就是 canvas 画布的 height 表示的高度方向，y 等于 -1 表示 canvas 画布的下边界，y 等于 1 表示 canvas 画布的上边界，y 等于 0 对应的是画布高度方向的中间。</li>\n<li>WebGL 坐标系统，Z 轴垂直 canvas 画布朝外，Z 值 -1 和 1 是 Z 方向的极限值，GPU 成像默认的沿着 Z 轴投影，你也可以抽象出一个概念，人眼睛位于 z 轴上，沿着 z 轴方向去观察物体，如果你在其他的书上看到视图坐标系等其它各类坐标系都是抽象出的概念都是建立在本节课所说的 WebGL 坐标系统之上，例如无人机导航中的所说的机体坐标系、地球坐标系都是直接对现实中事物的描述，三维场景中的各类坐标系与无人机中坐标系没什么区别，但是要显示在屏幕上，就要经过一些处理，这里不再详述，后面的教程后为大家引入各类坐标系概念，正射投影和透射投影概念。</li>\n</ol>\n<h2 id="webgl-平移变换"><a href="#webgl-%E5%B9%B3%E7%A7%BB%E5%8F%98%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 平移变换</h2>\n<p>有以下几种方式可以做到沿 X 轴平移 -0.4</p>\n<h3 id="方法一"><a href="#%E6%96%B9%E6%B3%95%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法一</h3>\n<p>提前在顶点中计算</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82939265257110600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = new Float32Array([\n   // 三角形顶点 1 坐标\n   0.0,\n   0.0,\n   1.0,\n\n   // 三角形顶点 2 坐标\n   0.0,\n   1.0,\n   0.0,\n\n   // 三角形顶点 3 坐标\n   1.0,\n   0.0,\n   0.0\n]);\n\n// x 坐标分别减少 0.4\n\nvar data = new Float32Array([\n   // 三角形顶点 1 坐标\n   -0.4,\n   0.0,\n   1.0,\n\n   // 三角形顶点 2 坐标\n   -0.4,\n   1.0,\n   0.0,\n\n   // 三角形顶点 3 坐标\n   0.6,\n   0.0,\n   0.0\n]);`, `82939265257110600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 三角形顶点 1 坐标</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">1.0</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 三角形顶点 2 坐标</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">1.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 三角形顶点 3 坐标</span>\n   <span class="token number">1.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// x 坐标分别减少 0.4</span>\n\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 三角形顶点 1 坐标</span>\n   <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">1.0</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 三角形顶点 2 坐标</span>\n   <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span>\n   <span class="token number">1.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 三角形顶点 3 坐标</span>\n   <span class="token number">0.6</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span><span class="token punctuation">,</span>\n   <span class="token number">0.0</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="方法二"><a href="#%E6%96%B9%E6%B3%95%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法二</h3>\n<p>循环修改数组 <code class="language-text">data=new Float32Array([..</code> 的顶点数据，把顶点坐标平移的数学计算任务交给 CPU</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72845628512936450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var i = 0; i < 9; i += 3) {\n   data[i] += -0.4;\n}`, `72845628512936450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="方法三"><a href="#%E6%96%B9%E6%B3%95%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法三</h3>\n<p>替换掉原来的代码 <code class="language-text">gl_Position = vec4(apos.x, apos.y, apos.z, 1)</code>，把顶点平移的数学运算任务交给了 GPU</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85540116381403530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在顶点着色器中逐顶点沿着 x 轴平移 -0.4\ngl_Position = vec4(apos.x - 0.4, apos.y, apos.z, 1);`, `85540116381403530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 在顶点着色器中逐顶点沿着 x 轴平移 -0.4</span>\ngl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>apos<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">0.4</span><span class="token punctuation">,</span> apos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> apos<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="方法四"><a href="#%E6%96%B9%E6%B3%95%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法四</h3>\n<p>在原来的顶点着色器代码中，声明一个 4 x 4 矩阵 m4，然后通过矩阵和表示顶点坐标的列向量相乘 <code class="language-text">m4 * apos</code>，实现对顶点 apos 的平移变换，和方法三一样把数学计算任务交给 GPU 处理器，具体说是顶点着色器单元（Vertex Processor），顶点着色器单元能够完成矩阵的乘法运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9028792033167376000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// attribute 声明 vec4 类型变量 apos\nattribute vec4 apos;\nvoid main() {\n  // 创建平移矩阵（沿 x 轴平移 -0.4）\n  // 1   0   0  -0.4\n  // 0   1   0    0\n  // 0   0   1    0\n  // 0   0   0    1\n  mat4 m4 = mat4(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, -0.4, 0, 0, 1);\n  // 平移矩阵 m4 左乘顶点坐标（vec4 类型数据可以理解为线性代数中的 nx1 矩阵，即列向量）\n  // 逐顶点进行矩阵变换\n  gl_Position = m4 * apos;\n}`, `9028792033167376000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// attribute 声明 vec4 类型变量 apos</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> apos<span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建平移矩阵（沿 x 轴平移 -0.4）</span>\n  <span class="token comment">// 1   0   0  -0.4</span>\n  <span class="token comment">// 0   1   0    0</span>\n  <span class="token comment">// 0   0   1    0</span>\n  <span class="token comment">// 0   0   0    1</span>\n  <span class="token keyword">mat4</span> m4 <span class="token operator">=</span> <span class="token keyword">mat4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 平移矩阵 m4 左乘顶点坐标（vec4 类型数据可以理解为线性代数中的 nx1 矩阵，即列向量）</span>\n  <span class="token comment">// 逐顶点进行矩阵变换</span>\n  gl_Position <span class="token operator">=</span> m4 <span class="token operator">*</span> apos<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>mat4 关键字和 vec4 关键字一样用来声明 WebGL 着色器变量的数据类型，和 vec4 一样也具有构造数据的功能。</p>\n<p>vec4 是 4 x 1 矩阵，就是列向量，有四个元素，mat4 表示 4 x 4 矩阵，mat4() 函数括号中的 16 个数据，每四个为一组，以列为准，前四个数就是 mat4 矩阵的第一列，后面的按顺序依次排列。</p>\n<h4 id="平移矩阵解析"><a href="#%E5%B9%B3%E7%A7%BB%E7%9F%A9%E9%98%B5%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>平移矩阵解析</h4>\n<p>一个点的坐标是 (x, y, z)，假设沿着 X、Y、Z 轴分别平移 Tx、Ty、Tz，平移后的坐标是 <code class="language-text">(x + Tx, y + Ty, z + Tz)</code>。</p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi><mo>+</mo><mi>T</mi><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi><mo>+</mo><mi>T</mi><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi><mo>+</mo><mi>T</mi><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">   \\begin{bmatrix}\n   1 &amp; 0 &amp; 0 &amp; Tx \\\\\n   0 &amp; 1 &amp; 0 &amp; Ty \\\\\n   0 &amp; 0 &amp; 1 &amp; Tz \\\\\n   0 &amp; 0 &amp; 0 &amp; 1 \\\\\n   \\end{bmatrix}\n\n   \\begin{bmatrix}\n   x \\\\\n   y \\\\\n   z \\\\\n   1 \\\\\n   \\end{bmatrix}\n\n   =\n\n   \\begin{bmatrix}\n   x + Tx \\\\\n   y + Ty \\\\\n   z + Tz \\\\\n   1 \\\\\n   \\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.6520099999999998em;"></span><span class="strut bottom" style="height:4.80204em;vertical-align:-2.15003em;"></span><span class="base"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span></span></span></span></span>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>上面计算式的巧妙之处就是把三维坐标，增加一个元素 1.0，用 4 x 1 矩阵表示，n x 1 矩阵也称为列向量，对应的数据类型就是 vec4</li>\n<li>n 维向量增加一个维度用 n + 1 维向量表示就是齐次坐标。</li>\n<li>上面的 4 x 4 矩阵，就是平移矩阵，平移矩阵左乘顶点的齐次坐标，结果仍然是一个齐次坐标，也就是平移后的坐标。</li>\n<li>矩阵的乘法满足结合律，如果多次平移，可以把所有的平移矩阵先进行乘法运算，然后左乘要平移顶点的齐次坐标。</li>\n</ol>\n<h2 id="webgl-旋转变换"><a href="#webgl-%E6%97%8B%E8%BD%AC%E5%8F%98%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 旋转变换</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5g67mm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="着色器内置函数"><a href="#%E7%9D%80%E8%89%B2%E5%99%A8%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>着色器内置函数</h3>\n<p>WebGL 着色器提供了一系列可以内置函数，也就是说不用声明可以直接调用的函数。</p>\n<p>radians() 函数：角度值转化为弧度制，参数是浮点数 float，比如 30 度时，要写成 30.0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93926472380427120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 旋转角度 30 度转化为弧度值\nfloat radian = radians(30.0);`, `93926472380427120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 旋转角度 30 度转化为弧度值</span>\n<span class="token keyword">float</span> radian <span class="token operator">=</span> <span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">30.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>cos() 是余弦函数，参数要求是弧度值且是浮点数</p>\n<p>sin() 是正弦函数，参数要求是弧度值且是浮点数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51169844960910770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 求解旋转角度余弦值\nfloat cos = cos(radian);\n// 求解旋转角度正弦值\nfloat sin = sin(radian);`, `51169844960910770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 求解旋转角度余弦值</span>\n<span class="token keyword">float</span> cos <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>radian<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 求解旋转角度正弦值</span>\n<span class="token keyword">float</span> sin <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>radian<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="流程简述"><a href="#%E6%B5%81%E7%A8%8B%E7%AE%80%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程简述</h3>\n<p>多次调用了绘制命令 <code class="language-text">gl.drawArrays</code>，data 变量定义的顶点数据初始化时，会存入内存中，执行代码 <code class="language-text">gl.bindBuffer(gl.ARRAY_BUFFER, buffer);</code> 内存中的数据一次性传入显存缓冲区中，传入缓冲区中的顶点数据可以通过 drawArrays 方法多次调用，每次 drawArrays 方法调用，顶点经过渲染管线得到的像素相关数据都会存入帧缓存中，后一次调用，前一次调用生成的像素数据不会清空，最终形成一幅完整的立方体线框图。</p>\n<h3 id="旋转矩阵解析"><a href="#%E6%97%8B%E8%BD%AC%E7%9F%A9%E9%98%B5%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>旋转矩阵解析</h3>\n<p>假设一个点的坐标是 (x, y, z)，经过旋转变换后的坐标为 (X, Y, Z)</p>\n<h4 id="绕-z-轴旋转-γ-角度"><a href="#%E7%BB%95-z-%E8%BD%B4%E6%97%8B%E8%BD%AC-%CE%B3-%E8%A7%92%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绕 Z 轴旋转 γ 角度</h4>\n<p>z 的坐标不变，x、y 的坐标发生变化，在笛卡尔坐标系下通过简单的数学计算就可以知道结果 <code class="language-text">X = xcosγ - ysinγ, Y = xsinγ + ycosγ</code></p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>γ</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>s</mi><mi>i</mi><mi>n</mi><mi>γ</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mi>γ</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>γ</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>γ</mi><mo>−</mo><mi>y</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>γ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>γ</mi><mo>+</mo><mi>y</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>γ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">   \\begin{bmatrix}\n   cosγ &amp; -sinγ &amp; 0 &amp; 0 \\\\\n   sinγ &amp; cosγ &amp; 0 &amp; 0 \\\\\n   0 &amp; 0 &amp; 1 &amp; 0 \\\\\n   0 &amp; 0 &amp; 0 &amp; 1 \\\\\n   \\end{bmatrix}\n\n   \\begin{bmatrix}\n   x \\\\\n   y \\\\\n   z \\\\\n   1 \\\\\n   \\end{bmatrix}\n\n   =\n\n   \\begin{bmatrix}\n   xcosγ - ysinγ \\\\\n   xsinγ + ycosγ \\\\\n   z \\\\\n   1 \\\\\n   \\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.6520099999999998em;"></span><span class="strut bottom" style="height:4.80204em;vertical-align:-2.15003em;"></span><span class="base"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span></span></span></span></span>\n<h4 id="绕-x-轴旋转-α-角度"><a href="#%E7%BB%95-x-%E8%BD%B4%E6%97%8B%E8%BD%AC-%CE%B1-%E8%A7%92%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绕 X 轴旋转 α 角度</h4>\n<p>x 的坐标不变，y、z 的坐标发生变化 <code class="language-text">Y = ycosα - zsinα, Z = ysinα + zcosα</code></p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>α</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>s</mi><mi>i</mi><mi>n</mi><mi>α</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mi>α</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>α</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>α</mi><mo>−</mo><mi>z</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>α</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>α</mi><mo>+</mo><mi>z</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>α</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">   \\begin{bmatrix}\n   1 &amp; 0 &amp; 0 &amp; 0 \\\\\n   0 &amp; cosα &amp; -sinα &amp; 0 \\\\\n   0 &amp; sinα &amp; cosα &amp; 0 \\\\\n   0 &amp; 0 &amp; 0 &amp; 1 \\\\\n   \\end{bmatrix}\n\n   \\begin{bmatrix}\n   x \\\\\n   y \\\\\n   z \\\\\n   1 \\\\\n   \\end{bmatrix}\n\n   =\n\n   \\begin{bmatrix}\n   x \\\\\n   ycosα - zsinα \\\\\n   ysinα + zcosα \\\\\n   1 \\\\\n   \\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.6520099999999998em;"></span><span class="strut bottom" style="height:4.80204em;vertical-align:-2.15003em;"></span><span class="base"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.0037em;">α</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.0037em;">α</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span></span></span></span></span>\n<h4 id="绕-y-轴旋转-β-角度"><a href="#%E7%BB%95-y-%E8%BD%B4%E6%97%8B%E8%BD%AC-%CE%B2-%E8%A7%92%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绕 Y 轴旋转 β 角度</h4>\n<p>y 的坐标不变，x、z 的坐标发生变化 <code class="language-text">X = zsinβ + xcosβ, Z = zcosβ - xsinβ</code></p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>β</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mi>β</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>s</mi><mi>i</mi><mi>n</mi><mi>β</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mi>β</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>β</mi><mo>+</mo><mi>x</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>β</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>z</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>β</mi><mo>−</mo><mi>x</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>β</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">   \\begin{bmatrix}\n   cosβ &amp; 0 &amp; sinβ &amp; 0 \\\\\n   0 &amp; 1 &amp; 0 &amp; 0 \\\\\n   -sinβ &amp; 0 &amp; cosβ &amp; 0 \\\\\n   0 &amp; 0 &amp; 0 &amp; 1 \\\\\n   \\end{bmatrix}\n\n   \\begin{bmatrix}\n   x \\\\\n   y \\\\\n   z \\\\\n   1 \\\\\n   \\end{bmatrix}\n\n   =\n\n   \\begin{bmatrix}\n   zsinβ + xcosβ \\\\\n   y \\\\\n   zcosβ - xsinβ \\\\\n   1 \\\\\n   \\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.6520099999999998em;"></span><span class="strut bottom" style="height:4.80204em;vertical-align:-2.15003em;"></span><span class="base"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">x</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6500000000000004em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">x</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">x</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span><span style="top:-1.2099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1500000000000004em;"></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6520099999999998em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.80499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.40599em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.65201em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"></span></span></span></span></span></span></span></span></span></span>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果几何体经过多次旋转可以把每一次的旋转矩阵，连续进行乘法运算，最后再左乘顶点的齐次坐标</li>\n<li>旋转变换和平移变换同时存在，旋转矩阵和平移矩阵一样都是四阶矩阵，因此同样可以先进行乘法运算得到的仍是四阶矩阵，最后再左乘顶点的齐次坐标，这种情况也就是复合变换</li>\n</ol>\n<h2 id="webgl-顶点索引绘制"><a href="#webgl-%E9%A1%B6%E7%82%B9%E7%B4%A2%E5%BC%95%E7%BB%98%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 顶点索引绘制</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/eep0sn?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>WebGL 为了复用顶点数据新引入了一个新的绘制函数 gl.drawElements()，gl.drawElements() 和 gl.drawArrays() 方法一样都是命令浏览器 WebGL 图形系统开始处理顶点绘制渲染出像素并显示在屏幕 Canvas 画布上。区别是 gl.drawArrays() 方法直接调用顶点数组数据，gl.drawElements() 是通过一个索引数组访问使用顶点数组中的顶点数据。</p>\n<p>可以在上面旋转变换的基础上进行修改</p>\n<h3 id="顶点列举"><a href="#%E9%A1%B6%E7%82%B9%E5%88%97%E4%B8%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点列举</h3>\n<p>只需要把所有的顶点列举一次即可，不用重复枚举。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46494353677717970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 8 个顶点坐标数组\nvar data = new Float32Array([\n   // 顶点 0\n   0.5,\n   0.5,\n   0.5,\n\n   // 顶点 1\n   -0.5,\n   0.5,\n   0.5,\n\n   // 顶点 2\n   -0.5,\n   -0.5,\n   0.5,\n\n   // 顶点 3\n   0.5,\n   -0.5,\n   0.5,\n\n   // 顶点 4\n   0.5,\n   0.5,\n   -0.5,\n\n   // 顶点 5\n   -0.5,\n   0.5,\n   -0.5,\n\n   // 顶点 6\n   -0.5,\n   -0.5,\n   -0.5,\n\n   // 顶点 7\n   0.5,\n   -0.5,\n   -0.5\n]);`, `46494353677717970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 8 个顶点坐标数组</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 顶点 0</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 1</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 2</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 3</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 4</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 5</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 6</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 顶点 7</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="顶点的索引数组"><a href="#%E9%A1%B6%E7%82%B9%E7%9A%84%E7%B4%A2%E5%BC%95%E6%95%B0%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点的索引数组</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-10-17-15-53-30f6de9980c9f647d712659669b00cce-28759.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 500px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.6%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABc0lEQVQY002QzytFQRTHv3PO3B9vHvfdd90fj/fui9JjqRAl2bJRkoXYCf+AhY29/wB5rJTyD8jGiixkYedHUUrJxpJEY66LfOtMn5k5c86cLwCNTBHfF3w+j/sNp6jKgB+iyWJ+l2na3c+hRVtQuoLCYwfcszKcE9twDeojttRrAG150DYEUPIUorJ5wiaSklgK8LN55m+EZshLa7i4Yi1FKY2lDZ7wZigOeqm/Z7hw65pGFrQELwpZMfmeCbVOHDWJKr8/U+b4k3PW0lYvhPZtgcY8EK4BwR0jvRFIdd4bkGhnCTgBn7QBjfII4E8JUSLaC/FPO9yVQ+GjFc5FBOewCp4NQeMenKMq1Ftgq9eSyaiTWSyfdhMPg8XMJRN+KBYyzrzAkHv6V5jcMyXkaizsjbCTRv26qMcdcjlN1EsR6t3FNcOZE7KWFf02X1CyReRnvGlaaW8Amn5HluUnRq1J6LsC7GNCfEDoNt4mWphhjb4ApINErzyiiI0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 10 17 15 53" title="" data-src="/static/2022-08-10-17-15-53-30f6de9980c9f647d712659669b00cce-28759.png" data-srcset="/static/2022-08-10-17-15-53-30f6de9980c9f647d712659669b00cce-6ac48.png 200w,\n/static/2022-08-10-17-15-53-30f6de9980c9f647d712659669b00cce-4b8bf.png 400w,\n/static/2022-08-10-17-15-53-30f6de9980c9f647d712659669b00cce-28759.png 500w" data-sizes="(max-width: 500px) 100vw, 500px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<table>\n<thead>\n<tr>\n<th align="left">索引值</th>\n<th align="left">索引值对应顶点坐标</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">0</td>\n<td align="left">(0.5, 0.5, 0.5)</td>\n</tr>\n<tr>\n<td align="left">1</td>\n<td align="left">(-0.5, 0.5, 0.5)</td>\n</tr>\n<tr>\n<td align="left">2</td>\n<td align="left">(-0.5, -0.5, 0.5)</td>\n</tr>\n<tr>\n<td align="left">3</td>\n<td align="left">(0.5, -0.5, 0.5)</td>\n</tr>\n<tr>\n<td align="left">4</td>\n<td align="left">(0.5, 0.5, -0.5)</td>\n</tr>\n<tr>\n<td align="left">5</td>\n<td align="left">(-0.5, 0.5, -0.5)</td>\n</tr>\n<tr>\n<td align="left">6</td>\n<td align="left">(-0.5, -0.5, -0.5)</td>\n</tr>\n<tr>\n<td align="left">7</td>\n<td align="left">(0.5, -0.5, -0.5)</td>\n</tr>\n</tbody>\n</table>\n<p>下面代码中表示的顶点索引如上图所示。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34712929845959750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点索引数组\nvar indexes = new Uint8Array([\n   // 前四个点对应索引值\n   0,\n   1,\n   2,\n   3, // gl.LINE_LOOP 模式四个点绘制一个矩形框\n\n   // 后四个顶点对应索引值\n   4,\n   5,\n   6,\n   7, // gl.LINE_LOOP 模式四个点绘制一个矩形框\n\n   // 前后对应点对应索引值\n   0,\n   4, // 两个点绘制一条直线\n   1,\n   5, // 两个点绘制一条直线\n   2,\n   6, // 两个点绘制一条直线\n   3,\n   7 // 两个点绘制一条直线\n]);`, `34712929845959750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 顶点索引数组</span>\n<span class="token keyword">var</span> indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 前四个点对应索引值</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">2</span><span class="token punctuation">,</span>\n   <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// gl.LINE_LOOP 模式四个点绘制一个矩形框</span>\n\n   <span class="token comment">// 后四个顶点对应索引值</span>\n   <span class="token number">4</span><span class="token punctuation">,</span>\n   <span class="token number">5</span><span class="token punctuation">,</span>\n   <span class="token number">6</span><span class="token punctuation">,</span>\n   <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// gl.LINE_LOOP 模式四个点绘制一个矩形框</span>\n\n   <span class="token comment">// 前后对应点对应索引值</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 两个点绘制一条直线</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 两个点绘制一条直线</span>\n   <span class="token number">2</span><span class="token punctuation">,</span>\n   <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// 两个点绘制一条直线</span>\n   <span class="token number">3</span><span class="token punctuation">,</span>\n   <span class="token number">7</span> <span class="token comment">// 两个点绘制一条直线</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol>\n<li>\n<p>索引数组的数据传入显存缓冲区，注意与顶点数据传入缓冲区方法参数的对比，传入索引数据时，bindBuffer() 和 bufferData() 方法的第一个参数是 <code class="language-text">gl.ELEMENT_ARRAY_BUFFER</code>，传入顶点数据时是 <code class="language-text">gl.ARRAY_BUFFER</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64958869104023400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建缓冲区对象\nvar indexesBuffer = gl.createBuffer();\n// 绑定缓冲区对象\ngl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexesBuffer);\n// 索引数组 indexes 数据传入缓冲区\ngl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indexes, gl.STATIC_DRAW);`, `64958869104023400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建缓冲区对象</span>\n<span class="token keyword">var</span> indexesBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定缓冲区对象</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexesBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 索引数组 indexes 数据传入缓冲区</span>\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ELEMENT_ARRAY_BUFFER</span><span class="token punctuation">,</span> indexes<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>使用方法 drawElements() 替换 drawArrays() 方法，参数设置基本一致，方法 drawElements() 只是新增了一个数据类型设置参数 <code class="language-text">gl.UNSIGNED_BYTE</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13669748145984340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// LINE_LOOP 模式绘制前四个点\ngl.drawElements(gl.LINE_LOOP, 4, gl.UNSIGNED_BYTE, 0);\n// LINE_LOOP 模式从第五个点开始绘制四个点\ngl.drawElements(gl.LINE_LOOP, 4, gl.UNSIGNED_BYTE, 4);\n// LINES 模式绘制后 8 个点\ngl.drawElements(gl.LINES, 8, gl.UNSIGNED_BYTE, 8);`, `13669748145984340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// LINE_LOOP 模式绘制前四个点</span>\ngl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINE_LOOP</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// LINE_LOOP 模式从第五个点开始绘制四个点</span>\ngl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINE_LOOP</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// LINES 模式绘制后 8 个点</span>\ngl<span class="token punctuation">.</span><span class="token function">drawElements</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h3 id="gldrawelements"><a href="#gldrawelements" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gl.drawElements()</h3>\n<p>参数格式：drawElements(mode, count, type, offset)</p>\n<table>\n<thead>\n<tr>\n<th align="left">参数</th>\n<th align="left">含义</th>\n<th align="left">值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">mode</td>\n<td align="left">绘制模式</td>\n<td align="left">gl.LINE_LOOP、gl.LINES、gl.TRIANGLES 等</td>\n</tr>\n<tr>\n<td align="left">count</td>\n<td align="left">绘制顶点个数</td>\n<td align="left">整型数</td>\n</tr>\n<tr>\n<td align="left">type</td>\n<td align="left">数据类型</td>\n<td align="left"><code class="language-text">gl.UNSIGNED_BYTE</code>\n 对应 Uint8Array，\n<code class="language-text">gl.UNSIGNED_SHORT</code>\n 对应 Uint16Array</td>\n</tr>\n<tr>\n<td align="left">offset</td>\n<td align="left">从第几个点开始绘制</td>\n<td align="left">整型数，以字节为单位</td>\n</tr>\n</tbody>\n</table>\n<p>count 和 offset 组合可以确定绘制众多顶点中的连续一段，通过顶点索引关联顶点数据，count 和 offset 指的是顶点的索引数组。</p>\n<h2 id="varying-变量和颜色插值"><a href="#varying-%E5%8F%98%E9%87%8F%E5%92%8C%E9%A2%9C%E8%89%B2%E6%8F%92%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>varying 变量和颜色插值</h2>\n<p>使用关键字 varying 实现颜色插值计算</p>\n<h3 id="颜色线性插值"><a href="#%E9%A2%9C%E8%89%B2%E7%BA%BF%E6%80%A7%E6%8F%92%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>颜色线性插值</h3>\n<p>顶点着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49967587170604696000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// attribute 声明 vec4 类型变量 apos\nattribute vec4 apos;\n// attribute 声明顶点颜色变量\nattribute vec4 a_color;\n// varying 声明顶点颜色插值后变量，使用 varying 可以插值计算\nvarying vec4 v_color;\nvoid main() {\n  // 顶点坐标 apos 赋值给内置变量 gl_Position\n  gl_Position = apos;\n  // 顶点颜色插值计算\n  v_color = a_color;\n}`, `49967587170604696000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// attribute 声明 vec4 类型变量 apos</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> apos<span class="token punctuation">;</span>\n<span class="token comment">// attribute 声明顶点颜色变量</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_color<span class="token punctuation">;</span>\n<span class="token comment">// varying 声明顶点颜色插值后变量，使用 varying 可以插值计算</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_color<span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 顶点坐标 apos 赋值给内置变量 gl_Position</span>\n  gl_Position <span class="token operator">=</span> apos<span class="token punctuation">;</span>\n  <span class="token comment">// 顶点颜色插值计算</span>\n  v_color <span class="token operator">=</span> a_color<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>片元着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79334051238871060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 所有 float 类型数据的精度是 lowp\n// lowp 是精度限定字表示低精度，计算机资源有限，设置数据精度是为了提高执行效率\n// 除了片元着色器中的浮点类型 float 数据，其它所有类型数据浏览器都有默认的精度，因此要设定片元着色器中浮点类型 float 数据精度，否则会报错\nprecision lowp float;\n// 接收顶点着色器中 v_color 数据\nvarying vec4 v_color;\nvoid main() {\n  // 插值后颜色数据赋值给对应的片元\n  gl_FragColor = v_color;\n}`, `79334051238871060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 所有 float 类型数据的精度是 lowp</span>\n<span class="token comment">// lowp 是精度限定字表示低精度，计算机资源有限，设置数据精度是为了提高执行效率</span>\n<span class="token comment">// 除了片元着色器中的浮点类型 float 数据，其它所有类型数据浏览器都有默认的精度，因此要设定片元着色器中浮点类型 float 数据精度，否则会报错</span>\n<span class="token keyword">precision</span> <span class="token keyword">lowp</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n<span class="token comment">// 接收顶点着色器中 v_color 数据</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_color<span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 插值后颜色数据赋值给对应的片元</span>\n  gl_FragColor <span class="token operator">=</span> v_color<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/do2n1z?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="获取顶点变量"><a href="#%E8%8E%B7%E5%8F%96%E9%A1%B6%E7%82%B9%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取顶点变量</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99520262682446090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 获取顶点着色器的位置变量 apos\nvar aposLocation = gl.getAttribLocation(program, \'apos\');\nvar a_color = gl.getAttribLocation(program, \'a_color\');`, `99520262682446090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 获取顶点着色器的位置变量 apos</span>\n<span class="token keyword">var</span> aposLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'apos\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> a_color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="设置顶点颜色、位置数据"><a href="#%E8%AE%BE%E7%BD%AE%E9%A1%B6%E7%82%B9%E9%A2%9C%E8%89%B2%E3%80%81%E4%BD%8D%E7%BD%AE%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置顶点颜色、位置数据</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83619062824893640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n  创建顶点位置数据数组 data，存储两个顶点 (-0.5, 0.5)、(0.5, 0.5)\n  创建顶点颜色数组 colorData，存储两个顶点对应 RGB 颜色值 (0, 0, 1)、(1, 0, 0)\n **/\nvar data = new Float32Array([-0.5, 0.5, 0.5, 0.5]);\nvar colorData = new Float32Array([0, 0, 1, 1, 0, 0]);`, `83619062824893640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n  创建顶点位置数据数组 data，存储两个顶点 (-0.5, 0.5)、(0.5, 0.5)\n  创建顶点颜色数组 colorData，存储两个顶点对应 RGB 颜色值 (0, 0, 1)、(1, 0, 0)\n **/</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建顶点缓冲区、传递数据"><a href="#%E5%88%9B%E5%BB%BA%E9%A1%B6%E7%82%B9%E7%BC%93%E5%86%B2%E5%8C%BA%E3%80%81%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建顶点缓冲区、传递数据</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84049964236205340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n  创建缓冲区 buffer，传入顶点位置数据 data\n **/\nvar buffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, buffer);\ngl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);\ngl.vertexAttribPointer(aposLocation, 2, gl.FLOAT, false, 0, 0);\ngl.enableVertexAttribArray(aposLocation);\n\n/**\n  创建缓冲区 colorBuffer，传入顶点颜色数据 colorData\n **/\nvar colorBuffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\ngl.bufferData(gl.ARRAY_BUFFER, colorData, gl.STATIC_DRAW);\ngl.vertexAttribPointer(a_color, 3, gl.FLOAT, false, 0, 0);\ngl.enableVertexAttribArray(a_color);`, `84049964236205340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n  创建缓冲区 buffer，传入顶点位置数据 data\n **/</span>\n<span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aposLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aposLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n  创建缓冲区 colorBuffer，传入顶点颜色数据 colorData\n **/</span>\n<span class="token keyword">var</span> colorBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colorBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> colorData<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_color<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_color<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建一个彩色三角形"><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%BD%A9%E8%89%B2%E4%B8%89%E8%A7%92%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建一个彩色三角形</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68480551963926020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n  创建顶点位置数据数组 data，存储 3 个顶点 (-0.5, 0.5)、(0.5, 0.5)、(0.5, -0.5)\n  创建顶点颜色数组 colorData，存储 3 个顶点对应 RGB 颜色值 (1, 0, 0)、(0, 1, 0)、(0, 0, 1)\n**/\nvar data = new Float32Array([-0.5, 0.5, 0.5, 0.5, 0.5, -0.5]);\nvar colorData = new Float32Array([1, 0, 0, 0, 1, 0, 0, 0, 1]);\n\n/** 执行绘制命令 **/\ngl.drawArrays(gl.TRIANGLES, 0, 3);`, `68480551963926020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n  创建顶点位置数据数组 data，存储 3 个顶点 (-0.5, 0.5)、(0.5, 0.5)、(0.5, -0.5)\n  创建顶点颜色数组 colorData，存储 3 个顶点对应 RGB 颜色值 (1, 0, 0)、(0, 1, 0)、(0, 0, 1)\n**/</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 执行绘制命令 **/</span>\ngl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x1ef94?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="两个单色三角面（不同颜色）"><a href="#%E4%B8%A4%E4%B8%AA%E5%8D%95%E8%89%B2%E4%B8%89%E8%A7%92%E9%9D%A2%EF%BC%88%E4%B8%8D%E5%90%8C%E9%A2%9C%E8%89%B2%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>两个单色三角面（不同颜色）</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86785341408355120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n  创建顶点位置数据数组 data，存储 6 个顶点\n  创建顶点颜色数组 colorData，存储 6 个顶点对应 RGB 颜色值\n **/\nvar data = new Float32Array([\n   // 第一个三角形的三个点\n   -0.5,\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n\n   // 第二个三角形的三个点\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5\n]);\n\nvar colorData = new Float32Array([\n   // 三个红色点\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n\n   // 三个蓝色点\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1\n]);`, `86785341408355120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n  创建顶点位置数据数组 data，存储 6 个顶点\n  创建顶点颜色数组 colorData，存储 6 个顶点对应 RGB 颜色值\n **/</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 第一个三角形的三个点</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 第二个三角形的三个点</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token comment">// 三个红色点</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n\n   <span class="token comment">// 三个蓝色点</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xnbwdw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="颜色插值（顶点位置、颜色使用一个缓冲区存储）"><a href="#%E9%A2%9C%E8%89%B2%E6%8F%92%E5%80%BC%EF%BC%88%E9%A1%B6%E7%82%B9%E4%BD%8D%E7%BD%AE%E3%80%81%E9%A2%9C%E8%89%B2%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%AD%98%E5%82%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>颜色插值（顶点位置、颜色使用一个缓冲区存储）</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15988338291977300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n 创建顶点位置数据数组 data，存储两个顶点 (-0.5, 0.5)、(0.5, 0.5)\n 存储两个顶点对应 RGB 颜色值 (0, 0, 1)、(1, 0, 0)\n **/\nvar data = new Float32Array([-0.5, 0.5, 0, 0, 1, 0.5, 0.5, 1, 0, 0]);\n/**\n 创建缓冲区 buffer，传入顶点颜色、位置数据 data\n **/\nvar buffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, buffer);\ngl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);\n// 4 表示 data 数组一个元素占据的字节数\n// 倒数第二个参数 4 * 5 表示每 5 个元素是一个选择单元\n// 第 2 个参数 2 表示从 5 元素组成的一个选择单元中选择前 2 个作为顶点位置数据\ngl.vertexAttribPointer(aposLocation, 2, gl.FLOAT, false, 4 * 5, 0);\n// 最后一个参数 4 * 2 表示 5 元素组成的一个选择单元中偏移 2 个元素\n// 第 2 个参数 3 表示从 5 元素组成的一个选择单元中选择后三个作为顶点颜色数据\ngl.vertexAttribPointer(a_color, 3, gl.FLOAT, false, 4 * 5, 4 * 2);\ngl.enableVertexAttribArray(aposLocation);\ngl.enableVertexAttribArray(a_color);`, `15988338291977300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n 创建顶点位置数据数组 data，存储两个顶点 (-0.5, 0.5)、(0.5, 0.5)\n 存储两个顶点对应 RGB 颜色值 (0, 0, 1)、(1, 0, 0)\n **/</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">/**\n 创建缓冲区 buffer，传入顶点颜色、位置数据 data\n **/</span>\n<span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 4 表示 data 数组一个元素占据的字节数</span>\n<span class="token comment">// 倒数第二个参数 4 * 5 表示每 5 个元素是一个选择单元</span>\n<span class="token comment">// 第 2 个参数 2 表示从 5 元素组成的一个选择单元中选择前 2 个作为顶点位置数据</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aposLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 最后一个参数 4 * 2 表示 5 元素组成的一个选择单元中偏移 2 个元素</span>\n<span class="token comment">// 第 2 个参数 3 表示从 5 元素组成的一个选择单元中选择后三个作为顶点颜色数据</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>a_color<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aposLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>a_color<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/gtg0fg?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="立方体-每个面一种颜色"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93-%E6%AF%8F%E4%B8%AA%E9%9D%A2%E4%B8%80%E7%A7%8D%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体-每个面一种颜色</h2>\n<p>思路很简单，在线框模式的立方体源码基础上直接进行更改，添加 varying 变量，引入顶点数据颜色，立方体 6 个面，每个面可以分为两个三角面绘制出来，也就是说每个面需要定义 6 个点，6 个点需要定义 36 个顶点。</p>\n<h3 id="着色器程序"><a href="#%E7%9D%80%E8%89%B2%E5%99%A8%E7%A8%8B%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>着色器程序</h3>\n<p>着色器程序参考颜色插值 varying 的使用方法添加即可，就不再列出。</p>\n<h3 id="顶点数据"><a href="#%E9%A1%B6%E7%82%B9%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点数据</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40436951687939750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n 创建顶点位置数据数组 data，js 中小数点前面的 0 可以省略\n **/\nvar data = new Float32Array([\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   0.5, // 面1\n\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5, // 面 2\n\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   0.5,\n   0.5,\n   0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5, // 面 3\n\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5, // 面 4\n\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   0.5, // 面 5\n\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   -0.5,\n   -0.5,\n   0.5,\n   -0.5,\n   0.5,\n   0.5,\n   -0.5 // 面 6\n]);\n\n/**\n 创建顶点颜色数组colorData\n **/\nvar colorData = new Float32Array([\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 1\n\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0, // 绿色——面 2\n\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1, // 蓝色——面 3\n\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0, // 黄色——面 4\n\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0, // 黑色——面 5\n\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1,\n   1 // 白色——面 6\n]);`, `40436951687939750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n 创建顶点位置数据数组 data，js 中小数点前面的 0 可以省略\n **/</span>\n<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// 面1</span>\n\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// 面 2</span>\n\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// 面 3</span>\n\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// 面 4</span>\n\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token comment">// 面 5</span>\n\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token number">0.5</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.5</span> <span class="token comment">// 面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n 创建顶点颜色数组colorData\n **/</span>\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 1</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 绿色——面 2</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 蓝色——面 3</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 黄色——面 4</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 黑色——面 5</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span> <span class="token comment">// 白色——面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="深度测试"><a href="#%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深度测试</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49286732217503390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 执行绘制之前，一定要开启深度测试，以免颜色混乱 **/\ngl.enable(gl.DEPTH_TEST);`, `49286732217503390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 执行绘制之前，一定要开启深度测试，以免颜色混乱 **/</span>\ngl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/wt39uk?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="测试"><a href="#%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h3>\n<p>可以把所有的颜色都改为红色，发现没有立体的视觉效果，白、蓝、绿处于其他三个面的前面，是可见面。可以把三个面设置为红色 R 分别为 1、0.9、0.8 来测试效果。你可以发现 R 值差异了 0.1，你会有很强的立体感，其实你可以继续使用更小的差值，来测试你的眼睛视觉变化。这其实相当于手动编写颜色值，模拟自然界光场，如果有兴趣可以学习下一节课程，如何模拟真实自然界的太阳光、灯光等各种类型光线在物体表面反射光场的分布，不仅不同的面会出现 R 值不同，一个面上的 R 值也会不同，呈现某种规律的变化，比如金属在阳光下会有局部高光现象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68633072542204270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n 创建顶点颜色数组 colorData\n **/\nvar colorData = new Float32Array([\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 1\n\n   0.9,\n   0,\n   0,\n   0.9,\n   0,\n   0,\n   0.9,\n   0,\n   0,\n   0.9,\n   0,\n   0,\n   0.9,\n   0,\n   0,\n   0.9,\n   0,\n   0, // R = 0.9——面 2\n\n   0.8,\n   0,\n   0,\n   0.8,\n   0,\n   0,\n   0.8,\n   0,\n   0,\n   0.8,\n   0,\n   0,\n   0.8,\n   0,\n   0,\n   0.8,\n   0,\n   0, // R = 0.8——面 3\n\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0,\n   1,\n   1,\n   0, // 黄色——面 4\n\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0,\n   0, // 黑色——面 5\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0 // R = 1——面 6\n]);`, `68633072542204270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n 创建顶点颜色数组 colorData\n **/</span>\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 1</span>\n\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.9</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// R = 0.9——面 2</span>\n\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0.8</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// R = 0.8——面 3</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 黄色——面 4</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 黑色——面 5</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span> <span class="token comment">// R = 1——面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kmys42?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="webgl-光照渲染立方体"><a href="#webgl-%E5%85%89%E7%85%A7%E6%B8%B2%E6%9F%93%E7%AB%8B%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 光照渲染立方体</h2>\n<h3 id="光照模型"><a href="#%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>光照模型</h3>\n<h4 id="漫反射"><a href="#%E6%BC%AB%E5%8F%8D%E5%B0%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>漫反射</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-16-11-20-33-0d0cb0596ec226b70f581a065aac1328-49396.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 526px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.59315589353612%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABAklEQVQoz22R3W6DMAyFef93602n7WLTelPUrVMLQyH/IWe2ISXQRcQRzqdj57jBsjKHaZq3JDJ9kqVURojAhk1pw5bVtO0Fxug5H6OAWZgsXBE1JkJrS9dxZf8TPJ3OBJq1K65cQUWw73scDkc5JR+CCOaKEUEOXMwHD6PUU4e1KNeKcUkyt7DFHt4NB0/F3j8+8fpyfAjkXYfzmeEcMCgNN6rV04ppys/vYDF03eYZNVgEucv7eYBuO/hvjcmnDdMUMATajo1en4GdP2JPZ6GvHvZm4W4G7osGmnYePiY5JqSQnp49UdeBhhDJbNdr2NHh5+0OdRlhqYBXFpGmn+j+D46Tdfyug7P4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 16 11 20 33" title="" data-src="/static/2022-08-16-11-20-33-0d0cb0596ec226b70f581a065aac1328-49396.png" data-srcset="/static/2022-08-16-11-20-33-0d0cb0596ec226b70f581a065aac1328-68c83.png 200w,\n/static/2022-08-16-11-20-33-0d0cb0596ec226b70f581a065aac1328-d339c.png 400w,\n/static/2022-08-16-11-20-33-0d0cb0596ec226b70f581a065aac1328-49396.png 526w" data-sizes="(max-width: 526px) 100vw, 526px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>平行光漫反射简单数学模型：漫反射光的颜色 = 几何体表面基色 x 光线颜色 x 光线入射角余弦值</p>\n<p>几何体表面基色简单的说就是不考虑光照物体自身的颜色。</p>\n<h4 id="漫反射模型：光线入射角余弦值"><a href="#%E6%BC%AB%E5%8F%8D%E5%B0%84%E6%A8%A1%E5%9E%8B%EF%BC%9A%E5%85%89%E7%BA%BF%E5%85%A5%E5%B0%84%E8%A7%92%E4%BD%99%E5%BC%A6%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>漫反射模型：光线入射角余弦值</h4>\n<p>这个数学模型没有考虑镜面反射描述的就是理想的漫反射体，并不能完整的描述物体表面的光场，既然是数学模型，自然就是可以修正的，比如添加一个系数，更改指数等等，这里不再详述。比如普通的桌子桌面它的粗糙度是微米 um 级，相比人的脸它是平的，光的波长是纳米 nm 级，这时候桌子表面相比光线是凹凸不平的，宏观来看一束光线照射到物体的表面，对于理想的漫反射而言，因为表面无规则随机分布凹凸不平的反射面，光线的反射是不定向的，换句话说任何角度的反射光都是一样的，这也就是说物体反射到眼睛中的光与人的观察位置无关，反射效果展示如上图所示。</p>\n<p>关于漫反射光照数学模型中物体的漫反射光强度与光线的入射角有关如何解释，这个其实很简单，比如两块纸板面积相同，如下图所示，两个边长为 L 的方形板，一个垂直太阳光线放置，一个不垂直太阳光线也就是入射角不是 90 度，同样强度的光照条件下，垂直太阳光的纸板的光通量肯定比斜着放的纸板接收的光量大，这时候就有必要给数学模型引入一个入射角的因数。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-16-11-26-01-929cb5e8a1b650748b372295c25f96b9-f4a80.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 631px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.914421553090335%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABEUlEQVQY032P626DMAyFef/3WIXjZM8xTR2Xksu4tP1b7Vo6oJAAnQPd30mfrCPnnNgOhGkJbjphOpSN8II6DXWwcEI2XDerR+jubqaOanhhA6ZHUCNVItxZRlpZj3YsnyBzIJ3XhFrFCNKyzGExU9jB30OYDXefcejDI2TWW/WCWgV9N7DMYjEF5AOzTDZjmPaY9SxtMarDqF4m/xsGmkmBpMPoQhmW1LA7g243+sqKiTbyBrNwX4rO9NdhOQciOWF8wvRNqJqrC1Ydr3pRXh+PdHwPT+9s+4UvxDePa4zPpNn2E54/UHYBFANUIx5uuJ+xmjjV/UTwwy3Mh41sWG4hH0D1SNuWDl576jzIH8jtL1pVWZwtCc86AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 16 11 26 01" title="" data-src="/static/2022-08-16-11-26-01-929cb5e8a1b650748b372295c25f96b9-f4a80.png" data-srcset="/static/2022-08-16-11-26-01-929cb5e8a1b650748b372295c25f96b9-0de09.png 200w,\n/static/2022-08-16-11-26-01-929cb5e8a1b650748b372295c25f96b9-e7891.png 400w,\n/static/2022-08-16-11-26-01-929cb5e8a1b650748b372295c25f96b9-f4a80.png 631w" data-sizes="(max-width: 631px) 100vw, 631px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="rgb-分量表示颜色"><a href="#rgb-%E5%88%86%E9%87%8F%E8%A1%A8%E7%A4%BA%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RGB 分量表示颜色</h4>\n<p>光的颜色可以使用多种模型来表示，把上面的文字公式使用 RGB 具体参数来表示形式如下，比如物体表面的颜色是纯红色 (1, 0, 0)，入射光是纯白色 (1, 1, 1)，光线入射角是 60 度，余弦值就是 0.5，代入下面公式，可以得出结果是 (0.5, 0, 0), 结果仍然是红色，这是符合实际生活的，白色太阳光照在常见的红色物体上，反射的颜色是红色，只是太阳光线照射在物体表面的角度不同，反射的光强度不同。入射光垂直物体表面，也就是入射角是 0 对应的余弦值是 1，光线垂直表面受光量最大，反射光自然最大，和 1 对应；入射光线平行物体表面，此时的入射角是 90 度，物体表面自然没什么光可以反射。</p>\n<p>漫反射数学模型 RGB 分量表示：<code class="language-text">(R2, G2, B2) = (R1, G1, B1) x (R0, G0, B0) x cosθ</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22631055770737852000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`R2 = R1 * R0 * cosθ\nG2 = G1 * G0 * cosθ\nB2 = B1 * B0 * cosθ`, `22631055770737852000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">R2 = R1 * R0 * cosθ\nG2 = G1 * G0 * cosθ\nB2 = B1 * B0 * cosθ</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>WebGL 着色器语言表示</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50475675290627600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 角度值转化为弧度值\nfloat radian = radians(60.0);\n// reflectedLight 的结果是 (0.5, 0, 0)\nvec3 reflectedLight = vec3(1.0, 0.0, 0.0) * vec3(1.0, 1.0, 1.0) * cos(radian)`, `50475675290627600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 角度值转化为弧度值</span>\n<span class="token keyword">float</span> radian <span class="token operator">=</span> <span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// reflectedLight 的结果是 (0.5, 0, 0)</span>\n<span class="token keyword">vec3</span> reflectedLight <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>radian<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="镜面反射"><a href="#%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜面反射</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-16-11-30-26-1f80772aafc2c1aa2fef187e5a9b4ad6-7027d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 300px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACOklEQVQ4y31SS2sTURg99zGZV17VWOOkRYoVglJciAUXgqAoxYVFFBdVEFzUhQgqbn2AIo1NFBQRf4AbUXei+FrYjRatzQN8FGzS6sYWQVwZzHXmziuJST/45nz3ztwz5zvfBWQ0DEbrxKmuHR7Hl4kkFm+oEO5LB7mdilfLoLPExVKAup1cLtKJBZ7pqZpOfXH0LH7cBKqTeldCWqQuSTEgY6xEDPiKvGMEbbE0pnQkZL6qckBssBKlwcFv15W++Unj0Nvzg7sWCup2O/fXClocoULW8AgbfsthqxE71eY9zOUS+vIt9D07N5y5d2Kk/+dtWOUraxWf8BdMXqcu4aUjMfCXa+S+rYrYJNIqPusJrOb1tkZFQCSOhQr9lpvDGQTzBhGoc6KW1zB9YYAI+9TwwBTrjX2Xfx3CFGAJdlk9pQkQBSJLUg9SnD8apLQMZg9HbxlOkTS5hGaHhKKaX3vMRGUbT1b2pfFpb3ZiaBNepA8oTzO7lSfWHvZOjZPF0M8WhSGpAI8suR/RPxngo7auf3nzzlTZEqfB+PPU+uT9RBYfkgafjmjSxxnF87MjYYgEf+OO0g0b69aO3jPpV0CE56KrU491C78hfWNvDE8hRZfwST/LZ4TMO17GR+w8aOqr7DpKxxBXhMokUQXt3nVumyAvV1FcZSAzMbEFRIARCM7UAolJdQ8p/pvuyirfu0CEchR3TPsycdQ0I7gygq3UamsQ5CTexVaJo3gdO34yk3BmJsnmuqv7BwI7pk0ulneLAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 16 11 30 26" title="" data-src="/static/2022-08-16-11-30-26-1f80772aafc2c1aa2fef187e5a9b4ad6-7027d.png" data-srcset="/static/2022-08-16-11-30-26-1f80772aafc2c1aa2fef187e5a9b4ad6-55fa9.png 200w,\n/static/2022-08-16-11-30-26-1f80772aafc2c1aa2fef187e5a9b4ad6-7027d.png 300w" data-sizes="(max-width: 300px) 100vw, 300px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上面的漫反射数学模型没有考虑镜面反射，描述的就是理想的漫反射体，并不能完整的描述物体表面的光场。漫反射是因为几何体表面粗糙度尺寸相对光波长尺寸而言是凹凸不平的，这种凹凸不平又是随机的，所以说漫反射的光线各个方向是均匀的。镜面反射也就是说光照在物体上的反射光线具有方向性，具体点说就是光线的反射角等于入射角。生活中的镜子它的表面粗糙度很小，和光的波长是一个数量级，当光线照在上面的时候，反射光线就会表现出方向性。</p>\n<p>实际的生活中所有的物体没有绝对的漫反射或者镜面反射，往往都是同时存在，只是表现的倾向性不同，镜子的镜面反射更明显，粗糙的树皮漫反射更明显。光照射到物体上一部分会被吸收，透明的话一部分会被折射，除去吸收和折射的光剩余的会被反射，反射的时候根据表面的粗糙度不同，镜面反射和漫反射分配的比例不同可以使用两个系数 k1、k2 去描述。</p>\n<p>在室外停放着一辆车，你观察车的时候，你会发现车的外表面会在某个局部出现高光，这很好理解，车的外壳是曲面的，曲面上如果某个区域的的光线反射角刚好是你的视线方向，自然会呈现出局部高亮的现象，其他的部位是漫反射为主。镜面反射的公式仍然可以写成上面的形式，只是角度不再是光线入射角度而是眼睛视线与反射光线的夹角，n 角度余弦值的指数，实际编程的时候你可以自由定义，没有绝对完美的模型，都可以进行修正。</p>\n<p>镜面反射光的颜色 = 几何体表面基色 x 光线颜色 x 视线与反射光线的夹角余弦值<sup>n</sup></p>\n<h4 id="环境光照"><a href="#%E7%8E%AF%E5%A2%83%E5%85%89%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境光照</h4>\n<p>在暗的环境下，物体比较暗，光亮的环境下，物体比较光亮，描述这个现象可以使用环境光照模型。光线在自然环境中会在不同的物体之间来回反射，单束的光线具有方向性，所有方向的光线随机分布，形成一个没有特殊的光线方向的的环境光照。多数情况下室内室外环境光颜色通常都是 RGB 相同的白色到黑色之间的值，(1, 1, 1) 表示最强的环境光照颜色，(0, 0, 0) 相当于处于完全的没有光照的黑色环境中。</p>\n<p>环境反射光颜色 = 几何体表面基色 x 环境光颜色</p>\n<h4 id="复合光照"><a href="#%E5%A4%8D%E5%90%88%E5%85%89%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>复合光照</h4>\n<p>使用光照渲染模型的时候往往会使用多种光照模型，然后把每个光照模型颜色相乘的结果 RGB 分别相加，这时候要注意，多种模型的光照颜色相加后 RGB 的值要保证在区间 [0, 1]，因为 WebGL 的 RGB 颜色模型默认 RGB 分量的最大值是 1，注意分配比例即可。</p>\n<p>总反射光线 = 漫反射光线 + 镜面反射光线 + 环境反射光线</p>\n<h4 id="法向量"><a href="#%E6%B3%95%E5%90%91%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>法向量</h4>\n<p>有基本的数学知识应该都有法线的概念，垂直与面的直线就是面的法线，对于平面而言面上所有位置的法线方向是相同的，对于曲面而言不同的位置法线的方向是变化的。在三维笛卡尔坐标系中，可以使用向量 (x, y, z) 来表示法向量，根据几何体表面的法向量和光线的方向，就可以求解出光线入射角的余弦值，法向量的点积计算满足下面的公式，为了方便计算，着色器语言内置了一个方法 dot() 用来求解两个向量之间的余弦值，已知向量 a1(x1, y1, z1)、a2(x2, y2, z2) 执行 dot(a1, a2) 可以求出两个向量 a1、a2 的余弦值。</p>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>a</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>b</mi><mo>⃗</mo></mover><mo>=</mo><mi mathvariant="normal">∣</mi><mover accent="true"><mi>a</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mover accent="true"><mi>b</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow><annotation encoding="application/x-tex">\\vec a \\cdot \\vec b = \\vert \\vec a \\vert \\vert \\vec b \\vert cosθ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9774399999999999em;"></span><span class="strut bottom" style="height:1.2274399999999999em;vertical-align:-0.25em;"></span><span class="base"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">a</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">b</span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">a</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">b</span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span></span>\n<span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>a</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>b</mi><mo>⃗</mo></mover><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>y</mi><mn>1</mn></msub><msub><mi>y</mi><mn>2</mn></msub><mo>+</mo><msub><mi>z</mi><mn>1</mn></msub><msub><mi>z</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\\vec a \\cdot \\vec b = x_1x_2 + y_1y_2 + z_1z_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9774399999999999em;"></span><span class="strut bottom" style="height:1.1718799999999998em;vertical-align:-0.19444em;"></span><span class="base"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">a</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathit">b</span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width=\'0.471em\' height=\'0.714em\' style=\'width:0.471em\' viewBox=\'0 0 471 714\' preserveAspectRatio=\'xMinYMin\'><path d=\'M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z\'/></svg></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span></span>\n<h3 id="立方体添加平行光"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93%E6%B7%BB%E5%8A%A0%E5%B9%B3%E8%A1%8C%E5%85%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体添加平行光</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ffujml?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>该 WebGL 案例源码是通过给一个单色的立方体添加平行光进行渲染，通过这样一个简单的 WebGL 光照计算案例，来体会光照模型在物体渲染中的应用，在学习下面的代码之前确保你有逐顶点和颜色插值计算的概念，了解顶点位置数据、顶点颜色数据，本节课在这两种顶点数据的基础之上在引入一种新的顶点数据：定点法向量。</p>\n<p>平行光照射在立方体上，与不同的平面夹角不同，自然反射的颜色 RGB 值强弱不同，实际绘图的时候你不可能手动计算去定义每一个像素的值，前面课程中讲解颜色插值计算的知识，应该对你有一定的启发，你只需要计算出每一个顶点在光照下的颜色，然后利用插值计算就可以得到三个顶点之间区域的像素值，这时候顶点法向量数据就派上了用场，每一个顶点都有位置数据、颜色数据、法向量数据，法向量和颜色数据先进行计算得出新的顶点颜色数据，然后渲染管线对顶点进行装配光栅化的过程中，新的顶点颜色数据进行插值计算。这时候提示一下大家，不要去从宏观思考法向量问题，要从逐顶点、插值计算的角度理解问题，下面的问题可能大家会有一个疑问，为什么立方体的一个顶点会有三个方向，从实际的物体来看，立方体的一个顶点就是一个顶点，但是从绘图的角度来看，每一次是通过三个顶点绘制一个三角形面，只不过恰好三个三角形面共顶点，会有顶点位置重复而已，但是每一组的三个顶点是一个装配光栅化和插值计算的独立单元，两组的三个顶点位置有重复也不会影响他们各自的渲染得到的像素结果。</p>\n<h4 id="顶点着色器：声明变量"><a href="#%E9%A1%B6%E7%82%B9%E7%9D%80%E8%89%B2%E5%99%A8%EF%BC%9A%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点着色器：声明变量</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96221009962546150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 apos; // attribute 声明 vec4 类型变量 apos\nattribute vec4 a_color; // attribute 声明顶点颜色变量\nattribute vec4 a_normal; // 顶点法向量变量\nuniform vec3 u_lightColor; // uniform 声明平行光颜色变量\nuniform vec3 u_lightPosition; // uniform 声明平行光颜色变量\nvarying vec4 v_color; // varying 声明顶点颜色插值后变量`, `96221009962546150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> apos<span class="token punctuation">;</span> <span class="token comment">// attribute 声明 vec4 类型变量 apos</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_color<span class="token punctuation">;</span> <span class="token comment">// attribute 声明顶点颜色变量</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_normal<span class="token punctuation">;</span> <span class="token comment">// 顶点法向量变量</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightColor<span class="token punctuation">;</span> <span class="token comment">// uniform 声明平行光颜色变量</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightPosition<span class="token punctuation">;</span> <span class="token comment">// uniform 声明平行光颜色变量</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_color<span class="token punctuation">;</span> <span class="token comment">// varying 声明顶点颜色插值后变量</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看上面的代码大家可以发现一个新的关键字 uniform，uniform 关键字和 attribute 关键字的都是为了 js 可以向 WebGL 着色器传递数据而出现。区别在于如果一个变量表示顶点相关的数据并且需要从 js 代码中获取顶点数据，需要使用 attribute 关键字声明该变量，比如上面代码 attribute 关键字声明的顶点位置变量 apos、顶点颜色变量 <code class="language-text">a_color</code>、顶点法向量变量 <code class="language-text">a_normal</code>。如果一个变量是非顶点相关的数据并且需要 js 传递该变量相关的数据，需要使用 uniform 关键字声明该变量，比如上面代码通过 uniform 关键字声明的光源位置变量 <code class="language-text">u_lightPosition</code>、光源颜色变量 <code class="language-text">u_lightColor</code>。更多关于 uniform 关键字和 attribute 关键字的内容可以查看第二章着色器介绍三种变量类型 attribute、uniform、varying</p>\n<p>在上面代码中涉及 WebGL 着色器三维向量 vec3 和四维向量 vec4 两种数据类型，比如光线的方向需要 xyz 三个分量描述，可以使用关键字 vec3 声明，比如顶点位置的齐次坐标 (x, y, z, w)，包含透明度的 RGB 颜色模型 RGBA(r, g, b, a) 都需要四个分量描述，可以使用关键字 vec4 声明。</p>\n<p><code class="language-text">attribute vec4 a_normal;</code> 中变量 <code class="language-text">a_normal</code> 定义的是 vec4 类型，第四个参数默认是 1.0 主要是为了凑成齐次坐标用于矩阵计算，表示法向量方向的是前三个参数，所以执行 <code class="language-text">a_normal.xyz</code> 就相当于访问法向量的 xyz 值，返回的结果是一个 vec3 数据，如果执行 vec3.xy 相当于返回一个 vec2 数据，如果一个顶点的 <code class="language-text">a_normal</code> 数据是 (1.0, 1.0, 1.0, 1.0)，那么它的模长就不是 1，而是 3 的平方根，这时候需要把前三个 1 全部除以 3 的平方根才可以把非单位向量转化为单位向量。</p>\n<h4 id="顶点着色器：光照计算"><a href="#%E9%A1%B6%E7%82%B9%E7%9D%80%E8%89%B2%E5%99%A8%EF%BC%9A%E5%85%89%E7%85%A7%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点着色器：光照计算</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66033652071791620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点法向量进行矩阵变换，然后归一化\nvec3 normal = normalize((mx * my * a_normal).xyz);\n// 计算点光源照射顶点的方向并归一化\nvec3 lightDirection = normalize(vec3(gl_Position) - u_lightPosition);\n// 计算平行光方向向量和顶点法向量的点积\nfloat dot = max(dot(lightDirection, normal), 0.0);\n// 计算反射后的颜色\nvec3 reflectedLight = u_lightColor * a_color.rgb * dot;\n// 颜色插值计算\nv_color = vec4(reflectedLight, a_color.a);`, `66033652071791620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 顶点法向量进行矩阵变换，然后归一化</span>\n<span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mx <span class="token operator">*</span> my <span class="token operator">*</span> a_normal<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算点光源照射顶点的方向并归一化</span>\n<span class="token keyword">vec3</span> lightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> u_lightPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算平行光方向向量和顶点法向量的点积</span>\n<span class="token keyword">float</span> dot <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>lightDirection<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算反射后的颜色</span>\n<span class="token keyword">vec3</span> reflectedLight <span class="token operator">=</span> u_lightColor <span class="token operator">*</span> a_color<span class="token punctuation">.</span>rgb <span class="token operator">*</span> dot<span class="token punctuation">;</span>\n<span class="token comment">// 颜色插值计算</span>\nv_color <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>reflectedLight<span class="token punctuation">,</span> a_color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>dot() 是 WebGL 着色器语言的一个内置函数，可以直接使用，它的参数是两个向量，执行结果是两个向量的点积，如果光线方向向量和顶点法向量两个向量都是单位向量，求解的结果就是平行光线与物体表面法线夹角的余弦值。内置函数 normalize() 和 dot() 一样是 WebGL 着色器语言提供的用于数学计算的函数，normalize() 的作用就是把向量归一化，具体点说就是如果向量的模长不是 1，不改变向量方向，把模长变为 1，也就是把向量转化为单位向量。</p>\n<p><code class="language-text">max(dot(lightDirection, normal), 0.0)</code> 在 dot 代码的外面嵌套了一个函数 max()，dot() 的计算结果作为 max() 的第一个参数，dot 的计算结果可能是 [-1, 1] 之间，颜色不存在负值要舍去 [-1, 0)，这时候就是内置函数 max() 派上用场的时候，<code class="language-text">max(dot(lightDirection, normal), 0.0)</code> 中 max() 函数的第二个参数是 0，dot() 方法的计算结果会和 0 进行比较运算，返回一个较大的值，着色器语言内置提供了 max() 函数，自然也有对应的求较小值的函数 min()。余弦值是负值的物理意义就是光线无法照的地方，临界点是余弦值 0，入射角是 90 度，也就是说入射光线平行平面，平行平面相当于光线没有照射到平面上，平面没有收到光自然无法反射光，你可以尝试改变立方体顶点的旋转矩阵可以看到一些面的颜色是黑色，就是因为没有光线照射，这是符合实际生活和物理规律的，不管本身是什么颜色，没有外界光源，那就表现为黑色。</p>\n<p><code class="language-text">u_lightColor * a_color.rgb * dot;</code> 是套用理想漫反射光照模型的一个公式进行计算，顶点颜色变量 <code class="language-text">a_color</code> 是 vec4 类型包含透明度，计算式中光源颜色变量 <code class="language-text">u_lightColor</code> 没有透明度分量 A，所以使用 <code class="language-text">a_color.rgb</code> 语句返回 <code class="language-text">a_color</code> 变量的 RGB 三个分量，也就是返回一个 vec3 类型数据。</p>\n<p><code class="language-text">v_color = vec4(reflectedLight, a_color.a);</code> 通过把反射颜色 reflectedLight 赋值给 varying 声明的一个变量实现颜色的插值计算，关于插值计算之前讲过，不再多谈，这里说一下着色器语言数据类型的相关转化、构造、访问相关问题，vec4、vec3 和 float、int 一样是数据类型的标识关键字，float、int 在 C 语言中都是常见的类型，着色器语言为了实现大规模的顶点运算增加了 vec4、vec3、mat4 等数据类型，vec4()、vec3() 这时候相当于一个 vec4、vec3 数据的构造函数，<code class="language-text">vec4(reflectedLight, a_color.a)</code> 中把一个 vec3 类型数据和一个 vec4 类型数据的一个分量 a 作为构造函数 vec4 的两个参数，来实现创建一个 vec4 类型数据。访问多元素数据的分量可使用点符号 <code class="language-text">.</code> ，从面对象的角度来看， 一个 vec4 数据是一个对象，数据的一个元素就是数据的一个分量，比如 <code class="language-text">a_color.a</code> 表示 vec4 类型变量 <code class="language-text">a_color</code> 的透明度分量 a。关于 vec4、vec3 等向量数据类型的介绍可以查看第二章 WebGL 着色器。</p>\n<h5 id="获取着色器变量"><a href="#%E8%8E%B7%E5%8F%96%E7%9D%80%E8%89%B2%E5%99%A8%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取着色器变量</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43070426254380090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 从 program 对象获取相关的变量\n * attribute 变量声明的方法使用 getAttribLocation() 方法\n * uniform 变量声明的方法使用 getUniformLocation() 方法\n **/\nvar aposLocation = gl.getAttribLocation(program, \'apos\');\nvar a_color = gl.getAttribLocation(program, \'a_color\');\nvar a_normal = gl.getAttribLocation(program, \'a_normal\');\nvar u_lightColor = gl.getUniformLocation(program, \'u_lightColor\');\nvar u_lightPosition = gl.getUniformLocation(program, \'u_lightPosition\');`, `43070426254380090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 从 program 对象获取相关的变量\n * attribute 变量声明的方法使用 getAttribLocation() 方法\n * uniform 变量声明的方法使用 getUniformLocation() 方法\n **/</span>\n<span class="token keyword">var</span> aposLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'apos\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> a_color <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> a_normal <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_normal\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> u_lightColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightColor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> u_lightPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想给着色器程序中声明的变量传递数据，首先要获取数据的地址，然后通过指针地址传递给变量。要想获取变量地址，不可能像普通 CPU 变成一样，要考虑 GPU 的特殊性，首先要通过调用初始化着色器函数 initShader()，把着色器程序处理后通过 CPU 与 GPU 的通信传递给 GPU 配置渲染管线，执行初始化着色器函数 initShader() 的同时会返回一个 program 对象，通过对象 program 可以获取着色器程序中的变量索引地址，通过 WebGL API gl.getAttribLocation() 用来获取 attribute 关键字声明的顶点变量地址，通过 WebGL API gl.getUniformLocation() 获取 uniform 关键字声明的非顶点变量地址。</p>\n<h5 id="传递数据"><a href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传递数据</h5>\n<p>对于简单的数据，不像顶点有大批量数据，不需要在显存上开辟缓冲区上传数据，可以直接使用 WebGL API gl.uniform3f() 把数据传递给 GPU，uniform3f(变量地址, x, y, z) 表示传递三个浮点数 x, y, z，接收这个数据的变量是 vec3 类型，uniform2f(变量地址, x, y) 表示传递 2 个浮点数，接收数据的变量是 vec2 数据类型，以此类推还有方法 uniform4f()、uniform1f()，命名的特点是数字表示传递的数据有多少分量，f 是关键字 float 的缩写表示浮点数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88971327110695800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 给平行光传入颜色和方向数据 RGB(1, 1, 1)，单位向量 (x, y, z)\n **/\ngl.uniform3f(u_lightColor, 1.0, 1.0, 1.0);\n// 保证向量 (x, y, -z) 的长度为 1，即单位向量\n// 如果不是单位向量，也可以再来着色器代码中进行归一化\nvar x = 1 / Math.sqrt(14),\n   y = 2 / Math.sqrt(14),\n   z = 3 / Math.sqrt(14);\ngl.uniform3f(u_lightDirection, x, y, -z);`, `88971327110695800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 给平行光传入颜色和方向数据 RGB(1, 1, 1)，单位向量 (x, y, z)\n **/</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightColor<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 保证向量 (x, y, -z) 的长度为 1，即单位向量</span>\n<span class="token comment">// 如果不是单位向量，也可以再来着色器代码中进行归一化</span>\n<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   y <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   z <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightDirection<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>传递 uniform 变量的 WebGL API 对应的着色器 uniform 变量数据类型</p>\n<table>\n<thead>\n<tr>\n<th align="left">WebGL API</th>\n<th align="left">数据类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">uniform1f()</td>\n<td align="left">float</td>\n</tr>\n<tr>\n<td align="left">uniform2f()</td>\n<td align="left">vec2</td>\n</tr>\n<tr>\n<td align="left">uniform3f()</td>\n<td align="left">vec3</td>\n</tr>\n<tr>\n<td align="left">uniform4f()</td>\n<td align="left">vec4</td>\n</tr>\n</tbody>\n</table>\n<h5 id="顶点法向量"><a href="#%E9%A1%B6%E7%82%B9%E6%B3%95%E5%90%91%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点法向量</h5>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-23-14-21-42-00cf9bc9d3de3276f6a3b9e81d9c0051-997dd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 195px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 87.17948717948718%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAADOElEQVQ4y4VUzYsURxT/vVfV0z09PdMzO9+ubnZ2R81kHeJEXd31E8UEwrLsQRQ/LosXIYRcQhLJKRCSoCKJEEFBLwqCJ0H8AwTxtKfkqgm4eDDsZRGScaNTvurucXf04KOL96pe1a9+r957DawRlYyqNtG8FppcBWbOWWpk+THm+G+1ixe5rf7iw/0zZac3VtL/jlu7pLv0DpgVB+sih6NGij7OtNSEM8y/4hB/Tdv5LE3y9zStg7AiWypFvfh5Wfcm3wB2tY5A/tOaTGLHF3COCZ9Yky+ioH6nanKxjnV+SMHdKWbKztN0cZXd8hogKwzIZlSVoqqPeVaGXfWIC31/PoQv/jzxLU9heX8JXd+uX8aZVYbPtW4az7MTX66sJsBlOUgYFI3w222q8kLYmwNQJjPg7QoNqyXc9pdEo2JOeDHDgowJAa2JLoZwy5bcBdpw5Cf93QkBOuni3u4/5ekMqPACVJdUDg2AC7MRUQFHLFsSlh4XO2TkM02GCxzd9COfnjGK2kIhMyVJ+QPYL0AHXwGzoqewQpT+H+jIpPwL8LHodQa5dHJB0cHMmwcmnGsBuZTsIRnFq0D7BuqbV1Bov4zJAD1ZlLFVNsx2geP/wM/Z9brutX36ohVDGUeGK8hhKslyIl6gFqbH9MqWOERBkS8vDEPRo9eALQ9Q86yvos2xLP98SMwC4eYE00xJwt+ooOqCmFcIAnn8RsiXGso1UQmf57N4W+Thh9karpotau40gYdStHfaQjHFcJq2nATQi5NFrf7BqT5YL6qfKMsoAuvjcgmyOiNRb1raLZ5PJZSReJ1KDT9HEp/mZK+VDH0V6ZLqxgvXmfu+Yg6ZrEwrGDce2JwSwI9cI91iUtkUOIQXlUb9GBHFHUP9ZrCtF9UhkjocnSealgR+WLOdhN+ywINOIAs8iaH0JfWBbBue17RX9tqWxG1mwpp/QL+w49C13nNXc9PWYbBD1/gK9qpvUOcfnI66wgf8edii95c81Xil9b6EBCkMpt3+FPr9nDXbUirJfpofq8/4SdCQ31WHH9GcesaWIU7cVYT3yVO1SnoqpHcO8H3yeIEq8dvYqnSwsPruA/IaJ6mgu8ZAyJ8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 23 14 21 42" title="" data-src="/static/2022-08-23-14-21-42-00cf9bc9d3de3276f6a3b9e81d9c0051-997dd.png" data-srcset="/static/2022-08-23-14-21-42-00cf9bc9d3de3276f6a3b9e81d9c0051-997dd.png 195w" data-sizes="(max-width: 195px) 100vw, 195px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25485051535905014000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 顶点法向量数组 normalData\n **/\nvar normalData = new Float32Array([\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1, // z 轴正方向——面 1\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // x 轴正方向——面 2\n\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0, // y 轴正方向——面 3\n\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0, // x 轴负方向——面 4\n\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0, // y 轴负方向——面 5\n\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1 // z 轴负方向——面 6\n]);`, `25485051535905014000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 顶点法向量数组 normalData\n **/</span>\n<span class="token keyword">var</span> normalData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// z 轴正方向——面 1</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴正方向——面 2</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴正方向——面 3</span>\n\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴负方向——面 4</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴负方向——面 5</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// z 轴负方向——面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于立方体而言六个平面也就是有六个不同的平面法向量，但是这里要注意思考如何表达一个面的法向量，你不能说直接告诉 GPU 一个平面的法向量是 (x, y, z)，对于立方体而言而言这样比较简单，符合人的思维，但是如果是复杂的曲面这样并不合适，而且顶点着色器是逐顶点处理，为了表示面的法向量，往往是通过顶点，具体点说是每个顶点对应一个法向量，三个顶点确定一个三角面，三角面的不同位置的法向量相当于通过他的三个顶点的法向量插值得出，或者换个说法就是三个顶点的法向量分别与各自颜色数据进行乘法运算，得到新的顶点颜色，然后渲染管线利用新的顶点颜色进行插值计算，这就是通过顶点法向量表示面法向量的方法，通过这样的巧妙设计还可以实现法向量的插值计算，只不过插值是通过颜色插值完成的，对于平滑的曲面，过每一个顶点存在一个法平面，也就是有一个法向量，往往在不同三角面中同一位置的顶点法向量是相同的，对于规则的长方体而言，每个顶点法向量往往在各自平面中有不同的值。</p>\n<h4 id="顶点法向量矩阵变换"><a href="#%E9%A1%B6%E7%82%B9%E6%B3%95%E5%90%91%E9%87%8F%E7%9F%A9%E9%98%B5%E5%8F%98%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶点法向量矩阵变换</h4>\n<p>执行代码 <code class="language-text">gl_Position = mx * my * apos;</code> 意味着通过旋转矩阵 mx 和 my 对立方体顶点数据 apos 进行旋转变换，也就是说立方体在三维空间中进行了旋转，如果立方体进行了旋转，也就是说立方体表面的法线方向变化了，立方体表面的法线是通过顶点法向量表示的，所以说顶点法向量数据要和顶点位置数据一样执行矩阵变换 <code class="language-text">mx * my * a_normal</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47940994922451360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 两个旋转矩阵、顶点齐次坐标连乘\ngl_Position = mx * my * apos;\n// 顶点法向量进行矩阵变换，然后归一化\nvec3 normal = normalize((mx * my * a_normal).xyz);`, `47940994922451360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 两个旋转矩阵、顶点齐次坐标连乘</span>\ngl_Position <span class="token operator">=</span> mx <span class="token operator">*</span> my <span class="token operator">*</span> apos<span class="token punctuation">;</span>\n<span class="token comment">// 顶点法向量进行矩阵变换，然后归一化</span>\n<span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mx <span class="token operator">*</span> my <span class="token operator">*</span> a_normal<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="视线"><a href="#%E8%A7%86%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视线</h4>\n<p>通过下面的代码测试，来体会 WebGL 投影的规律。</p>\n<p>WebGL 图形系统默认的投影方向，或者说人的眼睛观察几何体的方向，或者说照相机拍照的方向。代码中的灯光方向的向量数据，第三个参数是负数，也就是说从 z 轴的角度看，平行光照射物体的方向，就是人眼睛看物体的方向，如果把灯光方向的向量数据 z 参数更改为正数，刷新浏览器看到的是一个漆黑的立方体投影，这时候相当于黑暗的环境中，人站在物体的背光面，而不是向光面，对于 WebGL 图形系统，你可以形象的理解为把光源从屏幕前面放到了屏幕的后面，人的观察方向是沿着 z 轴负方向，从屏幕外向里观察，光线自然被立方体遮挡住了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61886675375294734000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var x = 1 / Math.sqrt(15),\n   y = 2 / Math.sqrt(15),\n   z = 3 / Math.sqrt(15);\ngl.uniform3f(u_lightDirection, x, y, -z);`, `61886675375294734000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   y <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   z <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightDirection<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更改 -z 为 z，立方体显示为黑色效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61506467987972964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform3f(u_lightDirection, x, y, z);`, `61506467987972964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightDirection<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="立方体添加点光源"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93%E6%B7%BB%E5%8A%A0%E7%82%B9%E5%85%89%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体添加点光源</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yvjixk?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>添加平行光是直接定义光线照射物体的方向，点光源的光线是发散的，无法直接定义它的光线方向，不过只要定义好点光源的位置坐标，然后与某个顶点的位置坐标进行减法运算，计算结果就是光源射到该顶点的方向。这很好理解，在三维空间中两个点确定一条直线，几何体顶点代表一个点，点光源的位置代表一个点，直线所在的方向就是光线的方向，在三维笛卡尔坐标系中，把两个顶点的 xyz 三个分量相减就可以得到一个表示直线方向的向量，把该向量和顶点法向量作为 dot() 点积函数的参数，可以计算出光线入射角余弦值然后代入漫反射光照模型公式可以得到新的顶点颜色，渲染管线利用新的顶点颜色进行插值计算可以得到立方体表面每一个像素的值。</p>\n<h4 id="添加点光源位置、颜色数据"><a href="#%E6%B7%BB%E5%8A%A0%E7%82%B9%E5%85%89%E6%BA%90%E4%BD%8D%E7%BD%AE%E3%80%81%E9%A2%9C%E8%89%B2%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加点光源位置、颜色数据</h4>\n<p>WebGL 顶点着色器声明两个变量 <code class="language-text">u_lightPosition</code>、<code class="language-text">u_lightColor</code> 分别表示点光源的位置和颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74693581331998770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// uniform 声明点光源颜色变量\nuniform vec3 u_lightColor;\n// uniform 声明点光源位置变量\nuniform vec3 u_lightPosition;`, `74693581331998770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// uniform 声明点光源颜色变量</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightColor<span class="token punctuation">;</span>\n<span class="token comment">// uniform 声明点光源位置变量</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>给点光源颜色变量 <code class="language-text">u_lightColor</code>、位置变量 <code class="language-text">u_lightPosition</code> 传递数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99055601481107550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 传入点光源颜色数据、位置数据\ngl.uniform3f(u_lightColor, 1.0, 1.0, 1.0);\ngl.uniform3f(u_lightPosition, 2.0, 3.0, 4.0);`, `99055601481107550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 传入点光源颜色数据、位置数据</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightColor<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3f</span><span class="token punctuation">(</span>u_lightPosition<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h4 id="点光源与顶点方向计算"><a href="#%E7%82%B9%E5%85%89%E6%BA%90%E4%B8%8E%E9%A1%B6%E7%82%B9%E6%96%B9%E5%90%91%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>点光源与顶点方向计算</h4>\n<p>点光源的光线是发散的，点光源与每一顶点连线的方向都需要单独计算。</p>\n<p><code class="language-text">vec3(gl_Position) - u_lightPosition</code> 用来计算光线方向，然后利用内置函数 normalize() 归一化向量数据，<code class="language-text">vec3(gl_Position)</code> 和 <code class="language-text">gl_Position.xyz</code> 的写法是等效的，都是为了提取 vec4 类型顶点数据前三个分量，返回的数据类型是 vec3，比如 vec2(vec4) 就是提取 vec4 的前两个分量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91430357745396680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 计算点光源照射顶点的方向并归一化\nvec3 lightDirection = normalize(vec3(gl_Position) - u_lightPosition);\n// 计算平行光方向向量和顶点法向量的点积\nfloat dot = max(dot(lightDirection, normal), 0.0);`, `91430357745396680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 计算点光源照射顶点的方向并归一化</span>\n<span class="token keyword">vec3</span> lightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> u_lightPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算平行光方向向量和顶点法向量的点积</span>\n<span class="token keyword">float</span> dot <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>lightDirection<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="立方体旋转动画"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93%E6%97%8B%E8%BD%AC%E5%8A%A8%E7%94%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体旋转动画</h2>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5ebtu4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>要通过 WebGL 渲染出立方体旋转的动画效果，你首要了解“帧”这个概念，比如你观看的视频其实就是一帧一帧的图片连续播放的效果，只要图片刷新的频率的不是太低，人的眼睛都不会察觉，一般 30~60FPS 就可以。WebGL 如何产生一帧一帧的图片，这个很简单，执行一次绘制函数 gl.drawArrays()，WebGL 图形系统就会通知 GPU 渲染管线处理顶点数据生成一帧 RGB 像素数据显示在屏幕 canvas 画布上。只要周期性保持一定的频率调用 gl.drawArrays() 就可以生成一帧一帧的图片，在这个过程中同时要利用 JS 程序更新顶点的旋转矩阵，如果顶点的位置不变化，渲染出来的都是一样的图片，自然也没有动画的效果。</p>\n<p>浏览器提供了一个方法 requestAnimationFrame() 可以实现周期性调用某个函数，主要用于动画。</p>\n<p>在光照立方体的基础上进行更改，一方面是周期性执行绘制方法 gl.drawArrays()，另一方面以一定的旋转速度更新立方体的旋转矩阵，原来使用着色器语言定义的旋转矩阵更改为使用 JS 语句创建好再传递给顶点着色器，gl.drawArrays() 每次执行的时候，都会重新传入着色器顶点旋转矩阵数据并渲染出来。</p>\n<h3 id="声明矩阵变量"><a href="#%E5%A3%B0%E6%98%8E%E7%9F%A9%E9%98%B5%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>声明矩阵变量</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16211971901354215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** uniform 声明旋转矩阵变量 mx、my **/\nuniform mat4 mx; // 绕 x 轴旋转矩阵\nuniform mat4 my; // 绕 y 轴旋转矩阵`, `16211971901354215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">/** uniform 声明旋转矩阵变量 mx、my **/</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> mx<span class="token punctuation">;</span> <span class="token comment">// 绕 x 轴旋转矩阵</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> my<span class="token punctuation">;</span> <span class="token comment">// 绕 y 轴旋转矩阵</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在顶点着色器代码中使用关键字 uniform 声明两个旋转矩阵变量 mx 和 my，分别表示绕 x 轴、y 轴的旋转矩阵。旋转矩阵数据和光照数据一样适用于所有的非顶点数据，使用关键字 uniform 声明，不能使用 attribute 关键字声明。</p>\n<h3 id="传入-mx-矩阵数据"><a href="#%E4%BC%A0%E5%85%A5-mx-%E7%9F%A9%E9%98%B5%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入 mx 矩阵数据</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19743430137266536000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 从 program 对象获得旋转矩阵变量 mx、my 地址 **/\nvar mx = gl.getUniformLocation(program, \'mx\');\nvar my = gl.getUniformLocation(program, \'my\');`, `19743430137266536000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 从 program 对象获得旋转矩阵变量 mx、my 地址 **/</span>\n<span class="token keyword">var</span> mx <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'mx\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> my <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'my\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34978334021249855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 绕 x 轴旋转 45 度 **/\nvar mxArr = new Float32Array([\n   1,\n   0,\n   0,\n   0,\n\n   0,\n   Math.cos(Math.PI / 4),\n   -Math.sin(Math.PI / 4),\n   0,\n\n   0,\n   Math.sin(Math.PI / 4),\n   Math.cos(Math.PI / 4),\n   0,\n\n   0,\n   0,\n   0,\n   1\n]);\n\n// 把数据 mxArr 传递给着色器旋转矩阵变量 mx\ngl.uniformMatrix4fv(mx, false, mxArr);`, `34978334021249855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 绕 x 轴旋转 45 度 **/</span>\n<span class="token keyword">var</span> mxArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 把数据 mxArr 传递给着色器旋转矩阵变量 mx</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>mx<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mxArr<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上节课定义顶点旋转矩阵使用的着色器语言，下面的案例是先在 JS 程序中使用类型数组 Float32Array() 创建旋转矩阵的数据，然后使用 WebGL API gl.uniformMatrix4fv() 把数据传递给着色器。WebGL 中给着色器中不同关键字声明的不同类型变量传递数据，要使用不同的 WebGL API，uniform 关键字声明的 mat4 类型变量使用 WebGL API gl.uniformMatrix4fv()，uniform 关键字声明的 mat2 类型变量使用 WebGL API uniformMatrix2fv()，uniform 关键字声明的一个浮点数使用 gl.uniform1f() 传递，uniform 关键字声明的 vec4 类型变量和 mat4 一样使用 uniform4fv（变量地址名，<code class="language-text">new Float32Array([a, b, c, d])</code>）传递，也可以使用 uniform4f（变量地址名，a, b, c, d）传递，attribute 关键字声明的变量使用 WebGL API gl.vertexAttribPointer() 传递。</p>\n<h3 id="绘制函数-draw"><a href="#%E7%BB%98%E5%88%B6%E5%87%BD%E6%95%B0-draw" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>绘制函数 draw()</h3>\n<p>该绘制函数 draw() 可以使用 requestAnimationFrame(draw) 代码实现 draw() 函数的循环调用，因为要实现立方体绕 y 轴旋转，所以要在 draw 函数中更新 my 旋转矩阵的数据，同时利用 WebGL API gl.uniformMatrix4fv() 把新的矩阵数据传递给着色器矩阵变量 my，在函数重复调用 gl.drawArrays(gl.TRIANGLES, 0, 36) 不停绘制旋转后的顶点数据，所有需要更新的数据都要写在 draw 函数中，不需要反复执行的代码写在 draw 函数外，比如 mx 旋转矩阵只需要执行传入一次不再改变。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61922939978840930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 定义绘制函数 draw()，定时更新旋转矩阵数据，并调用 WebGL 绘制 API\n ***/\nvar angle = Math.PI / 4; // 起始角度\nfunction draw() {\n   // gl.clear(gl.COLOR_BUFFER_BIT); // 清空画布上一帧图像\n   /**\n    * 立方体绕 y 轴旋转\n    ***/\n   angle += 0.01; // 每次渲染角度递增，每次渲染不同的角度\n   var sin = Math.sin(angle); // 旋转角度正弦值\n   var cos = Math.cos(angle); // 旋转角度余弦值\n   var myArr = new Float32Array([cos, 0, -sin, 0, 0, 1, 0, 0, sin, 0, cos, 0, 0, 0, 0, 1]);\n   gl.uniformMatrix4fv(my, false, myArr);\n   requestAnimationFrame(draw);\n   /** 执行绘制命令 **/\n   gl.drawArrays(gl.TRIANGLES, 0, 36);\n}\ndraw();`, `61922939978840930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 定义绘制函数 draw()，定时更新旋转矩阵数据，并调用 WebGL 绘制 API\n ***/</span>\n<span class="token keyword">var</span> angle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 起始角度</span>\n<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// gl.clear(gl.COLOR_BUFFER_BIT); // 清空画布上一帧图像</span>\n   <span class="token comment">/**\n    * 立方体绕 y 轴旋转\n    ***/</span>\n   angle <span class="token operator">+=</span> <span class="token number">0.01</span><span class="token punctuation">;</span> <span class="token comment">// 每次渲染角度递增，每次渲染不同的角度</span>\n   <span class="token keyword">var</span> sin <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 旋转角度正弦值</span>\n   <span class="token keyword">var</span> cos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 旋转角度余弦值</span>\n   <span class="token keyword">var</span> myArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> myArr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">/** 执行绘制命令 **/</span>\n   gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="webgl-绘制多个几何体"><a href="#webgl-%E7%BB%98%E5%88%B6%E5%A4%9A%E4%B8%AA%E5%87%A0%E4%BD%95%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 绘制多个几何体</h2>\n<p>利用 WebGL 重现三维场景的时候，往往不仅仅有一个几何体，比如像机器人是由多个子零件构成的装配体，可能同一个零件出现在不同的位置，可能两个零件的形状一样颜色不一样，也有颜色形状完全不同的零件。阅读下面的讲解内容，一方面可以学习如何利用 WebGL 创建多几何体场景，同时借助实际的问题进一步加深对渲染管线这个硬件黑箱的认知，只有更好的认知渲染管线才能更好的应用与它紧密关联的 API 接口，学习精力是有限的，毕竟 GPU 的数字电路不是每个人都有时间学习明白，只能通过简单的案例程序学习如何利用 WebGL API 操作渲染管线的相关功能。</p>\n<p>绘制多个几何体你首先会想到应该是每个几何体都有自己的顶点数据，要创建多个几何体自然要先利用类型数据创建这些顶点数据，除此外还要学习绘制函数的多次调用与帧缓存的知识，学习如何切换使用多组着色器程序。</p>\n<p>为了绘制两个相同的立方体效果，下面给出了两种方式。</p>\n<h3 id="方式一"><a href="#%E6%96%B9%E5%BC%8F%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方式一</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/phgtl1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最简单思路，增加一个几何体就把几何体的顶点添加到顶点数据中，在光照立方体代码的基础上更改即可，把立方体原来数据复制一份，为了把两个立方体的位置错开，可以使用 for 循环批量修改顶点数据，把某个坐标值加或减。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48614596882520100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = new Float32Array([\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3, // 面 1\n\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3, // 面 2\n\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3, // 面 3\n\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3, // 面 4\n\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3, // 面 3\n\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3, // 面 6\n\n   // 立方体 2 的顶点坐标数据\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3, // 面 1\n\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3, // 面 2\n\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3, // 面 3\n\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3, // 面 4\n\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   0.3, // 面 3\n\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   -0.3,\n   -0.3,\n   0.3,\n   -0.3,\n   0.3,\n   0.3,\n   -0.3 // 面 6\n]);\n// 立方体 1 顶点数据 x 坐标批量加 0.5\nfor (var i = 0; i < 36 * 3; i += 3) {\n   data[i] += 0.5;\n}\n// 立方体 2 顶点数据 x 坐标批量减 0.5\nfor (var i = 36 * 3; i < 72 * 3; i += 3) {\n   data[i] -= 0.5;\n}`, `48614596882520100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 1</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 2</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 3</span>\n\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 4</span>\n\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 3</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 6</span>\n\n   <span class="token comment">// 立方体 2 的顶点坐标数据</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 1</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 2</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 3</span>\n\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 4</span>\n\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token comment">// 面 3</span>\n\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token number">0.3</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">0.3</span> <span class="token comment">// 面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 立方体 1 顶点数据 x 坐标批量加 0.5</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">36</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 立方体 2 顶点数据 x 坐标批量减 0.5</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">36</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">72</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>顶点的法向量数据、颜色数据重新复制一份即可，和原来相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46055979454344870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n 创建顶点颜色数组 colorData\n **/\nvar colorData = new Float32Array([\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 1\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 2\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 3\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 4\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 5\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 6\n\n   // 立方体 2 的顶点颜色数据\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 1\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 2\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 3\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 4\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // 红色——面 5\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0 // 红色——面 6\n]);\n/**\n *顶点法向量数组 normalData\n **/\nvar normalData = new Float32Array([\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1, // z 轴正方向——面 1\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // x 轴正方向——面 2\n\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0, // y 轴正方向——面 3\n\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0, // x 轴负方向——面 4\n\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0, // y 轴负方向——面 5\n\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1, // z 轴负方向——面 6\n\n   // 立方体 2 的顶点法向量数据\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1, // z 轴正方向——面 1\n\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0, // x 轴正方向——面 2\n\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0,\n   0,\n   1,\n   0, // y 轴正方向——面 3\n\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0, // x 轴负方向——面 4\n\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0, // y 轴负方向——面 5\n\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1,\n   0,\n   0,\n   -1 // z 轴负方向——面 6\n]);`, `46055979454344870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n 创建顶点颜色数组 colorData\n **/</span>\n<span class="token keyword">var</span> colorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 1</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 2</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 3</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 4</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 5</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 6</span>\n\n   <span class="token comment">// 立方体 2 的顶点颜色数据</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 1</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 2</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 3</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 4</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 红色——面 5</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span> <span class="token comment">// 红色——面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">/**\n *顶点法向量数组 normalData\n **/</span>\n<span class="token keyword">var</span> normalData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// z 轴正方向——面 1</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴正方向——面 2</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴正方向——面 3</span>\n\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴负方向——面 4</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴负方向——面 5</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// z 轴负方向——面 6</span>\n\n   <span class="token comment">// 立方体 2 的顶点法向量数据</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// z 轴正方向——面 1</span>\n\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴正方向——面 2</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴正方向——面 3</span>\n\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// x 轴负方向——面 4</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// y 轴负方向——面 5</span>\n\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token number">0</span><span class="token punctuation">,</span>\n   <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// z 轴负方向——面 6</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>绘制的顶点数量增加了，drawArrays 方法的参数要从 36 变为 72.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32960699053868335000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 执行绘制命令 **/\ngl.drawArrays(gl.TRIANGLES, 0, 36);`, `32960699053868335000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 执行绘制命令 **/</span>\ngl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4947798788892221000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 执行绘制命令 **/\ngl.drawArrays(gl.TRIANGLES, 0, 72);`, `4947798788892221000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 执行绘制命令 **/</span>\ngl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="方式二（重用数据）"><a href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%88%E9%87%8D%E7%94%A8%E6%95%B0%E6%8D%AE%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方式二（重用数据）</h3>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nml4xw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>两个几何体颜色、形状完全相同，没有必要在创建一组顶点数据，可以使用 WebGL API 绘制函数 gl.drawArrays() 多次调用同一组顶点数据，执行平移变换即可，第一次调用 WebGL API 绘制函数 gl.drawArrays() 把立方体整体向右平移（x 轴正方向），第二次调用立方体整体向左平移（x 轴负方向）。</p>\n<p>在着色器声明旋转矩阵 mx、my 和平移矩阵 Tx，旋转矩阵传入一次数据不再改变，平移矩阵的数据每次调用 WebGL API 绘制函数 gl.drawArrays()，都会重新传入着色器新的数据，在新的位置渲染出来几何体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93814967956003450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** uniform 声明旋转矩阵变量 mx、my，平移矩阵 Tx **/\nuniform mat4 mx; // 绕 x 轴旋转矩阵\nuniform mat4 my; // 绕 y 轴旋转矩阵\nuniform mat4 Tx; // 沿着 x 轴平移矩阵`, `93814967956003450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">/** uniform 声明旋转矩阵变量 mx、my，平移矩阵 Tx **/</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> mx<span class="token punctuation">;</span> <span class="token comment">// 绕 x 轴旋转矩阵</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> my<span class="token punctuation">;</span> <span class="token comment">// 绕 y 轴旋转矩阵</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> Tx<span class="token punctuation">;</span> <span class="token comment">// 沿着 x 轴平移矩阵</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在着色器声明旋转矩阵 mx、my 和平移矩阵 Tx，旋转矩阵传入一次数据不再改变，平移矩阵的数据每次调用 WebGL API 绘制函数 gl.drawArrays()，都会重新传入着色器新的数据，在新的位置渲染出来几何体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10332729130543528000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** 从 program 对象获得旋转矩阵变量 mx、my、Tx 地址 **/\nvar mx = gl.getUniformLocation(program, \'mx\');\nvar my = gl.getUniformLocation(program, \'my\');\nvar Tx = gl.getUniformLocation(program, \'Tx\');`, `10332729130543528000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** 从 program 对象获得旋转矩阵变量 mx、my、Tx 地址 **/</span>\n<span class="token keyword">var</span> mx <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'mx\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> my <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'my\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> Tx <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'Tx\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 WebGL API gl.uniformMatrix4fv() 把类型数据创建的旋转矩阵数据传递给着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26051638531239084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 传入旋转矩阵数据\n ***/\nvar angle = Math.PI / 4; // 旋转角度\nvar sin = Math.sin(angle);\nvar cos = Math.cos(angle);\n// 旋转矩阵数据\nvar mxArr = new Float32Array([1, 0, 0, 0, 0, cos, -sin, 0, 0, sin, cos, 0, 0, 0, 0, 1]);\nvar myArr = new Float32Array([cos, 0, -sin, 0, 0, 1, 0, 0, sin, 0, cos, 0, 0, 0, 0, 1]);\n// 类型数组传入矩阵\ngl.uniformMatrix4fv(mx, false, mxArr);\ngl.uniformMatrix4fv(my, false, myArr);`, `26051638531239084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 传入旋转矩阵数据\n ***/</span>\n<span class="token keyword">var</span> angle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 旋转角度</span>\n<span class="token keyword">var</span> sin <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> cos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 旋转矩阵数据</span>\n<span class="token keyword">var</span> mxArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cos<span class="token punctuation">,</span> <span class="token operator">-</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sin<span class="token punctuation">,</span> cos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> myArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 类型数组传入矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>mx<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mxArr<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>my<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> myArr<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>声明一个绘制函数 draw(x)，参数 x 是平移矩阵的一个元素，表示沿 x 轴平移距离，每次调用 draw() 函数都会传入新的 x 值。调用 draw 函数，执行 gl.drawArrays(gl.TRIANGLES, 0, 36) 语句的时候，渲染管线会生成立方体图像的像素值，像素值存储在帧缓冲区的颜色缓冲区中，你可以把帧缓冲区当成一个 RGB 像素值仓库，每执行一次 gl.drawArrays(gl.TRIANGLES, 0, 36) 生成一组 RGB 值，这些数据会被送进帧缓冲去中，默认不会覆盖前面的 RGB 数据，显示系统会不停的循环扫描帧缓冲区中的颜色数据显示在屏幕上。</p>\n<p>你可以执行注释掉的代码 <code class="language-text">gl.clear(gl.COLOR_BUFFER_BIT)</code>，然后刷新浏览器可以发现，网页上只有一个立方的图像， 这句代码 <code class="language-text">gl.clear(gl.COLOR_BUFFER_BIT)</code> 的作用就是清除帧缓冲区中颜色缓冲区存储的颜色数据，clear() 是一个 WebGL API，参数 <code class="language-text">COLOR_BUFFER_BIT</code> 表示帧缓冲区的颜色缓冲区，当然你也可以清除其它显存区域中的数据，比如参数是 <code class="language-text">gl.DEPTH_BUFFER_BIT</code> 就表示帧缓冲区的深度缓冲区像素深度数据，深度缓冲区和颜色缓冲区一样都是帧缓存的子缓冲区。</p>\n<p>立方体的所有面的像素值都存储在颜色缓冲区中，这些像素的深度值都保存在深度缓冲区中，深度缓冲区中数据表征像素距离人眼睛的长度，执行 <code class="language-text">gl.enable(gl.DEPTH_TEST)</code> 可以开启深度检测功能，离眼睛近的像素才会显示出来，离眼睛远的像素值会被覆盖，对应生活中就是正常情况下你的眼睛不可能不可能看到立方体的背面，你只能看到离你眼睛近的正面。</p>\n<h3 id="webgl-坐标系"><a href="#webgl-%E5%9D%90%E6%A0%87%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 坐标系</h3>\n<p>第一个 WebGL 程序创建了两个立方体的顶点数据，两个立方体一左一右，然后执行了绕 x 轴和 y 轴两个旋转变换，查看效果图你可以知道绕 y 旋转的时候是 WebGL 默认坐标系的 y 轴，不是过立方体几何中心的的 y 轴，查看立方体的顶点坐标可以看出来，两个立方体自身的几何中心是在 x 轴上的，所以立方体绕 WebGL 坐标系 x 轴的旋转相当于绕自身过几何中心的 x 轴旋转。复杂的场景往往牵扯到各种各样抽象出来的坐标系，比如视图坐标系、世界坐标系等，他们都是基于 WebGL 默认的坐标系抽象出来的，这里不再多说，先有一个简单的印象，一个几何体变换是相对于谁而言。</p>\n<p>对比上面方法一和方法二两个 WebGL 程序，你可以发现他们稍有区别。第二个 WebGL 程序的运行结果和第一个之所以不一样是因为平移和旋转的先后顺序不一样，第一个 WebGL 程序中虽然没有平移变换，但是两个几何体一左一右关于 y 轴对称，相当于从中间平移过去，然后经过两次旋转。查看下面第二个 WebGL 程序的着色器程序矩阵相乘的顺序，可以知道着色器处理器先对顶点进行旋转变换再进行平移变换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8495832645155522000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 平移矩阵 Tx、旋转矩阵 mx、旋转矩阵 my 连乘、顶点齐次坐标连乘\ngl_Position = Tx * mx * my * apos;`, `8495832645155522000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 平移矩阵 Tx、旋转矩阵 mx、旋转矩阵 my 连乘、顶点齐次坐标连乘</span>\ngl_Position <span class="token operator">=</span> Tx <span class="token operator">*</span> mx <span class="token operator">*</span> my <span class="token operator">*</span> apos<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>矩阵的乘法运算中，矩阵的左乘和右乘是不一样的，是有顺序性的，离 apos 列向量近的矩阵就是先执行的变换，如果把平移矩阵 Tx 靠近 apos 列向量，运行程序你会发现和第一个 WebGL 程序的运算结果是一样的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84335720371079410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 平移矩阵 Tx、旋转矩阵 mx、旋转矩阵 my 连乘、顶点齐次坐标连乘\ngl_Position = mx * my * Tx * apos;`, `84335720371079410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 平移矩阵 Tx、旋转矩阵 mx、旋转矩阵 my 连乘、顶点齐次坐标连乘</span>\ngl_Position <span class="token operator">=</span> mx <span class="token operator">*</span> my <span class="token operator">*</span> Tx <span class="token operator">*</span> apos<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="webgl-纹理贴图"><a href="#webgl-%E7%BA%B9%E7%90%86%E8%B4%B4%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 纹理贴图</h2>\n<p>把 png、jpg 等格式图片显示在 WebGL 三维场景中，比如一个产品的三维模型上贴一个商标。一张图片从数据结构的角度看，文件中包含的信息就是和颜色缓冲区中的 RGB 或 RGBA 数据一样，.jpg 格式图片数据包含 RGB 红绿蓝三个颜色分量，.png 格式图片的数据除了 RGB 三个分量还包含透明度 A 分量，在 WebGL 中可以通过调节透明度 A 分量的值可以实现颜色叠加，模拟透明、半透明的玻璃效果。</p>\n<p>前面学习过顶点位置坐标、顶点颜色、顶点法向量三种顶点数据，本节课要引入新的顶点数据纹理坐标。图片称为纹理图像，图片上的一个像素称为纹素，一个纹素就是一个 RGB 或 RGBA 值。把整个图片看成一个平面区域，用一个二维 UV 坐标系可以描述每一个纹素的位置。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-14-18-25-57-fd397c2893203713c5b2a695c9dc8f04-fee1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACkUlEQVQoz41SW0hUYRCec84e91x2z9k9u2ddd9d13WtpUm2KFERRINhzZJYPQS9BUIF0IbqJYU+WkgayQWViElqGpUYrEZWUikpkahcQUczorQtm2TR7ew0HPmbmZ+b75wYAIEFuJCgjCnZESbw2JLsQeb5sb0DNdm+3cnxUMGSVgCErSiil+AikJECwpW2ewCQtBFA3tDytV9rHv0vXn8+qwyvzps7JObHh4dfQ/Y/xznVV/kuFRx2lu58payunZLe33J4fqVIY6xqvK7hH9ThKNCtAdj8Ah4whRe98MN0sN/WhcKIR1Qkqs7kfherLqMQXRwGRWQIQVkQ1e5ETnH0GyfdDsOkg2LVa3uw9zPLF8wAOKswxS3FJQjn++YqpawLFi7d/qWO4It8c/C2cjaE5vvAqQZiI2RIKsGEaTwElUVYRPe0UqRYXgLKJ3gozZAlRuqcbTN3TaGobWlaHl9HcO/PH3PMJlZffXgf+IpsMcoV5YDiaGaOl57eDfLIZnWwzgTihOBkrPp6rF2tbUTh59ac6jstSY8+S8VANKr0zg5lPqSVDArsAtGO0jCCRkM/do6pJsy2k3SlSAN+d0RtKxzjKbSNo+YBofrKAYvsoygNfpqAdxVOhatObSIXeqkd9FZy4MZ5lCeQpAf8RS8QfEx0FY/QBkeqYuJh3tKGtB04ftHa8rZNaR86Zut7XyHcnzwdjL5oKmgaOR22RzaCt90G40g6ScxuE9yuptnQrFJ/h4D+SmJWY1oZHAFaCVkea/CIfgJGySwhBC7VLm8qlI8kx0nbpCPV9NEzMMJVduMWyOXk+xpYTYpxePyEfyAeHxwPlMXAatdRiWINEeX6Ch7zcNLwEN5s57NUKt8q4f/K0vVPWvBF4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 14 18 25 57" title="" data-src="/static/2022-09-14-18-25-57-fd397c2893203713c5b2a695c9dc8f04-fee1c.png" data-srcset="/static/2022-09-14-18-25-57-fd397c2893203713c5b2a695c9dc8f04-a67b7.png 200w,\n/static/2022-09-14-18-25-57-fd397c2893203713c5b2a695c9dc8f04-0b187.png 400w,\n/static/2022-09-14-18-25-57-fd397c2893203713c5b2a695c9dc8f04-fee1c.png 800w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>// TODO <a href="http://www.yanhuangxueyuan.com/WebGL/" target="_blank" rel="nofollow noreferrer noopener">http://www.yanhuangxueyuan.com/WebGL/</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/WebGL零基础入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:36,frontmatter:{date:"2022-09-14 18:27:05",path:"/webgl-zero-based-practice-learn/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 零基础入门学习",draft:null}}],page:2,pagesSum:47,length:231,prevPath:"/page/1",nextPath:"/page/3"}}}});