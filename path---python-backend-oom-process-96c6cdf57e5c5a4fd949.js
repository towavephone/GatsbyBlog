webpackJsonp([21270542947780],{1374:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢</p>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>需要找到哪行代码导致的内存泄漏，有以下方案</p>\n<ol>\n<li><a href="https://zhuanlan.zhihu.com/p/436577356" target="_blank" rel="nofollow noreferrer noopener">pympler</a></li>\n<li><a href="https://github.com/plasma-umass/scalene" target="_blank" rel="nofollow noreferrer noopener">scalene</a> (python3.8 以上，不符合)</li>\n<li><a href="https://github.com/bloomberg/memray" target="_blank" rel="nofollow noreferrer noopener">memray</a> (python3.7 以上，不符合)</li>\n<li>使用 python 内置的 tracemalloc 库</li>\n</ol>\n<p>由于项目用的是 python 3.6 的版本，所以采用方案 1 和 4</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="内存占用检测"><a href="#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存占用检测</h2>\n<ol>\n<li>通过接口获取当前内存占用最大的排名前几的代码行数</li>\n<li>通过接口获取当前占用内存最大的对象</li>\n</ol>\n<p><code class="language-text">controllers/app_monitor_controller.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47364907180869050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import tracemalloc\nimport logging\n\nfrom controllers.wrapper import (\n    get_param, get_int_param, request_wrapper)\n\n\n@request_wrapper()\ndef get_tracemalloc(request):\n    key_type = get_param(request, \'key_type\', default=\'traceback\')\n    limit = get_int_param(request, \'limit\', default=\'10\')\n    snapshot = tracemalloc.take_snapshot()\n    snapshot = snapshot.filter_traces((\n        tracemalloc.Filter(False, &quot;<unknown>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap_external>&quot;),\n        tracemalloc.Filter(\n            False, &quot;<frozen importlib._bootstrap>&quot;),\n        tracemalloc.Filter(False, tracemalloc.__file__),\n    ))\n    top_stats = snapshot.statistics(key_type)\n    top_result = []\n    for index, stat in enumerate(top_stats[:limit], 1):\n        frame = stat.traceback[0]\n        desc = &quot;#%s: %s:%s: %.1f KiB&quot; % (\n            index, frame.filename, frame.lineno, stat.size / 1024)\n        top_result.append({\n            \'desc\': desc,\n            \'traceback\': stat.traceback.format()\n        })\n\n    other = top_stats[limit:]\n    if other:\n        size = sum(stat.size for stat in other)\n\n    total = sum(stat.size for stat in top_stats)\n\n    return {\n        \'top_result\': top_result,\n        \'other_result\': &quot;Total %s, other: %.1f KiB&quot; %\n        (len(other), size / 1024),\n        \'total_size\': &quot;%.1f KiB&quot; % (total / 1024)\n    }\n\n\n@request_wrapper()\ndef get_memory(request):\n    limit = get_int_param(request, \'limit\', default=\'1\')\n    from pympler import muppy, summary\n\n    all_objects = muppy.get_objects()\n    sum1 = summary.summarize(all_objects)\n    logging.info(\'Summary -----\')\n    summary.print_(sum1)\n\n    filter_all_objects = muppy.sort(all_objects)\n    dicts = [ao for ao in filter_all_objects if isinstance(ao, dict)]\n    result = []\n    for d in dicts[-limit:]:\n        item = f\'{len(d)}, {str(d).encode(&quot;utf-8&quot;)}\'\n        result.append(item)\n\n    import objgraph\n\n    logging.info(\'Common -----\')\n    objgraph.show_most_common_types()\n\n    logging.info(\'Growth -----\')\n    objgraph.show_growth(limit=5)\n\n    return result`, `47364907180869050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> logging\n\n<span class="token keyword">from</span> controllers<span class="token punctuation">.</span>wrapper <span class="token keyword">import</span> <span class="token punctuation">(</span>\n    get_param<span class="token punctuation">,</span> get_int_param<span class="token punctuation">,</span> request_wrapper<span class="token punctuation">)</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_tracemalloc</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    key_type <span class="token operator">=</span> get_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'key_type\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'traceback\'</span><span class="token punctuation">)</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'10\'</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> tracemalloc<span class="token punctuation">.</span>take_snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    snapshot <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>filter_traces<span class="token punctuation">(</span><span class="token punctuation">(</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;unknown>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap_external>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span>\n            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"&lt;frozen importlib._bootstrap>"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        tracemalloc<span class="token punctuation">.</span>Filter<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> tracemalloc<span class="token punctuation">.</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">)</span>\n    top_stats <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>statistics<span class="token punctuation">(</span>key_type<span class="token punctuation">)</span>\n    top_result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> stat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>top_stats<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        frame <span class="token operator">=</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n        desc <span class="token operator">=</span> <span class="token string">"#%s: %s:%s: %.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n            index<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>lineno<span class="token punctuation">,</span> stat<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n        top_result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'desc\'</span><span class="token punctuation">:</span> desc<span class="token punctuation">,</span>\n            <span class="token string">\'traceback\'</span><span class="token punctuation">:</span> stat<span class="token punctuation">.</span>traceback<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    other <span class="token operator">=</span> top_stats<span class="token punctuation">[</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> other<span class="token punctuation">:</span>\n        size <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> other<span class="token punctuation">)</span>\n\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token keyword">for</span> stat <span class="token keyword">in</span> top_stats<span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">\'top_result\'</span><span class="token punctuation">:</span> top_result<span class="token punctuation">,</span>\n        <span class="token string">\'other_result\'</span><span class="token punctuation">:</span> <span class="token string">"Total %s, other: %.1f KiB"</span> <span class="token operator">%</span>\n        <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token string">\'total_size\'</span><span class="token punctuation">:</span> <span class="token string">"%.1f KiB"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>total <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n\n@request_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">get_memory</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    limit <span class="token operator">=</span> get_int_param<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">\'limit\'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">from</span> pympler <span class="token keyword">import</span> muppy<span class="token punctuation">,</span> summary\n\n    all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>get_objects<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sum1 <span class="token operator">=</span> summary<span class="token punctuation">.</span>summarize<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Summary -----\'</span><span class="token punctuation">)</span>\n    summary<span class="token punctuation">.</span>print_<span class="token punctuation">(</span>sum1<span class="token punctuation">)</span>\n\n    filter_all_objects <span class="token operator">=</span> muppy<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>all_objects<span class="token punctuation">)</span>\n    dicts <span class="token operator">=</span> <span class="token punctuation">[</span>ao <span class="token keyword">for</span> ao <span class="token keyword">in</span> filter_all_objects <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ao<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> d <span class="token keyword">in</span> dicts<span class="token punctuation">[</span><span class="token operator">-</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        item <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>\n\n    <span class="token keyword">import</span> objgraph\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Common -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_most_common_types<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'Growth -----\'</span><span class="token punctuation">)</span>\n    objgraph<span class="token punctuation">.</span>show_growth<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里需要在项目启动的时候去开启记录内存的功能，否则上面的 <code class="language-text">get_tracemalloc</code> 功能不可用，当然这里的功能需要在使用结束后立即关闭，否则内存占用较大</p>\n<p>apps.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22821336154321340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from django.apps import AppConfig\nimport tracemalloc\nimport os\n\n# 减少 pypinyin 的内存占用\nos.environ[\'PYPINYIN_NO_PHRASES\'] = \'true\'\nos.environ[\'PYPINYIN_NO_DICT_COPY\'] = \'true\'\n\n\nclass Config(AppConfig):\n    def ready(self):\n        from entry.settings import START_RECORD_MEMORY\n        if not START_RECORD_MEMORY:\n            return\n        tracemalloc.start(25)`, `22821336154321340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig\n<span class="token keyword">import</span> tracemalloc\n<span class="token keyword">import</span> os\n\n<span class="token comment"># 减少 pypinyin 的内存占用</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_PHRASES\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\nos<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">\'PYPINYIN_NO_DICT_COPY\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'true\'</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">ready</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">from</span> entry<span class="token punctuation">.</span>settings <span class="token keyword">import</span> START_RECORD_MEMORY\n        <span class="token keyword">if</span> <span class="token keyword">not</span> START_RECORD_MEMORY<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        tracemalloc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="耗时检测"><a href="#%E8%80%97%E6%97%B6%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>耗时检测</h2>\n<p>主要用来统计函数执行过程中每行耗时及调用次数</p>\n<p><code class="language-text">tools/performance_tool.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13204948370283299000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from cProfile import Profile\nfrom pstats import Stats\n\n\ndef print_func_cost():\n    def wrapper2(func):\n        def wrapper1(*args, **kwargs):\n            profiler = Profile()\n            # request = args[0]\n\n            result = profiler.runcall(func, *args, **kwargs)\n\n            stats = Stats(profiler)\n            stats.strip_dirs()\n            stats.sort_stats(\'cumulative\')\n            # stats.print_stats()\n            stats.print_callers()\n\n            return result\n        return wrapper1\n    return wrapper2`, `13204948370283299000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> cProfile <span class="token keyword">import</span> Profile\n<span class="token keyword">from</span> pstats <span class="token keyword">import</span> Stats\n\n\n<span class="token keyword">def</span> <span class="token function">print_func_cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper1</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            profiler <span class="token operator">=</span> Profile<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token comment"># request = args[0]</span>\n\n            result <span class="token operator">=</span> profiler<span class="token punctuation">.</span>runcall<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n            stats <span class="token operator">=</span> Stats<span class="token punctuation">(</span>profiler<span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>strip_dirs<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            stats<span class="token punctuation">.</span>sort_stats<span class="token punctuation">(</span><span class="token string">\'cumulative\'</span><span class="token punctuation">)</span>\n            <span class="token comment"># stats.print_stats()</span>\n            stats<span class="token punctuation">.</span>print_callers<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n            <span class="token keyword">return</span> result\n        <span class="token keyword">return</span> wrapper1\n    <span class="token keyword">return</span> wrapper2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>由以下日志可看出，内存占用较大的部分主要在 protobuf 解码，大文件读取，pypinyin，之后的优化就可以进行下去</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18602147236576540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`07:56:48 apps.py:37 INFO #1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB\n07:56:48 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 1580\'\n07:56:48 apps.py:43 INFO     b\'    data = text_format.Parse(data, DataTree())\'\n07:00:05 apps.py:33 INFO #2: 文件路径:1571: 66375.2 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:00:05 apps.py:33 INFO #8: 文件路径:1569: 2053.4 KiB\n07:00:05 apps.py:37 INFO     b&quot;data = data + open(file_path, \'r\').read()&quot;\n07:56:52 apps.py:37 INFO #5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB\n  07:56:52 apps.py:43 INFO     b\'  File &quot;文件路径&quot;, line 26\'\n07:56:52 apps.py:43 INFO     b\'    from pypinyin import lazy_pinyin\'`, `18602147236576540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">07:56:48 apps.py:37 INFO <span class="token comment">#1: /usr/local/lib/python3.6/site-packages/google/protobuf/text_format.py:682: 114541.4 KiB</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 1580\'</span>\n07:56:48 apps.py:43 INFO     b<span class="token string">\'    data = text_format.Parse(data, DataTree())\'</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#2: 文件路径:1571: 66375.2 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:00:05 apps.py:33 INFO <span class="token comment">#8: 文件路径:1569: 2053.4 KiB</span>\n07:00:05 apps.py:37 INFO     b<span class="token string">"data = data + open(file_path, \'r\').read()"</span>\n07:56:52 apps.py:37 INFO <span class="token comment">#5: /usr/local/lib/python3.6/site-packages/pypinyin/phrases_dict.py:45476: 2560.4 KiB</span>\n  07:56:52 apps.py:43 INFO     b<span class="token string">\'  File "文件路径", line 26\'</span>\n07:56:52 apps.py:43 INFO     b<span class="token string">\'    from pypinyin import lazy_pinyin\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"背景 python 的 django 后端在刚启动时内存占用上升很快，导致对应的 pod 内存溢出，很多接口响应慢 方案 需要找到哪行代码导致的内存泄漏，有以下方案 pympler scalene  (python3.8 以上，不符合) memray  (python3.…",timeToRead:3,tableOfContents:'<ul>\n<li><a href="/python-backend-oom-process/#%E8%83%8C%E6%99%AF">背景</a></li>\n<li><a href="/python-backend-oom-process/#%E6%96%B9%E6%A1%88">方案</a></li>\n<li>\n<p><a href="/python-backend-oom-process/#%E5%AE%9E%E7%8E%B0">实现</a></p>\n<ul>\n<li><a href="/python-backend-oom-process/#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E6%A3%80%E6%B5%8B">内存占用检测</a></li>\n<li><a href="/python-backend-oom-process/#%E8%80%97%E6%97%B6%E6%A3%80%E6%B5%8B">耗时检测</a></li>\n</ul>\n</li>\n<li><a href="/python-backend-oom-process/#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA">效果展示</a></li>\n</ul>',wordCount:{words:70},frontmatter:{date:"2023-11-30 17:46:51",path:"/python-backend-oom-process/",tags:"后端, python, 预研",title:"Python 后端 oom 处理过程",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu 系统下却正常显示（右侧），如下图所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 324px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.1358024691358%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACWElEQVQozz2SWU9TARCF77/0RR80MYawxBaUfW2lUiWllKVFKQSoFJTFaqkgmwgCSgCxRaCAQpe7dW8pxWg+ryHx4cuZzGTOyzlCbVMdhkcN2LvMWNtqsD+pZKTjAVNd5czadXwermKr7y6Hcw7S2QyZeJRUXCKhRokrETIphWxaJZtSSSdlBHHeyvG7DvZ9NjZetrHoMuFxGnH3NDLUWceYw4jFUMKEu5/LyxzpXJxUOkYsoaAmZLL5lEaafCFLrpBByL9vhBUDrLfBjg32nXA0BieTcOrR1AvBaXIna6iiSDawQ/IwQOLAr6lf0z2SR37tHiAb/IbwuKkMU0MRlpZi7KZSBs3FvOmtYNFZxdpQLYFJI2FPE/KuR3s+JOQaJNFjIu9oIGer5sKi4+KpnrzpHvmamwjSro/gRzfbvj5WxtvxOpt57WxlpKuBbpMOi1FP08PbjL54RuHnKT+e20m2V3PpqCc/YKQwZKbg7uRqysHVmA3h98kynH8AcR3ULxqb2rwKZwtw7OPq+1uyWy7EvXnCx0HU7Q3kT0soy3PE15cR/XtE9veRAgEiAT+CuUXPgK2R/vYKRq0VeB2VrA7X8/WVgbOZNmJLVn5t2skdLBAJnRFSRM4ViZAqEY7LnMcVQhqSRlgLSjgaKeHIXc6msxRvdxnDFj09WnX+VchqrqO1WU9LbRETY04y6SQxKUxCiV6jilp1oihyhJh8vRM6zLW4LPfZGNAhjxfB9C2YvMGfqTtczFSSnGvldLSEw9leEqk0STVCMib9J66ZKpqZLEWQxBB/AQBvSOSbuQBPAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 11 28 17 00 49" title="" data-src="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png" data-srcset="/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-6752f.png 200w,\n/static/2023-11-28-17-00-49-8eed1f43729ab0534e4ba15a630ed339-16a51.png 324w" data-sizes="(max-width: 324px) 100vw, 324px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h1>\n<p>红点是由 <a href="https://lbs.amap.com/api/javascript-api-v2/documentation#circlemarker" target="_blank" rel="nofollow noreferrer noopener">CircleMarker</a> 组件实现，而下面的线则是 <a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/mass-data/pathsimplifier" target="_blank" rel="nofollow noreferrer noopener">PathSimplifier</a> 实现，在 chrome 浏览器下不同系统的表现为：</p>\n<ol>\n<li>window: CircleMarker 由 canvas 渲染，且层级和高德地图图层一致，而 PathSimplifier 的层级比高德地图图层要高</li>\n<li>ubuntu: CircleMarker 由 svg 渲染，层级比 PathSimplifier 要高</li>\n</ol>\n<h1 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h1>\n<p>综上所述，需要统一不同系统下的渲染方式，优缺点对比如下</p>\n<table>\n<thead>\n<tr>\n<th align="center">渲染方式</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">canvas</td>\n<td align="center">性能好</td>\n<td align="center">实现成本高，即需要生成比 PathSimplifier 所在层级要高的新图层</td>\n</tr>\n<tr>\n<td align="center">svg</td>\n<td align="center">实现方便，有现成的 \n<a href="https://lbs.amap.com/api/amap-ui/reference-amap-ui/overlay/svgmarker" target="_blank" rel="nofollow noreferrer noopener">SvgMarker</a></td>\n<td align="center">性能差，但对于这个场景来说只需要鼠标悬浮上去才渲染一条路线上的点，即性能要求不高</td>\n</tr>\n</tbody>\n</table>\n<p>最终采用 SvgMarker 渲染</p>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>以下都在 chrome 浏览器下测试：</p>\n<h2 id="修复前"><a href="#%E4%BF%AE%E5%A4%8D%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复前</h2>\n<p>windows 下不能正常显示，ubuntu 正常</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x86xtf?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="修复后"><a href="#%E4%BF%AE%E5%A4%8D%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复后</h2>\n<p>windows、ubuntu 都能正常显示</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/9cpd4v?codemirror=1&amp;hidenavigation=1&amp;module=%2Fsrc%2Fcomponents%2FReactAmap%2Fhooks%2FuseDrawPoints.js&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>',excerpt:"背景 在 chrome 浏览器上，用高德地图的 CircleMarker, PathSimplifier 分别画点和线时候，需要实现点在线的上面的效果，此时在 windows 系统上不能正常显示红点（左侧），在 ubuntu…",frontmatter:{date:"2023-11-28 16:55:48",path:"/amap-browser-compatibility/",tags:"前端, 地图, 预研",title:"记一次处理高德地图浏览器兼容性问题",draft:null}},prePost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91492669752188010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Uncaught ChunkLoadError: Loading chunk <CHUNK_NAME> failed.\n(error: <WEBSITE_PATH>/<CHUNK_NAME>-<CHUNK_HASH>.js)`, `91492669752188010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Uncaught ChunkLoadError: Loading chunk <span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span> failed.\n<span class="token punctuation">(</span>error: <span class="token operator">&lt;</span>WEBSITE_PATH<span class="token operator">></span>/<span class="token operator">&lt;</span>CHUNK_NAME<span class="token operator">></span>-<span class="token operator">&lt;</span>CHUNK_HASH<span class="token operator">></span>.js<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="原因与方案"><a href="#%E5%8E%9F%E5%9B%A0%E4%B8%8E%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因与方案</h1>\n<p>由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash）来更新</p>\n<p>所以在部署期间或者用户没有长时间打开网页，可能会请求已被删除的对应的 chunk 或者 chunk 虽然路径，文件名没变，但是内容改变导致有概率的白屏，所以针对此情况，有以下方案</p>\n<ol>\n<li>缓存所有版本的文件，但会造成空间浪费</li>\n<li>对打包出来的文件都不做缓存，但对服务器有很大压力</li>\n<li>可以通过一个 websocket 链接或者轮询来主动告知浏览器更新版本，但此方案过于繁重且需要后端支持</li>\n<li>对报错的文件重试，超过一定次数白屏，或者主动告知用户刷新页面</li>\n</ol>\n<p>综上，采用方案 4</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<p>对于方案 4，同样有 2 大类，编译时或运行时，选型对比如下</p>\n<table>\n  <thead>\n    <tr>\n      <th>类型</th>\n      <th>序号</th>\n      <th>选型</th>\n      <th>优点</th>\n      <th>缺点</th>\n   </tr>\n   </thead>\n  <tbody>\n   <tr>\n      <td rowspan="2">运行时</td>\n      <td>1</td>\n      <td>\n         <a href="https://github.com/Nikaple/assets-retry" target="_blank">assets-retry</a> 以及 <a href="https://github.com/Nikaple/assets-retry/blob/master/README-cn.md" target="_blank">原理</a>\n      </td>\n      <td>接入简单</td>\n      <td>重试的元素种类太多，对于白屏问题，只需要保证 js 需要重试</td>\n   </tr>\n   <tr>\n      <td>2</td>\n      <td>\n         重写 react lazy 方法，对报错进行重试\n      </td>\n      <td>实现简单</td>\n      <td>\n         <ol>\n            <li>\n               不能监听到主入口的报错，需要用 window.error 补齐\n            </li>\n            <li>\n               需要改动原始代码\n            </li>\n            <li>\n               由于 webpack 的 chunk 加载机制，失败的 chunk 不能重试，原理见上面\n            </li>\n         </ol>\n      </td>\n    </tr>\n    <tr>\n      <td rowspan="2">编译时</td>\n      <td>3</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a>\n      </td>\n      <td>\n         接入简单，很方便的实现 chunk 重试\n      </td>\n      <td>\n         不能让主入口报错重试\n      </td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>\n         <a href="https://github.com/mattlewis92/webpack-retry-chunk-load-plugin" target="_blank">webpack-retry-chunk-load-plugin</a> 以及\n         <a href="https://gist.github.com/mishani0x0ef/b15a969c016fa01b85f413b712c40fa1" target="_blank">html-tag-attributes-plugin</a>\n      </td>\n      <td>\n         接入简单\n      </td>\n      <td>\n         需要自己实现主入口报错重试逻辑\n      </td>\n    </tr>\n   </tbody>\n</table>\n<p>其他参考链接如下:</p>\n<ol>\n<li><a href="https://dev.to/igor_bykov/handle-loading-errors-fallback-with-htmlwebpackplugin-2d31" target="_blank" rel="nofollow noreferrer noopener">handle-loading-errors-fallback-with-htmlwebpackplugin</a></li>\n<li><a href="https://baijiahao.baidu.com/s?id=1776343703094638001&#x26;wfr=spider&#x26;for=pc" target="_blank" rel="nofollow noreferrer noopener">如何解决 JS 脚本加载失败的问题</a></li>\n<li><a href="https://stackoverflow.com/questions/69047420/webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e" target="_blank" rel="nofollow noreferrer noopener">webpack-code-splitting-chunkloaderror-loading-chunk-x-failed-but-the-chunk-e</a></li>\n</ol>\n<p>最终采用选型 4</p>\n<h1 id="实现过程"><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现过程</h1>\n<p>预研过程包含选型 2 与 4，注意这里的重试需要有间隔时间以及需要带额外的 <code class="language-text">?</code> 参数防止缓存生效</p>\n<h2 id="重写-react-lazy-方法"><a href="#%E9%87%8D%E5%86%99-react-lazy-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重写 react lazy 方法</h2>\n<p>使用时可以直接替代 react 的 lazy 方法，但由于上面提到的缺点不采用此方案</p>\n<p>importRetry.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62027649718883434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import * as React from \'react\';\n\nconst noop = () => {};\nconst strategies = {\n   PARSE_ERROR_MESSAGE: (error, _) => {\n      const url = new URL(error.request);\n      return url.href;\n   }\n};\n\nconst defaultOpts = {\n   strategy: \'PARSE_ERROR_MESSAGE\',\n   importFunction: (path) => import(/* @vite-ignore */ path),\n   logger: noop\n};\n\n/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */\n// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts\nfunction createDynamicImportWithRetry(maxRetries, opts = {}) {\n   const resolvedOpts = {\n      ...defaultOpts,\n      ...opts\n   };\n   const { logger, importFunction, strategy } = resolvedOpts;\n\n   return async (importer) => {\n      try {\n         return await importer();\n      } catch (error) {\n         logger(Date.now(), \\`Importing failed: \\`, error);\n\n         const modulePath = strategies[strategy](error, importer);\n         logger(\\`Parsed url using \\${strategy}:\\${modulePath}\\`);\n\n         if (!modulePath) {\n            logger(\'Unable to determine path to module when trying to reload\');\n            // nothing we can do ...\n            throw error;\n         }\n\n         // retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)\n         //\n         for (let i = -1; i < maxRetries; i++) {\n            // add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)\n            let cacheBustedPath = \\`\\${modulePath}?t=\\${+new Date()}\\`;\n            logger(Date.now(), \\`Trying re-import module using cache busted path: \\${cacheBustedPath}\\`);\n\n            try {\n               return await importFunction(cacheBustedPath);\n            } catch (e) {\n               logger(\\`Import for \\${cacheBustedPath} failed\\`);\n               await new Promise((resolve) => setTimeout(resolve, 1000 * 2 ** i));\n            }\n         }\n         throw error;\n      }\n   };\n}\n\nconst MAX_RETRY_COUNT = 5;\n\nconst defaultDynamicImportWithRetry = createDynamicImportWithRetry(MAX_RETRY_COUNT, {\n   logger: console.log\n});\n\nexport function lazy(importer) {\n   return process.env.NODE_ENV === \'development\'\n      ? React.lazy\n      : React.lazy(() => defaultDynamicImportWithRetry(importer));\n}`, `62027649718883434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> strategies <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">PARSE_ERROR_MESSAGE</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> url<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n   strategy<span class="token punctuation">:</span> <span class="token string">\'PARSE_ERROR_MESSAGE\'</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">importFunction</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* @vite-ignore */</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span>\n   logger<span class="token punctuation">:</span> noop\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * Future improvements:\n * - cache successful variations to skip unnecessary lag on subsequent reloads\n */</span>\n<span class="token comment">// https://github.com/fatso83/retry-dynamic-import/blob/main/lib/retry.ts</span>\n<span class="token keyword">function</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token parameter">maxRetries<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> resolvedOpts <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultOpts<span class="token punctuation">,</span>\n      <span class="token operator">...</span>opts\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> logger<span class="token punctuation">,</span> importFunction<span class="token punctuation">,</span> strategy <span class="token punctuation">}</span> <span class="token operator">=</span> resolvedOpts<span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Importing failed: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">const</span> modulePath <span class="token operator">=</span> strategies<span class="token punctuation">[</span>strategy<span class="token punctuation">]</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Parsed url using </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>strategy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">\'Unable to determine path to module when trying to reload\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// nothing we can do ...</span>\n            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// retry x times with 2 second delay base and backoff factor of 2 (1/2, 1, 2, 4, 8 seconds)</span>\n         <span class="token comment">//</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// add a timestamp to the url to force a reload the module (and not use the cached version - cache busting)</span>\n            <span class="token keyword">let</span> cacheBustedPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n            <span class="token function">logger</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Trying re-import module using cache busted path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">importFunction</span><span class="token punctuation">(</span>cacheBustedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token function">logger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Import for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cacheBustedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">**</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">throw</span> error<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_RETRY_COUNT</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> defaultDynamicImportWithRetry <span class="token operator">=</span> <span class="token function">createDynamicImportWithRetry</span><span class="token punctuation">(</span><span class="token constant">MAX_RETRY_COUNT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   logger<span class="token punctuation">:</span> console<span class="token punctuation">.</span>log\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span>\n      <span class="token operator">?</span> React<span class="token punctuation">.</span>lazy\n      <span class="token punctuation">:</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">defaultDynamicImportWithRetry</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="webpack-retry-chunk-load-plugin--html-tag-attributes-plugin"><a href="#webpack-retry-chunk-load-plugin--html-tag-attributes-plugin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack-retry-chunk-load-plugin + html-tag-attributes-plugin</h2>\n<p>plugins/html-tag-attributes-plugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59356928024636390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n\n// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events\nclass HtmlTagAttributesPlugin {\n   static name = \'HtmlTagAttributesPlugin\';\n\n   constructor(options) {\n      const defaultOptions = {\n         script: {}\n      };\n\n      this.options = { ...defaultOptions, ...options };\n   }\n\n   apply(compiler) {\n      compiler.hooks.compilation.tap(HtmlTagAttributesPlugin.name, (compilation) =>\n         this._hookIntoHtmlAlterAssetTags(compilation)\n      );\n   }\n\n   _hookIntoHtmlAlterAssetTags(compilation) {\n      HtmlWebpackPlugin.getHooks(compilation).alterAssetTags.tapAsync(HtmlTagAttributesPlugin.name, (data, cb) =>\n         cb(null, this._extendScriptTags(data))\n      );\n   }\n\n   _extendScriptTags(data) {\n      data.assetTags.scripts = data.assetTags.scripts.map(({ attributes, ...other }) => ({\n         ...other,\n         attributes: {\n            ...attributes,\n            ...this.options.script\n         }\n      }));\n\n      return data;\n   }\n}\n\nmodule.exports = { HtmlTagAttributesPlugin };`, `59356928024636390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// For more information about plugin concepts, see: https://github.com/jantimon/html-webpack-plugin#events</span>\n<span class="token keyword">class</span> <span class="token class-name">HtmlTagAttributesPlugin</span> <span class="token punctuation">{</span>\n   <span class="token keyword">static</span> name <span class="token operator">=</span> <span class="token string">\'HtmlTagAttributesPlugin\'</span><span class="token punctuation">;</span>\n\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_hookIntoHtmlAlterAssetTags</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>alterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>HtmlTagAttributesPlugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n         <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_extendScriptTags</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">_extendScriptTags</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts <span class="token operator">=</span> data<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> attributes<span class="token punctuation">,</span> <span class="token operator">...</span>other <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token operator">...</span>other<span class="token punctuation">,</span>\n         attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span>attributes<span class="token punctuation">,</span>\n            <span class="token operator">...</span>this<span class="token punctuation">.</span>options<span class="token punctuation">.</span>script\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> data<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78286742248866510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { RetryChunkLoadPlugin } = require(\'webpack-retry-chunk-load-plugin\');\nconst { HtmlTagAttributesPlugin } = require(\'./plugins/html-tag-attributes-plugin\');\n\nconst lastResortScript = &quot;window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);&quot;;\nconst retryDelay = 4000;\nconst maxRetries = 5;\n\nconst isProd = env === \'production\';\n\nconst localConfig = override(\n   isProd &&\n      addWebpackPlugin(\n         new RetryChunkLoadPlugin({\n            // optional stringified function to get the cache busting query string appended to the script src\n            // if not set will default to appending the string \\`?cache-bust=true\\`\n            cacheBust: \\`function() {\n              return Date.now();\n            }\\`,\n            // optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0\n            // if string, value must be code to generate a delay value. Receives retryCount as argument\n            // e.g. \\`function(retryAttempt) { return retryAttempt * 1000 }\\`\n            retryDelay,\n            // optional value to set the maximum number of retries to load the chunk. Default is 1\n            maxRetries,\n            // // optional list of chunks to which retry script should be injected\n            // // if not set will add retry script to all chunks that have webpack script loading\n            // chunks: [\'chunkName\'],\n            // optional code to be executed in the browser context if after all retries chunk is not loaded.\n            // if not set - nothing will happen and error will be returned to the chunk loader.\n            lastResortScript\n         })\n      ),\n   isProd &&\n      addWebpackPlugin(\n         new HtmlTagAttributesPlugin({\n            script: {\n               onerror: \\`\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, \\${retryDelay}))\n                      if (retryCount === \\${maxRetries}) {\n                        \\${lastResortScript}\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              \\`\n            }\n         })\n      )\n);`, `78286742248866510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> RetryChunkLoadPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-retry-chunk-load-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> HtmlTagAttributesPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/html-tag-attributes-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> lastResortScript <span class="token operator">=</span> <span class="token string">"window.alert(\'Frontend Is Deploying, Please Wait!\'); window.location.reload(true);"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> retryDelay <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">RetryChunkLoadPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// optional stringified function to get the cache busting query string appended to the script src</span>\n            <span class="token comment">// if not set will default to appending the string `?cache-bust=true`</span>\n            cacheBust<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function() {\n              return Date.now();\n            }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the amount of time in milliseconds before trying to load the chunk again. Default is 0</span>\n            <span class="token comment">// if string, value must be code to generate a delay value. Receives retryCount as argument</span>\n            <span class="token comment">// e.g. `function(retryAttempt) { return retryAttempt * 1000 }`</span>\n            retryDelay<span class="token punctuation">,</span>\n            <span class="token comment">// optional value to set the maximum number of retries to load the chunk. Default is 1</span>\n            maxRetries<span class="token punctuation">,</span>\n            <span class="token comment">// // optional list of chunks to which retry script should be injected</span>\n            <span class="token comment">// // if not set will add retry script to all chunks that have webpack script loading</span>\n            <span class="token comment">// chunks: [\'chunkName\'],</span>\n            <span class="token comment">// optional code to be executed in the browser context if after all retries chunk is not loaded.</span>\n            <span class="token comment">// if not set - nothing will happen and error will be returned to the chunk loader.</span>\n            lastResortScript\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n   isProd <span class="token operator">&amp;&amp;</span>\n      <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n         <span class="token keyword">new</span> <span class="token class-name">HtmlTagAttributesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            script<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               onerror<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n                // const isAsyncScript = event.target.defer || event.target.async\n                // 暂时不包含对同步脚本的处理\n                let retryCount = 0\n                const retryFunc = async () => {\n                  retryCount++\n                  let cacheBustedPath = event.target.src + \'?t=\' + (+new Date())\n                    const script = document.createElement(\'script\')\n                    script.src = cacheBustedPath\n                    script.onerror = async () => {\n                      await new Promise(resolve => setTimeout(resolve, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryDelay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))\n                      if (retryCount === </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) {\n                        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastResortScript<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n                      } else {\n                        retryFunc()\n                      }\n                    }\n                    // webpack nonce for csp\n                    const originalNonce = event.target.getAttribute(\'nonce\')\n                    if (originalNonce) {\n                        script.setAttribute(\'nonce\', originalNonce)\n                    }\n                    document.getElementsByTagName(\'head\')[0].appendChild(script)\n                }\n\n                retryFunc()\n              </span><span class="token template-punctuation string">`</span></span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<p>在主入口的 js 以及分包后的 chunk 报错后都会做重试 5 次的操作，超过 5 次弹窗提示用户在部署，点击确定后刷新页面再次重试</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.06810035842294%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABUklEQVQ4y6WS3U6EMBCFef/X8Fm89MobY9wNYpbfAi30n4XjdDZrNGrM4iQn0yHk6zltM601xlFCSsldTRNSndQZ97kHtpXnbdsu33uNp5ccefGGsm5wqho0neBeU8/WdeWfrzqvCXDGY+lw96C+AScTIMQAYy0rLgusdYgx8szAn0SID9BVqaxx8D7wxjEuCCHCec/yISDDL7Wy2y0RvwBn1aMoco5bkTrRo+06iH7gdfbZwV9KtTiFuiwI0vOZB3KV7sE6B2PM7cBgJSoGCnLVM2SeZ2ju+nZgdBJlAlI8qRS/jtTThSTw7UAjIU6vkAQMziLQ7Wp6apZiG73DYVASMT9gaWrEcUDUM4IcEWgddgHJYVsc0bcdpnG8iGKb+R8OTX6EJYdOCLhhYPndDieFQMDYNohDz7E5Mm0U9jwbTxB7eIarK7iuJXc0E5wdU/R3tY72ZhqkSJAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 12 05 11 29 43" title="" data-src="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png" data-srcset="/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a67b7.png 200w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-0b187.png 400w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-fee1c.png 800w,\n/static/2023-12-05-11-29-43-f7fbec7ad07fe7e42ef5d3622f3019ab-a01e8.png 1116w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
excerpt:"背景 在线上部署期间，或者用户长时间没有访问网页等等各种情况，有一定概率会出现以下形式的报错，导致网页白屏 原因与方案 由于现代前端工具链打包出来的，尤其是 webpack 的项目，其主入口默认不缓存，其他文件长期缓存，缓存的文件通过改变文件名（一般是 hash…",frontmatter:{date:"2023-11-30 17:47:38",path:"/cache-error-retry-process/",tags:"前端, 预研, webpack, 前端构建工具",title:"缓存报错重试机制探究",draft:null}}},pathContext:{mainPostPath:"/python-backend-oom-process/",nextPostPath:"/amap-browser-compatibility/",prePostPath:"/cache-error-retry-process/"}}}});