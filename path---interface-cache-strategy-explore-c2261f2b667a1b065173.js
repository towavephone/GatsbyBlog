webpackJsonp([0xe5e4becc3f34],{1292:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>由于有些接口响应时间较长，在接口不需要频繁更新的情况下可以对其进行缓存</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<p>cache_tool.py</p>\n<p>实现装饰器缓存函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61913659783781564000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import hashlib\nimport json\nimport logging\nimport time\n\nfrom cacheout import Cache\nfrom controllers.wrapper import get_post_param\nfrom tools import redis_tool\n\nQueue_Cache = Cache(maxsize=1024, ttl=300, timer=time.time, default=None)\n\n\ndef cache_request(is_with_cache_param=False, cache_type=&quot;cache&quot;, ttl=300):\n    &quot;&quot;&quot;\n    _summary_.\n\n    Args:\n        is_with_cache_param (bool, optional): 是否携带缓存参数，默认为 False\n    &quot;&quot;&quot;\n\n    def wrapper2(func):\n        if cache_type == &quot;cache&quot;:\n            queue_cache = Cache(maxsize=1024, ttl=ttl, timer=time.time, default=None)\n\n        def wrapper1(*args, **kwargs):\n            request = args[0]\n            is_not_cache = get_post_param(\n                request, &quot;is_not_cache&quot;, default=&quot;0&quot;, type=int\n            )\n\n            # 如果携带缓存参数为真且 is_not_cache 为真，则不使用缓存\n            # 除了以上情况，默认使用缓存\n            if is_with_cache_param and is_not_cache:\n                result = func(*args, **kwargs)\n\n            prefix = f&quot;{func.__module__}.{func.__name__}:&quot;\n            key = prefix + hashlib.md5(str(request.POST.dict()).encode()).hexdigest()\n            logging.debug(\n                &quot;cache_request key %s, params %s&quot;,\n                key,\n                str(request.POST.dict()).encode(&quot;utf-8&quot;),\n            )\n\n            result = None\n\n            if cache_type == &quot;cache&quot;:\n                result = queue_cache.get(key)\n            elif cache_type == &quot;redis&quot;:\n                cache_result = redis_tool.get(key)\n                if cache_result:\n                    result = json.loads(cache_result)\n\n            if not result:\n                result = func(*args, **kwargs)\n\n                if cache_type == &quot;cache&quot;:\n                    queue_cache.set(key, result)\n                elif cache_type == &quot;redis&quot;:\n                    redis_tool.setex(key, ttl, json.dumps(result))\n\n            return result\n\n        return wrapper1\n\n    return wrapper2`, `61913659783781564000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> hashlib\n<span class="token keyword">import</span> json\n<span class="token keyword">import</span> logging\n<span class="token keyword">import</span> time\n\n<span class="token keyword">from</span> cacheout <span class="token keyword">import</span> Cache\n<span class="token keyword">from</span> controllers<span class="token punctuation">.</span>wrapper <span class="token keyword">import</span> get_post_param\n<span class="token keyword">from</span> tools <span class="token keyword">import</span> redis_tool\n\nQueue_Cache <span class="token operator">=</span> Cache<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> timer<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">cache_request</span><span class="token punctuation">(</span>is_with_cache_param<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> cache_type<span class="token operator">=</span><span class="token string">"cache"</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""\n    _summary_.\n\n    Args:\n        is_with_cache_param (bool, optional): 是否携带缓存参数，默认为 False\n    """</span>\n\n    <span class="token keyword">def</span> <span class="token function">wrapper2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> cache_type <span class="token operator">==</span> <span class="token string">"cache"</span><span class="token punctuation">:</span>\n            queue_cache <span class="token operator">=</span> Cache<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span>ttl<span class="token punctuation">,</span> timer<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">def</span> <span class="token function">wrapper1</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            request <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n            is_not_cache <span class="token operator">=</span> get_post_param<span class="token punctuation">(</span>\n                request<span class="token punctuation">,</span> <span class="token string">"is_not_cache"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span>\n            <span class="token punctuation">)</span>\n\n            <span class="token comment"># 如果携带缓存参数为真且 is_not_cache 为真，则不使用缓存</span>\n            <span class="token comment"># 除了以上情况，默认使用缓存</span>\n            <span class="token keyword">if</span> is_with_cache_param <span class="token keyword">and</span> is_not_cache<span class="token punctuation">:</span>\n                result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n            prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__module__<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">:"</span></span>\n            key <span class="token operator">=</span> prefix <span class="token operator">+</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>\n                <span class="token string">"cache_request key %s, params %s"</span><span class="token punctuation">,</span>\n                key<span class="token punctuation">,</span>\n                <span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">)</span>\n\n            result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n            <span class="token keyword">if</span> cache_type <span class="token operator">==</span> <span class="token string">"cache"</span><span class="token punctuation">:</span>\n                result <span class="token operator">=</span> queue_cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n            <span class="token keyword">elif</span> cache_type <span class="token operator">==</span> <span class="token string">"redis"</span><span class="token punctuation">:</span>\n                cache_result <span class="token operator">=</span> redis_tool<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n                <span class="token keyword">if</span> cache_result<span class="token punctuation">:</span>\n                    result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cache_result<span class="token punctuation">)</span>\n\n            <span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n                result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n                <span class="token keyword">if</span> cache_type <span class="token operator">==</span> <span class="token string">"cache"</span><span class="token punctuation">:</span>\n                    queue_cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">)</span>\n                <span class="token keyword">elif</span> cache_type <span class="token operator">==</span> <span class="token string">"redis"</span><span class="token punctuation">:</span>\n                    redis_tool<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n            <span class="token keyword">return</span> result\n\n        <span class="token keyword">return</span> wrapper1\n\n    <span class="token keyword">return</span> wrapper2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>redis_tool.py</p>\n<p>实现删除某个接口的所有缓存结果，这里使用了 redis 的 scan 方法，因为是顺序扫描效率很低，数据量大的时候比较慢</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20333791398547720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@retry_on_redis_error()\ndef scan(pattern, count=100000):\n    itcl = IntervalTimeCostLogging(func_name=&quot;scan&quot;, enable_call=True)\n    cursor = 0\n    result = []\n    index = 0\n    # 这里全量扫描耗时太长，有 20 秒，有 80 万条数据（2025-03-28 16:07:10），暂时只扫描 10 万个\n    while True:\n        cursor, keys = _get_client().scan(cursor, pattern, count=count)\n        itcl.mark(f&quot;scan_from_{index}_to_{index + count}_keys_count_{len(keys)}&quot;)\n        result += keys\n        #   if cursor == 0 or index == 0:  # 这里临时提前终止\n        #       break\n        index += count\n\n    itcl.logging_cost()\n\n    logging.debug(f&quot;Scan keys: {result}&quot;)\n    return cursor, result\n\n@retry_on_redis_error()\ndef delete(key: str):\n    res = _get_client().delete(key)\n    logging.debug(&quot;Delete %s [%s]&quot;, key, res and &quot;hit&quot; or &quot;miss&quot;)\n    return res\n\n@retry_on_redis_error()\ndef delete_scan(pattern):\n    _, keys = scan(pattern)\n    for key in keys:\n        delete(key)`, `20333791398547720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@retry_on_redis_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">scan</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    itcl <span class="token operator">=</span> IntervalTimeCostLogging<span class="token punctuation">(</span>func_name<span class="token operator">=</span><span class="token string">"scan"</span><span class="token punctuation">,</span> enable_call<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    cursor <span class="token operator">=</span> <span class="token number">0</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    index <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token comment"># 这里全量扫描耗时太长，有 20 秒，有 80 万条数据（2025-03-28 16:07:10），暂时只扫描 10 万个</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        cursor<span class="token punctuation">,</span> keys <span class="token operator">=</span> _get_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scan<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> count<span class="token operator">=</span>count<span class="token punctuation">)</span>\n        itcl<span class="token punctuation">.</span>mark<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"scan_from_</span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string">_to_</span><span class="token interpolation"><span class="token punctuation">{</span>index <span class="token operator">+</span> count<span class="token punctuation">}</span></span><span class="token string">_keys_count_</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">+=</span> keys\n        <span class="token comment">#   if cursor == 0 or index == 0:  # 这里临时提前终止</span>\n        <span class="token comment">#       break</span>\n        index <span class="token operator">+=</span> count\n\n    itcl<span class="token punctuation">.</span>logging_cost<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Scan keys: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> cursor<span class="token punctuation">,</span> result\n\n@retry_on_redis_error<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    res <span class="token operator">=</span> _get_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Delete %s [%s]"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> res <span class="token keyword">and</span> <span class="token string">"hit"</span> <span class="token keyword">or</span> <span class="token string">"miss"</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> res\n\n@retry_on_redis_error<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">delete_scan</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    _<span class="token punctuation">,</span> keys <span class="token operator">=</span> scan<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n        delete<span class="token punctuation">(</span>key<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40615233016694740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 需要缓存的接口\n@request_wrapper()\n@cache_tool.cache_request(\n    cache_type=&quot;redis&quot;, is_with_cache_param=True\n)  # 作用：根据参数缓存响应结果\ndef get_list(request):\n    pass\n\n\n# 需要删除上面接口的缓存，比如在更新时候需要删除缓存以便拿到最新结果\n@request_wrapper()\ndef update(request):\n    # 重置缓存\n    redis_tool.delete_scan(\n        &quot;接口路径.get_list:*&quot;\n    )`, `40615233016694740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 需要缓存的接口</span>\n<span class="token decorator annotation punctuation">@request_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n@cache_tool<span class="token punctuation">.</span>cache_request<span class="token punctuation">(</span>\n    cache_type<span class="token operator">=</span><span class="token string">"redis"</span><span class="token punctuation">,</span> is_with_cache_param<span class="token operator">=</span><span class="token boolean">True</span>\n<span class="token punctuation">)</span>  <span class="token comment"># 作用：根据参数缓存响应结果</span>\n<span class="token keyword">def</span> <span class="token function">get_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token comment"># 需要删除上面接口的缓存，比如在更新时候需要删除缓存以便拿到最新结果</span>\n<span class="token decorator annotation punctuation">@request_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 重置缓存</span>\n    redis_tool<span class="token punctuation">.</span>delete_scan<span class="token punctuation">(</span>\n        <span class="token string">"接口路径.get_list:*"</span>\n    <span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="缓存失效优化"><a href="#%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存失效优化</h1>\n<p>由于上面实现模糊匹配删除缓存 key 即 redis scan 时间过长，需要转换思路通过递增数据版本号来使缓存失效，避免性能问题</p>\n<p>cache_tool.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89806440014783760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# cache_tool.py（摘取并替换 redis 分支相关部分）\nversion_key = f&quot;version:{func.__module__}.{func.__name__}&quot;\nversion = &quot;0&quot;\nif cache_type == &quot;redis&quot;:\n    v = redis_tool.get(version_key)\n    if v:\n        version = v.decode() if isinstance(v, bytes) else str(v)\n\n# 旧的 key 生成： prefix + md5(...) 改成带版本\nkey = f&quot;{prefix}{version}:{hashlib.md5(str(request.POST.dict()).encode()).hexdigest()}&quot;\n\n# 后续正常读写 redis（setex/get）即可`, `89806440014783760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># cache_tool.py（摘取并替换 redis 分支相关部分）</span>\nversion_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"version:</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__module__<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">"</span></span>\nversion <span class="token operator">=</span> <span class="token string">"0"</span>\n<span class="token keyword">if</span> cache_type <span class="token operator">==</span> <span class="token string">"redis"</span><span class="token punctuation">:</span>\n    v <span class="token operator">=</span> redis_tool<span class="token punctuation">.</span>get<span class="token punctuation">(</span>version_key<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> v<span class="token punctuation">:</span>\n        version <span class="token operator">=</span> v<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">str</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>\n\n<span class="token comment"># 旧的 key 生成： prefix + md5(...) 改成带版本</span>\nkey <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>version<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>\n\n<span class="token comment"># 后续正常读写 redis（setex/get）即可</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>redis_tool.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93711071577101900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@retry_on_redis_error()\ndef incr(key: str):\n    # 返回递增后的 int 值\n    return _get_client().incr(key)`, `93711071577101900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@retry_on_redis_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">incr</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 返回递增后的 int 值</span>\n    <span class="token keyword">return</span> _get_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>incr<span class="token punctuation">(</span>key<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69817998881627940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@request_wrapper()\ndef update(request):\n    # ... 执行更新数据库的操作 ...\n\n    # 旧做法：redis_tool.delete_scan(&quot;接口路径.get_list:*&quot;)  # 慢\n    # 新做法：递增版本号\n    redis_tool.incr(&quot;version:接口路径.get_list&quot;)`, `69817998881627940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@request_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># ... 执行更新数据库的操作 ...</span>\n\n    <span class="token comment"># 旧做法：redis_tool.delete_scan("接口路径.get_list:*")  # 慢</span>\n    <span class="token comment"># 新做法：递增版本号</span>\n    redis_tool<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">"version:接口路径.get_list"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h1>\n<h2 id="耗时打印"><a href="#%E8%80%97%E6%97%B6%E6%89%93%E5%8D%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>耗时打印</h2>\n<p>实现耗时日志的打印，方便打印每块代码区间的耗时</p>\n<h3 id="实现-1"><a href="#%E5%AE%9E%E7%8E%B0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="821355252086442000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import logging\nimport time\n\nfrom pydash import py_\n\n\nclass IntervalTimeCostLogging:\n    def __init__(\n        self,\n        enable=False,\n        enable_call=False,\n        enable_cost=False,\n        func_name=&quot;&quot;,\n    ):\n        self.enable_call = enable_call\n        self.enable_cost = enable_cost\n\n        if enable:\n            self.enable_call = True\n            self.enable_cost = True\n\n        self.func_name = func_name\n        self.last_time = time.time()\n        self.total_time = 0\n        self.log_list = []\n\n    def mark(self, name):\n        if not self.enable_call and not self.enable_cost:\n            return\n\n        current_time = time.time()\n        elapsed_ms = (current_time - self.last_time) * 1000\n        self.total_time += elapsed_ms\n        log = f&quot;函数名称: {self.func_name}, 区间 {name} 耗时: {elapsed_ms:.2f}ms, 累积耗时: {self.total_time:.2f}ms&quot;\n        if self.enable_call:\n            logging.debug(log)\n        self.log_list.append(\n            {\n                &quot;name&quot;: name,\n                &quot;elapsed_ms&quot;: elapsed_ms,\n                &quot;total_time&quot;: self.total_time,\n            }\n        )\n        self.last_time = current_time\n\n    def logging_cost(self):\n        if not self.enable_cost:\n            return\n        from tabulate import tabulate\n\n        self.log_list.sort(key=lambda x: x[&quot;elapsed_ms&quot;], reverse=True)\n        data = []\n        for item in self.log_list:\n            data.append([item[&quot;name&quot;], item[&quot;elapsed_ms&quot;], item[&quot;total_time&quot;]])\n        table = tabulate(\n            data,\n            [&quot;区间名称&quot;, &quot;区间耗时(ms)&quot;, &quot;累积耗时(ms)&quot;],\n            tablefmt=&quot;grid&quot;,\n            numalign=&quot;right&quot;,\n        )\n        logging.debug(f&quot;函数名称：{self.func_name} 花费时间按区间耗时倒序: \\n{table}&quot;)\n\n\ndef test():\n    timer = IntervalTimeCostLogging(enable=True, func_name=&quot;test&quot;)\n\n    # 模拟一些操作\n    time.sleep(0.1)\n    timer.mark(&quot;step_1&quot;)\n\n    time.sleep(0.2)\n    timer.mark(&quot;step_2&quot;)\n\n    time.sleep(0.3)\n    timer.mark(&quot;step_3&quot;)\n\n    timer.logging_cost()\n\n\nif __name__ == &quot;__main__&quot;:\n    logging.basicConfig(\n        level=logging.DEBUG,\n        format=&quot;%(asctime)s %(levelname)s %(filename)s:%(lineno)d %(message)s&quot;\n    )\n    test()`, `821355252086442000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> logging\n<span class="token keyword">import</span> time\n\n<span class="token keyword">from</span> pydash <span class="token keyword">import</span> py_\n\n\n<span class="token keyword">class</span> <span class="token class-name">IntervalTimeCostLogging</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>\n        self<span class="token punctuation">,</span>\n        enable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n        enable_call<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n        enable_cost<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n        func_name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>enable_call <span class="token operator">=</span> enable_call\n        self<span class="token punctuation">.</span>enable_cost <span class="token operator">=</span> enable_cost\n\n        <span class="token keyword">if</span> enable<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>enable_call <span class="token operator">=</span> <span class="token boolean">True</span>\n            self<span class="token punctuation">.</span>enable_cost <span class="token operator">=</span> <span class="token boolean">True</span>\n\n        self<span class="token punctuation">.</span>func_name <span class="token operator">=</span> func_name\n        self<span class="token punctuation">.</span>last_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>total_time <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>log_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">mark</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>enable_call <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>enable_cost<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n\n        current_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        elapsed_ms <span class="token operator">=</span> <span class="token punctuation">(</span>current_time <span class="token operator">-</span> self<span class="token punctuation">.</span>last_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>\n        self<span class="token punctuation">.</span>total_time <span class="token operator">+=</span> elapsed_ms\n        log <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"函数名称: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>func_name<span class="token punctuation">}</span></span><span class="token string">, 区间 </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> 耗时: </span><span class="token interpolation"><span class="token punctuation">{</span>elapsed_ms<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms, 累积耗时: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>total_time<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>enable_call<span class="token punctuation">:</span>\n            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>log<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>log_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>\n            <span class="token punctuation">{</span>\n                <span class="token string">"name"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>\n                <span class="token string">"elapsed_ms"</span><span class="token punctuation">:</span> elapsed_ms<span class="token punctuation">,</span>\n                <span class="token string">"total_time"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>total_time<span class="token punctuation">,</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>last_time <span class="token operator">=</span> current_time\n\n    <span class="token keyword">def</span> <span class="token function">logging_cost</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>enable_cost<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        <span class="token keyword">from</span> tabulate <span class="token keyword">import</span> tabulate\n\n        self<span class="token punctuation">.</span>log_list<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">"elapsed_ms"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>log_list<span class="token punctuation">:</span>\n            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">"elapsed_ms"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">"total_time"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        table <span class="token operator">=</span> tabulate<span class="token punctuation">(</span>\n            data<span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">"区间名称"</span><span class="token punctuation">,</span> <span class="token string">"区间耗时(ms)"</span><span class="token punctuation">,</span> <span class="token string">"累积耗时(ms)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            tablefmt<span class="token operator">=</span><span class="token string">"grid"</span><span class="token punctuation">,</span>\n            numalign<span class="token operator">=</span><span class="token string">"right"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span>\n        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"函数名称：</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>func_name<span class="token punctuation">}</span></span><span class="token string"> 花费时间按区间耗时倒序: \\n</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    timer <span class="token operator">=</span> IntervalTimeCostLogging<span class="token punctuation">(</span>enable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> func_name<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 模拟一些操作</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n    timer<span class="token punctuation">.</span>mark<span class="token punctuation">(</span><span class="token string">"step_1"</span><span class="token punctuation">)</span>\n\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>\n    timer<span class="token punctuation">.</span>mark<span class="token punctuation">(</span><span class="token string">"step_2"</span><span class="token punctuation">)</span>\n\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>\n    timer<span class="token punctuation">.</span>mark<span class="token punctuation">(</span><span class="token string">"step_3"</span><span class="token punctuation">)</span>\n\n    timer<span class="token punctuation">.</span>logging_cost<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>\n    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>\n        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>\n        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"%(asctime)s %(levelname)s %(filename)s:%(lineno)d %(message)s"</span>\n    <span class="token punctuation">)</span>\n    test<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打印效果"><a href="#%E6%89%93%E5%8D%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打印效果</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40657781772764004000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2025-10-30 15:31:15,733 DEBUG cost.py:36 函数名称: test, 区间 step_1 耗时: 107.24ms, 累积耗时: 107.24ms\n2025-10-30 15:31:15,950 DEBUG cost.py:36 函数名称: test, 区间 step_2 耗时: 216.73ms, 累积耗时: 323.98ms\n2025-10-30 15:31:16,251 DEBUG cost.py:36 函数名称: test, 区间 step_3 耗时: 301.41ms, 累积耗时: 625.39ms\n2025-10-30 15:31:16,258 DEBUG cost.py:61 函数名称：test 花费时间按区间耗时倒序: \n+--------+------------+------------+\n| 区间名称   |   区间耗时(ms) |   累积耗时(ms) |\n+========+============+============+\n| step_3 |    301.413 |    625.391 |\n+--------+------------+------------+\n| step_2 |    216.735 |    323.978 |\n+--------+------------+------------+\n| step_1 |    107.244 |    107.244 |\n+--------+------------+------------+`, `40657781772764004000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token number">2025</span>-10-30 <span class="token number">15</span>:31:15,733 DEBUG cost.py:36 函数名称: test, 区间 step_1 耗时: <span class="token number">107</span>.24ms, 累积耗时: <span class="token number">107</span>.24ms\n<span class="token number">2025</span>-10-30 <span class="token number">15</span>:31:15,950 DEBUG cost.py:36 函数名称: test, 区间 step_2 耗时: <span class="token number">216</span>.73ms, 累积耗时: <span class="token number">323</span>.98ms\n<span class="token number">2025</span>-10-30 <span class="token number">15</span>:31:16,251 DEBUG cost.py:36 函数名称: test, 区间 step_3 耗时: <span class="token number">301</span>.41ms, 累积耗时: <span class="token number">625</span>.39ms\n<span class="token number">2025</span>-10-30 <span class="token number">15</span>:31:16,258 DEBUG cost.py:61 函数名称：test 花费时间按区间耗时倒序: \n+--------+------------+------------+\n<span class="token operator">|</span> 区间名称   <span class="token operator">|</span>   区间耗时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span> <span class="token operator">|</span>   累积耗时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span> <span class="token operator">|</span>\n<span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>+\n<span class="token operator">|</span> step_3 <span class="token operator">|</span>    <span class="token number">301.413</span> <span class="token operator">|</span>    <span class="token number">625.391</span> <span class="token operator">|</span>\n+--------+------------+------------+\n<span class="token operator">|</span> step_2 <span class="token operator">|</span>    <span class="token number">216.735</span> <span class="token operator">|</span>    <span class="token number">323.978</span> <span class="token operator">|</span>\n+--------+------------+------------+\n<span class="token operator">|</span> step_1 <span class="token operator">|</span>    <span class="token number">107.244</span> <span class="token operator">|</span>    <span class="token number">107.244</span> <span class="token operator">|</span>\n+--------+------------+------------+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"背景 由于有些接口响应时间较长，在接口不需要频繁更新的情况下可以对其进行缓存 实现 cache_tool.py 实现装饰器缓存函数 redis_tool.py 实现删除某个接口的所有缓存结果，这里使用了 redis 的 scan…",timeToRead:4,tableOfContents:'<ul>\n<li><a href="/interface-cache-strategy-explore/#%E8%83%8C%E6%99%AF">背景</a></li>\n<li><a href="/interface-cache-strategy-explore/#%E5%AE%9E%E7%8E%B0">实现</a></li>\n<li><a href="/interface-cache-strategy-explore/#%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E4%BC%98%E5%8C%96">缓存失效优化</a></li>\n<li>\n<p><a href="/interface-cache-strategy-explore/#%E5%85%B6%E4%BB%96">其他</a></p>\n<ul>\n<li>\n<p><a href="/interface-cache-strategy-explore/#%E8%80%97%E6%97%B6%E6%89%93%E5%8D%B0">耗时打印</a></p>\n<ul>\n<li><a href="/interface-cache-strategy-explore/#%E5%AE%9E%E7%8E%B0-1">实现</a></li>\n<li><a href="/interface-cache-strategy-explore/#%E6%89%93%E5%8D%B0%E6%95%88%E6%9E%9C">打印效果</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>',wordCount:{words:47},frontmatter:{date:"2025-10-30 11:21:37",path:"/interface-cache-strategy-explore/",tags:"后端, 接口缓存, 预研",title:"接口缓存策略探索",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<p>网页在不同平台上展示的布局不一致，需要改成类似等比缩放的效果以便在各平台显示</p>\n<h1 id="选型"><a href="#%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型</h1>\n<ol>\n<li><a href="/mobile-page-adaptation/">主流方案</a></li>\n<li><a href="/international-official-website-technical-difficulties/#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%80%82%E9%85%8D">官网方案</a></li>\n</ol>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h2>\n<ol>\n<li>\n<p>使用 postcss-px-to-viewport 插件，将 src 以及三方库(node_modules)下的所有样式文件 <code class="language-text">(*.css|*.module.css|*.less|*.module.less)</code> 里面的 px 单位转换到 rem 单位</p>\n</li>\n<li>\n<p>在公共样式下根据媒体查询（屏幕宽度 or 屏幕 dpi）设置每种字体的大小</p>\n</li>\n<li>\n<p>由于目前插件不能转换非样式文件里面的 px 单位，所以需要写两种公共样式，这里会通过 url 来决定哪种生效</p>\n<ol>\n<li>需要等比缩放的，根据屏幕宽度改变字体大小（新页面，即此次重构页面）</li>\n<li>需要固定大小的，固定设置为 1920 下的字体大小（老页面）</li>\n</ol>\n</li>\n</ol>\n<p>重构目标：重构页面采用等比缩放，老页面维持固定大小，注意上线之后所有非样式代码即 js 文件里面禁止使用 px 单位，需要手动转换为 rem 单位，转换公式为 px 大小 / 10</p>\n<p>最终目标：所有页面统一采用等比缩放 （即将 js 代码里面的 px 单位全部改为 rem 单位，三方库里面的 js 代码暂不考虑，之后才能全部采用此方案）</p>\n<h2 id="postcssconfigjs（插件转换-px-为-rem）"><a href="#postcssconfigjs%EF%BC%88%E6%8F%92%E4%BB%B6%E8%BD%AC%E6%8D%A2-px-%E4%B8%BA-rem%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>postcss.config.js（插件转换 px 为 rem）</h2>\n<h3 id="配置分离"><a href="#%E9%85%8D%E7%BD%AE%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置分离</h3>\n<p>由于想让 cra 使用 postcss.config.js 的配置（cra 默认不使用），在 cra 5 版本和 customize-cra 情况下，addPostcssPlugins <a href="https://github.com/arackaf/customize-cra/issues/327#issuecomment-1210459104" target="_blank" rel="nofollow noreferrer noopener">不起作用</a>，有 2 种方式可以解决</p>\n<ol>\n<li>\n<p>重写 addPostcssPlugins</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93072216571164330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const addPostcssPlugins = (plugins) => (config) => {\n  const rules = config.module.rules.find((rule) => Array.isArray(rule.oneOf)).oneOf;\n  rules.forEach(\n     (r) =>\n        r.use &&\n        r.use.forEach((u) => {\n           if (u.options && u.options.ident === \'postcss\') {\n              const postcssOptions = {\n                 ident: \'postcss\',\n                 config: false\n              };\n              if (!u.options.plugins) {\n                 // u.options.plugins = () => [...plugins]\n                 postcssOptions.plugins = plugins;\n              } else {\n                 // const originalPlugins = u.options.plugins\n                 // u.options.plugins = () => [...originalPlugins(), ...plugins]\n                 postcssOptions.plugins = plugins;\n              }\n\n              delete u.options.plugins;\n              delete u.options.ident;\n\n              u.options.postcssOptions = postcssOptions;\n           } else if (u.options && u.options.postcssOptions && u.options.postcssOptions.ident === \'postcss\') {\n              if (!u.options.postcssOptions.plugins) {\n                 u.options.postcssOptions.plugins = plugins;\n              } else {\n                 const originalPlugins = u.options.postcssOptions.plugins;\n                 u.options.postcssOptions.plugins = [...originalPlugins, ...plugins];\n              }\n           }\n        })\n  );\n  return config;\n};`, `93072216571164330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">addPostcssPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">plugins</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> rules <span class="token operator">=</span> config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token operator">=></span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>oneOf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oneOf<span class="token punctuation">;</span>\n  rules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>\n     <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n        r<span class="token punctuation">.</span>use <span class="token operator">&amp;&amp;</span>\n        r<span class="token punctuation">.</span>use<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n           <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ident <span class="token operator">===</span> <span class="token string">\'postcss\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n                 ident<span class="token punctuation">:</span> <span class="token string">\'postcss\'</span><span class="token punctuation">,</span>\n                 config<span class="token punctuation">:</span> <span class="token boolean">false</span>\n              <span class="token punctuation">}</span><span class="token punctuation">;</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                 <span class="token comment">// u.options.plugins = () => [...plugins]</span>\n                 postcssOptions<span class="token punctuation">.</span>plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                 <span class="token comment">// const originalPlugins = u.options.plugins</span>\n                 <span class="token comment">// u.options.plugins = () => [...originalPlugins(), ...plugins]</span>\n                 postcssOptions<span class="token punctuation">.</span>plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span>\n\n              <span class="token keyword">delete</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>\n              <span class="token keyword">delete</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ident<span class="token punctuation">;</span>\n\n              u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions <span class="token operator">=</span> postcssOptions<span class="token punctuation">;</span>\n           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>ident <span class="token operator">===</span> <span class="token string">\'postcss\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                 u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                 <span class="token keyword">const</span> originalPlugins <span class="token operator">=</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>\n                 u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>originalPlugins<span class="token punctuation">,</span> <span class="token operator">...</span>plugins<span class="token punctuation">]</span><span class="token punctuation">;</span>\n              <span class="token punctuation">}</span>\n           <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>去掉相关配置，<a href="https://github.com/arackaf/customize-cra/issues/327#issuecomment-1371815281" target="_blank" rel="nofollow noreferrer noopener">依赖 postcss.config.js</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77299418943656330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const enablePostcssRc = () => (config) => {\n  const rules = config.module.rules.find((rule) => Array.isArray(rule.oneOf)).oneOf;\n  rules.forEach(\n     (r) =>\n        r.use &&\n        r.use.forEach((u) => {\n           if (u.options && u.options.ident === \'postcss\') {\n              delete u.options.ident;\n              if (u.options.plugins) {\n                 delete u.options.plugins; // 删除 plugins 属性，使用 postcss.config.js 中的配置\n              }\n           }\n\n           if (u.options && u.options.postcssOptions && u.options.postcssOptions.ident === \'postcss\') {\n              delete u.options.postcssOptions;\n           }\n        })\n  );\n  return config;\n};`, `77299418943656330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">enablePostcssRc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> rules <span class="token operator">=</span> config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token operator">=></span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>oneOf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oneOf<span class="token punctuation">;</span>\n  rules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>\n     <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n        r<span class="token punctuation">.</span>use <span class="token operator">&amp;&amp;</span>\n        r<span class="token punctuation">.</span>use<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n           <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ident <span class="token operator">===</span> <span class="token string">\'postcss\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">delete</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ident<span class="token punctuation">;</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                 <span class="token keyword">delete</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span> <span class="token comment">// 删除 plugins 属性，使用 postcss.config.js 中的配置</span>\n              <span class="token punctuation">}</span>\n           <span class="token punctuation">}</span>\n\n           <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">.</span>ident <span class="token operator">===</span> <span class="token string">\'postcss\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">delete</span> u<span class="token punctuation">.</span>options<span class="token punctuation">.</span>postcssOptions<span class="token punctuation">;</span>\n           <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>采用方案二</p>\n<h3 id="rspack-适配"><a href="#rspack-%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rspack 适配</h3>\n<p>rule 需要添加以下规则来兼容业务代码/三方库的样式文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72893507550230160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   module: {\n      rules: [\n         {\n            test: /\\.css\\$/,\n            exclude: /\\.module\\.css\\$/,\n            use: [\'postcss-loader\'],\n            type: \'css\'\n         },\n         {\n            test: /\\.module\\.css\\$/,\n            use: [\'postcss-loader\'],\n            type: \'css/module\'\n         },\n         {\n            test: /\\.less\\$/,\n            exclude: /\\.module\\.less\\$/,\n            use: [\n               \'postcss-loader\',\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css\'\n         },\n         {\n            test: /\\.module\\.less\\$/,\n            use: [\n               \'postcss-loader\',\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css/module\'\n         }\n      ];\n   }\n}`, `72893507550230160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/\\.module\\.css$/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'postcss-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.module\\.css$/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'postcss-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css/module\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/\\.module\\.less$/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'postcss-loader\'</span><span class="token punctuation">,</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.module\\.less$/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'postcss-loader\'</span><span class="token punctuation">,</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css/module\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="配置代码"><a href="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置代码</h3>\n<p>postcss.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38255398585799790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      \'postcss-flexbugs-fixes\',\n      [\n         \'postcss-preset-env\',\n         {\n            autoprefixer: {\n               flexbox: \'no-2009\'\n            },\n            stage: 3\n         }\n      ],\n      \'postcss-normalize\',\n      [\n         \'postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1000, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'] // 需要忽略的 CSS 选择器，不会转为视口单位，使用原有的 px 等单位\n            // include: /\\/src\\//\n            // exclude: /node_modules/,\n         }\n      ]\n   ]\n};`, `38255398585799790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token string">\'postcss-flexbugs-fixes\'</span><span class="token punctuation">,</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'postcss-preset-env\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            autoprefixer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               flexbox<span class="token punctuation">:</span> <span class="token string">\'no-2009\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            stage<span class="token punctuation">:</span> <span class="token number">3</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">\'postcss-normalize\'</span><span class="token punctuation">,</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span> <span class="token comment">// 需要忽略的 CSS 选择器，不会转为视口单位，使用原有的 px 等单位</span>\n            <span class="token comment">// include: /\\/src\\//</span>\n            <span class="token comment">// exclude: /node_modules/,</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="commonless（缩放规则）"><a href="#commonless%EF%BC%88%E7%BC%A9%E6%94%BE%E8%A7%84%E5%88%99%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>common.less（缩放规则）</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90010753161197600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 固定大小的页面\n.hackFixedPage {\n   font-size: 10px;\n}\n\n// 等比缩放的页面\n.hackResponsivePage {\n   // 大于 1500px (10px)\n   @media screen and (min-width: 1501px) {\n      font-size: 10px;\n   }\n\n   // 1300px～1500px 的宽度区间的根字号大小是某个范围（8px～10px）\n   @media screen and (min-width: 1300px) and (max-width: 1500px) {\n      font-size: calc(8px + 2 * (100vw - 1300px) / 200);\n   }\n\n   // 小于 1300px 的屏幕宽度，固定根字号大小（8px）\n   @media screen and (max-width: 1299px) {\n      font-size: 8px;\n   }\n}`, `90010753161197600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="less"\n              >\n                <span class="gatsby-code-button-language">less</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="less"><pre style="counter-reset: linenumber NaN" class="language-less line-numbers"><code class="language-less"><span class="token comment">// 固定大小的页面</span>\n<span class="token selector">.hackFixedPage</span> <span class="token punctuation">{</span>\n   <span class="token property">font-size</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 等比缩放的页面</span>\n<span class="token selector">.hackResponsivePage</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 大于 1500px (10px)</span>\n   <span class="token atrule">@media screen and <span class="token punctuation">(</span>min-width<span class="token punctuation">:</span> 1501px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 1300px～1500px 的宽度区间的根字号大小是某个范围（8px～10px）</span>\n   <span class="token atrule">@media screen and <span class="token punctuation">(</span>min-width<span class="token punctuation">:</span> 1300px<span class="token punctuation">)</span> and <span class="token punctuation">(</span>max-width<span class="token punctuation">:</span> 1500px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>8px <span class="token operator">+</span> 2 <span class="token operator">*</span> <span class="token punctuation">(</span>100vw <span class="token operator">-</span> 1300px<span class="token punctuation">)</span> <span class="token operator">/</span> 200<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 小于 1300px 的屏幕宽度，固定根字号大小（8px）</span>\n   <span class="token atrule">@media screen and <span class="token punctuation">(</span>max-width<span class="token punctuation">:</span> 1299px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实际使用"><a href="#%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实际使用</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52406740093730095000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.hintIcon {\n   font-size: 14px; // 实际转换为 14 / 10 = 1.4rem\n   margin-left: 8px; // 实际转换为 8 / 10 = 0.8rem\n   vertical-align: 1px; // 不做转换\n}`, `52406740093730095000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="less"\n              >\n                <span class="gatsby-code-button-language">less</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="less"><pre style="counter-reset: linenumber NaN" class="language-less line-numbers"><code class="language-less"><span class="token selector">.hintIcon</span> <span class="token punctuation">{</span>\n   <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span> <span class="token comment">// 实际转换为 14 / 10 = 1.4rem</span>\n   <span class="token property">margin-left</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span> <span class="token comment">// 实际转换为 8 / 10 = 0.8rem</span>\n   <span class="token property">vertical-align</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span> <span class="token comment">// 不做转换</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="三方库非样式文件单位转换"><a href="#%E4%B8%89%E6%96%B9%E5%BA%93%E9%9D%9E%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6%E5%8D%95%E4%BD%8D%E8%BD%AC%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三方库非样式文件单位转换</h1>\n<p>在上面适配规则上线之后，发现有的三方库不能正确的缩放，导致页面看起来不协调，以下是各个三方库的修复</p>\n<h2 id="pro-components"><a href="#pro-components" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pro components</h2>\n<p>参考<a href="https://github.com/ant-design/cssinjs?tab=readme-ov-file" target="_blank" rel="nofollow noreferrer noopener">文档</a>，对应<a href="https://github.com/ant-design/cssinjs/blob/master/src/transformers/px2rem.ts" target="_blank" rel="nofollow noreferrer noopener">源码</a>，可以看出是运行时的单位转换</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36238297750511084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { px2remTransformer, StyleProvider } from \'@ant-design/cssinjs\';\n\nconst StyleHoc = ({ children }) => {\n   // 和上面的 postcss-px-to-viewport 的适配策略保持一致\n   // 以 10 为根字体大小进行转换，保留 8 位小数，媒体查询下也进行转换\n   return (\n      <StyleProvider transformers={[px2remTransformer({ rootValue: 10, precision: 8, mediaQuery: true })]}>\n         {children}\n      </StyleProvider>\n   );\n};`, `36238297750511084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> px2remTransformer<span class="token punctuation">,</span> StyleProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/cssinjs\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">StyleHoc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token comment">// 和上面的 postcss-px-to-viewport 的适配策略保持一致</span>\n   <span class="token comment">// 以 10 为根字体大小进行转换，保留 8 位小数，媒体查询下也进行转换</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token operator">&lt;</span>StyleProvider transformers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token function">px2remTransformer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> rootValue<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> precision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span>\n         <span class="token punctuation">{</span>children<span class="token punctuation">}</span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>StyleProvider<span class="token operator">></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="mui"><a href="#mui" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mui</h2>\n<p>参考<a href="https://v5.mui.com/material-ui/customization/theming/" target="_blank" rel="nofollow noreferrer noopener">文档</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22708623197848277000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { createTheme, ThemeProvider } from \'@mui/material/styles\';\n\nconst theme = createTheme({\n   // 和上面的 postcss-px-to-viewport 的适配策略保持一致\n   // 以 10 为根字体大小进行转换\n   typography: {\n      pxToRem: (size) => \\`\\${size / 10}rem\\`\n   }\n});\n\nconst ThemeHoc = ({ children }) => {\n   return <ThemeProvider theme={theme}>{children}</ThemeProvider>;\n};`, `22708623197848277000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> createTheme<span class="token punctuation">,</span> ThemeProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@mui/material/styles\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token function">createTheme</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   <span class="token comment">// 和上面的 postcss-px-to-viewport 的适配策略保持一致</span>\n   <span class="token comment">// 以 10 为根字体大小进行转换</span>\n   typography<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token function-variable function">pxToRem</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>size <span class="token operator">/</span> <span class="token number">10</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">rem</span><span class="token template-punctuation string">`</span></span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">ThemeHoc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token operator">&lt;</span>ThemeProvider theme<span class="token operator">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>ThemeProvider<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"背景 网页在不同平台上展示的布局不一致，需要改成类似等比缩放的效果以便在各平台显示 选型 主流方案 官网方案 实现 核心逻辑 使用 postcss-px-to-viewport 插件，将 src 以及三方库(node_modules)下的所有样式文件   里面的 px…",frontmatter:{date:"2025-10-27 11:43:35",path:"/frontend-multi-platform-page-adaptation/",tags:"前端, 页面适配, 预研",title:"前端多平台页面适配",draft:null}},prePost:null},pathContext:{mainPostPath:"/interface-cache-strategy-explore/",nextPostPath:"/frontend-multi-platform-page-adaptation/",prePostPath:"none"}}}});